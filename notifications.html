<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifikasi | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
<style>
    /* Style Badge Notifikasi */
    .menu-item { position: relative; }

    .nav-badge {
        background-color: #e74c3c;
        color: white;
        font-size: 10px;
        font-weight: bold;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        position: absolute;
        border: 2px solid #fff;
        z-index: 10;
    }

    .mobile-nav .nav-badge { top: 0px; right: 25%; }
    .sidebar-left .nav-badge { top: 8px; right: 10px; }

    /* STYLE BARU UNTUK KARTU NOTIFIKASI */
    .notif-card {
        display: flex; 
        align-items: center; 
        gap: 15px; 
        padding: 15px;
        text-decoration: none; /* Hilangkan garis bawah link */
        color: inherit; /* Warna teks ikut parent */
        transition: background 0.2s;
        border-bottom: 1px solid #eee; /* Garis pemisah */
    }
    .notif-card:hover {
        background-color: #f9f9f9; /* Efek hover */
    }
    
    /* Layout Mobile Responsif */
    .notif-text { font-size: 14px; line-height: 1.4; flex: 1; }
    .notif-time { font-size: 11px; color: #999; margin-top: 3px; }
    
</style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item active">
                    <i class="fa-solid fa-bell"></i> Notifikasi
                    <span class="nav-badge" id="badgeSidebar">0</span> 
                </a>
                <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="disconnect()" class="menu-item" style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</a>
            </div>
        </div>

        <div class="main-feed">
            <h3 style="margin: 0 0 20px 0; color: #7385a5;">Aktivitas Terbaru</h3>
            <div id="notifContainer">
                <div class="card" style="padding: 20px; text-align: center; color: #999;">Memuat...</div>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item"><i class="fa-solid fa-house" style="font-size: 18px;"></i></a>
        <a href="notifications.html" class="menu-item active" style="flex-direction: column; gap: 2px; font-size: 10px;">
            <i class="fa-solid fa-bell" style="font-size: 18px;"></i>
            <span class="nav-badge" id="badgeMobile">0</span> 
        </a>
        <a href="profile.html" class="menu-item"><i class="fa-solid fa-user" style="font-size: 18px;"></i></a>
    </div>

    <script src="main.js"></script>
    <script>
        // Cache sederhana untuk profil biar loading cepat
        const profileCache = {};

        window.onload = async () => {
            await initApp();
            if(userAddress) {
                await loadNotifs();
                markAsReadLocal(); 
            }
        };

        function markAsReadLocal() {
            const now = Math.floor(Date.now() / 1000);
            localStorage.setItem("lastNotifCheck", now);
            const badges = document.querySelectorAll('.nav-badge');
            badges.forEach(b => b.style.display = 'none');
        }

        async function loadNotifs() {
            try {
                // Gunakan EXTENDED_ABI di main.js atau pastikan getMyNotifications ada di ABI
                const notifs = await contract.getMyNotifications();
                const container = document.getElementById("notifContainer");
                container.innerHTML = "";

                if(notifs.length === 0) {
                    container.innerHTML = `<div class="card" style="padding: 20px; text-align: center; color: #999;">Belum ada notifikasi.</div>`;
                    return;
                }

                const lastCheck = localStorage.getItem("lastNotifCheck") || 0;

                // Loop menggunakan for..of agar bisa AWAIT (Fetch profil satu-satu)
                // Reverse agar yang baru paling atas
                for (const n of [...notifs].reverse()) {
                    
                    // 1. Ambil Data Profil (Nickname & Foto)
                    let nick = n.actor.substring(0,6) + "...";
                    let avatar = "https://via.placeholder.com/40"; // Default

                    // Cek Cache dulu
                    if(profileCache[n.actor]) {
                        nick = profileCache[n.actor].nick;
                        avatar = profileCache[n.actor].avatar;
                    } else {
                        // Fetch Blockchain
                        try {
                            const p = await contract.getProfile(n.actor);
                            if(p.nickname) nick = p.nickname;
                            if(p.fotoProfil) {
                                // Direct Link Pinata (Anti Broken Image)
                                avatar = p.fotoProfil.replace('ipfs://', 'https://ipfs.io/ipfs/');
                            }
                            // Simpan ke cache
                            profileCache[n.actor] = { nick, avatar };
                        } catch(err) { console.log("Skip profil", n.actor); }
                    }

                    // 2. Tentukan Ikon & Teks
                    let iconHtml = '<i class="fa-solid fa-circle-info"></i>';
                    let text = 'berinteraksi';
                    let color = '#7385a5';

                    if(n.actionType === "LIKE") {
                        iconHtml = '<i class="fa-solid fa-heart" style="color: #e74c3c;"></i>'; 
                        text = 'menyukai postingan Anda'; 
                    } else if (n.actionType === "COMMENT") {
                        iconHtml = '<i class="fa-solid fa-comment" style="color: #3498db;"></i>'; 
                        text = 'mengomentari postingan Anda'; 
                    } else if (n.actionType === "RATE") {
                        iconHtml = '<i class="fa-solid fa-star" style="color: gold;"></i>'; 
                        text = 'memberi bintang'; 
                    } else if (n.actionType === "SAWER") {
                        iconHtml = '<i class="fa-solid fa-gift" style="color: #27ae60;"></i>'; 
                        text = 'menyawer Anda! ðŸ’¸'; 
                    } else if (n.actionType === "FOLLOW") {
                        iconHtml = '<i class="fa-solid fa-user-plus" style="color: #9b59b6;"></i>'; 
                        text = 'mulai mengikuti Anda'; 
                    }

                    // 3. Highlight Baru
                    const isNew = n.timestamp > lastCheck;
                    const bgStyle = isNew ? "background-color: #f0f8ff; border-left: 4px solid #3498db;" : "background-color: #fff;";
                    const badgeNew = isNew ? `<span style="background:#e74c3c; color:white; padding:1px 4px; border-radius:3px; font-size:9px; vertical-align:middle; margin-left:5px;">BARU</span>` : "";

                    // 4. Link Navigasi (Membuka detail postingan)
                    // Jika FOLLOW, buka profil orang itu. Jika POST, buka koleksi.html
                    let targetLink = `koleksi.html?id=${n.postId}`;
                    if(n.actionType === "FOLLOW") targetLink = `profile.html?addr=${n.actor}`;

                    // 5. Render HTML
                    const html = `
                    <a href="${targetLink}" class="card notif-card" style="${bgStyle}">
                        <img src="${avatar}" 
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/40';"
                             style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee;">
                        
                        <div class="notif-text">
                            <span style="font-weight:bold; color:#2c3e50;">${nick}</span>
                            <span style="color:#555;">${text}</span> ${badgeNew}
                            <div class="notif-time">
                                <i class="fa-regular fa-clock"></i> ${new Date(n.timestamp * 1000).toLocaleString()}
                            </div>
                        </div>

                        <div style="font-size: 18px; opacity: 0.8; margin-left: auto;">
                            ${iconHtml}
                        </div>
                    </a>`;
                    
                    container.innerHTML += html;
                }

            } catch (e) {
                console.error(e);
                document.getElementById("notifContainer").innerHTML = "<p style='text-align:center; color:red;'>Gagal memuat notifikasi.</p>";
            }
        }
    </script>
</body>
</html>
