<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifikasi | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
/* Style Badge Notifikasi */
.menu-item { position: relative; } /* Wajib agar badge menempel */

.nav-badge {
    background-color: #e74c3c; /* Warna Merah */
    color: white;
    font-size: 10px;
    font-weight: bold;
    min-width: 18px; /* Lebar minimum agar bulat */
    height: 18px;
    border-radius: 50%; /* Membuat lingkaran */
    display: none; /* Sembunyi jika 0 */
    align-items: center;
    justify-content: center;
    position: absolute;
    border: 2px solid #fff; /* Border putih biar rapi */
    z-index: 10;
}

/* Posisi di Mobile (Bawah) */
.mobile-nav .nav-badge {
    top: 0px;
    right: 25%; /* Geser supaya pas di pojok ikon */
}

/* Posisi di Sidebar Desktop (Kiri) */
.sidebar-left .nav-badge {
    top: 8px;
    right: 10px; /* Di ujung kanan tombol */
}
</style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item">
    <i class="fa-solid fa-bell"></i> Notifikasi
    <span class="nav-badge" id="badgeSidebar">0</span> 
                </a>
                <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="disconnect()" class="menu-item" style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</a>
            </div>
        </div>

        <div class="main-feed">
            <h3 style="margin: 0 0 20px 0; color: #7385a5;">Aktivitas Terbaru</h3>
            <div id="notifContainer">
                <div class="card" style="padding: 20px; text-align: center; color: #999;">Memuat...</div>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item"><i class="fa-solid fa-house" style="font-size: 18px;"></i></a>
        <a href="notifications.html" class="menu-item" style="flex-direction: column; gap: 2px; font-size: 10px;">
    <i class="fa-solid fa-bell" style="font-size: 18px;"></i>
    <span class="nav-badge" id="badgeMobile">0</span> 
        </a>
        <a href="profile.html" class="menu-item"><i class="fa-solid fa-user" style="font-size: 18px;"></i></a>
    </div>

    <script src="main.js"></script>
    <script>
        window.onload = async () => {
            await initApp();
            if(userAddress) {
                // 1. Load dulu notifikasinya
                await loadNotifs();
                
                // 2. Setelah tampil, baru tandai sudah dibaca (Reset Dot Merah)
                markAsReadLocal(); 
            }
        };

        // Fungsi Reset Dot Merah (Gratis tanpa Gas Fee)
        function markAsReadLocal() {
            // Simpan waktu sekarang (detik) ke browser
            const now = Math.floor(Date.now() / 1000);
            localStorage.setItem("lastNotifCheck", now);
            
            // Hilangkan badge merah di Navbar seketika
            const badges = document.querySelectorAll('.nav-badge');
            badges.forEach(b => b.style.display = 'none');
        }

        async function loadNotifs() {
            try {
                const notifs = await contract.getMyNotifications();
                const container = document.getElementById("notifContainer");
                container.innerHTML = "";

                if(notifs.length === 0) {
                    container.innerHTML = `<div class="card" style="padding: 20px; text-align: center; color: #999;">Belum ada notifikasi.</div>`;
                    return;
                }

                // Ambil waktu cek terakhir (untuk menentukan mana yang "BARU")
                const lastCheck = localStorage.getItem("lastNotifCheck") || 0;

                [...notifs].reverse().forEach(n => {
                    let icon = '<i class="fa-solid fa-circle-info"></i>';
                    let text = 'berinteraksi dengan post Anda';
                    let color = '#7385a5';

                    // Logika Icon & Warna
                    if(n.actionType === "LIKE") {
                        icon = '<i class="fa-solid fa-heart"></i>'; 
                        text = 'menyukai postingan Anda'; 
                        color = '#e74c3c'; // Merah
                    } else if (n.actionType === "COMMENT") {
                        icon = '<i class="fa-solid fa-comment"></i>'; 
                        text = 'mengomentari postingan Anda'; 
                        color = '#3498db'; // Biru
                    } else if (n.actionType === "RATE") {
                        icon = '<i class="fa-solid fa-star"></i>'; 
                        text = 'memberi bintang'; 
                        color = 'gold'; // Emas
                    } else if (n.actionType === "FOLLOW") {
                        icon = '<i class="fa-solid fa-user-plus"></i>'; 
                        text = 'mulai mengikuti Anda'; 
                        color = '#2ecc71'; // Hijau
                    }

                    // Logika Highlight (Jika timestamp notif > terakhir cek)
                    // Notif baru akan berwarna biru muda dan ada border kiri
                    const isNew = n.timestamp > lastCheck;
                    const bgStyle = isNew ? "background-color: #f0f8ff; border-left: 4px solid #3498db;" : "";
                    const badgeNew = isNew ? `<span style="background:#e74c3c; color:white; padding:2px 6px; border-radius:4px; font-size:9px; margin-left:5px; vertical-align:middle;">BARU</span>` : "";

                    const html = `
                    <div class="card" style="padding: 15px; display: flex; gap: 15px; align-items: center; ${bgStyle}">
                        <div style="font-size: 24px; color: ${color}; width: 40px; text-align: center;">
                            ${icon}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; line-height: 1.4;">
                                <strong>${n.actor.substring(0,6)}...</strong> ${text} ${badgeNew}
                            </div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                <i class="fa-regular fa-clock"></i> ${new Date(n.timestamp * 1000).toLocaleString()}
                            </div>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            } catch (e) {
                console.error(e);
                container.innerHTML = "<p style='text-align:center; color:red;'>Gagal memuat notifikasi.</p>";
            }
        }
    </script>
</body>
</html>
