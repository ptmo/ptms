<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        /* Backdrop gelap saat modal muncul */
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }

        /* Modal hanya tampil FLEX saat statusnya OPEN */
        #commentModal[open] {
            display: flex;
            flex-direction: column;
        }
        
        /* Style item komentar */
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item"><i class="fa-solid fa-bell"></i> Notifikasi</a>
                <a href="profile.html" class="menu-item active"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="disconnect()" class="menu-item" style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</a>
            </div>
        </div>

        <div class="main-feed">
            
            <div class="card" style="text-align: center; padding: 30px 20px;">
                <img id="pAvatar" src="https://via.placeholder.com/100" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid #f0f2f5; margin-top: -10px; object-fit: cover;">
                
                <h2 id="pNick" style="margin: 10px 0 5px 0; color: #333;">Memuat...</h2>
                <div id="pWallet" style="font-size: 12px; color: #888; background: #eee; display: inline-block; padding: 3px 10px; border-radius: 10px;">0x...</div>
                
                <p id="pBio" style="margin: 15px 0; color: #555; font-style: italic;">-</p>
                
                <div style="display: flex; justify-content: center; gap: 15px; font-size: 13px; color: #666;">
                    <span><i class="fa-solid fa-location-dot"></i> <span id="pLoc">-</span></span>
                    <span><i class="fa-solid fa-image"></i> <span id="pPostCount">0</span> Post</span>
                </div>

                <div id="myActions" style="margin-top: 20px; display: none; gap: 10px; justify-content: center;">
                    <button class="btn-primary" style="font-size: 13px; background: #eee; color: #333;" onclick="openEditModal()">Edit Profil</button>
                    </div>
            </div>

            <h4 style="margin: 20px 0 10px; color: #7385a5;">Postingan</h4>
            
            <div id="profileFeed"></div>
        </div>
    </div>

    <dialog id="editModal" style="border:none; border-radius:10px; padding:20px; width:90%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0;">Edit Profil</h3>
        <input type="text" id="editBio" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Bio Baru">
        <input type="text" id="editLoc" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Lokasi Baru">
        <label style="font-size:12px;">Foto Baru (Opsional)</label>
        <input type="file" id="editFoto" class="cp-input">
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('editModal').close()" style="background:none; border:none; cursor:pointer;">Batal</button>
            <button onclick="submitEditProfile()" class="btn-primary">Simpan</button>
        </div>
    </dialog>

    <dialog id="commentModal" style="border:none; border-radius:15px; padding:0; box-shadow:0 0 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; height: 70vh;">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; color:#7385a5;">Komentar</h3>
            <span onclick="document.getElementById('commentModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        
        <div id="commentList" style="flex: 1; overflow-y: auto; padding: 15px;">
            <p style="text-align:center; color:#999;">Memuat komentar...</p>
        </div>

        <div style="padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; display: flex; gap: 10px;">
            <input type="text" id="commentInput" class="cp-input" style="height: 40px;" placeholder="Tulis komentar...">
            <input type="hidden" id="commentPostId">
            <button onclick="submitComment()" class="btn-primary" style="padding: 0 20px;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </dialog>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item" style="flex-direction: column; gap: 2px; font-size: 10px;"><i class="fa-solid fa-house" style="font-size: 18px;"></i> Home</a>
        <a href="notifications.html" class="menu-item" style="flex-direction: column; gap: 2px; font-size: 10px;"><i class="fa-solid fa-bell" style="font-size: 18px;"></i> Notif</a>
        <a href="profile.html" class="menu-item active" style="flex-direction: column; gap: 2px; font-size: 10px;"><i class="fa-solid fa-user" style="font-size: 18px;"></i> Profil</a>
    </div>

    <div id="toast"></div>
    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
    let currentProfileAddr;
    
    // Gunakan ABI lengkap dari main.js ditambah fungsi komentar
    // Jika main.js sudah memuat CONTRACT_ABI, kita bisa extend. 
    // Jika tidak, pastikan ABI ini lengkap.
    const EXTENDED_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"string","name":"action","type":"string"}],"name":"NewInteraction","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"postId","type":"uint256"},{"indexed":true,"internalType":"address","name":"author","type":"address"}],"name":"NewPost","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newName","type":"string"},{"indexed":false,"internalType":"bool","name":"isPaid","type":"bool"}],"name":"NicknameChanged","type":"event"},{"inputs":[],"name":"MAX_FREE_CHANGES","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"string","name":"_text","type":"string"},{"internalType":"string","name":"_imageURI","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_newNickname","type":"string"}],"name":"changeNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_imageURI","type":"string"},{"internalType":"string","name":"_caption","type":"string"}],"name":"createPost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"dislikePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficial.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"}],"name":"getComments","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasOfficial.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyNotifications","outputs":[{"components":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"internalType":"struct PutramasOfficial.Notification[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getProfile","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficial.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getProfileById","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficial.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficial.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasDisliked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"idToWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"likePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"nicknamePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"postComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"posts","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"}],"name":"ratePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"registerProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newPrice","type":"uint256"}],"name":"setNicknamePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateBioAndPhoto","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userNotifications","outputs":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRating","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"stateMutability":"view","type":"function"}];

    window.onload = async () => {
        await initApp();
        
        const urlParams = new URLSearchParams(window.location.search);
        const addrParam = urlParams.get('addr');
        currentProfileAddr = addrParam ? addrParam : userAddress;

        if(userAddress) {
            // Re-init contract dengan ABI Extended
            contract = new ethers.Contract(CONTRACT_ADDRESS, EXTENDED_ABI, signer);
            loadProfileData(currentProfileAddr);
        }
    };

    function getOptimizedUrl(ipfsUrl, width = 600) {
        if (!ipfsUrl) return null;
        const rawUrl = ipfsUrl.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
        return `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=${width}&q=80&output=webp`;
    }

    async function loadProfileData(addr) {
        try {
            const p = await contract.getProfile(addr);
            
            document.getElementById("pNick").innerText = p.nickname;
            document.getElementById("pBio").innerText = p.bio;
            document.getElementById("pLoc").innerText = p.lokasi;
            document.getElementById("pWallet").innerText = addr.substring(0,8) + "...";
            
            if(p.fotoProfil) document.getElementById("pAvatar").src = getOptimizedUrl(p.fotoProfil, 100);

            if (addr.toLowerCase() === userAddress.toLowerCase()) {
                document.getElementById("myActions").style.display = "flex";
            }

            const posts = await contract.getUserPosts(addr);
            document.getElementById("pPostCount").innerText = posts.length;
            
            const container = document.getElementById("profileFeed");
            container.innerHTML = "";

            if(posts.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:30px;'>Belum ada postingan.</p>";
                return;
            }

            [...posts].reverse().forEach(post => {
                let imgHtml = "";
                if(post.imageURI && post.imageURI.length > 5) {
                    const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    const optUrl = getOptimizedUrl(post.imageURI, 600);
                    imgHtml = `<a href="${rawUrl}" target="_blank"><img src="${optUrl}" class="post-image" style="width:100%; height:auto; display:block; margin-top:10px; border-radius:8px;"></a>`;
                }

                const html = `
                <div class="card" style="padding:0; overflow:hidden;">
                    <div style="padding:15px 15px 0 15px;">
                        <small style="color:#999;">${new Date(post.timestamp * 1000).toLocaleDateString()}</small>
                        <div style="margin-top:5px; font-size:14px; line-height:1.4;">${post.caption}</div>
                    </div>
                    ${imgHtml}
                    <div class="post-actions" style="border-top:1px solid #eee; padding:10px; display:flex; justify-content:space-around; margin-top:10px;">
                        <button class="action-btn" style="background:none; border:none; color:#666;">❤️ ${post.likeCount}</button>
                        <button class="action-btn" onclick="openComments(${post.id})" style="background:none; border:none; color:#666; cursor:pointer;"><i class="fa-regular fa-comment"></i> ${post.commentCount}</button>
                        <button class="action-btn" style="background:none; border:none; color:gold;">⭐ ${post.ratingCount > 0 ? (post.totalRatingScore/post.ratingCount).toFixed(1) : '0.0'}</button>
                    </div>
                </div>`;
                container.innerHTML += html;
            });

        } catch (e) {
            console.error(e);
            showToast("Gagal memuat profil", "error");
        }
    }

    // --- FUNGSI KOMENTAR (WAJIB ADA) ---
    async function openComments(postId) {
        const index = postId - 1; 
        const modal = document.getElementById("commentModal");
        const list = document.getElementById("commentList");
        
        document.getElementById("commentPostId").value = index;
        document.getElementById("commentInput").value = "";
        
        modal.showModal(); 
        list.innerHTML = "<p style='text-align:center; padding:20px;'>Memuat...</p>";

        try {
            const comments = await contract.getComments(index);
            list.innerHTML = "";
            if(comments.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Belum ada komentar.</p>";
                return;
            }

            for (const c of comments) {
                let nick = c.commenter.substring(0,6);
                let avt = "https://via.placeholder.com/30";
                
                // Fetch profil komentator (bisa dioptimalkan dengan cache)
                try {
                    const p = await contract.getProfile(c.commenter);
                    nick = p.nickname;
                    if(p.fotoProfil) avt = getOptimizedUrl(p.fotoProfil, 50);
                } catch(e){}

                const html = `
                <div class="comment-item" style="border-bottom:1px solid #eee; padding:10px; display:flex; gap:10px;">
                    <img src="${avt}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:12px; color:#7385a5;">${nick}</div>
                        <div style="font-size:13px;">${c.text}</div>
                        <div style="font-size:10px; color:#999;">${new Date(c.timestamp * 1000).toLocaleTimeString()}</div>
                    </div>
                </div>`;
                list.innerHTML += html;
            }
        } catch(e) { list.innerHTML = "Gagal memuat komentar."; }
    }

    async function submitComment() {
        const index = document.getElementById("commentPostId").value;
        const text = document.getElementById("commentInput").value;
        if(!text) return;
        try {
            showToast("Mengirim...", "info");
            const tx = await contract.addComment(index, text, "");
            await tx.wait();
            showToast("Terkirim!", "success");
            document.getElementById("commentInput").value = "";
            openComments(parseInt(index) + 1);
        } catch(e) { showToast("Gagal: " + e.message, "error"); }
    }

    function openEditModal() { document.getElementById('editModal').showModal(); }
    
    async function submitEditProfile() {
        const bio = document.getElementById("editBio").value;
        const loc = document.getElementById("editLoc").value;
        const file = document.getElementById("editFoto").files[0];
        if(!bio && !loc && !file) return showToast("Tidak ada perubahan", "info");

        try {
            const p = await contract.getProfile(userAddress);
            let imgUri = p.fotoProfil;
            if(file) {
                showToast("Kompresi 30KB...", "info");
                imgUri = await uploadToIPFS(file, 30);
            }
            showToast("Update Blockchain...", "info");
            const tx = await contract.updateProfile(p.nickname, imgUri, bio || p.bio, loc || p.lokasi);
            await tx.wait();
            showToast("Sukses!", "success");
            location.reload();
        } catch(e) { showToast("Gagal: " + e.message, "error"); }
    }
    </script>
</body>
</html>
