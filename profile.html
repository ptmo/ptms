<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        #commentModal[open] { 
        display: flex; 
        flex-direction: column;
        /* Wajib ada agar melayang di tengah saat display:flex */
        margin: auto; 
        position: fixed;
        inset: 0;
        }
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; gap: 10px; }
        .post-image { cursor: zoom-in; transition: opacity 0.2s; }
        .post-image:hover { opacity: 0.9; }

        /* Style Badge Notifikasi */
.menu-item { position: relative; } /* Wajib agar badge menempel */

.nav-badge {
    background-color: #e74c3c; /* Warna Merah */
    color: white;
    font-size: 10px;
    font-weight: bold;
    min-width: 18px; /* Lebar minimum agar bulat */
    height: 18px;
    border-radius: 50%; /* Membuat lingkaran */
    display: none; /* Sembunyi jika 0 */
    align-items: center;
    justify-content: center;
    position: absolute;
    border: 2px solid #fff; /* Border putih biar rapi */
    z-index: 10;
}

/* Posisi di Mobile (Bawah) */
.mobile-nav .nav-badge {
    top: 0px;
    right: 25%; /* Geser supaya pas di pojok ikon */
}

/* Posisi di Sidebar Desktop (Kiri) */
.sidebar-left .nav-badge {
    top: 8px;
    right: 10px; /* Di ujung kanan tombol */
}
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item">
    <i class="fa-solid fa-bell"></i> Notifikasi
    <span class="nav-badge" id="badgeSidebar">0</span> 
                </a>
                <a href="profile.html" class="menu-item active"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="disconnect()" class="menu-item" style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</a>
            </div>
        </div>

        <div class="main-feed">
    <div class="card" style="text-align: center; padding: 30px 20px;">
        <img id="pAvatar" src="https://via.placeholder.com/100" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid #f0f2f5; margin-top: -10px; object-fit: cover;">
        
        <h2 id="pNick" style="margin: 10px 0 5px 0; color: #333;">Memuat...</h2>
        <div id="pWallet" style="font-size: 12px; color: #888; background: #eee; display: inline-block; padding: 3px 10px; border-radius: 10px;">0x...</div>
        
        <p id="pBio" style="margin: 15px 0; color: #555; font-style: italic;">-</p>
        
        <div style="display: flex; justify-content: center; gap: 25px; margin: 20px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 15px 0;">
            <div style="text-align: center;">
                <div id="statPost" style="font-weight: bold; font-size: 18px; color: #333;">0</div>
                <div style="font-size: 11px; color: #999;">POST</div>
            </div>
            
            <div style="text-align: center; cursor: pointer;" onclick="openFollowList('followers')">
                <div id="statFollower" style="font-weight: bold; font-size: 18px; color: #333;">0</div>
                <div style="font-size: 11px; color: #999;">PENGIKUT</div>
            </div>
            
            <div style="text-align: center; cursor: pointer;" onclick="openFollowList('following')">
                <div id="statFollowing" style="font-weight: bold; font-size: 18px; color: #333;">0</div>
                <div style="font-size: 11px; color: #999;">MENGIKUTI</div>
            </div>
        </div>

        <div style="display: flex; justify-content: center; gap: 15px; font-size: 13px; color: #666; margin-bottom: 15px;">
            <span><i class="fa-solid fa-location-dot"></i> <span id="pLoc">-</span></span>
        </div>

        <div id="actionButtons" style="display: flex; gap: 10px; justify-content: center;">
            </div>
    </div>

    <h4 style="margin: 20px 0 10px; color: #7385a5;">Postingan</h4>
    <div id="profileFeed"></div>
</div>

    <dialog id="editModal" style="border:none; border-radius:10px; padding:20px; width:90%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0;">Edit Profil</h3>
        <input type="text" id="editBio" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Bio Baru">
        <input type="text" id="editLoc" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Lokasi Baru">
        <label style="font-size:12px;">Foto Baru (Opsional)</label>
        <input type="file" id="editFoto" class="cp-input">
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('editModal').close()" style="background:none; border:none; cursor:pointer;">Batal</button>
            <button onclick="submitEditProfile()" class="btn-primary">Simpan</button>
        </div>
    </dialog>

    <dialog id="nickModal" style="border:none; border-radius:10px; padding:20px; width:90%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0; color:#e74c3c;">Ganti Nickname</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px;">
            Kuota Gratis: <span id="freeCount" style="font-weight:bold;">Loading...</span> / 2<br>
            Biaya setelah habis: <strong>0.0001 ETH</strong>
        </p>
        <input type="text" id="newNickInput" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Nickname Baru (Tanpa Angka)">
        
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('nickModal').close()" style="background:none; border:none; cursor:pointer;">Batal</button>
            <button id="btnSaveNick" onclick="submitChangeNick()" class="btn-primary" style="background:#e74c3c;">Ganti</button>
        </div>
    </dialog>

    <dialog id="commentModal" style="border:none; border-radius:15px; padding:0; box-shadow:0 0 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; height: 70vh;">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; color:#7385a5;">Komentar</h3>
            <span onclick="document.getElementById('commentModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        <div id="commentList" style="flex: 1; overflow-y: auto; padding: 15px;">
            <p style="text-align:center; color:#999;">Memuat komentar...</p>
        </div>
        <div style="padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; display: flex; gap: 10px;">
            <input type="text" id="commentInput" class="cp-input" style="height: 40px;" placeholder="Tulis komentar...">
            <input type="hidden" id="commentPostId">
            <button onclick="submitComment()" class="btn-primary" style="padding: 0 20px;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </dialog>

    <dialog id="ratingModal" style="border:none; border-radius:15px; padding:20px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
        <h3 style="margin-top:0; text-align:center; color:#7385a5;">Beri Rating</h3>
        <div style="display:flex; gap:10px; font-size:30px; justify-content:center; cursor:pointer; margin:20px 0;">
            <span onclick="setRate(1)">‚≠ê</span><span onclick="setRate(2)">‚≠ê</span><span onclick="setRate(3)">‚≠ê</span><span onclick="setRate(4)">‚≠ê</span><span onclick="setRate(5)">‚≠ê</span>
        </div>
        <input type="hidden" id="targetPostId">
        <button onclick="submitRating()" class="btn-primary" style="width:100%">Kirim</button>
        <button onclick="document.getElementById('ratingModal').close()" style="width:100%; background:none; border:none; color:#666; margin-top:10px; cursor:pointer;">Batal</button>
    </dialog>

    <dialog id="sawerModal" style="border:none; padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        <h3 style="margin-top:0; text-align:center;">üéÅ Sawer Kreator</h3>
        <input type="number" id="sawerAmount" class="cp-input" placeholder="0.0001" style="width:100%; margin-bottom:10px;">
        <small style="display:block; text-align:center; margin-bottom:10px;">Min: 0.00002 ETH - Max: 0.01 ETH</small>
        <input type="hidden" id="sawerPostId">
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('sawerModal').close()" style="flex:1; padding:10px; cursor:pointer;">Batal</button>
            <button onclick="submitSawer()" style="flex:1; background:#27ae60; color:white; border:none; padding:10px; cursor:pointer;">Kirim</button>
        </div>
    </dialog>

    <dialog id="followListModal" style="border:none; border-radius:15px; padding:0; box-shadow:0 0 50px rgba(0,0,0,0.5); width: 90%; max-width: 400px; height: 60vh;">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position:sticky; top:0; background:white;">
            <h3 id="followListTitle" style="margin:0; color:#7385a5;">Daftar Teman</h3>
            <span onclick="document.getElementById('followListModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        
        <div id="followListContainer" style="overflow-y: auto; padding: 10px; height: calc(100% - 60px);">
            <p style="text-align:center; color:#999; margin-top:20px;">Memuat daftar...</p>
        </div>
    </dialog>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i></a>
        <a href="notifications.html" class="menu-item" style="flex-direction: column; gap: 2px; font-size: 10px;">
    <i class="fa-solid fa-bell" style="font-size: 18px;"></i>
    <span class="nav-badge" id="badgeMobile">0</span> 
        </a>
        <a href="profile.html" class="menu-item active"><i class="fa-solid fa-user"></i></a>
    </div>

    <div id="toast"></div>
    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
    let currentProfileAddr;
    let myChangeCount = 0; 
    const commentProfileCache = {};

    // --- 1. ABI BARU (Sesuai Kontrak NFT PutramasUltimate) ---
    const EXTENDED_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"follower","type":"address"},{"indexed":true,"internalType":"address","name":"followed","type":"address"}],"name":"Followed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"string","name":"action","type":"string"}],"name":"NewInteraction","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"postId","type":"uint256"},{"indexed":true,"internalType":"address","name":"author","type":"address"}],"name":"NewPost","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"postId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"nftId","type":"uint256"},{"indexed":false,"internalType":"address","name":"author","type":"address"}],"name":"NewPost","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newName","type":"string"},{"indexed":false,"internalType":"bool","name":"isPaid","type":"bool"}],"name":"NicknameChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"postId","type":"uint256"}],"name":"Sawer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"follower","type":"address"},{"indexed":true,"internalType":"address","name":"unfollowed","type":"address"}],"name":"Unfollowed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"blocker","type":"address"},{"indexed":true,"internalType":"address","name":"blocked","type":"address"}],"name":"UserBlocked","type":"event"},{"inputs":[],"name":"MAX_FREE_CHANGES","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"string","name":"_text","type":"string"},{"internalType":"string","name":"_imageURI","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_target","type":"address"}],"name":"blockUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_newNickname","type":"string"}],"name":"changeNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_imgURI","type":"string"},{"internalType":"string","name":"_metaURI","type":"string"},{"internalType":"string","name":"_caption","type":"string"}],"name":"createPost","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"dislikePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_target","type":"address"}],"name":"followUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"followerList","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"followingList","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAllPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"nftId","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"tokenURI","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficialWayangNusantara.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"}],"name":"getComments","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasOfficialWayangNusantara.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getFollowCounts","outputs":[{"internalType":"uint256","name":"followersCount","type":"uint256"},{"internalType":"uint256","name":"followingCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyFeed","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"nftId","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"tokenURI","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficialWayangNusantara.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyNotifications","outputs":[{"components":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"internalType":"struct PutramasOfficialWayangNusantara.Notification[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getProfile","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficialWayangNusantara.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getProfileById","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficialWayangNusantara.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"nftId","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"tokenURI","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficialWayangNusantara.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"hasBlocked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasDisliked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"idToWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"ownerAddr","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"isFollowing","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"likePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"mintPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nicknamePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"postComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"posts","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"nftId","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"tokenURI","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"}],"name":"ratePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"registerProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"sawerPost","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newPrice","type":"uint256"}],"name":"setNicknamePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tokenCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_target","type":"address"}],"name":"unfollowUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateBioAndPhoto","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userNotifications","outputs":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRating","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"stateMutability":"view","type":"function"}];
        
    window.onload = async () => {
        await initApp();
        const urlParams = new URLSearchParams(window.location.search);
        currentProfileAddr = urlParams.get('addr') ? urlParams.get('addr') : userAddress;

        if(userAddress) {
            // Gunakan EXTENDED_ABI yang baru
            contract = new ethers.Contract(CONTRACT_ADDRESS, EXTENDED_ABI, signer);
            loadProfileData(currentProfileAddr);
        }
    };

    function getOptimizedUrl(ipfsUrl, width = 600) {
        if (!ipfsUrl) return null;
        const rawUrl = ipfsUrl.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
        return `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=${width}&q=80&output=webp`;
    }

    // --- FUNGSI LOAD PROFILE (DIPERBAIKI) ---
    async function loadProfileData(addr) {
        // Validasi alamat
        if (!addr || !ethers.utils.isAddress(addr)) {
            document.getElementById("pNick").innerText = "User Tidak Ditemukan";
            return;
        }

        try {
            // 1. AMBIL DATA PROFIL UTAMA
            const p = await contract.getProfile(addr);
            
            // Simpan data untuk dipakai di loop postingan (Biar Nickname muncul)
            const ownerNick = p.nickname || "Tanpa Nama";
            const ownerWallet = addr.substring(0,6) + "..." + addr.substring(38);
            
            // Siapkan Avatar Pemilik
            let ownerAvatar = "https://via.placeholder.com/40";
            if(p.fotoProfil && p.fotoProfil.length > 5) {
                // Gunakan direct link untuk avatar juga biar aman
                ownerAvatar = p.fotoProfil.replace('ipfs://', 'https://ipfs.io/ipfs/');
            }

            // Render Header Profil
            document.getElementById("pNick").innerText = ownerNick;
            document.getElementById("pBio").innerText = p.bio || "-";
            document.getElementById("pLoc").innerText = p.lokasi || "-";
            document.getElementById("pWallet").innerText = ownerWallet;
            document.getElementById("pAvatar").src = ownerAvatar;

            // Tombol Edit/Ganti Nick (Hanya jika profil sendiri)
            if (userAddress && addr.toLowerCase() === userAddress.toLowerCase()) {
                document.getElementById("myActions").style.display = "flex";
                myChangeCount = p.nameChangeCount ? p.nameChangeCount.toNumber() : 0;
            } else {
                document.getElementById("myActions").style.display = "none";
            }

            // 2. LOAD POSTINGAN
            const posts = await contract.getUserPosts(addr);
            document.getElementById("statPost").innerText = posts.length; // Update ID baru
            loadFollowData(addr); // Panggil fungsi follow system
            const container = document.getElementById("profileFeed");
            container.innerHTML = "";

            if(posts.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:30px;'>Belum ada postingan.</p>";
                return;
            }

            // 3. RENDER LOOP POSTINGAN
            [...posts].reverse().forEach(post => {
                
                const profileLink = `profile.html?addr=${post.author}`;

                // --- LOGIKA GAMBAR (FIX BROKEN IMAGE) ---
                let imgHtml = "";
                if(post.imageURI && post.imageURI.length > 5) {
                    // PENTING: Gunakan RAW URL (Pinata) langsung agar tidak broken image
                    const rawUrl = post.imageURI.replace('ipfs://', 'https://ipfs.io/ipfs/');
                    
                    imgHtml = `
                    <div style="position:relative; margin:10px -15px;">
                        <a href="koleksi.html?id=${post.id}">
                            <img src="${rawUrl}" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/600x400?text=Gagal+Muat';"
                                 class="post-image" 
                                 style="width:100%; display:block; min-height:200px; background:#f0f0f0;" 
                                 loading="lazy">
                        </a>
                    </div>`;
                }

                const avgRating = post.ratingCount > 0 ? (post.totalRatingScore/post.ratingCount).toFixed(1) : '0.0';
                
                const nftBadge = (post.nftId && post.nftId > 0) 
                    ? `<span style="background:#d4af37; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">NFT #${post.nftId}</span>` 
                    : "";

                const html = `
                    <div class="card" id="post-${post.id}" style="padding: 15px; margin-bottom: 20px;">
                        
                        <div class="post-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <a href="${profileLink}">
                                <img src="${ownerAvatar}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee;">
                            </a>
                            
                            <div class="post-info">
                                <a href="${profileLink}" 
                                   style="text-decoration: none; color: #333; font-weight: bold; font-size: 14px;">
                                    ${ownerNick}
                                </a>
                                <div style="font-size: 11px; color: #999;">
                                    ${new Date(post.timestamp * 1000).toLocaleString()} ${nftBadge}
                                </div>
                            </div>
                        </div>

                        <div class="post-caption" style="margin-bottom:10px; font-size:14px; line-height:1.5;">${post.caption}</div>
                        ${imgHtml}

                        <div class="post-actions" style="border-top:1px solid #eee; padding-top:10px; margin-top:5px; display:flex; justify-content:space-around; align-items:center;">
                             
                             <button class="action-btn" onclick="handleLike(${post.id})" style="background:none; border:none; cursor:pointer; color:#666; display:flex; gap:5px; align-items:center;">
                                <i class="fa-regular fa-heart" id="icon-like-${post.id}"></i> 
                                <span id="count-like-${post.id}">${post.likeCount}</span>
                             </button>

                             <button class="action-btn" onclick="openComments(${post.id})" style="background:none; border:none; cursor:pointer; color:#666; display:flex; gap:5px; align-items:center;">
                                <i class="fa-regular fa-comment"></i> ${post.commentCount}
                             </button>

                             <button class="action-btn" onclick="openSawerModal(${post.id})" style="background:none; border:none; cursor:pointer; color:#666;" title="Sawer">
                                <i class="fa-solid fa-gift"></i>
                             </button>

                             <button class="action-btn" style="background:none; border:none; cursor:default; color:gold; display:flex; gap:5px; align-items:center;">
                                <i class="fa-solid fa-star"></i> ${avgRating}
                             </button>

                        </div>
                    </div>`;
                container.innerHTML += html;
            });

        } catch (e) { 
            console.error(e); 
            if(e.code === 'CALL_EXCEPTION' || e.message.includes("buffer")) {
                showToast("Error: Kontrak diperbarui, harap hapus cache browser.", "error");
            } else {
                showToast("Gagal memuat profil: " + (e.reason || e.message), "error");
            }
        }
    }

    // --- FITUR FOLLOW SYSTEM ---
    
    async function loadFollowData(targetAddr) {
        try {
            // 1. Ambil Statistik (Followers & Following)
            // Return contract: (followersCount, followingCount)
            const stats = await contract.getFollowCounts(targetAddr);
            
            document.getElementById("statFollower").innerText = stats[0].toString();
            document.getElementById("statFollowing").innerText = stats[1].toString();

            // 2. Tentukan Tombol Aksi
            const btnContainer = document.getElementById("actionButtons");
            btnContainer.innerHTML = ""; // Bersihkan dulu

            // SKENARIO A: PROFIL SENDIRI
            if (userAddress && targetAddr.toLowerCase() === userAddress.toLowerCase()) {
                // Tampilkan Tombol Edit
                btnContainer.innerHTML = `
                    <button class="btn-primary" style="background: #eee; color: #333;" onclick="openEditModal()">Edit Profil</button>
                    <button class="btn-primary" style="background: #e74c3c;" onclick="openNickModal()">Ganti Nama</button>
                `;
            } 
            // SKENARIO B: PROFIL ORANG LAIN
            else {
                // Cek apakah kita sudah follow dia?
                const isFollowing = await contract.isFollowing(userAddress, targetAddr);
                
                if (isFollowing) {
                    // Tombol Unfollow
                    btnContainer.innerHTML = `
                        <button onclick="toggleFollow('${targetAddr}', false)" class="btn-primary" style="background: #ccc; color: #333; border: 1px solid #999;">
                            <i class="fa-solid fa-user-check"></i> Mengikuti
                        </button>
                        <button onclick="toggleBlock('${targetAddr}')" class="btn-primary" style="background: #333; color: white;">
                            <i class="fa-solid fa-ban"></i>
                        </button>
                    `;
                } else {
                    // Tombol Follow
                    btnContainer.innerHTML = `
                        <button onclick="toggleFollow('${targetAddr}', true)" class="btn-primary" style="background: #3498db;">
                            <i class="fa-solid fa-user-plus"></i> Ikuti
                        </button>
                    `;
                }
            }

        } catch (e) {
            console.error("Gagal load follow data:", e);
        }
    }

    // Fungsi Eksekusi Follow/Unfollow
    async function toggleFollow(targetAddr, isToFollow) {
        try {
            if (isToFollow) {
                showToast("Memproses Mengikuti...", "info");
                const tx = await contract.followUser(targetAddr);
                await tx.wait();
                showToast("Berhasil Mengikuti!", "success");
            } else {
                showToast("Memproses Berhenti Mengikuti...", "info");
                const tx = await contract.unfollowUser(targetAddr);
                await tx.wait();
                showToast("Berhasil Unfollow.", "success");
            }
            // Reload data tanpa refresh halaman
            loadFollowData(targetAddr); 
        } catch (e) {
            showToast("Gagal: " + (e.reason || e.message), "error");
        }
    }
    
    // Fungsi Blokir (Opsional)
    async function toggleBlock(targetAddr) {
        if(!confirm("Blokir user ini? Anda tidak akan melihat postingannya lagi.")) return;
        try {
            const tx = await contract.blockUser(targetAddr);
            await tx.wait();
            showToast("User Diblokir", "success");
            window.location.href = "home.html"; // Lempar ke home
        } catch(e) { showToast("Gagal blokir", "error"); }
    }

    // --- INTERAKSI (COPY PASTE KODE LAMA ANDA DI SINI) ---
    async function handleLike(postId) {
        const countSpan = document.getElementById(`count-like-${postId}`);
        const icon = document.getElementById(`icon-like-${postId}`);
        const current = parseInt(countSpan.innerText);
        countSpan.innerText = current + 1;
        icon.classList.remove("fa-regular");
        icon.classList.add("fa-solid");
        icon.style.color = "#e74c3c";
        try {
            const tx = await contract.likePost(postId - 1);
            await tx.wait();
        } catch (e) {
            countSpan.innerText = current; 
            icon.classList.add("fa-regular");
            icon.classList.remove("fa-solid");
            icon.style.color = "";
            showToast("Gagal Like", "error");
        }
    }

    let selectedRate = 0;
    function openRating(pid) { document.getElementById("targetPostId").value = pid; document.getElementById("ratingModal").showModal(); selectedRate=0; }
    function setRate(n) { selectedRate=n; showToast(`${n} Bintang`, "info"); }
    
    async function submitRating() {
        if(!selectedRate) return showToast("Pilih bintang dulu!", "error");
        const postId = document.getElementById("targetPostId").value;
        try {
            document.getElementById("ratingModal").close();
            const tx = await contract.ratePost(postId - 1, selectedRate);
            showToast("Mengirim Rating...", "info");
            await tx.wait();
            showToast("Rating Berhasil!", "success");
            loadProfileData(currentProfileAddr); 
        } catch (e) { showToast("Gagal Rate: " + e.message, "error"); }
    }

    // --- FITUR GANTI NICKNAME ---
    function openNickModal() {
        document.getElementById("freeCount").innerText = myChangeCount;
        const btn = document.getElementById("btnSaveNick");
        if (myChangeCount >= 2) {
            btn.innerText = "Bayar 0.0001 ETH & Ganti";
        } else {
            btn.innerText = "Ganti (Gratis)";
        }
        document.getElementById("nickModal").showModal();
    }

    async function submitChangeNick() {
        const newNick = document.getElementById("newNickInput").value;
        if (/\d/.test(newNick)) return showToast("Nickname tidak boleh ada angka!", "error");
        if (newNick.length < 3) return showToast("Minimal 3 huruf!", "error");
        try {
            document.getElementById("nickModal").close();
            showToast("Memproses ganti nama...", "info");
            let options = {};
            if (myChangeCount >= 2) {
                options = { value: ethers.utils.parseEther("0.0001") };
            }
            const tx = await contract.changeNickname(newNick, options);
            await tx.wait();
            showToast("Nickname Berhasil Diganti!", "success");
            location.reload();
        } catch(e) { showToast("Gagal: " + (e.reason || e.message), "error"); }
    }

    // --- KOMENTAR ---
    async function openComments(postId) {
        const index = postId - 1; 
        const modal = document.getElementById("commentModal");
        const list = document.getElementById("commentList");

        document.getElementById("commentPostId").value = index;
        document.getElementById("commentInput").value = "";

        modal.showModal();
        // Hapus style display flex manual agar fix CSS margin:auto bekerja
        // modal.style.display = "flex"; <-- JANGAN DIPAKAI LAGI

        list.innerHTML = "<p style='text-align:center; padding:20px;'><i class='fa-solid fa-spinner fa-spin'></i> Memuat...</p>";

        try {
            const comments = await contract.getComments(index);
            list.innerHTML = "";

            if(comments.length === 0) { 
                list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Belum ada komentar.</p>"; 
                return; 
            }

            // Loop Komentar
            for (const c of comments) {
                let nick = c.commenter.substring(0,6) + "..."; // Default Wallet
                let avt = "https://via.placeholder.com/30";   // Default Avatar
                let profileFound = false;

                // 1. CEK CACHE DULU (Biar gak nembak blockchain terus)
                if (commentProfileCache[c.commenter]) {
                    nick = commentProfileCache[c.commenter].nick;
                    avt = commentProfileCache[c.commenter].avt;
                    profileFound = true;
                } 
                // 2. JIKA BELUM ADA DI CACHE, AMBIL DARI SMART CONTRACT
                else {
                    try { 
                        const p = await contract.getProfile(c.commenter);

                        // Cek apakah user sudah set nickname?
                        if(p.nickname && p.nickname.length > 0) {
                            nick = p.nickname;
                        }

                        // Cek foto profil
                        if(p.fotoProfil && p.fotoProfil.length > 5) {
                            // PENTING: Pakai Link Langsung (Jangan dikompres wsrv.nl)
                            // Agar PNG Transparan tidak rusak/hitam
                            avt = p.fotoProfil.replace('ipfs://', 'https://ipfs.io/ipfs/');
                        }

                        // Simpan ke Cache
                        commentProfileCache[c.commenter] = { nick, avt };
                        profileFound = true;

                    } catch(e) {
                        console.warn("Gagal ambil profil:", c.commenter);
                    }
                }

                const commenterLink = `profile.html?addr=${c.commenter}`;

                // HTML Render
                // Perhatikan bagian <img> ada 'onerror' untuk jaga-jaga
                const html = `
                <div class="comment-item" style="border-bottom:1px solid #eee; padding:10px; display:flex; gap:10px; align-items: flex-start;">

                    <a href="${commenterLink}" style="flex-shrink: 0;">
                        <img src="${avt}" 
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/30';"
                             style="width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid #eee; background:#fff;">
                    </a>

                    <div style="flex:1; min-width: 0;">
                        <div style="margin-bottom: 2px;">
                            <a href="${commenterLink}" style="font-weight:bold; font-size:13px; color:#2c3e50; text-decoration:none;">
                                ${nick}
                            </a>
                        </div>

                        <div style="font-size:13px; color:#333; word-wrap: break-word;">${c.text}</div>
                        <div style="font-size:10px; color:#999; margin-top:3px;">${new Date(c.timestamp * 1000).toLocaleString()}</div>
                    </div>
                </div>`;

                list.innerHTML += html;
            }
        } catch(e) { 
            console.error(e);
            list.innerHTML = "Gagal memuat komentar."; 
        }
        }

    async function submitComment() {
        const index = document.getElementById("commentPostId").value;
        const text = document.getElementById("commentInput").value;
        if(!text) return;
        try {
            showToast("Mengirim...", "info");
            const tx = await contract.addComment(index, text, "");
            await tx.wait();
            showToast("Terkirim!", "success");
            document.getElementById("commentInput").value = "";
            openComments(parseInt(index) + 1);
        } catch(e) { showToast("Gagal: " + e.message, "error"); }
    }

    // --- EDIT BIASA ---
    function openEditModal() { document.getElementById('editModal').showModal(); }
    async function submitEditProfile() {
        const bio = document.getElementById("editBio").value;
        const loc = document.getElementById("editLoc").value;
        const file = document.getElementById("editFoto").files[0];
        if(!bio && !loc && !file) return showToast("Tidak ada perubahan", "info");
        try {
            const p = await contract.getProfile(userAddress);
            let imgUri = p.fotoProfil;
            if(file) { showToast("Kompresi 30KB...", "info"); imgUri = await uploadToIPFS(file, 30); }
            showToast("Update Blockchain...", "info");
            const tx = await contract.updateProfile(p.nickname, imgUri, bio || p.bio, loc || p.lokasi);
            await tx.wait();
            showToast("Sukses!", "success");
            location.reload();
        } catch(e) { showToast("Gagal: " + e.message, "error"); }
    }
    
    // --- MODAL SAWER (Wajib Ada) ---
    function openSawerModal(id) {
        if(document.getElementById("sawerModal")) {
            document.getElementById("sawerPostId").value = id;
            document.getElementById("sawerModal").showModal();
        } else {
            showToast("Fitur sawer belum tersedia di halaman ini", "error");
        }
    }

    async function submitSawer() {
        const amount = document.getElementById("sawerAmount").value;
        const postId = document.getElementById("sawerPostId").value;
        if(!amount) return;
        try {
            document.getElementById("sawerModal").close();
            showToast("Mengirim Saweran...", "info");
            const tx = await contract.sawerPost(postId - 1, { value: ethers.utils.parseEther(amount) });
            await tx.wait();
            showToast("Terima kasih sudah menyawer! üéÅ", "success");
        } catch(e) { showToast("Gagal: " + e.message, "error"); }
    }

    // --- FITUR LIST FOLLOWERS/FOLLOWING ---

    async function openFollowList(type) {
        const modal = document.getElementById("followListModal");
        const container = document.getElementById("followListContainer");
        const title = document.getElementById("followListTitle");
        
        // Tentukan Judul & Jumlah Loop
        let count = 0;
        if (type === 'followers') {
            title.innerText = "Pengikut";
            count = parseInt(document.getElementById("statFollower").innerText);
        } else {
            title.innerText = "Mengikuti";
            count = parseInt(document.getElementById("statFollowing").innerText);
        }

        modal.showModal();
        container.innerHTML = "<p style='text-align:center; padding:20px;'><i class='fa-solid fa-spinner fa-spin'></i> Memuat data...</p>";

        if (count === 0) {
            container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Belum ada data.</p>";
            return;
        }

        try {
            // Kita akan ambil data profil target (profil yang sedang dilihat)
            // Pastikan variabel 'currentProfileAddr' tersedia (sudah ada di script profile.html sebelumnya)
            const target = currentProfileAddr || userAddress; 

            let htmlContent = "";
            
            // LOOPING FETCH DATA (Maksimal 20 agar tidak berat)
            // Kontrak: followerList(address user, uint256 index) -> returns address
            const maxFetch = Math.min(count, 20); 

            for (let i = 0; i < maxFetch; i++) {
                let friendAddr = "0x0";
                
                // Panggil getter array dari kontrak
                if (type === 'followers') {
                    friendAddr = await contract.followerList(target, i);
                } else {
                    friendAddr = await contract.followingList(target, i);
                }

                // Ambil Detail Profil Teman
                let nick = friendAddr.substring(0,6) + "...";
                let avt = "https://via.placeholder.com/40";
                
                try {
                    const p = await contract.getProfile(friendAddr);
                    if (p.nickname) nick = p.nickname;
                    if (p.fotoProfil) avt = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                } catch(err) {}

                // Render Item
                htmlContent += `
                <div style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #eee;">
                    <a href="profile.html?addr=${friendAddr}">
                        <img src="${avt}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #eee;">
                    </a>
                    <div style="flex:1;">
                        <a href="profile.html?addr=${friendAddr}" style="text-decoration:none; color:#333; font-weight:bold; font-size:14px;">
                            ${nick}
                        </a>
                        <div style="font-size:11px; color:#999;">${friendAddr.substring(0,8)}...</div>
                    </div>
                </div>`;
            }

            if (count > 20) {
                htmlContent += `<div style="text-align:center; padding:10px; font-size:12px; color:#999;">Dan ${count - 20} lainnya...</div>`;
            }

            container.innerHTML = htmlContent;

        } catch (e) {
            console.error(e);
            container.innerHTML = "<p style='text-align:center; color:red;'>Gagal mengambil daftar.</p>";
        }
    }
    </script>

</body

</html
