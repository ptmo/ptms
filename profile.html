<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body>

    <div class="layout-wrapper">
        
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item"><i class="fa-solid fa-bell"></i> Notifikasi</a>
                <a href="profile.html" class="menu-item active"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="disconnect()" class="menu-item" style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</a>
            </div>
        </div>

        <div class="main-feed">
            
            <div class="card" style="text-align: center; padding: 30px 20px;">
                <img id="pAvatar" src="https://via.placeholder.com/100" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid #f0f2f5; margin-top: -10px; object-fit: cover;">
                
                <h2 id="pNick" style="margin: 10px 0 5px 0; color: #333;">Memuat...</h2>
                <div id="pWallet" style="font-size: 12px; color: #888; background: #eee; display: inline-block; padding: 3px 10px; border-radius: 10px;">0x...</div>
                
                <p id="pBio" style="margin: 15px 0; color: #555; font-style: italic;">-</p>
                
                <div style="display: flex; justify-content: center; gap: 15px; font-size: 13px; color: #666;">
                    <span><i class="fa-solid fa-location-dot"></i> <span id="pLoc">-</span></span>
                    <span><i class="fa-solid fa-image"></i> <span id="pPostCount">0</span> Post</span>
                </div>

                <div id="myActions" style="margin-top: 20px; display: none; gap: 10px; justify-content: center;">
                    <button class="btn-primary" style="font-size: 13px; background: #eee; color: #333;" onclick="openEditModal()">Edit Profil</button>
                    <button class="btn-primary" style="font-size: 13px; background: #e74c3c;" onclick="openNickModal()">Ganti Nickname</button>
                </div>
            </div>

            <h4 style="margin: 20px 0 10px; color: #7385a5;">Postingan</h4>
            
            <div id="profileFeed">
                </div>
        </div>
    </div>

    <dialog id="editModal" style="border:none; border-radius:10px; padding:20px; width:90%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0;">Edit Profil</h3>
        <input type="text" id="editBio" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Bio Baru">
        <input type="text" id="editLoc" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Lokasi Baru">
        <label style="font-size:12px;">Foto Baru (Opsional)</label>
        <input type="file" id="editFoto" class="cp-input">
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('editModal').close()" style="background:none; border:none; cursor:pointer;">Batal</button>
            <button onclick="submitEditProfile()" class="btn-primary">Simpan</button>
        </div>
    </dialog>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item" style="flex-direction: column; gap: 2px; font-size: 10px;"><i class="fa-solid fa-house" style="font-size: 18px;"></i> Home</a>
        <a href="notifications.html" class="menu-item" style="flex-direction: column; gap: 2px; font-size: 10px;"><i class="fa-solid fa-bell" style="font-size: 18px;"></i> Notif</a>
        <a href="profile.html" class="menu-item active" style="flex-direction: column; gap: 2px; font-size: 10px;"><i class="fa-solid fa-user" style="font-size: 18px;"></i> Profil</a>
    </div>

    <div id="toast"></div>
    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        let currentProfileAddr;

        window.onload = async () => {
            await initApp();
            
            // Cek URL params: ?addr=0x...
            const urlParams = new URLSearchParams(window.location.search);
            const addrParam = urlParams.get('addr');

            // Tentukan profil siapa yang dibuka
            currentProfileAddr = addrParam ? addrParam : userAddress;

            loadProfileData(currentProfileAddr);
        };

        async function loadProfileData(addr) {
            try {
                // 1. Get Profile Info
                const p = await contract.getProfile(addr);
                
                document.getElementById("pNick").innerText = p.nickname;
                document.getElementById("pBio").innerText = p.bio;
                document.getElementById("pLoc").innerText = p.lokasi;
                document.getElementById("pWallet").innerText = addr.substring(0,8) + "...";
                if(p.fotoProfil) document.getElementById("pAvatar").src = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');

                // Jika profil sendiri, tampilkan tombol edit
                if (addr.toLowerCase() === userAddress.toLowerCase()) {
                    document.getElementById("myActions").style.display = "flex";
                }

                // 2. Get User Posts
                const posts = await contract.getUserPosts(addr);
                document.getElementById("pPostCount").innerText = posts.length;
                
                const container = document.getElementById("profileFeed");
                container.innerHTML = "";

                if(posts.length === 0) {
                    container.innerHTML = "<p style='text-align:center; color:#999;'>Belum ada postingan.</p>";
                    return;
                }

                [...posts].reverse().forEach(post => {
                    // Render Card Sederhana
                    const imgHtml = post.imageURI ? `<img src="${post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/')}" class="post-image">` : '';
                    const html = `
                    <div class="card">
                        <div class="post-header"><small>${new Date(post.timestamp * 1000).toLocaleDateString()}</small></div>
                        <div class="post-caption">${post.caption}</div>
                        ${imgHtml}
                        <div class="post-actions">
                            <span>❤️ ${post.likeCount}</span>
                            <span>⭐ ${post.ratingCount > 0 ? (post.totalRatingScore/post.ratingCount).toFixed(1) : '0'}</span>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });

            } catch (e) {
                console.error(e);
                showToast("Gagal memuat profil", "error");
            }
        }

        // --- EDIT FUNCTIONS ---
        function openEditModal() { document.getElementById('editModal').showModal(); }
        
        async function submitEditProfile() {
            const bio = document.getElementById("editBio").value;
            const loc = document.getElementById("editLoc").value;
            const file = document.getElementById("editFoto").files[0];
            
            // Jika kosong, pakai data lama (idealnya fetch data lama dulu, tapi ini simplified)
            if(!bio && !loc && !file) return showToast("Tidak ada perubahan", "info");

            try {
                // Ambil data lama dulu untuk fallback
                const p = await contract.getProfile(userAddress);
                let imgUri = p.fotoProfil;
                
                if(file) {
                    showToast("Upload gambar baru...", "info");
                    imgUri = await uploadToIPFS(file);
                }

                showToast("Update Profil di Blockchain...", "info");
                const tx = await contract.updateProfile(
                    p.nickname, // Nickname tidak berubah di fungsi ini
                    imgUri, 
                    bio || p.bio, 
                    loc || p.lokasi
                );
                await tx.wait();
                
                showToast("Sukses!", "success");
                location.reload();
            } catch(e) {
                showToast("Gagal: " + e.message, "error");
            }
        }
        
        // Fitur Ganti Nickname (Premium) bisa ditambahkan logikanya serupa dengan edit profile
    </script>
</body>
</html>
