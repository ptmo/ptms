<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Pencarian | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* CSS KHUSUS HALAMAN RESULT */
        .search-grid {
            display: grid;
            grid-template-columns: 1fr 300px; /* Kiri Lebar, Kanan 300px */
            gap: 20px;
        }
        
        /* Tampilan Mobile: Stack ke bawah */
        @media (max-width: 768px) {
            .search-grid { grid-template-columns: 1fr; }
            .col-users { order: -1; margin-bottom: 20px; } 
        }

        .section-title {
            font-size: 14px; font-weight: bold; color: #7385a5;
            border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* User Card Style */
        .user-result-card {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; background: white; border-radius: 8px;
            border: 1px solid #eee; margin-bottom: 10px;
        }
        .btn-follow-small {
            padding: 5px 10px; font-size: 11px; border-radius: 20px;
            border: 1px solid #3498db; background: transparent; color: #3498db;
            cursor: pointer; transition: 0.2s;
        }
        .btn-follow-small:hover { background: #3498db; color: white; }
        .btn-follow-small.following { background: #eee; border-color: #ccc; color: #666; }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item"><i class="fa-solid fa-bell"></i> Notifikasi</a>
                <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="window.history.back()" class="menu-item" style="color: #7385a5;"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
            </div>
        </div>

        <div class="main-feed" style="max-width: 100%;"> 
            <div class="card" style="padding: 15px; margin-bottom: 20px;">
                <h2 style="margin:0; font-size:18px; color:#333;">
                    <i class="fa-solid fa-magnifying-glass"></i> Hasil Pencarian: <span id="queryDisplay" style="color:#e74c3c;">...</span>
                </h2>
            </div>

            <div class="search-grid">
                
                <div class="col-posts">
                    <div class="section-title"><i class="fa-regular fa-newspaper"></i> Postingan Terkait</div>
                    <div id="postsResultContainer">
                        <div style="text-align:center; padding:20px; color:#999;"><i class="fa-solid fa-spinner fa-spin"></i> Mencari Wayang...</div>
                    </div>
                </div>

                <div class="col-users">
                    <div class="section-title"><i class="fa-solid fa-users"></i> Pengguna Ditemukan</div>
                    <div id="usersResultContainer">
                        <div style="text-align:center; padding:20px; color:#999;"><i class="fa-solid fa-spinner fa-spin"></i> Mencari Orang...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        // Ambil Kata Kunci dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') ? urlParams.get('q').toLowerCase().trim() : "";

        // Tampilkan kata kunci di Header
        document.getElementById("queryDisplay").innerText = query || "Semua";

        // --- WINDOW ONLOAD ---
        window.onload = async () => {
            await initApp();
            
            if(!query) {
                document.getElementById("postsResultContainer").innerHTML = "<p style='text-align:center; color:#999;'>Masukkan kata kunci pencarian.</p>";
                document.getElementById("usersResultContainer").innerHTML = "";
                return;
            }

            if(userAddress) {
                performSearch();
            }
        };

        // --- FUNGSI PENCARIAN UTAMA ---
        async function performSearch() {
            // A. CARI POSTINGAN (Berdasarkan Caption)
            searchPosts();

            // B. CARI USER (Berdasarkan Data Registrasi Blockchain)
            searchUsers();
        }

        // --- A. LOGIKA CARI POSTINGAN ---
        async function searchPosts() {
            const container = document.getElementById("postsResultContainer");
            container.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'><i class='fa-solid fa-spinner fa-spin'></i> Mencari di arsip...</div>";

            try {
                // Ambil semua postingan
                const allPosts = await contract.getAllPosts();
                
                // Filter: Caption mengandung kata kunci
                // NOTE: Pencarian NFT (Arjuna) tidak bisa dilakukan ke metadata IPFS secara instan client-side
                // Jadi kita hanya mencari di Caption. Pastikan saat posting, nama wayang masuk ke caption atau metadata.
                const filtered = allPosts.filter(p => p.caption.toLowerCase().includes(query));

                container.innerHTML = "";
                if(filtered.length === 0) {
                    container.innerHTML = `
                    <div style='padding:30px; text-align:center; color:#999; border:1px dashed #ddd; border-radius:8px;'>
                        <i class="fa-regular fa-folder-open fa-2x"></i><br><br>
                        Tidak ada postingan dengan kata kunci "${query}" di caption.
                    </div>`;
                    return;
                }

                // Render Hasil
                [...filtered].reverse().forEach(post => {
                    const profileLink = `profile.html?addr=${post.author}`;
                    
                    // Logika Gambar
                    let imgHtml = "";
                    if(post.imageURI && post.imageURI.length > 5) {
                        const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                        const optUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=600&q=80&output=webp`;
                        imgHtml = `<a href="koleksi.html?id=${post.id}"><img src="${optUrl}" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-top:10px; background:#f0f0f0;"></a>`;
                    }
                    
                    // Render Kartu Simple
                    const html = `
                    <div class="card" style="padding:15px; margin-bottom:15px;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <a href="${profileLink}">
                                <img src="https://via.placeholder.com/30" class="avt-${post.author}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                            </a>
                            <div>
                                <div style="font-weight:bold; font-size:13px;">
                                    <a href="${profileLink}" class="nick-${post.author}" style="text-decoration:none; color:#333;">${post.author.substring(0,6)}...</a>
                                </div>
                                <div style="font-size:10px; color:#999;">${new Date(post.timestamp * 1000).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <p style="font-size:13px; margin:10px 0;">${post.caption}</p>
                        ${imgHtml}
                    </div>`;
                    
                    container.innerHTML += html;
                    fetchProfileLazy(post.author); // Ambil nama & foto author
                });

            } catch(e) {
                console.error("Post search error:", e);
                container.innerHTML = "<p style='color:red; text-align:center;'>Gagal memuat postingan.</p>";
            }
        }

        // --- B. LOGIKA CARI USER (FIXED: Loop ID) ---
        async function searchUsers() {
            const container = document.getElementById("usersResultContainer");
            container.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'><i class='fa-solid fa-spinner fa-spin'></i> Memindai User...</div>";

            try {
                // 1. Ambil Total User
                // Pastikan smart contract Anda memiliki public variable 'userCounter'
                const userCountBN = await contract.userCounter();
                const totalUsers = userCountBN.toNumber();
                let foundCount = 0;
                let htmlResult = "";

                // 2. Loop Semua User (Dari ID 1 sampai Total)
                for (let i = 1; i <= totalUsers; i++) {
                    try {
                        // Ambil data user dari mapping 'users' berdasarkan ID
                        // Pastikan struct 'users' public di smart contract: mapping(uint256 => UserProfile) public users;
                        const u = await contract.users(i); 
                        
                        // Cek Validitas Data (kadang ada data kosong jika di-delete/burn)
                        if(u.wallet === "0x0000000000000000000000000000000000000000") continue;

                        // Cek Nama vs Query (Case Insensitive)
                        if (u.nickname.toLowerCase().includes(query) || u.wallet.toLowerCase() === query) {
                            foundCount++;
                            
                            // Siapkan Data
                            const displayNick = u.nickname || "Tanpa Nama";
                            const displayAvt = u.fotoProfil ? u.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/40";
                            const addr = u.wallet;

                            // Cek Follow Status
                            const isFollowing = await contract.isFollowing(userAddress, addr);
                            const btnAction = isFollowing ? `unfollow('${addr}')` : `follow('${addr}')`;
                            const btnText = isFollowing ? "Mengikuti" : "Ikuti";
                            const btnClass = isFollowing ? "btn-follow-small following" : "btn-follow-small";
                            
                            // Tombol Follow (Sembunyikan jika diri sendiri)
                            let btnHtml = `<button onclick="${btnAction}" class="${btnClass}">${btnText}</button>`;
                            if (addr.toLowerCase() === userAddress.toLowerCase()) btnHtml = `<span style='font-size:10px; color:#999;'>Anda</span>`;

                            // Render Item User
                            htmlResult += `
                            <div class="user-result-card">
                                <a href="profile.html?addr=${addr}">
                                    <img src="${displayAvt}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #eee;">
                                </a>
                                <div style="flex:1; min-width:0;">
                                    <a href="profile.html?addr=${addr}" style="text-decoration:none; color:#333; font-weight:bold; font-size:13px; display:block;">
                                        ${displayNick}
                                    </a>
                                    <div style="font-size:10px; color:#999;">${addr.substring(0,6)}...${addr.substring(38)}</div>
                                </div>
                                ${btnHtml}
                            </div>`;
                        }
                    } catch (err) {
                        console.warn("Skip user id " + i, err);
                    }
                }

                // 3. Tampilkan Hasil
                container.innerHTML = htmlResult;
                
                if (foundCount === 0) {
                    container.innerHTML = `
                    <div style='text-align:center; padding:20px; color:#999;'>
                        <i class="fa-solid fa-user-slash"></i><br>
                        User "${query}" tidak ditemukan.
                    </div>`;
                }

            } catch(e) {
                console.error("User search error:", e);
                container.innerHTML = "<p style='color:red; text-align:center; font-size:12px;'>Gagal memuat user (Network/Contract Error).</p>";
            }
        }

        // --- HELPER LAINNYA ---
        
        async function fetchProfileLazy(address) {
            try {
                const p = await contract.getProfile(address);
                const avt = p.fotoProfil ? p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/30";
                const nick = p.nickname || address.substring(0,6)+"...";
                
                document.querySelectorAll(`.avt-${address}`).forEach(el => el.src = avt);
                document.querySelectorAll(`.nick-${address}`).forEach(el => el.innerText = nick);
            } catch(e) {}
        }

        async function follow(target) {
            try {
                showToast("Memproses...", "info");
                const tx = await contract.followUser(target);
                await tx.wait();
                showToast("Berhasil mengikuti!", "success");
                // Refresh hasil user saja tanpa reload page
                searchUsers();
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }
        
        async function unfollow(target) {
            try {
                showToast("Memproses...", "info");
                const tx = await contract.unfollowUser(target);
                await tx.wait();
                showToast("Berhasil unfollow.", "success");
                searchUsers();
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }
    </script>
</body>
</html>
