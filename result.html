<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencarian Deep Scan | Putramas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .search-grid { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 768px) { .search-grid { grid-template-columns: 1fr; } .col-users { order: -1; margin-bottom: 20px; } }
        .section-title { font-size: 14px; font-weight: bold; color: #7385a5; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .user-result-card { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px; animation: fadeIn 0.5s; }
        .btn-follow-small { padding: 5px 10px; font-size: 11px; border-radius: 20px; border: 1px solid #3498db; background: transparent; color: #3498db; cursor: pointer; }
        .btn-follow-small:hover { background: #3498db; color: white; }
        .btn-follow-small.following { background: #eee; border-color: #ccc; color: #666; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Indikator Deep Scan */
        .scanning-bar { height: 4px; width: 100%; background: #eee; margin-top: 10px; border-radius: 2px; overflow: hidden; display: none; }
        .scanning-progress { height: 100%; background: #e74c3c; width: 0%; transition: width 0.3s; }

    /* =========================================
       BAGIAN 1: HEADER PENCARIAN (PREMIUM)
       (Wajib ada agar Search Bar rapi)
       ========================================= */
    
    .header-wrapper {
        position: relative;
        width: 100%;
        max-width: 600px;
        margin: 0 auto 10px auto; 
    }

    /* Input Field */
    .custom-search-input {
        width: 100%;
        height: 48px;
        /* Padding: Kiri 75px (ikon+back), Kanan 20px */
        padding: 12px 20px 12px 75px; 
        background: #ffffff;
        border: 1px solid transparent;
        border-radius: 14px;
        font-size: 15px;
        color: #334155;
        outline: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05); /* Shadow halus */
        box-sizing: border-box;
        transition: all 0.3s ease;
    }
    .custom-search-input:focus {
        box-shadow: 0 0 0 4px rgba(115, 133, 165, 0.2);
        border-color: #bfdbfe;
    }

    /* Ikon Kaca Pembesar (Overlay) */
    .icon-overlay {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        left: 45px; /* Default (Mobile) */
        color: #7385a5;
        font-size: 16px;
        pointer-events: none;
        z-index: 9;
    }

    /* Tombol Back (Mobile) */
    .btn-back-mobile {
        position: absolute;
        left: 10px;
        top: 24px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #7385a5;
        font-size: 18px;
        cursor: pointer;
        padding: 5px;
        z-index: 10;
    }

    /* Status Deep Search (Rata Kanan) */
    .status-container {
        display: flex;
        align-items: center;
        justify-content: flex-end; /* Rata Kanan */
        margin-top: 8px;
        padding-right: 5px;
        font-size: 11px;
        color: #7385a5;
        font-weight: 500;
    }
    
    /* Warna elemen status */
    .status-container span, .status-container b, .status-container i {
        color: #7385a5 !important;
    }

    /* Animasi Loader */
    .spin-loader {
        animation: spin 1.5s linear infinite;
        margin-right: 6px;
        min-width: 14px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }


    /* --- LOGIKA RESPONSIF PC (>768px) --- */
    @media (min-width: 768px) {
        .btn-back-mobile { display: none !important; } /* Hilangkan tombol back */
        .icon-overlay { left: 20px !important; }       /* Geser ikon search ke kiri */
        .custom-search-input { padding-left: 50px !important; } /* Kurangi padding input */
    }


    /* =========================================
       BAGIAN 2: CSS STABLE PILIHAN ANDA (BAWAH)
       (Grid, Card, Scanning Bar - Tidak Diubah)
       ========================================= */

    .search-grid { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
    @media (max-width: 768px) { .search-grid { grid-template-columns: 1fr; } .col-users { order: -1; margin-bottom: 20px; } }
    .section-title { font-size: 14px; font-weight: bold; color: #7385a5; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
    .user-result-card { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px; animation: fadeIn 0.5s; }
    .btn-follow-small { padding: 5px 10px; font-size: 11px; border-radius: 20px; border: 1px solid #3498db; background: transparent; color: #3498db; cursor: pointer; }
    .btn-follow-small:hover { background: #3498db; color: white; }
    .btn-follow-small.following { background: #eee; border-color: #ccc; color: #666; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Indikator Deep Scan (Stable) */
    .scanning-bar { height: 4px; width: 100%; background: #eee; margin-top: 10px; border-radius: 2px; overflow: hidden; display: none; }
    .scanning-progress { height: 100%; background: #e74c3c; width: 0%; transition: width 0.3s; }
    
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="#" onclick="window.history.back()" class="menu-item" style="color: #7385a5;"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
            </div>
        </div>

        <div class="header-wrapper">
    
    <button type="button" onclick="window.history.back()" class="btn-back-mobile">
        <i class="fa-solid fa-chevron-left"></i>
    </button>
    
    <i class="fa-solid fa-magnifying-glass icon-overlay"></i>

    <input type="search" 
           id="searchInput" 
           class="custom-search-input" 
           placeholder="Pencarian..." 
           autocomplete="off">

    <div class="status-container">
        <i class="fa-solid fa-circle-notch spin-loader"></i>
        
        <span>
            Deep Search: <b id="queryDisplay">...</b>
            
            <span id="scanStatus" style="display: inline !important; margin-left: 5px;">
                <span id="scanCount" style="display:none;"></span>
            </span>
        </span>
    </div>

    <div class="scanning-bar" id="scanBar" style="display: none !important;">
        <div class="scanning-progress" id="scanProgress"></div>
    </div>

        </div>

            <div class="search-grid">
                <div class="col-posts">
                    <div class="section-title"><i class="fa-regular fa-newspaper"></i> Hasil Postingan & NFT</div>
                    <div id="postsResultContainer"></div>
                </div>

                <div class="col-users">
                    <div class="section-title"><i class="fa-solid fa-users"></i> Pengguna Ditemukan</div>
                    <div id="usersResultContainer">
                        <div style="text-align:center; padding:20px; color:#999;"><i class="fa-solid fa-circle-notch fa-spin"></i> Menunggu Koneksi...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"></div>
    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') ? urlParams.get('q').toLowerCase().trim() : "";
        document.getElementById("queryDisplay").innerText = query || "Semua";
        
        const displayedPostIds = new Set(); 

        // --- 1. STARTUP SUPER CEPAT (DOMContentLoaded) ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Langsung tampilkan UI kerangka
            if(!query) {
                document.getElementById("postsResultContainer").innerHTML = "<p style='color:#999; text-align:center;'>Ketik kata kunci untuk mencari.</p>";
                document.getElementById("usersResultContainer").innerHTML = "";
                return;
            }

            // Init Wallet di Background
            await initApp();

            if(userAddress) {
                // JALANKAN PARALEL (Supaya User & Post jalan bareng)
                // Kita tidak pakai 'await' di sini agar keduanya jalan serentak
                searchUsersBrutal(); 
                searchPostsDeep();
            }
        });

        // ==========================================
        // 2. PENCARIAN USER (INCREMENTAL RENDER)
        // ==========================================
        async function searchUsersBrutal() {
            const container = document.getElementById("usersResultContainer");
            container.innerHTML = "<div style='text-align:center; color:#999; font-size:12px;'><i class='fa-solid fa-spinner fa-spin'></i> Memindai ID...</div>";

            try {
                const userCountBN = await contract.userCounter();
                const totalUsers = userCountBN.toNumber();
                
                let foundCount = 0;
                
                // Bersihkan loading spinner jika user > 0
                if(totalUsers > 0) container.innerHTML = "";

                for (let i = 1; i <= totalUsers; i++) {
                    try {
                        // Ambil data satu per satu
                        let u;
                        try { u = await contract.getProfileById(i); } catch(e) { u = await contract.users(i); }
                        
                        if(u.wallet === "0x0000000000000000000000000000000000000000") continue;

                        const nickname = u.nickname ? u.nickname.toLowerCase() : "";
                        const wallet = u.wallet ? u.wallet.toLowerCase() : "";

                        // Jika Cocok, LANGSUNG Render (Jangan ditampung di variabel)
                        if (nickname.includes(query) || wallet === query) {
                            foundCount++;
                            const html = await generateUserHTML(u);
                            container.insertAdjacentHTML('beforeend', html); // Tampil seketika
                        }
                    } catch (err) {}
                }

                if (foundCount === 0) {
                    container.innerHTML = `<div style='text-align:center; padding:20px; color:#999; font-size:12px;'>User tidak ditemukan.</div>`;
                }

            } catch(e) {
                container.innerHTML = "<p style='color:red; font-size:11px;'>Gagal akses data user.</p>";
            }
        }

        async function generateUserHTML(u) {
            const displayNick = u.nickname || "Tanpa Nama";
            const displayAvt = u.fotoProfil ? u.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/40";
            const addr = u.wallet;
            
            let isFollowing = false;
            try { isFollowing = await contract.isFollowing(userAddress, addr); } catch(e) {}

            const btnAction = isFollowing ? `unfollow('${addr}')` : `follow('${addr}')`;
            const btnText = isFollowing ? "Mengikuti" : "Ikuti";
            const btnClass = isFollowing ? "btn-follow-small following" : "btn-follow-small";
            
            let btnHtml = `<button onclick="${btnAction}" class="${btnClass}">${btnText}</button>`;
            if (addr.toLowerCase() === userAddress.toLowerCase()) btnHtml = `<span style='font-size:10px; color:#999;'>Anda</span>`;

            return `
            <div class="user-result-card">
                <a href="profile.html?addr=${addr}"><img src="${displayAvt}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #eee;"></a>
                <div style="flex:1; min-width:0;">
                    <a href="profile.html?addr=${addr}" style="text-decoration:none; color:#333; font-weight:bold; font-size:13px; display:block;">${displayNick}</a>
                    <div style="font-size:10px; color:#999;">${addr.substring(0,6)}...</div>
                </div>
                ${btnHtml}
            </div>`;
        }

        // ==========================================
        // 3. PENCARIAN POST (CAPTION + DEEP SCAN)
        // ==========================================
        async function searchPostsDeep() {
            const container = document.getElementById("postsResultContainer");
            const scanBar = document.getElementById("scanBar");
            const scanProgress = document.getElementById("scanProgress");
            const scanStatus = document.getElementById("scanStatus");
            const scanCountEl = document.getElementById("scanCount");

            try {
                // 1. Ambil Postingan (Agak berat, tapi wajib)
                const allPosts = await contract.getAllPosts();
                
                // 2. HASIL CEPAT: Filter Caption (Langsung Tampil)
                const captionMatches = allPosts.filter(p => p.caption.toLowerCase().includes(query));
                
                container.innerHTML = "";
                captionMatches.forEach(post => {
                    displayedPostIds.add(post.id.toString());
                    container.innerHTML += generatePostHTML(post, "Ditemukan di Caption");
                    fetchProfileLazy(post.author);
                });

                if(container.innerHTML === "") container.innerHTML = "<p style='text-align:center; color:#999;'>Mencari di Metadata NFT...</p>";

                // 3. HASIL LAMBAT: Filter IPFS (Deep Scan)
                const deepScanTargets = allPosts.filter(p => !displayedPostIds.has(p.id.toString()) && p.nftId > 0 && p.tokenURI);
                
                if(deepScanTargets.length > 0) {
                    scanBar.style.display = "block";
                    scanStatus.style.display = "block";
                    
                    let scanned = 0;
                    const total = deepScanTargets.length;

                    // Scan satu per satu agar tidak hang
                    for (const post of deepScanTargets) {
                        scanned++;
                        const pct = (scanned / total) * 100;
                        scanProgress.style.width = pct + "%";
                        scanCountEl.innerText = `${scanned}/${total}`;

                        try {
                            const url = post.tokenURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                            
                            // Timeout 2 detik per file agar cepat
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 2000); 
                            
                            const res = await fetch(url, { signal: controller.signal });
                            clearTimeout(timeoutId);

                            if(res.ok) {
                                const meta = await res.json();
                                const metaString = JSON.stringify(meta).toLowerCase();
                                
                                if (metaString.includes(query)) {
                                    // Jika cocok, TAMBAHKAN ke bawah (Incremental)
                                    // Hapus pesan loading jika ini hasil pertama
                                    if(container.innerHTML.includes("Mencari di Metadata")) container.innerHTML = "";
                                    
                                    container.innerHTML += generatePostHTML(post, `Metadata: ${meta.name || 'NFT'}`);
                                    fetchProfileLazy(post.author);
                                    // Render detail metadata belakangan
                                    setTimeout(() => renderMetadataSpecific(post.id, meta), 100);
                                }
                            }
                        } catch(err) { }
                    }
                }

                // Selesai
                setTimeout(() => {
                    scanStatus.innerHTML = "<i class='fa-solid fa-check'></i> Selesai.";
                    scanBar.style.display = "none";
                    if(container.innerHTML.includes("Mencari di Metadata") || container.innerHTML === "") {
                        container.innerHTML = `<div style='padding:30px; text-align:center; color:#999; border:1px dashed #ddd; border-radius:8px;'>Tidak ditemukan hasil untuk "${query}".</div>`;
                    }
                }, 1000);

            } catch(e) { console.error(e); }
        }

        // --- HELPER HTML ---
        function generatePostHTML(post, foundReason) {
            const profileLink = `profile.html?addr=${post.author}`;
            let imgHtml = "";
            let metaBox = ""; 

            if(post.imageURI && post.imageURI.length > 5) {
                const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                const optUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=600&q=80&output=webp`;
                
                if(post.nftId > 0) {
                     metaBox = `<div class="nft-citation" style="background:#f0fff4; padding:8px; border:1px solid #c6f6d5; border-top:none; border-radius:0 0 10px 10px; font-size:11px; color:#2f855a; margin-top:-4px;"><i class="fa-solid fa-bolt"></i> ${foundReason}<div id="meta-details-${post.id}" style="margin-top:5px; color:#555;"></div></div>`;
                }
                imgHtml = `<a href="koleksi.html?id=${post.id}"><img src="${optUrl}" style="width:100%; height:auto; display:block; border-radius:${post.nftId>0?'0':'8px'}; margin-top:10px; background:#f0f0f0;"></a>${metaBox}`;
            }
            
            return `
            <div class="card" style="padding:15px; margin-bottom:15px; animation: fadeIn 0.5s;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <a href="${profileLink}"><img src="https://via.placeholder.com/30" class="avt-${post.author}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;"></a>
                    <div>
                        <div style="font-weight:bold; font-size:13px;"><a href="${profileLink}" class="nick-${post.author}" style="text-decoration:none; color:#333;">${post.author.substring(0,6)}...</a></div>
                        <div style="font-size:10px; color:#999;">${new Date(post.timestamp * 1000).toLocaleDateString()}</div>
                    </div>
                </div>
                <p style="font-size:13px; margin:10px 0;">${post.caption}</p>
                ${imgHtml}
            </div>`;
        }

        function renderMetadataSpecific(postId, meta) {
            const el = document.getElementById(`meta-details-${postId}`);
            if(!el) return;
            let gagrak = "-";
            if(meta.attributes) {
                const attr = meta.attributes.find(a => a.trait_type.includes("Gaya") || a.trait_type.includes("Gagrak"));
                if(attr) gagrak = attr.value;
            }
            el.innerHTML = `<strong>${meta.name}</strong> â€¢ Gagrak: ${gagrak}`;
        }

        // --- HELPER STANDARD ---
        async function fetchProfileLazy(address) {
            try {
                const p = await contract.getProfile(address);
                const avt = p.fotoProfil ? p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/30";
                const nick = p.nickname || address.substring(0,6)+"...";
                document.querySelectorAll(`.avt-${address}`).forEach(el => el.src = avt);
                document.querySelectorAll(`.nick-${address}`).forEach(el => el.innerText = nick);
            } catch(e) {}
        }
        async function follow(target) {
            try { showToast("Memproses...", "info"); const tx = await contract.followUser(target); await tx.wait(); showToast("Berhasil!", "success"); } catch(e) { showToast("Gagal", "error"); }
        }
        async function unfollow(target) {
            try { showToast("Memproses...", "info"); const tx = await contract.unfollowUser(target); await tx.wait(); showToast("Berhasil!", "success"); } catch(e) { showToast("Gagal", "error"); }
        }
    </script>
</body>
</html>
