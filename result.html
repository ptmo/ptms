<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Pencarian | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* CSS KHUSUS HALAMAN RESULT */
        .search-grid {
            display: grid;
            grid-template-columns: 1fr 300px; /* Kiri Lebar, Kanan 300px */
            gap: 20px;
        }
        
        /* Tampilan Mobile: Stack ke bawah */
        @media (max-width: 768px) {
            .search-grid { grid-template-columns: 1fr; }
            /* Balik urutan di mobile: User dulu baru post, atau sebaliknya sesuai selera */
            .col-users { order: -1; margin-bottom: 20px; } 
        }

        .section-title {
            font-size: 14px; font-weight: bold; color: #7385a5;
            border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* User Card Style */
        .user-result-card {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; background: white; border-radius: 8px;
            border: 1px solid #eee; margin-bottom: 10px;
        }
        .btn-follow-small {
            padding: 5px 10px; font-size: 11px; border-radius: 20px;
            border: 1px solid #3498db; background: transparent; color: #3498db;
            cursor: pointer; transition: 0.2s;
        }
        .btn-follow-small:hover { background: #3498db; color: white; }
        .btn-follow-small.following { background: #eee; border-color: #ccc; color: #666; }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item"><i class="fa-solid fa-bell"></i> Notifikasi</a>
                <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="window.history.back()" class="menu-item" style="color: #7385a5;"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
            </div>
        </div>

        <div class="main-feed" style="max-width: 100%;"> <div class="card" style="padding: 15px; margin-bottom: 20px;">
                <h2 style="margin:0; font-size:18px; color:#333;">
                    <i class="fa-solid fa-magnifying-glass"></i> Hasil Pencarian: <span id="queryDisplay" style="color:#e74c3c;">...</span>
                </h2>
            </div>

            <div class="search-grid">
                
                <div class="col-posts">
                    <div class="section-title"><i class="fa-regular fa-newspaper"></i> Postingan Terkait</div>
                    <div id="postsResultContainer">
                        <div style="text-align:center; padding:20px; color:#999;"><i class="fa-solid fa-spinner fa-spin"></i> Mencari Wayang...</div>
                    </div>
                </div>

                <div class="col-users">
                    <div class="section-title"><i class="fa-solid fa-users"></i> Pengguna Ditemukan</div>
                    <div id="usersResultContainer">
                        <div style="text-align:center; padding:20px; color:#999;"><i class="fa-solid fa-spinner fa-spin"></i> Mencari Orang...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        // Ambil Kata Kunci dari URL (?q=Budi)
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') ? urlParams.get('q').toLowerCase() : "";

        // Tampilkan kata kunci di Header
        document.getElementById("queryDisplay").innerText = query || "Semua";

        window.onload = async () => {
            await initApp();
            if(userAddress && query) {
                performSearch();
            } else {
                document.getElementById("postsResultContainer").innerHTML = "<p>Silakan masukkan kata kunci.</p>";
                document.getElementById("usersResultContainer").innerHTML = "";
            }
        };

        async function performSearch() {
            // 1. CARI POSTINGAN (Filter Caption)
            try {
                const allPosts = await contract.getAllPosts();
                const filteredPosts = allPosts.filter(p => p.caption.toLowerCase().includes(query));
                renderPosts(filteredPosts);
            } catch(e) { console.error(e); }

            // 2. CARI USER (Looping User ID)
            // Smart contract tidak punya fitur "Search User", jadi kita harus manual loop
            // Ini mungkin lambat jika user ribuan, tapi oke untuk demo.
            try {
                const userCount = await contract.userCounter(); // Pastikan di ABI ada userCounter
                const foundUsers = [];
                const maxSearch = userCount.toNumber(); 

                // Kita loop semua user (atau batasi 50 terakhir biar cepat)
                for(let i = 1; i <= maxSearch; i++) {
                    try {
                        // Get Profile By ID (Pastikan fungsi ini ada di Contract/ABI)
                        // Kalau tidak ada, kita pakai getProfile(address) dari list address jika ada.
                        // Asumsi: Contract punya getProfileById atau kita pakai cara lain.
                        // JIKA TIDAK ADA getProfileById, kita skip bagian ini atau pakai trik lain.
                        
                        // TRIK AMAN: Cari User dari Author Postingan yang sudah ditarik
                        // (Lebih hemat gas daripada nembak ID satu2)
                    } catch(err) {}
                }
                
                // ALTERNATIF SEARCH USER (DARI DATA POSTINGAN AGAR CEPAT)
                // Kita ambil semua author unik dari postingan, lalu cek namanya
                const allPosts = await contract.getAllPosts();
                const uniqueAuthors = [...new Set(allPosts.map(p => p.author))];
                
                document.getElementById("usersResultContainer").innerHTML = "";
                let userFoundCount = 0;

                for (const addr of uniqueAuthors) {
                    const p = await contract.getProfile(addr);
                    const nick = p.nickname || "";
                    
                    // Cek apakah Nickname atau Address mengandung kata kunci
                    if (nick.toLowerCase().includes(query) || addr.toLowerCase().includes(query)) {
                        userFoundCount++;
                        renderUserCard(addr, p);
                    }
                }

                if(userFoundCount === 0) {
                    document.getElementById("usersResultContainer").innerHTML = "<p style='color:#999; font-size:12px;'>Tidak ada user dengan nama tersebut di daftar kreator.</p>";
                }

            } catch(e) { 
                console.error("User search error", e);
                document.getElementById("usersResultContainer").innerHTML = "Gagal memuat user.";
            }
        }

        // --- RENDER POSTINGAN (Sama seperti Home) ---
        function renderPosts(posts) {
            const container = document.getElementById("postsResultContainer");
            container.innerHTML = "";
            
            if(posts.length === 0) {
                container.innerHTML = "<div style='padding:20px; background:white; border-radius:8px; text-align:center; color:#999;'>Tidak ditemukan postingan.</div>";
                return;
            }

            [...posts].reverse().forEach(post => {
                // ... (Snippet Render Kartu Postingan Sederhana) ...
                const profileLink = `profile.html?addr=${post.author}`;
                let imgHtml = "";
                if(post.imageURI && post.imageURI.length > 5) {
                    const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    const optUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=600&q=80&output=webp`;
                    imgHtml = `<a href="koleksi.html?id=${post.id}"><img src="${optUrl}" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-top:10px;"></a>`;
                }
                
                const html = `
                <div class="card" style="padding:15px; margin-bottom:15px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="https://via.placeholder.com/30" class="avt-${post.author}" style="width:30px; height:30px; border-radius:50%;">
                        <div>
                            <div style="font-weight:bold; font-size:13px;" class="nick-${post.author}">${post.author.substring(0,6)}...</div>
                            <div style="font-size:10px; color:#999;">${new Date(post.timestamp * 1000).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <p style="font-size:13px; margin:10px 0;">${post.caption}</p>
                    ${imgHtml}
                </div>`;
                container.innerHTML += html;
                fetchProfileLazy(post.author); // Helper profile fetcher
            });
        }

        // --- RENDER USER CARD ---
        async function renderUserCard(addr, profile) {
            const container = document.getElementById("usersResultContainer");
            const nick = profile.nickname || addr.substring(0,6)+"...";
            const avt = profile.fotoProfil ? profile.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/40";
            
            // Cek status follow
            const isFollowing = await contract.isFollowing(userAddress, addr);
            const btnText = isFollowing ? "Mengikuti" : "Ikuti";
            const btnClass = isFollowing ? "btn-follow-small following" : "btn-follow-small";
            const btnAction = isFollowing ? `unfollow('${addr}')` : `follow('${addr}')`;

            // Jangan tampilkan tombol follow jika diri sendiri
            let btnHtml = `<button onclick="${btnAction}" class="${btnClass}">${btnText}</button>`;
            if(addr.toLowerCase() === userAddress.toLowerCase()) btnHtml = `<span style="font-size:10px; color:#999;">Anda</span>`;

            const html = `
            <div class="user-result-card">
                <a href="profile.html?addr=${addr}">
                    <img src="${avt}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #eee;">
                </a>
                <div style="flex:1; min-width:0;">
                    <a href="profile.html?addr=${addr}" style="text-decoration:none; color:#333; font-weight:bold; font-size:13px; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        ${nick}
                    </a>
                    <div style="font-size:10px; color:#999;">${addr.substring(0,6)}...${addr.substring(38)}</div>
                </div>
                ${btnHtml}
            </div>`;
            
            container.innerHTML += html;
        }

        // --- HELPER FUNCTION ---
        async function fetchProfileLazy(address) {
            try {
                const p = await contract.getProfile(address);
                const avt = p.fotoProfil ? p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/30";
                const nick = p.nickname || address.substring(0,6)+"...";
                
                document.querySelectorAll(`.avt-${address}`).forEach(el => el.src = avt);
                document.querySelectorAll(`.nick-${address}`).forEach(el => el.innerText = nick);
            } catch(e) {}
        }

        // --- ACTION FOLLOW/UNFOLLOW ---
        async function follow(target) {
            try {
                showToast("Memproses...", "info");
                const tx = await contract.followUser(target);
                await tx.wait();
                showToast("Berhasil mengikuti!", "success");
                setTimeout(()=>location.reload(), 1000);
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }
        
        async function unfollow(target) {
            try {
                showToast("Memproses...", "info");
                const tx = await contract.unfollowUser(target);
                await tx.wait();
                showToast("Berhasil unfollow.", "success");
                setTimeout(()=>location.reload(), 1000);
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }

    </script>
</body>
</html>
