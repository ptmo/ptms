<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencarian | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .search-container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .section-header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; margin-top: 30px;
        }
        .section-title { font-size: 16px; font-weight: bold; color: #333; text-transform: uppercase; }
        .result-count { background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 11px; color: #666; }
        
        /* USER CARD */
        .user-card {
            display: flex; align-items: center; gap: 15px; background: #fff;
            padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .btn-follow {
            padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer;
            border: 1px solid #3498db; background: transparent; color: #3498db;
        }
        .btn-follow:hover { background: #3498db; color: white; }
        .btn-follow.active { background: #eee; border-color: #ccc; color: #888; }

        /* POST CARD */
        .post-card {
            background: #fff; border-radius: 12px; border: 1px solid #eee; 
            margin-bottom: 20px; overflow: hidden;
        }
        .post-match-info {
            background: #e8f5e9; color: #2e7d32; font-size: 11px; padding: 5px 15px;
            border-bottom: 1px solid #c8e6c9; display: flex; align-items: center; gap: 5px;
        }
        
        /* LOADING BAR */
        .loader-bar { height: 4px; width: 100%; background: #f0f0f0; margin-top: 20px; border-radius: 4px; overflow: hidden; position: relative; }
        .loader-fill { height: 100%; background: linear-gradient(90deg, #3498db, #8e44ad); width: 0%; transition: width 0.3s; }
        .loader-text { font-size: 11px; color: #777; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

    <div style="background: white; padding: 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100;">
        <div style="max-width: 1000px; margin: auto; display: flex; align-items: center; gap: 15px;">
            <a href="home.html" style="color: #555; font-size: 20px;"><i class="fa-solid fa-arrow-left"></i></a>
            <div style="flex: 1; position: relative;">
                <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                <form onsubmit="event.preventDefault(); window.location.href='result.html?q='+document.getElementById('qInput').value;">
                    <input type="search" id="qInput" class="cp-input" style="width: 100%; padding: 10px 10px 10px 40px; border-radius: 25px; border: 1px solid #ddd; background: #f9f9f9;" placeholder="Cari User atau Wayang...">
                </form>
            </div>
        </div>
    </div>

    <div class="search-container">
        
        <h2 style="margin-bottom: 5px;">Hasil Pencarian: <span id="queryText" style="color: #e74c3c;">...</span></h2>
        
        <div id="scanStatusArea">
            <div class="loader-bar"><div class="loader-fill" id="scanProgress"></div></div>
            <div class="loader-text" id="scanText">Menghubungkan ke Blockchain...</div>
        </div>

        <div id="userSection" style="display:none;">
            <div class="section-header">
                <div class="section-title"><i class="fa-solid fa-users"></i> Pengguna</div>
                <div class="result-count" id="userCount">0</div>
            </div>
            <div id="userResults"></div>
        </div>

        <div id="postSection" style="display:none;">
            <div class="section-header">
                <div class="section-title"><i class="fa-solid fa-layer-group"></i> Postingan & Koleksi</div>
                <div class="result-count" id="postCount">0</div>
            </div>
            <div id="postResults"></div>
        </div>

        <div id="noResults" style="display:none; text-align: center; padding: 50px; color: #999;">
            <i class="fa-regular fa-face-frown-open fa-3x"></i><br><br>
            Tidak ditemukan hasil apapun untuk pencarian ini.
        </div>

    </div>

    <div id="toast"></div>

    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        // AMBIL QUERY
        const params = new URLSearchParams(window.location.search);
        const query = params.get('q') ? params.get('q').toLowerCase().trim() : "";
        document.getElementById("queryText").innerText = query || "Semua";
        document.getElementById("qInput").value = query;

        // STATE
        let foundUsers = 0;
        let foundPosts = 0;
        let isScanComplete = false;
        
        // CACHE UTAMA
        const processedPosts = new Set(); 

        window.onload = async () => {
            await initApp();
            if(!query) {
                document.getElementById("scanText").innerText = "Silakan masukkan kata kunci.";
                return;
            }

            if(userAddress) {
                startBrutalSearch();
            }
        };

        async function startBrutalSearch() {
            // Jalankan paralel: Scan User & Scan Postingan
            Promise.all([
                scanUsersBrutal(),
                scanPostsDeep()
            ]).then(() => {
                document.getElementById("scanStatusArea").style.display = "none";
                if(foundUsers === 0 && foundPosts === 0) {
                    document.getElementById("noResults").style.display = "block";
                }
            });
        }

        // ==========================================
        // 1. TEKNIK CARI USER (BATCH PROCESSING)
        // ==========================================
        async function scanUsersBrutal() {
            const progress = document.getElementById("scanProgress");
            const status = document.getElementById("scanText");
            
            try {
                const countBN = await contract.userCounter();
                const totalUsers = countBN.toNumber();
                
                // Batch size: 10 user sekaligus supaya cepat
                const batchSize = 10;
                
                for (let i = 1; i <= totalUsers; i += batchSize) {
                    // Update UI
                    const pct = Math.min(((i / totalUsers) * 100), 50); // User scan max 50% bar
                    progress.style.width = pct + "%";
                    status.innerText = `Memindai User ID ${i} s/d ${Math.min(i + batchSize - 1, totalUsers)}...`;

                    // Buat array promise untuk batch ini
                    const promises = [];
                    for (let j = i; j < i + batchSize && j <= totalUsers; j++) {
                        promises.push(checkUser(j));
                    }
                    
                    // Tunggu batch ini selesai
                    await Promise.all(promises);
                }

            } catch (e) { console.error("User Scan Error", e); }
        }

        async function checkUser(id) {
            try {
                // Ambil data langsung dari mapping 'users' (pasti ada function ini di contract public)
                const u = await contract.users(id);
                
                // Validasi data kosong
                if(u.wallet === "0x0000000000000000000000000000000000000000") return;

                // LOGIKA PENCOCOKAN
                const nickMatch = u.nickname.toLowerCase().includes(query);
                const walletMatch = u.wallet.toLowerCase() === query;

                if (nickMatch || walletMatch) {
                    renderUser(u);
                }
            } catch (err) { }
        }

        async function renderUser(u) {
            foundUsers++;
            document.getElementById("userSection").style.display = "block";
            document.getElementById("userCount").innerText = foundUsers;

            const container = document.getElementById("userResults");
            const avt = u.fotoProfil ? u.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/50";
            
            // Cek status follow
            const isFollowing = await contract.isFollowing(userAddress, u.wallet);
            const btnClass = isFollowing ? "btn-follow active" : "btn-follow";
            const btnText = isFollowing ? "Mengikuti" : "Ikuti";
            const btnAction = isFollowing ? `unfollow('${u.wallet}')` : `follow('${u.wallet}')`;

            let btnHtml = `<button onclick="${btnAction}" class="${btnClass}">${btnText}</button>`;
            if(u.wallet.toLowerCase() === userAddress.toLowerCase()) btnHtml = `<span style="font-size:11px; color:#999;">Profil Anda</span>`;

            const html = `
            <div class="user-card">
                <a href="profile.html?addr=${u.wallet}">
                    <img src="${avt}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:1px solid #eee;">
                </a>
                <div style="flex:1;">
                    <a href="profile.html?addr=${u.wallet}" style="text-decoration:none; color:#333; font-weight:bold; font-size:14px; display:block;">
                        ${u.nickname || "Tanpa Nama"}
                    </a>
                    <div style="font-size:11px; color:#999;">${u.wallet.substring(0,8)}...${u.wallet.substring(38)}</div>
                </div>
                ${btnHtml}
            </div>`;
            
            container.innerHTML += html;
        }

        // ==========================================
        // 2. TEKNIK CARI POSTINGAN (DEEP IPFS)
        // ==========================================
        async function scanPostsDeep() {
            const progress = document.getElementById("scanProgress");
            const status = document.getElementById("scanText");

            try {
                const allPosts = await contract.getAllPosts();
                const totalPosts = allPosts.length;
                
                // --- TAHAP 1: CARI DI CAPTION (CEPAT) ---
                const captionMatches = allPosts.filter(p => p.caption.toLowerCase().includes(query));
                captionMatches.forEach(p => {
                    if(!processedPosts.has(p.id.toString())) {
                        renderPost(p, "Ditemukan di Deskripsi/Caption");
                        processedPosts.add(p.id.toString());
                    }
                });

                // --- TAHAP 2: DEEP SCAN IPFS (METADATA ARJUNA DLL) ---
                // Filter postingan yang punya NFT tapi belum ketemu di caption
                const candidates = allPosts.filter(p => !processedPosts.has(p.id.toString()) && p.nftId > 0 && p.tokenURI);
                
                // Proses batch 5 sekaligus (jangan kebanyakan nanti browser hang)
                const batchSize = 5;
                for (let i = 0; i < candidates.length; i += batchSize) {
                    
                    // Update UI Progress (50% s/d 100%)
                    const pct = 50 + ((i / candidates.length) * 50);
                    progress.style.width = pct + "%";
                    status.innerText = `Membaca Metadata NFT (${i}/${candidates.length})...`;

                    const promises = [];
                    for (let j = i; j < i + batchSize && j < candidates.length; j++) {
                        promises.push(checkMetadata(candidates[j]));
                    }
                    await Promise.all(promises);
                }

            } catch(e) { console.error("Post Scan Error", e); }
        }

        async function checkMetadata(post) {
            try {
                // Trik: Gunakan public gateway yang cepat, atau fallback ke pinata
                const url = post.tokenURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                
                // Fetch dengan timeout 5 detik
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const res = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if(res.ok) {
                    const meta = await res.json();
                    const metaString = JSON.stringify(meta).toLowerCase();
                    
                    // Cek apakah query ada di dalam JSON (Name, Description, Attributes)
                    if(metaString.includes(query)) {
                        renderPost(post, `Ditemukan di Metadata: ${meta.name || 'NFT'}`);
                    }
                }
            } catch (err) { }
        }

        async function renderPost(post, reason) {
            foundPosts++;
            document.getElementById("postSection").style.display = "block";
            document.getElementById("postCount").innerText = foundPosts;

            const container = document.getElementById("postResults");
            const profileLink = `profile.html?addr=${post.author}`;
            
            // Gambar
            let imgHtml = "";
            if(post.imageURI) {
                const raw = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                const opt = `https://wsrv.nl/?url=${encodeURIComponent(raw)}&w=600&q=80&output=webp`;
                imgHtml = `<a href="koleksi.html?id=${post.id}"><img src="${opt}" style="width:100%; height:200px; object-fit:cover; display:block;"></a>`;
            }

            const html = `
            <div class="post-card">
                <div class="post-match-info"><i class="fa-solid fa-check-circle"></i> ${reason}</div>
                <div style="padding:15px;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <img src="https://via.placeholder.com/30" class="avt-${post.author}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                        <div>
                            <div style="font-weight:bold; font-size:13px;"><a href="${profileLink}" class="nick-${post.author}" style="text-decoration:none; color:#333;">${post.author.substring(0,6)}...</a></div>
                            <div style="font-size:10px; color:#999;">${new Date(post.timestamp*1000).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div style="font-size:13px; margin-bottom:10px; color:#444;">${post.caption}</div>
                </div>
                ${imgHtml}
            </div>`;

            container.innerHTML += html;
            fetchProfileLazy(post.author);
        }

        // --- HELPER LAIN ---
        async function fetchProfileLazy(address) {
            try {
                const p = await contract.getProfile(address);
                const avt = p.fotoProfil ? p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/30";
                const nick = p.nickname || address.substring(0,6)+"...";
                document.querySelectorAll(`.avt-${address}`).forEach(el => el.src = avt);
                document.querySelectorAll(`.nick-${address}`).forEach(el => el.innerText = nick);
            } catch(e) {}
        }

        async function follow(target) {
            try {
                showToast("Memproses...", "info");
                const tx = await contract.followUser(target);
                await tx.wait();
                showToast("Berhasil!", "success");
            } catch(e) { showToast("Gagal", "error"); }
        }
        
        async function unfollow(target) {
            try {
                showToast("Memproses...", "info");
                const tx = await contract.unfollowUser(target);
                await tx.wait();
                showToast("Berhasil!", "success");
            } catch(e) { showToast("Gagal", "error"); }
        }

    </script>
</body>
</html>
