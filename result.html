<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencarian Deep Scan | Putramas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .search-grid { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 768px) { .search-grid { grid-template-columns: 1fr; } .col-users { order: -1; margin-bottom: 20px; } }
        .section-title { font-size: 14px; font-weight: bold; color: #7385a5; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .user-result-card { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px; }
        .btn-follow-small { padding: 5px 10px; font-size: 11px; border-radius: 20px; border: 1px solid #3498db; background: transparent; color: #3498db; cursor: pointer; }
        .btn-follow-small:hover { background: #3498db; color: white; }
        .btn-follow-small.following { background: #eee; border-color: #ccc; color: #666; }
        
        /* Indikator Deep Scan */
        .scanning-bar {
            height: 4px; width: 100%; background: #eee; margin-top: 10px; border-radius: 2px; overflow: hidden; display: none;
        }
        .scanning-progress {
            height: 100%; background: #e74c3c; width: 0%; transition: width 0.3s;
        }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="#" onclick="window.history.back()" class="menu-item" style="color: #7385a5;"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
            </div>
        </div>

        <div class="main-feed" style="max-width: 100%;"> 
            <div class="card" style="padding: 15px; margin-bottom: 20px;">
                <h2 style="margin:0; font-size:18px; color:#333;">
                    <i class="fa-solid fa-magnifying-glass"></i> Deep Search: <span id="queryDisplay" style="color:#e74c3c;">...</span>
                </h2>
                <div id="scanStatus" style="font-size:11px; color:#888; margin-top:5px; display:none;">
                    <i class="fa-solid fa-satellite-dish fa-beat"></i> Membongkar Metadata IPFS... (<span id="scanCount">0</span> diperiksa)
                </div>
                <div class="scanning-bar" id="scanBar"><div class="scanning-progress" id="scanProgress"></div></div>
            </div>

            <div class="search-grid">
                
                <div class="col-posts">
                    <div class="section-title"><i class="fa-regular fa-newspaper"></i> Hasil Postingan & NFT</div>
                    <div id="postsResultContainer"></div>
                </div>

                <div class="col-users">
                    <div class="section-title"><i class="fa-solid fa-users"></i> Pengguna Ditemukan</div>
                    <div id="usersResultContainer">
                        <div style="text-align:center; padding:20px; color:#999;"><i class="fa-solid fa-spinner fa-spin"></i> Memindai Blockchain...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="toast"></div>
    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') ? urlParams.get('q').toLowerCase().trim() : "";
        document.getElementById("queryDisplay").innerText = query || "Semua";

        // Variabel untuk mencegah duplikasi hasil Deep Scan
        const displayedPostIds = new Set(); 

        window.onload = async () => {
            await initApp();
            if(!query) return;
            if(userAddress) {
                // Jalankan Pencarian Paralel (Brutal Mode)
                searchUsersBrutal(); 
                searchPostsDeep();
            }
        };

        // ==========================================
        // 1. PENCARIAN USER (BRUTAL LOOP ID - FIXED)
        // ==========================================
        async function searchUsersBrutal() {
            const container = document.getElementById("usersResultContainer");
            container.innerHTML = "<div style='text-align:center; color:#999; font-size:12px;'><i class='fa-solid fa-spinner fa-spin'></i> Scanning Smart Contract...</div>";

            try {
                // Ambil Total User Langsung dari Blockchain
                // Pastikan nama variabel counter di smart contract Anda benar (userCounter atau _userIds dll)
                const userCountBN = await contract.userCounter();
                const totalUsers = userCountBN.toNumber();
                
                console.log("Total Users to Scan:", totalUsers); // Debugging

                let foundCount = 0;
                let htmlBuffer = "";

                // Loop Brutal: Cek SATU PER SATU dari ID 1 sampai akhir
                for (let i = 1; i <= totalUsers; i++) {
                    try {
                        // COBA CARA 1: Get Profile By ID (Jika ada fungsi ini)
                        let u;
                        try {
                            u = await contract.getProfileById(i);
                        } catch(e) {
                            // FALLBACK CARA 2: Akses mapping public 'users'
                            u = await contract.users(i);
                        }
                        
                        // Validasi: Wallet tidak boleh kosong
                        if(u.wallet === "0x0000000000000000000000000000000000000000") continue;

                        // DATA CLEANING
                        const nickname = u.nickname ? u.nickname.toLowerCase() : "";
                        const wallet = u.wallet ? u.wallet.toLowerCase() : "";

                        // CEK KECOCOKAN (Nama ATAU Wallet)
                        if (nickname.includes(query) || wallet === query) {
                            foundCount++;
                            htmlBuffer += await generateUserHTML(u);
                        }
                    } catch (err) { 
                        console.warn("Error scanning user ID " + i, err);
                    }
                }

                // Render Hasil
                if (foundCount > 0) {
                    container.innerHTML = htmlBuffer;
                } else {
                    container.innerHTML = `<div style='text-align:center; padding:20px; color:#999;'>User tidak ditemukan di Blockchain.</div>`;
                }

            } catch(e) {
                console.error("User Search Error:", e);
                container.innerHTML = "<p style='color:red; font-size:11px;'>Gagal akses data user. Pastikan Smart Contract mendukung iterasi user.</p>";
            }
        }

        async function generateUserHTML(u) {
            const displayNick = u.nickname || "Tanpa Nama";
            const displayAvt = u.fotoProfil ? u.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/40";
            const addr = u.wallet;
            
            // Cek Follow (Async di dalam loop gapapa demi akurasi)
            let isFollowing = false;
            try {
                isFollowing = await contract.isFollowing(userAddress, addr);
            } catch(e) {}

            const btnAction = isFollowing ? `unfollow('${addr}')` : `follow('${addr}')`;
            const btnText = isFollowing ? "Mengikuti" : "Ikuti";
            const btnClass = isFollowing ? "btn-follow-small following" : "btn-follow-small";
            
            let btnHtml = `<button onclick="${btnAction}" class="${btnClass}">${btnText}</button>`;
            if (addr.toLowerCase() === userAddress.toLowerCase()) btnHtml = `<span style='font-size:10px; color:#999;'>Anda</span>`;

            return `
            <div class="user-result-card">
                <a href="profile.html?addr=${addr}"><img src="${displayAvt}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #eee;"></a>
                <div style="flex:1; min-width:0;">
                    <a href="profile.html?addr=${addr}" style="text-decoration:none; color:#333; font-weight:bold; font-size:13px; display:block;">${displayNick}</a>
                    <div style="font-size:10px; color:#999;">${addr.substring(0,6)}...${addr.substring(38)}</div>
                </div>
                ${btnHtml}
            </div>`;
        }

        // ==========================================
        // 2. PENCARIAN POST (DEEP SCAN IPFS - SUDAH BERHASIL)
        // ==========================================
        async function searchPostsDeep() {
            const container = document.getElementById("postsResultContainer");
            const scanBar = document.getElementById("scanBar");
            const scanProgress = document.getElementById("scanProgress");
            const scanStatus = document.getElementById("scanStatus");
            const scanCountEl = document.getElementById("scanCount");

            try {
                // 1. Ambil SEMUA Postingan
                const allPosts = await contract.getAllPosts();
                
                // 2. TAHAP 1: Filter Cepat (Berdasarkan Caption)
                const captionMatches = allPosts.filter(p => p.caption.toLowerCase().includes(query));
                
                container.innerHTML = "";
                captionMatches.forEach(post => {
                    displayedPostIds.add(post.id.toString());
                    container.innerHTML += generatePostHTML(post, "Ditemukan di Caption");
                    fetchProfileLazy(post.author);
                });

                // 3. TAHAP 2: DEEP SCAN (Membongkar Metadata NFT)
                const deepScanTargets = allPosts.filter(p => !displayedPostIds.has(p.id.toString()) && p.nftId > 0 && p.tokenURI);
                
                if(deepScanTargets.length > 0) {
                    scanBar.style.display = "block";
                    scanStatus.style.display = "block";
                    
                    let scanned = 0;
                    const total = deepScanTargets.length;

                    // Fetch Serial (Satu per satu) untuk stabilitas
                    for (const post of deepScanTargets) {
                        scanned++;
                        const pct = (scanned / total) * 100;
                        scanProgress.style.width = pct + "%";
                        scanCountEl.innerText = `${scanned}/${total}`;

                        try {
                            // FETCH IPFS
                            const url = post.tokenURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                            
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 3000); 
                            
                            const res = await fetch(url, { signal: controller.signal });
                            clearTimeout(timeoutId);

                            if(res.ok) {
                                const meta = await res.json();
                                const metaString = JSON.stringify(meta).toLowerCase();
                                
                                if (metaString.includes(query)) {
                                    container.innerHTML += generatePostHTML(post, `Ditemukan di Metadata: ${meta.name || 'NFT'}`);
                                    fetchProfileLazy(post.author);
                                    setTimeout(() => renderMetadataSpecific(post.id, meta), 100);
                                }
                            }
                        } catch(err) { }
                    }
                }

                // Selesai Scanning
                setTimeout(() => {
                    scanStatus.innerHTML = "<i class='fa-solid fa-check'></i> Deep Scan Selesai.";
                    scanBar.style.display = "none";
                    if(container.innerHTML === "") {
                        container.innerHTML = `<div style='padding:30px; text-align:center; color:#999; border:1px dashed #ddd; border-radius:8px;'>Tidak ditemukan hasil untuk "${query}" (Scan Selesai).</div>`;
                    }
                }, 1000);

            } catch(e) {
                console.error("Deep Search Error:", e);
            }
        }

        // --- HTML GENERATOR ---
        function generatePostHTML(post, foundReason) {
            const profileLink = `profile.html?addr=${post.author}`;
            let imgHtml = "";
            let metaBox = ""; 

            if(post.imageURI && post.imageURI.length > 5) {
                const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                const optUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=600&q=80&output=webp`;
                
                if(post.nftId > 0) {
                     metaBox = `
                    <div class="nft-citation" style="background:#f0fff4; padding:8px; border:1px solid #c6f6d5; border-top:none; border-radius:0 0 10px 10px; font-size:11px; color:#2f855a; margin-top:-4px;">
                        <i class="fa-solid fa-bolt"></i> ${foundReason}
                        <div id="meta-details-${post.id}" style="margin-top:5px; color:#555;"></div>
                    </div>`;
                }

                imgHtml = `<a href="koleksi.html?id=${post.id}"><img src="${optUrl}" style="width:100%; height:200px; object-fit:cover; border-radius:${post.nftId>0?'0':'8px'}; margin-top:10px; background:#f0f0f0;"></a>${metaBox}`;
            }

            return `
            <div class="card" style="padding:15px; margin-bottom:15px; border-left: 3px solid #3498db;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <a href="${profileLink}"><img src="https://via.placeholder.com/30" class="avt-${post.author}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;"></a>
                    <div>
                        <div style="font-weight:bold; font-size:13px;"><a href="${profileLink}" class="nick-${post.author}" style="text-decoration:none; color:#333;">${post.author.substring(0,6)}...</a></div>
                        <div style="font-size:10px; color:#999;">${new Date(post.timestamp * 1000).toLocaleDateString()}</div>
                    </div>
                </div>
                <p style="font-size:13px; margin:10px 0;">${post.caption}</p>
                ${imgHtml}
            </div>`;
        }

        function renderMetadataSpecific(postId, meta) {
            const el = document.getElementById(`meta-details-${postId}`);
            if(!el) return;
            let gagrak = "-";
            if(meta.attributes) {
                const attr = meta.attributes.find(a => a.trait_type.includes("Gaya") || a.trait_type.includes("Gagrak"));
                if(attr) gagrak = attr.value;
            }
            el.innerHTML = `<strong>${meta.name}</strong> â€¢ Gagrak: ${gagrak}`;
        }

        // --- HELPER BIASA ---
        async function fetchProfileLazy(address) {
            try {
                const p = await contract.getProfile(address);
                const avt = p.fotoProfil ? p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : "https://via.placeholder.com/30";
                const nick = p.nickname || address.substring(0,6)+"...";
                document.querySelectorAll(`.avt-${address}`).forEach(el => el.src = avt);
                document.querySelectorAll(`.nick-${address}`).forEach(el => el.innerText = nick);
            } catch(e) {}
        }
        async function follow(target) {
            try { showToast("Memproses...", "info"); const tx = await contract.followUser(target); await tx.wait(); showToast("Berhasil!", "success"); } catch(e) { showToast("Gagal", "error"); }
        }
        async function unfollow(target) {
            try { showToast("Memproses...", "info"); const tx = await contract.unfollowUser(target); await tx.wait(); showToast("Berhasil!", "success"); } catch(e) { showToast("Gagal", "error"); }
        }
    </script>
</body>
</html>
