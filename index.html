<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Putramas Official | Digital Galeri Wayang Nusantara</title>
    <meta name="description" content="Kunjungi Koleksi Wayang Kulit Nusantara Di Galeri Digital Putramas Official">
    <meta name="keywords" content="
Wayang,
Wayang Kulit,
Wayang Kulit Indonesia,
Wayang Indonesia,
Wayang Nusantara,

Wayang Kulit Gagrak Cirebon,
Wayang Gagrak Cirebon,
Wayang Cirebon,
Wayang Kulit Cirebon,

Wayang Kulit Jawa,
Wayang Kulit Jawa Tengah,
Wayang Kulit Jawa Timur,
Wayang Kulit Jawa Barat,

Wayang Kulit Gagrak Yogyakarta,
Wayang Kulit Gagrak Surakarta,
Wayang Kulit Gagrak Solo,
Wayang Kulit Gagrak Banyumas,
Wayang Kulit Gagrak Kedu,
Wayang Kulit Gagrak Mataram,

Wayang Kulit Purwa,
Wayang Kulit Parwa,
Wayang Kulit Bali,
Wayang Bali,

Wayang Kulit Sasak,
Wayang Sasak Lombok,

Wayang Kulit Madura,
Wayang Madura,

Wayang Kulit Banjar,
Wayang Banjar Kalimantan,

Wayang Kulit Betawi,
Wayang Betawi,

Wayang Kulit Sunda,
Wayang Golek,
Wayang Golek Sunda,
        
Wayang Kulit Pesisiran,
Wayang Kulit Pantura,
        
Wayang Ramayana,
Wayang Mahabharata,
Tokoh Wayang,
Arsip Wayang,
Galeri Wayang,
Koleksi Wayang Kulit
">
    <meta name="robots" content="index, follow">

    <link rel="canonical" href="https://putramas.web.id">

    <!-- Open Graph -->
    <meta property="og:title" content="Putramas Official | Digital Galeri Wayang Nusantara>
    <meta property="og:description" content="Kunjungi Koleksi Wayang Kulit Nusantara Di Galeri Digital Putramas Official.">
    <meta property="og:url" content="https://putramas.web.id">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://putramas.web.id/img/og.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Putramas Official | Digital Galeri Wayang Nusantara">
    <meta name="twitter:description" content="Kunjungi Koleksi Wayang Kulit Nusantara Di Galeri Digital Putramas Official.">
    <meta name="twitter:image" content="https://putramas.web.id/img/og.png">

    <!-- Favicon -->
    <link rel="icon" href="/img/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/img/icon-512.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        * { box-sizing: border-box; }

        body { 
            font-family: 'Rubik', sans-serif; 
            background-color: #ffffff; 
            color: #f4f1ea; 
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: #f6f9ff;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .nav-left { display: flex; align-items: center; gap: 15px; }
        
        .nav-logo {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 2px solid #7385a5;
            object-fit: cover;
        }

        .nav-brand {
            font-size: 1.2em; font-weight: bold; color: #7385a5;
            letter-spacing: 1.5px;
        }

.hero-section {
    position: relative;
    width: 100%;
    min-height: 450px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.8)), 
                url('https://putramas.web.id/img/logo2.png');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    margin-bottom: 40px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    overflow: hidden;
    border-radius: 10px;
}
        
.hero-content {
    z-index: 2;
    max-width: 800px;
    padding: 20px;
}

.hero-title {
    font-size: 3.5em;
    font-weight: 800;
    color: #a0aaf8;
    letter-spacing: 5px;
    margin: 0 0 15px 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    opacity: 0;
    animation: fadeInUp 1s ease-out forwards;
}

.hero-subtitle {
    font-size: 0.8em;
    color: #666666;
    font-style: italic;
    margin-bottom: 30px;
    opacity: 0;
    animation: fadeInUp 1s ease-out 0.3s forwards;
}

.btn-upload-hero {
    background: #a6b4cd;
    color: #fff;
    border: 2px solid #7385a5;
    padding: 15px 40px;
    border-radius: 50px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    letter-spacing: 1px;
    box-shadow: 0 5px 15px rgba(115, 133, 165, 0.4);
    transition: all 0.3s ease;
    opacity: 0;
    animation: fadeInUp 1s ease-out 0.6s forwards;
}

.btn-upload-hero:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(115, 133, 165, 0.6);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(40px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 600px) {
    .hero-section { min-height: 350px; }
    .hero-title { font-size: 2.2em; letter-spacing: 2px; }
    .btn-upload-hero { padding: 12px 30px; font-size: 14px; }
}
        .galeri-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; }
        
        .wayang-card { 
            background: #4154f1; border: 1px solid #a6b4cd; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.3s; 
            text-decoration: none; display: flex; flex-direction: column; position: relative;
        }
        .wayang-card:hover { transform: translateY(-8px); border-color: #8094b7; }
        
        .wayang-img { 
            width: 100%; height: 450px; background: #e0e0e0; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden;
        }
        .wayang-img img { max-width: 97%; max-height: 97%; filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.5)); padding-bottom: 40px; transition: transform 0.3s; }
        .wayang-card:hover .wayang-img img { transform: scale(1.05); }

        .img-overlay-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 35px;
            background: #7385a5; border-top: 2px solid #a6b4cd;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; z-index: 10; box-sizing: border-box;
        }
        .overlay-date { color: #ccc; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .overlay-stats { display: flex; gap: 15px; }
        .stat-item { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold; color: #deb887; }

        .card-body { padding: 15px; background: #f6f9ff; }
        .card-meta { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .gaya-text { background: #7385a5; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase; }
        .date-text { color: #888; font-size: 11px; font-weight: bold; }
        h3 { margin: 0; font-size: 1.4em; color: #2c241b; font-family: 'Rubik', sans-serif; }
        .stats-row { border-top: 1px solid #eee; margin-top: 10px; padding-top: 8px; font-size: 11px; color: #666; font-style: italic; text-align: center; }
        .owner-badge { position: absolute; top: 10px; left: 10px; background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; z-index: 5; font-family: 'Rubik', sans-serif; }

        .main-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 80vh;
        }

        .footer {
            background: #f6f9ff;
            padding: 20px 20px;
            margin-top: 25px;
            text-align: center;
            width: 100%;
        }

        .social-icons { margin-bottom: 10px; }
        
        .social-link {
            display: inline-flex; justify-content: center; align-items: center;
            width: 35px; height: 35px; margin: 0 07px;
            border-radius: 50%; background: #7385a5; color: #fff;
            font-size: 15px; transition: all 0.3s ease; border: 1.5px solid #7385a5;
            text-decoration: none;
        }
        .social-link:hover {
            background: #fff; color: #7385a5;
            transform: translateY(-5px); box-shadow: 0 0 15px #7385a5;
        }

        .copyright { color: #888; font-size: 13px; letter-spacing: 1px; margin-top: 10px; }

        #btn-connect {
            background: transparent; color: #7385a5; border: 2px solid #7385a5; 
            padding: 10px 25px; cursor: pointer; font-family: 'Rubik', sans-serif; 
            font-weight: bold; border-radius: 30px; transition: 0.3s; font-size: 14px;
        }
        #btn-connect:hover { background: #f6f9ff; color: #7385a5; border: 2px solid #7385a5; }
        #btn-connect.connected { background: #abb6c9; color: #fff; border-color: #7385a5; cursor: default; }

        .search-wrapper {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 auto 30px auto;
}

#searchInput {
    width: 100%;
    padding: 15px 25px;
    border-radius: 50px;
    border: 2px solid #7385a5;
    background: #fff;
    outline: none;
    text-align: center;
    box-shadow: 0 2px 6px rgba(115, 133, 165, 0.25);
    transition:
        box-shadow 0.25s ease,
        border-color 0.25s ease,
        transform 0.25s ease;
}

#searchInput:hover,
#searchInput:focus {
    border-color: #7385a5;
    box-shadow: 0 6px 16px rgba(115, 133, 165, 0.45);
    transform: translateY(-2px);
}
        
        .tab-wrapper { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .tab-btn { background: transparent; border: 2px solid #7385a5; color: #7385a5; padding: 12px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: #abb6c9; color: #fff; border-color: #7385a5; }
        .galeri-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; }
        .filter-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .btn-filter { background: #f6f9ff; color: #7385a5; border: 2px solid #7385a5; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        .btn-filter.active { background: #a6b4cd; color: #fff; }

        @media (max-width: 600px) {
            .navbar { padding: 15px 20px; }
            .nav-brand { font-size: 0.9em; }
            #btn-connect { padding: 8px 15px; font-size: 12px; }
            h1 { font-size: 2em; }
        }

#toast {
    visibility: hidden;
    min-width: 220px;
    max-width: 85%;
    position: fixed;
    z-index: 99999;
    top: 90px;
    right: 20px;
    left: auto;
    background-color: rgba(51, 51, 51, 0.95);
    backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    padding: 10px 35px 10px 15px; 
    display: flex;
    align-items: center;
    font-family: 'Rubik', sans-serif;
    font-weight: 500;
    font-size: 11px;
    letter-spacing: 0.3px;
    opacity: 0;
    transform: translateX(20px) scale(0.9); 
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0.4s; 
}

#toast.show {
    visibility: visible;
    opacity: 1;
    transform: translateX(0) scale(1);
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0s;
}
    
#toast .toast-icon {
    width: 23px;
    height: 23px; 
    margin-right: 10px; 
    object-fit: contain;
}

#toast .toast-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 9px;
    height: 9px;
    cursor: pointer;
    opacity: 0.6;
    transition: 0.2s;
}

        #toast .toast-close:hover { opacity: 1; transform: scale(1.1); }

#toast.info {
    background: rgba(0, 53, 107, 0.35);
    border: 1px solid rgba(0, 100, 204, 0.4);
    color: #fff;
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0, 100, 255, 0.25);
}

#toast.success {
    background: rgba(0, 77, 7, 0.35);
    color: #fff;
    border: 1px solid rgba(0, 184, 15, 0.4);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0,255,0,0.2);
}

#toast.error {
    background: rgba(107, 0, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(184, 0, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 22px rgba(255,0,0,0.25);
    }

#toast.warning {
    background: rgba(102, 98, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(179, 171, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 20px rgba(255,255,0,0.25);
}

#toast.wolf {
    background: rgba(125, 65, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(204, 106, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(255,140,0,0.25);
}

#toast.load {
    background: rgba(49, 77, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(104, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(0,255,0,0.25);
}
    
#toast.loading {
    background: rgba(52, 90, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(94, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(94, 163, 0, 0.25);
}

@keyframes slideDown {
    from {top: -50px; opacity: 0;}
    to {top: 30px; opacity: 1;}
}

@keyframes fadeOut {
    from {top: 30px; opacity: 1;}
    to {top: -50px; opacity: 0;}
}
</style>
</head>
<body>

<nav class="navbar">
        <div class="nav-left">
            <img src="img/icon-192.png" class="nav-logo">
            <span class="nav-brand">Putramas Official</span>
        </div>
        <div class="nav-right">
            <button id="btn-connect" onclick="connectWallet()">
    <img src="img/chain.svg" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px; margin-bottom: 2px;">
    Hubungkan
            </button>
        </div>
    </nav>

    <div class="main-container">
        
        <section class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">Wayang Nusantara</h1>
        <p class="hero-subtitle">Arsip Digital Galeri Wayang Nusantara</p>
        
        <button class="btn-upload-hero" onclick="window.location.href='upload_public'">
    <img src="img/up.svg" 
         style="width: 24px; height: 24px; vertical-align: middle; margin-right: 10px; filter: brightness(0) invert(1);">
    Upload Koleksi/Karya Anda
        </button>
    </div>
        </section>

        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="üîç Pencarian..." onkeyup="smartSearch()">
        </div>

<div class="tab-wrapper" id="tabContainer">
    <button class="tab-btn active" id="tab-official" onclick="switchTab('official')">Koleksi Putramas</button>
    <button class="tab-btn" id="tab-public" onclick="switchTab('public')">Galeri Nusantara</button>
</div>

<div class="filter-container" id="categoryContainer">
    <button class="btn-filter" onclick="filterKategori('Satria', this)">Satria</button>
    <button class="btn-filter" onclick="filterKategori('Dewa', this)">Dewa</button>
    <button class="btn-filter" onclick="filterKategori('Yaksa', this)">Yaksa</button>
    <button class="btn-filter" onclick="filterKategori('Wanara', this)">Wanara</button>
    <button class="btn-filter" onclick="filterKategori('Panakawan', this)">Panakawan</button>
    <button class="btn-filter" onclick="filterKategori('Kayon', this)">Kayon</button>
    <button class="btn-filter" onclick="filterKategori('Bambangan', this)">Bambangan</button>
    <button class="btn-filter" onclick="filterKategori('Punggawa', this)">Punggawa</button>
    <button class="btn-filter" onclick="filterKategori('Krodan', this)">Krodan</button>
    <button class="btn-filter" onclick="filterKategori('Resi', this)">Resi</button>
    <button class="btn-filter" onclick="filterKategori('Putren', this)">Putren</button>
    <button class="btn-filter" onclick="filterKategori('Buta Kiwe', this)">Buta Kiwe</button>
    <button class="btn-filter" onclick="filterKategori('Sato', this)">Sato</button>
    <button class="btn-filter" onclick="filterKategori('Gaman', this)">Gaman</button>
</div>

<div id="containerGaleri" class="galeri-grid">
    <p style="text-align: center; width: 100%; grid-column: 1/-1; color: #aaa;">Menunggu data...</p>
</div>

<div id="toast"></div>

</div> <footer class="footer">
        <div class="footer-content">
            <div class="social-icons">
                <a href="https://youtube.com/@PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-youtube"></i></a>
                <a href="https://instagram.com/putramas_official" target="_blank" class="social-link"><i class="fab fa-instagram"></i></a>
                <a href="https://facebook.com/PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-facebook-f"></i></a>
                <a href="https://facebook.com/PutramasOfficialStudio" target="_blank" class="social-link"><i class="fab fa-facebook-f"></i></a>
            </div>
            <p class="copyright">
                &copy; <span id="year"></span> Powered By <strong>Putramas Official</strong>
            </p>
        </div>
</footer>

<script>
    // --- 1. KONFIGURASI UTAMA ---
    const CONTRACT_ADDRESS = "0x5dfe8311e98b0443C471A10e26198b72355Ca713"; 
    
    // GANTI DENGAN WALLET OFFICIAL ANDA
    const OFFICIAL_WALLET = "0x736fc1d7b9ad6b2e194717674cd57816d805d294"; 

    const BASE_SEPOLIA_ID = '0x14a34';
    const BASE_SEPOLIA_RPC = 'https://sepolia.base.org';
    const BASE_SEPOLIA_CONFIG = {
        chainId: BASE_SEPOLIA_ID, chainName: 'Base Sepolia Testnet',
        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
        rpcUrls: [BASE_SEPOLIA_RPC], blockExplorerUrls: ['https://sepolia.basescan.org']
    };

    const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct WayangArsipPro.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPro.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
    const BATCH_SIZE = 10;
    let provider, signer;
    let contractReader;
    let currentTab = 'official';
    let searchIndex = [];
    let isSearchReady = false;
    let searchRequestId = 0;
    let globalIds = [];          // Menyimpan seluruh daftar ID
    let currentOffset = 0;       // Posisi data saat ini
    let isFetchingBatch = false; // Mencegah double loading
    let toastTimeout;

    // --- 2. INIT ---
    window.onload = async function() {
        // Init Provider Read-Only
        const readProvider = new ethers.providers.JsonRpcProvider(BASE_SEPOLIA_RPC);
        contractReader = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);
        // UI Init
        const btns = document.querySelectorAll('.btn-filter');
        if(btns.length > 0) btns[0].classList.add('active');
        loadGaleri(); 
        buildSearchIndex(); 
    };

    // --- 3. BACKGROUND INDEXING (VERSI OPTIMIZED) ---
async function buildSearchIndex() {
    console.log("Building Search Index...");
    searchIndex = []; // Reset Array

    // Pastikan list ini SAMA PERSIS dengan <select> di HTML Menu Revisi/Upload
    const golongans = ['Satria', 'Dewa', 'Yaksa', 'Wanara', 'Panakawan', 'Kayon', 'Bambangan', 'Punggawa', 'Krodan', 'Resi', 'Putren', 'Buta Kiwe', 'Sato', 'Gaman'];

    try {
        const promises = golongans.map(async (gol) => {
            // Ambil ID per golongan
            const ids = await contractReader.getIdsByGolongan(gol);
            
            // Fetch Detail secara paralel tapi aman
            const detailPromises = ids.map(async (id) => {
                try {
                    const info = await contractReader.getInfoWayang(id);
                    
                    // Skip jika wayang sudah dihapus/tidak aktif
                    if (!info.isActive) return null;

                    return { 
                        id: id.toString(), // Penting: Ubah ke String untuk pencarian ID
                        nama: info.nama.toLowerCase(), 
                        gaya: info.gaya.toLowerCase(), 
                        golongan: info.golongan // Tidak perlu lowercase agar tampil cantik di UI
                    };
                } catch(e) { return null; }
            });

            return Promise.all(detailPromises);
        });

        const results = await Promise.all(promises);
        
        // Ratakan array & Hapus data null/error
        const flatResults = results.flat().filter(i => i !== null);

        // FILTER FINAL: Hapus Duplikat berdasarkan ID
        searchIndex = [...new Map(flatResults.map(item => [item.id, item])).values()];

        isSearchReady = true;
        console.log(`‚úÖ Index Ready: ${searchIndex.length} items.`);
        
        // Update Placeholder Search Bar
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
            searchInput.placeholder = `üîç Cari dari ${searchIndex.length} wayang...`;
        }

    } catch(e) { 
        console.error("Index failed:", e); 
    }
}

    // --- 4. SMART SEARCH LOGIC (UPDATED) ---
    async function smartSearch() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        const container = document.getElementById("containerGaleri");

        // 1. Anti Tabrakan Data (PENTING)
        searchRequestId++; 
        const currentRequestId = searchRequestId;

        // 2. Jika Search Kosong -> Kembali ke Mode Galeri (Infinite Scroll)
        if (query.length === 0) {
            document.getElementById("tabContainer").style.display = "flex";
            document.getElementById("categoryContainer").style.display = "flex";
            loadGaleri(); // Panggil fungsi utama lagi
            return;
        }

        // 3. Mode Search Aktif -> Sembunyikan Filter lain
        document.getElementById("tabContainer").style.display = "none";
        document.getElementById("categoryContainer").style.display = "none";

        // Cek apakah index pencarian sudah siap?
        if (!isSearchReady) {
            // PERBAIKAN: Ganti icon & Hapus variable ${titleTab} yang bikin error
            container.innerHTML = `<p style="text-align:center; color:#80db80; grid-column: 1/-1;">
                <img src="https://i.gifer.com/ZZ5H.gif" style="width: 25px; height: 25px; vertical-align: middle; margin-right: 10px;"> 
                Menyiapkan data pencarian...
            </p>`;
            return;
        }

        // 4. FILTER PENCARIAN (Lebih Teliti)
        const results = searchIndex.filter(w => 
            w.nama.toLowerCase().includes(query) || 
            w.gaya.toLowerCase().includes(query) || 
            String(w.id) === query // Pastikan ID dianggap string agar bisa dicari
        );

        if (results.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:#888; grid-column: 1/-1;">Tidak ditemukan hasil untuk "<b>${query}</b>"</p>`;
            return;
        }

        // 5. Render Hasil
        container.innerHTML = ""; // WAJIB CLEAR karena renderCards sekarang sifatnya "nambah ke bawah"
        window.scrollTo({ top: 0, behavior: 'smooth' }); // UX: Scroll ke atas

        // Ambil 20 hasil teratas saja (agar tidak berat)
        const limitedIds = results.slice(0, 20).map(r => r.id);
        
        // Panggil Render dengan Flag Mode Search = TRUE
        await renderCards(limitedIds, container, true, currentRequestId);
    }

    // --- 5. LOGIKA TAB & KATEGORI ---
    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-official').className = tab === 'official' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-public').className = tab === 'public' ? 'tab-btn active' : 'tab-btn';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        loadGaleri();
    }

    function filterKategori(kategori, btnElement) {
        currentCategory = kategori;
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        loadGaleri();
    }

    async function loadGaleri() {
    // 1. [TETAP] Reset Search Input
    document.getElementById("searchInput").value = "";

    // 2. [TETAP] ID Request & UI Loading
    searchRequestId++; 
    const currentRequestId = searchRequestId;
    const container = document.getElementById("containerGaleri");
    const titleTab = currentTab === 'official' ? "Koleksi Putramas" : "Galeri Nusantara";
    
    // Gunakan loading yang Anda suka
    container.innerHTML = `<p style="text-align:center; color:#80db80; grid-column: 1/-1;">
        <img src="img/load.svg" style="width: 25px; height: 25px; vertical-align: middle; margin-right: 10px;"> 
        Memuat ${titleTab} (${currentCategory})...
    </p>`;

    try {
        // 3. [TETAP] Ambil Data Blockchain
        const ids = await contractReader.getIdsByGolongan(currentCategory);
        
        // --- PENGAMAN TAMBAHAN: Cek apakah user sudah pindah tab saat loading? ---
        if (searchRequestId !== currentRequestId) return;

        // 4. [UPDATE] Setup Infinite Scroll
        // Kita balik urutannya biar yang terbaru muncul di atas
        globalIds = ids.slice().reverse(); 
        currentOffset = 0;
        isFetchingBatch = false;

        // 5. [TETAP] Cek Kosong
        if (globalIds.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:#aaa; grid-column: 1/-1;">Belum ada koleksi di kategori ini.</p>`;
            return;
        }

        // 6. [UPDATE] Bersihkan & Mulai Batch Pertama
        container.innerHTML = ""; 
        await loadNextBatch(); // <-- Panggil fungsi batch, bukan renderCards langsung

    } catch (err) {
        console.error(err);
        // Cek ID request lagi agar error tab lama tidak muncul di tab baru
        if (searchRequestId === currentRequestId) {
            container.innerHTML = `<p style="color:red; text-align:center; grid-column: 1/-1;">Gagal koneksi RPC.</p>`;
        }
    }
}

    async function loadNextBatch() {
    // Cek: Sedang loading? Data habis? Ada search text?
    if (isFetchingBatch || currentOffset >= globalIds.length || document.getElementById("searchInput").value !== "") return;

    isFetchingBatch = true;
    const container = document.getElementById("containerGaleri");
    
    // Indikator Loading Kecil di Bawah
    const loaderId = "loader-bottom";
    if (!document.getElementById(loaderId)) {
        container.insertAdjacentHTML('beforeend', `
            <p id="${loaderId}" style="text-align:center; grid-column: 1/-1; color:#888; font-style:italic; margin-top:20px;">
                <img src="img/loading.svg" style="width: 25px; height: 25px; vertical-align: middle; margin-right: 10px;"> Memuat data berikutnya...
            </p>
        `);
    }

    // Ambil potongan ID (Slice)
    const batchIds = globalIds.slice(currentOffset, currentOffset + BATCH_SIZE);
    
    // Panggil renderCards dengan ID request yang aktif
    await renderCards(batchIds, container, false, searchRequestId);

    // Hapus Loader
    const loaderEl = document.getElementById(loaderId);
    if (loaderEl) loaderEl.remove();

    // Update Offset & Status
    currentOffset += BATCH_SIZE;
    isFetchingBatch = false;

    // Jika layar masih kosong (misal batch 1 kena filter hidden semua), load lagi otomatis
    if (container.children.length === 0 && currentOffset < globalIds.length) {
        loadNextBatch();
    }
}
    
        // --- 6. CORE RENDERER (VERSI INFINITE SCROLL) ---
    async function renderCards(ids, container, isSearchMode, requestId) {
        
        // 1. Fetch Data Paralel (TETAP SAMA)
        const promises = ids.map(async (id) => {
            try {
                const [info, owner, likes, ratingRaw, uri] = await Promise.all([
                    contractReader.getInfoWayang(id),
                    contractReader.ownerOf(id),
                    contractReader.totalLikes(id),
                    contractReader.getAverageRating(id),
                    contractReader.tokenURI(id)
                ]);

                if (!info.isActive) return null;

                // Filter Tab (Hanya jika BUKAN mode search)
                if (!isSearchMode) {
                    const isOwnerOfficial = (owner.toLowerCase() === OFFICIAL_WALLET.toLowerCase());
                    if (currentTab === 'official' && !isOwnerOfficial) return null;
                    if (currentTab === 'public' && isOwnerOfficial) return null;
                }

                const rating = ratingRaw > 0 ? (ratingRaw / 10).toFixed(1) : "N/A";
                const date = new Date(info.timestamp * 1000).toLocaleDateString("id-ID", { day: 'numeric', month: 'short', year: 'numeric' });
                const httpUri = uri ? uri.replace("ipfs://", "https://gateway.pinata.cloud/ipfs/") : "https://via.placeholder.com/300";
                
                return { id, nama: info.nama, gaya: info.gaya, likes, rating, date, metaUrl: httpUri, owner };
            } catch (e) { return null; }
        });

        const results = await Promise.all(promises);

        // 2. Cek Pembatalan (Anti Tabrakan Data)
        if (searchRequestId !== requestId) return;

        const cleanResults = results.filter(item => item !== null);

        // --- [UPDATE 1] LOGIKA KOSONG YANG LEBIH AMAN ---
        if (cleanResults.length === 0) {
            // Jika Mode Search: Langsung kasih tau tidak ketemu
            if (isSearchMode) {
                container.innerHTML = `<p style="text-align:center; color:#888; grid-column: 1/-1;">Tidak ada item ditemukan.</p>`;
            } 
            // Jika Mode Scroll: Jangan lakukan apa-apa (biarkan data sebelumnya tetap tampil)
            return;
        }

        // 3. Render Loop
        for (const w of cleanResults) {            
            // Logika Badge (TETAP SAMA)
            let ownerBadge = "";
            const isOwnerOfficial = (w.owner.toLowerCase() === OFFICIAL_WALLET.toLowerCase());         
            if (isOwnerOfficial) {
                ownerBadge = `<div class="owner-badge" style="background:#f1c40f; color:black; border:1px solid #d35400;"> 
                üëë Official</div>`;
            } else {
                ownerBadge = `<div class="owner-badge" style="background:#3498db; color:white;">Oleh: ${w.owner.substring(0,6)}...</div>`;
            }

            const html = generateCardHTML(w, ownerBadge);
            
            // --- [UPDATE 2] CARA APPEND (MENEMPEL) YANG BENAR ---
            // 'beforeend' menempelkan HTML baru di paling bawah TANPA mengganggu elemen di atasnya
            container.insertAdjacentHTML('beforeend', html);            
            
            // Lazy Load Gambar
            if (typeof fetchOptimizedImage === "function") {
                fetchOptimizedImage(w.metaUrl, w.id);
            }
        }       
    }

    // Template HTML Terpisah (Clean Code & Updated Icons)
function generateCardHTML(w, badge) {
    return `
        <a href="detail?id=${w.id}" class="wayang-card">
            <div class="wayang-img">
                ${badge}
                <img id="img-${w.id}" src="https://via.placeholder.com/300x350/333/777?text=Loading..." alt="${w.nama}" loading="lazy">
                
                <div class="img-overlay-bar">
                    <div class="overlay-date">${w.date}</div>
                    <div class="overlay-stats">
                        
                        <div class="stat-item">
                           ‚ù§Ô∏è ${w.likes}
                        </div>

                        <div class="stat-item">
                           ‚≠ê ${w.rating}
                        </div>

                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <div class="card-meta">
                    <span class="gaya-text">${w.gaya}</span>
                    <span class="date-text">#${w.id}</span>
                </div>
                <h3>${w.nama}</h3>
                <div class="stats-row">Klik untuk detail & ulasan</div>
            </div>
        </a>`;
}

    // --- GAMBAR (DENGAN FALLBACK SYSTEM) ---
    async function fetchOptimizedImage(metaUrl, id) {
        try {
            // 1. Ambil Metadata JSON dulu
            const res = await axios.get(metaUrl);      
            // Bersihkan URL gambar dari IPFS prefix
            const rawImgUrl = res.data.image.replace("ipfs://", "https://gateway.pinata.cloud/ipfs/");
            // 2. Optimasi Gambar
            // Ubah w=800 jadi w=400 (Cukup tajam untuk kartu, tapi jauh lebih ringan)
            const optimizedUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawImgUrl)}&w=400&q=80&output=webp`;
            const imgEl = document.getElementById(`img-${id}`);
            if (!imgEl) return;
            // 3. Teknik Preloading dengan Fallback
            const tempImg = new Image();
            // [PENTING] Jika Optimasi Gagal (wsrv.nl down/timeout), pakai gambar asli
            tempImg.onerror = () => {
                console.warn(`Optimasi gagal ID ${id}, menggunakan raw link.`);
                imgEl.src = rawImgUrl; // Fallback ke link Pinata langsung
                imgEl.style.opacity = 1; 
            };

            // Jika Berhasil Load
            tempImg.onload = () => {
                imgEl.src = optimizedUrl; 
                // Efek Fade-In yang lebih smooth (lewat CSS transition)
                imgEl.style.transition = "opacity 0.5s ease-in-out";
                imgEl.style.opacity = 1; 
            };

            // Mulai muat gambar
            tempImg.src = optimizedUrl;

        } catch(e) { 
            console.log("Gagal load metadata/gambar id " + id); 
        }
    }

    // --- WALLET ---
    async function connectWallet() {
        if (!window.ethereum) return showToast("Install dahulu, Metamask tidak ditemukan!", 'wolf');
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);

            const network = await provider.getNetwork();
            if (network.chainId !== 84532) await switchNetwork();
            signer = provider.getSigner();
            const address = await signer.getAddress();
            document.getElementById("btn-connect").innerText = address.substring(0, 6) + "...";
            document.getElementById("btn-connect").classList.add("connected");
        } catch (err) { console.error(err); }
    }

    async function switchNetwork() {
        try {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_ID }] });
        } catch (e) {
            if (e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [BASE_SEPOLIA_CONFIG] });
        }
    }

    function showToast(msg, type = 'info') {
    const x = document.getElementById("toast");

    const icons = {
        info: 'img/info-icon.svg',
        load: 'img/load.svg',
        loading: 'img/loading.svg',
        success: 'img/success.svg',
        error: 'img/error.svg',
        warning: 'img/warning.svg',
        wolf: 'img/wolf.svg'
    };

    const closeIcon = 'img/x.svg'; 

    if (!icons[type]) type = 'info';

    x.innerHTML = `
        <img src="${icons[type]}" class="toast-icon" alt="${type}"> 
        <span style="flex:1;">${msg}</span>
        <img src="${closeIcon}" class="toast-close" onclick="this.parentElement.className = this.parentElement.className.replace('show', '')" alt="close">
    `;

    x.className = ''; 
    void x.offsetWidth; 
    x.className = `show ${type}`;

    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { 
        x.className = x.className.replace("show", ""); 
    }, 10000); 
    }

    document.getElementById("year").innerText = new Date().getFullYear();
    
    window.addEventListener('scroll', () => {
    // Jika scroll sudah mendekati bawah (sisa 200px), muat lagi
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
        loadNextBatch();
    }
});
</script>
</body>
</html>
