<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Putramas Social | Masuk</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <script>
        if(localStorage.getItem("putramas_session")) {
            window.location.replace("home.html");
        }
    </script>
</head>
<body>

    <div class="landing-container">
        <img src="https://via.placeholder.com/150/7385a5/ffffff?text=P" class="logo-big" style="width:100px; height:100px; border-radius:20px; margin-bottom:20px;" alt="Logo">
        
        <h1 style="color: #7385a5; margin-bottom: 10px;">Putramas Social</h1>
        <p style="color: #666; margin-bottom: 40px; max-width: 400px; line-height: 1.6;">
            Platform sosial media terdesentralisasi di jaringan Base Sepolia. 
            <br>Tanpa server, tanpa sensor, milik komunitas.
        </p>

        <button id="btnLogin" onclick="handleLogin()" class="btn-primary" style="padding: 15px 40px; font-size: 16px; border-radius: 30px; width: 100%; max-width: 300px;">
            <i class="fa-solid fa-wallet"></i> Hubungkan Dompet
        </button>

        <p style="margin-top: 20px; font-size: 12px; color: #aaa;">
            Pastikan Anda menggunakan Metamask / Browser Web3
        </p>
    </div>

    <div id="toast"></div>
    <script src="main.js"></script>
    
    <script>
        async function handleLogin() {
            const btn = document.getElementById("btnLogin");
            
            // 1. Cek Metamask
            if (!window.ethereum) {
                alert("Metamask tidak terdeteksi! Silakan install terlebih dahulu.");
                return;
            }

            try {
                // UI Loading
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Menghubungkan...';
                btn.disabled = true;
                btn.style.opacity = "0.8";

                // 2. Request Akun
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                
                // 3. Cek Network (Wajib Base Sepolia)
                const { chainId } = await provider.getNetwork();
                // Pastikan CHAIN_ID ada di main.js (84532), kalau belum ada sesuaikan manual
                const targetChainId = (typeof CHAIN_ID !== 'undefined') ? CHAIN_ID : 84532;
                
                if (chainId !== targetChainId) {
                    try {
                        // Coba Switch Otomatis (Fungsi switchNetwork ada di main.js)
                        if(typeof switchNetwork === 'function') {
                            btn.innerHTML = 'Ganti Network...';
                            await switchNetwork();
                        } else {
                            throw new Error("Wrong Network");
                        }
                    } catch(e) {
                        alert("Harap ganti jaringan ke Base Sepolia!");
                        throw e;
                    }
                }

                // 4. Cek Status Registrasi di Smart Contract
                const signer = provider.getSigner();
                const address = await signer.getAddress();
                
                btn.innerHTML = 'Memeriksa Akun...';
                
                // Init Contract (Pastikan ABI & Address ada di main.js)
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Panggil data user (struct index ke-6 biasanya isRegistered)
                const user = await contract.users(address);

                // 5. Routing (Home vs Register)
                if (user.isRegistered) {
                    // Login Sukses
                    localStorage.setItem("putramas_session", address);
                    window.location.href = "home.html";
                } else {
                    // Belum daftar, lempar ke register
                    // Hapus session lama jika ada biar bersih
                    localStorage.removeItem("putramas_session"); 
                    window.location.href = "register.html";
                }

            } catch (err) {
                console.error(err);
                // Reset Tombol jika gagal
                btn.innerHTML = '<i class="fa-solid fa-wallet"></i> Hubungkan Dompet';
                btn.disabled = false;
                btn.style.opacity = "1";
                
                // Tampilkan Error (Pakai showToast dari main.js jika ada, atau alert)
                if(typeof showToast === 'function') showToast("Gagal login: " + err.message, "error");
                else alert("Gagal login: " + err.message);
            }
        }
    </script>
</body>
</html>
