<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; gap: 10px; }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .comment-content { flex: 1; font-size: 13px; }
        .comment-author { font-weight: bold; font-size: 12px; color: #7385a5; }
        .comment-time { font-size: 10px; color: #999; }
        
        /* Fix Dialog di HP */
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item"><i class="fa-solid fa-bell"></i> Notifikasi</a>
                <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="disconnect()" class="menu-item" style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</a>
            </div>
            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin: 0 0 10px; font-size: 14px; color: #7385a5;">Status Wallet</h4>
                <div style="font-size: 12px; word-break: break-all; color: #666;" id="walletDisplay">Loading...</div>
            </div>
        </div>

        <div class="main-feed">
            <div class="card create-post-box">
                <div class="cp-header">
                    <img src="https://via.placeholder.com/40" class="user-avatar" id="myAvatar">
                    <textarea id="postCaption" class="cp-input" placeholder="Apa yang sedang terjadi?"></textarea>
                </div>
                <div id="previewContainer" style="display:none; margin-bottom:10px; position:relative;">
                    <img id="imgPreview" style="width:100%; border-radius:10px; max-height: 300px; object-fit: cover;">
                    <button onclick="clearImage()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer;">&times;</button>
                </div>
                <div class="cp-actions">
                    <label for="fileInput" class="btn-upload">
                        <i class="fa-solid fa-image" style="color: #2ecc71;"></i> Foto
                    </label>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImage(this)">
                    <button id="btnPost" class="btn-primary" onclick="submitPost()">Posting</button>
                </div>
            </div>

            <div id="feedContainer">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat Blockchain...
                </div>
            </div>
        </div>
    </div>

    <dialog id="ratingModal" style="border:none; border-radius:15px; padding:20px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
        <h3 style="margin-top:0; text-align:center; color:#7385a5;">Beri Rating</h3>
        <div style="display:flex; gap:10px; font-size:30px; justify-content:center; cursor:pointer; margin:20px 0;">
            <span onclick="setRate(1)">⭐</span>
            <span onclick="setRate(2)">⭐</span>
            <span onclick="setRate(3)">⭐</span>
            <span onclick="setRate(4)">⭐</span>
            <span onclick="setRate(5)">⭐</span>
        </div>
        <input type="hidden" id="targetPostId">
        <button onclick="submitRating()" class="btn-primary" style="width:100%">Kirim</button>
        <button onclick="document.getElementById('ratingModal').close()" style="width:100%; background:none; border:none; color:#666; margin-top:10px; cursor:pointer;">Batal</button>
    </dialog>

    <dialog id="commentModal" style="border:none; border-radius:15px; padding:0; box-shadow:0 0 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; height: 70vh; display: flex; flex-direction: column;">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; color:#7385a5;">Komentar</h3>
            <span onclick="document.getElementById('commentModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        
        <div id="commentList" style="flex: 1; overflow-y: auto; padding: 15px;">
            <p style="text-align:center; color:#999;">Memuat komentar...</p>
        </div>

        <div style="padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; display: flex; gap: 10px;">
            <input type="text" id="commentInput" class="cp-input" style="height: 40px;" placeholder="Tulis komentar...">
            <input type="hidden" id="commentPostId">
            <button onclick="submitComment()" class="btn-primary" style="padding: 0 20px;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </dialog>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i></a>
        <a href="notifications.html" class="menu-item"><i class="fa-solid fa-bell"></i></a>
        <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i></a>
    </div>

    <div id="toast"></div>

    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        const profileCache = {}; 
        
        const EXTENDED_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"string","name":"action","type":"string"}],"name":"NewInteraction","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"postId","type":"uint256"},{"indexed":true,"internalType":"address","name":"author","type":"address"}],"name":"NewPost","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newName","type":"string"},{"indexed":false,"internalType":"bool","name":"isPaid","type":"bool"}],"name":"NicknameChanged","type":"event"},{"inputs":[],"name":"MAX_FREE_CHANGES","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"string","name":"_text","type":"string"},{"internalType":"string","name":"_imageURI","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_newNickname","type":"string"}],"name":"changeNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_imageURI","type":"string"},{"internalType":"string","name":"_caption","type":"string"}],"name":"createPost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"dislikePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficial.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"}],"name":"getComments","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasOfficial.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyNotifications","outputs":[{"components":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"internalType":"struct PutramasOfficial.Notification[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getProfile","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficial.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getProfileById","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficial.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficial.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasDisliked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"idToWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"likePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"nicknamePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"postComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"posts","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"}],"name":"ratePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"registerProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newPrice","type":"uint256"}],"name":"setNicknamePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateBioAndPhoto","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userNotifications","outputs":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRating","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"stateMutability":"view","type":"function"}];

        window.onload = async () => {
            await initApp(); 
            if(userAddress) {
                contract = new ethers.Contract(CONTRACT_ADDRESS, EXTENDED_ABI, signer);
                document.getElementById("walletDisplay").innerText = userAddress;
                loadMyProfile();
                loadFeed();
            }
        };

        function resolveIPFS(url) {
            if (!url) return null;
            return url.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
        }

        async function loadMyProfile() {
            try {
                const p = await contract.getProfile(userAddress);
                if(p.fotoProfil) document.getElementById("myAvatar").src = resolveIPFS(p.fotoProfil);
            } catch(e) {}
        }

        // --- FUNGSI UTAMA LOAD FEED ---
        async function loadFeed() {
            try {
                const posts = await contract.getAllPosts();
                const container = document.getElementById("feedContainer");
                container.innerHTML = "";

                if(posts.length === 0) {
                    container.innerHTML = "<p style='text-align:center; color:#999;'>Belum ada postingan.</p>";
                    return;
                }

                // Render Kartu Saja (TANPA KOMENTAR)
                [...posts].reverse().forEach(post => {
                    const uniqueId = `post-${post.id}`;
                    
                    let imgHtml = "";
                    if(post.imageURI && post.imageURI.length > 5) {
                        imgHtml = `<img src="${resolveIPFS(post.imageURI)}" class="post-image" loading="lazy" onerror="this.style.display='none'">`;
                    }

                    const avgRating = post.ratingCount > 0 ? (post.totalRatingScore / post.ratingCount).toFixed(1) : "0.0";

                    // HTML ini BERSIH dari komentar
                    const html = `
                    <div class="card" id="${uniqueId}">
                        <div class="post-header">
                            <img src="https://via.placeholder.com/40" class="user-avatar author-avatar-${post.author}">
                            <div class="post-info">
                                <h4 class="author-nick-${post.author}">${post.author.substring(0,6)}...</h4>
                                <span>${new Date(post.timestamp * 1000).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="post-caption">${post.caption}</div>
                        ${imgHtml}

                        <div class="post-actions">
                            <button class="action-btn" onclick="handleLike(${post.id})">
                                <i class="fa-regular fa-heart" id="icon-like-${post.id}"></i> 
                                <span id="count-like-${post.id}">${post.likeCount}</span>
                            </button>
                            <button class="action-btn" onclick="openComments(${post.id})">
                                <i class="fa-regular fa-comment"></i> ${post.commentCount}
                            </button>
                            <button class="action-btn" onclick="openRating(${post.id})" style="color: #f1c40f;">
                                <i class="fa-solid fa-star"></i> ${avgRating}
                            </button>
                        </div>
                    </div>`;
                    container.innerHTML += html;

                    fetchProfileLazy(post.author);
                });

            } catch (e) {
                console.error(e);
                showToast("Gagal memuat feed.", "error");
            }
        }

        async function fetchProfileLazy(address) {
            if(profileCache[address]) {
                updatePostAuthorUI(address, profileCache[address]);
                return;
            }
            try {
                const p = await contract.getProfile(address);
                const profileData = {
                    nickname: p.nickname,
                    avatar: p.fotoProfil ? resolveIPFS(p.fotoProfil) : 'https://via.placeholder.com/40'
                };
                profileCache[address] = profileData;
                updatePostAuthorUI(address, profileData);
            } catch (e) {}
        }

        function updatePostAuthorUI(address, data) {
            document.querySelectorAll(`.author-avatar-${address}`).forEach(img => img.src = data.avatar);
            document.querySelectorAll(`.author-nick-${address}`).forEach(el => el.innerText = data.nickname);
        }

        // --- INTERAKSI ---
        
        async function openComments(postId) {
            const index = postId - 1; 
            const modal = document.getElementById("commentModal");
            const list = document.getElementById("commentList");
            
            document.getElementById("commentPostId").value = index;
            document.getElementById("commentInput").value = "";
            modal.showModal(); // BUKA POPUP
            list.innerHTML = "<p style='text-align:center; padding:20px;'><i class='fa-solid fa-spinner fa-spin'></i> Memuat...</p>";

            try {
                const comments = await contract.getComments(index);
                list.innerHTML = "";
                
                if(comments.length === 0) {
                    list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Belum ada komentar.</p>";
                    return;
                }

                for (const c of comments) {
                    // Logic sederhana tanpa lazy load untuk komentar biar cepat
                    let nick = c.commenter.substring(0,6);
                    let avt = "https://via.placeholder.com/30";
                    
                    if(profileCache[c.commenter]) {
                        nick = profileCache[c.commenter].nickname;
                        avt = profileCache[c.commenter].avatar;
                    }

                    const html = `
                    <div class="comment-item">
                        <img src="${avt}" class="comment-avatar">
                        <div class="comment-content">
                            <div class="comment-author">${nick}</div>
                            <div>${c.text}</div>
                            <div class="comment-time">${new Date(c.timestamp * 1000).toLocaleTimeString()}</div>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                }
            } catch(e) {
                list.innerHTML = "Gagal memuat komentar.";
            }
        }

        async function submitComment() {
            const index = document.getElementById("commentPostId").value;
            const text = document.getElementById("commentInput").value;
            if(!text) return;

            try {
                showToast("Mengirim...", "info");
                const tx = await contract.addComment(index, text, "");
                await tx.wait();
                showToast("Terkirim!", "success");
                document.getElementById("commentInput").value = "";
                openComments(parseInt(index) + 1); // Refresh modal
                loadFeed(); // Refresh counter di home
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }

        async function handleLike(postId) {
            const countSpan = document.getElementById(`count-like-${postId}`);
            const icon = document.getElementById(`icon-like-${postId}`);
            const current = parseInt(countSpan.innerText);
            
            // Optimistic UI
            countSpan.innerText = current + 1;
            icon.classList.remove("fa-regular");
            icon.classList.add("fa-solid");
            icon.style.color = "#e74c3c";

            try {
                const tx = await contract.likePost(postId - 1);
                await tx.wait();
            } catch (e) {
                countSpan.innerText = current; // Rollback
                icon.classList.add("fa-regular");
                icon.classList.remove("fa-solid");
                icon.style.color = "";
                showToast("Gagal Like", "error");
            }
        }

        // Post & Rating
        async function submitPost() {
            const caption = document.getElementById("postCaption").value;
            const file = document.getElementById("fileInput").files[0];
            const btn = document.getElementById("btnPost");

            if(!caption && !file) return showToast("Konten kosong!", "error");

            try {
                btn.disabled = true;
                btn.innerText = "Mengirim...";
                let imgUri = "";
                if(file) {
                    showToast("Mengupload (Kompresi 30KB)...", "info");
                    imgUri = await uploadToIPFS(file);
                }
                const tx = await contract.createPost(imgUri, caption);
                await tx.wait();
                showToast("Berhasil!", "success");
                document.getElementById("postCaption").value = "";
                clearImage();
                btn.disabled = false;
                btn.innerText = "Posting";
                loadFeed();
            } catch(e) {
                showToast("Gagal: " + e.message, "error");
                btn.disabled = false;
                btn.innerText = "Posting";
            }
        }

        let selectedRate = 0;
        function openRating(pid) { document.getElementById("targetPostId").value = pid; document.getElementById("ratingModal").showModal(); selectedRate=0; }
        function setRate(n) { selectedRate=n; showToast(`${n} Bintang`, "info"); }
        async function submitRating() {
            if(!selectedRate) return;
            try {
                document.getElementById("ratingModal").close();
                const tx = await contract.ratePost(document.getElementById("targetPostId").value - 1, selectedRate);
                await tx.wait();
                showToast("Rated!", "success");
            } catch(e) { showToast("Gagal", "error"); }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imgPreview').src = e.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function clearImage() {
            document.getElementById('fileInput').value = "";
            document.getElementById('previewContainer').style.display = 'none';
        }
    </script>
</body>
    </html>
