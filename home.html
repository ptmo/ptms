<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
   <style>
    /* --- RESET & GLOBAL --- */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background: #f0f2f5; }

    /* --- LAYOUT GRID UTAMA --- */
    .layout-wrapper { 
        display: grid; 
        grid-template-columns: 280px 1fr; /* Kiri 280px, Kanan Auto */
        gap: 25px; 
        max-width: 1200px; 
        margin: 20px auto;
        padding: 0 15px;
    }

    /* --- SIDEBAR PC --- */
    .sidebar-left { display: block; }

    /* --- MOBILE NAV (MENU BAWAH) --- */
    .mobile-nav {
        display: none; /* Default sembunyi di PC */
        position: fixed; /* KUNCI: Menempel di layar */
        bottom: 0; left: 0; width: 100%;
        background: white; border-top: 1px solid #eee;
        justify-content: space-around; align-items: center;
        padding: 12px 0; z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    .mobile-nav .menu-item {
        font-size: 20px; color: #ccc;
        text-decoration: none; position: relative;
        padding: 5px 15px; display: flex;
        align-items: center; justify-content: center;
    }
    .mobile-nav .menu-item.active { color: #7385a5; }

    /* --- RESPONSIVE (HP) --- */
    @media (max-width: 900px) {
        .layout-wrapper { grid-template-columns: 1fr; display: block; }
        .sidebar-left { display: none !important; } /* Paksa Sidebar Hilang */
        .mobile-nav { display: flex !important; } /* Paksa Menu Bawah Muncul */
        .main-feed { margin-bottom: 80px; } /* Beri jarak agar tidak tertutup menu */
    }

    /* --- COMPONENTS --- */
    .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; gap: 10px; }
    .comment-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
    .comment-content { flex: 1; font-size: 13px; }
    .post-image { cursor: zoom-in; transition: opacity 0.2s; }
    dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    
    .nav-badge {
        background-color: #e74c3c; color: white;
        font-size: 10px; font-weight: bold;
        min-width: 16px; height: 16px; border-radius: 50%;
        display: none; align-items: center; justify-content: center;
        position: absolute; top: -5px; right: -25%; z-index: 10;
    }
    .star-wrapper { display: flex; gap: 15px; direction: ltr; }
    .star-item { color: #ccc; transition: 0.2s; cursor: pointer; }
    .star-item.active, .star-item:hover { color: gold; transform: scale(1.2); }
   </style>
</head>
<body>

    <div class="layout-wrapper">
        
        <div class="sidebar-left">
    <div class="menu-card">
        <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i> Beranda</a>
        <a href="notifications.html" class="menu-item">
            <i class="fa-solid fa-bell"></i> Notifikasi
            <span class="nav-badge" id="badgeSidebar">0</span> 
        </a>
        <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
        
        <a href="#" id="sidebarWalletBtn" onclick="handleWalletClick()" class="menu-item" style="justify-content: space-between;">
            <span><i class="fa-solid fa-wallet"></i> <span id="sidebarWalletText">Connect</span></span>
            <i class="fa-solid fa-circle" id="walletIndicator" style="font-size: 8px; color: #ccc;"></i>
        </a>
    </div>
</div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin: 0 0 10px; font-size: 14px; color: #7385a5;">Status Wallet</h4>
                <div style="font-size: 12px; word-break: break-all; color: #666;" id="walletDisplay">Loading...</div>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin-top:0; color:#7385a5;">ðŸ”¥ Sedang Populer</h4>
                <div id="trendingWidget">
                    <p style="font-size:12px; color:#999;">Memuat...</p>
                </div>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin-top:0; color:#7385a5;">âœ¨ Siapa yang diikuti</h4>
                <div id="recomWidget">
                    <p style="font-size:12px; color:#999;">Mencari...</p>
                </div>
            </div>
        </div>

        <div class="main-feed">
    
            <div class="card" style="padding: 5px 15px; margin-bottom: 20px; position: sticky; top: 10px; z-index: 99; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">            
                <form onsubmit="event.preventDefault(); window.location.href = 'result.html?q=' + document.getElementById('searchInput').value;" 
                      style="display: flex; gap: 10px; align-items: center; margin: 0; width: 100%;">
                    
                    <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer; color: #999;">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                    
                    <input type="search" id="searchInput" 
                           class="cp-input" 
                           placeholder="Pencarian..." 
                           style="border: none; background: transparent; flex: 1; outline: none; height:35px;">
                </form>
            </div>

            <div style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee;">
                <div id="tabFriends" onclick="switchFeed('friends')" style="flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #8b4513; border-bottom: 3px solid #8b4513;">
                 <i class="fa-solid fa-user-group"></i> Mengikuti
            </div>
            <div id="tabGlobal" onclick="switchFeed('global')" style="flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #999; border-bottom: 3px solid transparent;">
                 <i class="fa-solid fa-earth-asia"></i> Jelajah
            </div>
            </div>

            <div class="card create-post-box" style="margin-bottom: 20px;">
                <div class="cp-header">
                    <img src="https://via.placeholder.com/40" class="user-avatar" id="myAvatar">
                    <textarea id="mainCaption" class="cp-input" placeholder="Ceritakan wayang ini"></textarea>
                </div>

                <div id="nftReadyIndicator" style="display:none; background:#f0fff4; border:1px solid #48bb78; padding:10px; margin:10px 15px; border-radius:8px; font-size:12px; color:#2f855a;">
                    <i class="fa-solid fa-check-circle"></i> 
                    <strong>Data Arsip Siap!</strong> <span id="nftFilenamePreview"></span>
                    <button onclick="cancelNft()" style="float:right; background:none; border:none; color:#c53030; cursor:pointer;">Batal</button>
                </div>

                <div class="cp-actions">
                    <button onclick="openNftModal()" class="btn-upload" style="background:none; border:none; cursor:pointer; color:#8b4513; font-weight:bold; display:flex; align-items:center; gap:5px;">
                        <i class="fa-solid fa-scroll"></i> Arsipkan Wayang
                    </button>
                    <span style="font-size:10px; color:#999; margin-right:auto; margin-left:5px;">(0.0001 ETH)</span>

                    <button id="btnPost" class="btn-primary" onclick="submitPost()">Posting</button>
                </div>
            </div>

            <div id="feedContainer">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat Blockchain...
                </div>
            </div>
        </div>

        </div>

    <dialog id="commentModal" style="border:none; border-radius:15px; padding:0; box-shadow:0 0 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; height: 70vh;">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; color:#7385a5;">Komentar</h3>
            <span onclick="document.getElementById('commentModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        <div id="commentList" style="flex: 1; overflow-y: auto; padding: 15px;">
            <p style="text-align:center; color:#999;">Memuat komentar...</p>
        </div>
        <div style="padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; display: flex; gap: 10px; align-items: flex-end;">
            <textarea 
                id="commentInput" 
                class="cp-input" 
                placeholder="Tulis komentar... (Tempel link di sini)" 
                style="flex: 1; height: 50px; padding: 10px; resize: none; border: 1px solid #ddd; border-radius: 10px; font-family: sans-serif;"></textarea>
            <input type="hidden" id="commentPostId">        
            <button 
                onclick="submitComment()" 
                class="btn-primary" 
                style="height: 50px; width: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </dialog>

    <dialog id="nftModal" style="border:none; border-radius:10px; padding:20px; width:95%; max-width:500px; box-shadow:0 0 50px rgba(0,0,0,0.5); margin:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; color:#8b4513;"><i class="fa-solid fa-scroll"></i> Arsip Wayang (NFT)</h3>
            <span onclick="document.getElementById('nftModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>

        <div style="overflow-y:auto; max-height:60vh; padding-right:5px;">
            <div style="margin-bottom: 15px;">
                <label style="font-size:12px; font-weight:bold; color:#8b4513;">Nama Tokoh Wayang <span style="color:red">*</span></label>
                <input type="text" id="mName" class="cp-input" style="width:100%; font-size:14px; font-weight:bold;" placeholder="Contoh: Raden Arjuna">
            </div>

            <div style="background:#fffaf0; padding:15px; border-radius:8px; text-align:center; border:2px dashed #d4af37; margin-bottom:15px;">
                <label for="modalFileInput" style="cursor:pointer; display:block;">
                    <i class="fa-solid fa-camera" style="font-size:24px; color:#8b4513;"></i><br>
                    <span style="font-size:12px; color:#666;">Klik untuk Pilih Foto Fisik Wayang</span>
                </label>
                <input type="file" id="modalFileInput" style="display:none;" onchange="previewInModal(this)">
                <div id="modalFilePreview" style="font-size:11px; color:#27ae60; margin-top:5px; font-weight:bold;"></div>
            </div>

            <label style="font-size:12px; font-weight:bold; color:#555;">Detail Atribut Wayang</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div>
                    <label style="font-size:10px; color:#999;">Golongan</label>
                    <select id="mGolongan" class="cp-input" style="width:100%; height:38px;">
                        <option value="" disabled selected>-- Pilih --</option>
                        <option value="Dewa">Dewa</option>
                        <option value="Punggawa">Punggawa</option>
                        <option value="Satria">Satria</option>
                        <option value="Putri">Putri</option>
                        <option value="Resi">Resi</option>
                        <option value="Punakawan">Punakawan</option>
                        <option value="Raksasa">Raksasa</option>
                        <option value="Wanara">Wanara</option>
                        <option value="Hewan">Hewan</option>
                        <option value="Pusaka">Pusaka</option>
                        <option value="Krodan">Krodan</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:10px; color:#999;">Gaya (Gagrak)</label>
                    <select id="mGaya" class="cp-input" style="width:100%; height:38px;">
                        <option value="" disabled selected>-- Pilih --</option>
                        <option value="Surakarta">Surakarta</option>
                        <option value="Yogyakarta">Yogyakarta</option>
                        <option value="Kedu">Kedu</option>
                        <option value="Banyumasan">Banyumasan</option>
                        <option value="Jawa Timuran">Jawa Timuran</option>
                        <option value="Cirebon">Cirebon</option>
                        <option value="Golek Sunda">Golek Sunda</option>
                        <option value="Bali">Bali</option>
                        <option value="Sasak">Sasak (Lombok)</option>
                        <option value="Palembang">Palembang</option>
                        <option value="Banjar">Banjar</option>
                        <option value="Kontemporer">Kontemporer</option>
                    </select>
                </div>
                <input type="text" id="mBahan" class="cp-input" placeholder="Bahan (Cth: Kulit Kerbau)">
                <input type="text" id="mGapit" class="cp-input" placeholder="Gapit (Cth: Tanduk)">
                <input type="text" id="mPenatah" class="cp-input" placeholder="Penatah (Opsional)">
                <input type="text" id="mPenyungging" class="cp-input" placeholder="Penyungging (Opsional)">
                <input type="text" id="mTahun" class="cp-input" placeholder="Tahun (Cth: 1980)">
                <input type="text" id="mKolektor" class="cp-input" placeholder="Kolektor Saat Ini">
            </div>
        </div>

        <div style="margin-top:20px;">
            <button onclick="saveNftDraft()" class="btn-primary" style="width:100%; background:#8b4513; border:none; padding:12px; font-weight:bold;">
                <i class="fa-solid fa-save"></i> Simpan Data Arsip
            </button>
        </div>
    </dialog>

    <dialog id="sawerModal" style="border:none; padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); width: 300px;">
    <h3 style="margin-top:0; text-align:center; color:#7385a5;">Sawer Kurator</h3>
    <p style="text-align:center; font-size:12px; color:#666;">Dukung pelestari budaya dengan ETH.</p>
    
    <input type="hidden" id="sawerTargetId">

    <div class="preset-row">
        <button type="button" class="btn-preset" onclick="setSawerVal('min')">Min</button>
        <button type="button" class="btn-preset" onclick="setSawerVal(0.25)">25%</button>
        <button type="button" class="btn-preset" onclick="setSawerVal(0.50)">50%</button>
        <button type="button" class="btn-preset" onclick="setSawerVal(0.75)">75%</button>
        <button type="button" class="btn-preset" onclick="setSawerVal('max')">Max</button>
    </div>

    <input type="number" id="sawerAmount" class="cp-input" placeholder="0.0001" step="0.00001" style="width:100%; margin-bottom:5px; text-align:center; font-weight:bold; box-sizing:border-box;">
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:10px; color:#999;">
        <span>Min: 0.00002 ETH</span>
        <span>Max: 0.01 ETH</span>
    </div>

    <div style="display:flex; gap:10px;">
        <button onclick="document.getElementById('sawerModal').close()" style="flex:1; background:none; border:1px solid #ccc; padding:10px; cursor:pointer; border-radius:10px;">Batal</button>
        <button onclick="submitSawer()" style="flex:1; background:#7385a5; color:white; border:none; padding:10px; cursor:pointer; border-radius:10px;">Kirim</button>
    </div>
    </dialog>
    
    <dialog id="ratingModal" style="border:none; border-radius:12px; padding:20px; box-shadow:0 0 30px rgba(0,0,0,0.3); width:300px;">
    <h3 style="margin-top:0; text-align:center; color:#7385a5;">Beri Bintang</h3>
    
    <input type="hidden" id="ratingTargetId">

    <div style="display:flex; gap:5px; font-size:35px; justify-content:center; cursor:pointer; margin:20px 0;">
        <div class="star-wrapper">
            <i class="fa-solid fa-star star-item" data-value="1" onclick="setRate(1)"></i>
            <i class="fa-solid fa-star star-item" data-value="2" onclick="setRate(2)"></i>
            <i class="fa-solid fa-star star-item" data-value="3" onclick="setRate(3)"></i>
            <i class="fa-solid fa-star star-item" data-value="4" onclick="setRate(4)"></i>
            <i class="fa-solid fa-star star-item" data-value="5" onclick="setRate(5)"></i>
        </div>
    </div>
    
    <div style="display:flex; gap:10px;">
        <button onclick="document.getElementById('ratingModal').close()" style="flex:1; background:none; border:1px solid #ccc; padding:10px; cursor:pointer; border-radius:10px;">Batal</button>
        <button onclick="submitRating()" style="flex:1; background:#7385a5; border:none; padding:10px; color:white; border-radius:10px; cursor:pointer; font-weight:bold;">Kirim</button>
    </div>
    </dialog>

    <div id="walletPopupOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; width: 300px; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: relative;">
        
        <h3 style="margin: 0 0 15px 0; color: #333;">Dompet Terhubung</h3>
        
        <div style="width: 60px; height: 60px; background: #eef2f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
            <i class="fa-solid fa-wallet" style="font-size: 24px; color: #7385a5;"></i>
        </div>

        <p style="font-size: 12px; color: #888; margin-bottom: 5px;">Alamat Dompet:</p>
        <div style="background: #f5f5f5; padding: 8px; border-radius: 8px; font-family: monospace; font-size: 13px; color: #333; word-break: break-all; margin-bottom: 20px;">
            <span id="popupAddressText">0x...</span>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="copyAddress()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer;">
                <i class="fa-regular fa-copy"></i> Salin
            </button>
            <button onclick="performDisconnect()" style="flex: 1; padding: 10px; border: none; background: #ffebee; color: #d32f2f; border-radius: 8px; cursor: pointer; font-weight: bold;">
                Putuskan
            </button>
        </div>

        <button onclick="closeWalletPopup()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: #999;">&times;</button>
    </div>
    </div>
    
    <div class="mobile-nav">
    <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i></a>
    <a href="notifications.html" class="menu-item">
        <i class="fa-solid fa-bell"></i>
        <span class="nav-badge" id="badgeMobile">0</span> 
    </a>
    <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i></a>
    <a href="#" id="navWalletBtn" onclick="handleWalletClick()" class="menu-item">
        <i class="fa-solid fa-wallet"></i>
    </a>
    </div>
    
    <div id="toast"></div>

    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        const profileCache = {};
        const commentProfileCache = {};
        const SAWER_MIN = 0.00002;
        const SAWER_MAX = 0.01;
        let currentFeedType = 'friends';
        let selectedRate = 0;
        let isWalletConnected = false;
        
        // ABI BARU (PASTE ABI LENGKAP DARI REMIX DI SINI ATAU DI MAIN.JS)

        // --- 1. STARTUP SUPER CEPAT (EVENT LISTENER BARU) ---
        // --- FIX STARTUP LOGIC ---
window.addEventListener('load', async () => {
    // 1. Cek Sesi Lokal
    const sessionRaw = localStorage.getItem("putramas_session");
    if (!sessionRaw) {
        // Jangan redirect, biarkan user lihat feed public/cache dulu
        // window.location.replace("index.html"); 
        return;
    }

    try {
        const session = JSON.parse(sessionRaw);
        
        // 2. Cek Expired
        if (Date.now() > session.expiry) {
            localStorage.removeItem("putramas_session");
            return;
        }

        if (!window.ethereum) return;

        // 3. Init Provider & Active Signer
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // Cek apakah wallet terkunci (Silent check dulu)
        const accounts = await provider.listAccounts();
        if (accounts.length > 0) {
             // Kalau sudah unlock, minta akses penuh
             await provider.send("eth_requestAccounts", []);
        } else {
             // Kalau terkunci, stop dulu (tunggu user klik tombol connect)
             return;
        }

        // 4. Cek Network
        const { chainId } = await provider.getNetwork();
        if (chainId !== BASE_SEPOLIA_ID) return; // Salah network, stop

        signer = provider.getSigner();
        const currentAddr = await signer.getAddress();

        // 5. Validasi Akun Sesuai Sesi
        if (currentAddr.toLowerCase() !== session.address.toLowerCase()) {
            throw new Error("Akun Berbeda");
        }

        // 6. Setup Kontrak & State Global
        contract = new ethers.Contract(MY_CONTRACT_ADDR, CONTRACT_ABI, signer);
        window.contract = contract;
        window.userAddress = currentAddr;
        userAddress = currentAddr;

        console.log("âœ… KONEKSI AMAN:", currentAddr);
        
        // 7. Update UI (PENTING)
        isWalletConnected = true;
        updateWalletUI(currentAddr);
        loadMyProfile();
        
        // 8. Load Data Live
        loadFeedLive(); 

    } catch (e) {
        console.warn("Sesi Invalid/Reset:", e.message);
        localStorage.removeItem("putramas_session");
        isWalletConnected = false;
        updateWalletUI("");
    }
});

        // --- 2. LOAD PROFIL HEADER (Kiri Atas) ---
        async function loadMyProfile() {
            try {
                const p = await contract.getProfile(userAddress);
                if(p.fotoProfil) {
                    const cleanUrl = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    // Avatar Profil juga dikompres kecil
                    const optAvatar = `https://wsrv.nl/?url=${encodeURIComponent(cleanUrl)}&w=100&q=70&output=webp`;
                    document.getElementById("myAvatar").src = optAvatar;
                }
            } catch(e) {}
        }

        // --- 3. FUNGSI GANTI TAB ---
        function switchFeed(type) {
            currentFeedType = type;
            const tabFriends = document.getElementById("tabFriends");
            const tabGlobal = document.getElementById("tabGlobal");

            // Reset UI Loading
            document.getElementById("feedContainer").innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat...
                </div>`;

            // Atur Style Tab
            if(type === 'friends') {
                tabFriends.style.color = "#8b4513";
                tabFriends.style.borderBottom = "3px solid #8b4513";
                tabGlobal.style.color = "#999";
                tabGlobal.style.borderBottom = "3px solid transparent";
            } else {
                tabGlobal.style.color = "#8b4513";
                tabGlobal.style.borderBottom = "3px solid #8b4513";
                tabFriends.style.color = "#999";
                tabFriends.style.borderBottom = "3px solid transparent";
            }

            loadFeed();
        }
        
        // --- SCRIPT SAWWER (WAJIB ADA) ---
    function openSawerModal(id) {
        document.getElementById("sawerTargetId").value = id;
        document.getElementById("sawerAmount").value = ""; // Kosongkan input
        
        // Reset warna tombol preset
        document.querySelectorAll('.btn-preset').forEach(b => b.classList.remove('active'));
        
        document.getElementById("sawerModal").showModal();
    }

    // 2. Fungsi Hitung Otomatis (Preset)
    function setSawerVal(factor) {
        let val = 0;
        
        if (factor === 'min') {
            val = SAWER_MIN;
        } else if (factor === 'max') {
            val = SAWER_MAX;
        } else {
            // Hitung persentase dari MAKSIMAL (0.01)
            val = SAWER_MAX * factor;
        }

        // Format angka (maksimal 5 desimal agar tidak error overflow)
        // parseFloat untuk menghilangkan nol tidak penting di belakang (misal 0.00500 jadi 0.005)
        document.getElementById("sawerAmount").value = parseFloat(val.toFixed(5));
        
        // Visual Feedback (Highlight tombol yang diklik)
        document.querySelectorAll('.btn-preset').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    // 3. Fungsi Kirim (Submit)
    async function submitSawer() {
        const postId = document.getElementById("sawerTargetId").value; // Ambil dari input hidden
        const amount = document.getElementById("sawerAmount").value;

        // Validasi
        if (!postId) return showToast("Error ID Postingan", "error");
        if (!amount || amount <= 0) return showToast("Masukkan jumlah valid", "error");
        if (amount < SAWER_MIN) return showToast(`Minimal ${SAWER_MIN} ETH`, "error");
        if (amount > SAWER_MAX) return showToast(`Maksimal ${SAWER_MAX} ETH`, "error");

        try {
            document.getElementById("sawerModal").close();
            showToast("Mengirim Saweran...", "info");
            
            // Konversi ke Wei
            const weiAmount = ethers.utils.parseEther(amount.toString());
            
            // Eksekusi Smart Contract (Index blockchain = ID - 1)
            const tx = await contract.sawerPost(postId - 1, { value: weiAmount });
            
            await tx.wait();
            showToast("Terima kasih! Saweran terkirim", "success");
        } catch (e) {
            console.error(e);
            // Cek jika user reject
            if(e.code === 'ACTION_REJECTED' || e.code === 4001) {
                showToast("Transaksi dibatalkan user", "info");
            } else {
                showToast("Gagal: " + (e.reason || e.message), "error");
            }
        }
    }

        // --- SCRIPT FOLLOW ---
        async function followUser(targetAddr) {
            try {
                showToast("Memproses Follow...", "info");
                const tx = await contract.followUser(targetAddr);
                await tx.wait();
                showToast("Berhasil Mengikuti!", "success");
                renderWidgets(); // Refresh widget
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }

        // --- FUNGSI LOAD PROFILE HEADER ---
         async function loadMyProfile() {
            try {
                const p = await contract.getProfile(userAddress);
                if(p.fotoProfil) {
                    const cleanUrl = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    const optAvatar = `https://wsrv.nl/?url=${encodeURIComponent(cleanUrl)}&w=100&q=70&output=webp`;
                    document.getElementById("myAvatar").src = optAvatar;
                }
            } catch(e) {}
        }

        async function fetchProfileLazy(address) {
            if(profileCache[address]) {
                updatePostAuthorUI(address, profileCache[address]);
                return;
            }
            try {
                const p = await contract.getProfile(address);
                let avatarUrl = 'https://via.placeholder.com/40';
                if (p.fotoProfil) {
                    const raw = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    avatarUrl = `https://wsrv.nl/?url=${encodeURIComponent(raw)}&w=80&q=60&output=webp`;
                }
                const data = { nickname: p.nickname, avatar: avatarUrl };
                profileCache[address] = data;
                updatePostAuthorUI(address, data);
            } catch (e) {}
        }
        
        // --- 2. FUNGSI KHUSUS BACA CACHE (Sangat Ringan) ---
        function loadFeedFromCacheOnly() {
            const cacheKey = `feed_cache_${currentFeedType}`;
            const cachedData = localStorage.getItem(cacheKey);
            
            if (cachedData) {
                console.log("âš¡ Tampil Instan dari Cache");
                try {
                    const parsed = JSON.parse(cachedData);
                    if(parsed.length > 0) {
                        const container = document.getElementById("feedContainer");
                        container.innerHTML = ""; // Bersihkan loading spinner
                        renderPostLoop(parsed, container, true); // true = mode cache
                    }
                } catch(e) { console.error("Cache rusak", e); }
            }
        }

        // --- 3. FUNGSI KHUSUS LIVE DATA (Blockchain) ---
        async function loadFeedLive() {
            try {
                // Jangan hapus konten lama dulu (biar user gak liat layar kedip putih)
                // Kita load data di memori dulu
                let posts;
                if(currentFeedType === 'friends') {
                    posts = await contract.getMyFeed();
                } else {
                    posts = await contract.getAllPosts();
                }

                const container = document.getElementById("feedContainer");

                if(posts.length === 0) {
                    // Cek lagi cache, kalau cache juga kosong baru tampilkan pesan kosong
                    const cacheKey = `feed_cache_${currentFeedType}`;
                    if(!localStorage.getItem(cacheKey)) {
                         const msg = currentFeedType === 'friends' 
                            ? "Belum ada postingan dari teman."
                            : "Belum ada postingan di platform.";
                        container.innerHTML = `<p style='text-align:center; color:#999; margin-top:40px;'>${msg}</p>`;
                    }
                    return;
                }

                // SIMPAN KE LOCAL STORAGE
                const plainPosts = posts.map(p => ({
                    id: p.id.toString(),
                    author: p.author,
                    caption: p.caption,
                    imageURI: p.imageURI,
                    tokenURI: p.tokenURI,
                    timestamp: p.timestamp.toString(),
                    likeCount: p.likeCount.toString(),
                    commentCount: p.commentCount.toString(),
                    nftId: p.nftId.toString(),
                    ratingCount: p.ratingCount.toString(),
                    totalRatingScore: p.totalRatingScore.toString()
                }));

                const cacheKey = `feed_cache_${currentFeedType}`;
                localStorage.setItem(cacheKey, JSON.stringify(plainPosts));

                // RENDER ULANG (Update Tampilan dengan Data Baru)
                container.innerHTML = ""; 
                renderPostLoop(plainPosts, container, false); // false = mode live

            } catch (e) { 
                console.error("Gagal load live:", e);
                // Tidak perlu tampilkan error di UI jika cache sudah tampil
            }
        }

        // --- 4. GANTI TAB (Panggil Cache Dulu, Baru Live) ---
        function switchFeed(type) {
            currentFeedType = type;
            
            // UI Tab
            const tabFriends = document.getElementById("tabFriends");
            const tabGlobal = document.getElementById("tabGlobal");
            const activeStyle = "flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #8b4513; border-bottom: 3px solid #8b4513;";
            const inactiveStyle = "flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #999; border-bottom: 3px solid transparent;";

            if(type === 'friends') {
                tabFriends.style.cssText = activeStyle;
                tabGlobal.style.cssText = inactiveStyle;
            } else {
                tabGlobal.style.cssText = activeStyle;
                tabFriends.style.cssText = inactiveStyle;
            }

            // LOGIKA GANTI TAB CEPAT
            const container = document.getElementById("feedContainer");
            const cacheKey = `feed_cache_${type}`;
            const cachedData = localStorage.getItem(cacheKey);

            if(cachedData) {
                // Jika ada cache, langsung tampilkan
                container.innerHTML = "";
                renderPostLoop(JSON.parse(cachedData), container, true);
                // Lalu update diam-diam
                loadFeedLive();
            } else {
                // Jika tidak ada cache, baru munculkan loading spinner
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #999;"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat...</div>`;
                loadFeedLive();
            }
        }

        // --- HELPER RENDER (Sama seperti sebelumnya) ---
        function renderPostLoop(postsArray, container, isCache) {
            [...postsArray].reverse().forEach(post => {
                const profileLink = `profile.html?addr=${post.author}`;
                let imgHtml = "";
                
                // Optimasi Gambar 60KB
                if(post.imageURI && post.imageURI.length > 5) {
                    const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    const optUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=500&q=60&output=webp`;

                    let metaBox = "";
                    if(parseInt(post.nftId) > 0) {
                        const shortWallet = post.author.substring(0,6) + "..." + post.author.substring(38);
                        metaBox = `
                        <div class="nft-citation" style="background:#f8f9fa; padding:12px; border:1px solid #eee; border-top:none; border-radius:0 0 10px 10px; font-size:12px; color:#444; margin-top:-4px; position:relative; z-index:2;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px; align-items:center;">
                                <span><i class="fa-solid fa-mask" style="color:#8b4513; margin-right:5px;"></i> <strong>Nama:</strong> <span id="meta-name-${post.id}" style="color:#8b4513; font-weight:bold;">Loading...</span></span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
                                <span><i class="fa-solid fa-palette" style="color:#7385a5; margin-right:5px;"></i> <strong>Gagrak:</strong> <span id="meta-gagrak-${post.id}">-</span></span>
                            </div>
                            <div style="border-top:1px dashed #ddd; padding-top:8px; display:flex; justify-content:space-between; align-items:center;">
                                <span><i class="fa-solid fa-user-tie" style="color:#555; margin-right:5px;"></i> <strong>Kolektor:</strong> <span class="author-nick-${post.author}">${shortWallet}</span></span>
                                <span style="font-size:10px; color:#8b4513; font-style:italic;">Detail <i class="fa-solid fa-chevron-right" style="font-size:9px;"></i></span>
                            </div>
                        </div>`;
                    }

                    imgHtml = `
                    <div style="margin:10px -15px 0 -15px;">
                        <a href="koleksi.html?id=${post.id}" style="text-decoration:none; display:block;">
                            <img src="${optUrl}" class="post-image" style="width:100%; display:block; min-height:200px; background:#f0f0f0;" loading="lazy">
                            ${metaBox}
                        </a>
                    </div>`;

                    if(parseInt(post.nftId) > 0 && post.tokenURI && !isCache) {
                        setTimeout(() => fetchCardMetadata(post.id, post.tokenURI), 100);
                    }
                }

                const rCount = parseInt(post.ratingCount);
                const rScore = parseInt(post.totalRatingScore);
                const avgRating = rCount > 0 ? (rScore / rCount).toFixed(1) : "0.0";
                const nftBadge = parseInt(post.nftId) > 0 ? `<span style="background:#d4af37; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">NFT #${post.nftId}</span>` : "";
                
                const html = `
                <div class="card" id="post-${post.id}" style="padding: 15px; margin-bottom: 20px;">
                    <div class="post-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <a href="${profileLink}">
                            <img src="https://via.placeholder.com/40" class="user-avatar author-avatar-${post.author}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee;" loading="lazy">
                        </a>
                        <div class="post-info">
                            <a href="${profileLink}" class="author-nick-${post.author}" style="text-decoration: none; color: #333; font-weight: bold; font-size: 14px;">
                                ${post.author.substring(0,6)}...
                            </a>
                            <div style="font-size: 11px; color: #999;">
                                ${new Date(parseInt(post.timestamp) * 1000).toLocaleString()} ${nftBadge}
                            </div>
                        </div>
                    </div>
                    <div class="post-caption" style="margin-bottom:10px; font-size:14px; line-height:1.5;">${formatCaption(post.caption)}</div>
                    ${imgHtml}

                    <div class="post-actions" style="border-top:1px solid #eee; padding-top:10px; margin-top:5px; display:flex; justify-content:space-around; align-items:center;">
                         <button class="action-btn" onclick="handleLike(${post.id})" style="background:none; border:none; cursor:pointer; color:#666; display:flex; gap:5px; align-items:center;">
                            <i class="fa-regular fa-heart" id="icon-like-${post.id}"></i> <span id="count-like-${post.id}">${post.likeCount}</span>
                         </button>
                         <button class="action-btn" onclick="openComments(${post.id})" style="background:none; border:none; cursor:pointer; color:#666; display:flex; gap:5px; align-items:center;">
                            <i class="fa-regular fa-comment"></i> <span id="count-comment-${post.id}">${post.commentCount}</span>
                         </button>
                         <button class="action-btn" onclick="openSawerModal(${post.id})" style="background:none; border:none; cursor:pointer; color:#666;" title="Sawer">
                            <i class="fa-solid fa-gift"></i>
                         </button>
                         <button class="action-btn" onclick="openRating(${post.id})" style="background:none; border:none; cursor:default; color:gold; display:flex; gap:5px; align-items:center;">
                            <i class="fa-solid fa-star"></i> <span id="score-rating-${post.id}">${avgRating}</span>
                         </button>
                    </div>
                </div>`;
                container.innerHTML += html;
                fetchProfileLazy(post.author);
            });
                                                                          }
                
        function updatePostAuthorUI(address, data) {
            document.querySelectorAll(`.author-avatar-${address}`).forEach(img => img.src = data.avatar);
            document.querySelectorAll(`.author-nick-${address}`).forEach(el => el.innerText = data.nickname);
        }

        // --- INTERAKSI LIKE & RATE ---
        async function handleLike(postId) {
            const countSpan = document.getElementById(`count-like-${postId}`);
            const icon = document.getElementById(`icon-like-${postId}`);
            const current = parseInt(countSpan.innerText);
            
            countSpan.innerText = current + 1;
            icon.classList.remove("fa-regular");
            icon.classList.add("fa-solid");
            icon.style.color = "#e74c3c";

            try {
                const tx = await contract.likePost(postId - 1);
                await tx.wait();
            } catch (e) {
                // Rollback jika gagal
                countSpan.innerText = current;
                icon.classList.add("fa-regular");
                icon.classList.remove("fa-solid");
                icon.style.color = "";
            }
        }

        // --- 1. MEMBUKA MODAL ---
    function openRating(id) {
        // Simpan ID ke input hidden
        document.getElementById("ratingTargetId").value = id;
        // Reset tampilan bintang jadi 0
        selectedRate = 0;
        updateStarVisuals(0);
        // Buka Modal
        document.getElementById("ratingModal").showModal();
    }

    // --- 2. LOGIKA WARNA BINTANG ---
    function setRate(n) {
        selectedRate = n;
        updateStarVisuals(n);
    }

    function updateStarVisuals(n) {
        const stars = document.querySelectorAll('.star-item');
        stars.forEach((star, index) => {
            // Index array mulai dari 0, nilai n mulai dari 1
            // Jika index < n, warnai emas. Sisanya abu-abu.
            if (index < n) {
                star.style.color = "gold";
                star.classList.add('active'); // Memicu efek scale di CSS
            } else {
                star.style.color = "#ccc"; 
                star.classList.remove('active');
            }
      });
    }

    // --- 3. KIRIM KE BLOCKCHAIN ---
    async function submitRating() {
        const postId = document.getElementById("ratingTargetId").value;

        if (!postId) return showToast("Error ID Postingan", "error");
        if (selectedRate === 0) return showToast("Pilih minimal 1 bintang!", "error");

        try {
            document.getElementById("ratingModal").close();
            showToast(`Mengirim ${selectedRate} Bintang...`, "info");

            // Post ID di Blockchain = ID - 1 (Array Index)
            const tx = await contract.ratePost(postId - 1, selectedRate);
            await tx.wait();
            showToast("Rating berhasil dikirim!", "success");
            // (Opsional) Refresh halaman otomatis agar nilai berubah
            // setTimeout(() => location.reload(), 1000); 
        } catch (e) {
            console.error(e);
            // Cek jika user membatalkan di Metamask
            if(e.code === 'ACTION_REJECTED' || e.code === 4001) {
                showToast("Batal memberi rating", "info");
            } else {
                showToast("Gagal: " + (e.reason || e.message), "error");
            }
        }
    }
        
        // --- SCRIPT KOMENTAR ---
        async function openComments(postId) {
            const index = postId - 1; 
            const modal = document.getElementById("commentModal");
            const list = document.getElementById("commentList");
            document.getElementById("commentPostId").value = index;
            document.getElementById("commentInput").value = "";
            modal.showModal();
            list.innerHTML = "<p style='text-align:center; padding:20px;'><i class='fa-solid fa-spinner fa-spin'></i> Memuat...</p>";

            try {
                const comments = await contract.getComments(index);
                list.innerHTML = "";
                if(comments.length === 0) { 
                    list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Belum ada komentar.</p>"; 
                    return; 
                }
                for (const c of comments) {
                    let nick = c.commenter.substring(0,6) + "..."; 
                    let avt = "https://via.placeholder.com/30";   
                    if (commentProfileCache[c.commenter]) {
                        nick = commentProfileCache[c.commenter].nick;
                        avt = commentProfileCache[c.commenter].avt;
                    } else {
                        try { 
                            const p = await contract.getProfile(c.commenter);
                            if(p.nickname) nick = p.nickname;
                            if(p.fotoProfil) avt = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                            commentProfileCache[c.commenter] = { nick, avt };
                        } catch(e){}
                    }
                    // Buat Link Profil
                const profileUrl = `profile.html?addr=${c.commenter}`;

                const html = `
                    <div class="comment-item" style="border-bottom:1px solid #eee; padding:10px; display:flex; gap:10px; align-items: flex-start;">
                        
                        <a href="${profileUrl}" style="text-decoration:none;">
                            <img src="${avt}" style="width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid #eee;">
                        </a>

                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:13px;">
                                <a href="${profileUrl}" style="text-decoration:none; color:#2c3e50;">
                                    ${nick}
                                </a>
                            </div>
                            <div style="font-size:10px; color:#999; margin-top:3px;">${new Date(c.timestamp * 1000).toLocaleString()}</div>
                            <div style="font-size:13px; color:#333; line-height:1.4;">${formatCaption(c.text)}</div>
                        </div>
                    </div>`;
                    
                    list.innerHTML += html;
                }
            } catch(e) { console.error(e); }
        }

        async function submitComment() {
        const index = document.getElementById("commentPostId").value; // Index array (mulai dari 0)
        const text = document.getElementById("commentInput").value;
        if(!text) return;
        
        try {
            showToast("Mengirim...", "info");
            const tx = await contract.addComment(index, text, "");
            await tx.wait();
            
            showToast("Terkirim!", "success");
            document.getElementById("commentInput").value = "";
            
            // --- UPDATE ANGKA OTOMATIS (BARU) ---
            // Post ID biasanya index + 1
            const postId = parseInt(index) + 1; 
            const countSpan = document.getElementById(`count-comment-${postId}`);
            
            if(countSpan) {
                // Ambil angka lama, tambah 1
                const currentCount = parseInt(countSpan.innerText);
                countSpan.innerText = currentCount + 1;
            }
            
            // Reload list komentar di modal
            openComments(postId);
            
        } catch(e) { showToast("Gagal: " + e.message, "error"); }
    }

    // Fungsi untuk mengubah Enter jadi Spasi Bawah & Link jadi Biru
    function formatCaption(text) {
            if (!text) return "";
            let clean = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            clean = clean.replace(urlRegex, (url) => `<a href="${url}" target="_blank" style="color:#7385a5; font-weight:bold; text-decoration:none;">${url}</a>`);
            return clean.replace(/\n/g, "<br>");
        }

        // 1. Mengatur Tampilan Ikon (Merah/Hijau/Teks)
function updateWalletUI(address) {
    const shortAddr = address.substring(0, 6) + "..." + address.substring(address.length - 4);
    // UI HP
    const navBtn = document.getElementById("navWalletBtn");
    if(navBtn) {
        navBtn.style.color = "#2ecc71"; // Jadi Hijau kalau konek
    }

    // UI PC Sidebar
    const sideText = document.getElementById("sidebarWalletText");
    const sideInd = document.getElementById("walletIndicator");
    if(sideText) sideText.innerText = shortAddr;
    if(sideInd) sideInd.style.color = "#2ecc71"; // Titik Hijau
    // Isi Text Popup
    document.getElementById("popupAddressText").innerText = address;
}

// 2. Handle Klik Tombol Wallet
function handleWalletClick() {
    if (isWalletConnected) {
        // Jika sudah konek -> Buka Popup Info
        document.getElementById("walletPopupOverlay").style.display = "flex";
    } else {
        // Jika belum konek -> Jalankan Manual Connect (Fungsi Robust yg lama)
        manualConnect();
    }
}

// 3. Tutup Popup
function closeWalletPopup() {
    document.getElementById("walletPopupOverlay").style.display = "none";
}

// 4. Salin Alamat
function copyAddress() {
    const text = document.getElementById("popupAddressText").innerText;
    navigator.clipboard.writeText(text).then(() => {
        alert("Alamat disalin!");
    });
}

// 5. Fungsi Diskonek (Logout)
function performDisconnect() {
    if(confirm("Yakin ingin memutuskan koneksi?")) {
        localStorage.removeItem("putramas_session");
        window.location.replace("index.html");
    }
    }
        // --- FIX DUMMY WIDGETS ---
async function renderWidgets() {
    const tW = document.getElementById("trendingWidget");
    const rW = document.getElementById("recomWidget");
    if(tW) tW.innerHTML = "<div style='font-size:11px; color:#999; padding:10px;'>Fitur Segera Hadir</div>";
    if(rW) rW.innerHTML = "<div style='font-size:11px; color:#999; padding:10px;'>Fitur Segera Hadir</div>";
                                             }
        async function renderWidgets() {
        // --- TRENDING & REKOMENDASI (Widget Kanan) ---
        async function getTrendingPosts() { /* Kode algoritma trending sama seperti sebelumnya */ }
        async function getWhoToFollow() { /* Kode algoritma rekomendasi sama seperti sebelumnya */ }
        async function renderWidgets() {
            // Panggil fungsi widget di sini
            // (Untuk menghemat tempat, silakan gunakan fungsi getWhoToFollow yang sudah saya berikan di respon sebelumnya)
            // ...
        }
        }
    </script>
</body>
    </html>
