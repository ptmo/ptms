<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; gap: 10px; }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .comment-content { flex: 1; font-size: 13px; }
        .comment-author { font-weight: bold; font-size: 12px; color: #7385a5; }
        .comment-time { font-size: 10px; color: #999; }
        
        .post-image { cursor: zoom-in; transition: opacity 0.2s; }
        .post-image:hover { opacity: 0.9; }

        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        #commentModal[open] { display: flex; flex-direction: column; }

        /* Badge Notifikasi */
        .menu-item { position: relative; }
        .nav-badge {
            background-color: #e74c3c; color: white;
            font-size: 10px; font-weight: bold;
            min-width: 18px; height: 18px; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            position: absolute; border: 2px solid #fff; z-index: 10;
        }
        .mobile-nav .nav-badge { top: 0px; right: 25%; }
        .sidebar-left .nav-badge { top: 8px; right: 10px; }

        /* Responsive Layout (Grid) - DIPERBARUI: 2 Kolom (Sidebar Kiri + Feed Lebar) */
        .layout-wrapper { 
            display: grid; 
            /* Ubah jadi 2 kolom: Kiri (300px) dan Kanan (Sisa/Flexible) */
            grid-template-columns: 300px 1fr; 
            gap: 25px; 
            max-width: 1200px; 
            margin: 20px auto;
            padding: 0 15px;
        }

        @media (max-width: 900px) {
            .layout-wrapper { grid-template-columns: 1fr !important; }
            .sidebar-left { display: none !important; } /* Sidebar kanan sudah dihapus */
        }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item">
                    <i class="fa-solid fa-bell"></i> Notifikasi
                    <span class="nav-badge" id="badgeSidebar">0</span> 
                </a>
                <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                <a href="#" onclick="disconnect()" class="menu-item" style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</a>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin: 0 0 10px; font-size: 14px; color: #7385a5;">Status Wallet</h4>
                <div style="font-size: 12px; word-break: break-all; color: #666;" id="walletDisplay">Loading...</div>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin-top:0; color:#7385a5;">üî• Sedang Populer</h4>
                <div id="trendingWidget">
                    <p style="font-size:12px; color:#999;">Memuat...</p>
                </div>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin-top:0; color:#7385a5;">‚ú® Siapa yang diikuti</h4>
                <div id="recomWidget">
                    <p style="font-size:12px; color:#999;">Mencari...</p>
                </div>
            </div>
        </div>

        <div class="main-feed">
    
            <div class="card" style="padding: 7px 15px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; position: sticky; top: 10px; z-index: 99; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                <i class="fa-solid fa-magnifying-glass" style="color: #999;"></i>
                <input type="text" id="searchInput" onkeyup="handleSearch()" class="cp-input" placeholder="Pencarian..." style="border: none; background: transparent; flex: 1; outline: none;">
                <button onclick="clearSearch()" id="btnClearSearch" style="background: none; border: none; cursor: pointer; color: #999; display: none;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee;">
                <div id="tabGlobal" onclick="switchFeed('global')" 
                     style="flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #8b4513; border-bottom: 3px solid #8b4513;">
                     <i class="fa-solid fa-earth-asia"></i> Jelajah
                </div>
                <div id="tabFriends" onclick="switchFeed('friends')" 
                     style="flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #999; border-bottom: 3px solid transparent;">
                     <i class="fa-solid fa-user-group"></i> Mengikuti
                </div>
            </div>

            <div class="card create-post-box" style="margin-bottom: 20px;">
                <div class="cp-header">
                    <img src="https://via.placeholder.com/40" class="user-avatar" id="myAvatar">
                    <textarea id="mainCaption" class="cp-input" placeholder="Ceritakan wayang ini"></textarea>
                </div>

                <div id="nftReadyIndicator" style="display:none; background:#f0fff4; border:1px solid #48bb78; padding:10px; margin:10px 15px; border-radius:8px; font-size:12px; color:#2f855a;">
                    <i class="fa-solid fa-check-circle"></i> 
                    <strong>Data Arsip Siap!</strong> <span id="nftFilenamePreview"></span>
                    <button onclick="cancelNft()" style="float:right; background:none; border:none; color:#c53030; cursor:pointer;">Batal</button>
                </div>

                <div class="cp-actions">
                    <button onclick="openNftModal()" class="btn-upload" style="background:none; border:none; cursor:pointer; color:#8b4513; font-weight:bold; display:flex; align-items:center; gap:5px;">
                        <i class="fa-solid fa-scroll"></i> Arsipkan Wayang
                    </button>
                    <span style="font-size:10px; color:#999; margin-right:auto; margin-left:5px;">(0.0001 ETH)</span>

                    <button id="btnPost" class="btn-primary" onclick="submitPost()">Posting</button>
                </div>
            </div>

            <div id="feedContainer">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat Blockchain...
                </div>
            </div>
        </div>

        </div>

    <dialog id="ratingModal" style="border:none; border-radius:15px; padding:20px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
        <h3 style="margin-top:0; text-align:center; color:#7385a5;">Beri Rating</h3>
        <div style="display:flex; gap:10px; font-size:30px; justify-content:center; cursor:pointer; margin:20px 0;">
            <span onclick="setRate(1)">‚≠ê</span><span onclick="setRate(2)">‚≠ê</span><span onclick="setRate(3)">‚≠ê</span><span onclick="setRate(4)">‚≠ê</span><span onclick="setRate(5)">‚≠ê</span>
        </div>
        <input type="hidden" id="targetPostId">
        <button onclick="submitRating()" class="btn-primary" style="width:100%">Kirim</button>
        <button onclick="document.getElementById('ratingModal').close()" style="width:100%; background:none; border:none; color:#666; margin-top:10px; cursor:pointer;">Batal</button>
    </dialog>

    <dialog id="commentModal" style="border:none; border-radius:15px; padding:0; box-shadow:0 0 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; height: 70vh;">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; color:#7385a5;">Komentar</h3>
            <span onclick="document.getElementById('commentModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        <div id="commentList" style="flex: 1; overflow-y: auto; padding: 15px;">
            <p style="text-align:center; color:#999;">Memuat komentar...</p>
        </div>
        <div style="padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; display: flex; gap: 10px;">
            <input type="text" id="commentInput" class="cp-input" style="height: 40px;" placeholder="Tulis komentar...">
            <input type="hidden" id="commentPostId">
            <button onclick="submitComment()" class="btn-primary" style="padding: 0 20px;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </dialog>

    <dialog id="nftModal" style="border:none; border-radius:10px; padding:20px; width:95%; max-width:500px; box-shadow:0 0 50px rgba(0,0,0,0.5); margin:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; color:#8b4513;"><i class="fa-solid fa-scroll"></i> Arsip Wayang (NFT)</h3>
            <span onclick="document.getElementById('nftModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>

        <div style="overflow-y:auto; max-height:60vh; padding-right:5px;">
            <div style="margin-bottom: 15px;">
                <label style="font-size:12px; font-weight:bold; color:#8b4513;">Nama Tokoh Wayang <span style="color:red">*</span></label>
                <input type="text" id="mName" class="cp-input" style="width:100%; font-size:14px; font-weight:bold;" placeholder="Contoh: Raden Arjuna">
            </div>

            <div style="background:#fffaf0; padding:15px; border-radius:8px; text-align:center; border:2px dashed #d4af37; margin-bottom:15px;">
                <label for="modalFileInput" style="cursor:pointer; display:block;">
                    <i class="fa-solid fa-camera" style="font-size:24px; color:#8b4513;"></i><br>
                    <span style="font-size:12px; color:#666;">Klik untuk Pilih Foto Fisik Wayang</span>
                </label>
                <input type="file" id="modalFileInput" style="display:none;" onchange="previewInModal(this)">
                <div id="modalFilePreview" style="font-size:11px; color:#27ae60; margin-top:5px; font-weight:bold;"></div>
            </div>

            <label style="font-size:12px; font-weight:bold; color:#555;">Detail Atribut Wayang</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div>
                    <label style="font-size:10px; color:#999;">Golongan</label>
                    <select id="mGolongan" class="cp-input" style="width:100%; height:38px;">
                        <option value="" disabled selected>-- Pilih --</option>
                        <option value="Dewa">Dewa</option>
                        <option value="Punggawa">Punggawa</option>
                        <option value="Satria">Satria</option>
                        <option value="Putri">Putri</option>
                        <option value="Resi">Resi</option>
                        <option value="Punakawan">Punakawan</option>
                        <option value="Raksasa">Raksasa</option>
                        <option value="Wanara">Wanara</option>
                        <option value="Hewan">Hewan</option>
                        <option value="Pusaka">Pusaka</option>
                        <option value="Krodan">Krodan</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:10px; color:#999;">Gaya (Gagrak)</label>
                    <select id="mGaya" class="cp-input" style="width:100%; height:38px;">
                        <option value="" disabled selected>-- Pilih --</option>
                        <option value="Surakarta">Surakarta</option>
                        <option value="Yogyakarta">Yogyakarta</option>
                        <option value="Kedu">Kedu</option>
                        <option value="Banyumasan">Banyumasan</option>
                        <option value="Jawa Timuran">Jawa Timuran</option>
                        <option value="Cirebon">Cirebon</option>
                        <option value="Golek Sunda">Golek Sunda</option>
                        <option value="Bali">Bali</option>
                        <option value="Sasak">Sasak (Lombok)</option>
                        <option value="Palembang">Palembang</option>
                        <option value="Banjar">Banjar</option>
                        <option value="Kontemporer">Kontemporer</option>
                    </select>
                </div>
                <input type="text" id="mBahan" class="cp-input" placeholder="Bahan (Cth: Kulit Kerbau)">
                <input type="text" id="mGapit" class="cp-input" placeholder="Gapit (Cth: Tanduk)">
                <input type="text" id="mPenatah" class="cp-input" placeholder="Penatah (Opsional)">
                <input type="text" id="mPenyungging" class="cp-input" placeholder="Penyungging (Opsional)">
                <input type="text" id="mTahun" class="cp-input" placeholder="Tahun (Cth: 1980)">
                <input type="text" id="mKolektor" class="cp-input" placeholder="Kolektor Saat Ini">
            </div>
        </div>

        <div style="margin-top:20px;">
            <button onclick="saveNftDraft()" class="btn-primary" style="width:100%; background:#8b4513; border:none; padding:12px; font-weight:bold;">
                <i class="fa-solid fa-save"></i> Simpan Data Arsip
            </button>
        </div>
    </dialog>

    <dialog id="sawerModal" style="border:none; padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        <h3 style="margin-top:0; text-align:center;">üéÅ Sawer Kreator</h3>
        <input type="number" id="sawerAmount" class="cp-input" placeholder="0.0001" style="width:100%; margin-bottom:10px;">
        <small style="display:block; text-align:center; margin-bottom:10px;">Min: 0.00002 ETH</small>
        <input type="hidden" id="sawerPostId">
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('sawerModal').close()" style="flex:1; padding:10px; cursor:pointer;">Batal</button>
            <button onclick="submitSawer()" style="flex:1; background:#27ae60; color:white; border:none; padding:10px; cursor:pointer;">Kirim</button>
        </div>
    </dialog>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i></a>
        <a href="notifications.html" class="menu-item" style="flex-direction: column; gap: 2px; font-size: 10px;">
            <i class="fa-solid fa-bell" style="font-size: 18px;"></i>
            <span class="nav-badge" id="badgeMobile">0</span> 
        </a>
        <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i></a>
    </div>

    <div id="toast"></div>

    <script src="main.js"></script>
    <script src="ipfs_helper.js"></script>

    <script>
        const profileCache = {};
        const commentProfileCache = {};
        
        // ABI BARU (PASTE ABI LENGKAP DARI REMIX DI SINI ATAU DI MAIN.JS)
        
        // --- SCRIPT SAWWER (WAJIB ADA) ---
        function openSawerModal(id) {
            document.getElementById("sawerPostId").value = id;
            document.getElementById("sawerModal").showModal();
        }
        
        async function submitSawer() {
            const amount = document.getElementById("sawerAmount").value;
            const postId = document.getElementById("sawerPostId").value;
            if(!amount) return;
            try {
                document.getElementById("sawerModal").close();
                showToast("Mengirim Saweran...", "info");
                // postId di blockchain = index array (jadi id - 1)
                const tx = await contract.sawerPost(postId - 1, { value: ethers.utils.parseEther(amount) });
                await tx.wait();
                showToast("Terima kasih sudah menyawer! üéÅ", "success");
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }

        // --- SCRIPT FOLLOW ---
        async function followUser(targetAddr) {
            try {
                showToast("Memproses Follow...", "info");
                const tx = await contract.followUser(targetAddr);
                await tx.wait();
                showToast("Berhasil Mengikuti!", "success");
                renderWidgets(); // Refresh widget
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }

        // --- LOAD AWAL ---
        window.onload = async () => {
            await initApp(); 
            if(userAddress) {
                // Pastikan ABI dan Contract Address sudah benar di main.js
                // Render elemen UI
                document.getElementById("walletDisplay").innerText = userAddress;
                loadMyProfile();
                loadFeed();
                renderWidgets();
            }
        };

        // --- FUNGSI LOAD PROFILE HEADER ---
        async function loadMyProfile() {
            try {
                const p = await contract.getProfile(userAddress);
                if(p.fotoProfil) {
                    const cleanUrl = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    document.getElementById("myAvatar").src = cleanUrl;
                }
            } catch(e) {}
        }
        
        // --- FUNGSI LOAD FEED ---
        async function loadFeed() {
            try {
                const posts = await contract.getAllPosts();
                const container = document.getElementById("feedContainer");
                container.innerHTML = "";

                if(posts.length === 0) {
                    container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Belum ada postingan.</p>";
                    return;
                }

                [...posts].reverse().forEach(post => {
                    let imgHtml = "";
                    if(post.imageURI && post.imageURI.length > 5) {
                        const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');          
                        const optUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=600&q=80&output=webp`; 
                        
                        // Link ke Koleksi
                        imgHtml = `
                        <div style="margin-top:10px; margin-bottom:10px;">
                            <a href="koleksi.html?id=${post.id}">
                                <img src="${optUrl}" class="post-image" loading="lazy" style="width:100%; border-radius:8px; display:block; min-height:200px; background:#f0f0f0;">
                            </a>
                        </div>`;
                    }

                    const avgRating = post.ratingCount > 0 ? (post.totalRatingScore / post.ratingCount).toFixed(1) : "0.0";
                    const profileLink = `profile.html?addr=${post.author}`;
                    
                    // Badge NFT
                    const nftBadge = post.nftId > 0 ? `<span style="background:#d4af37; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">NFT #${post.nftId}</span>` : "";

                    const html = `
                    <div class="card" id="post-${post.id}" style="padding: 15px; margin-bottom: 20px;">
                        <div class="post-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <a href="${profileLink}">
                                <img src="https://via.placeholder.com/40" class="user-avatar author-avatar-${post.author}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee;">
                            </a>
                            <div class="post-info">
                                <a href="${profileLink}" class="author-nick-${post.author}" 
                                   style="text-decoration: none; color: #333; font-weight: bold; font-size: 14px;">
                                    ${post.author.substring(0,6)}...
                                </a>
                                <div style="font-size: 11px; color: #999;">
                                    ${new Date(post.timestamp * 1000).toLocaleString()} ${nftBadge}
                                </div>
                            </div>
                        </div>

                        <div class="post-caption" style="margin-bottom:10px; font-size:14px; line-height:1.5;">${post.caption}</div>
                        ${imgHtml}

                        <div class="post-actions" style="border-top:1px solid #eee; padding-top:10px; margin-top:5px; display:flex; justify-content:space-around; align-items:center;">
                             <button class="action-btn" onclick="handleLike(${post.id})" style="background:none; border:none; cursor:pointer; color:#666; display:flex; gap:5px; align-items:center;">
                                <i class="fa-regular fa-heart" id="icon-like-${post.id}"></i> 
                                <span id="count-like-${post.id}">${post.likeCount}</span>
                             </button>
                             <button class="action-btn" onclick="openComments(${post.id})" style="background:none; border:none; cursor:pointer; color:#666; display:flex; gap:5px; align-items:center;">
                                <i class="fa-regular fa-comment"></i> ${post.commentCount}
                             </button>
                             <button class="action-btn" onclick="openSawerModal(${post.id})" style="background:none; border:none; cursor:pointer; color:#666;" title="Sawer">
                                <i class="fa-solid fa-gift"></i>
                             </button>
                             <button class="action-btn" onclick="openRating(${post.id})" style="background:none; border:none; cursor:pointer; color:666; display:flex; gap:5px; align-items:center;">
                                <i class="fa-solid fa-star"></i> ${avgRating}
                             </button>
                        </div>
                    </div>`;
                    
                    container.innerHTML += html;
                    fetchProfileLazy(post.author);
                });
            } catch (e) { console.error(e); }
        }

        async function fetchProfileLazy(address) {
            if(profileCache[address]) {
                updatePostAuthorUI(address, profileCache[address]);
                return;
            }
            try {
                const p = await contract.getProfile(address);
                const data = {
                    nickname: p.nickname,
                    avatar: p.fotoProfil ? p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : 'https://via.placeholder.com/40'
                };
                profileCache[address] = data;
                updatePostAuthorUI(address, data);
            } catch (e) {}
        }

        function updatePostAuthorUI(address, data) {
            document.querySelectorAll(`.author-avatar-${address}`).forEach(img => img.src = data.avatar);
            document.querySelectorAll(`.author-nick-${address}`).forEach(el => el.innerText = data.nickname);
        }

        // --- INTERAKSI LIKE & RATE ---
        async function handleLike(postId) {
            const countSpan = document.getElementById(`count-like-${postId}`);
            const icon = document.getElementById(`icon-like-${postId}`);
            const current = parseInt(countSpan.innerText);
            
            countSpan.innerText = current + 1;
            icon.classList.remove("fa-regular");
            icon.classList.add("fa-solid");
            icon.style.color = "#e74c3c";

            try {
                const tx = await contract.likePost(postId - 1);
                await tx.wait();
            } catch (e) {
                // Rollback jika gagal
                countSpan.innerText = current;
                icon.classList.add("fa-regular");
                icon.classList.remove("fa-solid");
                icon.style.color = "";
            }
        }

        let selectedRate = 0;
        function openRating(pid) { document.getElementById("targetPostId").value = pid; document.getElementById("ratingModal").showModal(); selectedRate=0; }
        function setRate(n) { selectedRate=n; showToast(`${n} Bintang`, "info"); }
        async function submitRating() {
            if(!selectedRate) return;
            try {
                document.getElementById("ratingModal").close();
                const tx = await contract.ratePost(document.getElementById("targetPostId").value - 1, selectedRate);
                await tx.wait();
                showToast("Rated!", "success");
            } catch(e) { showToast("Gagal", "error"); }
        }
        
        // --- SCRIPT KOMENTAR ---
        async function openComments(postId) {
            const index = postId - 1; 
            const modal = document.getElementById("commentModal");
            const list = document.getElementById("commentList");
            document.getElementById("commentPostId").value = index;
            document.getElementById("commentInput").value = "";
            modal.showModal();
            list.innerHTML = "<p style='text-align:center; padding:20px;'><i class='fa-solid fa-spinner fa-spin'></i> Memuat...</p>";

            try {
                const comments = await contract.getComments(index);
                list.innerHTML = "";
                if(comments.length === 0) { 
                    list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Belum ada komentar.</p>"; 
                    return; 
                }
                for (const c of comments) {
                    let nick = c.commenter.substring(0,6) + "..."; 
                    let avt = "https://via.placeholder.com/30";   
                    if (commentProfileCache[c.commenter]) {
                        nick = commentProfileCache[c.commenter].nick;
                        avt = commentProfileCache[c.commenter].avt;
                    } else {
                        try { 
                            const p = await contract.getProfile(c.commenter);
                            if(p.nickname) nick = p.nickname;
                            if(p.fotoProfil) avt = p.fotoProfil.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                            commentProfileCache[c.commenter] = { nick, avt };
                        } catch(e){}
                    }
                    const html = `
                    <div class="comment-item" style="border-bottom:1px solid #eee; padding:10px; display:flex; gap:10px; align-items: flex-start;">
                        <img src="${avt}" style="width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid #eee;">
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:13px; color:#2c3e50;">${nick}</div>
                            <div style="font-size:13px; color:#333;">${c.text}</div>
                            <div style="font-size:10px; color:#999; margin-top:3px;">${new Date(c.timestamp * 1000).toLocaleString()}</div>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                }
            } catch(e) { console.error(e); }
        }

        async function submitComment() {
            const index = document.getElementById("commentPostId").value;
            const text = document.getElementById("commentInput").value;
            if(!text) return;
            try {
                showToast("Mengirim...", "info");
                const tx = await contract.addComment(index, text, "");
                await tx.wait();
                showToast("Terkirim!", "success");
                document.getElementById("commentInput").value = "";
                openComments(parseInt(index) + 1);
            } catch(e) { showToast("Gagal: " + e.message, "error"); }
        }

        // --- TRENDING & REKOMENDASI (Widget Kanan) ---
        async function getTrendingPosts() { /* Kode algoritma trending sama seperti sebelumnya */ }
        async function getWhoToFollow() { /* Kode algoritma rekomendasi sama seperti sebelumnya */ }
        async function renderWidgets() {
            // Panggil fungsi widget di sini
            // (Untuk menghemat tempat, silakan gunakan fungsi getWhoToFollow yang sudah saya berikan di respon sebelumnya)
            // ...
        }
    </script>
</body>
    </html>
