<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda - Putramas Social Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* --- CSS UTAMA (GAYA SOSMED PREMIUM) --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f0f2f5; /* Warna background khas FB/Twitter */
            margin: 0; padding: 0;
            padding-bottom: 80px; /* Spacer untuk menu bawah */
            color: #1c1e21;
        }

        /* NAVBAR ATAS */
        .top-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 1000;
            padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .brand { font-size: 18px; font-weight: 800; color: #7385a5; display: flex; align-items: center; gap: 8px; }
        .brand img { width: 30px; height: 30px; border-radius: 50%; }
        
        .btn-connect {
            background: #e4e6eb; color: #050505; border: none;
            padding: 8px 15px; border-radius: 20px; font-weight: 600; font-size: 13px;
            cursor: pointer; transition: 0.2s;
        }
        .btn-connect.connected { background: #e7f3ff; color: #1877f2; }

        /* CONTAINER UTAMA */
        .feed-container { max-width: 600px; margin: 0 auto; padding: 10px; }

        /* --- 1. FITUR UPLOAD INSTAN (DROPDOWN) --- */
        .upload-trigger {
            background: #fff; padding: 15px; border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; gap: 10px; align-items: center; cursor: pointer;
            transition: background 0.2s;
        }
        .upload-trigger:active { background: #f2f2f2; }
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; object-fit: cover; }
        .fake-input {
            flex: 1; background: #f0f2f5; padding: 10px 15px; border-radius: 20px;
            color: #65676b; font-size: 14px;
        }
        
        /* FORM UPLOAD (TERSEMBUNYI) */
        .upload-form-box {
            max-height: 0; overflow: hidden; opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 10px;
        }
        .upload-form-box.open { max-height: 600px; opacity: 1; margin-bottom: 20px; }
        
        .form-card {
            background: #fff; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;
        }
        .preview-box {
            width: 100%; height: 180px; background: #fafafa; border: 2px dashed #ccc;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; overflow: hidden; position: relative; cursor: pointer;
        }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .input-group { margin-bottom: 10px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .btn-post {
            width: 100%; background: #7385a5; color: #fff; padding: 12px;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .btn-post:disabled { background: #ccc; cursor: not-allowed; }

        /* --- 2. CARD FEED (TAMPILAN WAYANG) --- */
        .feed-card {
            background: #fff; border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 15px; overflow: hidden;
            animation: fadeIn 0.5s ease;
        }
        .card-header {
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-pic { width: 32px; height: 32px; border-radius: 50%; background: #eee; }
        .user-name { font-weight: 600; font-size: 14px; color: #050505; }
        .post-time { font-size: 11px; color: #65676b; }
        
        .card-image {
            width: 100%; min-height: 300px; background: #f0f2f5;
            display: flex; align-items: center; justify-content: center;
        }
        .card-image img { width: 100%; height: auto; display: block; }
        
        .card-content { padding: 12px 15px; }
        .wayang-title { font-size: 16px; font-weight: bold; margin: 0 0 5px 0; color: #1c1e21; }
        .wayang-desc { font-size: 13px; color: #65676b; margin-bottom: 10px; }
        .tag-badge { 
            background: #e7f3ff; color: #1877f2; padding: 3px 8px; 
            border-radius: 4px; font-size: 11px; font-weight: 600; 
        }

        .card-actions {
            padding: 8px 15px; border-top: 1px solid #f0f2f5;
            display: flex; justify-content: space-between;
        }
        .action-btn {
            background: none; border: none; color: #65676b;
            font-size: 13px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; padding: 6px 0;
        }
        .action-btn:hover { color: #7385a5; }

        /* --- 3. NAVIGASI BAWAH (FACEBOOK STYLE) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: #fff; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 5000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-link {
            display: flex; flex-direction: column; align-items: center;
            text-decoration: none; color: #65676b; font-size: 10px; width: 25%;
        }
        .nav-link i { font-size: 22px; margin-bottom: 4px; transition: 0.2s; }
        .nav-link.active { color: #1877f2; }
        .nav-link.active i { transform: scale(1.1); }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Official Badge */
        .verified-badge { color: #1877f2; font-size: 12px; margin-left: 4px; }
        .verified-gold { color: #f1c40f; font-size: 12px; margin-left: 4px; }
    </style>
</head>
<body>

    <nav class="top-navbar">
        <div class="brand">
            <img src="img/icon-192.png" alt="Logo">
            Putramas Feed
        </div>
        <button class="btn-connect" id="btnConnect" onclick="connectWallet()">
            <i class="fas fa-wallet"></i> Konek Wallet
        </button>
    </nav>

    <div class="feed-container">
        
        <div class="upload-trigger" onclick="toggleForm()">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="my-avatar">
            <div class="fake-input">Apa wayang terbaru Anda? Upload di sini...</div>
            <i class="fas fa-images" style="color: #45bd62; font-size: 20px;"></i>
        </div>

        <div class="upload-form-box" id="uploadBox">
            <div class="form-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0;">Post Wayang</h3>
                    <button onclick="toggleForm()" style="background:none; border:none; cursor:pointer;"><i class="fas fa-times"></i></button>
                </div>

                <div class="preview-box" onclick="document.getElementById('fileUpload').click()">
                    <img id="imgPreview">
                    <div id="textPreview" style="text-align:center; color:#aaa;">
                        <i class="fas fa-cloud-upload-alt" style="font-size:24px;"></i><br>
                        Klik pilih foto
                    </div>
                </div>
                <input type="file" id="fileUpload" hidden onchange="previewImage()">

                <div class="input-group">
                    <input type="text" id="inputNama" class="form-input" placeholder="Nama Wayang (Wajib)">
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="inputGol" class="form-input">
                        <option value="Satria">Satria</option>
                        <option value="Dewa">Dewa</option>
                        <option value="Yaksa">Yaksa</option>
                        <option value="Punakawan">Punakawan</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                    <select id="inputGaya" class="form-input">
                        <option value="Surakarta">Surakarta</option>
                        <option value="Yogyakarta">Yogyakarta</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>

                <button class="btn-post" id="btnSubmit" onclick="uploadWayang()">
                    <i class="fas fa-paper-plane"></i> Posting Sekarang
                </button>
            </div>
        </div>

        <div id="feedContent">
            <div style="text-align:center; padding:40px; color:#aaa;">
                <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>
                Memuat riwayat wayang...
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <a href="beranda.html" class="nav-link active">
            <i class="fas fa-home"></i>
            <span>Beranda</span>
        </a>
        
        <a href="index.html" class="nav-link">
            <i class="fas fa-crown"></i>
            <span>Official</span>
        </a>

        <a href="index.html" class="nav-link">
            <i class="fas fa-globe-asia"></i>
            <span>Global</span>
        </a>

        <button class="nav-link" onclick="window.scrollTo(0,0); toggleForm();">
            <i class="fas fa-plus-circle" style="color: #7385a5; font-size: 24px;"></i>
            <span>Upload</span>
        </button>
    </nav>

    <script>
        const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58"; 
        const OFFICIAL_WALLET = "0xBAcc1F6e717bF03dB0c40E3044DA47318C369B70";
        // ABI Minimal untuk Read Data + Upload
        const ABI = [
            "function getInfoWayang(uint256 tokenId) view returns (tuple(string nama, string golongan, string gaya, uint256 timestamp, bool isActive, bool isOfficial, address creator))",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function totalLikes(uint256 tokenId) view returns (uint256)",
            "function uploadPublik(string _tokenURI, string _nama, string _golongan, string _gaya) payable",
            "function publicMintFee() view returns (uint256)",
            "function getIdsByGolongan(string golongan) view returns (uint256[])"
        ];
        
        const PINATA_GATEWAY = "https://magenta-secondary-guan-686.mypinata.cloud/ipfs/";
        let provider, contractReader, signer;

        // --- INIT ---
        window.onload = async () => {
            // Setup Read Provider (Tanpa Wallet)
            const rpc = new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");
            contractReader = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpc);
            
            // Cek Login
            if(window.ethereum) {
                const web3 = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await web3.listAccounts();
                if(accounts.length > 0) {
                    document.getElementById("btnConnect").innerHTML = "Terhubung";
                    document.getElementById("btnConnect").classList.add("connected");
                }
            }

            // Load Feed
            loadFeed();
        };

        async function connectWallet() {
            if(!window.ethereum) return alert("Pasang Metamask!");
            const web3 = new ethers.providers.Web3Provider(window.ethereum);
            await web3.send("eth_requestAccounts", []);
            location.reload();
        }

        // --- LOGIKA FEED (GABUNGAN SEMUA DATA) ---
        async function loadFeed() {
            const container = document.getElementById("feedContent");
            const golongans = ['Satria', 'Dewa', 'Yaksa', 'Wanara', 'Panakawan', 'Kayon', 'Bambangan', 'Punggawa', 'Krodan', 'Resi', 'Putren', 'Buta Kiwe', 'Sato', 'Gaman'];

            try {
                // 1. Tarik semua ID dari semua golongan (Parallel Fetch)
                const promises = golongans.map(gol => contractReader.getIdsByGolongan(gol));
                const results = await Promise.all(promises);
                
                // 2. Gabungkan & Sortir (Terbesar = Terbaru)
                let allIds = results.flat().map(id => parseInt(id));
                allIds = [...new Set(allIds)].sort((a, b) => b - a); // Hapus duplikat & Sort Descending

                // 3. Ambil 20 Terbaru (Pagination sederhana)
                const feedIds = allIds.slice(0, 20);

                if(feedIds.length === 0) {
                    container.innerHTML = "<p style='text-align:center;'>Belum ada postingan.</p>";
                    return;
                }

                container.innerHTML = ""; // Bersihkan loading

                // 4. Render Kartu
                for(let id of feedIds) {
                    await renderCard(id, container);
                }

            } catch(e) {
                console.error(e);
                container.innerHTML = "<p style='color:red; text-align:center;'>Gagal memuat feed.</p>";
            }
        }

        async function renderCard(id, container) {
            try {
                const [info, uri, owner, likes] = await Promise.all([
                    contractReader.getInfoWayang(id),
                    contractReader.tokenURI(id),
                    contractReader.ownerOf(id),
                    contractReader.totalLikes(id)
                ]);

                if(!info.isActive) return;

                // Proses Gambar & Metadata
                let imgUrl = "img/loading.gif";
                try {
                    const jsonUrl = uri.replace("ipfs://", PINATA_GATEWAY);
                    const res = await axios.get(jsonUrl);
                    const rawImg = res.data.image || res.data.image_url;
                    imgUrl = rawImg.replace("ipfs://", PINATA_GATEWAY);
                    // Pakai Weserv biar cepat
                    imgUrl = `https://wsrv.nl/?url=${encodeURIComponent(imgUrl)}&w=500&q=75&output=webp`;
                } catch(e) {}

                // Cek Official
                const isOfficial = (owner.toLowerCase() === OFFICIAL_WALLET.toLowerCase());
                const badge = isOfficial 
                    ? `<i class="fas fa-check-circle verified-gold" title="Official"></i>` 
                    : `<i class="fas fa-check-circle verified-badge" title="Verified Creator"></i>`;
                
                const senderName = isOfficial ? "Putramas Official" : owner.substring(0,6) + "..." + owner.slice(-4);
                const avatar = `https://api.dicebear.com/7.x/identicon/svg?seed=${owner}`;

                // Template HTML Kartu
                const html = `
                <div class="feed-card">
                    <div class="card-header">
                        <div class="user-info">
                            <img src="${avatar}" class="user-pic">
                            <div>
                                <div class="user-name">${senderName} ${badge}</div>
                                <div class="post-time">${new Date(info.timestamp * 1000).toLocaleDateString()} â€¢ ID #${id}</div>
                            </div>
                        </div>
                        <i class="fas fa-ellipsis-h" style="color:#ccc;"></i>
                    </div>
                    
                    <div class="card-content">
                        <h3 class="wayang-title">${info.nama}</h3>
                        <div class="wayang-desc">
                            Wayang golongan <span class="tag-badge">${info.golongan}</span> 
                            gaya <span class="tag-badge">${info.gaya}</span>
                        </div>
                    </div>

                    <div class="card-image" onclick="window.location.href='detail?id=${id}'" style="cursor:pointer;">
                        <img src="${imgUrl}" loading="lazy">
                    </div>

                    <div class="card-actions">
                        <button class="action-btn"><i class="far fa-heart"></i> ${likes} Suka</button>
                        <button class="action-btn" onclick="window.location.href='detail?id=${id}'"><i class="far fa-comment"></i> Ulasan</button>
                        <button class="action-btn"><i class="fas fa-share"></i> Bagikan</button>
                    </div>
                </div>`;

                container.insertAdjacentHTML('beforeend', html);

            } catch(e) { console.log("Skip error id", id); }
        }

        // --- LOGIKA UPLOAD INSTAN ---
        function toggleForm() {
            document.getElementById("uploadBox").classList.toggle("open");
        }

        function previewImage() {
            const file = document.getElementById("fileUpload").files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById("imgPreview").src = e.target.result;
                document.getElementById("imgPreview").style.display = "block";
                document.getElementById("textPreview").style.display = "none";
            }
            reader.readAsDataURL(file);
        }

        async function uploadWayang() {
            // (Anda perlu memasukkan fungsi helper compressImage, uploadIPFS, uploadJSON di sini atau load dari file external)
            // Untuk demo ini, saya alert saja karena fungsinya panjang
            if(!window.ethereum) return alert("Wajib konek wallet!");
            alert("Fitur upload akan memanggil Metamask. (Silakan copy fungsi uploadHelper dari index.html ke sini)");
        }
    </script>
</body>
                                                                   </html>
