<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Putramas Analytics | Real-Time On-Chain Data</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- STYLE PREMIUM SOFT (Putramas DNA) --- */
        :root {
            --primary: #7385a5;
            --primary-dark: #5c6a84;
            --secondary: #a6b4cd;
            --bg-body: #f6f9ff;
            --text-dark: #2c3e50;
            --text-grey: #7f8c8d;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow-soft: 0 10px 30px rgba(115, 133, 165, 0.12);
            --shadow-hover: 0 15px 40px rgba(115, 133, 165, 0.20);
            --radius: 20px;
        }

        * { box-sizing: border-box; outline: none; }

        body { 
            font-family: 'Rubik', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-dark); 
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

        /* Header */
        .header-section { margin-bottom: 50px; text-align: center; }
        .page-title { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 10px; }
        .page-subtitle { color: var(--text-grey); font-size: 14px; letter-spacing: 0.5px; }
        
        .btn-connect {
            background: var(--primary); color: #fff; border: none; padding: 14px 35px;
            border-radius: 50px; font-weight: 700; cursor: pointer; margin-top: 25px;
            box-shadow: 0 5px 15px rgba(115, 133, 165, 0.3); transition: 0.3s;
            display: inline-flex; align-items: center; gap: 10px;
        }
        .btn-connect:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(115, 133, 165, 0.4); }
        .btn-connect.connected { background: #27ae60; cursor: default; }

        /* Card System */
        .card-panel {
            background: var(--white); border-radius: var(--radius); padding: 25px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: var(--shadow-soft); position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        .card-panel:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: var(--secondary); }

        .section-label {
            font-size: 12px; font-weight: 800; color: var(--primary); 
            text-transform: uppercase; letter-spacing: 1.5px; margin: 50px 0 20px 0;
            display: flex; align-items: center; gap: 15px;
        }
        .section-label::after { content: ''; flex: 1; height: 2px; background: rgba(115,133,165,0.1); border-radius: 2px; }

        /* 1. General Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; }
        .stat-item { display: flex; align-items: center; gap: 20px; }
        .stat-icon {
            width: 60px; height: 60px; border-radius: 18px; background: #f0f4fa;
            color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: inset 0 0 10px rgba(115,133,165,0.1);
        }
        .stat-info h4 { margin: 0; font-size: 11px; color: var(--text-grey); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-info h2 { margin: 5px 0 0 0; font-size: 26px; font-weight: 800; color: var(--text-dark); }

        /* 2. Charts Area */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media(max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: center; }
        .chart-title { font-weight: 700; color: var(--text-dark); font-size: 16px; }

        /* 3. Tables */
        .table-responsive { overflow-x: auto; }
        .premium-table { width: 100%; border-collapse: collapse; }
        .premium-table th { text-align: left; font-size: 10px; color: var(--text-grey); padding: 12px; text-transform: uppercase; border-bottom: 2px solid #f0f4fa; }
        .premium-table td { padding: 15px 12px; font-size: 13px; color: var(--text-dark); border-bottom: 1px dashed #eee; }
        .address-badge { background: #eaf2ff; padding: 5px 10px; border-radius: 8px; font-family: monospace; color: var(--primary); font-size: 12px; font-weight: 600; }

        /* 5. Tipping Leaderboard */
        .leaderboard-list { display: flex; flex-direction: column; gap: 10px; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fbfcfd; border-radius: 12px; border: 1px solid transparent; }
        .leaderboard-item:hover { border-color: var(--secondary); background: #fff; }
        .rank-badge { width: 28px; height: 28px; background: var(--primary); color: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; margin-right: 10px; }
        .rank-1 { background: linear-gradient(135deg, #f1c40f, #f39c12); box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4); }
        .rank-2 { background: #bdc3c7; }
        .rank-3 { background: #cd7f32; }

        /* Loader */
        .skeleton { animation: pulse 1.5s infinite; background: #eee; color: transparent; border-radius: 4px; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 0.8; } 100% { opacity: 0.5; } }

    </style>
</head>
<body>

<div class="container">
    
    <div class="header-section">
        <h1 class="page-title">Putramas Analytics</h1>
        <p class="page-subtitle">Dashboard Transparansi & Statistik Smart Contract</p>
        <button id="btnConnect" class="btn-connect" onclick="connectAndLoad()">
            <i class="fas fa-wallet"></i> Hubungkan Wallet (Base)
        </button>
    </div>

    <div class="section-label"><i class="fas fa-cube"></i> 1. Statistik Kontrak & Ekonomi</div>
    <div class="stats-grid">
        <div class="card-panel stat-item">
            <div class="stat-icon"><i class="fas fa-scroll"></i></div>
            <div class="stat-info">
                <h4>Total Wayang (Supply)</h4>
                <h2 id="val-supply" class="skeleton">0</h2>
            </div>
        </div>
        <div class="card-panel stat-item">
            <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
            <div class="stat-info">
                <h4>Biaya Minting</h4>
                <h2 id="val-fee" class="skeleton">0 ETH</h2>
            </div>
        </div>
        <div class="card-panel stat-item">
            <div class="stat-icon"><i class="fab fa-ethereum"></i></div>
            <div class="stat-info">
                <h4>Total Apresiasi (Tips)</h4>
                <h2 id="val-totalTips" class="skeleton">0 ETH</h2>
            </div>
        </div>
        <div class="card-panel stat-item">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-info">
                <h4>Partisipasi Owner</h4>
                <h2 id="val-owners" class="skeleton">-</h2>
            </div>
        </div>
    </div>

    <div class="section-label"><i class="fas fa-chart-pie"></i> 2. Analisis Budaya (Golongan & Gaya)</div>
    <div class="charts-grid">
        <div class="card-panel">
            <div class="chart-header">
                <div class="chart-title">Distribusi Golongan Wayang</div>
            </div>
            <div style="height: 250px; position: relative;">
                <canvas id="chartGolongan"></canvas>
            </div>
        </div>
        <div class="card-panel">
            <div class="chart-header">
                <div class="chart-title">Distribusi Gaya Seni</div>
            </div>
            <div style="height: 250px; position: relative;">
                <canvas id="chartGaya"></canvas>
            </div>
        </div>
    </div>

    <div class="section-label"><i class="fas fa-crown"></i> 3. Leaderboard Patron & Aktivitas</div>
    <div class="charts-grid" style="grid-template-columns: 1fr 1.5fr;">
        
        <div class="card-panel">
            <div class="chart-header">
                <div class="chart-title">Top Patron (Pemberi Tips)</div>
                <small style="color:var(--text-grey);">Based on 'TipSent' Event</small>
            </div>
            <div id="tipping-list" class="leaderboard-list">
                <div style="text-align:center; padding:20px; color:#aaa;">Menunggu Data...</div>
            </div>
        </div>

        <div class="card-panel">
            <div class="chart-header">
                <div class="chart-title">Aktivitas Jaringan Terkini</div>
            </div>
            <div class="table-responsive">
                <table class="premium-table">
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Dari / Kreator</th>
                            <th>Detail</th>
                            <th>Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="activity-table">
                        <tr><td colspan="4" style="text-align:center;">Memuat Event Blockchain...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="section-label"><i class="fas fa-chart-line"></i> 6. Tren Waktu (Minting)</div>
    <div class="card-panel">
        <div style="height: 250px; position: relative;">
            <canvas id="chartTren"></canvas>
        </div>
    </div>

    <div class="section-label"><i class="fas fa-lightbulb"></i> 7. Analisis Lanjutan</div>
    <div class="stats-grid">
        <div class="card-panel">
            <div class="chart-title" style="margin-bottom:10px; font-size:14px;">Kontribusi Official</div>
            <h2 id="val-official-ratio" style="color:var(--primary);">...%</h2>
            <small style="color:#7f8c8d;">Rasio wayang buatan Dalang vs Komunitas.</small>
        </div>
        <div class="card-panel">
            <div class="chart-title" style="margin-bottom:10px; font-size:14px;">Review Engagement</div>
            <h2 id="val-review-count" style="color:#e67e22;">...</h2>
            <small style="color:#7f8c8d;">Total ulasan yang diberikan user.</small>
        </div>
        <div class="card-panel">
            <div class="chart-title" style="margin-bottom:10px; font-size:14px;">Rata-rata Tip</div>
            <h2 id="val-avg-tip" style="color:#27ae60;">... ETH</h2>
            <small style="color:#7f8c8d;">Nilai tengah apresiasi per transaksi.</small>
        </div>
    </div>

    <div style="text-align:center; margin-top:50px; color:#bdc3c7; font-size:11px;">
        Powered by Putramas Official Smart Contract â€¢ Data Live from Base Chain
    </div>

</div>

<script>
    // --- 1. KONFIGURASI KONTRAK & CONSTANTS ---
    // GANTI DENGAN ALAMAT KONTRAK DEPLOY ANDA
    const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58"; 

    // ABI LENGKAP sesuai kode Solidity Anda (untuk Read & Events)
    const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"RevisionFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"TipSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[],"name":"MAX_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramas.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTipByIndex","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"message","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.TipRecord","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTipCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getTipTotalBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiWayang","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"revisionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_receiver","type":"address"},{"internalType":"string","name":"_message","type":"string"}],"name":"sendTip","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setRevisionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTipsGrand","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];

    // Data dari Form HTML Anda (untuk Loop)
    const listGolongan = ["Satria", "Dewa", "Yaksa", "Wanara", "Panakawan", "Kayon", "Bambangan", "Punggawa", "Krodan", "Resi", "Putren", "Buta Kiwe", "Sato", "Gaman"];
    const listGaya = ["Bali", "Banjar", "Banyumas", "Cirebon", "Golek Sunda", "Jawa Timur", "Kedu", "Kontemporer", "Kreasi", "Lombok", "Surakarta", "Yogyakarta", "Lainnya"];

    let provider, contract, signer;

    // --- 2. FUNGSI UTAMA ---

    // --- KONFIGURASI NETWORK (BASE MAINNET) ---
    // Gunakan 0x14a33 untuk Base Sepolia (Testnet) jika belum live
    const BASE_CHAIN_ID_HEX = "0x2105"; // Hex untuk 8453 (Base Mainnet)
    const BASE_CHAIN_ID_DEC = 8453;

    // --- 2. FUNGSI UTAMA YANG DIPERBAIKI ---
    async function connectAndLoad() {
        // 1. Cek apakah MetaMask/Wallet ada
        if (!window.ethereum) {
            alert("Wallet tidak ditemukan! Harap install MetaMask/Coinbase Wallet.");
            return;
        }
        
        const btn = document.getElementById("btnConnect");
        const originalText = btn.innerHTML; // Simpan teks asli tombol
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghubungkan...';
        btn.disabled = true; // Matikan tombol agar tidak diklik 2x

        try {
            // 2. Request Akses Akun
            await window.ethereum.request({ method: 'eth_requestAccounts' });

            // 3. Inisialisasi Provider Sementara untuk Cek Network
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const { chainId } = await provider.getNetwork();

            // 4. Logika Pindah Jaringan Otomatis (Auto-Switch)
            if (chainId !== BASE_CHAIN_ID_DEC) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID_HEX }],
                    });
                    // Refresh provider setelah ganti network
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } catch (switchError) {
                    // Error 4902 artinya Network belum ditambahkan di Wallet user
                    if (switchError.code === 4902) {
                        alert("Jaringan Base tidak ditemukan di Wallet Anda. Harap tambahkan secara manual.");
                    } else {
                        throw new Error("Gagal mengganti jaringan. Pastikan Anda menyetujui di Wallet.");
                    }
                }
            }

            // 5. Inisialisasi Signer & Kontrak (Setelah Network Benar)
            signer = provider.getSigner();
            const userAddress = await signer.getAddress();
            
            // Debugging: Cek apakah variabel global ada
            if (typeof CONTRACT_ADDRESS === 'undefined' || typeof ABI === 'undefined') {
                throw new Error("CONTRACT_ADDRESS atau ABI belum didefinisikan di script!");
            }

            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

            // 6. Update UI Sukses
            btn.innerHTML = `<i class="fas fa-check"></i> ${userAddress.substring(0,6)}...`;
            btn.classList.add('connected');
            btn.onclick = null; // Matikan fungsi klik setelah connect (opsional)

            // 7. Eksekusi Load Data
            // Pastikan fungsi-fungsi ini sudah ada di kode Anda sebelumnya
            await Promise.all([
                loadGeneralStats().catch(err => console.error("Error GeneralStats:", err)),
                loadDistribution().catch(err => console.error("Error Distribution:", err)),
                loadEventBasedStats().catch(err => console.error("Error Events:", err))
            ]);

        } catch (err) {
            console.error("Koneksi Error:", err);
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Gagal';
            alert(`Terjadi kesalahan: ${err.message}`);
            
            // Kembalikan tombol ke kondisi semula setelah 3 detik
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        }
    }

    // --- 3. LOAD STATISTIK UMUM ---
    async function loadGeneralStats() {
        // A. Total Supply (Looping Golongan karena tidak ada variable totalSupply public)
        let totalCount = 0;
        let golonganCounts = []; // Untuk Chart

        for (let gol of listGolongan) {
            try {
                const ids = await contract.getIdsByGolongan(gol);
                totalCount += ids.length;
                golonganCounts.push(ids.length);
            } catch (e) {
                golonganCounts.push(0);
            }
        }
        
        // Update UI Supply
        document.getElementById("val-supply").innerText = totalCount;
        document.getElementById("val-supply").classList.remove("skeleton");

        // B. Fees & Tips
        const fee = await contract.publicMintFee();
        const tips = await contract.totalTipsGrand();
        
        document.getElementById("val-fee").innerText = ethers.utils.formatEther(fee) + " ETH";
        document.getElementById("val-totalTips").innerText = ethers.utils.formatEther(tips) + " ETH";
        
        [document.getElementById("val-fee"), document.getElementById("val-totalTips")].forEach(el => el.classList.remove("skeleton"));

        // Render Chart Golongan
        renderPieChart("chartGolongan", listGolongan, golonganCounts);
    }

    // --- 4. LOAD DISTRIBUSI & GAYA ---
    async function loadDistribution() {
        // Karena tidak ada mapping(gaya => ids), kita harus scan Event WayangLahir
        // atau scan wayangRegistry satu per satu (berat). 
        // Solusi Efisien: Scan Event 'WayangLahir' (Official vs Public ada disana)
        
        // Ambil event dari Block 0 (atau block deploy) sampai sekarang
        const filter = contract.filters.WayangLahir(); 
        const events = await contract.queryFilter(filter); // Ini bisa berat jika transaksi ribuan, di prod gunakan indexer.

        let gayaStats = {};
        listGaya.forEach(g => gayaStats[g] = 0);
        
        let officialCount = 0;
        let publicCount = 0;

        // Kita perlu data 'Gaya' yg ada di wayangRegistry, tapi event tidak emit 'Gaya' di versi ke-1.
        // Di kode anda ada 2 definisi event WayangLahir. Asumsi smart contract emit yg lengkap.
        // Jika tidak, kita sampling data terbaru dari wayangRegistry.
        
        // Sampling 50 Wayang Terakhir untuk Analisis Gaya (Supaya tidak timeout)
        const sampleSize = events.length > 50 ? 50 : events.length;
        const recentIds = events.slice(-sampleSize).map(e => e.args.id);

        for (let id of recentIds) {
            const data = await contract.wayangRegistry(id);
            // data struct: nama, golongan, gaya, timestamp, active, official, creator
            const g = data[2]; // gaya
            const isOff = data[5]; // isOfficial
            
            if (gayaStats[g] !== undefined) gayaStats[g]++;
            else gayaStats["Lainnya"]++;

            if (isOff) officialCount++; else publicCount++;
        }

        renderBarChart("chartGaya", Object.keys(gayaStats), Object.values(gayaStats));
        
        // Insight: Official Ratio
        const totalSample = officialCount + publicCount;
        const ratio = totalSample > 0 ? ((officialCount / totalSample) * 100).toFixed(1) : 0;
        document.getElementById("val-official-ratio").innerText = ratio + "%";
    }

    // --- 5. LOAD EVENT BASED (Tipping, Trends, Reviews) ---
    async function loadEventBasedStats() {
        // A. Tipping Leaderboard & Review Count
        const tipFilter = contract.filters.TipSent();
        const reviewFilter = contract.filters.Reviewed();
        
        const [tipEvents, reviewEvents] = await Promise.all([
            contract.queryFilter(tipFilter),
            contract.queryFilter(reviewFilter)
        ]);

        // Hitung Leaderboard Tipping
        let tippingMap = {}; // address -> totalETH
        let totalTipVal = 0;

        tipEvents.forEach(ev => {
            const sender = ev.args.from;
            const amt = parseFloat(ethers.utils.formatEther(ev.args.amount));
            totalTipVal += amt;
            if(!tippingMap[sender]) tippingMap[sender] = 0;
            tippingMap[sender] += amt;
        });

        // Sort Top 3
        const sortedTippers = Object.entries(tippingMap)
            .sort(([,a],[,b]) => b - a)
            .slice(0, 5);

        // Render Leaderboard HTML
        const tipContainer = document.getElementById("tipping-list");
        tipContainer.innerHTML = "";
        
        sortedTippers.forEach((item, index) => {
            const addr = item[0].substring(0,6) + "..." + item[0].slice(-4);
            const val = item[1].toFixed(4);
            const rankClass = index < 3 ? `rank-${index+1}` : 'rank-2'; // fallback color
            
            const html = `
                <div class="leaderboard-item">
                    <div style="display:flex; align-items:center;">
                        <div class="rank-badge ${rankClass}">${index+1}</div>
                        <span class="address-badge">${addr}</span>
                    </div>
                    <div style="font-weight:bold; color:#27ae60;">${val} ETH</div>
                </div>`;
            tipContainer.innerHTML += html;
        });

        // Insight: Avg Tip & Reviews
        const avgTip = tipEvents.length > 0 ? (totalTipVal / tipEvents.length).toFixed(4) : "0";
        document.getElementById("val-avg-tip").innerText = avgTip + " ETH";
        document.getElementById("val-review-count").innerText = reviewEvents.length;

        // B. Recent Activity (Gabungan Minting & Tipping)
        const mintFilter = contract.filters.WayangLahir();
        const mintEvents = await contract.queryFilter(mintFilter);
        
        // Unique Owners (Est dari Creator Minting)
        const uniqueCreators = new Set(mintEvents.map(e => e.args.creator)).size;
        document.getElementById("val-owners").innerText = uniqueCreators;
        document.getElementById("val-owners").classList.remove("skeleton");

        // Merge Events untuk Tabel Aktivitas (Ambil 5 terakhir)
        // Note: Kita pakai mintEvents dan tipEvents yg sudah ada
        let allActivity = [];
        
        mintEvents.forEach(e => allActivity.push({
            type: "Minting", 
            who: e.args.creator, 
            detail: "Wayang #" + e.args.id, 
            block: e.blockNumber 
        }));
        
        tipEvents.forEach(e => allActivity.push({
            type: "Donasi", 
            who: e.args.from, 
            detail: ethers.utils.formatEther(e.args.amount) + " ETH", 
            block: e.blockNumber 
        }));

    allActivity.sort((a,b) => b.block - a.block); // Sort Descending
        const recent5 = allActivity.slice(0, 5);

        const tableBody = document.getElementById("activity-table");
        tableBody.innerHTML = "";
        
        recent5.forEach(act => {
            const badgeColor = act.type === "Minting" ? "#eaf2ff" : "#e8f8f5";
            const textColor = act.type === "Minting" ? "#7385a5" : "#27ae60";
            const icon = act.type === "Minting" ? '<i class="fas fa-cube"></i>' : '<i class="fas fa-coins"></i>';
            
            const row = `
                <tr>
                    <td><span style="color:${textColor}; font-weight:bold;">${icon} ${act.type}</span></td>
                    <td><span class="address-badge">${act.who.substring(0,6)}...</span></td>
                    <td>${act.detail}</td>
                    <td style="color:#aaa; font-size:11px;">Blk ${act.block}</td>
                </tr>`;
            tableBody.innerHTML += row;
        });

    const trendData = mintEvents.map((_, i) => i + 1); // 1, 2, 3... total
        const labels = mintEvents.map((_, i) => "E#" + (i+1)); // Event 1, Event 2...
        
        // Ambil 20 poin data terakhir supaya grafik tidak terlalu padat
        const limit = 20;
        const chartData = trendData.slice(-limit);
        const chartLabels = labels.slice(-limit);

        renderLineChart("chartTren", chartLabels, chartData);
    }

    function renderPieChart(id, labels, data) {
        new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#7385a5', '#889bbd', '#9db1d5', '#b2c7ed', '#c7ddff', '#5c6a84', '#a6b4cd'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function renderBarChart(id, labels, data) {
        new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jumlah Arsip',
                    data: data,
                    backgroundColor: '#7385a5',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    function renderLineChart(id, labels, data) {
        new Chart(document.getElementById(id), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pertumbuhan Arsip',
                    data: data,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { display: false }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });
    }
    </script>

</body>
</html>
