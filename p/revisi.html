<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisi Mandiri - Wayang Nusantara</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* BASE STYLE */
        * { box-sizing: border-box; }
    body { 
        font-family: 'Rubik', sans-serif; 
        background: #fff;
        padding: 0;
        margin: 0;
        color: #666; 
    }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: #f6f9ff;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .nav-left { display: flex; align-items: center; gap: 15px; }
        
        .nav-logo {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 2px solid #7385a5;
            object-fit: cover;
        }
        
        .container { 
        width: 95%;
        max-width: 800px; 
        margin: 40px auto;
        background: white; 
        padding: 40px; 
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        h1 { color: #d35400; margin-top: 0; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .sub-header { font-size: 14px; color: #888; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }

        /* FORM ELEMENTS */
        .id-box { background: #fff3e0; padding: 20px; border-radius: 8px; border: 1px solid #ffcc80; margin-bottom: 25px; }
        .id-box label { color: #e67e22; font-weight: 800; font-size: 14px; }
        .id-box input { border-color: #ffe0b2; font-size: 18px; font-weight: bold; color: #d35400; }
        
        fieldset { border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fff; }
        legend { font-weight: bold; color: #d35400; padding: 0 10px; }
        
        label { display: block; margin: 12px 0 5px; font-weight: 600; font-size: 13px; color: #666; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #d35400; outline: none; box-shadow: 0 0 5px rgba(211, 84, 0, 0.2); }

        /* BUTTONS */
        .btn-action { 
        background-color: transparent; color: #d35400; padding: 15px; 
        border: 2px solid #d35400; width: 50%; cursor: pointer; font-size: 12px; 
        border-radius: 25px; margin-top: 20px; font-weight: bold; 
        box-shadow: 0 4px 10px rgba(115, 133, 165, 0.28); align-items: center; margin-left: auto; margin-right: auto; display: block;
    }

.btn-action:hover {
    background-color: #d35400;
    color: #fff;
    border: 2px splid #943b00;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(115, 133, 165, 0.35);
}
        
        #btn-connect {
            background: transparent; color: #d35400; border: 2px solid #d35400; 
            padding: 10px 25px; cursor: pointer; font-family: 'Rubik', sans-serif; 
            font-weight: bold; border-radius: 30px; transition: 0.3s; font-size: 14px;
        }
        #btn-connect:hover { background: #f2ccb3; color: #d35400; border: 2px solid #d35400; }
        #btn-connect.connected { background: #d35400; color: #fff; border-color: #943b00; cursor: default; }
        
        /* STATUS & TOAST */
        .status { margin-top: 15px; padding: 15px; border-radius: 6px; font-size: 14px; text-align: center; display: none; }
        .status.loading { background: #fff3e0; color: #d35400; border: 1px solid #ffe0b2; }
        .status.success { background: #e8f5e9; color: #2ecc71; border: 1px solid #c8e6c9; }
        .status.error { background: #ffebee; color: #e74c3c; border: 1px solid #ffcdd2; }

        #toast { visibility: hidden; min-width: 250px; background: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-size: 13px; }
        #toast.show { visibility: visible; animation: fadein 0.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }

        @media (max-width: 600px) { .container { margin: 15px; padding: 20px; } .btn-connect { position: absolute; } }

        .footer {
            background: #f6f9ff;
            padding: 20px 20px;
            margin-top: 25px;
            text-align: center;
            width: 100%;
        }

        .social-icons { margin-bottom: 10px; }
        
        .social-link {
            display: inline-flex; justify-content: center; align-items: center;
            width: 35px; height: 35px; margin: 0 07px;
            border-radius: 50%; background: #7385a5; color: #fff;
            font-size: 15px; transition: all 0.3s ease; border: 1.5px solid #7385a5;
            text-decoration: none;
        }
        .social-link:hover {
            background: #fff; color: #7385a5;
            transform: translateY(-5px); box-shadow: 0 0 15px #7385a5;
        }

        .copyright { color: #888; font-size: 13px; letter-spacing: 1px; margin-top: 10px; }

        @media (max-width: 600px) {
            .navbar { padding: 15px 20px; }
            .nav-brand { font-size: 0.9em; }
            #btn-connect { padding: 8px 15px; font-size: 12px; }
            h1 { font-size: 2em; }
        }

        @media (max-width: 600px) {
        .container { margin: 20px auto; width: 95%; padding: 20px; }
        }

        .modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: transparent; /* Tidak ada warna/blur */
    backdrop-filter: none;
    z-index: 9998;
    display: none;
    /* Ubah dari flex ke block agar kita bisa atur posisi absolute manual */
    display: none; 
}

.modal-overlay.active {
    display: block; 
}

/* 2. Kartu Modal (Menjadi Dropdown) */
.modal-card {
    position: absolute; /* Kunci posisi */
    
    /* ATUR POSISI DISINI SESUAI TINGGI NAVBAR ANDA */
    top: 70px;  /* Jarak dari atas (sesuaikan dengan tinggi navbar) */
    right: 20px; /* Jarak dari kanan (supaya lurus dengan tombol connect) */
    
    width: 300px; /* Lebar fix agar rapi */
    background: #fff;
    padding: 20px;
    border-radius: 12px; /* Radius lebih kecil ala dropdown */
    
    /* Shadow Premium Soft */
    box-shadow: 0 5px 30px rgba(0,0,0,0.15); 
    border: 1px solid rgba(0,0,0,0.05); /* Border tipis halus */
    
    text-align: center;
    font-family: 'Rubik', sans-serif;
    
    /* Animasi Muncul dari atas */
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    transform-origin: top right; /* Animasi mulai dari pojok kanan atas */
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* State Aktif */
.modal-overlay.active .modal-card {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* (Opsional) Segitiga Kecil Penunjuk ke Atas (Arrow) */
.modal-card::before {
    content: "";
    position: absolute;
    top: -6px; /* Muncul di atas kotak */
    right: 20px; /* Posisi sejajar tombol */
    width: 12px;
    height: 12px;
    background: #fff;
    transform: rotate(45deg); /* Putar jadi wajik */
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
    box-shadow: -2px -2px 5px rgba(0,0,0,0.02);
}
    
/* Header */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.modal-header h3 { margin: 0; font-size: 18px; color: #333; }
.close-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }

/* Status Badge & Dot Kelap Kelip */
.modal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.status-badge {
    color: #27ae60;
    font-weight: bold;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-label { color: #888; }
    
.pulse-dot {
    width: 8px; height: 8px;
    background-color: #27ae60;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(39, 174, 96, 0.4);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(39, 174, 96, 0); }
    100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
}

/* Saldo */
.modal-balance { margin-bottom: 20px; }
.balance-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
.balance-amount { font-size: 24px; font-weight: bold; color: #2c3e50; margin-top: 5px; }

/* Address Box (Copyable) */
.modal-address-box {
    background: #f1f2f6;
    padding: 12px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    margin-bottom: 25px;
}
.modal-address-box:hover { border-color: #3498db; background: #eaf6ff; }
.address-text { font-family: monospace; font-size: 14px; color: #555; }
.copy-icon { color: #3498db; }

/* Tombol Aksi */
.modal-actions { display: flex; flex-direction: column; gap: 10px; }
.action-btn {
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    transition: transform 0.1s;
}
.action-btn:active { transform: scale(0.98); }
.action-btn.primary { background: #7385a5; color: white; }
.action-btn.danger { background: #fee; color: #e74c3c; border: 1px solid #fcc; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
  <a href="index" style="display: flex; align-items: center; text-decoration: none;">
    <img src="img/icon-192.png" class="nav-logo" style="margin-right:8px;">
    <span class="nav-brand" style="font-size:20px; color: #7385a5; font-weight:bold;">Putramas Official</span>
  </a>
        </div>
        <div class="nav-right">
        <button id="btn-connect" onclick="connectWallet()">
            <i class="fas fa-wallet"></i> Hubungkan
        </button>
    </div>
    </nav>

<div class="container">
    <h1><i class="fas fa-edit" style="font-size: 25px; color: #d35400; margin-right: 10px; vertical-align: middle;">></i> Revisi Metadata</h1>
    <p class="sub-header">Perbaiki data yang salah. Pastikan Anda menggunakan alamat yang sama.</p>

    <div class="id-box">
        <label><i class="fas fa-fingerprint"></i> ID WAYANG (Wajib Diisi):</label>
        <input type="number" id="editId" required>
        <small style="color:#d35400;">*Masukkan angka saja tanpa ID</small>
    </div>

    <fieldset>
        <legend>1. Data Utama (Baru)</legend>
        <label style="color: #d35400;">Perbarui Foto Wayang:</label>
        <input type="file" id="editGambar" required>
        <small style="color:#888;">*Jika foto tetap, upload foto yang sama.</small>
    
        <label style="color: #d35400;">Nama Tokoh:</label>
        <input type="text" id="editNama" placeholder="Tulis Nama yang benar...">
        
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;">
                <label>Golongan:</label>
                <select id="editGolongan">
                    <option value="Satria">Satria</option>
                    <option value="Dewa">Dewa</option>
                    <option value="Yaksa">Yaksa</option>
                    <option value="Wanara">Wanara</option>
                    <option value="Panakawan">Panakawan</option>
                    <option value="Kayon">Kayon</option>
                    <option value="Bambangan">Bambangan</option>
                    <option value="Punggawa">Punggawa</option>
                    <option value="Krodan">Krodan</option>
                    <option value="Resi">Resi</option>
                    <option value="Putren">Putren</option>
                    <option value="Buta Kiwe">Buta Kiwe</option>
                    <option value="Sato">Sato</option>
                    <option value="Gaman">Gaman</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>Gaya:</label>
                <select id="editGaya">
                    <option value="Yogyakarta">Yogyakarta</option>
                    <option value="Surakarta">Surakarta</option>
                    <option value="Cirebon">Cirebon</option>
                    <option value="Kedu">Kedu</option>
                    <option value="Banyumas">Banyumas</option>
                    <option value="Jawa Timur">Jawa Timur</option>
                    <option value="Jawa Barat">Golek Sunda</option>
                    <option value="Bali">Bali</option>
                    <option value="Banjar">Banjar</option>
                    <option value="Lombok">Lombok</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>2. Detail Fisik</legend>
        <label>Wanda:</label>
        <input type="text" id="editWanda">
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Material Kulit:</label><input type="text" id="editKulit"></div>
            <div style="flex:1"><label>Material Gapit:</label><input type="text" id="editGapit"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Penatah:</label><input type="text" id="editPenatah"></div>
            <div style="flex:1"><label>Penyungging:</label><input type="text" id="editPenyungging"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Tahun:</label><input type="text" id="editTahun"></div>
            <div style="flex:1"><label>Kolektor:</label><input type="text" id="editKolektor"></div>
        </div>
    </fieldset>

    <fieldset>
        <legend>3. Silsilah</legend>
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;"><label>Ayah:</label><input type="text" id="editAyah"></div>
            <div style="flex: 1;"><label>Ibu:</label><input type="text" id="editIbu"></div>
        </div>
        <label>Negara/Tempat:</label>
        <input type="text" id="editNegara">
        <label>Pusaka:</label>
        <input type="text" id="editPusaka">
    </fieldset>

    <fieldset>
        <legend>4. Media</legend>
        <label>Deskripsi:</label>
        <textarea id="editDeskripsi" rows="3"></textarea>
        </fieldset>

    <center><button class="btn-action" onclick="revisiWayang()">
        <i class="fas fa-sync-alt"></i> UPDATE DATA
    </button></center>
    
    <div id="statusRevisi" class="status"></div>
</div>

    <div id="walletModal" class="modal-overlay" onclick="closeWalletModal(event)">
    <div class="modal-card">
        
        <div class="modal-header">
            <h3><i class="fas fa-wallet" style="color:#7385a5;"></i> Wallet Info</h3>
            <button class="close-btn" onclick="toggleWalletModal()"><i class="fas fa-times"></i></button>
        </div>

        <div class="modal-status">
            <span class="status-label">Status</span>
            <div class="status-badge">
                <span class="pulse-dot"></span> Terhubung
            </div>
        </div>

        <div class="modal-balance">
            <div class="balance-label">Total Saldo</div>
            <div class="balance-amount" id="modalBalance">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        </div>

        <div class="modal-address-box" onclick="copyAddress()">
            <div class="address-text">
                <span id="modalFullAddress" style="display:none;"></span> <span id="modalShortAddress">0x...</span>
            </div>
            <i class="far fa-copy copy-icon"></i>
        </div>

        <div class="modal-actions">
            <button class="action-btn primary" onclick="window.location.href='/profile'">
                <i class="fas fa-user-circle"></i> Buka Profil Saya
            </button>
            
            <button class="action-btn danger" onclick="disconnectWallet()">
                <i class="fas fa-sign-out-alt"></i> Putuskan Koneksi
            </button>
        </div>
        
    </div>
    </div>

<div id="toast"></div>

    <footer class="footer">
        <div class="footer-content">
            <div class="social-icons">
                <a href="https://youtube.com/@PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-youtube"></i></a>
                <a href="https://instagram.com/putramas_official" target="_blank" class="social-link"><i class="fab fa-instagram"></i></a>
                <a href="https://facebook.com/PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-facebook-f"></i></a>
                <a href="https://facebook.com/PutramasOfficialStudio" target="_blank" class="social-link"><i class="fab fa-facebook-f"></i></a>
            </div>
            <p class="copyright">
                &copy; <span id="year"></span> Powered By <strong>Putramas Official</strong>
            </p>
        </div>
    </footer>

<script>
    // --- KONFIGURASI ---
    const CONTRACT_ADDRESS = "0xE6A51b5D204e1bA45e2d607ee53eba3D7E70Bc69"; 
    const PINATA_API_KEY = "9e761468bc54ff406e32";
    const PINATA_SECRET_KEY = "56cc032751b13afe3deb04ee30a341fbeb54b119649a45a1c4c6b1df8e58a780";
    
    // ABI (Hanya fungsi yang dibutuhkan)
    const CONTRACT_ABI = [
        "function revisiWayang(uint256 _id, string _namaBaru, string _uriBaru) public payable",
        "function revisionFee() view returns (uint256)"
    ];

    const BASE_SEPOLIA_ID = '0x14a34'; 

    // 2. KONFIGURASI RPC (Untuk Auto-Add)
    const BASE_SEPOLIA_CONFIG = {
        chainId: BASE_SEPOLIA_ID, 
        chainName: 'Base Sepolia',
        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
        rpcUrls: ['https://sepolia.base.org'],
        blockExplorerUrls: ['https://sepolia.basescan.org']
    };

    let provider, signer, userAddress;
    let toastTimeout;

    // --- FUNGSI GANTI NETWORK (Tadi hilang ini) ---
    async function switchNetwork() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: BASE_SEPOLIA_CONFIG.chainId }],
            });
        } catch (error) {
            // Error 4902 artinya chain belum ditambahkan di wallet
            if (error.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [BASE_SEPOLIA_CONFIG],
                    });
                } catch (addError) {
                    console.error("Gagal menambahkan network:", addError);
                    showToast("Gagal menambahkan network Base Sepolia otomatis.", 'error');
                }
            } else {
                console.error("Gagal ganti network:", error);
                showToast("Gagal berpindah network.", 'error');
            }
        }
    }
    

    // --- 1. CONNECT WALLET ---
    async function connectWallet() {
        const btn = document.getElementById("btn-connect");

        // Jika sudah connect, klik tombol membuka Modal Info
        if (btn.classList.contains("connected")) {
            toggleWalletModal();
            return;
        }

        // Cek Metamask
        if (!window.ethereum) return showToast("Install Metamask Dulu!", 'wolf');

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            
            // Cek & Switch Network Otomatis
            const network = await provider.getNetwork();
            
            // Menggunakan parseInt(hex, 16) untuk mencocokkan ID
            if (network.chainId !== parseInt(BASE_SEPOLIA_ID, 16)) {
                await switchNetwork();
                // Refresh provider setelah ganti network
                provider = new ethers.providers.Web3Provider(window.ethereum);
            }

            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            // Update UI Tombol
            btn.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
            btn.classList.add("connected");

            // Isi Data ke Modal
            if(document.getElementById("modalFullAddress")) {
                document.getElementById("modalFullAddress").innerText = userAddress;
                document.getElementById("modalShortAddress").innerText = userAddress.substring(0, 10) + "..." + userAddress.substring(35);

                const balance = await provider.getBalance(userAddress);
                const ethBalance = ethers.utils.formatEther(balance);
                document.getElementById("modalBalance").innerText = parseFloat(ethBalance).toFixed(4) + " ETH";
            }

            showToast("Dompet Terhubung!", 'success');

        } catch (err) { 
            console.error(err); 
            showToast("Batal / Gagal koneksi.", 'error'); 
        }
    }

    function toggleWalletModal() {
        const modal = document.getElementById("walletModal");
        if (modal.classList.contains("active")) {
            modal.classList.remove("active");
            setTimeout(() => modal.style.display = "none", 200);
        } else {
            modal.style.display = "block";
            setTimeout(() => modal.classList.add("active"), 10);
        }
    }

    function closeWalletModal(e) {
        if (e.target.id === "walletModal") toggleWalletModal();
    }

    function copyAddress() {
        const addr = document.getElementById("modalFullAddress").innerText;
        if(!addr) return;
        navigator.clipboard.writeText(addr).then(() => {
            showToast("Alamat Wallet disalin!", 'success');
        });
    }

    function disconnectWallet() {
        userAddress = null;
        signer = null;
        
        const btn = document.getElementById("btn-connect");
        btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
        btn.classList.remove("connected");
        
        toggleWalletModal();
        
        setTimeout(() => window.location.reload(), 500);
    }

    // --- 2. LOGIKA REVISI ---
    async function revisiWayang() {
        const statusEl = document.getElementById("statusRevisi");
        statusEl.style.display = 'block';
        
        // Ambil Value
        const id = document.getElementById("editId").value;
        const fileInput = document.getElementById("editGambar");
        const nama = document.getElementById("editNama").value;
        const deskripsiAsli = document.getElementById("editDeskripsi").value;

        // Validasi
        if (!userAddress) return showToast("Hubungkan dompet dulu!", 'warning');
        if (!id || !nama || !fileInput.files[0]) {
            return showToast("ID, Nama, dan Foto wajib diisi!", 'error');
        }

        try {
            statusEl.className = "status loading";
            const loadIcon = `<i class="fas fa-circle-notch fa-spin"></i>`;

            // A. KOMPRESI GAMBAR
            statusEl.innerHTML = `${loadIcon} 1/4 Memproses Gambar...`;
            const compressedFile = await compressImage(fileInput.files[0], 300);

            // B. UPLOAD IPFS
            statusEl.innerHTML = `${loadIcon} 2/4 Sedang Mengupload...`;
            const imgUrl = await uploadToIPFS(compressedFile);

            // C. BUAT METADATA BARU (Format Konsisten dengan Upload Public)
            statusEl.innerHTML = `${loadIcon} 3/4 Menyusun Data Baru...`;
            
            const metadata = {
                name: nama,
                description: deskripsiAsli, // Deskripsi Bersih
                image: imgUrl,
                attributes: [
                    { trait_type: "Golongan", value: document.getElementById("editGolongan").value },
                    { trait_type: "Gaya", value: document.getElementById("editGaya").value },
                    { trait_type: "Wanda", value: getVal("editWanda") },
                    { trait_type: "Material Kulit", value: getVal("editKulit") },
                    { trait_type: "Material Gapit", value: getVal("editGapit") },
                    { trait_type: "Penatah", value: getVal("editPenatah") },
                    { trait_type: "Penyungging", value: getVal("editPenyungging") },
                    { trait_type: "Tahun Pembuatan", value: getVal("editTahun") },
                    { trait_type: "Kolektor", value: getVal("editKolektor") },
                    { trait_type: "Ayah", value: getVal("editAyah") },
                    { trait_type: "Ibu", value: getVal("editIbu") },
                    { trait_type: "Negara", value: getVal("editNegara") },
                    { trait_type: "Pusaka", value: getVal("editPusaka") },
                    { trait_type: "Creator", value: userAddress },
                    { trait_type: "Status", value: "Revised" }
                ]
            };

            const tokenURI = await uploadJSON(metadata);

            // D. TRANSAKSI BLOCKCHAIN
            statusEl.innerHTML = `${loadIcon} 4/4 Konfirmasi Wallet...`;
            
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            // Cek Fee Revisi
            const fee = await contract.revisionFee(); // Panggil fungsi fee revisi
            
            // Eksekusi
            const tx = await contract.revisiWayang(id, nama, tokenURI, { value: fee });
            
            statusEl.innerHTML = `${loadIcon} Menunggu Konfirmasi...`;
            await tx.wait();

            // FINISH
            statusEl.className = "status success";
            statusEl.innerHTML = `âœ… REVISI BERHASIL!<br>Data ID #${id} telah diperbarui.<br><a href="detail?id=${id}" target="_blank">Lihat Hasil</a>`;
            showToast("Sukses!", 'success');

        } catch (err) {
            console.error(err);
            let msg = err.reason || err.message;
            if(msg.includes("bukan pemilik")) msg = "Gagal: Anda bukan pemilik wayang ini!";
            statusEl.className = "status error";
            statusEl.innerText = msg;
        }
    }

    // --- HELPER ---
    function getVal(id) { return document.getElementById(id).value || "-"; }

    async function uploadToIPFS(file) {
        let data = new FormData(); data.append('file', file);
        const res = await axios.post(`https://api.pinata.cloud/pinning/pinFileToIPFS`, data, {
            headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY, "Content-Type": "multipart/form-data"}
        });
        return `https://gateway.pinata.cloud/ipfs/${res.data.IpfsHash}`;
    }

    async function uploadJSON(json) {
        const res = await axios.post(`https://api.pinata.cloud/pinning/pinJSONToIPFS`, json, {
            headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY}
        });
        return `ipfs://${res.data.IpfsHash}`;
    }

    async function compressImage(file, maxSizeKB) {
        if (file.size <= maxSizeKB * 1024) return file;
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const MAX = 1000;
                    if(w>MAX){ h*=MAX/w; w=MAX; }
                    canvas.width=w; canvas.height=h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img,0,0,w,h);
                    canvas.toBlob(blob => resolve(new File([blob], file.name, {type:'image/jpeg', lastModified:Date.now()})), 'image/jpeg', 0.8);
                };
            };
        });
    }

    function showToast(msg, type) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = `show ${type}`;
        if(toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => x.className = "", 3000);
    }

    // --- AUTO-FILL ID DARI URL ---
window.onload = function() {
    // Cek apakah ada parameter ?id=... di URL
    const urlParams = new URLSearchParams(window.location.search);
    const idParam = urlParams.get('id');

    if (idParam) {
        // Isi kolom ID otomatis
        document.getElementById("editId").value = idParam;
        
        // Opsional: Langsung scroll ke form
        document.querySelector(".container").scrollIntoView({ behavior: 'smooth' });
    }
    
    // Coba connect wallet otomatis jika user sebelumnya sudah connect
    if(window.ethereum && window.ethereum.selectedAddress) {
        connectWallet();
    }
};
document.getElementById("year").innerText = new Date().getFullYear();
</script>

</body>
  </html>
