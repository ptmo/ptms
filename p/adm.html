<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
* {
    box-sizing: border-box; 
}

body { 
    font-family: 'Segoe UI', sans-serif; 
    background: #fff; 
    padding: 20px; 
    color: #666; 
    margin: 0;
}

.container { 
    width: 100%; 
    max-width: 900px; 
    margin: 0 auto; 
    background: #fff; 
    padding: 30px; 
    border-radius: 8px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    border: 1px solid #7385a5; 
}

@media (max-width: 480px) {
    body {
        padding: 10px;
    }
    .container {
        padding: 20px;
    }
}
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        h1 { color: #7385a5; margin: 0; font-size: 24px; }
        
        #btn-connect {
            background: #7385a5; color: white; border: 2px solid #a6b4cd; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold;
        }
        #btn-connect.connected { background: #87f57a; border: 2px solid #4cd93b; cursor: default; }

        label { font-weight: bold; font-size: 14px; display: block; margin-top: 15px; color: #666; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        fieldset { border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 15px; background: #fafafa; }
        legend { font-weight: bold; color: #7385a5; padding: 0 5px; }
        
        .btn-action { background-color: #7385a5; color: white; padding: 15px; border: 2px solid #a6b4cd; width: 50%; cursor: pointer; font-size: 16px; border-radius: 15px; margin-top: 20px; transition: 0.3s; font-weight: bold; display: block; margin: 0 auto; }
        .btn-action:hover { background-color: #a6b4cd; color: white; border: 2px solid #7385a5; }
        .btn-action:disabled { background-color: #ccc; cursor: not-allowed; }

        .status { margin-top: 15px; text-align: center; font-weight: bold; padding: 10px; border-radius: 5px; }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; } 
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .loading { color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; }

#toast {
    visibility: hidden;
    min-width: 220px;
    max-width: 85%;
    position: fixed;
    z-index: 99999;
    top: 90px;
    right: 20px;
    left: auto;
    background-color: rgba(51, 51, 51, 0.95);
    backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    padding: 10px 35px 10px 15px; 
    display: flex;
    align-items: center;
    font-family: 'Rubik', sans-serif;
    font-weight: 500;
    font-size: 11px;
    letter-spacing: 0.3px;
    opacity: 0;
    transform: translateX(20px) scale(0.9); 
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0.4s; 
}

#toast.show {
    visibility: visible;
    opacity: 1;
    transform: translateX(0) scale(1);
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0s;
}
    
#toast .toast-icon {
    width: 23px;
    height: 23px; 
    margin-right: 10px; 
    object-fit: contain;
}

#toast .toast-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 9px;
    height: 9px;
    cursor: pointer;
    opacity: 0.6;
    transition: 0.2s;
}

        #toast .toast-close:hover { opacity: 1; transform: scale(1.1); }

    #toast.info {
    background: rgba(0, 53, 107, 0.35);
    border: 1px solid rgba(0, 100, 204, 0.4);
    color: #fff;
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0, 100, 255, 0.25);
}

#toast.success {
    background: rgba(0, 77, 7, 0.35);
    color: #fff;
    border: 1px solid rgba(0, 184, 15, 0.4);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0,255,0,0.2);
}

#toast.error {
    background: rgba(107, 0, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(184, 0, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 22px rgba(255,0,0,0.25);
    }

#toast.warning {
    background: rgba(102, 98, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(179, 171, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 20px rgba(255,255,0,0.25);
}

#toast.wolf {
    background: rgba(125, 65, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(204, 106, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(255,140,0,0.25);
}

#toast.load {
    background: rgba(49, 77, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(104, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(0,255,0,0.25);
}
    
#toast.loading {
    background: rgba(52, 90, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(94, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(94, 163, 0, 0.25);
}

@keyframes slideDown {
    from {top: -50px; opacity: 0;}
    to {top: 30px; opacity: 1;}
}

@keyframes fadeOut {
    from {top: 30px; opacity: 1;}
    to {top: -50px; opacity: 0;}
}
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Studio Arsip</h1>
        <button id="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </div>
    
    <fieldset>
        <legend>1. Identitas Utama</legend>
        <label>Nama Tokoh:</label>
        <input type="text" id="inputNama" placeholder="Contoh: Arjuna">
        
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;">
                <label>Golongan:</label>
                <select id="inputGolongan">
                    <option value="Satria">Satria</option>
                    <option value="Dewa">Dewa</option>
                    <option value="Yaksa">Yaksa</option>
                    <option value="Wanara">Wanara</option>
                    <option value="Panakawan">Panakawan</option>
                    <option value="Kayon">Kayon</option>
                    <option value="Bambangan">Bambangan</option>
                    <option value="Punggawa">Punggawa</option>
                    <option value="Krodan">Krodan</option>
                    <option value="Resi">Resi</option>
                    <option value="Putren">Putren</option>
                    <option value="Buta Kiwe">Buta Kiwe</option>
                    <option value="Sato">Sato</option>
                    <option value="Gaman">Gaman</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>Gaya:</label>
                <select id="inputGaya">
                    <option value="Yogyakarta">Yogyakarta</option>
                    <option value="Surakarta">Surakarta</option>
                    <option value="Cirebon">Cirebon</option>
                    <option value="Kedu">Kedu</option>
                    <option value="Banyumas">Banyumas</option>
                    <option value="Jawa Timur">Jawa Timur</option>
                    <option value="Jawa Barat">Golek Sunda</option>
                    <option value="Bali">Bali</option>
                    <option value="Banjar">Banjar</option>
                    <option value="Lombok">Lombok</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>2. Detail Fisik</legend>
        <label>Wanda (Ekspresi):</label>
        <input type="text" id="inputWanda" placeholder="Contoh: SiGeger">
        <label>Material Kulit:</label>
        <input type="text" id="inputKulit" placeholder="Contoh: Kerbau">
        <label>Nama Pembuat/Empu:</label>
        <input type="text" id="inputPembuat" placeholder="Nama Empu">
    </fieldset>

    <fieldset>
        <legend>3. Silsilah</legend>
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;"><label>Ayah:</label><input type="text" id="inputAyah"></div>
            <div style="flex: 1;"><label>Ibu:</label><input type="text" id="inputIbu"></div>
        </div>
        <label>Negara/Tempat:</label>
        <input type="text" id="inputNegara" placeholder="Contoh: Indraprasta">
        
        <label>Pusaka:</label>
        <input type="text" id="inputPusaka" placeholder="Contoh: Bramasta">
    </fieldset>

    <fieldset>
        <legend>4. Media & Cerita</legend>
        <label>Deskripsi Singkat:</label>
        <textarea id="inputDeskripsi" rows="3"></textarea>
        <label>Upload Foto:</label>
        <input type="file" id="inputGambar">
    </fieldset>

    <button class="btn-action" onclick="arsipkanWayang()">ARSIPKAN</button>
    <div id="statusAdmin"></div>
</div>

    <div class="container" style="margin-top: 50px; border: 1px solid #d35400;">
    <h1 style="color: #d35400;">Revisi (Edit Data)</h1>
    <p style="color: #666; font-size: 14px;">Masukkan ID Wayang yang salah, lalu isi <b>SEMUA</b> data perbaikan di bawah ini.</p>

    <div style="background: #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e67e22;">
        <label style="font-weight: bold; color: #d35400;">TARGET ID WAYANG (Wajib):</label>
        <input type="number" id="editId" placeholder="Masukan ID" style="font-size: 14px;">
    </div>

    <fieldset>
        <legend style="color: #d35400;">1. Perbaikan Identitas</legend>
        <label>Nama Tokoh:</label>
        <input type="text" id="editNama" placeholder="Nama yang benar">
        
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;">
                <label>Golongan:</label>
                <select id="editGolongan">
                    <option value="Satria">Satria</option>
                    <option value="Dewa">Dewa</option>
                    <option value="Yaksa">Yaksa</option>
                    <option value="Wanara">Wanara</option>
                    <option value="Panakawan">Panakawan</option>
                    <option value="Kayon">Kayon</option>
                    <option value="Bambangan">Bambangan</option>
                    <option value="Punggawa">Punggawa</option>
                    <option value="Krodan">Krodan</option>
                    <option value="Resi">Resi</option>
                    <option value="Putren">Putren</option>
                    <option value="Buta Kiwe">Buta Kiwe</option>
                    <option value="Sato">Sato</option>
                    <option value="Gaman">Gaman</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>Gaya:</label>
                <select id="editGaya">
                    <option value="Yogyakarta">Yogyakarta</option>
                    <option value="Surakarta">Surakarta</option>
                    <option value="Cirebon">Cirebon</option>
                    <option value="Kedu">Kedu</option>
                    <option value="Banyumas">Banyumas</option>
                    <option value="Jawa Timur">Jawa Timur</option>
                    <option value="Jawa Barat">Golek Sunda</option>
                    <option value="Bali">Bali</option>
                    <option value="Banjar">Banjar</option>
                    <option value="Lombok">Lombok</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend style="color: #d35400;">2. Perbaikan Detail Fisik</legend>
        <label>Wanda (Ekspresi):</label>
        <input type="text" id="editWanda" placeholder="Contoh: SiGeger">
        <label>Material Kulit:</label>
        <input type="text" id="editKulit" placeholder="Contoh: Kerbau">
        <label>Nama Pembuat/Empu:</label>
        <input type="text" id="editPembuat" placeholder="Nama Empu">
    </fieldset>

    <fieldset>
        <legend style="color: #d35400;">3. Perbaikan Silsilah</legend>
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;"><label>Ayah:</label><input type="text" id="editAyah"></div>
            <div style="flex: 1;"><label>Ibu:</label><input type="text" id="editIbu"></div>
        </div>
        <label>Negara/Tempat:</label>
        <input type="text" id="editNegara" placeholder="Contoh: Indraprasta">
        <label>Pusaka:</label>
        <input type="text" id="editPusaka" placeholder="Contoh: Bramasta">
    </fieldset>

    <fieldset>
        <legend style="color: #d35400;">4. Perbaikan Media & Cerita</legend>
        <label>Deskripsi Singkat:</label>
        <textarea id="editDeskripsi" rows="3"></textarea>
        
        <label style="color: #d35400; font-weight: bold;">Upload Foto (Wajib Upload Ulang):</label>
        <input type="file" id="editGambar">
        
        <input type="hidden" id="editURI"> 
    </fieldset>

    <button class="btn-action" style="background-color: #d35400; font-weight: bold" onclick="revisiWayang()">UPDATE</button>
    <div id="statusRevisi" class="status"></div>
    </div>
    
<div id="toast"></div>
    
<script>
    const CONTRACT_ADDRESS = "0x68e009bcB135fFB0a872838039F5f2243aFCA18F";
    const PINATA_API_KEY = "4658f1eb70d0c8bcb9dc";
    const PINATA_SECRET_KEY = "4cc702ab4f76139600b8e18c1f95166c9aefe4611b5c81cfeb5dc8b58c33dbf5";

    const CHAIN_ID = 84532; 
    const HEX_CHAIN_ID = "0x14a34"; 

    const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct PutramasOfficialArchive.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasOfficialArchive.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
        
    let provider;
    let signer;
    let userAddress;
    let toastTimeout;

    async function compressImage(file, maxSizeKB = 700) {
        // 1. Cek ukuran file asli, jika di bawah target langsung kembalikan
        if (file.size <= maxSizeKB * 1024) return file;

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // 2. Resize jika terlalu lebar (Max 1280px agar ringan)
                    const MAX_WIDTH = 1280;
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 3. Loop Kompresi (Turunkan kualitas bertahap)
                    let quality = 0.9;
                    const tryCompress = () => {
                        canvas.toBlob((blob) => {
                            if (!blob) return reject("Gagal kompresi");
                            
                            const sizeKB = blob.size / 1024;
                            // Jika sudah < 700KB atau kualitas sudah jelek (0.5), Stop.
                            if (sizeKB <= maxSizeKB || quality <= 0.5) {
                                console.log(`Kompresi: ${(file.size/1024).toFixed(0)}KB -> ${sizeKB.toFixed(0)}KB (Q:${quality.toFixed(1)})`);
                                const newFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now(),
                                });
                                resolve(newFile);
                            } else {
                                // Kurangi kualitas dan coba lagi
                                quality -= 0.1;
                                tryCompress();
                            }
                        }, 'image/jpeg', quality);
                    };
                    tryCompress();
                };
            };
            reader.onerror = (error) => reject(error);
        });
    }

    async function connectWallet() {
        if (!window.ethereum) return showToast("Metamask tidak terdeteksi!", 'wolf');

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const network = await provider.getNetwork();
            if (network.chainId !== CHAIN_ID) {
                await switchNetwork();
            }

            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            const btn = document.getElementById("btn-connect");
            btn.innerText = "Connected: " + userAddress.substring(0,6) + "...";
            btn.classList.add("connected");

        } catch (err) {
            console.error(err);
            showToast("Gagal koneksi: " + err.message, 'error');
        }
    }

    async function switchNetwork() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: HEX_CHAIN_ID }],
            });
        } catch (switchError) {
            if (switchError.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: HEX_CHAIN_ID,
                        chainName: 'Base Sepolia Testnet',
                        rpcUrls: ['https://sepolia.base.org'],
                        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                        blockExplorerUrls: ['https://sepolia.basescan.org']
                    }],
                });
            }
        }
    }

    async function uploadToIPFS(file) {
        const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
        let data = new FormData();
        data.append('file', file);
        const res = await axios.post(url, data, {
            headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY, "Content-Type": "multipart/form-data"}
        });
        return `https://gateway.pinata.cloud/ipfs/${res.data.IpfsHash}`;
    }

    async function uploadJSON(jsonData) {
        const url = `https://api.pinata.cloud/pinning/pinJSONToIPFS`;
        const res = await axios.post(url, jsonData, {
            headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY}
        });
        return `ipfs://${res.data.IpfsHash}`;
    }

    async function arsipkanWayang() {
        const statusEl = document.getElementById("statusAdmin");
        if(!signer) {
            await connectWallet();
            if(!signer) return;
        }

        const nama = document.getElementById("inputNama").value;
        const file = document.getElementById("inputGambar").files[0];
        
        if(!nama || !file) { showToast("Nama dan Gambar wajib diisi!", 'warning'); return; }

        try {
            statusEl.className = "status loading";
            
            // --- MODIFIKASI: KOMPRESI GAMBAR ---
            statusEl.innerText = "⏳ Mengompres Gambar (Max 700KB)...";
            const compressedFile = await compressImage(file, 700);

            statusEl.innerText = "⏳ 1/3 Mengupload Gambar ke IPFS...";
            const imgUrl = await uploadToIPFS(compressedFile);

            statusEl.innerText = "⏳ 2/3 Menyusun Metadata...";
            const metadata = {
                name: nama,
                description: document.getElementById("inputDeskripsi").value,
                image: imgUrl,
                attributes: [
                    { trait_type: "Golongan", value: document.getElementById("inputGolongan").value },
                    { trait_type: "Gaya", value: document.getElementById("inputGaya").value },
                    { trait_type: "Wanda", value: document.getElementById("inputWanda").value || "-" },
                    { trait_type: "Material Kulit", value: document.getElementById("inputKulit").value || "-" },
                    { trait_type: "Pembuat", value: document.getElementById("inputPembuat").value || "-" },
                    { trait_type: "Ayah", value: document.getElementById("inputAyah").value || "-" },
                    { trait_type: "Ibu", value: document.getElementById("inputIbu").value || "-" },
                    { trait_type: "Negara", value: document.getElementById("inputNegara").value || "-" },
                    { trait_type: "Pusaka", value: document.getElementById("inputPusaka").value || "-" }
                ]
            };
            const tokenURI = await uploadJSON(metadata);

            statusEl.innerText = "⏳ 3/3 Konfirmasi Transaksi Metamask...";
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            const tx = await contract.arsipWayang(
                userAddress,
                tokenURI,
                nama, 
                document.getElementById("inputGolongan").value, 
                document.getElementById("inputGaya").value
            );
            
            statusEl.innerText = "⛏️ Sedang Mining di Base Sepolia...";
            const receipt = await tx.wait();

            statusEl.className = "status success";
            statusEl.innerHTML = `✅ SUKSES! Block: ${receipt.blockNumber}<br>Hash: ${tx.hash}`;
            
            document.getElementById("inputNama").value = "";
            document.getElementById("inputGambar").value = "";

        } catch (err) {
            console.error(err);
            statusEl.className = "status error";
            statusEl.innerText = "Gagal: " + (err.reason || err.message);
        }
    }

    async function revisiWayang() {
        const statusEl = document.getElementById("statusRevisi");
        const id = document.getElementById("editId").value;
        const nama = document.getElementById("editNama").value;
        const golongan = document.getElementById("editGolongan").value;
        const gaya = document.getElementById("editGaya").value;
        const wanda = document.getElementById("editWanda").value;
        const kulit = document.getElementById("editKulit").value;
        const pembuat = document.getElementById("editPembuat").value;
        const ayah = document.getElementById("editAyah").value;
        const ibu = document.getElementById("editIbu").value;
        const negara = document.getElementById("editNegara").value;
        const pusaka = document.getElementById("editPusaka").value;
        const deskripsi = document.getElementById("editDeskripsi").value;
        const fileInput = document.getElementById("editGambar").files[0];

        if (!id || !nama || !fileInput) {
            return showToast("ID, Nama, dan Foto (Upload Ulang) wajib diisi untuk revisi!", 'warning');
        }

        try {
            if (!signer) await connectWallet();

            statusEl.className = "status loading";

            // --- MODIFIKASI: KOMPRESI GAMBAR ---
            statusEl.innerText = "⏳ Mengompres Foto Revisi (Max 700KB)...";
            const compressedFile = await compressImage(fileInput, 700);

            statusEl.innerText = "⏳ Sedang mengupload Foto & Metadata Revisi ke IPFS...";
            const imgUrl = await uploadToIPFS(compressedFile);

            const metadata = {
                name: nama,
                description: deskripsi,
                image: imgUrl,
                attributes: [
                    { trait_type: "Golongan", value: golongan },
                    { trait_type: "Gaya", value: gaya },
                    { trait_type: "Wanda", value: wanda },
                    { trait_type: "Material", value: kulit },
                    { trait_type: "Empu", value: pembuat },
                    { trait_type: "Ayah", value: ayah },
                    { trait_type: "Ibu", value: ibu },
                    { trait_type: "Negara", value: negara },
                    { trait_type: "Pusaka", value: pusaka },
                    { trait_type: "Status", value: "Revisi" }
                ]
            };

            const tokenURI = await uploadJSON(metadata);
            console.log("New Metadata URI:", tokenURI);
            statusEl.innerText = "⏳ Mengirim Konfirmasi ke Blockchain (Cek Metamask)...";
        
            const contract = new ethers.Contract(CONTRACT_ADDRESS, [
                ...CONTRACT_ABI,
                "function revisiDataWayang(uint256 _tokenId, string memory _namaBaru, string memory _uriBaru) public"
            ], signer);

            const tx = await contract.revisiDataWayang(id, nama, tokenURI);
            
            statusEl.innerText = "⛏️ Sedang memproses update di Blockchain...";
            await tx.wait();

            statusEl.className = "status success";
            statusEl.innerText = `✅ SUKSES! Data ID #${id} telah direvisi sepenuhnya.`;
            
            document.getElementById("editId").value = "";
            document.getElementById("editNama").value = "";

        } catch (err) {
            console.error(err);
            statusEl.className = "status error";
            statusEl.innerText = "Gagal Revisi: " + (err.reason || err.message);
        }
                }
    
    function showToast(msg, type = 'info') {
    const x = document.getElementById("toast");

    const icons = {
        info: 'img/info-icon.svg',
        load: 'img/load.svg',
        loading: 'img/loading.svg',
        success: 'img/success.svg',
        error: 'img/error.svg',
        warning: 'img/warning.svg',
        wolf: 'img/wolf.svg'
    };

    const closeIcon = 'img/x.svg';
    if (!icons[type]) type = 'info';

    x.innerHTML = `
        <img src="${icons[type]}" class="toast-icon" alt="${type}"> 
        <span style="flex:1;">${msg}</span>
        <img src="${closeIcon}" class="toast-close" onclick="this.parentElement.className = this.parentElement.className.replace('show', '')" alt="close">
    `;

    x.className = ''; 
    void x.offsetWidth; 
    x.className = `show ${type}`;

    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { 
        x.className = x.className.replace("show", ""); 
    }, 10000); 
    }
</script>
</body>
</html>
