<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruang Koleksi - Profile Kolektor</title>
    
    <link rel="icon" href="/img/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/img/icon-512.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
<style>
* {
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background-color: #f6f9ff;
    color: #333;
    margin: 0;
    padding: 0;
    padding-top: 80px;
    padding-bottom: 80px;
}

.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 5%;
    height: 70px;
    background: rgba(255, 255, 255, 0.9); 
    backdrop-filter: blur(10px);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.nav-left {
    display: flex;
    align-items: center;
    height: 100%;
}

.brand-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    gap: 10px;
}

.nav-logo {
    width: 45px; 
    height: 45px;
    border-radius: 50%;
    border: 2px solid #7385a5;
    object-fit: cover;
}

.nav-brand {
    font-size: 20px;
    color: #7385a5;
    font-weight:bold;
}

.nav-right {
    display: flex;
    align-items: center;
    height: 100%;
}


.btn-connect {
    background: linear-gradient(135deg, #7385a5, #5c6a84);
    color: white;
    border: none;
    padding: 10px 25px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(115, 133, 165, 0.2);
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Poppins', sans-serif;
}

.btn-connect:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(115, 133, 165, 0.3);
}

@media (max-width: 600px) {
    .navbar {
        padding: 0 20px;
        height: 60px;
    }
    
    .nav-brand {
        font-size: 18px;
    }
    
    .btn-connect {
        padding: 8px 15px;
        font-size: 12px;
    }
    
    .btn-text {
        display: none;
    }
}
    
        .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 80vh; }
        
        .login-wall { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; text-align: center; animation: fadeIn 0.5s ease; }
        .lock-icon { font-size: 50px; color: #7385a5; margin-bottom: 20px; background: #e9f0ff; width: 100px; height: 100px; line-height: 100px; border-radius: 50%; box-shadow: 0 10px 30px rgba(115, 133, 165, 0.2); }
       .btn-connect-big { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(115, 133, 165, 0.3); display: flex; align-items: center; gap: 10px; }
        .btn-connect-big:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); }

        #mainContent { display: none; }
        
        .profile-card { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border-radius: 25px; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); position: relative; overflow: hidden; margin-bottom: 30px; text-align: center; }
        .profile-card::before { content: ''; position: absolute; top: -50%; left: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        @media (min-width: 768px) { .profile-card { flex-direction: row; text-align: left; justify-content: space-between; } .profile-info-wrapper { display: flex; align-items: center; gap: 20px; } }
        
        .profile-avatar img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); object-fit: cover; background: #ccc; }
        .profile-details h2 { margin: 0; font-size: 13px; font-family: 'Courier New', monospace; letter-spacing: 0.5px; margin-bottom: 5px; }
        .badges { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        @media (min-width: 768px) { .badges { justify-content: flex-start; } }
        .badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        
        .btn-copy { background: rgba(255,255,255,0.9); color: #7385a5; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-copy:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .section-title { color: #7385a5; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }

        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .wayang-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #eee; position: relative; }
        .wayang-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card-img { 
    width: 100%; 
    height: 180px;
    object-fit: contain; 
    object-position: center; 
    background: #f8f9fa; 
    box-sizing: border-box; 
    padding: 10px;
    display: block;
        }

.card-img-container {
    width: 100%;
    height: 180px;
    background: #f8f9fa;
    display: flex;
    align-items: center; 
    justify-content: center;
    overflow: hidden;
    padding: 10px;
    box-sizing: border-box;
}

.card-img-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
        .card-body { padding: 12px; }
        .card-title { font-size: 11px; font-weight: bold; color: #5c6a84; margin: 0; }
        .card-id { font-size: 11px; color: #999; margin-bottom: 8px; display: block; }
        .btn-detail { display: block; width: 100%; text-align: center; background: #e9f0ff; color: #7385a5; text-decoration: none; padding: 8px 0; border-radius: 8px; font-size: 12px; font-weight: bold; transition: 0.2s; }
        .btn-detail:hover { background: #7385a5; color: white; }
        .owned-badge { position: absolute; top: 10px; right: 10px; background: #f1c40f; color: white; font-size: 6px; padding: 2px 4px; border-radius: 8px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        .state-box { text-align: center; padding: 50px 20px; color: #7385a5; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

.search-capsule {
    background: white;
    border-radius: 50px;
    padding: 0; 
    display: flex;
    align-items: center;
    gap: 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 2px solid #7385a5;
    margin-bottom: 25px;
    transition: 0.3s;
    height: 50px;
    overflow: hidden;
}

.search-capsule:focus-within {
    box-shadow: 0 8px 25px rgba(115, 133, 165, 0.15);
    border-color: #dbe4f3;
    transform: translateY(-2px);
}

.search-icon {
    color: #b0b8c4;
    font-size: 16px;
    padding-left: 20px;
}

.search-capsule input {
    border: none;
    outline: none;
    flex: 1; 
    font-size: 14px;
    font-family: 'Poppins', sans-serif;
    color: #5c6a84;
    background: transparent;
    height: 100%;
    padding-left: 15px;
}

.search-capsule input::placeholder {
    color: #b0b8c4;
}

.btn-search {
    background: #7385a5;
    color: white;
    border: none;
    height: 100%; 
    padding: 0 20px; 
    font-size: 16px; 
    border-radius: 0 50px 50px 0;
    cursor: pointer;
    transition: 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-search:hover {
    background: #5c6a84;
    border: 2px solid #5c6a84;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5); 
}

@media (max-width: 480px) {
    .search-capsule {
    }
    .search-icon { display: none; }
    .search-capsule input { padding-left: 20px; }
    .btn-search { padding: 0 20px; }
        }

        .footer { background: #fff; padding: 15px; text-align: center; margin-top: auto; border-top: 1px solid #eee; }
        .copyright { color: #888; font-size: 13px; }

        #btn-connect {
            background: transparent; color: #7385a5; border: 2px solid #7385a5; 
            padding: 10px 25px; cursor: pointer; font-family: 'Rubik', sans-serif; 
            font-weight: bold; border-radius: 30px; transition: 0.3s; font-size: 14px;
        }
        #btn-connect:hover { background: #f6f9ff; color: #7385a5; border: 2px solid #7385a5; }
        #btn-connect.connected { background: #7385a5; color: #fff; border-color: #abb6c9; cursor: default; }
        @media (max-width: 600px) {
            .navbar { padding: 15px 20px; }
            .nav-brand { font-size: 0.9em; }
            #btn-connect { padding: 8px 15px; font-size: 12px; }
            h1 { font-size: 2em; }
                 }
                 
     #toast {
    visibility: hidden;
    min-width: 220px;
    max-width: 85%;
    position: fixed;
    z-index: 99999;
    top: 90px;
    right: 20px;
    left: auto;
    background-color: rgba(51, 51, 51, 0.95);
    backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    padding: 10px 35px 10px 15px; 
    display: flex;
    align-items: center;
    font-family: 'Rubik', sans-serif;
    font-weight: 500;
    font-size: 11px;
    letter-spacing: 0.3px;
    opacity: 0;
    transform: translateX(20px) scale(0.9); 
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0.4s; 
}

#toast.show {
    visibility: visible;
    opacity: 1;
    transform: translateX(0) scale(1);
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0s;
}
    
#toast .toast-icon {
    width: 23px;
    height: 23px; 
    margin-right: 10px; 
    object-fit: contain;
}

#toast .toast-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 9px;
    height: 9px;
    cursor: pointer;
    opacity: 0.6;
    transition: 0.2s;
}

        #toast .toast-close:hover { opacity: 1; transform: scale(1.1); }

    #toast.info {
    background: rgba(0, 53, 107, 0.35);
    border: 1px solid rgba(0, 100, 204, 0.4);
    color: #fff;
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0, 100, 255, 0.25);
}

#toast.success {
    background: rgba(0, 77, 7, 0.35);
    color: #fff;
    border: 1px solid rgba(0, 184, 15, 0.4);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0,255,0,0.2);
}

#toast.error {
    background: rgba(107, 0, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(184, 0, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 22px rgba(255,0,0,0.25);
    }

#toast.warning {
    background: rgba(102, 98, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(179, 171, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 20px rgba(255,255,0,0.25);
}

#toast.wolf {
    background: rgba(125, 65, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(204, 106, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(255,140,0,0.25);
}

#toast.load {
    background: rgba(49, 77, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(104, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(0,255,0,0.25);
}
    
#toast.loading {
    background: rgba(52, 90, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(94, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(94, 163, 0, 0.25);
}

@keyframes slideDown {
    from {top: -50px; opacity: 0;}
    to {top: 30px; opacity: 1;}
}

@keyframes fadeOut {
    from {top: 30px; opacity: 1;}
    to {top: -50px; opacity: 0;}
}

.sawer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 9999; display: none;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .sawer-overlay.active { opacity: 1; }

        .sawer-card {
            background: #f6f9ff; width: 90%; max-width: 400px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Rubik', sans-serif; border: 2px solid #7385a5; position: relative;
        }
        .sawer-overlay.active .sawer-card { transform: translateY(0); }

        .sawer-header { text-align: center; margin-bottom: 15px; }
        .sawer-header h3 { margin: 0; color: #7385a5; font-size: 14px; font-weight: 700; border: none !important; }

        .sawer-close {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 20px; color: #7385a5;
            cursor: pointer; z-index: 10; transition: transform 0.2s;
        }
        .sawer-close:hover { transform: rotate(90deg); color: #d35400; }

        .network-indicator {
            display: flex; align-items: center; gap: 8px; font-size: 11px;
            color: #27ae60; background: rgba(39, 174, 96, 0.1);
            padding: 6px 12px; border-radius: 20px; width: fit-content; margin: 0 auto 20px auto; font-weight: 600;
        }
        .pulse-green {
            width: 8px; height: 8px; background: #27ae60; border-radius: 50%;
            box-shadow: 0 0 0 rgba(39, 174, 96, 0.4); animation: pulse 1.5s infinite;
        }

        .sawer-info-box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dae1e7; }
        .info-row { display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 4px; }
        .info-row.sub { font-size: 11px; color: #999; }
        .info-row.highlight { color: #7385a5; font-weight: bold; font-size: 14px; }
        .info-row .mono { font-family: monospace; }
        .divider { height: 1px; background: #e0e0e0; margin: 8px 0; }

        .input-group label { display: block; font-size: 12px; color: #7385a5; margin-bottom: 5px; font-weight: 600; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper input {
            width: 100%; padding: 12px; padding-right: 50px;
            border: 2px solid #e0e0e0; border-radius: 10px; font-size: 18px; font-weight: bold; color: #2c3e50;
            transition: border-color 0.2s;
        }
        .input-wrapper input:focus { border-color: #7385a5; outline: none; }
        .suffix { position: absolute; right: 15px; color: #95a5a6; font-weight: 600; font-size: 12px; }
        .limit-info { font-size: 10px; color: #7385a5; margin-top: 4px; display: block; }
        textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; resize: none; box-sizing: border-box; }

        .percent-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .percent-grid button {
            background: #fff; border: 1px solid #7385a5; border-radius: 6px;
            padding: 6px 2px; font-size: 10px; font-weight: bold; color: #555;
            cursor: pointer; transition: 0.2s; white-space: nowrap;
        }
        .percent-grid button:hover { background: #e3e7ed; border-color: #5c6a84; }

        .btn-sawer-send {
            width: 100%; background: linear-gradient(135deg, #7385a5 0%, #5c6a84 100%);
            color: white; border: none; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(115, 133, 165, 0.25);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.2s;
        }
        .btn-sawer-send:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(115, 133, 165, 0.4); }
        .btn-sawer-send:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }

.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: transparent;
    backdrop-filter: none;
    z-index: 9998;
    display: none;
    display: none; 
}

.modal-overlay.active {
    display: block; 
}

.modal-card {
    position: absolute;
    top: 70px;
    right: 20px;  
    width: 300px;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.15); 
    border: 1px solid rgba(0,0,0,0.05); 
    text-align: center;
    font-family: 'Rubik', sans-serif;
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    transform-origin: top right;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    max-height: 80vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #ccc transparent;
}

.modal-card::before {
    content: "";
    position: absolute;
    top: -6px; 
    right: 20px; 
    width: 12px;
    height: 12px;
    background: #fff;
    transform: rotate(45deg);
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
    box-shadow: -2px -2px 5px rgba(0,0,0,0.02);
}

.modal-card::-webkit-scrollbar {
    width: 2px;
}
.modal-card::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 10px;
}
.modal-card::-webkit-scrollbar-track {
    background: transparent;
}

.modal-overlay.active .modal-card {
    opacity: 1;
    transform: translateY(0) scale(1);
}
    
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.modal-header h3 { margin: 0; font-size: 18px; color: #333; }
.close-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }

.modal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.status-badge {
    color: #27ae60;
    font-weight: bold;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-label { color: #888; }
    
.pulse-dot {
    width: 8px; height: 8px;
    background-color: #27ae60;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(39, 174, 96, 0.4);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(39, 174, 96, 0); }
    100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
}

.modal-balance { margin-bottom: 20px; }
.balance-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
.balance-amount { font-size: 24px; font-weight: bold; color: #2c3e50; margin-top: 5px; }

.modal-address-box {
    background: #f1f2f6;
    padding: 12px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    margin-bottom: 25px;
}
.modal-address-box:hover { border-color: #3498db; background: #eaf6ff; }
.address-text { font-family: monospace; font-size: 14px; color: #555; }
.copy-icon { color: #3498db; }

.modal-actions { display: flex; flex-direction: column; gap: 10px; }
.action-btn {
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    transition: transform 0.1s;
}
.action-btn:active { transform: scale(0.98); }
.action-btn.primary { background: #7385a5; color: white; }
.action-btn.danger { background: #fee; color: #e74c3c; border: 1px solid #fcc; }

.stat-box-gold, .stat-box-blue {
    flex: 1;
    min-width: 140px;
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid #eee;
}

.stat-icon {
    width: 30px; height: 30px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px;
}
.stat-box-gold .stat-icon { background: #f6f9ff; color: #7385a5; border: 1px solid #7385a5; }
.stat-box-blue .stat-icon { background: #f6f9ff; color: #7385a5; border: 1px solid #7385a5; }

.stat-info h3 { margin: 0; font-size: 16px; color: #7385a5; }
.stat-label { font-size: 11px; font-weight: bold; color: #95a5a6; text-transform: uppercase; letter-spacing: 0.5px; }

.tip-card {
    background: #fff;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    animation: fadeIn 0.5s ease;
}

.tip-header {
    display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 5px;
}

.tip-amount {
    font-weight: bold; color: #27ae60; font-size: 13px; display: flex; align-items: center; gap: 5px;
}

.tip-message {
    background: #fcfcfc;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    color: #555;
    font-style: italic;
    margin-top: 8px;
    border: 1px dashed #eee;
}

.modal-history-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 15px;
}

.history-scroll-area {
    max-height: 120px;
    overflow-y: auto;
    padding-right: 5px;
}

.history-scroll-area::-webkit-scrollbar { width: 4px; }
.history-scroll-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

.mini-history-item {
    background: #fff;
    border: 1px solid #eee;
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 6px;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mini-sender { font-weight: bold; color: #5c6a84; }
.mini-amount { color: #27ae60; font-weight: bold; }
.mini-msg { 
    display: block; 
    font-size: 10px; 
    color: #888; 
    font-style: italic; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    max-width: 150px;
}

@keyframes premiumFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.tip-card {
    background: #fff;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 12px;
    border: 1px solid #eee;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    animation: premiumFadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) backwards;   
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    cursor: default;
    position: relative;
    overflow: hidden;
}

.tip-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(115, 133, 165, 0.15);
    border-color: #7385a5;
}

.tip-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 4px;
    background: #7385a5;
    transform: scaleY(0);
    transition: transform 0.3s ease;
}

.tip-card:hover::before {
    transform: scaleY(1);
}

@media (min-width: 768px) {
    .tip-feed {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    .tip-card {
        flex: 1 1 calc(50% - 15px);
        margin-bottom: 0 !important;
        min-width: 300px;
    }
}

.official-text-glow {
    background: #f6f9ff;
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 900 !important;
    font-size: 24px;
    letter-spacing: 1px;
    animation: shineText 4s linear infinite;
    /* Drop shadow halus biar terbaca di background putih */
    filter: drop-shadow(0 2px 4px rgba(211, 84, 0, 0.3));
}

.official-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
    color: gold; 
    font-size: 1.7em; 
    vertical-align: middle; 
    transform: translateY(-4px); 
    animation: pulseBadge 2s infinite ease-in-out;
}

.official-avatar-border {
    border: 3px solid #d35400 !important;
    box-shadow: 0 0 15px rgba(211, 84, 0, 0.4);
    transition: transform 0.5s ease;
}

.official-avatar-border:hover {
    transform: scale(1.05);
    box-shadow: 0 0 25px rgba(211, 84, 0, 0.6);
}

.footer {
            background: none;
        }

        .social-icons { margin-bottom: 10px; }
        
        .social-link {
            display: inline-flex; justify-content: center; align-items: center;
            width: 25px; height: 25px; margin: 0 03px;
            border-radius: 50%; background: #7385a5; color: #fff;
            font-size: 12px; transition: all 0.3s ease; border: 1.5px solid #7385a5;
            text-decoration: none;
        }
        .social-link:hover {
            background: #fff; color: #7385a5;
            transform: translateY(-5px); box-shadow: 0 0 15px #7385a5;
        }

        .copyright { color: #888; font-size: 11px; letter-spacing: 1px; margin-top: 10px; }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: #fff; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 5000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;

    text-decoration: none;
    color: #666;
    font-size: 10px;
    width: 20%;

    background: none;
    border: none;
    padding: 6px 0;
    cursor: pointer;

    transition:
        color 0.25s ease,
        transform 0.25s ease;
}

.nav-link i {
    font-size: 22px;
    margin-bottom: 4px;
    transition:
        transform 0.25s ease,
        color 0.25s ease,
        filter 0.25s ease;
}

.nav-link:hover {
    color: #7385a5;
}

.nav-link:hover i {
    transform: translateY(-2px) scale(1.05);
    color: #7385a5;
    background: #e9f0ff;
    border-radius: 50px;
    border: 1px solid #7385a5;
    filter: drop-shadow(0 4px 8px rgba(115, 133, 165, 0.25));
}

.nav-link.active {
    color: #7385a5;
}

.nav-link.active i {
    transform: scale(1.08);
    filter: drop-shadow(0 6px 12px rgba(115, 133, 165, 0.35));
}


@media (min-width: 1100px) {
    .bottom-nav {
        display: none !important;
    }
}

.custom-name {
    font-size: 16px;
    font-weight: bold;
    color: #fff;
    margin-top: -5px;
    margin-bottom: 5px;
    min-height: 20px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

.profile-meta {
    font-size: 11px;
    color: rgba(255,255,255,0.8);
    margin-bottom: 8px;
    font-weight: bold;
}

.profile-avatar {
    position: relative;
}
.edit-photo-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    background: #2c3e50;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    font-size: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.sawer-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
}
.sawer-card {
    background: white; width: 90%; max-width: 320px;
    padding: 20px; border-radius: 12px; color: #333;
}
</style>
</head>
<body>
    
    <nav class="navbar">
    <div class="nav-left">
        <a href="index" class="brand-link">
            <img src="img/pwn-logo.png" class="nav-logo" alt="Logo">
            <span class="brand" style="font-size:20px; color: #7385a5; font-weight:bold;">Profile</span>
        </a>
    </div>

    <div class="nav-right">
        <button id="btn-connect" class="btn-connect" onclick="window.connectWallet()">
            <i class="fas fa-wallet"></i> Hubungkan
        </button>
    </div>
</nav>
    
    <div id="loginSection" class="login-wall">
        <div class="lock-icon"><i class="fas fa-shield-alt"></i></div>
        <h2 style="color:#5c6a84; margin-bottom:5px;">Akses Ruang Koleksi</h2>
        <p style="color:#8898aa; max-width: 350px;">
            Hubungkan dompet Web3 Anda untuk membuka sertifikat kepemilikan dan data koleksi.
        </p>
        <button onclick="window.requestLogin()" class="btn-connect-big" id="btnLogin">
            <i class="fas fa-wallet"></i> Buka Akses
        </button>
    </div>

    <div id="mainContent" class="container">
    
        <div class="search-capsule">
            <div class="search-icon"><i class="fas fa-search"></i></div>
            <input type="text" id="inputAddress" placeholder="Cari Alamat Wallet Kolektor" onkeypress="window.handleEnter(event)">
            <button onclick="window.cariProfile()" class="btn-search" title="Cari Alamat"><i class="fas fa-search"></i></button>
        </div>
        
        <div class="profile-card">
    <div class="profile-info-wrapper">
        
        <div class="profile-avatar">
            <img src="img/placeholder.jpg" id="avatarImg" alt="Avatar" style="object-fit: cover;">
            <button id="btnEditPhoto" class="edit-photo-btn" onclick="openEditModal()" style="display:none;">
                <i class="fas fa-camera"></i>
            </button>
        </div>

        <div class="profile-details">
            <h2 id="displayAddress">Loading...</h2>
            
            <div id="profileNickname" class="custom-name"></div>

            <div id="profileMeta" class="profile-meta" style="display:none;">
                <span id="profileCity"><i class="fas fa-map-marker-alt"></i> -</span> â€¢ 
                <span id="profileBio" style="font-style: italic;">-</span>
            </div>

            <div class="badges">
                <span class="badge"><i class="fas fa-crown"></i> Owner</span>
                <span class="badge" style="background:rgba(255,255,255,0.3);">
                    <i class="fas fa-cube"></i> <span id="totalItems">0</span> Koleksi
                </span>
            </div>
            
            <button id="btnEditProfile" onclick="openEditModal()" style="display:none; margin-top:10px; font-size:10px; padding:5px 10px; border-radius:15px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:white; cursor:pointer;">
                <i class="fas fa-pen"></i> Edit Profil
            </button>
        </div>
    </div>
    
    <button onclick="window.copyAddress()" class="btn-copy">
        <i class="far fa-copy"></i> <span id="btnCopyText">Salin Alamat</span>
    </button>
</div>

<div id="editProfileModal" class="sawer-overlay" style="display:none;">
    <div class="sawer-card">
        <div class="sawer-header">
            <h3>Edit Profil Global</h3>
            <button class="sawer-close" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
        </div>
        
        <div style="text-align:center; margin-bottom:15px;">
            <label for="inputAvatar" style="cursor:pointer;">
                <img id="previewAvatar" src="img/placeholder.jpg" style="width:80px; height:80px; border-radius:50%; border:2px dashed #ccc; object-fit:cover;">
                <br><span style="font-size:10px; color:#aaa;">Klik untuk ganti foto</span>
            </label>
            <input type="file" id="inputAvatar" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
        </div>

        <div class="input-group" style="margin-bottom:10px;">
            <input type="text" id="inputName" placeholder="Nama Anda" maxlength="20" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ddd;">
        </div>

        <div class="input-group" style="margin-bottom:10px;">
            <input type="text" id="inputCity" placeholder="Lokasi Anda" maxlength="30" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ddd;">
        </div>

        <div class="input-group" style="margin-bottom:15px;">
            <textarea id="inputBio" placeholder="Bio Singkat..." maxlength="60" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ddd; height:60px;"></textarea>
        </div>

        <button onclick="saveProfileData()" class="btn-sawer-send" style="width:100%;">
            <i class="fas fa-save"></i> Simpan
        </button>
    </div>
</div>

        <div class="stats-container" style="display:flex; gap:15px; margin-top:20px; flex-wrap:wrap;">
    
    <div class="stat-box-gold">
        <div class="stat-icon"><i class="fas fa-coins"></i></div>
        <div class="stat-info">
            <span class="stat-label">Total Apresiasi</span>
            <h3 id="displayTotalEarnings">0 ETH</h3>
        </div>
    </div>

    <div class="stat-box-blue">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-info">
            <span class="stat-label">Total Dukungan</span>
            <h3 id="displaySupporterCount">0 Orang</h3>
        </div>
    </div>

</div>

<div class="history-section" style="margin-top:25px;">
    <h3 class="section-title" style="font-size:16px; margin-bottom:15px;">
        <i class="fas fa-comment-dots" style="color:#7385a5;"></i> Dukungan Terbaru
    </h3>
    
    <div id="tipHistoryContainer" class="tip-feed">
        <p style="text-align:center; color:#aaa; font-size:13px; font-style:italic;">Memuat riwayat...</p>
    </div>

    <div id="loadMoreContainer" style="text-align:center; margin-top:15px; display:none;">
        <button onclick="loadNextTipBatch()" id="btnLoadMoreTips" 
            style="background:transparent; border:1px solid #7385a5; color:#7385a5; padding:8px 20px; border-radius:20px; cursor:pointer; font-size:12px; transition:0.3s;">
            <i class="fas fa-arrow-down"></i> Tampilkan 10 Berikutnya
        </button>
    </div>
</div>

        <h3 class="section-title"><i class="fas fa-box-open"></i> Koleksi/Karya</h3>

        <div id="loading" class="state-box">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i>
            <p id="loadingText">Membaca data Blockchain...</p>
        </div>

        <div id="emptyState" class="state-box" style="display: none;">
            <i class="fas fa-ghost" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>Belum ada Koleksi Wayang yang diadopsi.</p>
            <a href="index" style="color:#7385a5; font-weight:bold;">Cari Wayang</a>
        </div>

        <div id="collectionContainer" class="collection-grid"></div>
        
    </div>

    <div id="walletModal" class="modal-overlay" onclick="closeWalletModal(event)">
    <div class="modal-card">
    
    <div class="modal-header">
        <h3><i class="fas fa-wallet" style="color:#7385a5;"></i> Wallet Info</h3>
        <button class="close-btn" onclick="toggleWalletModal()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-status">
        <span class="status-label">Status:</span>
        <div class="status-badge">
            <span class="pulse-dot"></span> Terhubung Base
        </div>
    </div>

    <div class="modal-balance">
        <div class="balance-label">Saldo Dompet Utama</div>
        <div class="balance-amount" id="modalBalance">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>

        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #d1d9e6;">
            <div class="balance-label" style="color:#888;">
                <i class="fas fa-gift"></i> Total Pendapatan Dukungan
            </div>
            <div class="balance-amount" id="modalTipBalance" style="font-size: 18px; color: #7385a5;">
                0.0000 ETH
            </div>
        </div>
    </div>

    <div class="modal-address-box" onclick="copyAddress()">
        <div class="address-text">
            <span id="modalFullAddress" style="display:none;"></span> 
            <span id="modalShortAddress">0x...</span>
        </div>
        <i class="far fa-copy copy-icon"></i>
    </div>

    <div class="modal-history-section">
        <h4 style="font-size:12px; color:#7385a5; margin:0 0 8px 0; display:flex; justify-content:space-between;">
            <span><i class="fas fa-history"></i> Riwayat Masuk</span>
            <span id="modalTipCountBadge" style="background:#eee; padding:2px 6px; border-radius:10px; font-size:10px;">0</span>
        </h4>
        
        <div id="modalHistoryList" class="history-scroll-area">
            <p style="text-align:center; font-size:11px; color:#aaa; margin-top:10px;">Belum ada riwayat.</p>
        </div>

        <button id="btnModalLoadMore" onclick="loadNextModalTips()" style="display:none; width:100%; margin-top:5px; background:none; border:1px dashed #7385a5; color:#7385a5; font-size:10px; padding:5px; cursor:pointer; border-radius:5px;">
            Muat 3 Lagi <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    
    <div class="social-icons">
                <a href="https://youtube.com/@PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-youtube"></i></a>
                <a href="https://instagram.com/putramas_official" target="_blank" class="social-link"><i class="fab fa-instagram"></i></a>
                <a href="https://facebook.com/PutramasOfficialStudio" target="_blank" class="social-link"><i class="fab fa-facebook-f"></i></a>
                <a href="https://opensea.io/collection/putramas-nusantara-shadows-archive" target="_blank" class="social-link"><i class="fa fa-shopping-cart"></i></a>
            </div>
            <p class="copyright">
                &copy; <span id="year"></span> Powered By <strong>Putramas Official</strong>
            </p>

    <div class="modal-actions" style="margin-top: 15px;">             
        <button class="action-btn danger" onclick="disconnectWallet()">
            <i class="fas fa-sign-out-alt"></i> Putuskan Koneksi
        </button>
    </div>
    </div>
    </div>

    <div id="sawerModal" class="sawer-overlay" onclick="window.closeSawer(event)" style="display:none;">
        <div class="sawer-card">
            <button class="sawer-close" onclick="window.toggleSawerModal(false)"><i class="fas fa-times"></i></button>
            <div class="network-indicator"><span class="pulse-green"></span> Terhubung Ke Jaringan Base</div>
            <div class="sawer-header"><h3>Dukung & Apresiasi Kreator Dengan ETH</h3></div>

            <div class="sawer-info-box">
                <div class="info-row"><span class="label">Penerima:</span><span class="value" id="sawerReceiverName" style="font-weight:bold;">Loading...</span></div>
                <div class="info-row sub"><span class="label">Address:</span><span class="value mono" id="sawerReceiverAddr">0x...</span></div>
                <div class="divider"></div>
                <div class="info-row highlight"><span class="label">Saldo Anda:</span><span class="value" id="sawerUserBalance">0.0000 ETH</span></div>
            </div>

            <div class="input-group">
                <label>Nominal (ETH):</label>
                <div class="input-wrapper">
                    <input type="number" id="sawerAmount" placeholder="0.001" step="0.0001">
                    <span class="suffix">ETH</span>
                </div>
                <small class="limit-info">Min: 0.0001 ETH â€¢ Max: 0.005 ETH</small>
            </div>

            <div class="percent-grid">
                <button onclick="window.setSawerPercent('MIN')">Min</button> 
                <button onclick="window.setSawerPercent(25)">25%</button>
                <button onclick="window.setSawerPercent(50)">50%</button>
                <button onclick="window.setSawerPercent(75)">75%</button>
                <button onclick="window.setSawerPercent(100)">MAX</button>
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <label>Pesan Dukungan (Opsional)</label>
                <textarea id="sawerMessage" rows="2" placeholder="Semangat berkarya!"></textarea>
            </div>

            <button id="btnKirimSawer" class="btn-sawer-send" onclick="window.eksekusiSawer()">
                <i class="fas fa-paper-plane"></i> Kirim Apresiasi
            </button>
        </div>
    </div>

    <div id="toast"></div>
    
    <nav class="bottom-nav">
    <a href="index" class="nav-link active"><i class="fas fa-globe-asia"></i><span>Beranda</span></a>
    <a href="galeri" class="nav-link"><i class="fa fa-university"></i><span>Galeri</span></a>
    <a href="profile" class="nav-link"><i class="fas fa-user"></i><span>Profile</span></a>    
    <a href="upload_public" target="_blank" class="nav-link"><i class="fa fa-cloud-upload"></i><span>Upload</span></a>
</nav>

<script type="module"> 
// 1. IMPORT LIBRARY LENGKAP (APP + DATABASE + AUTH)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"; // <--- TAMBAHAN PENTING

const firebaseConfig = {
    apiKey: "AIzaSyCn1j8acLWDEVjoO2VB3qeN8rh8qUVBRR8",
    authDomain: "putramas-cc719.firebaseapp.com",
    databaseURL: "https://putramas-cc719-default-rtdb.firebaseio.com",
    projectId: "putramas-cc719",
    storageBucket: "putramas-cc719.firebasestorage.app",
    messagingSenderId: "1841157194",
    appId: "1:1841157194:web:012d80abf7293bd43d02b3",
    measurementId: "G-38XGWE5H38"
};

// 2. INISIALISASI
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app); // <--- INISIALISASI AUTH

let currentBase64Avatar = ""; 
let currentViewingAddress = ""; 

console.log("ðŸ”¥ [FRPRO] System V5 Loaded (With Auth Integration)");

// --- FUNGSI LOGIN DATABASE (JEMBATAN) ---
// Fungsi ini dipanggil oleh script MetaMask di bawah
window.loginFirebase = async function(address) {
    try {
        console.log("ðŸ”¥ Mencoba login database untuk:", address);
        
        // A. Login Anonim (Tanpa Password)
        const userCredential = await signInAnonymously(auth);
        const user = userCredential.user;
        
        console.log("âœ… Firebase Auth Sukses! UID:", user.uid);

        // B. Simpan Data Mapping (Wallet <-> UID)
        // Agar database tahu bahwa UID ini pemilik Wallet tersebut
        const updateData = {};
        updateData[`users/${user.uid}/walletAddress`] = address.toLowerCase();
        updateData[`users/${user.uid}/lastLogin`] = Date.now();
        
        // Kita update database
        await update(ref(db), updateData);
        
        return true;
    } catch (error) {
        console.error("Firebase Auth Gagal:", error);
        window.showToast("Gagal Connect Database: " + error.message, "error");
        return false;
    }
};

window.openEditModal = function() {
    const modal = document.getElementById("editProfileModal");
    if(!modal) return window.showToast("Modal Error", "error");
    
    modal.style.display = "flex";
    setTimeout(() => modal.classList.add("active"), 10);

    try {
        const nick = document.getElementById("profileNickname").innerText.replace(/[()]/g, '').trim();
        const city = document.getElementById("profileCity").innerText;
        const bio = document.getElementById("profileBio").innerText;
        
        document.getElementById("inputName").value = nick;
        document.getElementById("inputCity").value = (city === "" || city === "-") ? "" : city;
        document.getElementById("inputBio").value = (bio === "-") ? "" : bio;
        document.getElementById("previewAvatar").src = document.getElementById("avatarImg").src;
    } catch(e) {}
};

window.closeEditModal = function() {
    const modal = document.getElementById("editProfileModal");
    if(modal) { modal.classList.remove("active"); setTimeout(()=>modal.style.display="none", 300); }
};

window.loadGlobalProfile = function(address, isOwner) {
    if(!address) return;
    currentViewingAddress = address.toLowerCase();
    
    const checkUI = setInterval(() => {
        const btnEdit = document.getElementById("btnEditProfile");
        const btnPhoto = document.getElementById("btnEditPhoto");
        if(btnEdit && btnPhoto) {
            clearInterval(checkUI);
            if(isOwner) {
                btnEdit.style.display = "inline-block";
                btnPhoto.style.display = "block";
            } else {
                btnEdit.style.display = "none";
                btnPhoto.style.display = "none";
            }
        }
    }, 500);

    // Baca data berdasarkan Address (Struktur data manual, bukan UID)
    // Catatan: Jika ingin secure rules, pembacaan harus via UID, 
    // tapi untuk profil publik, baca via address tidak masalah.
    onValue(ref(db, 'users/' + currentViewingAddress + '/profile'), (snap) => {
        const data = snap.val();
        updateProfileHTML(data, address);
    });
};

function updateProfileHTML(data, address) {
    const update = setInterval(() => {
        const elNick = document.getElementById("profileNickname");
        const elMeta = document.getElementById("profileMeta");
        const elImg = document.getElementById("avatarImg");
        const elDisp = document.getElementById("displayAddress");

        if(elNick && elMeta && elImg) {
            clearInterval(update);
            
            if (data) {
                elNick.innerText = data.nickname ? `(${data.nickname})` : "";
                
                if(data.city || data.bio) {
                    elMeta.style.display = "block";
                    document.getElementById("profileCity").innerText = data.city || "Bumi";
                    document.getElementById("profileBio").innerText = data.bio || "_";
                } else {
                    elMeta.style.display = "none";
                }
                
                if(data.avatar && data.avatar.length > 50) elImg.src = data.avatar;
                
                if(data.nickname && elDisp) {
                    elDisp.innerText = data.nickname;
                    elDisp.style.color = "#2c3e50";
                }

            } else {
                elNick.innerText = "";
                elMeta.style.display = "none";
                elImg.src = `https://api.dicebear.com/7.x/identicon/svg?seed=${address}`;
            }
        }
    }, 500);
}

// Simpan data pakai Address sebagai key agar mudah dicari publik
window.saveProfileData = function() {
    const wallet = window.userAddress || localStorage.getItem('userWallet');
    if(!wallet) return window.showToast("Login Dulu!", "error");

    const d = {
        nickname: document.getElementById("inputName").value.trim(),
        city: document.getElementById("inputCity").value.trim(),
        bio: document.getElementById("inputBio").value.trim()
    };
    if(currentBase64Avatar) d.avatar = currentBase64Avatar;

    window.showToast("Menyimpan...", "loading");
    
    // Simpan di path users/walletAddress/profile
    set(ref(db, 'users/' + wallet.toLowerCase() + '/profile'), d)
    .then(() => {
        window.showToast("Berhasil!", "success");
        window.closeEditModal();
    })
    .catch((e) => window.showToast("Gagal: " + e.message, "error"));
};

window.handleImageUpload = function(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        if(file.size > 5 * 1024 * 1024) return window.showToast("Max 5MB", "error");
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image(); img.src = e.target.result;
            img.onload = function() {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                const scale = 150 / Math.max(img.width, img.height);
                cvs.width = img.width * scale; cvs.height = img.height * scale;
                ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                const res = cvs.toDataURL('image/jpeg', 0.7);
                document.getElementById("previewAvatar").src = res;
                currentBase64Avatar = res;
            };
        };
        reader.readAsDataURL(file);
    }
};
                    </script>
    
<script>
    const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58";

const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"RevisionFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"TipSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[],"name":"MAX_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramas.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTipByIndex","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"message","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.TipRecord","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTipCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getTipTotalBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiWayang","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"revisionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_receiver","type":"address"},{"internalType":"string","name":"_message","type":"string"}],"name":"sendTip","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setRevisionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTipsGrand","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
    
const BASE_SEPOLIA_ID = "0x2105"; // 8453
const BASE_SEPOLIA_CONFIG = {
    chainId: BASE_SEPOLIA_ID,
    chainName: 'Base',
    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
    rpcUrls: ['https://base-rpc.publicnode.com'],
    blockExplorerUrls: ['https://basescan.org/']
};

let provider, signer;
let userAddress;
let currentAddress = null;
let viewerAddress = null;
const MIN_TIP = 0.0001;
const MAX_TIP = 0.005;
let sawerTargetAddress = null;
let toastTimeout;
let profileGlobalIds = [];
let profileOffset = 0;
let isProfileFetching = false;
let tipCursor = 0;        
let tipTargetAddr = null;
let isTipLoading = false;
let modalTipCursor = 0;      
let modalUserAddr = null;    
let isModalFetching = false;

window.initGatekeeper = async function() {
        if (window.ethereum) {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    viewerAddress = accounts[0];
                    userAddress = accounts[0];
                    updateConnectButtonUI(viewerAddress);
                    
                    signer = provider.getSigner();
                    
                    updateModalData(viewerAddress);
                    updateModalWalletData(viewerAddress);
                }
            } catch (e) {
                console.log("Visitor mode (Read Only)");
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const addressParam = urlParams.get('address');

        if (addressParam) {
            unlockGate(addressParam); 
            return;
        }

        const cachedAddr = localStorage.getItem('userWallet');
        
        if (viewerAddress) {
            unlockGate(viewerAddress);
        } else if (cachedAddr) {
            unlockGate(cachedAddr);
            if(window.ethereum) verifyConnection(cachedAddr);
        }
    };
    
window.verifyConnection = async function(cachedAddr) {
    try {
        const accounts = await provider.listAccounts();
        if (accounts.length === 0 || accounts[0].toLowerCase() !== cachedAddr.toLowerCase()) {
            localStorage.removeItem('userWallet');
            location.reload(); 
        }
    } catch (e) {}
};

window.updateModalData = async function(addr) {
    if(!addr || !provider) return;
    
    try {
        if(document.getElementById("modalFullAddress")) {
            document.getElementById("modalFullAddress").innerText = addr;
            document.getElementById("modalShortAddress").innerText = addr.substring(0, 10) + "..." + addr.substring(34);
        }

        const balance = await provider.getBalance(addr);
        const ethBalance = ethers.utils.formatEther(balance);

        if(document.getElementById("modalBalance")) {
            document.getElementById("modalBalance").innerText = parseFloat(ethBalance).toFixed(8) + " ETH";
        }
    } catch (err) {
        console.error("Gagal update modal:", err);
    }
};

window.connectWallet = async function() {
        const btn = document.getElementById("btn-connect"); 
        const btnBig = document.getElementById("btnLogin"); 

        if (btn && btn.classList.contains("connected")) {
            toggleWalletModal();
            return;
        }

        if (!window.ethereum) return window.showToast("Install Metamask!", 'error');

        if(btn) btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
        if(btnBig) btnBig.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ...`;

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            await switchNetwork();

            signer = provider.getSigner();
            const address = await signer.getAddress();

            localStorage.setItem('userWallet', address);
            viewerAddress = address;
            window.userAddress = address; // Untuk Firebase
            
            // ðŸ”¥ðŸ”¥ PANGGIL FUNGSI LOGIN FIREBASE DISINI ðŸ”¥ðŸ”¥
            if (typeof window.loginFirebase === 'function') {
                await window.loginFirebase(address);
            }

            await updateModalData(address);
            await updateModalWalletData(address);
            updateConnectButtonUI(address);
            unlockGate(address);
            
            window.showToast("Berhasil Terhubung!", "success");

        } catch (err) {
            console.error("Login Error:", err);
            window.showToast("Gagal: " + err.message, 'error');
            if(btn) btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
            if(btnBig) btnBig.innerHTML = `<i class="fas fa-wallet"></i> Buka Akses`;
        }
    };

window.updateConnectButtonUI = function(addr) {
    const btn = document.getElementById("btn-connect");
    if(btn) {
        btn.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
        btn.classList.add("connected");
    }
};

window.switchNetwork = async function() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: BASE_SEPOLIA_ID }],
        });
    } catch (switchError) {
        if (switchError.code === 4902) {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [BASE_SEPOLIA_CONFIG],
                });
            } catch (addError) {
                throw addError;
            }
        } else {
            throw switchError;
        }
    }
};

window.requestLogin = function() {
    connectWallet(); 
};

window.disconnectWallet = function() {
    localStorage.removeItem('userWallet');
    if (typeof viewerAddress !== 'undefined') viewerAddress = null;
    signer = null;

    const btn = document.getElementById("btn-connect");
    if(btn) {
        btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
        btn.classList.remove("connected");
    }

    toggleWalletModal();
    window.location.reload();
};

// --- PERBAIKAN LOGIC MODAL WALLET ---

window.toggleWalletModal = function() {
    // KITA TARGET ID "walletModal" SESUAI HTML ANDA
    const modal = document.getElementById("walletModal");
    
    if (!modal) {
        console.error("Modal ID 'walletModal' tidak ditemukan di HTML!");
        return;
    }

    // Logic Buka/Tutup
    if (modal.classList.contains("active")) {
        // Tutup
        modal.classList.remove("active");
        setTimeout(() => { 
            modal.style.display = "none"; 
        }, 300); // Sesuaikan dengan durasi transisi CSS
    } else {
        // Buka
        modal.style.display = "block"; // Atau "flex" tergantung CSS .modal-overlay
        // Delay sedikit biar animasi CSS jalan
        setTimeout(() => { 
            modal.classList.add("active"); 
        }, 10);
        
        // Update Data saat dibuka
        if (typeof viewerAddress !== 'undefined' && viewerAddress) {
            updateModalWalletData(viewerAddress);
        }
    }
};

// Fungsi tutup jika klik area gelap (background)
window.closeWalletModal = function(e) {
    // Pastikan yang diklik adalah background overlay (id="walletModal"), bukan kartunya
    if (e.target.id === "walletModal") {
        window.toggleWalletModal();
    }
};

 // Main Unlock Logic (Gabungan Blockchain & Firebase Profile)
window.unlockGate = function(profileOwnerAddr) {
    // 1. Set Address Target
    currentAddress = profileOwnerAddr;
    
    // 2. Buka Gerbang (Hide Login / Show Main)
    const loginSec = document.getElementById("loginSection");
    const mainSec = document.getElementById("mainContent");
    if(loginSec) loginSec.style.display = "none";
    if(mainSec) mainSec.style.display = "block";
    
    // 3. Update UI Dasar (Supaya Header tidak kosong saat loading Firebase)
    if (typeof updateProfileUI === 'function') {
        updateProfileUI(currentAddress);
    }

    // 4. Load Data Blockchain (Koleksi & Saweran)
    loadTipData(currentAddress);
    loadDataCepat(currentAddress);

    // 5. Cek Viewer (Siapa yang sedang melihat)
    if (!viewerAddress) viewerAddress = localStorage.getItem('userWallet');
    window.userAddress = viewerAddress; // Set global var untuk script Firebase

    let isOwner = false;
    if (viewerAddress && currentAddress) {
        isOwner = viewerAddress.toLowerCase() === currentAddress.toLowerCase();
    }

    // 6. PANGGIL SCRIPT FIREBASE MODULE (Konfigurasi Profil)
    if (typeof window.loadGlobalProfile === 'function') {
        console.log("ðŸš€ [Firebase] Loading Profile Data...");
        window.loadGlobalProfile(currentAddress, isOwner);
    } else {
        // Retry Logic jika script firebase belum termuat
        console.warn("âš ï¸ Script Profile belum siap, mencoba lagi...");
        setTimeout(() => { 
            if(typeof window.loadGlobalProfile === 'function') {
                window.loadGlobalProfile(currentAddress, isOwner); 
            }
        }, 1000);
    }
};   

window.copyAddressModal = function() {
    const addr = document.getElementById("modalFullAddress").innerText;
    if(addr) {
        navigator.clipboard.writeText(addr).then(() => {
            const icon = document.querySelector(".copy-icon");
            if(icon) {
                const originalClass = icon.className;
                icon.className = "fas fa-check";
                setTimeout(() => { icon.className = originalClass; }, 2000);
            }
           showToast("Alamat Wallet Disalin!", 'success'); 
        });
    }
};

window.updateProfileUI = function(addr) {
    const OFFICIAL_ADDRESS = "0xbacc1f6e717bf03db0c40e3044da47318c369b70";
    
    const OFFICIAL_NAME = "Putramas Official";
    const OFFICIAL_LOGO = "img/icon-192.png";
    
    const nameEl = document.getElementById("displayAddress");
    const avatarEl = document.getElementById("avatarImg");

    if (addr.toLowerCase() === OFFICIAL_ADDRESS) {
        
        if (nameEl) {
            nameEl.innerHTML = `
                <span class="official-text-glow">${OFFICIAL_NAME}</span>
                <span class="official-badge" title="Verified Official">
                    <i class="fas fa-star"></i>
                </span>
            `;
        }

        if (avatarEl) {
            avatarEl.src = OFFICIAL_LOGO;
            avatarEl.classList.add("official-avatar-border");
            avatarEl.onerror = function() {
                this.src = `https://api.dicebear.com/7.x/identicon/svg?seed=${addr}&backgroundColor=00f2ea`;
            };
        }

    } else {
        
        const short = addr.substring(0, 6) + "..." + addr.substring(addr.length - 4);
        
        if (nameEl) {
            nameEl.innerText = short; 
            nameEl.classList.remove("official-text-glow"); 
        }

        if (avatarEl) {
            avatarEl.src = `https://api.dicebear.com/7.x/identicon/svg?seed=${addr}&backgroundColor=7385a5`;
            avatarEl.classList.remove("official-avatar-border");
        }
    }
};

window.loadTipData = async function(targetAddress) {
    const container = document.getElementById("tipHistoryContainer");
    const loadMoreBox = document.getElementById("loadMoreContainer");
    const elTotal = document.getElementById("displayTotalEarnings");
    const elCount = document.getElementById("displaySupporterCount");

    tipTargetAddr = targetAddress;
    container.innerHTML = `<p style="text-align:center; color:#aaa; font-size:12px;"><i class="fas fa-circle-notch fa-spin"></i> Mengambil data...</p>`;
    loadMoreBox.style.display = 'none';

    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);

    try {

        const [totalWei, countBN] = await Promise.all([
            contract.getTipTotalBalance(targetAddress),
            contract.getTipCount(targetAddress)
        ]);

        if(elTotal) elTotal.innerText = parseFloat(ethers.utils.formatEther(totalWei)).toFixed(4) + " ETH";
        const totalCount = parseInt(countBN);
        if(elCount) elCount.innerText = totalCount + " Orang";
        
        if (totalCount === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa; background:#fff; border-radius:10px; border:1px dashed #ddd;">
                <i class="fas fa-comment-slash" style="margin-bottom:5px;"></i><br>Belum ada pesan dukungan.
            </div>`;
            return;
        }

        tipCursor = totalCount - 1;

        container.innerHTML = ""; 
        await loadBatchTips(5);

    } catch (err) {
        console.error("Gagal load tips:", err);
        container.innerHTML = `<p style="color:red; text-align:center;">Gagal memuat riwayat.</p>`;
    }
};

window.loadBatchTips = async function(batchSize) {
    if (isTipLoading || tipCursor < 0) return;
    
    isTipLoading = true;
    const container = document.getElementById("tipHistoryContainer");
    const btn = document.getElementById("btnLoadMoreTips");
    const loadMoreBox = document.getElementById("loadMoreContainer");

    const originalBtnText = btn.innerHTML;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memuat...`;

    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);

    let end = tipCursor - batchSize + 1;
    if (end < 0) end = 0;

    let htmlBuffer = "";

    let animCount = 0; 

    for (let i = tipCursor; i >= end; i--) {
        try {
            const tip = await contract.getTipByIndex(tipTargetAddr, i);
            const senderShort = tip.sender.substring(0,6) + "..." + tip.sender.substring(38);
            const amount = parseFloat(ethers.utils.formatEther(tip.amount)).toFixed(4);
            const dateObj = new Date(tip.timestamp * 1000); 
            const dateStr = dateObj.toLocaleDateString("id-ID", { day: 'numeric', month: 'short', year: '2-digit' });

            htmlBuffer += `
            <div class="tip-card" style="animation-delay: ${animCount * 0.1}s;">
                <div class="tip-header">
                    <span style="display:flex; align-items:center; gap:6px; background:#f6f9ff; padding:4px 8px; border: 1px solid #7385a5; border-radius:10px; box-shadow:0 1px 4px rgba(115,133,165,0.15);">
                    <i class="fas fa-user-circle" style="color:#7385a5;"></i> 
                    <span style="font-weight:600; color:#555;">${senderShort}</span>
                    </span>
                    <span style="font-size:11px;">${dateStr}</span>
                </div>
                <div class="tip-amount">
                    <i class="fas fa-gift" style="color:#7385a5;"></i> <p style="color:#555;"> Dukung:</p> <span style="color:#27ae60;">${amount} ETH</span>
                </div>
                <div class="tip-message">
                    "${tip.message}"
                </div>
            </div>`;
            
            animCount++;

        } catch (e) {
            console.error("Skip index", i);
        }
    }

    container.insertAdjacentHTML('beforeend', htmlBuffer);

    tipCursor = end - 1;
    isTipLoading = false;
    btn.innerHTML = originalBtnText;

    if (tipCursor >= 0) {
        loadMoreBox.style.display = 'block';
    } else {
        loadMoreBox.style.display = 'none';
    }
};

window.loadNextTipBatch = function() {
    loadBatchTips(10);
};

// ==========================================
// 1. KONFIGURASI (Tweak Disini)
// ==========================================
const PROFILE_BATCH_SIZE = 10;
const CONCURRENCY_LIMIT = 3; // Ubah ke 3 agar tidak terlalu lambat, tapi tetap aman
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// ==========================================
// 2. FUNGSI INISIALISASI
// ==========================================
window.loadDataCepat = async function(targetAddress) {
    const container = document.getElementById("collectionContainer");
    const loading = document.getElementById("loading");
    const empty = document.getElementById("emptyState");
    const totalEl = document.getElementById("totalItems");
    
    // Reset
    container.innerHTML = "";
    profileGlobalIds = [];
    profileOffset = 0;
    isProfileFetching = false;
    
    // Hapus Listener Lama
    window.removeEventListener('scroll', handleProfileScroll);

    if(loading) loading.style.display = 'block';
    if(empty) empty.style.display = 'none';

    // Gunakan RPC Publik yang Stabil
    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");

    try {
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);
        const tokenIds = await contract.walletOfOwner(targetAddress);
        
        if(totalEl) totalEl.innerText = tokenIds.length;

        // Cek Badge Official
        const OFFICIAL_ADDR_LOWER = "0xbacc1f6e717bf03db0c40e3044da47318c369b70";
        if (targetAddress.toLowerCase() !== OFFICIAL_ADDR_LOWER) {
             const nameEl = document.getElementById("displayAddress");
             if (nameEl && !nameEl.innerHTML.includes("fa-check-circle") && tokenIds.length > 0) {
                 nameEl.innerHTML += ` <span style="color:#2ecc71; font-size:1em;"><i class="fa fa-check-circle"></i></span>`;
             }
        }

        // Jika Kosong
        if (tokenIds.length === 0) {
            if(loading) loading.style.display = 'none';
            if(empty) empty.style.display = 'block';
            return;
        }

        // Simpan ID Global
        profileGlobalIds = tokenIds.slice().reverse();

        if(loading) loading.style.display = 'none';

        // Load Batch Pertama
        await loadNextProfileBatch();

        // Pasang Event Scroll
        window.addEventListener('scroll', handleProfileScroll);

    } catch (err) {
        console.error("Gagal load data:", err);
        if(loading) loading.innerHTML = `<p style="color:red">Gagal memuat data Blockchain.</p>`;
    }
};

// ==========================================
// 3. BATCH LOADER (Dengan Chunking)
// ==========================================
window.loadNextProfileBatch = async function() {
    // 1. Cek Batas
    if (isProfileFetching || profileOffset >= profileGlobalIds.length) return;

    isProfileFetching = true;
    const container = document.getElementById("collectionContainer");

    // 2. Loader Bawah
    let bottomLoader = document.getElementById("bottomLoader");
    if (!bottomLoader && profileOffset > 0) {
        bottomLoader = document.createElement("div");
        bottomLoader.id = "bottomLoader";
        bottomLoader.style.cssText = "grid-column: 1/-1; text-align: center; padding: 20px; color: #7385a5; width: 100%; clear:both;";
        bottomLoader.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memuat koleksi lainnya...`;
        container.appendChild(bottomLoader);
    }

    // 3. Ambil Batch ID
    const batchIds = profileGlobalIds.slice(profileOffset, profileOffset + PROFILE_BATCH_SIZE);

    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://mainnet.base.org");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);

    // ============================================================
    // MODIFIKASI: PROSES DICICIL (CHUNKING)
    // Agar HP RAM 8GB tidak memblokir request karena terlalu cepat
    // ============================================================
    for (let i = 0; i < batchIds.length; i += CONCURRENCY_LIMIT) {
        const chunk = batchIds.slice(i, i + CONCURRENCY_LIMIT);

const chunkPromises = chunk.map(async (id) => {
    try {
        await delay(Math.random() * 100); 
        const uri = await contract.tokenURI(id);
        const meta = await fetchMetadata(uri); 

        // Return meta sesuai format baru (imageRaw)
        return { id: id.toString(), meta: meta }; 
    } catch (e) { 
        return { 
            id: id.toString(), 
            meta: { name: `Wayang #${id}`, imageRaw: null } 
        }; 
    }
});

const results = await Promise.all(chunkPromises);

results.forEach(item => {
    if (item && !document.getElementById(`card-${item.id}`)) {
        // Perhatikan parameter ke-3 sekarang 'item.meta.imageRaw'
        renderCard(item.id, item.meta.name, item.meta.imageRaw, container);
    }
});

        // Istirahat sebentar (Napas) sebelum lanjut
        await delay(200);
    }
    // ============================================================

    if (bottomLoader) bottomLoader.remove();

    profileOffset += PROFILE_BATCH_SIZE;
    isProfileFetching = false;
    
    // Auto-Fill jika layar belum penuh (Biar scrollbar muncul)
    if ((document.documentElement.scrollHeight <= window.innerHeight + 100) && (profileOffset < profileGlobalIds.length)) {
         loadNextProfileBatch();
    }
};
    
window.handleProfileScroll = function() {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const docHeight = document.documentElement.scrollHeight;

    // Load jika sisa 300px dari bawah
    if (scrollTop + windowHeight >= docHeight - 300) {
        loadNextProfileBatch();
    }
};

// ==========================================
// 4. FETCH METADATA (Perbaikan Gambar dengan Loop Gateway)
// ==========================================
window.fetchMetadata = async function(tokenURI) {
    // Kita pakai Cloudflare karena ini gateway publik paling stabil & cepat saat ini
    const GATEWAY = "https://magenta-secondary-guan-686.mypinata.cloud/ipfs/";
    
    try {
        // Bersihkan URI
        const cid = tokenURI.replace("ipfs://", "").replace("https://ipfs.io/ipfs/", "");
        const url = `${GATEWAY}${cid}`;
        
        // Timeout 3 detik. Kalau kelamaan, anggap gagal biar gak bikin macet.
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error("Gagal Fetch");
        
        const json = await response.json();
        
        // Ambil Raw URL Gambar
        let img = json.image || json.image_url || "";
        
        // Kita return URL mentahnya saja (CID), nanti dirakit di renderCard
        // Ini biar proses fetch JS cepat selesai
        return { 
            name: json.name || `Wayang #${cid.substring(0,4)}`, 
            imageRaw: img // Kita simpan raw-nya
        };

    } catch (e) {
        // Kalau JSON metadata gagal diambil, tetap return objek
        // Biar kartu tetap muncul walau tanpa nama (bisa direvisi nanti)
        return { 
            name: `Wayang #${tokenURI.substring(0, 5)}...`, 
            imageRaw: null 
        };
    }
};
    
window.renderCard = function(id, name, imgRaw, container) {
    // Cek duplikasi
    if (document.getElementById(`card-${id}`)) return;

    let isMyProfile = false;
    if (typeof viewerAddress !== 'undefined' && typeof currentAddress !== 'undefined') {
        if(viewerAddress && currentAddress) {
            isMyProfile = viewerAddress.toLowerCase() === currentAddress.toLowerCase();
        }
    }

    let badgeHtml = isMyProfile 
        ? `<span class="owned-badge" style="background:#f1c40f; color:#fff;"><i class="fas fa-check-circle"></i> Milik Anda</span>`
        : `<span class="owned-badge" style="background:#2ecc71; color:#fff;"><i class="fas fa-shield-alt"></i> Terverifikasi</span>`;
    
    let editBtn = isMyProfile 
        ? `<button onclick="window.location.href='revisi?id=${id}'" style="border:none; background:#d35400; color:white; font-weight: bold; border-radius:5px; font-size:9px; padding:2px 7px; cursor:pointer; margin-left:5px;"><i class="fas fa-edit"></i> Revisi</button>`
        : ``;

    // --- LOGIKA URL GAMBAR ---
    let srcUtama = "img/placeholder.jpg";
    let srcBackup1 = "img/placeholder.jpg";
    let srcBackup2 = "img/placeholder.jpg";

    if (imgRaw) {
        // Bersihkan CID
        const cid = imgRaw.replace("ipfs://", "").replace("https://ipfs.io/ipfs/", "");
        
        // Prioritas 1: Cloudflare (Cepat)
        srcUtama = `https://cloudflare-ipfs.com/ipfs/${cid}`;
        
        // Prioritas 2: Pinata (Cadangan)
        srcBackup1 = `https://gateway.pinata.cloud/ipfs/${cid}`;
        
        // Prioritas 3: IPFS.io (Lambat tapi pasti)
        srcBackup2 = `https://ipfs.io/ipfs/${cid}`;
    }

    const html = `
    <div class="wayang-card" id="card-${id}" style="animation: fadeIn 0.5s ease;">
        <div style="position:relative;">
            ${badgeHtml} 
            <div class="card-img-container">
                <img src="${srcUtama}" 
                     loading="lazy" 
                     alt="${name}" 
                     style="width:100%; height:100%; object-fit:contain;"
                     onerror="this.onerror=null; this.src='${srcBackup1}'; this.onerror=function(){this.src='${srcBackup2}'; this.onerror=function(){this.src='img/placeholder.jpg';}};">
            </div>
        </div>
        <div class="card-body">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                <span class="card-id">ID #${id}</span>
                ${editBtn}
            </div>
            <h4 class="card-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</h4>
            
            <div style="margin-top:10px; display:flex; gap:8px;">
                <a href="detail?id=${id}" class="btn-detail" title="Detail" style="flex:1; display:flex; justify-content:center; align-items:center; text-decoration:none;">
                   <i class="fas fa-arrow-left"></i>
                </a>
                <button onclick="event.stopPropagation(); window.panggilSawerDetail('${currentAddress}', '${name}')" 
                        class="btn-detail" title="Sawer" style="flex:1; border:none;">
                     <i class="fas fa-gift"></i>
                </button>
            </div>
        </div>
    </div>`;

    container.insertAdjacentHTML('beforeend', html);
};

window.panggilSawerDetail = async function(address, name) {
    if (!window.ethereum) return showToast("MetaMask tidak ditemukan!", 'error');
    
    if (!signer || !viewerAddress) {
        window.showToast("Hubungkan wallet dulu!", "warning");
        await window.connectWallet();
        return;
    }

    if (viewerAddress.toLowerCase() === address.toLowerCase()) {
        window.showToast("Tidak bisa menyawer diri sendiri!", "error");
        return;
    }

    sawerTargetAddress = address;

    document.getElementById("sawerReceiverName").innerText = name;
    document.getElementById("sawerReceiverAddr").innerText = address.substring(0, 10) + "..." + address.substring(address.length - 8);
    document.getElementById("sawerAmount").value = "";
    document.getElementById("sawerMessage").value = "";

    try {
        const balanceBN = await provider.getBalance(viewerAddress);
        const ethVal = ethers.utils.formatEther(balanceBN);
        
        const elSaldo = document.getElementById("sawerUserBalance");
        elSaldo.innerText = parseFloat(ethVal).toFixed(8) + " ETH";
        elSaldo.setAttribute('data-balance', ethVal);
    } catch (e) {
        console.error(e);
        document.getElementById("sawerUserBalance").innerText = "Error";
    }

    window.toggleSawerModal(true);
};

window.setSawerPercent = function(percent) {
    const elSaldo = document.getElementById("sawerUserBalance");
    const rawBalance = elSaldo.getAttribute('data-balance');
    
    if (!rawBalance) return;

    let balanceEth = parseFloat(rawBalance);
    let maxSafeUser = balanceEth - 0.0000055; 
    if (maxSafeUser < 0) maxSafeUser = 0;

    let effectiveLimit = Math.min(maxSafeUser, MAX_TIP); 

    let amount = 0;
    if (percent === 'MIN') {
        amount = MIN_TIP;
    } else {
        amount = (effectiveLimit * percent) / 100;
    }

    if (amount < MIN_TIP) amount = (maxSafeUser >= MIN_TIP) ? MIN_TIP : 0;
    if (amount > effectiveLimit) amount = effectiveLimit;

    if (amount > 0) {
        document.getElementById("sawerAmount").value = parseFloat(amount.toFixed(5)); 
    } else {
        window.showToast("Saldo tidak cukup untuk gas fee.", 'error');
    }
};

window.eksekusiSawer = async function() {
    const amountVal = document.getElementById("sawerAmount").value;
    const btn = document.getElementById("btnKirimSawer");

    if (!amountVal || amountVal < MIN_TIP || amountVal > MAX_TIP) {
        window.showToast(`Nominal harus ${MIN_TIP} - ${MAX_TIP} ETH`, 'warning');
        return;
    }

    try {
        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memproses...`;
        btn.disabled = true;

        const amountWei = ethers.utils.parseEther(amountVal.toString());
        const messageVal = document.getElementById("sawerMessage").value || "-";
        const contractWrite = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        const tx = await contractWrite.sendTip(sawerTargetAddress, messageVal, {
            value: amountWei
        });
        
        window.toggleSawerModal(false); 
        window.showToast("Transaksi dikirim! Menunggu konfirmasi...", 'loading');

        await tx.wait();
        
        window.showToast(`Sukses kirim ${amountVal} ETH!`, 'success');

        if(typeof updateModalWalletData === 'function' && viewerAddress) {
            window.updateModalWalletData(viewerAddress);
        }

    }
    catch (err) {
        console.error(err);
        let msg = err.reason || err.message;
        if(err.code === "ACTION_REJECTED" || err.code === 4001) msg = "Dibatalkan user.";
        else if(msg.includes("insufficient funds")) msg = "Saldo kurang (Gas Fee).";
        
        window.showToast("Gagal: " + msg, 'error');
    } finally {
        btn.innerHTML = `<i class="fas fa-paper-plane"></i> Kirim Apresiasi`;
        btn.disabled = false;
    }
};

async function updateModalWalletData(addr) {
    if(!addr) return;
    modalUserAddr = addr;

    const listEl = document.getElementById("modalHistoryList");
    const balEl = document.getElementById("modalTipBalance");
    const badgeEl = document.getElementById("modalTipCountBadge");
    const btnMore = document.getElementById("btnModalLoadMore");
    
    if(listEl) listEl.innerHTML = `<div style="text-align:center; padding:10px; color:#7385a5;"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>`;
    if(btnMore) btnMore.style.display = 'none';

    try {
        let readProvider;
        if (provider) {
            readProvider = provider;
        } else {
            readProvider = new ethers.providers.JsonRpcProvider("https://mainnet.base.org");
        }

        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

        const totalWei = await contract.getTipTotalBalance(addr);
        const totalEth = parseFloat(ethers.utils.formatEther(totalWei)).toFixed(8);

        if(balEl) {
            balEl.innerText = totalEth + " ETH";
            balEl.style.color = totalEth > 0 ? "#7385a5" : "#888";
        }

        const countBN = await contract.getTipCount(addr);
        const count = parseInt(countBN.toString()); 
        
        if(badgeEl) badgeEl.innerText = count;

        if (count === 0) {
            if(listEl) listEl.innerHTML = `<p style="text-align:center; font-size:11px; color:#aaa; margin-top:10px;">Belum ada riwayat masuk.</p>`;
            return;
        }

        modalTipCursor = count - 1; 
        if(listEl) listEl.innerHTML = "";
        
        await loadNextModalTips(); 

    } catch (e) {
        console.error("Gagal update modal data:", e);

        if(listEl) listEl.innerHTML = `<p style="color:red; font-size:10px; text-align:center;">Gagal koneksi ke Blockchain.<br>Coba refresh.</p>`;
    }
}
            
async function loadNextModalTips() {
    if(isModalFetching || modalTipCursor < 0) return;
    
    isModalFetching = true;
    const container = document.getElementById("modalHistoryList");
    const btnMore = document.getElementById("btnModalLoadMore");
    
    if(btnMore) btnMore.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memuat...`;

    let readProvider;
    if (provider) {
        readProvider = provider;
    } else {
        readProvider = new ethers.providers.JsonRpcProvider("https://mainnet.base.org");
    }

    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

    let end = modalTipCursor - 3 + 1;
    if(end < 0) end = 0;

    let html = "";

    for (let i = modalTipCursor; i >= end; i--) {
        try {
            const tip = await contract.getTipByIndex(modalUserAddr, i);
            const senderShort = tip.sender.substring(0,4) + ".." + tip.sender.substring(38);
            const amount = parseFloat(ethers.utils.formatEther(tip.amount)).toFixed(4);
            const msg = (tip.message && tip.message !== "") ? tip.message : "Tanpa pesan";

            html += `
            <div class="mini-history-item" style="animation: fadeIn 0.3s;">
                <div style="flex:1; overflow:hidden;">
                    <div class="mini-sender" style="display:flex; align-items:center; gap:4px;">
                        <i class="fas fa-user-circle" style="color:#7385a5;"></i> ${senderShort}
                    </div>
                    <span class="mini-msg" title="${msg}">${msg}</span>
                </div>
                <div class="mini-amount">+${amount} ETH</div>
            </div>`;
        } catch (e) {
            console.log("Skip error item index:", i);
        }
    }

    container.insertAdjacentHTML('beforeend', html);

    modalTipCursor = end - 1;
    isModalFetching = false;

    if(btnMore) {
        if(modalTipCursor >= 0) {
            btnMore.style.display = 'block';
            btnMore.innerHTML = `Muat 3 Lagi <i class="fas fa-chevron-down"></i>`;
        } else {
            btnMore.style.display = 'none';
        }
    }
}

window.toggleSawerModal = function(show) {
    const modal = document.getElementById("sawerModal");
    if (show) {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
    } else {
        modal.classList.remove("active");
        setTimeout(() => modal.style.display = "none", 300);
    }
};

window.closeSawer = function(e) {
    if (e.target.id === "sawerModal") window.toggleSawerModal(false);
};

window.copyAddress = function() {
    if(currentAddress) {
        navigator.clipboard.writeText(currentAddress);
        const btnText = document.getElementById("btnCopyText");
        if(btnText) {
            btnText.innerText = "Disalin!";
            setTimeout(() => btnText.innerText = "Salin Alamat", 2000);
        }
    }
};

window.cariProfile = function() {
    const input = document.getElementById("inputAddress").value.trim();
    if (input) window.location.href = `?address=${input}`;
};

window.handleEnter = function(e) { if (e.key === "Enter") cariProfile(); };

window.showToast = function(msg, type = 'info') {
    const x = document.getElementById("toast");

    const icons = {
        info: 'img/info-icon.svg',
        load: 'img/load.svg',
        loading: 'img/loading.svg',
        success: 'img/success.svg',
        error: 'img/error.svg',
        warning: 'img/warning.svg',
        wolf: 'img/wolf.svg'
    };

    const closeIcon = 'img/x.svg'; 

    if (!icons[type]) type = 'info';

    x.innerHTML = `
        <img src="${icons[type]}" class="toast-icon" alt="${type}"> 
        <span style="flex:1;">${msg}</span>
        <img src="${closeIcon}" class="toast-close" onclick="this.parentElement.className = this.parentElement.className.replace('show', '')" alt="close">
    `;

    x.className = ''; 
    void x.offsetWidth; 
    x.className = `show ${type}`;

    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { 
        x.className = x.className.replace("show", ""); 
    }, 10000); 
    }

window.addEventListener('DOMContentLoaded', () => {
    initGatekeeper();
    if(document.getElementById("year")) document.getElementById("year").innerText = new Date().getFullYear();
});

if(window.ethereum) {
    window.ethereum.on('accountsChanged', () => {
        localStorage.removeItem('userWallet');
        window.location.reload();
    });
    }
</script>
</body>
</html>
