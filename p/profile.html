<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruang Pusaka - Profil Kolektor</title>
    
    <link rel="icon" href="/img/favicon.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <style>
        /* --- STYLE PREMIUM (Tetap Sama) --- */
        body { font-family: 'Poppins', sans-serif; background-color: #f6f9ff; color: #333; margin: 0; padding: 0; }
        .navbar { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 700; color: #7385a5; font-size: 18px; text-decoration: none; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 80vh; }
        
        /* LOGIN WALL */
        .login-wall { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; text-align: center; animation: fadeIn 0.5s ease; }
        .lock-icon { font-size: 50px; color: #7385a5; margin-bottom: 20px; background: #e9f0ff; width: 100px; height: 100px; line-height: 100px; border-radius: 50%; box-shadow: 0 10px 30px rgba(115, 133, 165, 0.2); }
        .btn-connect-big { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(115, 133, 165, 0.3); display: flex; align-items: center; gap: 10px; }
        .btn-connect-big:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); }

        /* CONTENT */
        #mainContent { display: none; }
        
        /* PROFILE CARD */
        .profile-card { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border-radius: 25px; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); position: relative; overflow: hidden; margin-bottom: 30px; text-align: center; }
        .profile-card::before { content: ''; position: absolute; top: -50%; left: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        @media (min-width: 768px) { .profile-card { flex-direction: row; text-align: left; justify-content: space-between; } .profile-info-wrapper { display: flex; align-items: center; gap: 20px; } }
        
        .profile-avatar img { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); object-fit: cover; background: #fff; }
        .profile-details h2 { margin: 0; font-size: 16px; font-family: 'Courier New', monospace; letter-spacing: 0.5px; margin-bottom: 5px; }
        .badges { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        @media (min-width: 768px) { .badges { justify-content: flex-start; } }
        .badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        
        .btn-copy { background: rgba(255,255,255,0.9); color: #7385a5; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-copy:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .section-title { color: #7385a5; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        
        /* GRID SYSTEM */
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .wayang-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #eee; position: relative; }
        .wayang-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card-body { padding: 12px; }
        .card-title { font-size: 14px; font-weight: bold; color: #5c6a84; margin: 0; }
        .card-id { font-size: 11px; color: #999; margin-bottom: 8px; display: block; }
        .btn-detail { display: block; width: 100%; text-align: center; background: #e9f0ff; color: #7385a5; text-decoration: none; padding: 8px 0; border-radius: 8px; font-size: 12px; font-weight: bold; transition: 0.2s; }
        .btn-detail:hover { background: #7385a5; color: white; }
        .owned-badge { position: absolute; top: 10px; right: 10px; background: #f1c40f; color: white; font-size: 10px; padding: 4px 8px; border-radius: 8px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        .state-box { text-align: center; padding: 50px 20px; color: #7385a5; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        /* --- SEARCH CAPSULE STYLE (FIXED) --- */
.search-capsule {
    background: white;
    border-radius: 50px;
    /* Remove internal padding so the button can touch the edge */
    padding: 0; 
    display: flex;
    align-items: center;
    gap: 0; /* Remove gap, handle spacing via padding on elements */
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid #eef2f7;
    margin-bottom: 25px;
    transition: 0.3s;
    height: 50px; /* Set fixed height for consistency */
    overflow: hidden; /* Ensures button stays inside border radius */
}

.search-capsule:focus-within {
    box-shadow: 0 8px 25px rgba(115, 133, 165, 0.15);
    border-color: #dbe4f3;
    transform: translateY(-2px);
}

.search-icon {
    color: #b0b8c4;
    font-size: 16px;
    padding-left: 20px; /* Add padding here instead of container */
}

.search-capsule input {
    border: none;
    outline: none;
    flex: 1; 
    font-size: 14px;
    font-family: 'Poppins', sans-serif;
    color: #5c6a84;
    background: transparent;
    height: 100%; /* Fill height */
    padding-left: 15px; /* Space between icon and text */
}

.search-capsule input::placeholder {
    color: #b0b8c4;
}

.btn-search {
    background: #7385a5;
    color: white;
    border: none;
    /* Height 100% to fill the capsule vertically */
    height: 100%; 
    padding: 0 30px; /* Adjust width via horizontal padding */
    border-radius: 0 50px 50px 0; /* Only curve right side */
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: 0.3s;
    letter-spacing: 1px;
    /* Fix alignment issues */
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-search:hover {
    background: #5c6a84;
    /* No scale transform to keep it fitted inside */
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1); 
}

/* Mobile Responsive */
@media (max-width: 480px) {
    .search-capsule {
        /* On mobile, keep height but adjust padding if needed */
    }
    .search-icon { display: none; }
    .search-capsule input { padding-left: 20px; }
    .btn-search { padding: 0 20px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="logo"><i class="fas fa-arrow-left"></i> Kembali</a>
        <div style="font-weight:bold; color:#5c6a84;">Profil Kolektor</div>
    </nav>

    <div id="loginSection" class="login-wall">
        <div class="lock-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h2 style="color:#5c6a84; margin-bottom:5px;">Akses Ruang Pusaka</h2>
        <p style="color:#8898aa; max-width: 350px;">
            Hubungkan dompet Web3 Anda untuk membuka sertifikat kepemilikan dan data pusaka.
        </p>
        <button onclick="requestLogin()" class="btn-connect-big" id="btnLogin">
            <i class="fas fa-wallet"></i> Buka Akses
        </button>
    </div>

    <div id="mainContent" class="container">

        <div class="search-capsule">
    <div class="search-icon">
        <i class="fas fa-search"></i>
    </div>
    <input type="text" id="inputAddress" placeholder="Masukan Alamat Wallet Kolektor" onkeypress="handleEnter(event)">
    <button onclick="cariProfile()" class="btn-search">
        CARI
    </button>
        </div>
        
        <div class="profile-card">
            <div class="profile-info-wrapper">
                <div class="profile-avatar">
                    <img src="" id="avatarImg" alt="Avatar">
                </div>
                <div class="profile-details">
                    <h2 id="displayAddress">Loading...</h2>
                    <div class="badges">
                        <span class="badge"><i class="fas fa-crown"></i> Owner</span>
                        <span class="badge" style="background:rgba(255,255,255,0.3);"><i class="fas fa-cube"></i> <span id="totalItems">0</span> Koleksi</span>
                    </div>
                </div>
            </div>

            <button onclick="copyAddress()" class="btn-copy">
                <i class="far fa-copy"></i> <span id="btnCopyText">Salin Alamat</span>
            </button>
        </div>

        <h3 class="section-title">
            <i class="fas fa-box-open"></i> Koleksi/Karya
        </h3>

        <div id="loading" class="state-box">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i>
            <p id="loadingText">Membaca data Blockchain...</p>
        </div>

        <div id="emptyState" class="state-box" style="display: none;">
            <i class="fas fa-ghost" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>Belum ada Pusaka Wayang yang diadopsi.</p>
            <a href="index.html" style="color:#7385a5; font-weight:bold;">Cari Wayang</a>
        </div>

        <div id="collectionContainer" class="collection-grid"></div>

    </div>

    <script>
        // --- CONFIG ---
        const CONTRACT_ADDRESS = "0x29f19E566380DC680357d30fbfFc7EB7DD02947B"; 
        
        // ABI Full (Saya masukkan semua biar fungsi walletOfOwner jalan)
        const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramasOfficial.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramasOfficial.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
            
        let currentAddress = null;
        let provider, contract;

        // --- SCRIPT SAKTI (INIT) ---
        async function init() {
            // 1. Cek Mode Intip (URL Parameter)
            const urlParams = new URLSearchParams(window.location.search);
            const addressParam = urlParams.get('address');

            if (addressParam) {
                unlockGate(addressParam); // Langsung buka punya orang lain
                return;
            }

            // 2. Cek Cache LocalStorage (Fitur Anti-Login Ulang)
            const cachedAddr = localStorage.getItem('userWallet');
            if (cachedAddr) {
                // Jika ada cache, buka gerbang dulu biar cepat (Optimistic UI)
                unlockGate(cachedAddr);
                
                // Tapi tetap verifikasi diam-diam di background (Security Check)
                if(window.ethereum) verifyConnection(cachedAddr);
            }
        }

        // Verifikasi diam-diam (Silent Check)
        async function verifyConnection(cachedAddr) {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await provider.listAccounts();
            if (accounts.length === 0 || accounts[0].toLowerCase() !== cachedAddr.toLowerCase()) {
                // Jika user logout di metamask, kita kunci lagi & hapus cache
                localStorage.removeItem('userWallet');
                location.reload(); 
            }
        }

        // Fungsi Login Tombol
        async function requestLogin() {
            const btn = document.getElementById("btnLogin");
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Menghubungkan...`;
            
            try {
                if (!window.ethereum) throw new Error("No Wallet");
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const address = await signer.getAddress();
                
                // SIMPAN KE LOCAL STORAGE (Script Sakti)
                localStorage.setItem('userWallet', address);

                unlockGate(address);
            } catch (err) {
                console.error(err);
                btn.innerHTML = `<i class="fas fa-wallet"></i> Buka Akses`;
                alert("Koneksi gagal.");
            }
        }

        // Fungsi Buka Gerbang & Load Data
        function unlockGate(addr) {
            currentAddress = addr;
            
            // UI Switch
            document.getElementById("loginSection").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            
            updateProfileUI(currentAddress);
            loadDataCepat(currentAddress); // Pakai fungsi baru yang cepat
        }

        function updateProfileUI(addr) {
            const short = addr.substring(0, 6) + "..." + addr.substring(addr.length - 4);
            document.getElementById("displayAddress").innerText = short;
            document.getElementById("avatarImg").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${addr}&backgroundColor=7385a5`;
        }

        // --- CORE LOGIC TERBARU (PAKAI walletOfOwner) ---
        async function loadDataCepat(targetAddress) {
            const container = document.getElementById("collectionContainer");
            const loading = document.getElementById("loading");
            const empty = document.getElementById("emptyState");
            
            // Inisialisasi Provider (Jika belum ada karena load dari cache)
            if (!provider && window.ethereum) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
            } else if (!provider) {
                // Fallback provider publik (biar user non-wallet bisa lihat profil orang)
                provider = new ethers.providers.JsonRpcProvider("https://mainnet.base.org"); 
            }

            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
            container.innerHTML = "";

            try {
                // 1. PANGGIL FUNGSI SAKTI: walletOfOwner
                // Ini langsung mengembalikan ARRAY ID yang dimiliki [1, 5, 20]
                // Tidak perlu loop 1-50, jadi super cepat.
                const tokenIds = await contract.walletOfOwner(targetAddress);
                
                // Update Badge Total
                document.getElementById("totalItems").innerText = tokenIds.length;

                if (tokenIds.length === 0) {
                    loading.style.display = 'none'; // STOP LOADING
                    empty.style.display = 'block';
                    return;
                }

                // 2. Loop hanya ID yang dimiliki saja
                for (let i = 0; i < tokenIds.length; i++) {
                    const id = tokenIds[i]; // Ini tipe BigNumber
                    
                    const uri = await contract.tokenURI(id);
                    const meta = await fetchMetadata(uri);
                    
                    renderCard(id.toString(), meta.name, meta.image, container);
                }

                // 3. STOP LOADING SETELAH SELESAI
                loading.style.display = 'none';

            } catch (err) {
                console.error("Gagal load data:", err);
                loading.innerHTML = `<p style="color:red">Gagal memuat data Blockchain.</p>`;
            }
        }

        async function fetchMetadata(tokenURI) {
            try {
                let url = tokenURI.replace("ipfs://", "https://ipfs.io/ipfs/");
                const response = await fetch(url);
                const json = await response.json();
                let img = json.image ? json.image.replace("ipfs://", "https://ipfs.io/ipfs/") : "img/placeholder.jpg";
                return { name: json.name || `Wayang #${json.id}`, image: img };
            } catch (e) {
                return { name: "Data Error", image: "img/placeholder.jpg" };
            }
        }

        function renderCard(id, name, img, container) {
    // Kita ambil owner dari variable global 'currentAddress' 
    // karena halaman ini memang menampilkan koleksi milik address tersebut.
    const ownerOfThisItem = currentAddress; 

    const html = `
        <div class="wayang-card">
            <div style="position:relative;">
                <span class="owned-badge"><i class="fas fa-check"></i> MILIK ANDA</span>
                <img src="${img}" class="card-img" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
            </div>
            
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="card-id" style="margin:0;">ID #${id}</span>
                    
                    <button onclick="handleEditClick('${id}', '${ownerOfThisItem}')" 
                         title="Revisi Data" 
                         style="background:#d35400; color:#fff; padding:4px 10px; border-radius:5px; 
                         font-size:10px; font-weight:bold; border:none; 
                         cursor:pointer; display:inline-flex; align-items:center; gap:4px; 
                         box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.2s;">
                         <i class="fas fa-edit"></i> Revisi
                    </button>
                </div>

                <h4 class="card-title">${name}</h4>
                
                <div style="margin-top:10px;">
                    <a href="detail.html?id=${id}" class="btn-detail">
                        Lihat Sertifikat
                    </a>
                </div>
            </div>
        </div>
    `;
    container.innerHTML += html;
 }

        // --- LOGIKA TOMBOL REVISI ---

function handleEditClick(id, owner) {
    // 1. Cek apakah Wallet di Browser terhubung?
    if (!window.ethereum || !provider) {
        showToast("Hubungkan wallet dulu!", 'warning');
        return;
    }

    // 2. Ambil Wallet yang sedang Login di Metamask saat ini
    // (Bukan address profil yang sedang dilihat, tapi yang sedang aktif di extension)
    provider.listAccounts().then(accounts => {
        const loggedInUser = accounts[0];

        if (!loggedInUser) {
            showToast("Wallet terkunci/belum connect.", 'error');
            return;
        }

        // 3. Validasi: Apakah yang login = Pemilik barang?
        if (loggedInUser.toLowerCase() !== owner.toLowerCase()) {
            showToast("Eits! Anda bukan pemilik pusaka ini.", 'error');
            return;
        }

        // 4. Lolos Validasi -> Gas ke halaman revisi
        // (Pastikan file revisi.html atau revisi/index.html ada)
        window.location.href = `revisi?id=${id}`;
    });
}

        function copyAddress() {
            if(currentAddress) {
                navigator.clipboard.writeText(currentAddress);
                const btnText = document.getElementById("btnCopyText");
                btnText.innerText = "Disalin!";
                setTimeout(() => btnText.innerText = "Salin", 2000);
            }
        }

        // --- FITUR PENCARIAN PROFIL ---

function cariProfile() {
    const input = document.getElementById("inputAddress");
    const address = input.value.trim();

    // 1. Validasi Input Kosong
    if (!address) {
        showToast("Masukkan alamat wallet dulu!", 'warning');
        return;
    }

    // 2. Validasi Format Ethereum (Harus 0x... dan panjang 42)
    // Regex sederhana untuk cek address ETH
    const isAddress = /^0x[a-fA-F0-9]{40}$/.test(address);

    if (!isAddress) {
        showToast("Format alamat tidak valid! (Harus 0x...)", 'error');
        return;
    }

    // 3. Eksekusi Pencarian
    // Kita reload halaman dengan parameter address baru
    const btn = document.querySelector(".btn-search");
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`; // Loading effect
    
    setTimeout(() => {
        window.location.href = `profile?address=${address}`;
    }, 500); // Delay dikit biar animasi kelihatan
}

// Fitur: Tekan Enter untuk mencari
function handleEnter(e) {
    if (e.key === "Enter") {
        cariProfile();
    }
}

        // Auto Reload jika akun berubah di metamask
        if(window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
                localStorage.removeItem('userWallet'); // Hapus cache lama
                window.location.reload();
            });
        }

        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
