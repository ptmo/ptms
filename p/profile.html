<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruang Koleksi - Profile Kolektor</title>
    
    <link rel="icon" href="/img/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/img/icon-512.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
      body { font-family: 'Poppins', sans-serif; background-color: #f6f9ff; color: #333; margin: 0; padding: 0; }
        .navbar { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 700; color: #7385a5; font-size: 18px; text-decoration: none; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 80vh; }
        
        .login-wall { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; text-align: center; animation: fadeIn 0.5s ease; }
        .lock-icon { font-size: 50px; color: #7385a5; margin-bottom: 20px; background: #e9f0ff; width: 100px; height: 100px; line-height: 100px; border-radius: 50%; box-shadow: 0 10px 30px rgba(115, 133, 165, 0.2); }
        .btn-connect-big { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(115, 133, 165, 0.3); display: flex; align-items: center; gap: 10px; }
        .btn-connect-big:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); }

        #mainContent { display: none; }
        
        .profile-card { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border-radius: 25px; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); position: relative; overflow: hidden; margin-bottom: 30px; text-align: center; }
        .profile-card::before { content: ''; position: absolute; top: -50%; left: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        @media (min-width: 768px) { .profile-card { flex-direction: row; text-align: left; justify-content: space-between; } .profile-info-wrapper { display: flex; align-items: center; gap: 20px; } }
        
        .profile-avatar img { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); object-fit: cover; background: #fff; }
        .profile-details h2 { margin: 0; font-size: 13px; font-family: 'Courier New', monospace; letter-spacing: 0.5px; margin-bottom: 5px; }
        .badges { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        @media (min-width: 768px) { .badges { justify-content: flex-start; } }
        .badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        
        .btn-copy { background: rgba(255,255,255,0.9); color: #7385a5; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-copy:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .section-title { color: #7385a5; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }

        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .wayang-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #eee; position: relative; }
        .wayang-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card-img { 
    width: 100%; 
    height: 180px; 
    /* Mengatur agar gambar pas di dalam kotak tanpa terpotong */
    object-fit: contain; 
    /* Memastikan gambar berada di tengah (Horizontal & Vertikal) */
    object-position: center; 
    background: #f8f9fa; 
    /* Gunakan box-sizing agar padding tidak merusak ukuran lebar 100% */
    box-sizing: border-box; 
    padding: 10px;
    display: block;
        }

    /* Container pembungkus gambar di dalam kartu */
.card-img-container {
    width: 100%;
    height: 180px;
    background: #f8f9fa;
    display: flex;
    align-items: center;    /* Tengah vertikal */
    justify-content: center; /* Tengah horizontal */
    overflow: hidden;
    padding: 10px;
    box-sizing: border-box;
}

.card-img-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
        .card-body { padding: 12px; }
        .card-title { font-size: 11px; font-weight: bold; color: #5c6a84; margin: 0; }
        .card-id { font-size: 11px; color: #999; margin-bottom: 8px; display: block; }
        .btn-detail { display: block; width: 100%; text-align: center; background: #e9f0ff; color: #7385a5; text-decoration: none; padding: 8px 0; border-radius: 8px; font-size: 12px; font-weight: bold; transition: 0.2s; }
        .btn-detail:hover { background: #7385a5; color: white; }
        .owned-badge { position: absolute; top: 10px; right: 10px; background: #f1c40f; color: white; font-size: 6px; padding: 2px 4px; border-radius: 8px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        .state-box { text-align: center; padding: 50px 20px; color: #7385a5; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

.search-capsule {
    background: white;
    border-radius: 50px;
    padding: 0; 
    display: flex;
    align-items: center;
    gap: 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 2px solid #7385a5;
    margin-bottom: 25px;
    transition: 0.3s;
    height: 50px;
    overflow: hidden;
}

.search-capsule:focus-within {
    box-shadow: 0 8px 25px rgba(115, 133, 165, 0.15);
    border-color: #dbe4f3;
    transform: translateY(-2px);
}

.search-icon {
    color: #b0b8c4;
    font-size: 16px;
    padding-left: 20px;
}

.search-capsule input {
    border: none;
    outline: none;
    flex: 1; 
    font-size: 14px;
    font-family: 'Poppins', sans-serif;
    color: #5c6a84;
    background: transparent;
    height: 100%;
    padding-left: 15px;
}

.search-capsule input::placeholder {
    color: #b0b8c4;
}

.btn-search {
    background: #7385a5;
    color: white;
    border: none;
    height: 100%; 
    padding: 0 20px; 
    font-size: 16px; 
    border-radius: 0 50px 50px 0;
    cursor: pointer;
    transition: 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-search:hover {
    background: #5c6a84;
    border: 2px solid #5c6a84;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5); 
}

@media (max-width: 480px) {
    .search-capsule {
    }
    .search-icon { display: none; }
    .search-capsule input { padding-left: 20px; }
    .btn-search { padding: 0 20px; }
        }

        .footer { background: #fff; padding: 15px; text-align: center; margin-top: auto; border-top: 1px solid #eee; }
        .copyright { color: #888; font-size: 13px; }

        #btn-connect {
            background: transparent; color: #7385a5; border: 2px solid #7385a5; 
            padding: 10px 25px; cursor: pointer; font-family: 'Rubik', sans-serif; 
            font-weight: bold; border-radius: 30px; transition: 0.3s; font-size: 14px;
        }
        #btn-connect:hover { background: #f6f9ff; color: #7385a5; border: 2px solid #7385a5; }
        #btn-connect.connected { background: #7385a5; color: #fff; border-color: #abb6c9; cursor: default; }
        @media (max-width: 600px) {
            .navbar { padding: 15px 20px; }
            .nav-brand { font-size: 0.9em; }
            #btn-connect { padding: 8px 15px; font-size: 12px; }
            h1 { font-size: 2em; }
                 }
                 
     #toast {
    visibility: hidden;
    min-width: 220px;
    max-width: 85%;
    position: fixed;
    z-index: 99999;
    top: 90px;
    right: 20px;
    left: auto;
    background-color: rgba(51, 51, 51, 0.95);
    backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    padding: 10px 35px 10px 15px; 
    display: flex;
    align-items: center;
    font-family: 'Rubik', sans-serif;
    font-weight: 500;
    font-size: 11px;
    letter-spacing: 0.3px;
    opacity: 0;
    transform: translateX(20px) scale(0.9); 
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0.4s; 
}

#toast.show {
    visibility: visible;
    opacity: 1;
    transform: translateX(0) scale(1);
    transition: all 0.4s cubic-bezier(0.2, 0, 0, 1), visibility 0s 0s;
}
    
#toast .toast-icon {
    width: 23px;
    height: 23px; 
    margin-right: 10px; 
    object-fit: contain;
}

#toast .toast-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 9px;
    height: 9px;
    cursor: pointer;
    opacity: 0.6;
    transition: 0.2s;
}

        #toast .toast-close:hover { opacity: 1; transform: scale(1.1); }

    #toast.info {
    background: rgba(0, 53, 107, 0.35);
    border: 1px solid rgba(0, 100, 204, 0.4);
    color: #fff;
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0, 100, 255, 0.25);
}

#toast.success {
    background: rgba(0, 77, 7, 0.35);
    color: #fff;
    border: 1px solid rgba(0, 184, 15, 0.4);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.35), 0 0 20px rgba(0,255,0,0.2);
}

#toast.error {
    background: rgba(107, 0, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(184, 0, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 22px rgba(255,0,0,0.25);
    }

#toast.warning {
    background: rgba(102, 98, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(179, 171, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.40), 0 0 20px rgba(255,255,0,0.25);
}

#toast.wolf {
    background: rgba(125, 65, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(204, 106, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(255,140,0,0.25);
}

#toast.load {
    background: rgba(49, 77, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(104, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(0,255,0,0.25);
}
    
#toast.loading {
    background: rgba(52, 90, 0, 0.35);
    color: #fff;
    border: 1px solid rgba(94, 163, 0, 0.45);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    box-shadow: 0 8px 26px rgba(0,0,0,0.45), 0 0 20px rgba(94, 163, 0, 0.25);
}

@keyframes slideDown {
    from {top: -50px; opacity: 0;}
    to {top: 30px; opacity: 1;}
}

@keyframes fadeOut {
    from {top: 30px; opacity: 1;}
    to {top: -50px; opacity: 0;}
}

.sawer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 9999; display: none;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .sawer-overlay.active { opacity: 1; }

        .sawer-card {
            background: #f6f9ff; width: 90%; max-width: 400px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Rubik', sans-serif; border: 2px solid #7385a5; position: relative;
        }
        .sawer-overlay.active .sawer-card { transform: translateY(0); }

        .sawer-header { text-align: center; margin-bottom: 15px; }
        .sawer-header h3 { margin: 0; color: #7385a5; font-size: 14px; font-weight: 700; border: none !important; }

        .sawer-close {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 20px; color: #7385a5;
            cursor: pointer; z-index: 10; transition: transform 0.2s;
        }
        .sawer-close:hover { transform: rotate(90deg); color: #d35400; }

        .network-indicator {
            display: flex; align-items: center; gap: 8px; font-size: 11px;
            color: #27ae60; background: rgba(39, 174, 96, 0.1);
            padding: 6px 12px; border-radius: 20px; width: fit-content; margin: 0 auto 20px auto; font-weight: 600;
        }
        .pulse-green {
            width: 8px; height: 8px; background: #27ae60; border-radius: 50%;
            box-shadow: 0 0 0 rgba(39, 174, 96, 0.4); animation: pulse 1.5s infinite;
        }

        .sawer-info-box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dae1e7; }
        .info-row { display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 4px; }
        .info-row.sub { font-size: 11px; color: #999; }
        .info-row.highlight { color: #7385a5; font-weight: bold; font-size: 14px; }
        .info-row .mono { font-family: monospace; }
        .divider { height: 1px; background: #e0e0e0; margin: 8px 0; }

        .input-group label { display: block; font-size: 12px; color: #7385a5; margin-bottom: 5px; font-weight: 600; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper input {
            width: 100%; padding: 12px; padding-right: 50px;
            border: 2px solid #e0e0e0; border-radius: 10px; font-size: 18px; font-weight: bold; color: #2c3e50;
            transition: border-color 0.2s;
        }
        .input-wrapper input:focus { border-color: #7385a5; outline: none; }
        .suffix { position: absolute; right: 15px; color: #95a5a6; font-weight: 600; font-size: 12px; }
        .limit-info { font-size: 10px; color: #7385a5; margin-top: 4px; display: block; }
        textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; resize: none; box-sizing: border-box; }

        .percent-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .percent-grid button {
            background: #fff; border: 1px solid #7385a5; border-radius: 6px;
            padding: 6px 2px; font-size: 10px; font-weight: bold; color: #555;
            cursor: pointer; transition: 0.2s; white-space: nowrap;
        }
        .percent-grid button:hover { background: #e3e7ed; border-color: #5c6a84; }

        .btn-sawer-send {
            width: 100%; background: linear-gradient(135deg, #7385a5 0%, #5c6a84 100%);
            color: white; border: none; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(115, 133, 165, 0.25);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.2s;
        }
        .btn-sawer-send:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(115, 133, 165, 0.4); }
        .btn-sawer-send:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }

.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: transparent;
    backdrop-filter: none;
    z-index: 9998;
    display: none;
    display: none; 
}

.modal-overlay.active {
    display: block; 
}

.modal-card {
    position: absolute;
    top: 70px;
    right: 20px;
    width: 300px;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.15); 
    border: 1px solid rgba(0,0,0,0.05);
    text-align: center;
    font-family: 'Rubik', sans-serif;
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    transform-origin: top right;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.modal-overlay.active .modal-card {
    opacity: 1;
    transform: translateY(0) scale(1);
}

.modal-card::before {
    content: "";
    position: absolute;
    top: -6px;
    right: 20px;
    width: 12px;
    height: 12px;
    background: #fff;
    transform: rotate(45deg);
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
    box-shadow: -2px -2px 5px rgba(0,0,0,0.02);
}
    
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.modal-header h3 { margin: 0; font-size: 18px; color: #333; }
.close-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }

.modal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.status-badge {
    color: #27ae60;
    font-weight: bold;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-label { color: #888; }
    
.pulse-dot {
    width: 8px; height: 8px;
    background-color: #27ae60;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(39, 174, 96, 0.4);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(39, 174, 96, 0); }
    100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
}

.modal-balance { margin-bottom: 20px; }
.balance-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
.balance-amount { font-size: 24px; font-weight: bold; color: #2c3e50; margin-top: 5px; }

.modal-address-box {
    background: #f1f2f6;
    padding: 12px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    margin-bottom: 25px;
}
.modal-address-box:hover { border-color: #3498db; background: #eaf6ff; }
.address-text { font-family: monospace; font-size: 14px; color: #555; }
.copy-icon { color: #3498db; }

.modal-actions { display: flex; flex-direction: column; gap: 10px; }
.action-btn {
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    transition: transform 0.1s;
}
.action-btn:active { transform: scale(0.98); }
.action-btn.primary { background: #7385a5; color: white; }
.action-btn.danger { background: #fee; color: #e74c3c; border: 1px solid}

/* Gaya Kotak Statistik */
.stat-box-gold, .stat-box-blue {
    flex: 1;
    min-width: 140px;
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid #eee;
}

.stat-icon {
    width: 30px; height: 30px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px;
}
.stat-box-gold .stat-icon { background: #f6f9ff; color: #7385a5; border: 1px solid #7385a5; }
.stat-box-blue .stat-icon { background: #f6f9ff; color: #7385a5; border: 1px solid #7385a5; }

.stat-info h3 { margin: 0; font-size: 16px; color: #7385a5; }
.stat-label { font-size: 11px; font-weight: bold; color: #95a5a6; text-transform: uppercase; letter-spacing: 0.5px; }

/* Gaya Kartu Pesan (Tip Card) */
.tip-card {
    background: #fff;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    animation: fadeIn 0.5s ease;
}

.tip-header {
    display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 5px;
}

.tip-amount {
    font-weight: bold; color: #27ae60; font-size: 13px; display: flex; align-items: center; gap: 5px;
}

.tip-message {
    background: #fcfcfc;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    color: #555;
    font-style: italic;
    margin-top: 8px;
    border: 1px dashed #eee;
}
     /* Styling Area History di Modal */
.modal-history-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 15px;
}

.history-scroll-area {
    max-height: 120px; /* Batasi tinggi agar tidak memenuhi layar */
    overflow-y: auto;  /* Aktifkan Scroll Vertikal */
    padding-right: 5px;
}

/* Custom Scrollbar Tipis */
.history-scroll-area::-webkit-scrollbar { width: 4px; }
.history-scroll-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

/* Kartu Item Riwayat Mini */
.mini-history-item {
    background: #fff;
    border: 1px solid #eee;
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 6px;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mini-sender { font-weight: bold; color: #5c6a84; }
.mini-amount { color: #27ae60; font-weight: bold; }
.mini-msg { 
    display: block; 
    font-size: 10px; 
    color: #888; 
    font-style: italic; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    max-width: 150px;
}
</style>
</head>
<body>
     <nav class="navbar">
        <a href="index" class="logo"><i class="fas fa-arrow-left"></i>Profile Kolektor</a>
        <div class="nav-right">
            <button id="btn-connect" onclick="window.connectWallet()">
                <i class="fas fa-wallet"></i> Hubungkan
            </button>
        </div>
    </nav>

    <div id="loginSection" class="login-wall">
        <div class="lock-icon"><i class="fas fa-shield-alt"></i></div>
        <h2 style="color:#5c6a84; margin-bottom:5px;">Akses Ruang Koleksi</h2>
        <p style="color:#8898aa; max-width: 350px;">
            Hubungkan dompet Web3 Anda untuk membuka sertifikat kepemilikan dan data koleksi.
        </p>
        <button onclick="window.requestLogin()" class="btn-connect-big" id="btnLogin">
            <i class="fas fa-wallet"></i> Buka Akses
        </button>
    </div>

    <div id="mainContent" class="container">
        <div class="search-capsule">
            <div class="search-icon"><i class="fas fa-search"></i></div>
            <input type="text" id="inputAddress" placeholder="Cari Alamat Wallet Kolektor" onkeypress="window.handleEnter(event)">
            <button onclick="window.cariProfile()" class="btn-search" title="Cari Alamat"><i class="fas fa-search"></i></button>
        </div>
        
        <div class="profile-card">
            <div class="profile-info-wrapper">
                <div class="profile-avatar">
                    <img src="" id="avatarImg" alt="Avatar">
                </div>
                <div class="profile-details">
                    <h2 id="displayAddress">Loading...</h2>
                    <div class="badges">
                        <span class="badge"><i class="fas fa-crown"></i> Owner</span>
                        <span class="badge" style="background:rgba(255,255,255,0.3);"><i class="fas fa-cube"></i> <span id="totalItems">0</span> Koleksi</span>
                    </div>
                </div>
            </div>
            <button onclick="window.copyAddress()" class="btn-copy">
                <i class="far fa-copy"></i> <span id="btnCopyText">Salin Alamat</span>
            </button>
        </div>

        <div class="stats-container" style="display:flex; gap:15px; margin-top:20px; flex-wrap:wrap;">
    
    <div class="stat-box-gold">
        <div class="stat-icon"><i class="fas fa-coins"></i></div>
        <div class="stat-info">
            <span class="stat-label">Total Apresiasi</span>
            <h3 id="displayTotalEarnings">0 ETH</h3>
        </div>
    </div>

    <div class="stat-box-blue">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-info">
            <span class="stat-label">Total Dukungan</span>
            <h3 id="displaySupporterCount">0 Orang</h3>
        </div>
    </div>

</div>

<div class="history-section" style="margin-top:25px;">
    <h3 class="section-title" style="font-size:16px; margin-bottom:15px;">
        <i class="fas fa-comment-dots" style="color:#7385a5;"></i> Pesan Semangat Terbaru
    </h3>
    
    <div id="tipHistoryContainer" class="tip-feed">
        <p style="text-align:center; color:#aaa; font-size:13px; font-style:italic;">Memuat riwayat...</p>
    </div>

    <div id="loadMoreContainer" style="text-align:center; margin-top:15px; display:none;">
        <button onclick="loadNextTipBatch()" id="btnLoadMoreTips" 
            style="background:transparent; border:1px solid #7385a5; color:#7385a5; padding:8px 20px; border-radius:20px; cursor:pointer; font-size:12px; transition:0.3s;">
            <i class="fas fa-arrow-down"></i> Tampilkan 10 Berikutnya
        </button>
    </div>
</div>

        <h3 class="section-title"><i class="fas fa-box-open"></i> Koleksi/Karya</h3>

        <div id="loading" class="state-box">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i>
            <p id="loadingText">Membaca data Blockchain...</p>
        </div>

        <div id="emptyState" class="state-box" style="display: none;">
            <i class="fas fa-ghost" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>Belum ada Koleksi Wayang yang diadopsi.</p>
            <a href="index" style="color:#7385a5; font-weight:bold;">Cari Wayang</a>
        </div>

        <div id="collectionContainer" class="collection-grid"></div>
    </div>

    <div id="walletModal" class="modal-overlay" onclick="window.closeWalletModal(event)" style="display:none;">
        <div class="modal-card">
    
    <div class="modal-header">
        <h3><i class="fas fa-wallet" style="color:#7385a5;"></i> Wallet Info</h3>
        <button class="close-btn" onclick="toggleWalletModal()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-status">
        <span class="status-label">Status:</span>
        <div class="status-badge">
            <span class="pulse-dot"></span> Terhubung Base Network
        </div>
    </div>

    <div class="modal-balance">
        <div class="balance-label">Saldo Dompet Utama</div>
        <div class="balance-amount" id="modalBalance">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>

        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #d1d9e6;">
            <div class="balance-label" style="color:#888;">
                <i class="fas fa-gift"></i> Total Pendapatan Dukungan
            </div>
            <div class="balance-amount" id="modalTipBalance" style="font-size: 18px; color: #7385a5;">
                0.0000 ETH
            </div>
        </div>
    </div>

    <div class="modal-address-box" onclick="copyAddress()">
        <div class="address-text">
            <span id="modalFullAddress" style="display:none;"></span> 
            <span id="modalShortAddress">0x...</span>
        </div>
        <i class="far fa-copy copy-icon"></i>
    </div>

    <div class="modal-history-section">
        <h4 style="font-size:12px; color:#7385a5; margin:0 0 8px 0; display:flex; justify-content:space-between;">
            <span><i class="fas fa-history"></i> Riwayat Masuk</span>
            <span id="modalTipCountBadge" style="background:#eee; padding:2px 6px; border-radius:10px; font-size:10px;">0</span>
        </h4>
        
        <div id="modalHistoryList" class="history-scroll-area">
            <p style="text-align:center; font-size:11px; color:#aaa; margin-top:10px;">Belum ada riwayat.</p>
        </div>

        <button id="btnModalLoadMore" onclick="loadNextModalTips()" style="display:none; width:100%; margin-top:5px; background:none; border:1px dashed #7385a5; color:#7385a5; font-size:10px; padding:5px; cursor:pointer; border-radius:5px;">
            Muat 2 Lama <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <div class="modal-actions" style="margin-top: 15px;">
        <button class="action-btn primary" onclick="window.location.href='/profile'">
            <i class="fas fa-user-circle"></i> Buka Profil Saya
        </button>
        
        <button class="action-btn danger" onclick="disconnectWallet()">
            <i class="fas fa-sign-out-alt"></i> Putuskan Koneksi
        </button>
    </div>
    
    </div>
    </div>

    <div id="sawerModal" class="sawer-overlay" onclick="window.closeSawer(event)" style="display:none;">
        <div class="sawer-card">
            <button class="sawer-close" onclick="window.toggleSawerModal(false)"><i class="fas fa-times"></i></button>
            <div class="network-indicator"><span class="pulse-green"></span> Terhubung Ke Jaringan Base</div>
            <div class="sawer-header"><h3>Dukung & Apresiasi Kreator Dengan ETH</h3></div>

            <div class="sawer-info-box">
                <div class="info-row"><span class="label">Penerima:</span><span class="value" id="sawerReceiverName" style="font-weight:bold;">Loading...</span></div>
                <div class="info-row sub"><span class="label">Address:</span><span class="value mono" id="sawerReceiverAddr">0x...</span></div>
                <div class="divider"></div>
                <div class="info-row highlight"><span class="label">Saldo Anda:</span><span class="value" id="sawerUserBalance">0.0000 ETH</span></div>
            </div>

            <div class="input-group">
                <label>Nominal (ETH):</label>
                <div class="input-wrapper">
                    <input type="number" id="sawerAmount" placeholder="0.001" step="0.0001">
                    <span class="suffix">ETH</span>
                </div>
                <small class="limit-info">Min: 0.0001 ETH â€¢ Max: 0.005 ETH</small>
            </div>

            <div class="percent-grid">
                <button onclick="window.setSawerPercent('MIN')">Min</button> 
                <button onclick="window.setSawerPercent(25)">25%</button>
                <button onclick="window.setSawerPercent(50)">50%</button>
                <button onclick="window.setSawerPercent(75)">75%</button>
                <button onclick="window.setSawerPercent(100)">MAX</button>
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <label>Pesan Dukungan (Opsional)</label>
                <textarea id="sawerMessage" rows="2" placeholder="Semangat berkarya!"></textarea>
            </div>

            <button id="btnKirimSawer" class="btn-sawer-send" onclick="window.eksekusiSawer()">
                <i class="fas fa-paper-plane"></i> Kirim Apresiasi
            </button>
        </div>
    </div>

    <div id="toast"></div>

    <footer class="footer">
        <p class="copyright">&copy; <span id="year"></span> Powered By <strong>Putramas Official</strong></p>
                </footer>
    
        <script>
  
const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58";

const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"RevisionFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"TipSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[],"name":"MAX_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramas.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTipByIndex","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"message","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.TipRecord","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTipCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getTipTotalBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiWayang","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"revisionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_receiver","type":"address"},{"internalType":"string","name":"_message","type":"string"}],"name":"sendTip","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setRevisionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTipsGrand","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
    
const BASE_SEPOLIA_ID = "0x2105"; // 8453
const BASE_SEPOLIA_CONFIG = {
    chainId: BASE_SEPOLIA_ID,
    chainName: 'Base',
    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
    rpcUrls: ['https://base-rpc.publicnode.com'],
    blockExplorerUrls: ['https://basescan.org/']
};

let provider, signer;
let userAddress;
let currentAddress = null;
let viewerAddress = null;
const MIN_TIP = 0.0001;
const MAX_TIP = 0.005;
let sawerTargetAddress = null;
let toastTimeout;
let profileGlobalIds = [];
let profileOffset = 0;
let isProfileFetching = false;
const PROFILE_BATCH_SIZE = 12;
let tipCursor = 0;        
let tipTargetAddr = null;
let isTipLoading = false;
let modalTipCursor = 0;      
let modalUserAddr = null;    
let isModalFetching = false; 


window.initGatekeeper = async function() {
    if (window.ethereum) {
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await provider.listAccounts();
            if (accounts.length > 0) {
                viewerAddress = accounts[0];
                userAddress = accounts[0];
                updateConnectButtonUI(viewerAddress);
                
                signer = provider.getSigner();
                
                updateModalData(viewerAddress);
                updateModalWalletData(viewerAddress);
            }
        } catch (e) {
            console.log("Visitor mode (Read Only)");
        }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const addressParam = urlParams.get('address');

    if (addressParam) {
        unlockGate(addressParam); 
        return;
    }

    const cachedAddr = localStorage.getItem('userWallet');
    
    if (viewerAddress) {
        unlockGate(viewerAddress);
    } else if (cachedAddr) {
        unlockGate(cachedAddr);
        if(window.ethereum) verifyConnection(cachedAddr);
    }
};

window.verifyConnection = async function(cachedAddr) {
    try {
        const accounts = await provider.listAccounts();
        if (accounts.length === 0 || accounts[0].toLowerCase() !== cachedAddr.toLowerCase()) {
            localStorage.removeItem('userWallet');
            location.reload(); 
        }
    } catch (e) {}
};

window.updateModalData = async function(addr) {
    if(!addr || !provider) return;
    
    try {
        if(document.getElementById("modalFullAddress")) {
            document.getElementById("modalFullAddress").innerText = addr;
            document.getElementById("modalShortAddress").innerText = addr.substring(0, 10) + "..." + addr.substring(35);
        }

        const balance = await provider.getBalance(addr);
        const ethBalance = ethers.utils.formatEther(balance);

        if(document.getElementById("modalBalance")) {
            document.getElementById("modalBalance").innerText = parseFloat(ethBalance).toFixed(4) + " ETH";
        }
    } catch (err) {
        console.error("Gagal update modal:", err);
    }
};

window.connectWallet = async function() {
    const btn = document.getElementById("btn-connect"); 
    const btnBig = document.getElementById("btnLogin"); 

    if (btn && btn.classList.contains("connected")) {
        toggleWalletModal();
        if(viewerAddress) updateModalData(viewerAddress);
        return;
    }

    if (!window.ethereum) return showToast("Install Metamask Atau EVM Wallet Dulu!", 'wolf');

    if(btn) btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
    if(btnBig) btnBig.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Menghubungkan...`;

    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        
        await switchNetwork();

        signer = provider.getSigner();
        const address = await signer.getAddress();

        localStorage.setItem('userWallet', address);
        viewerAddress = address;
        
        await updateModalData(address);
        await updateModalWalletData(address);
        updateConnectButtonUI(address);
        unlockGate(address);

    } catch (err) {
        console.error("Login Error:", err);
        showToast("Gagal koneksi: " + err.message, 'error');
        if(btn) btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
        if(btnBig) btnBig.innerHTML = `<i class="fas fa-wallet"></i> Buka Akses`;
    }
};

window.updateConnectButtonUI = function(addr) {
    const btn = document.getElementById("btn-connect");
    if(btn) {
        btn.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
        btn.classList.add("connected");
    }
};

window.switchNetwork = async function() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: BASE_SEPOLIA_ID }],
        });
    } catch (switchError) {
        if (switchError.code === 4902) {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [BASE_SEPOLIA_CONFIG],
                });
            } catch (addError) {
                throw addError;
            }
        } else {
            throw switchError;
        }
    }
};

window.requestLogin = function() {
    connectWallet(); 
};

window.disconnectWallet = function() {
    localStorage.removeItem('userWallet');
    if (typeof viewerAddress !== 'undefined') viewerAddress = null;
    signer = null;

    const btn = document.getElementById("btn-connect");
    if(btn) {
        btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
        btn.classList.remove("connected");
    }

    toggleWalletModal();
    window.location.reload();
};

window.toggleWalletModal = function() {
    const modal = document.getElementById("walletModal");
    
    if (modal.classList.contains("active")) {
        modal.classList.remove("active");
        setTimeout(() => { modal.style.display = "none"; }, 200); 
    } else {
        modal.style.display = "block";
        setTimeout(() => { modal.classList.add("active"); }, 10);
        const targetAddr = userAddress || viewerAddress; 
        if (targetAddr) {
            updateModalWalletData(targetAddr);
        }
    }
};

window.closeWalletModal = function(e) {
    if (e.target.id === "walletModal") {
        toggleWalletModal();
    }
};

window.copyAddressModal = function() {
    const addr = document.getElementById("modalFullAddress").innerText;
    if(addr) {
        navigator.clipboard.writeText(addr).then(() => {
            const icon = document.querySelector(".copy-icon");
            if(icon) {
                const originalClass = icon.className;
                icon.className = "fas fa-check";
                setTimeout(() => { icon.className = originalClass; }, 2000);
            }
           showToast("Alamat Wallet Disalin!", 'success'); 
        });
    }
};

window.unlockGate = function(profileOwnerAddr) {
    currentAddress = profileOwnerAddr;
    
    const loginSec = document.getElementById("loginSection");
    const mainSec = document.getElementById("mainContent");
    if(loginSec) loginSec.style.display = "none";
    if(mainSec) mainSec.style.display = "block";
    
    updateProfileUI(currentAddress);
    loadDataCepat(currentAddress);
    loadTipData(currentAddress);
};

window.updateProfileUI = function(addr) {
    const short = addr.substring(0, 6) + "..." + addr.substring(addr.length - 4);
    if(document.getElementById("displayAddress")) {
        document.getElementById("displayAddress").innerText = short;
    }

    if(document.getElementById("avatarImg")) {
        document.getElementById("avatarImg").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${addr}&backgroundColor=7385a5`;
    }
};

// Panggil fungsi ini di dalam unlockGate() atau loadDataCepat()
window.loadTipData = async function(targetAddress) {
    const container = document.getElementById("tipHistoryContainer");
    const elTotal = document.getElementById("displayTotalEarnings");
    const elCount = document.getElementById("displaySupporterCount");

    // Gunakan Provider Read-Only (Cepat & Gratis)
    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://mainnet.base.org");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);

    try {
        // 1. AMBIL TOTAL BALANCE (getTipTotalBalance)
        const totalWei = await contract.getTipTotalBalance(targetAddress);
        const totalEth = ethers.utils.formatEther(totalWei);
        if(elTotal) elTotal.innerText = parseFloat(totalEth).toFixed(4) + " ETH";

        // 2. AMBIL JUMLAH COUNT (getTipCount)
        const countBN = await contract.getTipCount(targetAddress);
        const count = parseInt(countBN);
        if(elCount) elCount.innerText = count + " Orang";

        // 3. AMBIL DATA LIST (getTipByIndex) - Pake Loop
        if (count === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa; background:#fff; border-radius:10px;">
                <i class="fas fa-comment-slash" style="margin-bottom:5px;"></i><br>Belum ada pesan dukungan.
            </div>`;
            return;
        }

        container.innerHTML = ""; // Bersihkan loading text
        let html = "";

        // Loop Terbalik: Dari index terakhir (terbaru) ke index 0
        // Batasi maksimal 5 pesan terbaru saja biar ringan
        const limit = 5; 
        const start = Math.max(0, count - limit);

        for (let i = count - 1; i >= start; i--) {
            try {
                // Panggil Struct TipRecord
                const tip = await contract.getTipByIndex(targetAddress, i);
                
                // Format Data
                const senderShort = tip.sender.substring(0,6) + "..." + tip.sender.substring(38);
                const amount = ethers.utils.formatEther(tip.amount);
                // Konversi timestamp solidity ke Date JS
                const dateObj = new Date(tip.timestamp * 1000); 
                const dateStr = dateObj.toLocaleDateString("id-ID", { day: 'numeric', month: 'short' }) + " " + dateObj.toLocaleTimeString("id-ID", { hour: '2-digit', minute:'2-digit' });

                html += `
                <div class="tip-card">
                    <div class="tip-header">
                        <span><i class="fas fa-user-circle"></i> ${senderShort}</span>
                        <span>${dateStr}</span>
                    </div>
                    <div class="tip-amount">
                        <i class="fas fa-gift"></i> Sawer ${amount} ETH
                    </div>
                    <div class="tip-message">
                        "${tip.message}"
                    </div>
                </div>`;
                
            } catch (e) {
                console.error("Skip tip index", i);
            }
        }
        
        // Render ke layar
        container.innerHTML = html;
        
        // Tombol "Lihat Semua" jika data > 5 (Opsional)
        if (count > limit) {
            container.innerHTML += `<div style="text-align:center; font-size:12px; color:#7385a5; margin-top:10px; cursor:pointer;">
                Lihat ${count - limit} pesan lainnya...
            </div>`;
        }

    } catch (err) {
        console.error("Gagal load tips:", err);
    }
};

// 1. FUNGSI UTAMA (Dipanggil saat buka profil)
window.loadTipData = async function(targetAddress) {
    const container = document.getElementById("tipHistoryContainer");
    const loadMoreBox = document.getElementById("loadMoreContainer");
    const elTotal = document.getElementById("displayTotalEarnings");
    const elCount = document.getElementById("displaySupporterCount");

    tipTargetAddr = targetAddress;
    container.innerHTML = `<p style="text-align:center; color:#aaa; font-size:12px;"><i class="fas fa-circle-notch fa-spin"></i> Mengambil data...</p>`;
    loadMoreBox.style.display = 'none';

    // Gunakan Provider Read-Only (Cepat)
    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://mainnet.base.org");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);

    try {
        // A. Ambil Statistik (Total ETH & Jumlah Orang)
        const [totalWei, countBN] = await Promise.all([
            contract.getTipTotalBalance(targetAddress),
            contract.getTipCount(targetAddress)
        ]);

        // Update UI Statistik
        if(elTotal) elTotal.innerText = parseFloat(ethers.utils.formatEther(totalWei)).toFixed(4) + " ETH";
        const totalCount = parseInt(countBN);
        if(elCount) elCount.innerText = totalCount + " Orang";

        // B. Cek Data Kosong
        if (totalCount === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa; background:#fff; border-radius:10px; border:1px dashed #ddd;">
                <i class="fas fa-comment-slash" style="margin-bottom:5px;"></i><br>Belum ada pesan dukungan.
            </div>`;
            return;
        }

        // C. Siapkan Cursor (Mulai dari Index Terakhir/Terbaru)
        // Array di Smart Contract mulai dari 0 sampai Length-1.
        // Kita mulai dari yang paling baru (Length-1).
        tipCursor = totalCount - 1;

        // D. Bersihkan Wadah & Load 5 Pertama
        container.innerHTML = ""; 
        await loadBatchTips(5); // Load awal 5 biji

    } catch (err) {
        console.error("Gagal load tips:", err);
        container.innerHTML = `<p style="color:red; text-align:center;">Gagal memuat riwayat.</p>`;
    }
};

// 2. FUNGSI UNTUK LOAD BATCH (Dipanggil awal & saat klik tombol)
window.loadBatchTips = async function(batchSize) {
    if (isTipLoading || tipCursor < 0) return;
    
    isTipLoading = true;
    const container = document.getElementById("tipHistoryContainer");
    const btn = document.getElementById("btnLoadMoreTips");
    const loadMoreBox = document.getElementById("loadMoreContainer");

    // Ubah tombol jadi loading
    const originalBtnText = btn.innerHTML;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memuat...`;

    // Gunakan Provider Read-Only
    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://mainnet.base.org");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);

    // Hitung batas loop (Mundur)
    // Contoh: Cursor 49, Batch 10 -> Stop di 40
    let end = tipCursor - batchSize + 1;
    if (end < 0) end = 0; // Jangan sampai minus

    let htmlBuffer = "";

    // LOOP MUNDUR (Dari Terbaru ke Terlama)
    for (let i = tipCursor; i >= end; i--) {
        try {
            const tip = await contract.getTipByIndex(tipTargetAddr, i);
            
            // Format Data
            const senderShort = tip.sender.substring(0,6) + "..." + tip.sender.substring(38);
            const amount = parseFloat(ethers.utils.formatEther(tip.amount)).toFixed(4);
            const dateObj = new Date(tip.timestamp * 1000); 
            const dateStr = dateObj.toLocaleDateString("id-ID", { day: 'numeric', month: 'short', year: '2-digit' });

            // HTML Item
            htmlBuffer += `
            <div class="tip-card" style="animation: fadeIn 0.5s ease;">
                <div class="tip-header">
                    <span style="display:flex; align-items:center; gap:6px; background:#f6f9ff; padding:4px 8px; border: 1px solid #7385a5; border-radius:10px; box-shadow:0 1px 4px rgba(115,133,165,0.15);">
                    <i class="fas fa-user-circle" style="color:#7385a5;"></i> 
                    <span style="font-weight:600; color:#555;">${senderShort}</span>
                    </span>
                    <span style="font-size:11px;">${dateStr}</span>
                </div>
                <div class="tip-amount">
                    <i class="fas fa-gift" style="color:#7385a5;"></i> <p style="color:#555;"> Dukung:</p> <span style="color:#27ae60;">${amount} ETH</span>
                </div>
                <div class="tip-message">
                    "${tip.message}"
                </div>
            </div>`;
            
        } catch (e) {
            console.error("Skip index", i);
        }
    }

    // Tempel ke bawah (Append)
    container.insertAdjacentHTML('beforeend', htmlBuffer);

    // Update Cursor untuk load berikutnya
    tipCursor = end - 1;
    isTipLoading = false;
    btn.innerHTML = originalBtnText;

    // Cek apakah tombol Load More masih perlu ditampilkan?
    if (tipCursor >= 0) {
        loadMoreBox.style.display = 'block';
    } else {
        loadMoreBox.style.display = 'none'; // Sembunyikan jika data habis
    }
};

// 3. EVENT HANDLER TOMBOL
window.loadNextTipBatch = function() {
    loadBatchTips(10); // Load 10 berikutnya saat diklik
};

window.loadDataCepat = async function(targetAddress) {
    const container = document.getElementById("collectionContainer");
    const loading = document.getElementById("loading");
    const empty = document.getElementById("emptyState");
    
    // 1. Reset State & UI
    container.innerHTML = "";
    profileGlobalIds = [];
    profileOffset = 0;
    isProfileFetching = false;
    
    // Matikan sensor lama biar gak numpuk
    window.removeEventListener('scroll', handleProfileScroll);

    if(loading) loading.style.display = 'block';
    if(empty) empty.style.display = 'none';

    let tempProvider = provider;
    if (!tempProvider) {
        tempProvider = new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");
    }

    try {
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);
        
        // 2. Ambil SEMUA ID milik user (Cepat karena cuma angka)
        const tokenIds = await contract.walletOfOwner(targetAddress);
        
        if(document.getElementById("totalItems")) {
            document.getElementById("totalItems").innerText = tokenIds.length;
        }

        if (tokenIds.length === 0) {
            if(loading) loading.style.display = 'none';
            if(empty) empty.style.display = 'block';
            return;
        }

        // 3. Simpan ID ke Global Variable & Balik Urutan (Terbaru diatas)
        profileGlobalIds = tokenIds.slice().reverse();

        // 4. Sembunyikan Loading Besar
        if(loading) loading.style.display = 'none';

        // 5. Panggil Batch Pertama
        await loadNextProfileBatch();

        // 6. Hidupkan Sensor Scroll
        window.addEventListener('scroll', handleProfileScroll);

    } catch (err) {
        console.error("Gagal load data:", err);
        if(loading) loading.innerHTML = `<p style="color:red">Gagal memuat data Blockchain.</p>`;
    }
};

window.loadNextProfileBatch = async function() {
    // Cek Pengaman
    if (isProfileFetching || profileOffset >= profileGlobalIds.length) return;

    isProfileFetching = true;
    const container = document.getElementById("collectionContainer");

    // Tampilkan Loader Kecil di Bawah
    let bottomLoader = null;
    if (profileOffset > 0) {
        bottomLoader = document.createElement("div");
        bottomLoader.style.cssText = "grid-column: 1/-1; text-align: center; padding: 20px; color: #7385a5;";
        bottomLoader.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memuat koleksi lainnya...`;
        container.appendChild(bottomLoader);
    }

    // Ambil Potongan ID (Slice)
    const batchIds = profileGlobalIds.slice(profileOffset, profileOffset + PROFILE_BATCH_SIZE);

    // Setup Provider (Read Only juga oke buat metadata)
    let tempProvider = provider || new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);

    // Fetch Metadata Secara Paralel
    // Di dalam fungsi window.loadNextProfileBatch, pastikan bagian pemetaan seperti ini:
const promises = batchIds.map(async (id) => {
    try {
        const uri = await contract.tokenURI(id);
        const meta = await fetchMetadata(uri);
        // Pastikan id asli tetap dibawa untuk tombol detail
        return { id: id.toString(), meta: meta }; 
    } catch (e) { return null; }
});

    const results = await Promise.all(promises);

    // Hapus Loader Kecil
    if (bottomLoader) bottomLoader.remove();

    // Render Kartu
    results.forEach(item => {
        if (item) {
            renderCard(item.id, item.meta.name, item.meta.image, container);
        }
    });

    // Update Posisi
    profileOffset += PROFILE_BATCH_SIZE;
    isProfileFetching = false;
    
    // Auto-fill jika layar besar tapi data masih sedikit
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight && profileOffset < profileGlobalIds.length) {
         loadNextProfileBatch();
    }
};

window.handleProfileScroll = function() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
        loadNextProfileBatch();
    }
};

window.fetchMetadata = async function(tokenURI) {
    // Gunakan Dedicated Gateway Pinata agar tidak broken/loading lama
    const PINATA_GATEWAY = "https://magenta-secondary-guan-686.mypinata.cloud/ipfs/";
    
    try {
        // Bersihkan tokenURI dari prefix ipfs://
        const cid = tokenURI.replace("ipfs://", "");
        const url = `${PINATA_GATEWAY}${cid}`;
        
        const response = await fetch(url, { timeout: 5000 });
        if (!response.ok) throw new Error("Gateway Error");
        
        const json = await response.json();
        
        // Perbaiki link gambar
        let img = json.image || json.image_url;
        if (img && img.startsWith("ipfs://")) {
            img = img.replace("ipfs://", PINATA_GATEWAY);
        } else if (!img) {
            img = "img/placeholder.jpg";
        }

        return { 
            name: json.name || `Wayang #${id}`, 
            image: img 
        };
    } catch (e) {
        console.warn("Metadata gagal dimuat, mencoba gateway fallback...");
        // Fallback ke Cloudflare jika Pinata bermasalah
        try {
            const fallbackUrl = tokenURI.replace("ipfs://", "https://cloudflare-ipfs.com/ipfs/");
            const res = await fetch(fallbackUrl);
            const data = await res.json();
            return { 
                name: data.name, 
                image: data.image.replace("ipfs://", "https://cloudflare-ipfs.com/ipfs/") 
            };
        } catch (err) {
            return { name: "Karya Seni", image: "img/placeholder.jpg" };
        }
    }
};

window.renderCard = function(id, name, img, container) {
    let isMyProfile = false;
    if (typeof viewerAddress !== 'undefined' && typeof currentAddress !== 'undefined') {
        // Pastikan tidak error jika salah satu null
        if(viewerAddress && currentAddress) {
            isMyProfile = viewerAddress.toLowerCase() === currentAddress.toLowerCase();
        }
    }

    let badgeHtml = isMyProfile 
        ? `<span class="owned-badge" style="background:#f1c40f; color:#fff;"><i class="fas fa-check-circle"></i> Milik Anda</span>`
        : `<span class="owned-badge" style="background:#2ecc71; color:#fff;"><i class="fas fa-shield-alt"></i> Terverifikasi</span>`;
    
    let editBtn = isMyProfile 
        ? `<button onclick="window.location.href='revisi?id=${id}'" style="border:none; background:#d35400; color:white; font-weight: bold; border-radius:5px; font-size:9px; padding:2px 7px; cursor:pointer; margin-left:5px;"><i class="fas fa-edit"></i> Revisi</button>`
        : ``;

    const html = `
    <div class="wayang-card" style="animation: fadeIn 0.5s ease;">
        <div style="position:relative;">
            ${badgeHtml} 
            <div class="card-img-container">
                <img src="${img}" loading="lazy" alt="${name}" 
                     onerror="this.src='img/placeholder.jpg'">
            </div>
        </div>
            <div class="card-body">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                    <span class="card-id">ID #${id}</span>
                    ${editBtn}
                </div>
                <h4 class="card-title">${name}</h4>
                
                <div style="margin-top:10px; display:flex; gap:8px;">
                    <a href="detail?id=${id}" class="btn-detail" 
                       title="Lihat Detail"
                       style="flex: 1; display:flex; align-items:center; justify-content:center; text-decoration: none;">
                       <i class="fas fa-arrow-left"></i>
                    </a>

                    <button onclick="event.stopPropagation(); window.panggilSawerDetail('${currentAddress}', '${name}')" 
                            id="btnSawer" class="btn-detail" title="Sawer"
                            style="flex: 1; display:flex; align-items:center; justify-content:center; border: none; text-decoration: none;">
                         <i class="fas fa-gift"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    // PERUBAHAN UTAMA DISINI: Gunakan insertAdjacentHTML agar tidak berat
    container.insertAdjacentHTML('beforeend', html);
};

window.panggilSawerDetail = async function(address, name) {
    if (!window.ethereum) return showToast("MetaMask tidak ditemukan!", 'error');
    
    if (!signer || !viewerAddress) {
        window.showToast("Hubungkan wallet dulu!", "warning");
        await window.connectWallet();
        return;
    }

    if (viewerAddress.toLowerCase() === address.toLowerCase()) {
        window.showToast("Tidak bisa menyawer diri sendiri!", "error");
        return;
    }

    sawerTargetAddress = address;

    document.getElementById("sawerReceiverName").innerText = name;
    document.getElementById("sawerReceiverAddr").innerText = address.substring(0, 6) + "..." + address.substring(address.length - 4);
    document.getElementById("sawerAmount").value = "";
    document.getElementById("sawerMessage").value = "";

    try {
        const balanceBN = await provider.getBalance(viewerAddress);
        const ethVal = ethers.utils.formatEther(balanceBN);
        
        const elSaldo = document.getElementById("sawerUserBalance");
        elSaldo.innerText = parseFloat(ethVal).toFixed(4) + " ETH";
        elSaldo.setAttribute('data-balance', ethVal);
    } catch (e) {
        console.error(e);
        document.getElementById("sawerUserBalance").innerText = "Error";
    }

    window.toggleSawerModal(true);
};

window.setSawerPercent = function(percent) {
    const elSaldo = document.getElementById("sawerUserBalance");
    const rawBalance = elSaldo.getAttribute('data-balance');
    
    if (!rawBalance) return;

    let balanceEth = parseFloat(rawBalance);
    let maxSafeUser = balanceEth - 0.0000055; 
    if (maxSafeUser < 0) maxSafeUser = 0;

    let effectiveLimit = Math.min(maxSafeUser, MAX_TIP); 

    let amount = 0;
    if (percent === 'MIN') {
        amount = MIN_TIP;
    } else {
        amount = (effectiveLimit * percent) / 100;
    }

    if (amount < MIN_TIP) amount = (maxSafeUser >= MIN_TIP) ? MIN_TIP : 0;
    if (amount > effectiveLimit) amount = effectiveLimit;

    if (amount > 0) {
        document.getElementById("sawerAmount").value = parseFloat(amount.toFixed(5)); 
    } else {
        window.showToast("Saldo tidak cukup untuk gas fee.", 'error');
    }
};

window.eksekusiSawer = async function() {
    const amountVal = document.getElementById("sawerAmount").value;
    const btn = document.getElementById("btnKirimSawer");

    if (!amountVal || amountVal < MIN_TIP || amountVal > MAX_TIP) {
        window.showToast(`Nominal harus ${MIN_TIP} - ${MAX_TIP} ETH`, 'warning');
        return;
    }

    try {
        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memproses...`;
        btn.disabled = true;

        // 1. Siapkan Data Angka & Pesan
        const amountWei = ethers.utils.parseEther(amountVal.toString());
        
        // Ambil pesan dari inputan (default "-" jika kosong)
        const messageVal = document.getElementById("sawerMessage").value || "-";

        // 2. Definisi Kontrak Write (Wajib pakai Signer)
        const contractWrite = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // 3. EKSEKUSI YANG BENAR
        // Urutannya: (Alamat Penerima, Pesan String, { value: Jumlah ETH })
        const tx = await contractWrite.sendTip(sawerTargetAddress, messageVal, {
            value: amountWei
        });
        
        window.toggleSawerModal(false); 
        window.showToast("Transaksi dikirim! Menunggu konfirmasi...", 'loading');

        await tx.wait();
        
        window.showToast(`Sukses kirim ${amountVal} ETH!`, 'success');

        // Update modal jika ada fungsi update
        if(typeof updateModalWalletData === 'function' && viewerAddress) {
            window.updateModalWalletData(viewerAddress);
        }

    }
    catch (err) {
        console.error(err);
        let msg = err.reason || err.message;
        if(err.code === "ACTION_REJECTED" || err.code === 4001) msg = "Dibatalkan user.";
        else if(msg.includes("insufficient funds")) msg = "Saldo kurang (Gas Fee).";
        
        window.showToast("Gagal: " + msg, 'error');
    } finally {
        btn.innerHTML = `<i class="fas fa-paper-plane"></i> Kirim Apresiasi`;
        btn.disabled = false;
    }
};

async function updateModalWalletData(addr) {
    if(!addr) return;
    modalUserAddr = addr;

    const listEl = document.getElementById("modalHistoryList");
    const balEl = document.getElementById("modalTipBalance");
    const badgeEl = document.getElementById("modalTipCountBadge");
    const btnMore = document.getElementById("btnModalLoadMore");
    
    // Reset UI ke Loading
    if(listEl) listEl.innerHTML = `<div style="text-align:center; padding:10px; color:#7385a5;"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>`;
    if(btnMore) btnMore.style.display = 'none';

    try {
        // --- PERBAIKAN UTAMA: Gunakan Provider Metamask jika ada (Lebih Stabil) ---
        let readProvider;
        if (provider) {
            readProvider = provider; // Pakai yang sudah connect
        } else {
            readProvider = new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");
        }

        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

        // A. Ambil Total Pendapatan
        const totalWei = await contract.getTipTotalBalance(addr);
        const totalEth = parseFloat(ethers.utils.formatEther(totalWei)).toFixed(4);
        
        // Update UI Saldo
        if(balEl) {
            balEl.innerText = totalEth + " ETH";
            balEl.style.color = totalEth > 0 ? "#7385a5" : "#888"; // Hijau jika ada saldo
        }

        // B. Ambil Jumlah History
        const countBN = await contract.getTipCount(addr);
        const count = parseInt(countBN.toString()); 
        
        if(badgeEl) badgeEl.innerText = count;

        // C. Logika Tampilan List
        if (count === 0) {
            if(listEl) listEl.innerHTML = `<p style="text-align:center; font-size:11px; color:#aaa; margin-top:10px;">Belum ada riwayat masuk.</p>`;
            return;
        }

        // D. Siapkan Batch Pertama (Mulai dari index terakhir)
        modalTipCursor = count - 1; 
        if(listEl) listEl.innerHTML = ""; // Bersihkan loading
        
        await loadNextModalTips(); 

    } catch (e) {
        console.error("Gagal update modal data:", e);
        // Tampilkan error yang lebih spesifik di console browser (F12)
        if(listEl) listEl.innerHTML = `<p style="color:red; font-size:10px; text-align:center;">Gagal koneksi ke Blockchain.<br>Coba refresh.</p>`;
    }
}
            
async function loadNextModalTips() {
    if(isModalFetching || modalTipCursor < 0) return;
    
    isModalFetching = true;
    const container = document.getElementById("modalHistoryList");
    const btnMore = document.getElementById("btnModalLoadMore");
    
    if(btnMore) btnMore.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memuat...`;

    // --- PERBAIKAN: Gunakan Provider yang sama dengan fungsi utama ---
    let readProvider;
    if (provider) {
        readProvider = provider;
    } else {
        readProvider = new ethers.providers.JsonRpcProvider("https://sepolia.base.org");
    }

    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

    // Hitung mundur 5 langkah
    let end = modalTipCursor - 2 + 1;
    if(end < 0) end = 0;

    let html = "";

    for (let i = modalTipCursor; i >= end; i--) {
        try {
            const tip = await contract.getTipByIndex(modalUserAddr, i);
            
            // Format Data
            const senderShort = tip.sender.substring(0,4) + ".." + tip.sender.substring(38);
            const amount = parseFloat(ethers.utils.formatEther(tip.amount)).toFixed(4);
            // Cek pesan kosong
            const msg = (tip.message && tip.message !== "") ? tip.message : "Tanpa pesan";

            html += `
            <div class="mini-history-item" style="animation: fadeIn 0.3s;">
                <div style="flex:1; overflow:hidden;">
                    <div class="mini-sender" style="display:flex; align-items:center; gap:4px;">
                        <i class="fas fa-user-circle" style="color:#7385a5;"></i> ${senderShort}
                    </div>
                    <span class="mini-msg" title="${msg}">${msg}</span>
                </div>
                <div class="mini-amount">+${amount} ETH</div>
            </div>`;
        } catch (e) {
            console.log("Skip error item index:", i);
        }
    }

    // Append (Tempel ke bawah)
    container.insertAdjacentHTML('beforeend', html);

    // Update Status
    modalTipCursor = end - 1;
    isModalFetching = false;

    // Cek Tombol Load More
    if(btnMore) {
        if(modalTipCursor >= 0) {
            btnMore.style.display = 'block';
            btnMore.innerHTML = `Muat 2 Lama <i class="fas fa-chevron-down"></i>`;
        } else {
            btnMore.style.display = 'none'; // Data habis
        }
    }
}

window.toggleSawerModal = function(show) {
    const modal = document.getElementById("sawerModal");
    if (show) {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
    } else {
        modal.classList.remove("active");
        setTimeout(() => modal.style.display = "none", 300);
    }
};

window.closeSawer = function(e) {
    if (e.target.id === "sawerModal") window.toggleSawerModal(false);
};

window.copyAddress = function() {
    if(currentAddress) {
        navigator.clipboard.writeText(currentAddress);
        const btnText = document.getElementById("btnCopyText");
        if(btnText) {
            btnText.innerText = "Disalin!";
            setTimeout(() => btnText.innerText = "Salin Alamat", 2000);
        }
    }
};

window.cariProfile = function() {
    const input = document.getElementById("inputAddress").value.trim();
    if (input) window.location.href = `?address=${input}`;
};

window.handleEnter = function(e) { if (e.key === "Enter") cariProfile(); };

window.showToast = function(msg, type = 'info') {
    const x = document.getElementById("toast");

    const icons = {
        info: 'img/info-icon.svg',
        load: 'img/load.svg',
        loading: 'img/loading.svg',
        success: 'img/success.svg',
        error: 'img/error.svg',
        warning: 'img/warning.svg',
        wolf: 'img/wolf.svg'
    };

    const closeIcon = 'img/x.svg'; 

    if (!icons[type]) type = 'info';

    x.innerHTML = `
        <img src="${icons[type]}" class="toast-icon" alt="${type}"> 
        <span style="flex:1;">${msg}</span>
        <img src="${closeIcon}" class="toast-close" onclick="this.parentElement.className = this.parentElement.className.replace('show', '')" alt="close">
    `;

    x.className = ''; 
    void x.offsetWidth; 
    x.className = `show ${type}`;

    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { 
        x.className = x.className.replace("show", ""); 
    }, 10000); 
    }

window.addEventListener('DOMContentLoaded', () => {
    initGatekeeper();
    if(document.getElementById("year")) document.getElementById("year").innerText = new Date().getFullYear();
});

if(window.ethereum) {
    window.ethereum.on('accountsChanged', () => {
        localStorage.removeItem('userWallet');
        window.location.reload();
    });
}
        </script>
        </body>
        </html>
