<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruang Pusaka - Profil Kolektor</title>
    
    <link rel="icon" href="/img/favicon.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <style>
        /* --- STYLE PREMIUM (Tetap Sama) --- */
        body { font-family: 'Poppins', sans-serif; background-color: #f6f9ff; color: #333; margin: 0; padding: 0; }
        .navbar { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 700; color: #7385a5; font-size: 18px; text-decoration: none; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 80vh; }
        
        /* LOGIN WALL */
        .login-wall { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; text-align: center; animation: fadeIn 0.5s ease; }
        .lock-icon { font-size: 50px; color: #7385a5; margin-bottom: 20px; background: #e9f0ff; width: 100px; height: 100px; line-height: 100px; border-radius: 50%; box-shadow: 0 10px 30px rgba(115, 133, 165, 0.2); }
        .btn-connect-big { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(115, 133, 165, 0.3); display: flex; align-items: center; gap: 10px; }
        .btn-connect-big:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); }

        /* CONTENT */
        #mainContent { display: none; }
        
        /* PROFILE CARD */
        .profile-card { background: linear-gradient(135deg, #7385a5, #5c6a84); color: white; border-radius: 25px; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; box-shadow: 0 10px 25px rgba(115, 133, 165, 0.4); position: relative; overflow: hidden; margin-bottom: 30px; text-align: center; }
        .profile-card::before { content: ''; position: absolute; top: -50%; left: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        @media (min-width: 768px) { .profile-card { flex-direction: row; text-align: left; justify-content: space-between; } .profile-info-wrapper { display: flex; align-items: center; gap: 20px; } }
        
        .profile-avatar img { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); object-fit: cover; background: #fff; }
        .profile-details h2 { margin: 0; font-size: 13px; font-family: 'Courier New', monospace; letter-spacing: 0.5px; margin-bottom: 5px; }
        .badges { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        @media (min-width: 768px) { .badges { justify-content: flex-start; } }
        .badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        
        .btn-copy { background: rgba(255,255,255,0.9); color: #7385a5; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-copy:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .section-title { color: #7385a5; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        
        /* GRID SYSTEM */
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .wayang-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #eee; position: relative; }
        .wayang-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card-body { padding: 12px; }
        .card-title { font-size: 11px; font-weight: bold; color: #5c6a84; margin: 0; }
        .card-id { font-size: 11px; color: #999; margin-bottom: 8px; display: block; }
        .btn-detail { display: block; width: 100%; text-align: center; background: #e9f0ff; color: #7385a5; text-decoration: none; padding: 8px 0; border-radius: 8px; font-size: 12px; font-weight: bold; transition: 0.2s; }
        .btn-detail:hover { background: #7385a5; color: white; }
        .owned-badge { position: absolute; top: 10px; right: 10px; background: #f1c40f; color: white; font-size: 6px; padding: 2px 4px; border-radius: 8px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        .state-box { text-align: center; padding: 50px 20px; color: #7385a5; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        /* --- SEARCH CAPSULE STYLE (FIXED) --- */
.search-capsule {
    background: white;
    border-radius: 50px;
    /* Remove internal padding so the button can touch the edge */
    padding: 0; 
    display: flex;
    align-items: center;
    gap: 0; /* Remove gap, handle spacing via padding on elements */
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 2px solid #7385a5;
    margin-bottom: 25px;
    transition: 0.3s;
    height: 50px; /* Set fixed height for consistency */
    overflow: hidden; /* Ensures button stays inside border radius */
}

.search-capsule:focus-within {
    box-shadow: 0 8px 25px rgba(115, 133, 165, 0.15);
    border-color: #dbe4f3;
    transform: translateY(-2px);
}

.search-icon {
    color: #b0b8c4;
    font-size: 16px;
    padding-left: 20px; /* Add padding here instead of container */
}

.search-capsule input {
    border: none;
    outline: none;
    flex: 1; 
    font-size: 14px;
    font-family: 'Poppins', sans-serif;
    color: #5c6a84;
    background: transparent;
    height: 100%; /* Fill height */
    padding-left: 15px; /* Space between icon and text */
}

.search-capsule input::placeholder {
    color: #b0b8c4;
}

.btn-search {
    background: #7385a5;
    color: white;
    border: none;
    height: 100%; 
    
    /* UPDATE: Padding dikanan-kiri dikurangi biar jadi agak kotak/bulat di ujung */
    padding: 0 20px; 
    
    /* UPDATE: Ukuran font untuk icon dibesarkan sedikit biar jelas */
    font-size: 16px; 
    
    border-radius: 0 50px 50px 0;
    cursor: pointer;
    transition: 0.3s;
    
    /* Flexbox wajib biar icon di tengah */
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-search:hover {
    background: #5c6a84;
    border: 2px solid #5c6a84;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5); 
}

/* Mobile Responsive */
@media (max-width: 480px) {
    .search-capsule {
        /* On mobile, keep height but adjust padding if needed */
    }
    .search-icon { display: none; }
    .search-capsule input { padding-left: 20px; }
    .btn-search { padding: 0 20px; }
        }

        .footer { background: #fff; padding: 15px; text-align: center; margin-top: auto; border-top: 1px solid #eee; }
        .copyright { color: #888; font-size: 13px; }

        #btn-connect {
            background: transparent; color: #7385a5; border: 2px solid #7385a5; 
            padding: 10px 25px; cursor: pointer; font-family: 'Rubik', sans-serif; 
            font-weight: bold; border-radius: 30px; transition: 0.3s; font-size: 14px;
        }
        #btn-connect:hover { background: #f6f9ff; color: #7385a5; border: 2px solid #7385a5; }
        #btn-connect.connected { background: #7385a5; color: #fff; border-color: #abb6c9; cursor: default; }
        @media (max-width: 600px) {
            .navbar { padding: 15px 20px; }
            .nav-brand { font-size: 0.9em; }
            #btn-connect { padding: 8px 15px; font-size: 12px; }
            h1 { font-size: 2em; }
                 }

        /* 1. Overlay Transparan (Hanya untuk deteksi klik luar) */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: transparent; /* Tidak ada warna/blur */
    backdrop-filter: none;
    z-index: 9998;
    display: none;
    /* Ubah dari flex ke block agar kita bisa atur posisi absolute manual */
    display: none; 
}

.modal-overlay.active {
    display: block; 
}

/* 2. Kartu Modal (Menjadi Dropdown) */
.modal-card {
    position: absolute; /* Kunci posisi */
    
    /* ATUR POSISI DISINI SESUAI TINGGI NAVBAR ANDA */
    top: 70px;  /* Jarak dari atas (sesuaikan dengan tinggi navbar) */
    right: 20px; /* Jarak dari kanan (supaya lurus dengan tombol connect) */
    
    width: 300px; /* Lebar fix agar rapi */
    background: #fff;
    padding: 20px;
    border-radius: 12px; /* Radius lebih kecil ala dropdown */
    
    /* Shadow Premium Soft */
    box-shadow: 0 5px 30px rgba(0,0,0,0.15); 
    border: 1px solid rgba(0,0,0,0.05); /* Border tipis halus */
    
    text-align: center;
    font-family: 'Rubik', sans-serif;
    
    /* Animasi Muncul dari atas */
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    transform-origin: top right; /* Animasi mulai dari pojok kanan atas */
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* State Aktif */
.modal-overlay.active .modal-card {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* (Opsional) Segitiga Kecil Penunjuk ke Atas (Arrow) */
.modal-card::before {
    content: "";
    position: absolute;
    top: -6px; /* Muncul di atas kotak */
    right: 20px; /* Posisi sejajar tombol */
    width: 12px;
    height: 12px;
    background: #fff;
    transform: rotate(45deg); /* Putar jadi wajik */
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
    box-shadow: -2px -2px 5px rgba(0,0,0,0.02);
}
    
/* Header */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.modal-header h3 { margin: 0; font-size: 18px; color: #333; }
.close-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }

/* Status Badge & Dot Kelap Kelip */
.modal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.status-badge {
    color: #27ae60;
    font-weight: bold;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-label { color: #888; }
    
.pulse-dot {
    width: 8px; height: 8px;
    background-color: #27ae60;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(39, 174, 96, 0.4);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(39, 174, 96, 0); }
    100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
}

/* Saldo */
.modal-balance { margin-bottom: 20px; }
.balance-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
.balance-amount { font-size: 24px; font-weight: bold; color: #2c3e50; margin-top: 5px; }

/* Address Box (Copyable) */
.modal-address-box {
    background: #f1f2f6;
    padding: 12px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    margin-bottom: 25px;
}
.modal-address-box:hover { border-color: #3498db; background: #eaf6ff; }
.address-text { font-family: monospace; font-size: 14px; color: #555; }
.copy-icon { color: #3498db; }

/* Tombol Aksi */
.modal-actions { display: flex; flex-direction: column; gap: 10px; }
.action-btn {
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    transition: transform 0.1s;
}
.action-btn:active { transform: scale(0.98); }
.action-btn.primary { background: #7385a5; color: white; }
.action-btn.danger { background: #fee; color: #e74c3c; border: 1px solid
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index" class="logo"><i class="fas fa-arrow-left"></i>Profile Kolektor</a>
        <div class="nav-right">
        <button id="btn-connect" onclick="connectWallet()">
            <i class="fas fa-wallet"></i> Hubungkan
        </button>
        </div>
    </nav>

    <div id="loginSection" class="login-wall">
        <div class="lock-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h2 style="color:#5c6a84; margin-bottom:5px;">Akses Ruang Koleksi</h2>
        <p style="color:#8898aa; max-width: 350px;">
            Hubungkan dompet Web3 Anda untuk membuka sertifikat kepemilikan dan data koleksi.
        </p>
        <button onclick="requestLogin()" class="btn-connect-big" id="btnLogin">
            <i class="fas fa-wallet"></i> Buka Akses
        </button>
    </div>

    <div id="mainContent" class="container">

        <div class="search-capsule">
    <div class="search-icon">
        <i class="fas fa-search"></i>
    </div>
    <input type="text" id="inputAddress" placeholder="Cari Alamat Wallet Kolektor" onkeypress="handleEnter(event)">
    <button onclick="cariProfile()" class="btn-search" title="Cari Alamat">
    <i class="fas fa-search"></i>
    </button>
        </div>
        
        <div class="profile-card">
            <div class="profile-info-wrapper">
                <div class="profile-avatar">
                    <img src="" id="avatarImg" alt="Avatar">
                </div>
                <div class="profile-details">
                    <h2 id="displayAddress">Loading...</h2>
                    <div class="badges">
                        <span class="badge"><i class="fas fa-crown"></i> Owner</span>
                        <span class="badge" style="background:rgba(255,255,255,0.3);"><i class="fas fa-cube"></i> <span id="totalItems">0</span> Koleksi</span>
                    </div>
                </div>
            </div>

            <button onclick="copyAddress()" class="btn-copy">
                <i class="far fa-copy"></i> <span id="btnCopyText">Salin Alamat</span>
            </button>
        </div>

        <h3 class="section-title">
            <i class="fas fa-box-open"></i> Koleksi/Karya
        </h3>

        <div id="loading" class="state-box">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i>
            <p id="loadingText">Membaca data Blockchain...</p>
        </div>

        <div id="emptyState" class="state-box" style="display: none;">
            <i class="fas fa-ghost" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>Belum ada Koleksi Wayang yang diadopsi.</p>
            <a href="index" style="color:#7385a5; font-weight:bold;">Cari Wayang</a>
        </div>

        <div id="walletModal" class="modal-overlay" onclick="closeWalletModal(event)">
    <div class="modal-card">
        
        <div class="modal-header">
            <h3><i class="fas fa-wallet" style="color:#7385a5;"></i> Wallet Info</h3>
            <button class="close-btn" onclick="toggleWalletModal()"><i class="fas fa-times"></i></button>
        </div>

        <div class="modal-status">
            <span class="status-label">Status:</span>
            <div class="status-badge">
                <span class="pulse-dot"></span> Terhubung Base Network
            </div>
        </div>

        <div class="modal-balance">
            <div class="balance-label">Total Saldo</div>
            <div class="balance-amount" id="modalBalance">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        </div>

        <div class="modal-address-box" onclick="copyAddress()">
            <div class="address-text">
                <span id="modalFullAddress" style="display:none;"></span> <span id="modalShortAddress">0x...</span>
            </div>
            <i class="far fa-copy copy-icon"></i>
        </div>

        <div class="modal-actions">
            <button class="action-btn primary" onclick="window.location.href='/profile'">
                <i class="fas fa-user-circle"></i> Buka Profil Saya
            </button>
            
            <button class="action-btn danger" onclick="disconnectWallet()">
                <i class="fas fa-sign-out-alt"></i> Putuskan Koneksi
            </button>
        </div>
        
    </div>
        </div>

        <div id="collectionContainer" class="collection-grid"></div>

    </div>

    <footer class="footer">
    <p class="copyright">&copy; <span id="year"></span> Powered By <strong>Putramas Official</strong></p>
    </footer>
<script>
        // --- KONFIGURASI NETWORK (Base Sepolia) ---
        const BASE_SEPOLIA_ID = '0x14a34'; // Chain ID 84532
        const BASE_SEPOLIA_CONFIG = {
            chainId: BASE_SEPOLIA_ID,
            chainName: 'Base Sepolia Testnet',
            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia-explorer.base.org']
        };

        const CONTRACT_ADDRESS = "0xc690eBab5690210F7Ae20F8D32553683daA3FB5b"; 
        
        const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"RevisionFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"TipSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[],"name":"MAX_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramas.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTipByIndex","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"message","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.TipRecord","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTipCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getTipTotalBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiWayang","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"revisionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_receiver","type":"address"},{"internalType":"string","name":"_message","type":"string"}],"name":"sendTip","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setRevisionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTipsGrand","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
            
        // --- GLOBAL VARIABLES ---
        let provider, signer;
        let currentAddress = null; // Alamat Profil yang sedang DILIHAT
        let viewerAddress = null;  // Alamat Wallet KITA (Penonton)

        // ============================================================
        // 1. FUNGSI SAKTI (GATEKEEPER) - LOGIKA UTAMA
        // ============================================================
        async function initGatekeeper() {
        if (window.ethereum) {
            try {
                // Provider hanya untuk cek status (readonly)
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    viewerAddress = accounts[0]; 
                    updateConnectButtonUI(viewerAddress); 
                    
                    // --- PERBAIKAN: UPDATE MODAL SAAT LOAD ---
                    updateModalData(viewerAddress); 
                }
            } catch (e) {
                console.log("Visitor mode");
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const addressParam = urlParams.get('address');

        // Logic buka gerbang
        if (addressParam) {
            unlockGate(addressParam); 
            return;
        }

        const cachedAddr = localStorage.getItem('userWallet');
        
        if (viewerAddress) {
            unlockGate(viewerAddress);
        } else if (cachedAddr) {
            unlockGate(cachedAddr);
            if(window.ethereum) verifyConnection(cachedAddr);
        }
    }

    async function verifyConnection(cachedAddr) {
        try {
            const accounts = await provider.listAccounts();
            if (accounts.length === 0 || accounts[0].toLowerCase() !== cachedAddr.toLowerCase()) {
                localStorage.removeItem('userWallet');
                location.reload(); 
            }
        } catch (e) {}
    }

    // --- 2. FUNGSI KHUSUS UPDATE MODAL (SOLUSI STUCK) ---
    async function updateModalData(addr) {
        if(!addr || !provider) return;
        
        try {
            // A. Update Teks Address
            if(document.getElementById("modalFullAddress")) {
                document.getElementById("modalFullAddress").innerText = addr;
                document.getElementById("modalShortAddress").innerText = addr.substring(0, 10) + "..." + addr.substring(35);
            }

            // B. Fetch Saldo
            const balance = await provider.getBalance(addr);
            const ethBalance = ethers.utils.formatEther(balance);
            
            // C. Update Teks Saldo
            if(document.getElementById("modalBalance")) {
                document.getElementById("modalBalance").innerText = parseFloat(ethBalance).toFixed(4) + " ETH";
            }
        } catch (err) {
            console.error("Gagal update modal:", err);
        }
    }

    // --- 3. CONNECT WALLET (FIXED) ---
    async function connectWallet() {
        const btn = document.getElementById("btn-connect"); 
        const btnBig = document.getElementById("btnLogin"); 
        
        // JIKA SUDAH CONNECT -> BUKA MODAL
        if (btn && btn.classList.contains("connected")) {
            toggleWalletModal();
            // Panggil update lagi untuk jaga-jaga (misal saldo berubah)
            if(viewerAddress) updateModalData(viewerAddress);
            return;
        }

        if (!window.ethereum) return alert("Install Metamask!");

        if(btn) btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
        if(btnBig) btnBig.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Menghubungkan...`;

        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            
            await switchNetwork();

            signer = provider.getSigner();
            const address = await signer.getAddress();
            
            // Simpan Sesi
            localStorage.setItem('userWallet', address);
            viewerAddress = address;
            
            // --- PANGGIL FUNGSI UPDATE MODAL DISINI ---
            await updateModalData(address);
            // ------------------------------------------

            updateConnectButtonUI(address);
            unlockGate(address);

        } catch (err) {
            console.error("Login Error:", err);
            alert("Gagal koneksi: " + err.message);
            if(btn) btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
            if(btnBig) btnBig.innerHTML = `<i class="fas fa-wallet"></i> Buka Akses`;
        }
    }

// Fungsi Update UI Tombol Navbar (Dipanggil di atas)
function updateConnectButtonUI(addr) {
    const btn = document.getElementById("btn-connect");
    if(btn) {
        btn.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
        btn.classList.add("connected");
    }
}

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_SEPOLIA_ID }],
                });
            } catch (switchError) {
                // Jika error 4902 (Chain belum ada), tambahkan otomatis
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } catch (addError) {
                        throw addError;
                    }
                } else {
                    throw switchError;
                }
            }
        }

        function requestLogin() {
            connectWallet(); // Wrapper agar tombol Login Wall memanggil fungsi yang sama
        }

        // --- LOGIKA MODAL POPUP ---

// 1. Buka/Tutup Modal dengan Animasi
function toggleWalletModal() {
    const modal = document.getElementById("walletModal");
    
    if (modal.classList.contains("active")) {
        // Tutup
        modal.classList.remove("active");
        setTimeout(() => { modal.style.display = "none"; }, 200); // Tunggu animasi CSS selesai
    } else {
        // Buka
        modal.style.display = "block";
        // Delay sedikit agar transisi opacity CSS berjalan
        setTimeout(() => { modal.classList.add("active"); }, 10);
    }
}

// 2. Tutup jika klik area gelap (Overlay)
function closeWalletModal(e) {
    if (e.target.id === "walletModal") {
        toggleWalletModal();
    }
}

// 3. Fitur Copy Address
function copyAddress() {
    const addr = document.getElementById("modalFullAddress").innerText;
    if(addr) {
        navigator.clipboard.writeText(addr).then(() => {
            // Ubah icon sementara jadi checkmark (Feedback Visual)
            const icon = document.querySelector(".copy-icon");
            if(icon) {
                const originalClass = icon.className;
                icon.className = "fas fa-check";
                setTimeout(() => { icon.className = originalClass; }, 2000);
            }
            // Jika ada fungsi toast, panggil
            // showToast("Alamat disalin!"); 
            alert("Alamat Wallet Tersalin!"); 
        });
    }
}

// 4. Fitur Disconnect / Logout
function disconnectWallet() {
    // Hapus data sesi
    localStorage.removeItem('userWallet');
    if (typeof viewerAddress !== 'undefined') viewerAddress = null;
    signer = null;

    // Reset Tombol Navbar
    const btn = document.getElementById("btn-connect");
    if(btn) {
        btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
        btn.classList.remove("connected");
    }

    // Tutup Modal & Reload Halaman
    toggleWalletModal();
    window.location.reload();
}

        // ============================================================
        // 3. LOGIKA UI & DATA LOAD
        // ============================================================
        function unlockGate(profileOwnerAddr) {
            currentAddress = profileOwnerAddr;
            
            // Sembunyikan Wall, Munculkan Konten
            const loginSec = document.getElementById("loginSection");
            const mainSec = document.getElementById("mainContent");
            if(loginSec) loginSec.style.display = "none";
            if(mainSec) mainSec.style.display = "block";
            
            updateProfileUI(currentAddress);
            loadDataCepat(currentAddress);
        }

        function updateProfileUI(addr) {
            const short = addr.substring(0, 6) + "..." + addr.substring(addr.length - 4);
            document.getElementById("displayAddress").innerText = short;
            // Gunakan Identicon Unik
            document.getElementById("avatarImg").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${addr}&backgroundColor=7385a5`;
        }

        async function loadDataCepat(targetAddress) {
            const container = document.getElementById("collectionContainer");
            const loading = document.getElementById("loading");
            const empty = document.getElementById("emptyState");
            
            container.innerHTML = "";
            loading.style.display = 'block';
            empty.style.display = 'none';

            // Fallback Provider
            if (!provider) {
                provider = new ethers.providers.JsonRpcProvider("https://sepolia.base.org");
            }

            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

            try {
                // 1. AMBIL SEMUA ID SEKALIGUS (Cepat)
                const tokenIds = await contract.walletOfOwner(targetAddress);
                document.getElementById("totalItems").innerText = tokenIds.length;

                if (tokenIds.length === 0) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                // --- TEKNIK TURBO (PARALLEL FETCHING) ---
                // Kita batasi 30 item terbaru biar browser tidak hang
                // Reverse() supaya yang terbaru muncul duluan
                const recentIds = tokenIds.slice().reverse().slice(0, 50);

                // Buat Janji (Promises) untuk mengambil semua data metadata BARENGAN
                const promises = recentIds.map(async (id) => {
                    try {
                        const uri = await contract.tokenURI(id);
                        const meta = await fetchMetadata(uri);
                        return { id: id.toString(), meta: meta }; // Kembalikan paket data
                    } catch (e) {
                        return null; // Skip jika error
                    }
                });

                // Tunggu semua data selesai didownload (Super Cepat karena barengan)
                const results = await Promise.all(promises);

                // Matikan Loading
                loading.style.display = 'none';

                // Render ke layar (Hanya data yang sukses)
                results.forEach(item => {
                    if (item) {
                        renderCard(item.id, item.meta.name, item.meta.image, container);
                    }
                });

            } catch (err) {
                console.error("Gagal load data:", err);
                loading.innerHTML = `<p style="color:red">Gagal memuat data Blockchain.</p>`;
            }
        }

        async function fetchMetadata(tokenURI) {
            try {
                let url = tokenURI.replace("ipfs://", "https://ipfs.io/ipfs/");
                const response = await fetch(url);
                const json = await response.json();
                let img = json.image ? json.image.replace("ipfs://", "https://ipfs.io/ipfs/") : "img/placeholder.jpg";
                return { name: json.name || `Wayang #${json.id}`, image: img };
            } catch (e) {
                return { name: "Data Error", image: "img/placeholder.jpg" };
            }
        }

        function renderCard(id, name, img, container) {
            // LOGIKA BADGE MILIK SENDIRI
            // Apakah Penonton (Viewer) == Pemilik Profil (CurrentAddress)?
            let isMyProfile = false;
            if (viewerAddress && currentAddress) {
                isMyProfile = viewerAddress.toLowerCase() === currentAddress.toLowerCase();
            }

            let badgeHtml = isMyProfile 
                ? `<span class="owned-badge" style="background:#f1c40f; color:#fff;"><i class="fas fa-check-circle"></i> Milik Anda</span>`
                : `<span class="owned-badge" style="background:#2ecc71; color:#fff;"><i class="fas fa-shield-alt"></i> Terverifikasi</span>`;
            
            // Tombol Revisi (Hanya muncul jika profil sendiri)
            let editBtn = isMyProfile 
                ? `<button onclick="window.location.href='revisi?id=${id}'" style="border:none; background:#d35400; color:white; font-weight: bold; border-radius:5px; font-size:9px; padding:2px 7px; cursor:pointer;"><i class="fas fa-edit"></i> Revisi</button>`
                : ``;

            const html = `
                <div class="wayang-card">
                    <div style="position:relative;">
                        ${badgeHtml} 
                        <img src="${img}" class="card-img" loading="lazy">
                    </div>
                    <div class="card-body">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span class="card-id">ID #${id}</span>
                            ${editBtn}
                        </div>
                        <h4 class="card-title">${name}</h4>
                        <div style="margin-top:10px; display:flex; gap:8px;">
    
    <a href="detail?id=${id}" class="btn-detail" 
       title="Lihat Detail"
       style="flex: 1; display:flex; align-items:center; justify-content:center;">
       <i class="fas fa-arrow-right"></i>
    </a>

    <button onclick="event.stopPropagation(); window.sawerETH('${owner}', '${name}')" 
            class="btn-detail" 
            title="Kirim Hadiah/Tip"
            style="flex: 1; display:flex; align-items:center; justify-content:center; background: #f1c40f; color: white; border: 1px solid #f39c12; cursor: pointer;">
       <i class="fas fa-gift"></i>
    </button>

</div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        }

        // --- UTILS ---
        function copyAddress() {
            if(currentAddress) {
                navigator.clipboard.writeText(currentAddress);
                const btnText = document.getElementById("btnCopyText");
                btnText.innerText = "Disalin!";
                setTimeout(() => btnText.innerText = "Salin Alamat", 2000);
            }
        }

        function cariProfile() {
            const input = document.getElementById("inputAddress").value.trim();
            if (input) window.location.href = `?address=${input}`;
        }
        function handleEnter(e) { if (e.key === "Enter") cariProfile(); }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', initGatekeeper);
        document.getElementById("year").innerText = new Date().getFullYear();

        // Auto Refresh jika akun Metamask berubah
        if(window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
                localStorage.removeItem('userWallet');
                window.location.reload();
            });
        }
    </script>
</body>
</html>
