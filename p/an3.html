<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Putramas Analytics | Public Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        /* --- STYLE PREMIUM CLEAN (Tanpa Tombol) --- */
        :root {
            --primary: #7385a5;
            --primary-dark: #5c6a84;
            --gold: #c5a059;
            --bg-body: #f8faff;
            --white: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --radius: 24px;
            --shadow: 0 10px 30px -10px rgba(115, 133, 165, 0.15);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 40px 20px; }
        .container { max-width: 1100px; margin: 0 auto; }

        /* Header */
        .header { text-align: center; margin-bottom: 50px; }
        .header h1 { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 0 0 10px 0; letter-spacing: -1px; }
        .header p { color: var(--text-muted); font-size: 1.1rem; }
        .status-badge { display: inline-block; background: #e0f2f1; color: #00695c; padding: 5px 15px; border-radius: 50px; font-size: 0.8rem; font-weight: 700; margin-top: 15px; }

        /* Grid System */
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .grid-1-2 { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; margin-bottom: 30px; }

        @media(max-width: 800px) { .grid-2, .grid-1-2 { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--white); border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.03); transition: 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -10px rgba(115, 133, 165, 0.2); }
        
        /* Stats */
        .stat-label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }
        .stat-icon { float: right; font-size: 2rem; opacity: 0.1; color: var(--primary); margin-top: -30px; }

        /* Charts */
        .chart-box { height: 250px; position: relative; width: 100%; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; color: var(--primary-dark); }

        /* Table & List */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .rank { background: var(--primary); color: #fff; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; margin-right: 10px; }
        .addr { font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; color: var(--primary-dark); font-size: 0.9rem; }
        .amt { font-weight: 700; color: #27ae60; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 0.8rem; color: var(--text-muted); padding: 10px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px 10px; font-size: 0.9rem; border-bottom: 1px solid #f8fafc; }

        /* Loading Animation */
        .skeleton { background: #e2e8f0; color: transparent !important; border-radius: 6px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* Progress Bar Tambahan */
        #progress-bar { position: fixed; top: 0; left: 0; width: 0; height: 4px; background: var(--primary); transition: width 0.3s; z-index: 999; }
    </style>
</head>
<body>

<div id="progress-bar"></div>

<div class="container">
    
    <div class="header" data-aos="fade-down">
        <h1>Putramas Analytics</h1>
        <p>Dashboard Data Publik Smart Contract (Base Mainnet)</p>
        <div class="status-badge"><i class="fas fa-circle" style="font-size:8px; margin-right:5px;"></i> LIVE DATA</div>
    </div>

    <div class="grid-4" data-aos="fade-up">
        <div class="card">
            <div class="stat-label">Total Wayang</div>
            <div class="stat-value skeleton" id="val-supply">0</div>
            <div class="stat-icon"><i class="fas fa-scroll"></i></div>
        </div>
        <div class="card">
            <div class="stat-label">Biaya Minting</div>
            <div class="stat-value skeleton" id="val-fee">0</div>
            <div class="stat-icon"><i class="fas fa-tag"></i></div>
        </div>
        <div class="card">
            <div class="stat-label">Total Donasi</div>
            <div class="stat-value skeleton" id="val-tips">0</div>
            <div class="stat-icon"><i class="fab fa-ethereum"></i></div>
        </div>
        <div class="card">
            <div class="stat-label">Rasio Official</div>
            <div class="stat-value skeleton" id="val-ratio">0%</div>
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        </div>
    </div>

    <div class="grid-2" data-aos="fade-up" data-aos-delay="100">
        <div class="card">
            <div class="card-title">Distribusi Golongan</div>
            <div class="chart-box"><canvas id="chartGolongan"></canvas></div>
        </div>
        <div class="card">
            <div class="card-title">Distribusi Gaya Seni</div>
            <div class="chart-box"><canvas id="chartGaya"></canvas></div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 30px;" data-aos="fade-up" data-aos-delay="200">
        <div class="card-title">Tren Aktivitas Minting (Bulanan)</div>
        <div class="chart-box"><canvas id="chartTrend"></canvas></div>
    </div>

    <div class="grid-1-2" data-aos="fade-up" data-aos-delay="300">
        <div class="card">
            <div class="card-title">Top Patron (Donatur)</div>
            <div id="leaderboard-container">
                <div style="text-align:center; padding:20px; color:#aaa;">Memuat Data...</div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Log Aktivitas Terkini</div>
            <div style="overflow-x:auto;">
                <table id="activity-table">
                    <thead><tr><th>Event</th><th>Address</th><th>Detail</th><th>Block</th></tr></thead>
                    <tbody><tr><td colspan="4" style="text-align:center;">Memuat...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div style="text-align:center; color:#94a3b8; font-size:0.85rem;">
        &copy; 2024 Putramas Official â€¢ Blockchain Data Viewer (Optimized by Grok)
    </div>
</div>

<script>
    AOS.init({ duration: 800, once: true });

    // --- CONFIG ---
    const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58";
    const ALCHEMY_KEY = '9WNWGMuDgG3vg8xYOM7xs'; // Key dari screenshot Anda
    const ALCHEMY_RPC = `https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_KEY}`;
    const PUBLIC_RPC = "https://mainnet.base.org"; // Fallback

    const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"RevisionFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"TipSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[],"name":"MAX_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramas.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTipByIndex","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"message","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.TipRecord","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTipCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getTipTotalBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiWayang","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"revisionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_receiver","type":"address"},{"internalType":"string","name":"_message","type":"string"}],"name":"sendTip","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setRevisionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTipsGrand","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];

    const listGolongan = ["Satria", "Dewa", "Yaksa", "Wanara", "Panakawan", "Kayon", "Bambangan", "Punggawa", "Krodan", "Resi", "Putren", "Buta Kiwe", "Sato", "Gaman"];
    
    // Variabel Global
    let provider, contract;
    let foundIds = []; 
    const CACHE_KEY = 'putramas_data_cache';
    const CACHE_EXPIRY = 5 * 60 * 1000; // 5 menit

    // --- INIT (Jalan Otomatis) ---
    window.onload = async () => {
        try {
            // 1. Setup Provider dengan Try-Catch per Provider
            let alchemyProvider;
            try {
                alchemyProvider = new ethers.providers.JsonRpcProvider(ALCHEMY_RPC);
                await alchemyProvider.getNetwork(); // Test koneksi
                console.log("Alchemy connected successfully");
            } catch (alchemyError) {
                console.error("Alchemy connection failed:", alchemyError);
                alchemyProvider = null;
            }

            const publicProvider = new ethers.providers.JsonRpcProvider(PUBLIC_RPC);
            provider = alchemyProvider || publicProvider; // Prioritas Alchemy
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
            
            console.log("Connected to Base via", alchemyProvider ? "Alchemy" : "Public RPC");

            // 2. Cek Cache
            const cachedData = getCache();
            if (cachedData) {
                renderFromCache(cachedData);
                // Update background jika expired
                setTimeout(async () => {
                    await fetchAndUpdate();
                }, 1000);
                return;
            }

            // 3. Fetch data jika no cache
            await fetchAndUpdate();

        } catch (e) {
            console.error("Init Error:", e);
            alert("Gagal memuat data dari Blockchain. Coba cek console browser (F12) untuk detail error, atau refresh.");
        } finally {
            document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));
        }
    };

    // Fungsi Cache
    function getCache() {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp > CACHE_EXPIRY) return null;
        return data;
    }

    function setCache(data) {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }));
    }

    function renderFromCache(cached) {
        // Render UI dari cache
        document.getElementById("val-supply").innerText = cached.total;
        document.getElementById("val-fee").innerText = cached.fee + " ETH";
        document.getElementById("val-tips").innerText = cached.tips + " ETH";
        document.getElementById("val-ratio").innerText = cached.ratio + "%";

        renderDoughnut("chartGolongan", listGolongan, cached.golData);
        renderPolar("chartGaya", cached.gayaLabels, cached.gayaVals);
        renderLine("chartTrend", cached.trendLabels, cached.trendVals);

        // Leaderboard
        const board = document.getElementById("leaderboard-container");
        board.innerHTML = cached.leaderboardHTML;

        // Activity Table
        const table = document.getElementById("activity-table").getElementsByTagName('tbody')[0];
        table.innerHTML = cached.activityHTML;
    }

    async function fetchAndUpdate() {
        updateProgress(0);

        const [stats, activity] = await Promise.all([
            loadGlobalStats(),  // Kembalikan data stats
            loadActivity()      // Kembalikan data activity
        ]);
        updateProgress(50);

        const deep = await loadDeepDetails(); // Kembalikan deep data
        updateProgress(100);

        // Gabung data untuk cache
        const cacheData = {
            total: stats.total,
            fee: stats.fee,
            tips: stats.tips,
            golData: stats.golData,
            ratio: deep.ratio,
            gayaLabels: deep.gayaLabels,
            gayaVals: deep.gayaVals,
            trendLabels: deep.trendLabels,
            trendVals: deep.trendVals,
            leaderboardHTML: activity.leaderboardHTML,
            activityHTML: activity.activityHTML
        };

        setCache(cacheData);
        renderFromCache(cacheData); // Update UI jika perlu
    }

    function updateProgress(percent) {
        document.getElementById('progress-bar').style.width = `${percent}%`;
    }

    // --- LOADERS TANPA MULTICALL ---
    
    async function loadGlobalStats() {
        let total = 0;
        let golData = [];
        
        // Fetch Basic
        const fee = ethers.utils.formatEther(await contract.publicMintFee().catch(() => 0));
        const tips = ethers.utils.formatEther(await contract.totalTipsGrand().catch(() => 0));

        // Fetch Golongan Loop
        const promises = listGolongan.map(async (g) => {
            const ids = await contract.getIdsByGolongan(g).catch(() => []);
            return { label: g, count: ids.length, ids: ids };
        });

        const results = await Promise.all(promises);
        
        results.forEach(res => {
            total += res.count;
            golData.push(res.count);
            if(res.ids.length > 0) foundIds.push(...res.ids);
        });

        return { total, fee, tips, golData };
    }

    async function loadDeepDetails() {
        // Variabel Statistik
        let gayaCounts = {}; 
        let officialCount = 0;
        let timeData = {}; 

        // Promise.all untuk wayangRegistry (non-multicall)
        const fetchPromises = foundIds.map(async (id) => {
            try {
                const data = await contract.wayangRegistry(id);
                return {
                    gaya: data[2], 
                    ts: data[3].toNumber(), 
                    isOff: data[5]
                };
            } catch { return null; }
        });

        const details = await Promise.all(fetchPromises);

        details.forEach(d => {
            if(!d) return;
            gayaCounts[d.gaya] = (gayaCounts[d.gaya] || 0) + 1;
            if(d.isOff) officialCount++;
            const date = new Date(d.ts * 1000);
            const key = date.toLocaleString('id-ID', { month: 'short', year: '2-digit' });
            timeData[key] = (timeData[key] || 0) + 1;
        });

        const ratio = foundIds.length > 0 ? ((officialCount / foundIds.length) * 100).toFixed(1) : "0";
        const gayaLabels = Object.keys(gayaCounts);
        const gayaVals = Object.values(gayaCounts);
        const trendLabels = Object.keys(timeData);
        const trendVals = Object.values(timeData);

        return { ratio, gayaLabels, gayaVals, trendLabels, trendVals };
    }

    async function loadActivity() {
        try {
            const currentBlock = await provider.getBlockNumber();
            const fromBlock = Math.max(0, currentBlock - 2000); // Kurangi untuk cepat
            const filter = contract.filters.TipSent();
            const events = await contract.queryFilter(filter, fromBlock, "latest");

            // Leaderboard
            let map = {};
            events.forEach(e => {
                const s = e.args.from;
                const v = parseFloat(ethers.utils.formatEther(e.args.amount));
                map[s] = (map[s] || 0) + v;
            });

            const sorted = Object.entries(map).sort(([,a],[,b]) => b - a).slice(0, 3);
            let leaderboardHTML = "";
            if(sorted.length === 0) leaderboardHTML = '<div style="text-align:center; padding:15px; color:#aaa;">Belum ada data.</div>';
            else {
                sorted.forEach((item, i) => {
                    leaderboardHTML += `
                    <div class="list-item">
                        <div style="display:flex;align-items:center;">
                            <div class="rank">${i+1}</div>
                            <div class="addr">\( {item[0].substring(0,6)}... \){item[0].slice(-4)}</div>
                        </div>
                        <div class="amt">${item[1].toFixed(4)} ETH</div>
                    </div>`;
                });
            }

            // Activity Table
            let activityHTML = "";
            const logs = events.slice(-5).reverse();
            if(logs.length === 0) activityHTML = '<tr><td colspan="4" style="text-align:center;">Tidak ada aktivitas.</td></tr>';
            else {
                logs.forEach(e => {
                    activityHTML += `
                    <tr>
                        <td><span style="color:#27ae60;font-weight:700;">Donasi</span></td>
                        <td><span class="addr">${e.args.from.substring(0,6)}...</span></td>
                        <td>${ethers.utils.formatEther(e.args.amount)} ETH</td>
                        <td style="color:#aaa;">${e.blockNumber}</td>
                    </tr>`;
                });
            }

            return { leaderboardHTML, activityHTML };
        } catch(e) { console.warn("Activity fetch error:", e); return { leaderboardHTML: '<div style="text-align:center; padding:15px; color:#aaa;">Error memuat.</div>', activityHTML: '<tr><td colspan="4" style="text-align:center;">Error memuat.</td></tr>' }; }
    }

    // --- CHARTS CONFIG --- (sama)
    Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
    Chart.defaults.color = '#64748b';

    function renderDoughnut(id, lbl, dat) {
        new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: { labels: lbl, datasets: [{ data: dat, backgroundColor: ['#7385a5', '#c5a059', '#a6b4cd', '#e2e8f0', '#1e293b', '#64748b'], borderWidth:0 }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function renderPolarChart(id, labels, data) {
        const ctx = document.getElementById(id);
        if(!ctx) return;
        let chart = Chart.getChart(id);
        if (chart) chart.destroy();

        // Warna Premium
        const premiumColors = [
            'rgba(115, 133, 165, 0.8)', 'rgba(197, 160, 89, 0.8)', 
            'rgba(92, 106, 132, 0.8)', 'rgba(227, 233, 244, 0.9)',
            'rgba(143, 113, 58, 0.8)'
        ];

        new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jumlah',
                    data: data,
                    backgroundColor: premiumColors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { ticks: { display: false }, grid: { display: false } } },
                plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true, font: { size: 10 } } } }
            }
        });
    }

    function renderLine(id, lbl, dat) {
        new Chart(document.getElementById(id), {
            type: 'line',
            data: { labels: lbl, datasets: [{ label: 'Minting', data: dat, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', fill:true, tension:0.4 }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize:1 }, grid: { borderDash:[5,5] } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

</script>
</body>
</html>
