<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda - Putramas Social Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* --- CSS UTAMA (SOSMED STYLE) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Rubik', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 90px; color: #1c1e21; }

        /* NAVBAR ATAS */
        .top-navbar {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 1000; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .brand { font-size: 18px; font-weight: 800; color: #7385a5; display: flex; align-items: center; gap: 8px; }
        .brand img { width: 30px; height: 30px; border-radius: 50%; }
        .btn-connect { background: #e4e6eb; border: none; padding: 8px 15px; border-radius: 20px; font-weight: 600; font-size: 13px; cursor: pointer; }
        .btn-connect.connected { background: #e7f3ff; color: #1877f2; }

        .feed-container { max-width: 600px; margin: 0 auto; padding: 10px; }

        /* UPLOAD BOX */
        .upload-trigger {
            background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: flex; gap: 10px; align-items: center; cursor: pointer;
        }
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; background: #eee; }
        .fake-input { flex: 1; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; color: #65676b; font-size: 14px; }

        .upload-form-box { max-height: 0; overflow: hidden; opacity: 0; transition: 0.4s; margin-bottom: 10px; }
        .upload-form-box.open { max-height: 800px; opacity: 1; margin-bottom: 20px; }
        .form-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0; }
        .preview-box { width: 100%; height: 180px; background: #fafafa; border: 2px dashed #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; overflow: hidden; cursor: pointer; }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .btn-post { width: 100%; background: #7385a5; color: #fff; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* FEED CARD */
        .feed-card { background: #fff; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 15px; overflow: hidden; animation: fadeIn 0.5s ease; }
        .card-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-pic { width: 32px; height: 32px; border-radius: 50%; }
        .user-name { font-weight: 600; font-size: 14px; }
        .post-time { font-size: 11px; color: #65676b; }
        .card-image { width: 100%; min-height: 300px; background: #f0f2f5; display: flex; align-items: center; justify-content: center; cursor: pointer;}
        .card-image img { width: 100%; height: auto; display: block; }
        .card-content { padding: 12px 15px; }
        .wayang-title { font-size: 16px; font-weight: bold; margin: 0 0 5px 0; }
        .tag-badge { background: #e7f3ff; color: #1877f2; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .card-actions { padding: 8px 15px; border-top: 1px solid #f0f2f5; display: flex; justify-content: space-between; }
        .action-btn { background: none; border: none; color: #65676b; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        
        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 5000; }
        .nav-link { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #65676b; font-size: 10px; width: 25%; background:none; border:none; cursor:pointer;}
        .nav-link i { font-size: 22px; margin-bottom: 4px; transition: 0.2s; }
        .nav-link.active { color: #1877f2; }
        .nav-link.active i { transform: scale(1.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .verified-badge { color: #1877f2; font-size: 12px; margin-left: 4px; }
        .verified-gold { color: #f1c40f; font-size: 12px; margin-left: 4px; }
    </style>
</head>
<body>

    <nav class="top-navbar">
        <div class="brand"><img src="img/icon-192.png"> Putramas Feed</div>
        <button class="btn-connect" id="btnConnect" onclick="connectWallet()"><i class="fas fa-wallet"></i> Konek</button>
    </nav>

    <div class="feed-container">
        <div class="upload-trigger" onclick="toggleForm()">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="my-avatar">
            <div class="fake-input">Apa wayang terbaru Anda? Upload di sini...</div>
            <i class="fas fa-images" style="color: #45bd62; font-size: 20px;"></i>
        </div>

        <div class="upload-form-box" id="uploadBox">
            <div class="form-card">
                <div class="preview-box" onclick="document.getElementById('fileUpload').click()">
                    <img id="imgPreview">
                    <div id="textPreview" style="text-align:center; color:#aaa;">
                        <i class="fas fa-cloud-upload-alt" style="font-size:24px;"></i><br>Pilih Foto
                    </div>
                </div>
                <input type="file" id="fileUpload" hidden onchange="previewImage()">
                <input type="text" id="inputNama" class="form-input" placeholder="Nama Wayang">
                <div style="display:flex; gap:10px;">
                    <select id="inputGol" class="form-input"><option value="Satria">Satria</option><option value="Dewa">Dewa</option></select>
                    <select id="inputGaya" class="form-input"><option value="Surakarta">Surakarta</option><option value="Yogyakarta">Yogyakarta</option></select>
                </div>
                <button class="btn-post" onclick="uploadWayang()"><i class="fas fa-paper-plane"></i> Posting</button>
            </div>
        </div>

        <div id="feedContent">
            <div style="text-align:center; padding:40px; color:#aaa;">
                <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat...
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="beranda.html" class="nav-link active"><i class="fas fa-home"></i><span>Beranda</span></a>
        <a href="index.html" class="nav-link"><i class="fas fa-crown"></i><span>Official</span></a>
        <a href="index.html" class="nav-link"><i class="fas fa-globe-asia"></i><span>Global</span></a>
        <button class="nav-link" onclick="window.scrollTo(0,0); toggleForm();"><i class="fas fa-plus-circle" style="color:#7385a5; font-size:24px;"></i><span>Upload</span></button>
    </nav>

    <script>
    // --- KONFIGURASI ---
    const CHAIN_ID_BASE = "0x2105"; 
    const BASE_RPC = "https://mainnet.base.org"; 
    const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58"; 
    const OFFICIAL_WALLET = "0xBAcc1F6e717bF03dB0c40E3044DA47318C369B70";
    const CACHE_FEED_KEY = "PUTRAMAS_FEED_V1_MAINNET"; 

    // ABI Minimal
    const ABI = [
        "function getInfoWayang(uint256 tokenId) view returns (tuple(string nama, string golongan, string gaya, uint256 timestamp, bool isActive, bool isOfficial, address creator))",
        "function tokenURI(uint256 tokenId) view returns (string)",
        "function ownerOf(uint256 tokenId) view returns (address)",
        "function totalLikes(uint256 tokenId) view returns (uint256)",
        "function getIdsByGolongan(string golongan) view returns (uint256[])",
        "function uploadPublik(string _tokenURI, string _nama, string _golongan, string _gaya) payable",
        "function publicMintFee() view returns (uint256)"
    ];
    
    let contractReader;
    let feedData = []; 

    // --- INIT ---
    window.onload = async () => {
        const rpcProvider = new ethers.providers.JsonRpcProvider(BASE_RPC);
        contractReader = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpcProvider);
        
        checkWalletConnection();
        loadFeedTurbo(); // Start Turbo Engine
    };

    // --- TURBO LOAD LOGIC ---
    async function loadFeedTurbo() {
        const container = document.getElementById("feedContent");
        
        // 1. Cek Cache (Instant)
        const cachedRaw = localStorage.getItem(CACHE_FEED_KEY);
        let hasCache = false;

        if (cachedRaw) {
            try {
                const cached = JSON.parse(cachedRaw);
                if (cached.data && cached.data.length > 0) {
                    console.log("ðŸš€ Turbo Mode: Data dari Cache");
                    feedData = cached.data;
                    renderFeedFromArray(feedData);
                    hasCache = true;
                }
            } catch (e) { localStorage.removeItem(CACHE_FEED_KEY); }
        }

        if (!hasCache) container.innerHTML = `<div style="text-align:center; padding:40px; color:#aaa;"><i class="fas fa-circle-notch fa-spin fa-2x"></i><br>Sinkronisasi Blockchain...</div>`;

        // 2. Background Sync
        await syncBackgroundData(hasCache);
    }

    async function syncBackgroundData(isSilentMode) {
        const golongans = ['Satria', 'Dewa', 'Yaksa', 'Wanara', 'Panakawan', 'Kayon', 'Bambangan', 'Punggawa', 'Krodan', 'Resi', 'Putren', 'Buta Kiwe', 'Sato', 'Gaman'];

        try {
            const promises = golongans.map(gol => contractReader.getIdsByGolongan(gol));
            const results = await Promise.all(promises);
            
            let allIds = results.flat().map(id => parseInt(id));
            allIds = [...new Set(allIds)].sort((a, b) => b - a); // Sort Terbaru

            const top20Ids = allIds.slice(0, 20);

            // Cek Update
            const currentTopId = feedData.length > 0 ? feedData[0].id : -1;
            const blockchainTopId = top20Ids.length > 0 ? top20Ids[0] : -1;

            if (blockchainTopId === currentTopId) return; // Data sudah update

            console.log("ðŸ”„ Ada data baru! Mengambil...");
            if (!isSilentMode) document.getElementById("feedContent").innerHTML = ""; 

            const freshData = [];
            for (let id of top20Ids) {
                const existingItem = feedData.find(item => item.id === id);
                if (existingItem) {
                    freshData.push(existingItem);
                } else {
                    const item = await fetchWayangDetail(id);
                    if (item) freshData.push(item);
                }
            }

            feedData = freshData;
            localStorage.setItem(CACHE_FEED_KEY, JSON.stringify({ timestamp: Date.now(), data: feedData }));
            renderFeedFromArray(feedData);

        } catch (e) { console.error("Sync Error:", e); }
    }

    async function fetchWayangDetail(id) {
        try {
            const [info, uri, owner, likes] = await Promise.all([
                contractReader.getInfoWayang(id),
                contractReader.tokenURI(id),
                contractReader.ownerOf(id),
                contractReader.totalLikes(id)
            ]);

            if (!info.isActive) return null;

            let imgUrl = "img/loading.gif";
            try {
                let cleanUri = uri.replace("ipfs://", "https://magenta-secondary-guan-686.mypinata.cloud/ipfs/");
                const res = await axios.get(cleanUri); 
                let rawImg = res.data.image || res.data.image_url;
                rawImg = rawImg.replace("ipfs://", "https://magenta-secondary-guan-686.mypinata.cloud/ipfs/");
                imgUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawImg)}&w=500&q=75&output=webp`;
            } catch (e) {}

            const isOfficial = (owner.toLowerCase() === OFFICIAL_WALLET.toLowerCase());
            const dateStr = new Date(info.timestamp * 1000).toLocaleDateString("id-ID");

            return { id: id, nama: info.nama, golongan: info.golongan, gaya: info.gaya, owner: owner, isOfficial: isOfficial, likes: parseInt(likes), imgUrl: imgUrl, dateStr: dateStr };
        } catch (e) { return null; }
    }

    function renderFeedFromArray(dataArray) {
        const container = document.getElementById("feedContent");
        let html = "";

        dataArray.forEach(item => {
            const badge = item.isOfficial ? `<i class="fas fa-check-circle verified-gold"></i>` : `<i class="fas fa-check-circle verified-badge"></i>`;
            const senderName = item.isOfficial ? "Putramas Official" : item.owner.substring(0,6) + "...";
            const avatar = `https://api.dicebear.com/7.x/identicon/svg?seed=${item.owner}`;

            html += `
            <div class="feed-card">
                <div class="card-header">
                    <div class="user-info">
                        <img src="${avatar}" class="user-pic">
                        <div><div class="user-name">${senderName} ${badge}</div><div class="post-time">${item.dateStr} â€¢ ID #${item.id}</div></div>
                    </div>
                    <i class="fas fa-ellipsis-h" style="color:#ccc;"></i>
                </div>
                <div class="card-content">
                    <h3 class="wayang-title">${item.nama}</h3>
                    <div class="wayang-desc"><span class="tag-badge">${item.golongan}</span> <span class="tag-badge" style="background:#fef3c7; color:#d97706;">${item.gaya}</span></div>
                </div>
                <div class="card-image" onclick="window.location.href='detail?id=${item.id}'"><img src="${item.imgUrl}" loading="lazy"></div>
                <div class="card-actions">
                    <button class="action-btn"><i class="far fa-heart"></i> ${item.likes}</button>
                    <button class="action-btn" onclick="window.location.href='detail?id=${item.id}'"><i class="far fa-comment"></i> Ulasan</button>
                    <button class="action-btn"><i class="fas fa-share"></i> Share</button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    // --- UI & WALLET ---
    function toggleForm() { document.getElementById("uploadBox").classList.toggle("open"); }
    
    function previewImage() {
        const file = document.getElementById("fileUpload").files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById("imgPreview").src = e.target.result;
            document.getElementById("imgPreview").style.display = "block";
            document.getElementById("textPreview").style.display = "none";
        }
        reader.readAsDataURL(file);
    }

    async function checkWalletConnection() {
        if(window.ethereum) {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await provider.listAccounts();
            if(accounts.length > 0) document.getElementById("btnConnect").classList.add("connected");
        }
    }

    async function connectWallet() {
        if(!window.ethereum) return alert("Metamask tidak ada!");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const net = await provider.getNetwork();
        if(net.chainId !== 8453) {
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID_BASE }] }); } catch(e) { alert("Pindah ke Base Mainnet!"); }
        }
        location.reload();
    }

    async function uploadWayang() {
        if(!window.ethereum) return alert("Konek Wallet dulu!");
        alert("Fitur upload perlu integrasi IPFS. Silakan copy logika upload dari index.html Anda ke fungsi ini.");
    }
    </script>
</body>
</html>
