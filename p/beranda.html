<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda - Putramas Social Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* --- CSS UTAMA (GAYA SOSMED PREMIUM) --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f6f9ff; /* Warna background khas FB/Twitter */
            margin: 0; padding: 0;
            padding-bottom: 80px; /* Spacer untuk menu bawah */
            color: #1c1e21;
        }

        /* NAVBAR ATAS */
        .top-navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: #fff;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .brand { font-size:20px; color: #7385a5; font-weight:bold; }
        .brand-img { width: 45px; height: 45px;
            border-radius: 50%;
            border: 2px solid #7385a5;
            object-fit: cover; }
        
        .btn-connect {
            background: transparent; color: #7385a5; border: 2px solid #7385a5; 
            padding: 10px 25px; cursor: pointer; font-family: 'Rubik', sans-serif; 
            font-weight: bold; border-radius: 30px; transition: 0.3s; font-size: 14px;
        }
        .btn-connect.connected { background: #7385a5; color: #fff; border-color: #abb6c9; cursor: default }
        .btn-connect.hover { background: #f6f9ff; color: #7385a5; border: 2px solid #7385a5; }

        @media (max-width: 600px) {
            .top-navbar { padding: 15px 20px; }
            .brand { font-size: 0.9em; }
            .btn-connect { padding: 8px 15px; font-size: 12px; }
            h1 { font-size: 2em; }
        }
        
        
        /* CONTAINER UTAMA (Feed Tengah) */
.feed-container { 
    width: 100%;            /* Biar fleksibel mengikuti kolom Grid */
    max-width: 700px;       /* Lebar feed sedikit diperluas agar lega di PC */
    margin: 0;              /* Hapus 'auto' agar tidak lari ke tengah sendiri di PC */
    padding: 10px; 
}

/* Responsif: Di HP tetap ke tengah */
@media (max-width: 900px) {
    .feed-container {
        max-width: 600px;
        margin: 0 auto;     /* Kembali ke tengah saat mode HP */
    }
}
        /* --- 1. FITUR UPLOAD INSTAN (DROPDOWN) --- */
        .upload-trigger {
            background: #fff; padding: 15px; border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; gap: 10px; align-items: center; cursor: pointer;
            transition: background 0.2s;
        }
        .upload-trigger:active { background: #f2f2f2; }
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; background: none; object-fit: cover; }
        .fake-input {
            flex: 1; background: #f0f2f5; padding: 10px 15px; border-radius: 20px;
            color: #65676b; font-size: 14px;
        }
        
        /* FORM UPLOAD (TERSEMBUNYI) */
        /* --- PERBAIKAN CSS FORMULIR (SCROLLABLE) --- */

.upload-form-box {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    margin-bottom: 10px;
    
    /* Tambahan agar scroll halus */
    scrollbar-width: thin; 
    scrollbar-color: #ccc transparent;
}

.upload-form-box.open {
    /* Ubah tinggi maksimal jadi 80% layar HP (biar gak kepotong) */
    max-height: 75vh; 
    
    /* AKTIFKAN SCROLL JIKA KONTEN PANJANG */
    overflow-y: auto; 
    
    opacity: 1;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

/* Mempercantik Scrollbar (Opsional) */
.upload-form-box::-webkit-scrollbar { width: 5px; }
.upload-form-box::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
.upload-form-box::-webkit-scrollbar-track { background: transparent; }
        
        .form-card {
            background: #fff; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;
        }
        .preview-box {
            width: 100%; height: 180px; background: #fafafa; border: 2px dashed #ccc;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; overflow: hidden; position: relative; cursor: pointer;
        }
        .preview-box img { width: 35%; object-fit: cover; display: none; }
        .input-group { margin-bottom: 10px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .btn-post {
            width: 100%; background: #7385a5; color: #fff; padding: 12px;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .btn-post:disabled { background: #ccc; cursor: not-allowed; }

        /* --- 2. CARD FEED (TAMPILAN WAYANG) --- */
        .feed-card {
            background: #fff; border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 15px; overflow: hidden;
            animation: fadeIn 0.5s ease;
        }
        .card-header {
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-pic { width: 32px; height: 32px; border-radius: 50%; background: #eee; }
        .user-name { font-weight: 600; font-size: 14px; color: #050505; }
        .post-time { font-size: 11px; color: #65676b; }
        
        .card-image {
            width: 100%; min-height: 300px; background: #f0f2f5;
            display: flex; align-items: center; justify-content: center;
        }
        .card-image img { width: 100%; height: auto; display: block; }
        
        .card-content { padding: 12px 15px; }
        .wayang-title { font-size: 16px; font-weight: bold; margin: 0 0 5px 0; color: #4d4d4d; }
        .wayang-desc { font-size: 13px; color: #65676b; margin-bottom: 10px; }
        .tag-badge { 
            background: #e9f0ff; color: #7385a5; padding: 3px 8px; 
            border-radius: 4px; font-size: 11px; font-weight: 600; 
        }

        .card-actions {
    padding: 8px 12px;
    border-top: 1px solid #f0f2f5;

    display: flex;
    align-items: center;
    justify-content: space-around;
}

.action-btn {
    background: none;
    border: none;
    color: #666;

    font-size: 20px;
    font-weight: 600;
    cursor: pointer;

    display: flex;
    align-items: center;
    justify-content: center;

    padding: 6px;

    transition:
        color 0.25s ease,
        transform 0.25s ease,
        filter 0.25s ease;
}

.action-btn:hover {
    color: #7385a5;
    transform: translateY(-1px);
    filter: drop-shadow(0 4px 8px rgba(115, 133, 165, 0.25));
}

.action-btn:active {
    transform: scale(0.9);
}

        /* --- 3. NAVIGASI BAWAH (FACEBOOK STYLE) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: #fff; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 5000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;

    text-decoration: none;
    color: #666;
    font-size: 10px;
    width: 20%;

    background: none;
    border: none;
    padding: 6px 0;          /* sedikit ruang napas */
    cursor: pointer;

    transition:
        color 0.25s ease,
        transform 0.25s ease;
}

/* Icon */
.nav-link i {
    font-size: 22px;
    margin-bottom: 4px;

    transition:
        transform 0.25s ease,
        color 0.25s ease,
        filter 0.25s ease;
}

/* Hover: soft, elegan */
.nav-link:hover {
    color: #7385a5;
}

.nav-link:hover i {
    transform: translateY(-2px) scale(1.05);
    color: #7385a5;
    background: #e9f0ff;
    border-radius: 50px;
    border: 1px solid #7385a5;
    filter: drop-shadow(0 4px 8px rgba(115, 133, 165, 0.25));
}

/* Active (sedikit lebih tegas tapi tetap senada) */
.nav-link.active {
    color: #7385a5;
}

.nav-link.active i {
    transform: scale(1.08);
    filter: drop-shadow(0 6px 12px rgba(115, 133, 165, 0.35));
}

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Official Badge */
        .verified-badge { color: #1877f2; font-size: 12px; margin-left: 4px; }
        .verified-gold { color: #f1c40f; font-size: 12px; margin-left: 4px; }

        /* --- CSS TAMBAHAN UNTUK FORM LENGKAP --- */
fieldset {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 15px;
    background: #fafafa;
}
        
legend {
    font-size: 15px;
    font-weight: bold;
    color: #7385a5;
    padding: 4px 12px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
}
        
label {
    display: block;
    font-size: 10px;
    color: #555;
    margin-bottom: 4px;
    font-weight: 600;
    text-transform: uppercase;
}
/* Mempercantik Inputan */
.form-input, select, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 13px;
    margin-bottom: 10px;
    background: #fff;
    font-family: 'Rubik', sans-serif;
}
.form-input:focus { border-color: #7385a5; outline: none; }

        /* --- STYLE PENCARIAN GOOGLE --- */
.search-google-style {
    background: #fff;
    border-radius: 30px; /* Membulat ala Google */
    padding: 8px 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Bayangan halus */
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
}

.search-google-style:focus-within {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Bayangan menebal saat diketik */
    border-color: #dfe1e5;
}

.search-google-style input {
    flex: 1;
    border: none;
    padding: 10px;
    font-size: 15px;
    outline: none;
    color: #333;
    font-family: 'Rubik', sans-serif;
    background: transparent;
}

.search-icon-g { 
    color: #9aa0a6; 
    font-size: 18px; 
    margin-right: 10px; 
}

.search-clear-g { 
    color: #5f6368; 
    cursor: pointer; 
    font-size: 16px; 
    padding: 5px; 
    display: none; /* Sembunyi default */
    transition: color 0.2s;
}

.search-clear-g:hover { color: #333; }

        /* Efek hover pada header user */
.user-info:hover .user-name {
    text-decoration: underline;
    color: #1877f2; /* Warna biru link khas sosmed */
}

.user-info:hover .user-pic {
    filter: brightness(0.9);
}

        /* Layout Wrapper Utama */
.main-wrapper {
    display: flex;
    justify-content: center;
    gap: 30px;
    padding: 20px 5%;
}

/* Sidebar Samping (Default Sembunyi untuk HP) */
.sidebar-left, .sidebar-right {
    display: none; /* Sembunyikan di HP */
    width: 280px;
    position: sticky;
    top: 90px;
    height: fit-content;
}

/* Responsif: Mode PC (Layar Lebar) */
@media (min-width: 1100px) {
    .sidebar-left, .sidebar-right {
        display: block; /* Munculkan di PC */
    }

    .feed-container {
        max-width: 600px;
        margin: 0; /* Hilangkan auto margin agar tidak bergeser */
    }

    /* Sembunyikan Navigasi Bawah di PC karena sudah ada Navbar Atas/Sidebar */
    .bottom-nav {
        display: none !important;
    }
}

/* Style Item Sidebar Ala Facebook */
.sidebar-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 15px;
    transition: background 0.2s;
    color: #1c1e21;
}

.sidebar-item:hover {
    background: #e4e6eb;
}

.sidebar-item i {
    font-size: 20px;
    color: #7385a5;
    width: 24px;
    text-align: center;
}

.sidebar-label {
    padding: 10px 15px;
    font-size: 13px;
    font-weight: bold;
    color: #65676b;
}

.ad-card {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    margin-top: 10px;
}

.ad-card img {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 10px;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    font-size: 14px;
}

.status-online {
    width: 10px;
    height: 10px;
    background: #31a24c;
    border-radius: 50%;
}

/* Fix Navbar untuk PC agar center-aligned */
@media (min-width: 1100px) {
    .top-navbar {
        padding: 10px 15%; /* Lebih lebar ke tengah di PC */
    }
}

        /* Layout Wrapper: 2 Kolom (Sidebar 300px + Feed 1fr) */
.layout-wrapper { 
    display: grid; 
    grid-template-columns: 300px 1fr; 
    gap: 25px; 
    max-width: 1200px; 
    margin: 0 auto;
    padding: 20px 15px;
    align-items: start;
}

/* Sidebar Kiri Sticky di PC */
.sidebar-left {
    position: sticky;
    top: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Menu Card Sidebar */
.menu-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid rgba(115, 133, 165, 0.1);
}

.sidebar-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 18px;
    border-radius: 12px;
    text-decoration: none;
    color: #4b5563;
    font-weight: 500;
    margin-bottom: 5px;
    transition: all 0.25s;
}

.sidebar-item:hover, .sidebar-item.active {
    background: #f0f7ff;
    color: #7385a5;
    transform: translateX(5px);
}

.sidebar-item i { font-size: 20px; width: 25px; text-align: center; }

/* Wallet Mini Info Styling */
.wallet-mini-info {
    padding: 10px 5px;
    text-align: center;
}

.balance-display {
    font-size: 24px;
    font-weight: 800;
    color: #1c1e21;
    margin: 10px 0;
}

.address-short {
    font-family: monospace;
    font-size: 12px;
    color: #666;
    font-weight: bold;
    background: #f8fafc;
    padding: 5px;
    border-radius: 6px;
}

/* RESPONSIF: Atur Sembunyi/Muncul */
@media (max-width: 900px) {
    .layout-wrapper { grid-template-columns: 1fr; padding-bottom: 100px; }
    .sidebar-left { display: none !important; } /* Sembunyi di HP */
    .bottom-nav { display: flex !important; }   /* Muncul di HP */
}

@media (min-width: 901px) {
    .bottom-nav { display: none !important; }   /* Sembunyi di PC */
}

        .upload-form-box.open {
    max-height: 80vh; /* Agar tetap bisa di-scroll di dalam area feed */
    overflow-y: auto;
        }

/* 1. Overlay Transparan (Hanya untuk deteksi klik luar) */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: transparent; /* Tidak ada warna/blur */
    backdrop-filter: none;
    z-index: 9998;
    display: none;
    /* Ubah dari flex ke block agar kita bisa atur posisi absolute manual */
    display: none; 
}

.modal-overlay.active {
    display: block; 
}

/* 2. Kartu Modal (Menjadi Dropdown) */
.modal-card {
    position: absolute; /* Kunci posisi */
    
    /* ATUR POSISI DISINI SESUAI TINGGI NAVBAR ANDA */
    top: 70px;  /* Jarak dari atas (sesuaikan dengan tinggi navbar) */
    right: 20px; /* Jarak dari kanan (supaya lurus dengan tombol connect) */
    
    width: 300px; /* Lebar fix agar rapi */
    background: #fff;
    padding: 20px;
    border-radius: 12px; /* Radius lebih kecil ala dropdown */
    
    /* Shadow Premium Soft */
    box-shadow: 0 5px 30px rgba(0,0,0,0.15); 
    border: 1px solid rgba(0,0,0,0.05); /* Border tipis halus */
    
    text-align: center;
    font-family: 'Rubik', sans-serif;
    
    /* Animasi Muncul dari atas */
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    transform-origin: top right; /* Animasi mulai dari pojok kanan atas */
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* State Aktif */
.modal-overlay.active .modal-card {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* (Opsional) Segitiga Kecil Penunjuk ke Atas (Arrow) */
.modal-card::before {
    content: "";
    position: absolute;
    top: -6px; /* Muncul di atas kotak */
    right: 20px; /* Posisi sejajar tombol */
    width: 12px;
    height: 12px;
    background: #fff;
    transform: rotate(45deg); /* Putar jadi wajik */
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
    box-shadow: -2px -2px 5px rgba(0,0,0,0.02);
}
    
/* Header */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.modal-header h3 { margin: 0; font-size: 18px; color: #333; }
.close-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }

/* Status Badge & Dot Kelap Kelip */
.modal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.status-badge {
    color: #27ae60;
    font-weight: bold;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-label { color: #888; }
    
.pulse-dot {
    width: 8px; height: 8px;
    background-color: #27ae60;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(39, 174, 96, 0.4);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(39, 174, 96, 0); }
    100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
}

/* Saldo */
.modal-balance { margin-bottom: 20px; }
.balance-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
.balance-amount { font-size: 24px; font-weight: bold; color: #2c3e50; margin-top: 5px; }

/* Address Box (Copyable) */
.modal-address-box {
    background: #f1f2f6;
    padding: 12px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    margin-bottom: 25px;
}
.modal-address-box:hover { border-color: #3498db; background: #eaf6ff; }
.address-text { font-family: monospace; font-size: 14px; color: #555; }
.copy-icon { color: #3498db; }

/* Tombol Aksi */
.modal-actions { display: flex; flex-direction: column; gap: 10px; }
.action-btn {
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    transition: transform 0.1s;
}
.action-btn:active { transform: scale(0.98); }
.action-btn.primary { background: #7385a5; color: white; }
.action-btn.danger { background: #fee; color: #e74c3c; border: 1px solid #fcc; }

.footer {
            background: #fff;
            padding: 20px 20px;
            margin-top: 25px;
            text-align: center;
            width: 100%; /* WAJIB FULL */
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .social-icons { margin-bottom: 10px; }
        
        .social-link {
            display: inline-flex; justify-content: center; align-items: center;
            width: 35px; height: 35px; margin: 0 07px;
            border-radius: 50%; background: #7385a5; color: #fff;
            font-size: 15px; transition: all 0.3s ease; border: 1.5px solid #7385a5;
            text-decoration: none;
        }
        .social-link:hover {
            background: #fff; color: #7385a5;
            transform: translateY(-5px); box-shadow: 0 0 15px #7385a5;
        }

        .copyright { color: #888; font-size: 13px; letter-spacing: 1px; margin-top: 1px; }
        
        /* Animasi Dot Status: Premium & Semi-Aggressive */
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(39, 174, 96, 0.1); /* Latar hijau tipis */
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid rgba(39, 174, 96, 0.3);
    font-size: 11px;
    font-weight: 700;
    color: #27ae60;
    letter-spacing: 0.5px;
}

.pulse-dot {
    width: 8px;
    height: 8px;
    background-color: #2ecc71; /* Hijau Terang */
    border-radius: 50%;
    position: relative;
    z-index: 1;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.8); /* Glow inti */
}

/* Efek Denyut (Pulse) */
.pulse-dot::after {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 100%; height: 100%;
    border-radius: 50%;
    background-color: inherit;
    opacity: 0.6;
    z-index: -1;
    animation: aggressive-pulse 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
}

@keyframes aggressive-pulse {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
    50% { opacity: 0.3; }
    100% { transform: translate(-50%, -50%) scale(3); opacity: 0; box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
}
        .token-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    margin-bottom: 6px;
    transition: 0.2s;
}

.token-item:hover { background: rgba(255, 255, 255, 0.08); }

.token-left { display: flex; align-items: center; gap: 10px; }

.token-logo-img {
    width: 30px; height: 30px;
    border-radius: 50%;
    object-fit: cover;
    background: #fff;
    border: 1px solid #444;
}

.token-meta { display: flex; flex-direction: column; }
.token-name { font-size: 11px; font-weight: bold; color: #4d4d4d; }
.token-symbol { font-size: 9px; font-weight: bold; color: #808080; text-transform: uppercase; }

.token-balance {
    text-align: right;
    font-size: 11px;
    font-weight: bold;
    color: #7385a5;
}

.delete-token-btn {
    font-size: 10px; color: #ef4444; margin-left: 8px; cursor: pointer; opacity: 0.5;
}
.delete-token-btn:hover { opacity: 1; }

        .token-value-sub {
    font-size: 9px;
    color: #4d4d4d; /* Abu-abu agak terang */
    text-align: right;
    font-weight: bold;
    margin-top: 2px;
    font-family: 'Courier New', monospace;
    letter-spacing: -0.5px;
        }

        /* Style Tombol Persentase */
.p-btn {
    background: #1e2329;
    border: 1px solid #333;
    color: #94a3b8;
    font-size: 10px;
    padding: 6px 0;
    border-radius: 4px;
    cursor: pointer;
    transition: 0.2s;
}
.p-btn:hover { background: #333; color: #fff; }
.p-btn:active { transform: scale(0.95); }

/* Validasi Border Merah/Hijau */
.input-error { border: 1px solid #ef4444 !important; }
.input-success { border: 1px solid #2ecc71 !important; }

/* Tombol Kirim Aktif */
.btn-ready {
    background: #2ecc71 !important;
    color: #000 !important;
    cursor: pointer !important;
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
}
        /* Wrapper Utama */
.custom-select-wrapper {
    position: relative;
    user-select: none;
    width: 100%;
}

/* Kotak Pemicu (Yang diklik) */
.custom-select-trigger {
    background: #0b0e11;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #fff;
    font-weight: bold;
    font-size: 14px;
    transition: 0.2s;
}

.custom-select-trigger:hover {
    border-color: #555;
    background: #11151a;
}

/* Logo Kecil */
.token-mini-logo {
    width: 20px; 
    height: 20px; 
    border-radius: 50%; 
    object-fit: cover;
}

/* Daftar Opsi (Dropdown) */
.custom-options {
    position: absolute;
    top: 110%; /* Muncul di bawah */
    left: 0;
    right: 0;
    background: #15191e;
    border: 1px solid #333;
    border-radius: 8px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* Saat dropdown aktif */
.custom-select-wrapper.open .custom-options {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

/* Item di dalam list */
.custom-option {
    padding: 10px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #ccc;
    font-size: 13px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.custom-option:hover {
    background: #20252b;
    color: #fff;
}

/* Scrollbar tipis untuk dropdown */
.custom-options::-webkit-scrollbar { width: 3px; }
.custom-options::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

/* Container Scroll Token */
.token-scroll-area {
    max-height: 250px; /* Batas tinggi maksimal (sekitar 4-5 token) */
    overflow-y: auto;  /* Munculkan scroll jika lebih panjang */
    padding-right: 5px; /* Beri jarak untuk scrollbar */
    
    /* Agar scrollbar terlihat rapi */
    scrollbar-width: thin; 
    scrollbar-color: #d5dae4 transparent;
}

/* Kustomisasi Scrollbar (Webkit / Chrome) */
.token-scroll-area::-webkit-scrollbar {
    width: 3px;
}
.token-scroll-area::-webkit-scrollbar-thumb {
    background-color: #d5dae4;
    border-radius: 3px;
}
.token-scroll-area::-webkit-scrollbar-track {
    background: transparent;
}

        /* --- CSS RIWAYAT TRANSAKSI --- */
.history-container {
    max-height: 250px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #d5dae4 transparent;
}

.history-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: 0.2s;
}

.history-item:last-child { border-bottom: none; }
.history-item:hover { background: #f8f9fa; border-radius:6px; padding: 10px 5px; }

.history-icon {
    width: 25px; height: 25px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
}

/* Warna-Warni Ikon */
.icon-mint { background: #e9f0ff; color: #7385a5; } /* Ungu: Mint */
.icon-in { background: rgba(46, 204, 113, 0.15); color: #2ecc71; }   /* Hijau: Masuk */
.icon-out { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }   /* Merah: Keluar */
.icon-tip { background: rgba(155, 89, 182, 0.15)); color: #9b59b6; }  /* Kuning: Sawer */

.history-content { flex: 1; }
.history-title { font-size: 12px; font-weight: bold; color: #2c3e50; }
.history-sub { font-size: 10px; color: #7f8c8d; margin-top: 2px; }
.history-val { font-size: 11px; font-weight: bold; color: #34495e; text-align: right; }

        /* 1. Mengatur UKURAN (Lebar) Scrollbar */
.history-container::-webkit-scrollbar {
    width: 3px;  /* Ganti angka ini untuk memperbesar/memperkecil */
}

/* 2. Mengatur WARNA Batang (Yang bergerak) */
.history-container::-webkit-scrollbar-thumb {
    background-color: #d5dae4; /* Ganti kode warna ini (misal: #9b59b6 untuk ungu) */
    border-radius: 3px;    /* Agar ujungnya bulat */
}

/* 3. Mengatur WARNA Latar Belakang (Jalur lintasan) */
.history-container::-webkit-scrollbar-track {
    background: transparent;
}

/* (Opsional) Warna saat disentuh/hover */
.history-container::-webkit-scrollbar-thumb:hover {
    background-color: #c0c4cd; /* Warna jadi lebih gelap saat disentuh */
}

/* Overlay Gelap */
.sawer-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
    z-index: 9999; display: none; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s;
}
.sawer-overlay.active { opacity: 1; }

/* Kartu Modal */
.sawer-card {
    background: #f6f9ff; width: 90%; max-width: 400px;
    border-radius: 20px; padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Rubik', sans-serif;
    border: 2px solid #7385a5;
}
.sawer-overlay.active .sawer-card { transform: translateY(0); }

/* Komponen Header */
.sawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
.sawer-header h3 { margin: 0; color: #7385a5; font-size: 14px; }
.sawer-close {
    position: absolute; /* Kunci: Lepas dari aliran teks, nempel ke pojok */
    top: 15px;          /* Jarak dari sisi Atas */
    right: 15px;        /* Jarak dari sisi Kanan */
    
    background: none;
    border: none;
    font-size: 20px;
    color: #7385a5;
    cursor: pointer;
    z-index: 10;        /* Pastikan selalu di lapisan atas */
    
    /* Opsional: Efek Hover biar enak */
    transition: transform 0.2s;
}

.sawer-close:hover {
    transform: rotate(90deg); /* Efek putar sedikit saat disentuh */
    color: #5c6a84;
}
        
/* Indikator Jaringan */
.network-indicator {
    display: flex; align-items: center; gap: 8px; font-size: 11px;
    color: #27ae60; background: rgba(39, 174, 96, 0.1);
    padding: 6px 12px; border-radius: 20px; width: fit-content; margin-bottom: 20px; font-weight: 600;
}
.pulse-green {
    width: 8px; height: 8px; background: #27ae60; border-radius: 50%;
    box-shadow: 0 0 0 rgba(39, 174, 96, 0.4); animation: pulse 1.5s infinite;
}

/* Info Box */
.sawer-info-box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #7385a5; }
.info-row { display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 4px; }
.info-row.sub { font-size: 11px; color: #999; }
.info-row.highlight { color: #7385a5; font-weight: bold; font-size: 14px; }
.info-row .mono { font-family: monospace; }
.divider { height: 1px; background: #e0e0e0; margin: 8px 0; }

/* Input & Buttons */
.input-group label { display: block; font-size: 12px; color: #7385a5; margin-bottom: 5px; font-weight: 600; }
.input-wrapper { position: relative; display: flex; align-items: center; }
.input-wrapper input {
    width: 100%; padding: 12px; padding-right: 50px;
    border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; font-weight: bold; color: #2c3e50;
    transition: border-color 0.2s;
}
.input-wrapper input:focus { border-color: #7385a5; outline: none; }
.suffix { position: absolute; right: 15px; color: #95a5a6; font-weight: 600; font-size: 12px; }
.limit-info { font-size: 10px; color: #7385a5; margin-top: 4px; display: block; }
textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; resize: none; }

.percent-grid { 
    display: grid; 
    grid-template-columns: repeat(5, 1fr); /* UBAH 4 JADI 5 AGAR SEJAJAR */
    gap: 4px; /* Perkecil jarak antar tombol */
    margin-top: 10px; 
}

.percent-grid button {
    background: #fff; 
    border: 1px solid #7385a5; 
    border-radius: 6px; /* Radius sedikit diperkecil */
    padding: 6px 2px; /* Padding kiri-kanan dipersempit */
    font-size: 10px; /* Font dikecilkan sedikit agar muat */
    font-weight: bold; 
    color: #555; 
    cursor: pointer; 
    transition: 0.2s;
    white-space: nowrap; /* Agar teks tidak turun baris */
}

.percent-grid button:hover { 
    background: #e3e7ed; 
    border-color: #7385a5; 
}
        
.btn-sawer-send {
    width: 100%; background: linear-gradient(135deg, #abb6c9 0%, #7385a5 100%);
    color: white; border: none; padding: 14px; border-radius: 12px;
    font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;
    box-shadow:
  0 4px 15px rgba(115, 133, 165, 0.25),
  0 0 0 1px rgba(115, 133, 165, 0.15);
    display: flex; align-items: center; justify-content: center; gap: 8px;
}
        
.btn-sawer-send:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(115, 133, 165, 0.4);
}

.btn-sawer-send:disabled {
  background: #687895;
  border: 2px solid #9daac0;
  cursor: not-allowed;
}
        
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Hapus paksa segala jenis garis di Judul Modal */
.sawer-header h3 {
    text-decoration: none !important; /* Hapus Underline */
    border-bottom: none !important;   /* Hapus Border */
    padding-bottom: 0 !important;     /* Hapus Jarak sisa */
    display: inline-block;            /* Pastikan blok rapi */
}

/* Pastikan wadahnya juga bersih */
.sawer-header {
    border-bottom: none !important;
                  }
    </style>
</head>
<body>

<nav class="top-navbar">
    <div class="brand">
        <a href="index" style="display: flex; align-items: center; text-decoration: none;">
            <img src="img/icon-192.png" class="brand-img" style="margin-right:8px;">
            <span class="brand" style="font-size:20px; color: #7385a5; font-weight:bold;">Beranda</span>
        </a>
    </div>
    <button class="btn-connect" id="btnConnect" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> Hubungkan
    </button>
</nav>

<div class="layout-wrapper">
<aside class="sidebar-left">
    <div class="menu-card">
        <div class="sidebar-label">Navigasi Utama</div>
        <a href="index" class="sidebar-item active">
            <i class="fas fa-globe-asia"></i> <span>Beranda</span>
        </a>
        <a href="galeri" class="sidebar-item">
            <i class="fa fa-university"></i> <span>Galeri</span>
        </a>
        <a href="profile" class="sidebar-item">
            <i class="fas fa-user"></i> <span>Profile</span>
        </a>
        <div class="sidebar-item" onclick="window.scrollTo(0,0); toggleForm();" style="cursor:pointer;">
            <i class="fa fa-cloud-upload"></i> <span>Upload Koleksi</span>
        </div>
    </div>

    <div class="menu-card" style="margin-top: 10px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <div class="sidebar-label" style="margin: 0;">Estimasi Aset:</div>
        <div id="usdEstimate" style="font-size: 11px; color: #7385a5; font-weight: 700; letter-spacing: 0.5px;">
            $0.0000
        </div>
    </div>

    <div class="wallet-mini-info">
        <div class="status-pill">
            <span class="pulse-dot"></span> <span id="networkName">Base Mainnet</span>
        </div>
        
        <div class="balance-display">
            <span id="userBalance">0.00000000</span> <small>ETH</small>
        </div>
        
        <div class="address-short" id="userAddrMini" onclick="copySidebarAddress()" style="cursor: pointer;">
            0x...
        </div>
        
        <div class="token-section" style="margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px;">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span class="sidebar-label" style="margin:0;">Aset Token</span>
                <div style="display:flex; gap:10px;">
                    <button onclick="openGeneralSendPopup()" style="background:none; border:1px solid #7385a5; padding:2px 8px; border-radius:4px; color:#7385a5; cursor:pointer; font-size:11px;">
                        <i class="fas fa-paper-plane"></i> Kirim
                    </button>
                    <button onclick="toggleImportForm()" style="background:none; border:1px solid #7385a5; padding:2px 8px; border-radius:4px; color:#7385a5; cursor:pointer; font-size:11px;">
                        <i class="fas fa-plus-circle"></i> Import
                    </button>
                </div>
            </div>

            <div id="importTokenBox" style="display:none; background:#1e2329; padding:10px; border-radius:8px; margin-bottom:10px;">
                <input type="text" id="inputTokenAddr" placeholder="Paste Smart Contract (0x...)" 
                       style="width:100%; padding:8px; border-radius:5px; border:1px solid #444; background:#0b0e11; color:#fff; font-size:11px; margin-bottom:5px;">
                <button onclick="addNewToken()" id="btnAddToken" 
                        style="width:100%; padding:6px; background:#2ecc71; border:none; border-radius:5px; color:#fff; font-weight:bold; font-size:11px; cursor:pointer;">
                    <i class="fas fa-download"></i> Tambahkan Token
                </button>
            </div>
            
            <div class="token-scroll-area">
            <div class="token-item" 
                 onclick="openSendPopup('ETH', 'ETH', 18, 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png')" 
                 style="cursor:pointer; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; margin-bottom: 5px;">
                <div class="token-left">
                    <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png" class="token-logo-img">
                    <div class="token-meta">
                        <span class="token-name">Ethereum</span>
                        <span class="token-symbol">ETH</span>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <div class="token-balance" id="staticEthBalance">0.0000</div>
                    <div class="token-value-sub" id="staticEthDetails">Loading...</div>
                </div>
            </div>

            <div class="token-item" 
                 onclick="openSendPopup('0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', 'USDC', 6, 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913/logo.png')" 
                 style="cursor:pointer; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; margin-bottom: 5px;">
                <div class="token-left">
                    <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913/logo.png" class="token-logo-img">
                    <div class="token-meta">
                        <span class="token-name">USD Coin</span>
                        <span class="token-symbol">USDC</span>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <div class="token-balance" id="staticUsdcBalance">0.00</div>
                    <div class="token-value-sub" id="staticUsdcDetails">$1.00</div>
                </div>
            </div>

            <div class="token-item" 
                 onclick="openSendPopup('0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2', 'USDT', 6, 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2/logo.png')" 
                 style="cursor:pointer; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; margin-bottom: 8px;">
                <div class="token-left">
                    <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2/logo.png" class="token-logo-img">
                    <div class="token-meta">
                        <span class="token-name">Tether USD</span>
                        <span class="token-symbol">USDT</span>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <div class="token-balance" id="staticUsdtBalance">0.00</div>
                    <div class="token-value-sub" id="staticUsdtDetails">$1.00</div>
                </div>
            </div>

            <div id="tokenListDisplay"></div>
            </div>
        </div>
    </div>
    </div>

    <div class="menu-card" style="margin-top: 10px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <div class="sidebar-label" style="margin: 0;">Riwayat Aktivitas:</div>
        <div style="font-size: 10px; color: #aaa; cursor: pointer;" onclick="loadUserHistory(modalUserAddr)">
           <i class="fa fa-refresh" aria-hidden="true"></i>
        </div>
    </div>

    <div id="txHistoryList" class="history-container">
        <div style="text-align:center; font-size:11px; color:#aaa; padding:10px;">
            <i class="fas fa-circle-notch fa-spin"></i> Memuat Riwayat...
        </div>
    </div>
    
    <a href="#" target="_blank" id="linkBasescan" 
   style="display:block; text-align:center; font-size:10px; font-weight: bold; color:#7385a5; margin-top:10px; text-decoration:none;">
   Lihat Selengkapnya di Explorer <i class="fas fa-external-link-alt"></i>
    </a>
    </div>

    <div class="menu-card" style="margin-top: 10px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <div class="sidebar-label" style="margin: 0;">Riwayat Global:</div>
        <div style="font-size: 10px; color: #aaa; cursor: pointer;" onclick="loadGlobalFeed()">
            <i id="btnRefreshFeed" class="fas fa-sync-alt"></i>
        </div>
    </div>

    <div id="globalFeedList" class="history-container" style="max-height: 250px;">
        <div style="text-align:center; font-size:11px; color:#aaa; padding:10px;">
            <i class="fas fa-satellite-dish fa-spin"></i> Sedang Menghubungkan....
        </div>
    </div>
    </div>
</aside>
    
<main class="main-feed">
    <div class="search-google-style">
        <i class="fas fa-search search-icon-g"></i>
        <input type="text" id="searchInput" placeholder="Telusuri Wayang..." onkeyup="smartSearch(this.value)">
        <i class="fas fa-times search-clear-g" id="clearBtn" onclick="clearSearch()"></i>
    </div>

    <div class="upload-trigger" onclick="toggleForm()">
        <img src="img/ps-logo.png" class="my-avatar">
        <div class="fake-input">Apa wayang terbaru Anda? Upload sekarang...</div>
        <i class="fas fa-images" style="color: #45bd62; font-size: 20px;"></i>
    </div>

    <div class="upload-form-box" id="uploadBox">
        <div class="form-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0; color:#2c3e50;">Detail Wayang Lengkap</h3>
                <button onclick="toggleForm()" style="background:none; border:none; cursor:pointer; color:#e74c3c;">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <fieldset>
                <legend><i class="fas fa-id-card"></i> Identitas Utama</legend>
                <div class="preview-box" onclick="document.getElementById('fileUpload').click()">
                    <img id="imgPreview">
                    <div id="textPreview" style="text-align:center; color:#aaa;">
                        <i class="fas fa-cloud-upload-alt" style="font-size:24px;"></i><br>Klik pilih foto
                    </div>
                </div>
                <input type="file" id="fileUpload" hidden onchange="previewImage()">
                    
                <label>Nama Tokoh:</label>
                <input type="text" id="inputNama" class="form-input" placeholder="Contoh: Arjuna">
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Golongan:</label>
                        <select id="inputGolongan">
                            <option value="Satria">Satria</option>
                            <option value="Dewa">Dewa</option>
                            <option value="Yaksa">Yaksa</option>
                            <option value="Wanara">Wanara</option>
                            <option value="Panakawan">Panakawan</option>
                            <option value="Kayon">Kayon</option>
                            <option value="Bambangan">Bambangan</option>
                            <option value="Punggawa">Punggawa</option>
                            <option value="Krodan">Krodan</option>
                            <option value="Resi">Resi</option>
                            <option value="Putren">Putren</option>
                            <option value="Buta Kiwe">Buta Kiwe</option>
                            <option value="Sato">Sato</option>
                            <option value="Gaman">Gaman</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>Gaya:</label>
                        <select id="inputGaya">
                            <option value="Bali">Bali</option>
                    <option value="Banjar">Banjar</option>
                    <option value="Banyumas">Banyumas</option>
                    <option value="Cirebon">Cirebon</option>
                    <option value="Jawa Barat">Golek Sunda</option>
                    <option value="Jawa Timur">Jawa Timur</option>
                    <option value="Kedu">Kedu</option>
                    <option value="Kontemporer">Kontemporer</option>
                    <option value="Kreasi">Kreasi</option>
                    <option value="Lombok">Lombok</option>
                    <option value="Surakarta">Surakarta</option>
                    <option value="Yogyakarta">Yogyakarta</option>
                    <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend><i class="fas fa-ruler-combined"></i> Detail Fisik</legend>
                <label>Wanda (Ekspresi):</label>
                <input type="text" id="inputWanda" class="form-input" placeholder="-">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Material Kulit:</label><input type="text" id="inputKulit" class="form-input" placeholder="Kerbau"></div>
                    <div style="flex:1"><label>Material Gapit:</label><input type="text" id="inputGapit" class="form-input" placeholder="Tanduk"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Penatah:</label><input type="text" id="inputPenatah" class="form-input" placeholder="-"></div>
                    <div style="flex:1"><label>Penyungging:</label><input type="text" id="inputPenyungging" class="form-input" placeholder="-"></div>
                </div>
            </fieldset>

            <fieldset>
                <legend><i class="fas fa-users"></i> Silsilah & Asal</legend>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label>Ayah:</label><input type="text" id="inputAyah" class="form-input"></div>
                    <div style="flex: 1;"><label>Ibu:</label><input type="text" id="inputIbu" class="form-input"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>Negara:</label><input type="text" id="inputNegara" class="form-input"></div>
                    <div style="flex:1;"><label>Pusaka:</label><input type="text" id="inputPusaka" class="form-input"></div>
                </div>
            </fieldset>

            <fieldset>
                <legend><i class="fas fa-book-open"></i>  Cerita</legend>
                <label>Deskripsi:</label>
                <textarea id="inputDeskripsi" class="form-input" rows="3" placeholder="Ceritakan sejarah atau filosofinya..."></textarea>
            </fieldset>

            <button class="btn-post" id="btnSubmit" onclick="uploadWayang()">
                <i class="fas fa-paper-plane"></i> Posting
            </button>
        </div>
    </div>
    
    <div id="feedContent">
        <div style="text-align:center; padding:40px; color:#aaa;">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat...
        </div>
    </div>
</main>

<div id="walletModal" class="modal-overlay" onclick="closeWalletModal(event)">
    <div class="modal-card">
        <div class="modal-header">
            <h3><i class="fas fa-wallet" style="color:#7385a5;"></i> Wallet Info</h3>
            <button class="close-btn" onclick="toggleWalletModal()"><i class="fas fa-times"></i></button>
        </div>

        <div class="modal-status">
            <span class="status-label">Status:</span>
            <div class="status-badge">
                <span class="pulse-dot"></span> Terhubung Base Network
            </div>
        </div>

        <div class="modal-balance">
            <div class="balance-label">Saldo Dompet Utama</div>
            <div class="balance-amount" id="modalBalance">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>

            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #d1d9e6;">
                <div class="balance-label" style="color:#888;">
                    <i class="fas fa-gift"></i> Total Pendapatan Dukungan
                </div>
                <div class="balance-amount" id="modalTipBalance" style="font-size: 18px; color: #7385a5;">
                    0.0000 ETH
                </div>
            </div>
        </div>

        <div class="modal-address-box" onclick="copyAddress()">
            <div class="address-text">
                <span id="modalFullAddress" style="display:none;"></span> 
                <span id="modalShortAddress">0x...</span>
            </div>
            <i class="far fa-copy copy-icon"></i>
        </div>

        <div class="modal-history-section">
            <h4 style="font-size:12px; color:#7385a5; margin:0 0 8px 0; display:flex; justify-content:space-between;">
                <span><i class="fas fa-history"></i> Riwayat Masuk</span>
                <span id="modalTipCountBadge" style="background:#eee; padding:2px 6px; border-radius:10px; font-size:10px;">0</span>
            </h4>
            
            <div id="modalHistoryList" class="history-scroll-area">
                <p style="text-align:center; font-size:11px; color:#aaa; margin-top:10px;">Belum ada riwayat.</p>
            </div>

            <button id="btnModalLoadMore" onclick="loadNextModalTips()" style="display:none; width:100%; margin-top:5px; background:none; border:1px dashed #7385a5; color:#7385a5; font-size:10px; padding:5px; cursor:pointer; border-radius:5px;">
                Muat 3 Lagi <i class="fas fa-chevron-down"></i>
            </button>
        </div>

        <button class="action-btn danger" onclick="disconnectWallet()" style="width: 100%;">
                <i class="fas fa-sign-out-alt"></i> Putuskan Koneksi
        </button>

        <div class="modal-actions" style="margin-top: 15px; text-align: center;">
            <div class="social-icons" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 15px;">
                <a href="https://youtube.com/@PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-youtube"></i></a>
                <a href="https://instagram.com/putramas_official" target="_blank" class="social-link"><i class="fab fa-instagram"></i></a>
                <a href="https://facebook.com/PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-facebook-f"></i></a>
                <a href="https://opensea.io/collection/putramas-nusantara-shadows-archive" target="_blank" class="social-link"><i class="fa fa-shopping-cart"></i></a>
            </div>
            
            <p class="copyright" style="font-size: 10px; color: #94a3b8; margin-top: 15px;">
                &copy; <span id="year"></span> Powered By <strong>Putramas Official</strong>
            </p>
        </div>
    </div>
</div>

<div id="sendModalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#15191e; width:90%; max-width:400px; padding:20px; border-radius:12px; border:1px solid #333; position:relative;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#fff; font-size:16px;">Kirim Aset</h3>
            <i class="fas fa-times" onclick="closeSendModal()" style="color:#aaa; cursor:pointer;"></i>
        </div>

        <div style="margin-bottom:15px;">
    <label style="color:#94a3b8; font-size:11px; display:block; margin-bottom:5px;">Pilih Aset</label>
    
    <div class="custom-select-wrapper" onclick="toggleTokenList()">
        <div class="custom-select-trigger" id="selectedTokenDisplay">
            <div style="display:flex; align-items:center; gap:8px;">
                <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png" class="token-mini-logo" id="displayLogo">
                <span id="displaySymbol">Ethereum (ETH)</span>
            </div>
            <i class="fas fa-chevron-down" style="font-size:12px; color:#aaa;"></i>
        </div>

        <div class="custom-options" id="tokenOptionsList">
            </div>
    </div>
    <input type="hidden" id="hiddenTokenValue" value="ETH">
        </div>

        <div style="margin-bottom:15px;">
            <label style="color:#94a3b8; font-size:11px; display:block; margin-bottom:5px;">Alamat Wallet Penerima</label>
            <input type="text" id="inputSendAddr" placeholder="Paste alamat tujuan (0x...)" oninput="validateSendAddr()"
                   style="width:100%; padding:10px; background:#0b0e11; border:1px solid #333; color:#fff; border-radius:6px; font-family:monospace;">
            <div id="addrErrorMsg" style="color:#ef4444; font-size:10px; margin-top:3px; display:none;">Alamat tidak valid!</div>
        </div>

        <div style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <label style="color:#94a3b8; font-size:11px;">Jumlah Kirim</label>
                <label style="color:#2ecc71; font-size:11px; cursor:pointer;" onclick="setSendPercent(100)">
                    Saldo: <span id="sendMaxBal">Loading...</span>
                </label>
            </div>
            <div style="position:relative;">
                <input type="number" id="inputSendAmount" placeholder="0.0"
                       style="width:100%; padding:10px; padding-right:60px; background:#0b0e11; border:1px solid #333; color:#fff; border-radius:6px; font-weight:bold;">
                <span id="inputTicker" style="position:absolute; right:10px; top:10px; color:#666; font-weight:bold; font-size:12px;">ETH</span>
            </div>
        </div>

        <div class="percent-grid" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:5px; margin-bottom:20px;">
            <button class="p-btn" onclick="setSendPercent(0)">0%</button>
            <button class="p-btn" onclick="setSendPercent(10)">10%</button>
            <button class="p-btn" onclick="setSendPercent(20)">20%</button>
            <button class="p-btn" onclick="setSendPercent(30)">30%</button>
            <button class="p-btn" onclick="setSendPercent(40)">40%</button>
            <button class="p-btn" onclick="setSendPercent(50)">50%</button>
            <button class="p-btn" onclick="setSendPercent(60)">60%</button>
            <button class="p-btn" onclick="setSendPercent(70)">70%</button>
            <button class="p-btn" onclick="setSendPercent(80)">80%</button>
            <button class="p-btn" onclick="setSendPercent(90)">90%</button>
            <button class="p-btn" onclick="setSendPercent(100)" style="grid-column: span 2; background:rgba(46, 204, 113, 0.2); color:#2ecc71;">MAX</button>
        </div>

        <button id="btnProceedSend" onclick="askConfirmation()" disabled
                style="width:100%; padding:12px; background:#333; color:#777; border:none; border-radius:8px; font-weight:bold; cursor:not-allowed; transition:0.3s;">
            Kirim Aset
        </button>
    </div>
</div>

<div id="confirmModalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center;">
    <div style="background:#1e2329; width:85%; max-width:320px; padding:20px; border-radius:12px; border:1px solid #444; text-align:center;">
        <div style="font-size:40px; margin-bottom:10px;"></div>
        <h3 style="color:#fff; margin:0 0 10px 0;">Konfirmasi Transfer</h3>
        <p style="color:#ccc; font-size:13px; line-height:1.5;">
            Apakah anda akan mengirim <br>
            <strong style="color:#2ecc71; font-size:15px;"><span id="confAmount">0</span> <span id="confSymbol">TOKEN</span></strong><br>
            ke alamat:<br>
            <span id="confAddr" style="font-family:monospace; color:#3498db; font-size:11px; background:#111; padding:2px 5px; border-radius:4px;">0x...</span>
        </p>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="document.getElementById('confirmModalOverlay').style.display='none'" 
                    style="flex:1; padding:10px; background:#333; color:#fff; border:none; border-radius:6px; cursor:pointer;">Batal</button>
            <button onclick="executeTransfer()" 
                    style="flex:1; padding:10px; background:#2ecc71; color:#000; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">YA, Kirim</button>
        </div>
    </div>
</div>

<div id="sawerModal" class="sawer-overlay" onclick="closeSawer(event)">
    <div class="sawer-card">
        <button class="sawer-close" onclick="toggleSawerModal(false)"><i class="fas fa-times"></i></button>
        <div class="network-indicator">
            <span class="pulse-green"></span>
            Terhubung Ke Jaringan Base
        </div>
        
    <center><div class="sawer-header">
            <h3>Dukung & Apresiasi Kreator Dengan ETH</h3>
        </div></center><br>

        <div class="sawer-info-box">
            <div class="info-row">
                <span class="label">Penerima:</span>
                <span class="value" id="sawerReceiverName" style="font-weight:bold;">Loading...</span>
            </div>
            <div class="info-row sub">
                <span class="label">Address:</span>
                <span class="value mono" id="sawerReceiverAddr">0x...</span>
            </div>
            <div class="divider"></div>
            <div class="info-row highlight">
                <span class="label">Saldo Anda:</span>
                <span class="value" id="sawerUserBalance">0.0000 ETH</span>
            </div>
        </div>

        <div class="input-group">
            <label>Nominal (ETH):</label>
            <div class="input-wrapper">
                <input type="number" id="sawerAmount" placeholder="0.001" step="0.0001" min="0.0001" max="0.005">
                <span class="suffix">ETH</span>
            </div>
            <small class="limit-info">Min: 0.0001 ETH  Max: 0.005 ETH</small>
        </div>

        <div class="percent-grid">
    <button onclick="setSawerPercent('MIN')">Min</button> 
    <button onclick="setSawerPercent(25)">25%</button>
    <button onclick="setSawerPercent(50)">50%</button>
    <button onclick="setSawerPercent(75)">75%</button>
    <button onclick="setSawerPercent(100)">MAX</button>
        </div>

        <div class="input-group" style="margin-top: 15px;">
    <label>Dukungan (Opsional)</label>

    <textarea id="sawerMessage" rows="2"></textarea>
        </div>

        <button id="btnKirimSawer" class="btn-sawer-send" onclick="eksekusiSawer()">
            <i class="fas fa-paper-plane"></i> Kirim Apresiasi
        </button>

    </div>
</div>

<nav class="bottom-nav">
    <a href="index" class="nav-link active"><i class="fas fa-globe-asia"></i><span>Beranda</span></a>
    <a href="galeri" class="nav-link"><i class="fa fa-university"></i><span>Galeri</span></a>
    <a href="profile" class="nav-link"><i class="fas fa-user"></i><span>Profile</span></a>
    <button class="nav-link" onclick="window.scrollTo(0,0); toggleForm();">
        <i class="fa fa-cloud-upload"></i><span>Upload</span>
    </button>
</nav>

    <script type="module">
  // 1. Import Pustaka Firebase dari Google
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // 2. Konfigurasi Bapak (Sudah Benar)
  const firebaseConfig = {
    apiKey: "AIzaSyCn1j8acLWDEVjoO2VB3qeN8rh8qUVBRR8",
    authDomain: "putramas-cc719.firebaseapp.com",
    databaseURL: "https://putramas-cc719-default-rtdb.firebaseio.com",
    projectId: "putramas-cc719",
    storageBucket: "putramas-cc719.firebasestorage.app",
    messagingSenderId: "1841157194",
    appId: "1:1841157194:web:012d80abf7293bd43d02b3",
    measurementId: "G-38XGWE5H38"
  };

  // 3. Nyalakan Database
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ====================================================
  // FUNGSI SIMPAN & AMBIL DATA (SAYA SAMBUNGKAN KE WINDOW)
  // ====================================================

  // FUNGSI 1: Simpan ke Cloud (Dipanggil saat Tambah/Hapus Token)
  window.saveTokensToCloud = function(userAddress, tokens) {
      if(!userAddress) return;
      const cleanAddr = userAddress.toLowerCase();
      
      // Simpan di folder: users -> [Alamat Wallet] -> myTokens
      set(ref(db, 'users/' + cleanAddr + '/myTokens'), tokens)
      .then(() => {
          console.log(" Token berhasil disimpan ke Server Google!");
      })
      .catch((error) => {
          console.error(" Gagal simpan:", error);
      });
  };

  // FUNGSI 2: Ambil dari Cloud (VERSI PERBAIKAN)
  window.loadTokensFromCloud = async function(userAddress) {
      if(!userAddress) return;
      const cleanAddr = userAddress.toLowerCase();

      console.log(" Mengecek data token di server untuk:", cleanAddr);
      const dbRef = ref(db);
      
      try {
          const snapshot = await get(child(dbRef, `users/${cleanAddr}/myTokens`));
          
          if (snapshot.exists()) {
              const cloudData = snapshot.val();
              console.log(" Data Cloud Ditemukan!");
              
              // [PERBAIKAN DISINI]
              // Panggil fungsi jembatan yang kita buat di script utama tadi
              if (typeof window.updateLocalTokens === 'function') {
                  window.updateLocalTokens(cloudData);
              } else {
                  console.error(" Fungsi updateLocalTokens tidak ditemukan di script utama!");
              }
              
          } else {
              console.log(" Belum ada data di Cloud untuk wallet ini.");
          }
      } catch (error) {
          console.error(" Error ambil data:", error);
      }
  };
  
  console.log(" Firebase Siap!");
    </script>
    
    <script>
const CHAIN_ID_DECIMAL = 8453; // ID Base Mainnet
const CHAIN_ID_BASE = "0x2105"; // Hex ID Base Mainnet
const BASE_RPC_URL = "https://base-rpc.publicnode.com"; // RPC Resmi
        
const BASE_MAINNET_CONFIG = {
    chainId: CHAIN_ID_BASE,
    chainName: 'Base',
    nativeCurrency: {
        name: 'Ethereum',
        symbol: 'ETH',
        decimals: 18
    },
    rpcUrls: ['https://base-rpc.publicnode.com'], // RPC Resmi
    blockExplorerUrls: ['https://basescan.org']
};
        
        const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58"; 
        const OFFICIAL_WALLET = "0xBAcc1F6e717bF03dB0c40E3044DA47318C369B70";
        // ABI Minimal untuk Read Data + Upload
        const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"RevisionFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"TipSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[],"name":"MAX_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramas.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTipByIndex","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"message","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.TipRecord","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTipCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getTipTotalBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiWayang","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"revisionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_receiver","type":"address"},{"internalType":"string","name":"_message","type":"string"}],"name":"sendTip","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setRevisionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTipsGrand","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];

        // --- ABI KHUSUS UNTUK IMPORT TOKEN (ERC-20) ---
const ERC20_ABI = [
    // Read-Only Functions
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function balanceOf(address owner) view returns (uint256)",
    "function transfer(address to, uint amount) returns (bool)",
    "function approve(address spender, uint amount) returns (bool)"
];
        
        const PINATA_API_KEY = "d209d53257fcc57219af";    
const PINATA_SECRET_KEY = "c65d0f4b9de3d144cbb09da6394b2f8dd690e09a9a7b1533d465b541350e7c0d";

        const PINATA_GATEWAY = "https://magenta-secondary-guan-686.mypinata.cloud/ipfs/";
        let provider, contractReader, signer;
        let feedData = [];
        let globalSearchIndex = [];
        const INDEX_STORAGE_KEY = "WAYANG_INDEX_FULL_V1";
        let currentSearchTicket = 0;
        let isWalletConnected = false;
        let modalTipCursor = 0;
        let modalUserAddr = null;
        let isModalFetching = false;  // (Tetap)
        let myTokens = [];            // (Tetap)
        let activeToken = null;       // (Tetap)
        let cachedEthPrice = 0;       // (Tetap)
        let cachedEthChange = 0;      // [BARU] Wajib ada untuk simpan % ETH
        let cachedTokenChanges = {};
        let cachedTokenPrices = {};   // (Tetap)
        let lastPriceFetchTime = 0;
        let sawerTargetAddress = null; // (Tetap)
        let activeSawerId = null;      // <--- INI YANG HILANG (PENTING!)
        // --- VARIABEL GLOBAL HISTORY ---
let userHistoryLogs = [];     // Wadah semua data mentah yang ditemukan
let historyCursor = 0;        // Penanda posisi scroll saat ini
let isHistoryLoading = false; // Pengaman agar tidak loading ganda
        // --- GLOBAL FEED VARIABLES ---
let globalFeedIds = [];       // Menyimpan SEMUA ID wayang yang ada
let feedCursor = 0;           // Penanda kita sudah sampai mana
let isFeedLoading = false;    // Pengaman biar gak loading dobel
        
        const PRICE_CACHE_DURATION = 15000;
        const MIN_TIP = 0.0001;
        const MAX_TIP = 0.005;

        // DATABASE TOKEN POPULER BASE (Updated + USDT)
const POPULAR_BASE_TOKENS = [
    { symbol: "WETH", address: "0x4200000000000000000000000000000000000006", decimals: 18, name: "Wrapped Ether" },
    { symbol: "DEGEN", address: "0x4ed4E862860beD51a9570b96d80147f1D3a49325", decimals: 18, name: "Degen" },
    { symbol: "BRETT", address: "0x532f27101965dd16442E59d40670FaF5eBB142E4", decimals: 18, name: "Brett" },
    { symbol: "TOSHI", address: "0xAC1Ad4cb686070ea31198e131E7D52c05dd7455e", decimals: 18, name: "Toshi" },
    { symbol: "AERO", address: "0x940181a94A35A4569E4529A3CDf3B4cfbbD777f6", decimals: 18, name: "Aerodrome" },
    { symbol: "BSWAP", address: "0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9", decimals: 18, name: "BaseSwap" }
];
            // --- JEMBATAN KONEKSI FIREBASE (Letakkan di bawah let myTokens = []) ---

// 2. Fungsi Jembatan (WAJIB ADA)
// Fungsi ini akan dipanggil oleh Firebase saat data ditemukan
window.updateLocalTokens = function(cloudData) {
    if (cloudData && Array.isArray(cloudData)) {
        console.log(" Menerima data dari Cloud:", cloudData);
        myTokens = cloudData; // Update variabel lokal
        
        // Simpan juga ke LocalStorage biar sinkron
        localStorage.setItem("myTokens", JSON.stringify(myTokens));
        
        // Render ulang tampilan
        renderTokenList();
        
        // Update saldo (jika fungsi ada)
        if(typeof refreshAllTokenBalances === 'function') {
            refreshAllTokenBalances();
        }
    }
};

        // --- INIT ---
        window.onload = async () => {
    // -----------------------------------------------------------
    // 1. SETUP READ PROVIDER (Untuk User Belum Login)
    // -----------------------------------------------------------
    // Provider ini hanya untuk baca data umum (Feed/Kontrak) tanpa login
    if(typeof initTokenManager === 'function') initTokenManager();
            
    const rpc = new ethers.providers.JsonRpcProvider("https://base-rpc.publicnode.com");
    try {
        if(typeof CONTRACT_ADDRESS !== 'undefined' && typeof ABI !== 'undefined') {
            contractReader = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpc);
        }
    } catch(e) { console.log("Init contract error:", e); }
    
    // -----------------------------------------------------------
    // 2. LOGIKA AUTO-LOGIN METAMASK
    // -----------------------------------------------------------
    if(window.ethereum) {
        try {
            const web3 = new ethers.providers.Web3Provider(window.ethereum);
            // Cek apakah user pernah connect sebelumnya?
            const accounts = await web3.listAccounts();
            
            if(accounts.length > 0) {
                const userAddress = accounts[0];
                console.log(" Auto-Login Berhasil:", userAddress);
                
                // [CRITICAL] UPDATE VARIABEL GLOBAL
                // Agar script Firebase & Scan tahu ini wallet siapa
                modalUserAddr = userAddress; 
                isWalletConnected = true;

                // A. Update Tampilan Tombol Connect
                const btn = document.getElementById("btnConnect");
                if(btn) {
                    btn.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
                    btn.classList.add("connected");
                }
                
                // B. Update Data Modal (Teks Address)
                if(document.getElementById("modalFullAddress")) {
                    document.getElementById("modalFullAddress").innerText = userAddress;
                    document.getElementById("modalShortAddress").innerText = userAddress.substring(0, 10) + "..." + userAddress.slice(-8);
                }

                // C. Ambil Saldo Utama (ETH)
                const balance = await web3.getBalance(userAddress);
                if(document.getElementById("modalBalance")) {
                    document.getElementById("modalBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4) + " ETH";
                }

                // D. Update Fungsi-Fungsi DApp Lainnya
                if(typeof updateSidebarWallet === 'function') updateSidebarWallet(userAddress);
                if(typeof updateModalWalletData === 'function') updateModalWalletData(userAddress);
                
                // -------------------------------------------------------
                // [PENAMBAHAN PENTING] LOAD DATA DARI FIREBASE CLOUD
                // -------------------------------------------------------
                // Kita panggil ini AGAR TOKEN MUNCUL walau cache dihapus
                if (window.loadTokensFromCloud) {
                    await window.loadTokensFromCloud(userAddress);
                }
                loadGlobalFeed();
                loadUserHistory(userAddress);

                // E. Auto Scan Token (Jalan setelah Cloud selesai)
                // Memberi jeda sedikit agar UI tidak berat
                setTimeout(() => {
                    if(typeof autoScanTokens === 'function') autoScanTokens();
                }, 1000);
            }
        } catch(e) { console.error("Auto-login error:", e); }
    }

    // -----------------------------------------------------------
    // 3. INISIALISASI FITUR LAIN (Feed, Indexer, Manager)
    // -----------------------------------------------------------
    if(typeof loadFeed === 'function') loadFeed();
    if(typeof initDeepIndexer === 'function') setTimeout(initDeepIndexer, 3000);
    
    // -----------------------------------------------------------
    // 4. INTERVAL UPDATE HARGA REAL-TIME (Looping)
    // -----------------------------------------------------------
    setInterval(() => {
        // Hanya update jika user sedang melihat tab browser (Hemat API)
        if (!document.hidden) {
            refreshAllTokenBalances();
        }
    }, 15000);
};

async function connectWallet() {
    // A. Validasi Metamask
    if (!window.ethereum) return alert("Metamask tidak terdeteksi!");
    
    const btnConnect = document.getElementById("btnConnect");
    
    // B. LOGIKA TOGGLE
    if (isWalletConnected || (btnConnect && btnConnect.classList.contains("connected"))) {
        toggleWalletModal(); 
        return;
    }

    // C. PROSES KONEKSI BARU
    const originalText = btnConnect.innerHTML;
    btnConnect.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Loading...`;

    try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // 1. Request Akun
        await provider.send("eth_requestAccounts", []);

        // 2. Cek Network
        const network = await provider.getNetwork();
        if (network.chainId !== CHAIN_ID_DECIMAL) {
            await switchNetwork(); 
            connectWallet(); 
            return; 
        }

        // 3. Ambil Data User
        const signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        
        // [PERBAIKAN 1]: Update variabel Global dulu!
        // Agar script lain (seperti autoScan atau Firebase) tahu siapa yang login
        modalUserAddr = userAddress; 

        // 4. Update Tampilan Tombol
        btnConnect.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
        btnConnect.classList.add("connected");
        isWalletConnected = true; 

        // 5. Update Data Modal
        document.getElementById("modalFullAddress").innerText = userAddress;
        document.getElementById("modalShortAddress").innerText = userAddress.substring(0, 6) + "..." + userAddress.slice(-4);
        
        const balance = await provider.getBalance(userAddress);
        document.getElementById("modalBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(8) + " ETH";
        
        // 6. Tarik Data History & Cloud
        updateSidebarWallet(userAddress);
        await updateModalWalletData(userAddress);
        
        // [PERBAIKAN 2]: Panggil Firebase DULUAN sebelum scan
        // Logikanya: "Ambil catatan lama dulu, baru cari yang baru"
        if (window.loadTokensFromCloud) {
            // Kita pakai await biar list muncul dulu sebelum auto-scan jalan (opsional)
            await window.loadTokensFromCloud(modalUserAddr);
        }

        // Baru jalankan Auto Scan (untuk cari token yang belum kesimpan)
        autoScanTokens();

    } catch (err) { 
        console.error("Koneksi Error:", err);
        btnConnect.innerHTML = originalText;
    }
}

async function switchNetwork() {
    try {
        // Coba perintah ganti network
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CHAIN_ID_BASE }],
        });
    } catch (switchError) {
        // Kode 4902 artinya Network Belum Ada di Metamask User
        if (switchError.code === 4902) {
            try {
                // Perintah pasang RPC otomatis
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [BASE_MAINNET_CONFIG],
                });
            } catch (addError) {
                console.error("User menolak pasang RPC Base:", addError);
                throw addError;
            }
        } else {
            console.error("Gagal ganti network:", switchError);
            throw switchError;
        }
    }
}

    // Fungsi Buka/Tutup Modal
function toggleWalletModal() {
    const modal = document.getElementById("walletModal");
    if (modal.classList.contains("active")) {
        modal.classList.remove("active");
        setTimeout(() => modal.style.display = "none", 300);
    } else {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
        if (typeof userAddress !== 'undefined' && userAddress) {
            updateModalWalletData(userAddress);
        }
    }
}

// Fungsi Tutup jika klik area gelap
function closeWalletModal(e) {
    if (e.target.id === "walletModal") toggleWalletModal();
}

// Fungsi Copy Address
function copyAddress() {
    const fullAddress = document.getElementById("modalFullAddress").innerText;
    navigator.clipboard.writeText(fullAddress).then(() => {
        showToast("Alamat Wallet disalin!", 'success'); // Atau ubah icon ceklis
    });
}

// --- FUNGSI DISCONNECT YANG LEBIH BERSIH ---
function disconnectWallet() {
    // 1. Reset Variabel
    userAddress = null;
    signer = null;
    
    // 2. Reset Tombol Connect
    const btn = document.getElementById("btnConnect"); // Pastikan ID ini benar di HTML
    if (btn) {
        btn.innerHTML = `<i class="fas fa-wallet"></i> Konek Wallet`;
        btn.classList.remove("connected");
    }

    // 3. Tutup Modal
    toggleWalletModal(false);

    // 4. Hapus Cache Sesi (Opsional)
    localStorage.removeItem("walletConnected"); 

    // 5. Reload Halaman (Jeda sedikit biar smooth)
    setTimeout(() => {
        window.location.reload(); 
    }, 300);
}

// --- FUNGSI UPDATE DATA MODAL (FIXED VARIABLE NAME) ---
async function updateModalWalletData(addr) {
    if(!addr) return;
    modalUserAddr = addr;

    const listEl = document.getElementById("modalHistoryList");
    const balEl = document.getElementById("modalTipBalance");
    const badgeEl = document.getElementById("modalTipCountBadge");
    const btnMore = document.getElementById("btnModalLoadMore");

    if(listEl) listEl.innerHTML = `<div style="text-align:center; padding:15px; color:#7385a5;"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>`;
    if(balEl) balEl.innerText = "Loading...";
    if(btnMore) btnMore.style.display = 'none';

    try {
        // PERBAIKAN: Gunakan BASE_RPC_URL (Sesuai konstanta di atas)
        const rpcProvider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpcProvider);

        // A. AMBIL SALDO SAWERAN
        const totalWei = await contract.getTipTotalBalance(addr);
        const totalEth = parseFloat(ethers.utils.formatEther(totalWei)).toFixed(8);
        if(balEl) balEl.innerText = totalEth + " ETH";

        // B. AMBIL JUMLAH RIWAYAT
        const countBN = await contract.getTipCount(addr);
        const count = parseInt(countBN.toString());
        
        if(badgeEl) badgeEl.innerText = count;

        if (count === 0) {
            if(listEl) listEl.innerHTML = `<p style="text-align:center; font-size:12px; color:#aaa; margin-top:15px; font-style:italic;">Belum ada riwayat masuk.</p>`;
            return;
        }

        modalTipCursor = count - 1; 
        if(listEl) listEl.innerHTML = ""; 
        
        await loadNextModalTips(); 

    } catch (e) {
        console.error("Gagal update modal:", e);
        if(listEl) listEl.innerHTML = `<p style="color:#e74c3c; font-size:11px; text-align:center;">Gagal memuat data. Sinyal buruk.</p>`;
        if(balEl) balEl.innerText = "0.0000 ETH";
    }
}

// --- FUNGSI LOAD NEXT BATCH (FIXED VARIABLE NAME) ---
async function loadNextModalTips() {
    if(isModalFetching || modalTipCursor < 0) return;
    
    isModalFetching = true;
    const container = document.getElementById("modalHistoryList");
    const btnMore = document.getElementById("btnModalLoadMore");

    if(btnMore) {
        btnMore.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memuat...`;
        btnMore.disabled = true;
    }

    // PERBAIKAN: Gunakan BASE_RPC_URL
    const rpcProvider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpcProvider);

    let end = modalTipCursor - 3; 
    if(end < 0) end = 0;

    let htmlBuffer = "";

    for (let i = modalTipCursor; i >= end; i--) {
        try {
            const tip = await contract.getTipByIndex(modalUserAddr, i);
            const senderShort = tip.sender.substring(0,4) + ".." + tip.sender.substring(38);
            const amount = parseFloat(ethers.utils.formatEther(tip.amount)).toFixed(6);
            const msg = (tip.message && tip.message !== "") ? tip.message : "Tanpa pesan";
            
            let dateStr = "Baru saja";
            try {
                dateStr = new Date(tip.timestamp * 1000).toLocaleDateString("id-ID", { day: 'numeric', month: 'short' });
            } catch(ed){}

            htmlBuffer += `
            <div class="mini-history-item" style="animation: fadeIn 0.3s; padding:10px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <div style="font-size:12px; font-weight:bold; color:#555; display:flex; align-items:center; gap:5px;">
                        <i class="fas fa-user-circle" style="color:#7385a5;"></i> ${senderShort}
                        <span style="font-size:10px; color:#aaa; font-weight:normal;"> ${dateStr}</span>
                    </div>
                    <div style="font-size:11px; color:#888; font-style:italic; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px;">
                        "${msg}"
                    </div>
                </div>
                <div style="font-size:12px; font-weight:bold; color:#27ae60;">+${amount} ETH</div>
            </div>`;
        } catch (e) {}
    }

    container.insertAdjacentHTML('beforeend', htmlBuffer);

    modalTipCursor = end - 1;
    isModalFetching = false;

    if(btnMore) {
        btnMore.disabled = false;
        if(modalTipCursor >= 0) {
            btnMore.style.display = 'block';
            btnMore.innerHTML = `Muat 3 Lagi <i class="fas fa-chevron-down"></i>`;
        } else {
            btnMore.style.display = 'none';
        }
    }
}
        // --- PENCARIAN AGRESIF (DEEP SEARCH) ---
async function smartSearch(query) {
    const clearBtn = document.getElementById("clearBtn");
    const container = document.getElementById("feedContent");
    
    // Tiket pencarian baru
    currentSearchTicket++;
    const myTicket = currentSearchTicket;

    if (query.length === 0) {
        clearBtn.style.display = "none";
        container.innerHTML = "";
        loadFeed(); // Kembali ke feed awal
        return;
    }

    clearBtn.style.display = "block";
    query = query.toLowerCase().trim();

    // Tampilkan Loading
    container.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;"><i class="fas fa-circle-notch fa-spin"></i> Mencari...</div>`;

    // 1. FILTER UNIK dari Index
    // Kita filter dulu ID-nya agar tidak ada ID yang sama masuk ke proses render
    const matchedItems = globalSearchIndex.filter(item => 
        item.nama.includes(query) || 
        (item.id.toString() === query)
    );

    // Ambil ID Unik
    const uniqueMatchedIds = [...new Set(matchedItems.map(item => item.id))];

    // Jika tidak ada hasil
    if (uniqueMatchedIds.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#aaa;">Tidak ditemukan "${query}"</div>`;
        return;
    }

    // 2. RENDER HASIL
    container.innerHTML = ""; // Bersihkan loading
    
    // Ambil maksimal 10 hasil teratas untuk performa
    const targetIds = uniqueMatchedIds.slice(0, 10);

    for (let id of targetIds) {
        // Cek apakah tiket masih valid (user belum mengetik huruf baru)
        if (myTicket !== currentSearchTicket) return; 
        await renderCard(id, container);
    }
}

function clearSearch() {
    document.getElementById("searchInput").value = "";
    smartSearch(""); 
}

// --- LOGIKA FEED (GABUNGAN SEMUA DATA) ---
        async function loadFeed() {
    const container = document.getElementById("feedContent");
    const golongans = ['Satria', 'Dewa', 'Yaksa', 'Wanara', 'Panakawan', 'Kayon', 'Bambangan', 'Punggawa', 'Krodan', 'Resi', 'Putren', 'Buta Kiwe', 'Sato', 'Gaman'];

    // Reset State
    container.innerHTML = `<div style="text-align:center; padding:40px; color:#aaa;"><i class="fas fa-circle-notch fa-spin"></i> Menyiapkan Beranda...</div>`;
    globalFeedIds = [];
    feedCursor = 0;
    isFeedLoading = false;

    // --- SENSOR INFINITE SCROLL (GAYA FACEBOOK) ---
    // Deteksi saat user scroll halaman utama sampai bawah
    window.onscroll = function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            // Jika sisa jarak bawah tinggal 500px, muat lagi!
            loadNextFeedBatch();
        }
    };

    try {
        // 1. AMBIL SEMUA ID DARI SEMUA GOLONGAN (PARALEL)
        const results = await Promise.all(golongans.map(gol => contractReader.getIdsByGolongan(gol)));
        
        // 2. GABUNGKAN & HILANGKAN DUPLIKAT
        let allIds = results.flat().map(id => parseInt(id));
        
        // 3. URUTKAN DARI TERBARU (DESCENDING) & SIMPAN KE VARIABLE GLOBAL
        globalFeedIds = [...new Set(allIds)].sort((a, b) => b - a);

        container.innerHTML = ""; // Bersihkan loading awal

        if(globalFeedIds.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:40px; color:#aaa;'>Belum ada postingan wayang.</div>";
            return;
        }

        // 4. LOAD BATCH PERTAMA (Langsung Tampil)
        await loadNextFeedBatch();

    } catch(e) {
        console.error(e);
        container.innerHTML = "<p style='color:red; text-align:center;'>Gagal memuat feed.</p>";
    }
        }
        
        async function loadNextFeedBatch() {
    // Cek: Sedang loading? Atau data sudah habis?
    if (isFeedLoading || feedCursor >= globalFeedIds.length) return;

    isFeedLoading = true;
    const container = document.getElementById("feedContent");

    // Tampilkan Loader Kecil di Bawah
    const loaderId = "feedLoaderBottom";
    if (!document.getElementById(loaderId)) {
        container.insertAdjacentHTML('beforeend', 
            `<div id="${loaderId}" style="text-align:center; padding:20px; color:#aaa;">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat lainnya...
            </div>`
        );
    }

    // --- AMBIL 5 DATA BERIKUTNYA ---
    // Kenapa 5? Agar rendering cepat dan scroll terasa halus
    const BATCH_SIZE = 5;
    const nextIds = globalFeedIds.slice(feedCursor, feedCursor + BATCH_SIZE);

    // Render satu per satu (Sequential) agar urutan terjaga rapi
    for (let id of nextIds) {
        // Pastikan renderCard append ke container, bukan replace innerHTML
        await renderCard(id, container); 
    }

    // Update Cursor
    feedCursor += nextIds.length;
    isFeedLoading = false;

    // Hapus Loader Bawah
    const loaderEl = document.getElementById(loaderId);
    if (loaderEl) loaderEl.remove();

    // Cek jika sudah habis total
    if (feedCursor >= globalFeedIds.length) {
        container.insertAdjacentHTML('beforeend', 
            `<div style="text-align:center; padding:20px; color:#ddd; font-size:12px;">
                 Anda sudah mencapai dasar 
            </div>`
        );
    }
        }

async function renderCard(id, container) {
    // 1. Cek Duplikasi Visual
    if (document.getElementById(`card-${id}`)) return;

    try {
        // 2. Ambil Data Utama (Info, URI, Owner, Likes)
        // Kita pakai Promise.all biar cepat
        const [info, uri, owner, likes] = await Promise.all([
            contractReader.getInfoWayang(id),
            contractReader.tokenURI(id),
            contractReader.ownerOf(id),
            contractReader.totalLikes(id)
        ]);

        if(!info.isActive) return;

        // --- PERBAIKAN UTAMA DISINI ---
        // 3. Ambil Data Saweran (Tip Count) milik Owner
        // Kita pisah di try-catch kecil agar kalau gagal, kartu tetap muncul (nilai 0)
        let sawerCount = 0;
        try {
            // JANGAN pakai getTipCount (karena itu total saldo owner)
            // PAKAI fungsi filter manual kita:
            sawerCount = await getTipCountByID(id, owner);
        } catch(errTip) {
            sawerCount = 0;
        }
        // ------------------------------

        // 4. Proses Gambar (Weserv)
        let imgUrl = "img/loading-placeholder.gif"; 
        try {
            const jsonUrl = uri.replace("ipfs://", PINATA_GATEWAY);
            const res = await axios.get(jsonUrl, { timeout: 5000 });
            const rawImg = res.data.image || res.data.image_url;
            imgUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawImg.replace("ipfs://", PINATA_GATEWAY))}&w=500&q=75&output=webp`;
        } catch(e) { }

        // 5. Identitas & Badge
        const isOfficial = (owner.toLowerCase() === OFFICIAL_WALLET.toLowerCase());
        const badge = isOfficial 
            ? `<i class="fas fa-check-circle verified-gold" title="Official"></i>` 
            : `<i class="fas fa-check-circle verified-badge" title="Verified Creator"></i>`;
        
        const senderName = isOfficial ? "Putramas Official" : owner.substring(0,6) + "...";
        const avatar = isOfficial ? "img/icon-192.png" : `https://api.dicebear.com/7.x/identicon/svg?seed=${owner}`;

        // 6. Simpan ke Memori (Penting untuk Search)
        const existingData = feedData.find(x => x.id === id);
        if (!existingData) {
            feedData.push({ id, nama: info.nama, golongan: info.golongan, gaya: info.gaya, owner });
        }

        // 7. RENDER HTML (FIXED)
        // - ID tombol dihapus (diganti class) biar tidak duplikat
        // - sawerCount sudah aman
        const html = `
        <div class="feed-card" id="card-${id}">
            <div class="card-header">
                <a href="profile?address=${owner}" class="user-info" style="text-decoration:none;">
                    <img src="${avatar}" class="user-pic">
                    <div>
                        <div class="user-name" style="color:#2c3e50;">${senderName} ${badge}</div>
                        <div class="post-time">${new Date(info.timestamp * 1000).toLocaleDateString()}  ID #${id}</div>
                    </div>
                </a>
                <i class="fas fa-edit" style="color:#7385a5; cursor:pointer;" 
                   onclick="event.stopPropagation(); window.location.href='revisi?id=${id}'"></i>
            </div>
            
            <div class="card-content">
                <h3 class="wayang-title">${info.nama}</h3>
                <div class="wayang-desc">
                    <span class="tag-badge">${info.golongan}</span> 
                    <span class="tag-badge" style="background:#fef3c7; color:#d97706;">${info.gaya}</span>
                </div>
            </div>

            <div class="card-image" onclick="window.location.href='detail?id=${id}'">
                <img src="${imgUrl}" loading="lazy">
            </div>

            <div class="card-actions">
                <button class="action-btn" onclick="event.stopPropagation(); kirimLike('${id}', this)">
                    <i class="fas fa-heart"></i> ${likes}
                </button>
                
                <button id="btnSawer-${id}" class="action-btn" onclick="event.stopPropagation(); panggilSawerDetail('${id}')" title="Kirim Apresiasi">
    <i class="fas fa-gift"></i> <span id="sawerCount-${id}">${sawerCount}</span>
</button>

                <button class="action-btn"><i class="fas fa-star"></i></button>
                
                <button class="action-btn" onclick="event.stopPropagation(); window.open('https://opensea.io/assets/base/${CONTRACT_ADDRESS}/${id}', '_blank')">
                    <i class="fas fa-shopping-cart"></i>
                </button>
                
                <button class="action-btn" onclick="event.stopPropagation(); shareWayang('${id}', '${info.nama}')">
                    <i class="fas fa-share-alt"></i>
                </button>
            </div>
        </div>`;

        container.insertAdjacentHTML('beforeend', html);

    } catch(e) { 
        console.log("Gagal render ID", id, e); 
    }
}

        // --- DEEP INDEXER (JALAN DI BACKGROUND - ANTI DUPLIKAT) ---
async function initDeepIndexer() {
    // 1. Load index lama dari storage agar crawling lebih cepat
    const cachedIndex = localStorage.getItem(INDEX_STORAGE_KEY);
    if (cachedIndex) {
        globalSearchIndex = JSON.parse(cachedIndex);
        console.log(" Index awal dimuat:", globalSearchIndex.length, "items");
    }

    const golongans = ['Satria', 'Dewa', 'Yaksa', 'Wanara', 'Panakawan', 'Kayon', 'Bambangan', 'Punggawa', 'Krodan', 'Resi', 'Putren', 'Buta Kiwe', 'Sato', 'Gaman'];
    let tempIndex = [...globalSearchIndex]; // Mulai dengan data yang sudah ada

    // 2. Crawling Data Baru secara Paralel
    for (const gol of golongans) {
        try {
            const ids = await contractReader.getIdsByGolongan(gol);
            
            const promises = ids.map(async (idBig) => {
                const id = parseInt(idBig);
                
                // Cek apakah ID sudah ada di index? Kalau sudah, tidak perlu fetch lagi
                if (tempIndex.some(x => x.id === id)) return;

                try {
                    const info = await contractReader.getInfoWayang(id);
                    if (info.isActive) {
                        tempIndex.push({
                            id: id,
                            nama: info.nama.toLowerCase(),
                            golongan: info.golongan,
                            gaya: info.gaya
                        });
                    }
                } catch (e) {}
            });
            
            await Promise.all(promises);
        } catch (e) {}
    }

    // 3. PEMBERSIHAN DUPLIKAT FINAL (Penting!)
    // Kita gunakan Map untuk memastikan satu ID hanya punya satu entri data
    const uniqueIndex = Array.from(new Map(tempIndex.map(item => [item.id, item])).values());
    
    // Sortir terbaru di atas (ID Besar ke Kecil)
    globalSearchIndex = uniqueIndex.sort((a, b) => b.id - a.id);

    // 4. Simpan ke HP hanya data yang sudah unik dan rapi
    if (globalSearchIndex.length > 0) {
        localStorage.setItem(INDEX_STORAGE_KEY, JSON.stringify(globalSearchIndex));
        console.log(" Deep Index Sinkron:", globalSearchIndex.length, "items unik");
    }
}

// --- FUNGSI UPLOAD UTAMA ---
async function uploadWayang() {
    const btn = document.getElementById("btnSubmit");
    
    // 1. PERBAIKAN ID DISINI (Sesuaikan dengan HTML)
    const nama = document.getElementById("inputNama").value;
    const gol = document.getElementById("inputGolongan").value; // Dulu inputGol
    const gaya = document.getElementById("inputGaya").value;
    const fileInput = document.getElementById("fileUpload");    // Dulu inputGambar
    const deskripsi = document.getElementById("inputDeskripsi").value || "Koleksi Wayang Nusantara";

    // 2. Validasi
    if (!window.ethereum) return alert("Wajib install Metamask!");
    if (!nama || fileInput.files.length === 0) {
        return alert("Nama Tokoh dan Foto WAJIB diisi!");
    }

    try {
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> 1/4 Mempores Gambar...`;

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        // --- STAGE 1: KOMPRESI ---
        const compressedFile = await compressImage(fileInput.files[0], 300);

        // --- STAGE 2: IPFS GAMBAR ---
        btn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> 2/4 Mengupload Foto...`;
        const imgUrl = await uploadToIPFS(compressedFile);

        // --- STAGE 3: METADATA LENGKAP ---
        btn.innerHTML = `<i class="fas fa-file-alt"></i> 3/4 Mempores Metadata...`;

        const metadata = {
            name: nama,
            description: deskripsi,
            image: imgUrl,
            attributes: [
                // Identitas
                { trait_type: "Golongan", value: gol },
                { trait_type: "Gaya", value: gaya },
                // Fisik (Menggunakan helper getVal)
                { trait_type: "Wanda", value: getVal("inputWanda") },
                { trait_type: "Material Kulit", value: getVal("inputKulit") },
                { trait_type: "Material Gapit", value: getVal("inputGapit") },
                { trait_type: "Penatah", value: getVal("inputPenatah") },
                { trait_type: "Penyungging", value: getVal("inputPenyungging") },
                { trait_type: "Tahun Pembuatan", value: getVal("inputTahun") },
                { trait_type: "Kolektor", value: getVal("inputKolektor") },
                // Silsilah
                { trait_type: "Ayah", value: getVal("inputAyah") },
                { trait_type: "Ibu", value: getVal("inputIbu") },
                { trait_type: "Negara", value: getVal("inputNegara") },
                { trait_type: "Pusaka", value: getVal("inputPusaka") },
                // System
                { trait_type: "Creator", value: userAddress },
                { trait_type: "Type", value: "Full Metadata Upload" }
            ]
        };

        const tokenURI = await uploadJSON(metadata);

        // --- STAGE 4: BLOCKCHAIN ---
        btn.innerHTML = `<i class="fas fa-signature"></i> 4/4 Konfirmasi Wallet...`;
        
        const fee = await contract.publicMintFee();
        const tx = await contract.uploadPublik(tokenURI, nama, gol, gaya, { value: fee });
        
        btn.innerHTML = `<i class="fas fa-cog fa-spin"></i> Mining...`;
        await tx.wait();

        // SUKSES
        alert("Berhasil! Metadata lengkap sudah tersimpan.");
        toggleForm(); 
        
        // Refresh Feed jika fungsi tersedia
        if(typeof loadFeedTurbo === 'function') {
            loadFeedTurbo();
        } else {
            location.reload();
        }

    } catch (err) {
        console.error(err);
        alert("Gagal: " + (err.reason || err.message));
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-paper-plane"></i> Posting Sekarang`;
    }
}

// --- HELPER LAINNYA (JANGAN DIHAPUS) ---

async function uploadToIPFS(file) {
    const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
    let data = new FormData();
    data.append('file', file);
    const res = await axios.post(url, data, {
        headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY, "Content-Type": "multipart/form-data"}
    });
    return `https://gateway.pinata.cloud/ipfs/${res.data.IpfsHash}`;
}

async function uploadJSON(jsonData) {
    const url = `https://api.pinata.cloud/pinning/pinJSONToIPFS`;
    const res = await axios.post(url, jsonData, {
        headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY}
    });
    return `ipfs://${res.data.IpfsHash}`;
}

async function compressImage(file, maxSizeKB = 300) {
    if (file.size <= maxSizeKB * 1024) return file;
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (ev) => {
            const img = new Image();
            img.src = ev.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                const MAX = 1200; 
                if (w > MAX || h > MAX) {
                    const ratio = w / h;
                    if (w > h) { w = MAX; h = MAX / ratio; }
                    else { h = MAX; w = MAX * ratio; }
                }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                let quality = 0.9;
                const recursiveCompress = () => {
                    canvas.toBlob((blob) => {
                        if (!blob) return reject("Gagal kompresi");
                        if (blob.size <= maxSizeKB * 1024 || quality <= 0.1) {
                            resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
                        } else {
                            quality -= 0.1;
                            recursiveCompress();
                        }
                    }, 'image/jpeg', quality);
                };
                recursiveCompress();
            };
        };
        reader.onerror = reject;
    });
}

// Helper UI Preview (Pastikan ID fileUpload sesuai HTML)
function previewImage() {
    const file = document.getElementById("fileUpload").files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById("imgPreview").src = e.target.result;
        document.getElementById("imgPreview").style.display = "block";
        document.getElementById("textPreview").style.display = "none";
    }
    if(file) reader.readAsDataURL(file);
}

function toggleForm() { 
    document.getElementById("uploadBox").classList.toggle("open"); 
}

function getVal(id) {
    const el = document.getElementById(id);
    return (el && el.value.trim() !== "") ? el.value.trim() : "-";
}

// --- FITUR SHARE MODERN (WEB SHARE API) ---
async function shareWayang(id, nama) {
    // 1. Susun Link Detail
    const shareUrl = `${window.location.origin}/detail?id=${id}`;
    
    // 2. Data yang akan dibagikan
    const shareData = {
        title: 'Putramas Official Feed',
        text: `Lihat Wayang "${nama}" (ID #${id}) ini di Galeri Digital Putramas!`,
        url: shareUrl
    };

    // 3. Cek apakah Browser support Native Share? (Biasanya HP Android/iPhone support)
    if (navigator.share) {
        try {
            await navigator.share(shareData);
            console.log('Berhasil dibagikan');
        } catch (err) {
            console.log('Batal berbagi / Error:', err);
        }
    } else {
        // 4. Fallback untuk Desktop / Browser Lama (Copy to Clipboard)
        try {
            await navigator.clipboard.writeText(shareUrl);
            // Tampilkan Toast/Alert sederhana
            alert(" Link berhasil disalin ke clipboard!"); 
        } catch (err) {
            prompt("Copy link ini manual:", shareUrl);
        }
    }
}

// --- FUNGSI LIKE YANG SUDAH DIPERBAIKI ---
async function kirimLike(idWayang, btnElement) {
    // 1. Validasi ID
    if (!idWayang) return showToast("ID tidak valid!", 'error');

    // 2. Simpan teks asli tombol (backup)
    const originalContent = btnElement.innerHTML;

    try {
        // 3. Pastikan User Konek Dulu (Wajib!)
        await ensureWallet(); 

        // 4. Setup Kontrak (Perhatikan: Pakai 'ABI' bukan 'CONTRACT_ABI')
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        
        // 5. Ubah tombol jadi Loading
        btnElement.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
        btnElement.style.pointerEvents = "none"; 
        
        // 6. Eksekusi Transaksi
        console.log("Mengirim Like ke ID:", idWayang);
        const tx = await contract.kasihLike(idWayang);
        
        // Menunggu konfirmasi blockchain
        await tx.wait(); 
        
        // 7. Sukses!
        showToast("Berhasil menyukai!", 'success');
        
        
        // Ganti tulisan Sukses dengan ikon ceklis hijau
btnElement.innerHTML = `<i class="fas fa-heart" style="color: #e74c3c;"></i> <i class="fas fa-check" style="color: #2ecc71; margin-left: 4px;"></i>`;
        
    } catch(err) {
        console.error("Error Like:", err);
        const pesanError = (err.reason || err.message || "").toLowerCase();

        // Cek Error Spesifik
        if (pesanError.includes("already liked") || pesanError.includes("sudah")) {
            showToast("Anda sudah menyukai postingan ini", 'warning');
            // Tetap ubah jadi merah karena faktanya memang sudah dilike
            btnElement.innerHTML = `<i class="fas fa-heart" style="color: #e74c3c;"></i> Liked`;
        } else if (pesanError.includes("user rejected")) {
            showToast("Transaksi dibatalkan user", 'error');
            // Balikin tombol ke awal
            btnElement.innerHTML = originalContent;
            btnElement.style.pointerEvents = "auto";
        } else {
            showToast("Gagal: " + (err.reason || "Terjadi kesalahan"), 'error');
            // Balikin tombol ke awal
            btnElement.innerHTML = originalContent;
            btnElement.style.pointerEvents = "auto";
        }
    }
}

// --- HELPER 1: PASTIKAN WALLET TERHUBUNG ---
async function ensureWallet() {
    // Cek apakah Metamask ada?
    if (!window.ethereum) throw new Error("Metamask tidak terinstall!");

    // Cek apakah sudah ada signer?
    if (!signer) {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        // Request akses akun
        await provider.send("eth_requestAccounts", []);
        
        // Cek Network (Harus Base Mainnet)
        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: "0x2105" }], // Hex 8453
                });
            } catch (e) {
                throw new Error("Harap ganti jaringan ke Base Mainnet");
            }
        }
        
        // Update variable global signer
        signer = provider.getSigner();
    }
    return signer;
}

// --- HELPER 2: TOAST NOTIFIKASI (PENGGANTI ALERT) ---
function showToast(message, type = 'info') {
    // Buat elemen toast jika belum ada
    let toast = document.getElementById("customToast");
    if (!toast) {
        toast = document.createElement("div");
        toast.id = "customToast";
        toast.style.cssText = `
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 12px 24px; border-radius: 30px;
            font-size: 14px; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none; align-items: center; gap: 10px; font-family: sans-serif;
        `;
        document.body.appendChild(toast);
    }

    // Tentukan Warna & Ikon
    let icon = '<i class="fas fa-info-circle"></i>';
    let color = "#333";

    if (type === 'success') {
        color = "#27ae60"; // Hijau
        icon = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'error') {
        color = "#c0392b"; // Merah
        icon = '<i class="fas fa-exclamation-circle"></i>';
    } else if (type === 'warning') {
        color = "#f39c12"; // Oranye
        icon = '<i class="fas fa-exclamation-triangle"></i>';
    }

    // Tampilkan
    toast.style.background = color;
    toast.innerHTML = `${icon} <span>${message}</span>`;
    toast.style.display = "flex";
    
    // Animasi Masuk
    toast.style.opacity = 0;
    toast.style.bottom = "10px";
    setTimeout(() => {
        toast.style.transition = "all 0.3s ease";
        toast.style.opacity = 1;
        toast.style.bottom = "30px";
    }, 10);

    // Hilang otomatis setelah 3 detik
    setTimeout(() => {
        toast.style.opacity = 0;
        toast.style.bottom = "10px";
        setTimeout(() => { toast.style.display = "none"; }, 300);
    }, 3000);
}

// Fungsi Update Sidebar (Mode PC)
async function updateSidebarWallet(address) {
    if(!address) return;
    
    // 1. Update Address (UI)
    const addrEl = document.getElementById("userAddrMini");
    if(addrEl) {
        // Logika address pendek
        const short = address.substring(0, 10) + "..." + address.slice(-8);
        
        // Cek dulu biar gak kedip kalau teksnya masih sama
        if(!addrEl.innerHTML.includes(short)) {
            addrEl.innerHTML = `${short} <i class="far fa-copy" style="font-size: 10px; margin-left: 5px; opacity: 0.7;"></i>`;
            addrEl.setAttribute("data-full-address", address);
        }
    }
    
    // 2. Ambil Saldo & Hitung USD
    try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const balance = await provider.getBalance(address);
        const ethVal = ethers.utils.formatEther(balance);
        
        // Update Teks ETH
        if(document.getElementById("userBalance")) {
            document.getElementById("userBalance").innerText = parseFloat(ethVal).toFixed(8); 
        }

        // --- HITUNG ESTIMASI USD (FIXED API) ---
        const usdEl = document.getElementById("usdEstimate");
        if (usdEl) {
            try {
                // Gunakan CoinGecko
                const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd");
                const data = await res.json();
                const ethPrice = data.ethereum.usd;
                
                // Hitung total USD
                const totalUsd = parseFloat(ethVal) * ethPrice;
                
                let formattedUsd;

                // LOGIKA PRESISI MIKRO:
                if (totalUsd === 0) {
                    formattedUsd = "$0.0000";
                } 
                else if (totalUsd < 0.01) {
                    formattedUsd = "$" + totalUsd.toFixed(6);
                } 
                else if (totalUsd < 1) {
                    formattedUsd = "$" + totalUsd.toFixed(4);
                } 
                else {
                    formattedUsd = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(totalUsd);
                }

                usdEl.innerText = ` ${formattedUsd}`;
            } catch(e) { 
                console.warn("Gagal fetch harga USD (API Blocked), skip estimasi.");
                usdEl.innerText = " $ -"; 
            }
        }
        
    } catch(err) {
        console.error("Gagal update sidebar utama:", err);
    }
}

    function copySidebarAddress() {
    const addrEl = document.getElementById("userAddrMini");
    
    // Ambil alamat lengkap dari atribut yang kita simpan tadi
    const fullAddress = addrEl.getAttribute("data-full-address");
    
    if (fullAddress) {
        navigator.clipboard.writeText(fullAddress).then(() => {
            // Tampilkan Toast Sukses
            showToast("Alamat Wallet disalin!", "success");
            
            // Efek visual 'kedip' sedikit biar terasa responsif
            const originalHTML = addrEl.innerHTML;
            addrEl.innerHTML = `<i class="fas fa-check" style="color:#2ecc71;"></i> Tersalin`;
            setTimeout(() => {
                addrEl.innerHTML = originalHTML;
            }, 1000);
        });
    }
    }

    // --- MANAJEMEN TOKEN PINTAR ---
// 1. Load Token saat Web Dibuka
function initTokenManager() {
    // PERHATIKAN: Kuncinya harus "myTokens", sama dengan saat menyimpan
    const saved = localStorage.getItem("myTokens"); 
    
    if(saved) {
        try {
            myTokens = JSON.parse(saved);
            console.log(" Load dari LocalStorage:", myTokens.length, "token");
            renderTokenList(); 
            // Kita beri jeda sedikit sebelum refresh saldo agar tidak bentrok dengan RPC
            setTimeout(refreshAllTokenBalances, 500); 
        } catch (e) {
            console.error("Gagal parse localstorage", e);
            localStorage.removeItem("myTokens"); // Hapus jika data rusak
        }
    } else {
        console.log(" Tidak ada data di LocalStorage");
    }
}

// Panggil fungsi ini di window.onload Anda!
// window.onload = async () => { ... initTokenManager(); ... }

function toggleImportForm() {
    const el = document.getElementById("importTokenBox");
    el.style.display = (el.style.display === "none") ? "block" : "none";
}

// 2. Tambah Token Baru
async function addNewToken() {
    const addrInput = document.getElementById("inputTokenAddr");
    const btn = document.getElementById("btnAddToken");
    const address = addrInput.value.trim();

    if(!ethers.utils.isAddress(address)) return showToast("Alamat kontrak tidak valid!", "error");
    if(myTokens.some(t => t.address.toLowerCase() === address.toLowerCase())) return showToast("Token sudah ada!", "warning");

    try {
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Cek Data...`;
        btn.disabled = true;

        // Konek ke Blockchain untuk ambil metadata
        const provider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
        const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);

        const [name, symbol, decimals] = await Promise.all([
            tokenContract.name(),
            tokenContract.symbol(),
            tokenContract.decimals()
        ]);

        // Simpan ke Array
        const newToken = {
            address: address,
            name: name,
            symbol: symbol,
            decimals: decimals,
            logo: `https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/${ethers.utils.getAddress(address)}/logo.png`
        };

        myTokens.push(newToken);
        saveTokens();
        
        // Render Ulang
        renderTokenList();
        refreshAllTokenBalances();
        
        // Reset Form
        addrInput.value = "";
        toggleImportForm();
        showToast(`Berhasil import ${symbol}!`, "success");

        if(window.saveTokensToCloud && modalUserAddr) {
        window.saveTokensToCloud(modalUserAddr, myTokens);
        }

    } catch(e) {
        console.error(e);
        showToast("Gagal: Bukan Token ERC20 valid", "error");
    } finally {
        btn.innerHTML = `<i class="fas fa-download"></i> Tambahkan Token`;
        btn.disabled = false;
    }
}

// 3. Hapus Token
function removeToken(address) {
    if(!confirm("Hapus token ini dari daftar?")) return;
    
    // Filter (Hapus token target) - Pakai toLowerCase biar akurat
    myTokens = myTokens.filter(t => t.address.toLowerCase() !== address.toLowerCase());
    
    // Simpan Perubahan (Otomatis ke HP & Cloud karena fungsi di atas)
    saveTokens(); 
    
    // Update Tampilan
    renderTokenList();
    
    // Update Total Saldo/Harga (Penting biar estimasi $ di header berkurang)
    if(typeof refreshAllTokenBalances === 'function') {
        refreshAllTokenBalances();
    }
    
    showToast("Token berhasil dihapus.", "success");
}

// Fungsi Penyimpanan Pusat
function saveTokens() {
    // A. Simpan ke HP (LocalStorage) -> Pakai kunci "myTokens"
    localStorage.setItem("myTokens", JSON.stringify(myTokens));

    // B. Simpan ke Cloud (Firebase)
    if(window.saveTokensToCloud && typeof modalUserAddr !== 'undefined' && modalUserAddr) {
        window.saveTokensToCloud(modalUserAddr, myTokens);
    }
}

// Update fungsi renderTokenList
function renderTokenList() {
    const container = document.getElementById("tokenListDisplay");
    container.innerHTML = "";

    myTokens.forEach(token => {
        const fallbackLogo = `https://api.dicebear.com/7.x/identicon/svg?seed=${token.address}`;
        
        const html = `
        <div class="token-item" style="cursor:pointer;" 
             onclick="openSendPopup('${token.address}', '${token.symbol}', ${token.decimals}, '${token.logo}')">
             
            <div class="token-left">
                <img src="${token.logo}" onerror="this.src='${fallbackLogo}'" class="token-logo-img">
                <div class="token-meta">
                    <span class="token-name">${token.name}</span>
                    <span class="token-symbol">$${token.symbol}</span>
                </div>
            </div>
            
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <div class="token-balance" id="bal-${token.address}">0.00000000</div>
                    <div class="token-value-sub" id="val-${token.address}">-</div>
                </div>
                <i class="fas fa-trash delete-token-btn" onclick="event.stopPropagation(); removeToken('${token.address}')"></i>
            </div>
        </div>`;
        
        container.insertAdjacentHTML('beforeend', html);
    });
}

// --- UPDATE SALDO LENGKAP ---
async function refreshAllTokenBalances() {
    if(!window.ethereum || !modalUserAddr) return;
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    
    // Cek Update Harga
    const now = Date.now();
    if ((now - lastPriceFetchTime > PRICE_CACHE_DURATION) || cachedEthPrice === 0) {
        updateMarketPrices(); 
    }

    let currentTotalUsd = 0;

    // Helper HTML Warna
    const getChangeHtml = (changeVal) => {
        // Handle jika undefined/null/0
        if(changeVal === undefined || changeVal === null) return `<span style="color:#777;">(0%)</span>`;
        
        const color = changeVal >= 0 ? '#2ecc71' : '#ef4444'; 
        const sign = changeVal >= 0 ? '+' : '';
        return `<span style="color:${color}; font-weight:bold;">(${sign}${Number(changeVal).toFixed(2)}%)</span>`;
    };

    // ==========================================
    // A. HITUNG ETH (NATIVE)
    // ==========================================
    try {
        const ethRaw = await provider.getBalance(modalUserAddr);
        const ethFmt = ethers.utils.formatEther(ethRaw);
        const ethVal = parseFloat(ethFmt);
        
        const elEth = document.getElementById("staticEthBalance");
        if(elEth) elEth.innerText = ethVal.toFixed(6);

        const ethUsd = ethVal * cachedEthPrice;
        currentTotalUsd += ethUsd;

        const elEthDet = document.getElementById("staticEthDetails");
        if(elEthDet) {
            // cachedEthChange sekarang diisi oleh DexScreener (dari pair WETH)
            elEthDet.innerHTML = `@ ${fmtUSD(cachedEthPrice)} ${getChangeHtml(cachedEthChange)} <br> <span style="color:#666"> ${fmtUSD(ethUsd)}</span>`;
        }
    } catch(e) { }

    // ==========================================
    // B. HITUNG STATIC STABLECOIN (USDC & USDT)
    // ==========================================
    const staticTokens = [
        { id: "Usdc", addr: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", dec: 6 }, 
        { id: "Usdt", addr: "0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2", dec: 6 }  
    ];

    for (let st of staticTokens) {
        try {
            const contract = new ethers.Contract(st.addr, ERC20_ABI, provider);
            const balRaw = await contract.balanceOf(modalUserAddr);
            const balFmt = ethers.utils.formatUnits(balRaw, st.dec);
            const balFloat = parseFloat(balFmt);

            const elBal = document.getElementById(`static${st.id}Balance`);
            if(elBal) elBal.innerText = balFloat.toFixed(2);

            const lowerAddr = st.addr.toLowerCase();
            
            // Harga ($)
            let price = 1.0; 
            if(cachedTokenPrices[lowerAddr]) price = cachedTokenPrices[lowerAddr].usd || 1.0;

            // Persen (%) dari DexScreener
            let change24h = 0;
            if (cachedTokenChanges[lowerAddr] !== undefined) change24h = cachedTokenChanges[lowerAddr];

            const tokenUsd = balFloat * price;
            currentTotalUsd += tokenUsd;
            
            const elDet = document.getElementById(`static${st.id}Details`);
            if(elDet) {
                elDet.innerHTML = `@ ${fmtUSD(price)} ${getChangeHtml(change24h)} <br> <span style="color:#666"> ${fmtUSD(tokenUsd)}</span>`;
            }
        } catch(e) { }
    }

    // ==========================================
    // C. HITUNG TOKEN IMPORT
    // ==========================================
    for (const token of myTokens) {
        try {
            const contract = new ethers.Contract(token.address, ERC20_ABI, provider);
            const balRaw = await contract.balanceOf(modalUserAddr);
            const balFmt = ethers.utils.formatUnits(balRaw, token.decimals);
            const balFloat = parseFloat(balFmt);
            
            const el = document.getElementById(`bal-${token.address}`);
            if(el) el.innerText = balFloat.toFixed(4);

            const lowerAddr = token.address.toLowerCase();
            
            // Harga ($) CoinGecko
            let price = 0;
            if(cachedTokenPrices[lowerAddr]) price = cachedTokenPrices[lowerAddr].usd || 0;

            // Persen (%) DexScreener
            let change24h = 0;
            if (cachedTokenChanges[lowerAddr] !== undefined) change24h = cachedTokenChanges[lowerAddr];
            
            const tokenUsd = balFloat * price;
            currentTotalUsd += tokenUsd;

            const elVal = document.getElementById(`val-${token.address}`);
            if(elVal) {
                 elVal.innerHTML = `@ ${fmtUSD(price)} ${getChangeHtml(change24h)} <br> <span style="color:#666"> ${fmtUSD(tokenUsd)}</span>`;
            }
        } catch(e) { }
    }

    // Update Header Total
    const usdEl = document.getElementById("usdEstimate");
    if (usdEl && (currentTotalUsd > 0 || cachedEthPrice > 0)) {
        usdEl.innerText = ` ${fmtUSD(currentTotalUsd)}`;
    }
}

// --- FUNGSI AMBIL HARGA (HYBRID: HARGA CG + PERSEN SEMUA DARI DEXSCREENER) ---
async function updateMarketPrices() {
    console.log(" Update Harga (CG) & Volatilitas (DS)...");

    // ALAMAT PENTING DI BASE
    const STATIC_USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const STATIC_USDT = "0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2";
    const WETH_BASE   = "0x4200000000000000000000000000000000000006"; // WETH untuk cek % ETH

    try {
        // ==========================================
        // 1. AMBIL HARGA ETH ($) DARI COINGECKO (TETAP & KUAT)
        // ==========================================
        const resEth = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd");
        const dataEth = await resEth.json();
        if(dataEth.ethereum) {
            cachedEthPrice = dataEth.ethereum.usd || 0;
        }

        // ==========================================
        // 2. AMBIL HARGA TOKEN ($) DARI COINGECKO (TETAP & KUAT)
        // ==========================================
        // Kita hanya ambil harga token import, karena stablecoin kita anggap $1 (atau ambil dari cache nanti)
        const tokenAddrs = myTokens.map(t => t.address).join(',');
        
        if(tokenAddrs.length > 0) {
            const urlGecko = `https://api.coingecko.com/api/v3/simple/token_price/base?contract_addresses=${tokenAddrs}&vs_currencies=usd`;
            const resToken = await fetch(urlGecko);
            const dataToken = await resToken.json();
            
            cachedTokenPrices = { ...cachedTokenPrices, ...dataToken };
        }

        // ==========================================
        // 3. AMBIL PERSEN (%) SEMUA ASET DARI DEXSCREENER
        // ==========================================
        // Gabungkan: Token Import + USDC + USDT + WETH (untuk % ETH)
        const allTokensForDex = [
            ...myTokens.map(t => t.address), 
            STATIC_USDC, 
            STATIC_USDT, 
            WETH_BASE
        ];
        
        const dexAddrStr = allTokensForDex.join(',');

        try {
            const urlDex = `https://api.dexscreener.com/latest/dex/tokens/${dexAddrStr}`;
            const resDex = await fetch(urlDex);
            const dataDex = await resDex.json();

            if (dataDex.pairs) {
                // Sortir likuiditas tertinggi agar data valid
                dataDex.pairs.sort((a, b) => (b.liquidity?.usd || 0) - (a.liquidity?.usd || 0));

                dataDex.pairs.forEach(pair => {
                    const addr = pair.baseToken.address.toLowerCase();
                    const wethAddr = WETH_BASE.toLowerCase();

                    // Cek: Apakah ini WETH? Jika ya, simpan ke cachedEthChange
                    if (addr === wethAddr) {
                        // Prioritaskan pair dengan likuiditas tinggi (biasanya WETH/USDC)
                        if (cachedEthChange === 0 || pair.liquidity?.usd > 50000) {
                            cachedEthChange = pair.priceChange.h24;
                        }
                    } 
                    // Jika bukan WETH, simpan ke cache token biasa
                    else {
                        if (cachedTokenChanges[addr] === undefined || pair.liquidity?.usd > 1000) {
                            cachedTokenChanges[addr] = pair.priceChange.h24;
                        }
                    }
                });
            }
        } catch (errDex) {
            console.warn("Gagal ambil persen DexScreener:", errDex);
        }
        
        lastPriceFetchTime = Date.now(); 
        refreshAllTokenBalances();

    } catch(e) {
        console.warn("Gagal update market utama:", e);
    }
}
        
// Helper Format Uang
const fmtUSD = (val) => {
    if(!val) val = 0;
    if(val === 0) return "$0.00";
    if(val < 0.01) return "$" + val.toFixed(6);
    if(val < 1) return "$" + val.toFixed(4);
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
};
        
        // --- FITUR AUTO-IMPORT TOKEN SULTAN ---
async function autoScanTokens() {
    if (!window.ethereum || !modalUserAddr) return;
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    
    console.log(" Scanning aset populer...");
    let newTokensFound = false;

    // Loop semua token populer
    for (const token of POPULAR_BASE_TOKENS) {
        // 1. Cek apakah token ini SUDAH ADA di daftar user? (Biar gak dobel)
        const isAlreadyImported = myTokens.some(t => t.address.toLowerCase() === token.address.toLowerCase());
        
        if (!isAlreadyImported) {
            try {
                // 2. Cek Saldo di Blockchain
                const contract = new ethers.Contract(token.address, ERC20_ABI, provider);
                const balRaw = await contract.balanceOf(modalUserAddr);

                // 3. JIKA SALDO > 0 (Punya Duit), Import Otomatis!
                if (balRaw.gt(0)) {
                    const newToken = {
                        address: token.address,
                        name: token.name,
                        symbol: token.symbol,
                        decimals: token.decimals,
                        logo: `https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/${ethers.utils.getAddress(token.address)}/logo.png`
                    };
                    
                    myTokens.push(newToken);
                    newTokensFound = true;
                    console.log(` Aset ditemukan: ${token.symbol}`);
                }
            } catch (e) {
                // Skip jika error (mungkin kontrak bermasalah)
            }
        }
    }

    // 4. Jika ada token baru, simpan & refresh tampilan
    if (newTokensFound) {
        saveTokens(); // Simpan ke LocalStorage
        renderTokenList(); // Tampilkan di Sidebar
        refreshAllTokenBalances(); // Update saldo & harga USD
        showToast("Aset crypto Anda berhasil dideteksi otomatis!", "success");
    }
}

    // ==========================================
// SISTEM PENGIRIMAN (CUSTOM DROPDOWN + LOGO)
// ==========================================

// 1. FUNGSI UTAMA: Buka Popup (Dari Tombol "Kirim" Utama)
async function openGeneralSendPopup() {
    if(!modalUserAddr) return showToast("Hubungkan dompet dulu!", "warning");
    
    // A. Render List Token (Biar isinya update)
    renderCustomDropdown();
    
    // B. Buka Modal
    document.getElementById("sendModalOverlay").style.display = "flex";
    
    // C. Reset Form
    resetSendForm();
    
    // D. Default Pilih ETH (Native)
    // Logo ETH saya pakai link TrustWallet agar konsisten
    selectToken(
        'ETH', 
        'ETH', 
        'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png', 
        18
    );
}

// 2. FUNGSI KHUSUS: Buka Popup (Dari Klik List Token di Sidebar)
async function openSendPopup(address, symbol, decimals, logo) {
    if(!modalUserAddr) return showToast("Hubungkan dompet dulu!", "warning");

    // A. Render List Token (Supaya kalau user mau ganti token di dlm popup, listnya ada)
    renderCustomDropdown();

    // B. Buka Modal
    document.getElementById("sendModalOverlay").style.display = "flex";
    
    // C. Reset Form
    resetSendForm();

    // D. Langsung Pilih Token yang Diklik tadi
    selectToken(address, symbol, logo, decimals);
}

// 3. Helper: Reset Form
function resetSendForm() {
    document.getElementById("inputSendAddr").value = "";
    document.getElementById("inputSendAmount").value = "";
    document.getElementById("addrErrorMsg").style.display = "none";
    document.getElementById("inputSendAddr").classList.remove("input-error", "input-success");
    document.getElementById("btnProceedSend").disabled = true;
    document.getElementById("btnProceedSend").classList.remove("btn-ready");
    
    // Tutup dropdown jika masih terbuka
    const wrapper = document.querySelector('.custom-select-wrapper');
    if(wrapper) wrapper.classList.remove('open');
}

// 4. Tutup Modal
function closeSendModal() {
    document.getElementById("sendModalOverlay").style.display = "none";
}

// ==========================================
// LOGIKA CUSTOM DROPDOWN (UI)
// ==========================================

// 1. Render List Token ke dalam Dropdown
function renderCustomDropdown() {
    const listContainer = document.getElementById("tokenOptionsList");
    if(!listContainer) return;

    listContainer.innerHTML = ""; // Bersihkan isi lama

    // A. Masukkan ETH (Paling Atas)
    const ethLogo = "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png";
    const ethHtml = `
        <div class="custom-option" onclick="selectToken('ETH', 'ETH', '${ethLogo}', 18)">
            <img src="${ethLogo}" class="token-mini-logo">
            <span style="font-weight:bold;">Ethereum</span> 
            <span style="color:#777; font-size:11px;">(ETH)</span>
        </div>
    `;
    listContainer.insertAdjacentHTML('beforeend', ethHtml);

    // 1. USD Coin (USDC) - Base Mainnet (Decimals: 6)
    const usdcAddr = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"; 
    const usdcLogo = "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913/logo.png";
    
    const usdcHtml = `
        <div class="custom-option" onclick="selectToken('${usdcAddr}', 'USDC', '${usdcLogo}', 6)">
            <img src="${usdcLogo}" class="token-mini-logo">
            <span style="font-weight:bold;">USD Coin</span> 
            <span style="color:#777; font-size:11px;">(USDC)</span>
        </div>`;
    listContainer.insertAdjacentHTML('beforeend', usdcHtml);

    // 2. Tether USD (USDT) - Base Mainnet (Decimals: 6)
    const usdtAddr = "0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2";
    const usdtLogo = "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/base/assets/0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2/logo.png";
    
    const usdtHtml = `
        <div class="custom-option" onclick="selectToken('${usdtAddr}', 'USDT', '${usdtLogo}', 6)">
            <img src="${usdtLogo}" class="token-mini-logo">
            <span style="font-weight:bold;">Tether USD</span> 
            <span style="color:#777; font-size:11px;">(USDT)</span>
        </div>`;
    listContainer.insertAdjacentHTML('beforeend', usdtHtml);

    // B. Masukkan Token Import (Looping)
    if (myTokens && myTokens.length > 0) {
        myTokens.forEach(token => {
            // Logo fallback jika error (Identicon)
            const fallback = `https://api.dicebear.com/7.x/identicon/svg?seed=${token.address}`;
            
            const html = `
            <div class="custom-option" onclick="selectToken('${token.address}', '${token.symbol}', '${token.logo}', ${token.decimals})">
                <img src="${token.logo}" onerror="this.src='${fallback}'" class="token-mini-logo">
                <span style="font-weight:bold;">${token.name}</span> 
                <span style="color:#777; font-size:11px;">(${token.symbol})</span>
            </div>`;
            listContainer.insertAdjacentHTML('beforeend', html);
        });
    }
}

// 2. Logika Saat Token Dipilih (Klik Opsi)
async function selectToken(address, symbol, logo, decimals) {
    // A. Update Tampilan Header Dropdown
    const displayLogo = document.getElementById("displayLogo");
    const displaySymbol = document.getElementById("displaySymbol");
    
    if(displayLogo) displayLogo.src = logo;
    if(displaySymbol) displaySymbol.innerText = symbol;

    // B. Update Hidden Value (Untuk keperluan form submit)
    const hiddenInput = document.getElementById("hiddenTokenValue");
    if(hiddenInput) hiddenInput.value = address;

    // C. Tutup Dropdown
    const wrapper = document.querySelector('.custom-select-wrapper');
    if(wrapper) wrapper.classList.remove('open');

    // D. Load Saldo & Simpan State Active
    document.getElementById("sendMaxBal").innerText = "Loading...";
    document.getElementById("inputTicker").innerText = symbol;
    
    const provider = new ethers.providers.Web3Provider(window.ethereum);

    try {
        let balanceBN;
        if(address === 'ETH') {
            balanceBN = await provider.getBalance(modalUserAddr);
        } else {
            const contract = new ethers.Contract(address, ERC20_ABI, provider);
            balanceBN = await contract.balanceOf(modalUserAddr);
        }

        // Simpan ke Global Variable
        activeToken = {
            address: address,
            symbol: symbol,
            decimals: decimals,
            logo: logo,
            balanceBN: balanceBN
        };

        // Tampilkan Saldo
        const fmt = ethers.utils.formatUnits(balanceBN, decimals);
        document.getElementById("sendMaxBal").innerText = parseFloat(fmt).toFixed(6);

    } catch(e) {
        console.error("Gagal load saldo:", e);
        document.getElementById("sendMaxBal").innerText = "0.00";
    }
}

// 3. Toggle Dropdown (Klik Header)
function toggleTokenList() {
    const wrapper = document.querySelector('.custom-select-wrapper');
    if(wrapper) wrapper.classList.toggle('open');
}

// Tutup dropdown jika klik di luar area
window.onclick = function(e) {
    const wrapper = document.querySelector('.custom-select-wrapper');
    const trigger = document.querySelector('.custom-select-trigger');
    if (wrapper && trigger && !wrapper.contains(e.target) && !trigger.contains(e.target)) {
        wrapper.classList.remove('open');
    }
};


// ==========================================
// VALIDASI & EKSEKUSI (LOGIKA TRANSFER)
// ==========================================

// 1. Validasi Input Alamat
function validateSendAddr() {
    const input = document.getElementById("inputSendAddr");
    const val = input.value.trim();
    const err = document.getElementById("addrErrorMsg");

    // Regex: 0x diikuti 40 karakter hex
    const isValid = /^0x[a-fA-F0-9]{40}$/.test(val);

    if(val.length > 0) {
        if(!isValid) {
            input.classList.add("input-error");
            input.classList.remove("input-success");
            err.style.display = "block";
        } else {
            input.classList.remove("input-error");
            input.classList.add("input-success");
            err.style.display = "none";
        }
    } else {
        input.classList.remove("input-error", "input-success");
        err.style.display = "none";
    }
    checkFormReady();
}

// 2. Cek Tombol Kirim Aktif/Tidak
document.getElementById("inputSendAmount").addEventListener("input", checkFormReady);

function checkFormReady() {
    const addr = document.getElementById("inputSendAddr").value.trim();
    const amt = document.getElementById("inputSendAmount").value;
    const btn = document.getElementById("btnProceedSend");
    const isAddrValid = /^0x[a-fA-F0-9]{40}$/.test(addr);

    if(isAddrValid && amt > 0) {
        btn.disabled = false;
        btn.classList.add("btn-ready");
    } else {
        btn.disabled = true;
        btn.classList.remove("btn-ready");
    }
}

// 3. Tombol Max / Persen
function setSendPercent(percent) {
    if(!activeToken || !activeToken.balanceBN || activeToken.balanceBN.isZero()) return;

    // Hitung amount: Balance * Percent / 100
    const amountBN = activeToken.balanceBN.mul(percent).div(100);
    const amountStr = ethers.utils.formatUnits(amountBN, activeToken.decimals);
    
    document.getElementById("inputSendAmount").value = amountStr;
    checkFormReady();
}

// 4. Konfirmasi Akhir
function askConfirmation() {
    const addr = document.getElementById("inputSendAddr").value.trim();
    const amt = document.getElementById("inputSendAmount").value;

    document.getElementById("confAmount").innerText = amt;
    document.getElementById("confSymbol").innerText = activeToken.symbol;
    document.getElementById("confAddr").innerText = addr;
    
    document.getElementById("confirmModalOverlay").style.display = "flex";
}

// 5. EKSEKUSI TRANSFER KE BLOCKCHAIN
async function executeTransfer() {
    document.getElementById("confirmModalOverlay").style.display = "none";
    closeSendModal(); 

    const addr = document.getElementById("inputSendAddr").value.trim();
    const amt = document.getElementById("inputSendAmount").value;
    
    showToast("Memproses transaksi...", "info");

    try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        
        // Konversi input ke Wei
        const amountWei = ethers.utils.parseUnits(amt, activeToken.decimals);

        let tx;
        if(activeToken.address === 'ETH') {
            tx = await signer.sendTransaction({
                to: addr,
                value: amountWei
            });
        } else {
            const contract = new ethers.Contract(activeToken.address, ERC20_ABI, signer);
            tx = await contract.transfer(addr, amountWei);
        }

        showToast("Transaksi dikirim! Menunggu...", "success");
        await tx.wait();
        
        showToast("BERHASIL! Aset terkirim.", "success");
        
        // Refresh Saldo Total
        if(typeof refreshAllTokenBalances === 'function') refreshAllTokenBalances();

    } catch(err) {
        console.error(err);
        showToast("Gagal: " + (err.reason || err.message), "error");
    }
}

    // --- FITUR RIWAYAT: SMART SCAN (MUNDUR SAMPAI DAPAT) + INFINITE SCROLL ---

// FUNGSI 1: SCANNING MUNDUR BERTAHAP (Cari Data Dulu)
async function loadUserHistory(userAddr) {
    if (!userAddr) return;
    
    // SETUP UI
    const container = document.getElementById("txHistoryList");
    const linkScan = document.getElementById("linkBasescan");
    if(linkScan) linkScan.href = `https://basescan.org/address/${userAddr}`;
    
    // Reset State
    userHistoryLogs = [];
    historyCursor = 0;
    isHistoryLoading = false;
    
    // Tampilkan Loading Awal
    container.innerHTML = `<div style="text-align:center; font-size:11px; color:#aaa; padding:20px;"><i class="fas fa-circle-notch fa-spin"></i> Mencari jejak digital...</div>`;

    // PASANG SENSOR SCROLL (Facebook Style)
    container.onscroll = function() {
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 50) {
            renderNextHistoryBatch();
        }
    };

    try {
        const provider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
        
        // --- KONFIGURASI SMART SCAN ---
        const currentBlock = await provider.getBlockNumber();
        const DEPLOY_BLOCK = 40502777; // Ganti dengan blok deploy kontrak jika tahu (biar lebih cepat)
        const CHUNK_SIZE = 20000; // Aman untuk RPC Publik
        const MIN_DATA_NEEDED = 10; // Target minimal data biar box gak kosong

        let toBlock = currentBlock;
        let fromBlock = Math.max(currentBlock - CHUNK_SIZE, DEPLOY_BLOCK);
        let foundEnoughData = false;
        let loopCount = 0;
        const MAX_LOOPS = 50; // Batas maksimal mundur (sekitar 1 juta blok) biar browser gak crash

        // --- LOOPING MUNDUR (MENCARI DATA) ---
        while (!foundEnoughData && loopCount < MAX_LOOPS && toBlock > DEPLOY_BLOCK) {
            
            // Update Loading Text (Biar user tau progressnya)
            if(loopCount > 0) {
                container.innerHTML = `<div style="text-align:center; font-size:10px; color:#aaa; padding:20px;">
                    <i class="fas fa-search"></i> Memuat data... (Ditemukan: ${userHistoryLogs.length})
                </div>`;
            }

            // 1. SIAPKAN FILTER
            const filterTo = contract.filters.Transfer(null, userAddr);
            const filterFrom = contract.filters.Transfer(userAddr, null);
            const filterTipTo = contract.filters.TipSent(null, userAddr);
            const filterTipFrom = contract.filters.TipSent(userAddr, null);

            // 2. AMBIL DATA (Chunk 20rb blok)
            const [logsTo, logsFrom, tipsTo, tipsFrom] = await Promise.all([
                contract.queryFilter(filterTo, fromBlock, toBlock),
                contract.queryFilter(filterFrom, fromBlock, toBlock),
                contract.queryFilter(filterTipTo, fromBlock, toBlock),
                contract.queryFilter(filterTipFrom, fromBlock, toBlock)
            ]);

            // 3. GABUNGKAN HASIL
            const newLogs = [
                ...logsTo.map(l => ({ ...l, type: 'nft_in' })),
                ...logsFrom.map(l => ({ ...l, type: 'nft_out' })),
                ...tipsTo.map(l => ({ ...l, type: 'tip_in' })),
                ...tipsFrom.map(l => ({ ...l, type: 'tip_out' }))
            ];

            // Masukkan ke variabel global
            userHistoryLogs = [...userHistoryLogs, ...newLogs];

            // 4. CEK APAKAH SUDAH CUKUP?
            if (userHistoryLogs.length >= MIN_DATA_NEEDED) {
                foundEnoughData = true; // Stop scanning, data sudah ada!
            } else {
                // Belum cukup? Mundur lagi ke belakang
                toBlock = fromBlock - 1;
                fromBlock = Math.max(toBlock - CHUNK_SIZE, DEPLOY_BLOCK);
                loopCount++;
            }
        }

        // --- SELESAI SCANNING ---
        
        // Urutkan data yang didapat (Terbaru di atas)
        userHistoryLogs.sort((a, b) => b.blockNumber - a.blockNumber);

        // Hapus loading
        container.innerHTML = ""; 

        if (userHistoryLogs.length === 0) {
            container.innerHTML = `<div style="text-align:center; font-size:11px; color:#aaa; padding:15px;">Belum ada aktivitas.</div>`;
            return;
        }

        // PANGGIL RENDER BATCH PERTAMA (10 ITEM)
        await renderNextHistoryBatch();

    } catch (e) {
        console.warn("Gagal load history:", e);
        container.innerHTML = `<div style="text-align:center; font-size:10px; color:#e74c3c;">Gagal memuat data (RPC Error).</div>`;
    }
}

// FUNGSI 2: RENDER INFINITE SCROLL (Dipanggil saat scroll mentok)
async function renderNextHistoryBatch() {
    // Cek: Sedang loading atau data sudah habis?
    if (isHistoryLoading || historyCursor >= userHistoryLogs.length) return;
    
    isHistoryLoading = true;
    const container = document.getElementById("txHistoryList");
    const provider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    // Tampilkan Loader Kecil di Bawah
    const loaderId = "miniLoaderHistory";
    if(!document.getElementById(loaderId)) {
        container.insertAdjacentHTML('beforeend', 
            `<div id="${loaderId}" style="text-align:center; padding:10px; font-size:10px; color:#aaa;">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat...
            </div>`
        );
    }

    // AMBIL 10 DATA BERIKUTNYA
    const batch = userHistoryLogs.slice(historyCursor, historyCursor + 10);

    // LOOPING RENDER (Satu per satu biar Golongan muncul)
    for (let ev of batch) {
        let icon, title, sub, valStr;
        let namaGolongan = ""; 

        // CARI NAMA GOLONGAN (Hanya untuk NFT)
        if (ev.type.includes('nft')) {
            try {
                const info = await contract.getInfoWayang(ev.args.tokenId);
                namaGolongan = info.golongan ? ` ${info.golongan}` : ""; 
            } catch (e) { namaGolongan = ""; }
        }

        // LOGIKA TAMPILAN
        if (ev.type === 'nft_in') {
            if (ev.args.from === "0x0000000000000000000000000000000000000000") {
                icon = `<div class="history-icon icon-mint"><i class="fas fa-paint-brush"></i></div>`;
                title = `Mint Wayang${namaGolongan}`;
                sub = `ID Koleksi #${ev.args.tokenId}`;
                valStr = `<span style="color:#7385a5;">+1 NFT</span>`;
            } else {
                icon = `<div class="history-icon icon-in"><i class="fas fa-arrow-down"></i></div>`;
                title = `Terima Wayang${namaGolongan}`;
                sub = `Dari: ${ev.args.from.substring(0,4)}...${ev.args.from.slice(-4)}`;
                valStr = `<span style="color:#2ecc71;">+1 NFT</span>`;
            }
        } 
        else if (ev.type === 'nft_out') {
            icon = `<div class="history-icon icon-out"><i class="fas fa-paper-plane"></i></div>`;
            title = `Kirim Wayang${namaGolongan}`;
            sub = `Ke: ${ev.args.to.substring(0,4)}...${ev.args.to.slice(-4)}`;
            valStr = `<span style="color:#e74c3c;">-1 NFT</span>`;
        }
        else if (ev.type.includes('tip')) {
            const amount = parseFloat(ethers.utils.formatEther(ev.args.amount)).toFixed(4);
            if (ev.type === 'tip_in') {
                icon = `<div class="history-icon icon-tip"><i class="fas fa-gift"></i></div>`;
                title = "Dapat Dukungan";
                sub = `Dari Fans`;
                valStr = `<span style="color:#f39c12;">+${amount} ETH</span>`;
            } else {
                icon = `<div class="history-icon icon-out"><i class="fas fa-donate"></i></div>`;
                title = "Kirim Dukungan";
                sub = `Dukungan Karya`;
                valStr = `<span style="color:#e74c3c;">-${amount} ETH</span>`;
            }
        }

        // RENDER ITEM (Sisipkan sebelum loader)
        const html = `
        <div class="history-item" onclick="window.open('https://basescan.org/tx/${ev.transactionHash}', '_blank')" 
             style="cursor:pointer; animation: fadeIn 0.3s ease;">
            ${icon}
            <div class="history-content">
                <div class="history-title">${title}</div>
                <div class="history-sub">${sub}</div>
            </div>
            <div class="history-val">${valStr}</div>
        </div>`;
        
        const loaderEl = document.getElementById(loaderId);
        if(loaderEl) loaderEl.insertAdjacentHTML('beforebegin', html);
    }

    // UPDATE CURSOR
    historyCursor += 10;
    isHistoryLoading = false;
    
    // HAPUS LOADER JIKA SUDAH HABIS
    if(historyCursor >= userHistoryLogs.length) {
        const loaderEl = document.getElementById(loaderId);
        if(loaderEl) loaderEl.remove();
        container.insertAdjacentHTML('beforeend', `<div style="text-align:center; font-size:9px; color:#ddd; padding:5px;">- Akhir Riwayat -</div>`);
    }

    // AUTO-FILL (Jika layar besar dan data belum penuh, load lagi)
    if (container.scrollHeight <= container.clientHeight && historyCursor < userHistoryLogs.length) {
        renderNextHistoryBatch();
    }
 }

// --- FITUR GLOBAL ACTIVITY FEED (SAFE MODE) ---
async function loadGlobalFeed() {
    const container = document.getElementById("globalFeedList");
    const refreshIcon = document.getElementById("btnRefreshFeed");
    
    if(refreshIcon) refreshIcon.classList.add("fa-spin");
    container.innerHTML = `<div style="text-align:center; font-size:11px; color:#aaa; padding:15px;"><i class="fas fa-circle-notch fa-spin"></i> Memuat kabar jagat...</div>`;

    try {
        const provider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
        
        const currentBlock = await provider.getBlockNumber();
        const fromBlock = currentBlock - 5000; // Scan 5000 blok terakhir (aman)

        let allFeed = [];

        // 1. AMBIL EVENT SECARA TERPISAH (Agar kalau satu error, yg lain tetap jalan)
        
        // A. Event WayangLahir
        try {
            if (contract.filters.WayangLahir) {
                const logs = await contract.queryFilter(contract.filters.WayangLahir(), fromBlock, "latest");
                allFeed.push(...logs.map(l => ({ ...l, feedType: 'MINT' })));
            }
        } catch (err) { console.warn("Skip WayangLahir:", err.message); }

        // B. Event Reviewed
        try {
            if (contract.filters.Reviewed) {
                const logs = await contract.queryFilter(contract.filters.Reviewed(), fromBlock, "latest");
                allFeed.push(...logs.map(l => ({ ...l, feedType: 'REVIEW' })));
            }
        } catch (err) { console.warn("Skip Reviewed:", err.message); }

        // C. Event TipSent
        try {
            if (contract.filters.TipSent) {
                const logs = await contract.queryFilter(contract.filters.TipSent(), fromBlock, "latest");
                allFeed.push(...logs.map(l => ({ ...l, feedType: 'TIP' })));
            }
        } catch (err) { console.warn("Skip TipSent:", err.message); }


        // 2. URUTKAN & TAMPILKAN
        allFeed.sort((a, b) => b.blockNumber - a.blockNumber);
        const recentFeed = allFeed.slice(0, 10);

        if (recentFeed.length === 0) {
            container.innerHTML = `<div style="text-align:center; font-size:11px; color:#aaa; padding:15px;">Belum ada aktivitas baru.</div>`;
            return;
        }

        container.innerHTML = ""; 

        for (let ev of recentFeed) {
            let icon, contentHtml;
            const shortAddr = (addr) => addr.substring(0,5) + "..." + addr.substring(addr.length-3);

            if (ev.feedType === 'MINT') {
                const creator = ev.args.creator;
                const namaWayang = ev.args.nama;
                const isOfficial = ev.args.isOfficial;
                const actor = isOfficial ? "Putramas Official" : shortAddr(creator);
                
                icon = `<div class="history-icon" style="background:rgba(231,76,60,0.1); color:#e74c3c;"><i class="fas fa-fire"></i></div>`;
                contentHtml = `<div class="history-title"><b>${actor}</b> Mint<span style="color:#e74c3c;">${namaWayang}</span></div><div class="history-sub">Wayang baru lahir!</div>`;
            } 
            else if (ev.feedType === 'REVIEW') {
                const user = ev.args.user;
                const stars = ev.args.star;
                
                // Icon Bulat di Kiri (Tetap)
                icon = `<div class="history-icon" style="background:rgba(241,196,15,0.1); color:#f39c12;"><i class="fas fa-star"></i></div>`;
                
                // ISI KONTEN (Emoji Bintang diganti FA Icon)
                contentHtml = `
                    <div class="history-title"><b>${shortAddr(user)}</b> Memberi Rating</div>
                    <div class="history-sub">
                        <i class="fas fa-star" style="color:#f39c12; margin-right:4px;"></i> ${stars}/5
                    </div>`;
            }
            else if (ev.feedType === 'TIP') {
                const from = ev.args.from;
                const amount = parseFloat(ethers.utils.formatEther(ev.args.amount)).toFixed(4);
                
                // Icon Bulat di Kiri (Tetap)
                icon = `<div class="history-icon" style="background:rgba(46,204,113,0.1); color:#2ecc71;"><i class="fas fa-heart"></i></div>`;
                
                // ISI KONTEN (Emoji diganti FA Icon)
                contentHtml = `
                    <div class="history-title"><b>${shortAddr(from)}</b> Dukung</div>
                    <div class="history-sub">
                        <i class="fas fa-heart" style="color:#2ecc71; margin-right:4px;"></i> ${amount} ETH
                    </div>`;
            }

            const html = `
            <div class="history-item" onclick="window.open('https://basescan.org/tx/${ev.transactionHash}', '_blank')" style="cursor:pointer; animation: fadeIn 0.5s ease;">
                ${icon}
                <div class="history-content">${contentHtml}</div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

    } catch (e) {
        console.warn("Feed Error Global:", e);
        container.innerHTML = `<div style="text-align:center; font-size:10px; color:#e74c3c;">Gagal memuat feed (Check ABI).</div>`;
    } finally {
        if(refreshIcon) setTimeout(() => refreshIcon.classList.remove("fa-spin"), 500);
    }
}

// ==========================================
// 1. PANGGIL DATA & BUKA MODAL
// ==========================================
async function panggilSawerDetail(id) { 
    try {
        // 1. Fallback ID
        if (!id) {
            const params = new URLSearchParams(window.location.search);
            id = params.get('id');
        }
        if (!id) return showToast("ID Wayang tidak ditemukan.", 'error');

        // --- TAMBAHAN PENTING (REAL-TIME) ---
        activeSawerId = id; // Simpan ID agar nanti bisa diupdate angkanya
        // ------------------------------------

        // 2. Ambil Nama Wayang
        const elNama = document.getElementById("displayName");
        const namaWayang = elNama ? elNama.innerText : `Wayang #${id}`;
        
        // Loading Tombol
        const btnId = `btnSawer-${id}`; 
        const btn = document.getElementById(btnId);
        let originalIcon = "";
        
        if(btn) {
            originalIcon = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            btn.disabled = true;
        }

        try {
            // Gunakan contractReader global
            const ownerAddress = await contractReader.ownerOf(id);
            
            if(!ownerAddress || ownerAddress === "0x0000000000000000000000000000000000000000") {
                throw new Error("Invalid Owner Address");
            }

            const autoMessage = `Dukungan untuk: ${namaWayang} (ID #${id})`;
            await bukaModalSawer(ownerAddress, namaWayang, autoMessage);

        } catch (err) {
            console.error("Error Blockchain:", err);
            showToast("Gagal memuat data pemilik.", 'error');
        } finally {
            if(btn) {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        }
    } catch (e) {
        console.error("Error Script:", e);
        showToast("Terjadi kesalahan sistem.", 'error');
    }
}

// ==========================================
// 2. LOGIKA BUKA MODAL
// ==========================================
async function bukaModalSawer(address, name, autoMsg = "") {
    let currentUser = typeof userAddress !== 'undefined' ? userAddress : null;
    
    // Cek wallet connection
    if (!currentUser && window.ethereum) {
        try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) currentUser = accounts[0];
        } catch(e) {}
    }

    if (!currentUser) {
        showToast("Harap hubungkan wallet terlebih dahulu!", 'warning');
        return;
    }

    // Validasi Address
    if (!address || address === "0x0000000000000000000000000000000000000000") {
        showToast("Data pemilik tidak valid.", 'error');
        return;
    }

    // --- BAGIAN INI DIPERBAIKI ---
    if (currentUser.toLowerCase() === address.toLowerCase()) {
        showToast("Tidak bisa dukung diri sendiri.", 'warning'); // Ganti 'info' jadi 'warning' agar merah/kuning
        return; // <--- HAPUS TANDA // SUPAYA BERHENTI DISINI
    }
    // -----------------------------

    // Set Global Target
    sawerTargetAddress = address;

    // Update UI Modal
    document.getElementById("sawerReceiverName").innerText = name;
    document.getElementById("sawerReceiverAddr").innerText = address.substring(0, 6) + "..." + address.slice(-4);
    document.getElementById("sawerAmount").value = "";

    const elMsg = document.getElementById("sawerMessage");
    if(elMsg) {
        elMsg.value = autoMsg; 
        elMsg.readOnly = true; 
        elMsg.style.backgroundColor = "#f0f2f5";
    }

    // Cek Saldo User
    refreshUserBalance(currentUser);

    // Tampilkan
    toggleSawerModal(true);
}
// ==========================================
// 3. HITUNG PERSENTASE (Menggunakan Global Const)
// ==========================================
function setSawerPercent(percent) {
    const elSaldo = document.getElementById("sawerUserBalance");
    const rawBalance = elSaldo ? elSaldo.getAttribute('data-balance') : "0";
    
    if (!rawBalance || parseFloat(rawBalance) === 0) {
        showToast("Saldo kosong atau wallet belum terhubung.", 'warning');
        return;
    }

    let balanceEth = parseFloat(rawBalance);
    const GAS_RESERVE = 0.000001; // Cadangan untuk gas fee

    // Saldo yang aman digunakan
    let maxSafeUser = balanceEth - GAS_RESERVE;
    if (maxSafeUser < 0) maxSafeUser = 0;

    // Limit efektif (Tidak boleh lebih dari MAX_TIP dan tidak boleh lebih dari saldo user)
    let effectiveLimit = Math.min(maxSafeUser, MAX_TIP);

    let amount = 0;
    if (percent === 'MIN') {
        amount = MIN_TIP;
    } else {
        amount = (effectiveLimit * percent) / 100;
    }

    // Validasi Akhir
    if (amount < MIN_TIP) amount = MIN_TIP; // Jangan di bawah minimum
    if (amount > maxSafeUser) amount = maxSafeUser; // Jangan melebihi saldo

    // Jika saldo user bahkan tidak cukup untuk minimum + gas
    if (maxSafeUser < MIN_TIP) {
        document.getElementById("sawerAmount").value = "";
        showToast("Saldo tidak cukup (Butuh min 0.000001 + Gas).", 'error');
        return;
    }

    document.getElementById("sawerAmount").value = parseFloat(amount.toFixed(5));
}
        
// ==========================================
// 4. EKSEKUSI TRANSAKSI (FINAL - CORRECT COUNT)
// ==========================================
async function eksekusiSawer() {
    const amountVal = document.getElementById("sawerAmount").value;
    const msgVal = document.getElementById("sawerMessage").value;
    const btnModal = document.getElementById("btnKirimSawer");

    if (!sawerTargetAddress) {
        showToast("Error: Target penerima hilang.", 'error');
        return;
    }

    if (!amountVal || amountVal < MIN_TIP || amountVal > MAX_TIP) {
        showToast(`Nominal harus antara ${MIN_TIP} - ${MAX_TIP} ETH`, 'warning');
        return;
    }

    // --- 1. DEFINISIKAN btnCard DI SINI ---
    let btnCard = null;
    let originalCardContent = "";
    
    // Cek apakah kita sedang memproses ID tertentu
    if (activeSawerId) {
        btnCard = document.getElementById(`btnSawer-${activeSawerId}`);
        if (btnCard) {
            originalCardContent = btnCard.innerHTML; // Simpan icon lama
        }
    }

    try {
        // Loading di Modal
        btnModal.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memproses...`;
        btnModal.disabled = true;

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contractWrite = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer); 
        const amountWei = ethers.utils.parseEther(amountVal.toString());

        // Kirim Transaksi
        const tx = await contractWrite.sendTip(sawerTargetAddress, msgVal, { 
            value: amountWei,
            gasLimit: 300000 
        });
        
        // Modal Tutup, Toast Muncul
        toggleSawerModal(false); 
        showToast("Transaksi dikirim ke Blockchain...", 'load');

        // UBAH TOMBOL KARTU JADI LOADING (Feedback Visual)
        if (btnCard) {
            btnCard.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            btnCard.disabled = true;
        }

        // TUNGGU SAMPAI SELESAI
        await tx.wait();
        
        showToast(`Sukses terkirim!`, 'success');
        if (typeof userAddress !== 'undefined') refreshUserBalance(userAddress);

        // --- 2. UPDATE ANGKA SPESIFIK (FILTER PESAN) ---
        if (activeSawerId && sawerTargetAddress) {
            try {
                // Hitung ulang khusus ID ini (Pakai fungsi helper baru)
                const updatedCount = await getTipCountByID(activeSawerId, sawerTargetAddress);
                
                if (btnCard) {
                    // Update Text HTML (jika ada elemen span terpisah)
                    const elCount = document.getElementById(`sawerCount-${activeSawerId}`);
                    if(elCount) elCount.innerText = updatedCount;

                    // Balikin Tombol Jadi Icon Kado + Angka Baru
                    btnCard.innerHTML = `<i class="fas fa-gift"></i> <span id="sawerCount-${activeSawerId}">${updatedCount}</span>`;
                    btnCard.disabled = false;
                    
                    // Efek visual sukses (Hijau sebentar)
                    btnCard.style.color = "#2ecc71";
                    setTimeout(() => btnCard.style.color = "", 1000);
                }
            } catch (e) {
                console.warn("Gagal update angka:", e);
                // Kalau gagal hitung, balikin tampilan tombol lama
                if (btnCard) {
                    btnCard.innerHTML = originalCardContent; 
                    btnCard.disabled = false;
                }
            }
        }

    } catch (err) {
        console.error("Sawer Error:", err);
        let msg = "Transaksi Gagal.";
        
        if (err.code === 4001 || (err.error && err.error.code === 4001)) {
            msg = "Transaksi dibatalkan user.";
        } else if (err.message && err.message.includes("insufficient funds")) {
            msg = "Saldo ETH tidak cukup.";
        }
        
        showToast(msg, 'error');

        // Kalau Error, Kembalikan Tombol Kartu
        if (btnCard) {
            btnCard.innerHTML = originalCardContent;
            btnCard.disabled = false;
        }

    } finally {
        // Balikin Tombol Modal
        if (btnModal) {
            btnModal.innerHTML = `<i class="fas fa-paper-plane"></i> Kirim Apresiasi`;
            btnModal.disabled = false;
        }
    }
}

// --- HELPER: HITUNG SAWERAN PER ITEM (FILTER BY MESSAGE) ---
async function getTipCountByID(wayangId, ownerAddress) {
    try {
        // 1. Ambil semua riwayat saweran ke Owner ini
        const filter = contractReader.filters.TipSent(null, ownerAddress);
        
        // Scan 50.000 blok terakhir agar loading cepat
        const currentBlock = await contractReader.provider.getBlockNumber();
        const fromBlock = Math.max(0, currentBlock - 50000); 

        const logs = await contractReader.queryFilter(filter, fromBlock, "latest");

        // 2. HITUNG MANUAL: Cek isi pesannya satu per satu
        let count = 0;
        const targetTag = `ID #${wayangId}`; 

        for (let log of logs) {
            const msg = log.args.message || "";
            if (msg.includes(targetTag)) {
                count++;
            }
        }
        return count;

    } catch (e) {
        return 0; 
    }
}

// ==========================================
// 5. HELPER LAINNYA
// ==========================================
async function refreshUserBalance(address) {
    try {
        const walletProvider = new ethers.providers.Web3Provider(window.ethereum);
        const balanceBN = await walletProvider.getBalance(address);
        const ethVal = ethers.utils.formatEther(balanceBN);

        const elSaldo = document.getElementById("sawerUserBalance");
        if(elSaldo) {
            elSaldo.innerText = parseFloat(ethVal).toFixed(8) + " ETH";
            elSaldo.setAttribute('data-balance', ethVal);
        }
    } catch (e) { console.error(e); }
}

function toggleSawerModal(show) {
    const modal = document.getElementById("sawerModal");
    if(!modal) return;
    if(show) {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
    } else {
        modal.classList.remove("active");
        setTimeout(() => modal.style.display = "none", 300);
    }
}

function closeSawer(event) {
    if (event.target.id === "sawerModal") toggleSawerModal(false);
}
        
document.getElementById("year").innerText = new Date().getFullYear();
</script>
</body>
</html>
