<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda - Putramas Social Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* --- CSS UTAMA (GAYA SOSMED PREMIUM) --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f6f9ff; /* Warna background khas FB/Twitter */
            margin: 0; padding: 0;
            padding-bottom: 80px; /* Spacer untuk menu bawah */
            color: #1c1e21;
        }

        /* NAVBAR ATAS */
        .top-navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: #fff;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .brand { font-size:20px; color: #7385a5; font-weight:bold; }
        .brand-img { width: 45px; height: 45px;
            border-radius: 50%;
            border: 2px solid #7385a5;
            object-fit: cover; }
        
        .btn-connect {
            background: transparent; color: #7385a5; border: 2px solid #7385a5; 
            padding: 10px 25px; cursor: pointer; font-family: 'Rubik', sans-serif; 
            font-weight: bold; border-radius: 30px; transition: 0.3s; font-size: 14px;
        }
        .btn-connect.connected { background: #7385a5; color: #fff; border-color: #abb6c9; cursor: default }
        .btn-connect.hover { background: #f6f9ff; color: #7385a5; border: 2px solid #7385a5; }

        @media (max-width: 600px) {
            .top-navbar { padding: 15px 20px; }
            .brand { font-size: 0.9em; }
            .btn-connect { padding: 8px 15px; font-size: 12px; }
            h1 { font-size: 2em; }
        }
        
        
        /* CONTAINER UTAMA (Feed Tengah) */
.feed-container { 
    width: 100%;            /* Biar fleksibel mengikuti kolom Grid */
    max-width: 700px;       /* Lebar feed sedikit diperluas agar lega di PC */
    margin: 0;              /* Hapus 'auto' agar tidak lari ke tengah sendiri di PC */
    padding: 10px; 
}

/* Responsif: Di HP tetap ke tengah */
@media (max-width: 900px) {
    .feed-container {
        max-width: 600px;
        margin: 0 auto;     /* Kembali ke tengah saat mode HP */
    }
}
        /* --- 1. FITUR UPLOAD INSTAN (DROPDOWN) --- */
        .upload-trigger {
            background: #fff; padding: 15px; border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; gap: 10px; align-items: center; cursor: pointer;
            transition: background 0.2s;
        }
        .upload-trigger:active { background: #f2f2f2; }
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; background: none; object-fit: cover; }
        .fake-input {
            flex: 1; background: #f0f2f5; padding: 10px 15px; border-radius: 20px;
            color: #65676b; font-size: 14px;
        }
        
        /* FORM UPLOAD (TERSEMBUNYI) */
        /* --- PERBAIKAN CSS FORMULIR (SCROLLABLE) --- */

.upload-form-box {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    margin-bottom: 10px;
    
    /* Tambahan agar scroll halus */
    scrollbar-width: thin; 
    scrollbar-color: #ccc transparent;
}

.upload-form-box.open {
    /* Ubah tinggi maksimal jadi 80% layar HP (biar gak kepotong) */
    max-height: 75vh; 
    
    /* AKTIFKAN SCROLL JIKA KONTEN PANJANG */
    overflow-y: auto; 
    
    opacity: 1;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

/* Mempercantik Scrollbar (Opsional) */
.upload-form-box::-webkit-scrollbar { width: 5px; }
.upload-form-box::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
.upload-form-box::-webkit-scrollbar-track { background: transparent; }
        
        .form-card {
            background: #fff; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;
        }
        .preview-box {
            width: 100%; height: 180px; background: #fafafa; border: 2px dashed #ccc;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; overflow: hidden; position: relative; cursor: pointer;
        }
        .preview-box img { width: 35%; object-fit: cover; display: none; }
        .input-group { margin-bottom: 10px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .btn-post {
            width: 100%; background: #7385a5; color: #fff; padding: 12px;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .btn-post:disabled { background: #ccc; cursor: not-allowed; }

        /* --- 2. CARD FEED (TAMPILAN WAYANG) --- */
        .feed-card {
            background: #fff; border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 15px; overflow: hidden;
            animation: fadeIn 0.5s ease;
        }
        .card-header {
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-pic { width: 32px; height: 32px; border-radius: 50%; background: #eee; }
        .user-name { font-weight: 600; font-size: 14px; color: #050505; }
        .post-time { font-size: 11px; color: #65676b; }
        
        .card-image {
            width: 100%; min-height: 300px; background: #f0f2f5;
            display: flex; align-items: center; justify-content: center;
        }
        .card-image img { width: 100%; height: auto; display: block; }
        
        .card-content { padding: 12px 15px; }
        .wayang-title { font-size: 16px; font-weight: bold; margin: 0 0 5px 0; color: #4d4d4d; }
        .wayang-desc { font-size: 13px; color: #65676b; margin-bottom: 10px; }
        .tag-badge { 
            background: #e9f0ff; color: #7385a5; padding: 3px 8px; 
            border-radius: 4px; font-size: 11px; font-weight: 600; 
        }

        .card-actions {
            padding: 8px 15px; border-top: 1px solid #f0f2f5;
            display: flex; justify-content: space-between;
        }
        .action-btn {
            background: none; border: none; color: #65676b;
            font-size: 13px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; padding: 6px 0;
        }
        .action-btn:hover { color: #7385a5; }

        /* --- 3. NAVIGASI BAWAH (FACEBOOK STYLE) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: #fff; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 5000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;

    text-decoration: none;
    color: #666;
    font-size: 10px;
    width: 20%;

    background: none;
    border: none;
    padding: 6px 0;          /* sedikit ruang napas */
    cursor: pointer;

    transition:
        color 0.25s ease,
        transform 0.25s ease;
}

/* Icon */
.nav-link i {
    font-size: 22px;
    margin-bottom: 4px;

    transition:
        transform 0.25s ease,
        color 0.25s ease,
        filter 0.25s ease;
}

/* Hover: soft, elegan */
.nav-link:hover {
    color: #7385a5;
}

.nav-link:hover i {
    transform: translateY(-2px) scale(1.05);
    color: #7385a5;
    background: #e9f0ff;
    border-radius: 50px;
    border: 1px solid #7385a5;
    filter: drop-shadow(0 4px 8px rgba(115, 133, 165, 0.25));
}

/* Active (sedikit lebih tegas tapi tetap senada) */
.nav-link.active {
    color: #7385a5;
}

.nav-link.active i {
    transform: scale(1.08);
    filter: drop-shadow(0 6px 12px rgba(115, 133, 165, 0.35));
}

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Official Badge */
        .verified-badge { color: #1877f2; font-size: 12px; margin-left: 4px; }
        .verified-gold { color: #f1c40f; font-size: 12px; margin-left: 4px; }

        /* --- CSS TAMBAHAN UNTUK FORM LENGKAP --- */
fieldset {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 15px;
    background: #fafafa;
}
        
legend {
    font-size: 15px;
    font-weight: bold;
    color: #7385a5;
    padding: 4px 12px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
}
        
label {
    display: block;
    font-size: 10px;
    color: #555;
    margin-bottom: 4px;
    font-weight: 600;
    text-transform: uppercase;
}
/* Mempercantik Inputan */
.form-input, select, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 13px;
    margin-bottom: 10px;
    background: #fff;
    font-family: 'Rubik', sans-serif;
}
.form-input:focus { border-color: #7385a5; outline: none; }

        /* --- STYLE PENCARIAN GOOGLE --- */
.search-google-style {
    background: #fff;
    border-radius: 30px; /* Membulat ala Google */
    padding: 8px 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Bayangan halus */
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
}

.search-google-style:focus-within {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Bayangan menebal saat diketik */
    border-color: #dfe1e5;
}

.search-google-style input {
    flex: 1;
    border: none;
    padding: 10px;
    font-size: 15px;
    outline: none;
    color: #333;
    font-family: 'Rubik', sans-serif;
    background: transparent;
}

.search-icon-g { 
    color: #9aa0a6; 
    font-size: 18px; 
    margin-right: 10px; 
}

.search-clear-g { 
    color: #5f6368; 
    cursor: pointer; 
    font-size: 16px; 
    padding: 5px; 
    display: none; /* Sembunyi default */
    transition: color 0.2s;
}

.search-clear-g:hover { color: #333; }

        /* Efek hover pada header user */
.user-info:hover .user-name {
    text-decoration: underline;
    color: #1877f2; /* Warna biru link khas sosmed */
}

.user-info:hover .user-pic {
    filter: brightness(0.9);
}

        /* Layout Wrapper Utama */
.main-wrapper {
    display: flex;
    justify-content: center;
    gap: 30px;
    padding: 20px 5%;
}

/* Sidebar Samping (Default Sembunyi untuk HP) */
.sidebar-left, .sidebar-right {
    display: none; /* Sembunyikan di HP */
    width: 280px;
    position: sticky;
    top: 90px;
    height: fit-content;
}

/* Responsif: Mode PC (Layar Lebar) */
@media (min-width: 1100px) {
    .sidebar-left, .sidebar-right {
        display: block; /* Munculkan di PC */
    }

    .feed-container {
        max-width: 600px;
        margin: 0; /* Hilangkan auto margin agar tidak bergeser */
    }

    /* Sembunyikan Navigasi Bawah di PC karena sudah ada Navbar Atas/Sidebar */
    .bottom-nav {
        display: none !important;
    }
}

/* Style Item Sidebar Ala Facebook */
.sidebar-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 15px;
    transition: background 0.2s;
    color: #1c1e21;
}

.sidebar-item:hover {
    background: #e4e6eb;
}

.sidebar-item i {
    font-size: 20px;
    color: #7385a5;
    width: 24px;
    text-align: center;
}

.sidebar-label {
    padding: 10px 15px;
    font-size: 13px;
    font-weight: bold;
    color: #65676b;
    text-transform: uppercase;
}

.ad-card {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    margin-top: 10px;
}

.ad-card img {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 10px;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    font-size: 14px;
}

.status-online {
    width: 10px;
    height: 10px;
    background: #31a24c;
    border-radius: 50%;
}

/* Fix Navbar untuk PC agar center-aligned */
@media (min-width: 1100px) {
    .top-navbar {
        padding: 10px 15%; /* Lebih lebar ke tengah di PC */
    }
}

        /* Layout Wrapper: 2 Kolom (Sidebar 300px + Feed 1fr) */
.layout-wrapper { 
    display: grid; 
    grid-template-columns: 300px 1fr; 
    gap: 25px; 
    max-width: 1200px; 
    margin: 0 auto;
    padding: 20px 15px;
    align-items: start;
}

/* Sidebar Kiri Sticky di PC */
.sidebar-left {
    position: sticky;
    top: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Menu Card Sidebar */
.menu-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid rgba(115, 133, 165, 0.1);
}

.sidebar-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 18px;
    border-radius: 12px;
    text-decoration: none;
    color: #4b5563;
    font-weight: 500;
    margin-bottom: 5px;
    transition: all 0.25s;
}

.sidebar-item:hover, .sidebar-item.active {
    background: #f0f7ff;
    color: #7385a5;
    transform: translateX(5px);
}

.sidebar-item i { font-size: 20px; width: 25px; text-align: center; }

/* Wallet Mini Info Styling */
.wallet-mini-info {
    padding: 10px 5px;
    text-align: center;
}

.balance-display {
    font-size: 24px;
    font-weight: 800;
    color: #1c1e21;
    margin: 10px 0;
}

.address-short {
    font-family: monospace;
    font-size: 12px;
    color: #94a3b8;
    background: #f8fafc;
    padding: 5px;
    border-radius: 6px;
}

/* RESPONSIF: Atur Sembunyi/Muncul */
@media (max-width: 900px) {
    .layout-wrapper { grid-template-columns: 1fr; padding-bottom: 100px; }
    .sidebar-left { display: none !important; } /* Sembunyi di HP */
    .bottom-nav { display: flex !important; }   /* Muncul di HP */
}

@media (min-width: 901px) {
    .bottom-nav { display: none !important; }   /* Sembunyi di PC */
}

        .upload-form-box.open {
    max-height: 80vh; /* Agar tetap bisa di-scroll di dalam area feed */
    overflow-y: auto;
        }

/* 1. Overlay Transparan (Hanya untuk deteksi klik luar) */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: transparent; /* Tidak ada warna/blur */
    backdrop-filter: none;
    z-index: 9998;
    display: none;
    /* Ubah dari flex ke block agar kita bisa atur posisi absolute manual */
    display: none; 
}

.modal-overlay.active {
    display: block; 
}

/* 2. Kartu Modal (Menjadi Dropdown) */
.modal-card {
    position: absolute; /* Kunci posisi */
    
    /* ATUR POSISI DISINI SESUAI TINGGI NAVBAR ANDA */
    top: 70px;  /* Jarak dari atas (sesuaikan dengan tinggi navbar) */
    right: 20px; /* Jarak dari kanan (supaya lurus dengan tombol connect) */
    
    width: 300px; /* Lebar fix agar rapi */
    background: #fff;
    padding: 20px;
    border-radius: 12px; /* Radius lebih kecil ala dropdown */
    
    /* Shadow Premium Soft */
    box-shadow: 0 5px 30px rgba(0,0,0,0.15); 
    border: 1px solid rgba(0,0,0,0.05); /* Border tipis halus */
    
    text-align: center;
    font-family: 'Rubik', sans-serif;
    
    /* Animasi Muncul dari atas */
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    transform-origin: top right; /* Animasi mulai dari pojok kanan atas */
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* State Aktif */
.modal-overlay.active .modal-card {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* (Opsional) Segitiga Kecil Penunjuk ke Atas (Arrow) */
.modal-card::before {
    content: "";
    position: absolute;
    top: -6px; /* Muncul di atas kotak */
    right: 20px; /* Posisi sejajar tombol */
    width: 12px;
    height: 12px;
    background: #fff;
    transform: rotate(45deg); /* Putar jadi wajik */
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
    box-shadow: -2px -2px 5px rgba(0,0,0,0.02);
}
    
/* Header */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.modal-header h3 { margin: 0; font-size: 18px; color: #333; }
.close-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }

/* Status Badge & Dot Kelap Kelip */
.modal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.status-badge {
    color: #27ae60;
    font-weight: bold;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-label { color: #888; }
    
.pulse-dot {
    width: 8px; height: 8px;
    background-color: #27ae60;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(39, 174, 96, 0.4);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(39, 174, 96, 0); }
    100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
}

/* Saldo */
.modal-balance { margin-bottom: 20px; }
.balance-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
.balance-amount { font-size: 24px; font-weight: bold; color: #2c3e50; margin-top: 5px; }

/* Address Box (Copyable) */
.modal-address-box {
    background: #f1f2f6;
    padding: 12px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    margin-bottom: 25px;
}
.modal-address-box:hover { border-color: #3498db; background: #eaf6ff; }
.address-text { font-family: monospace; font-size: 14px; color: #555; }
.copy-icon { color: #3498db; }

/* Tombol Aksi */
.modal-actions { display: flex; flex-direction: column; gap: 10px; }
.action-btn {
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    transition: transform 0.1s;
}
.action-btn:active { transform: scale(0.98); }
.action-btn.primary { background: #7385a5; color: white; }
.action-btn.danger { background: #fee; color: #e74c3c; border: 1px solid #fcc; }

.footer {
            background: #fff;
            padding: 20px 20px;
            margin-top: 25px;
            text-align: center;
            width: 100%; /* WAJIB FULL */
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .social-icons { margin-bottom: 10px; }
        
        .social-link {
            display: inline-flex; justify-content: center; align-items: center;
            width: 35px; height: 35px; margin: 0 07px;
            border-radius: 50%; background: #7385a5; color: #fff;
            font-size: 15px; transition: all 0.3s ease; border: 1.5px solid #7385a5;
            text-decoration: none;
        }
        .social-link:hover {
            background: #fff; color: #7385a5;
            transform: translateY(-5px); box-shadow: 0 0 15px #7385a5;
        }

        .copyright { color: #888; font-size: 13px; letter-spacing: 1px; margin-top: 10px; }

    </style>
</head>
<body>

<nav class="top-navbar">
    <div class="brand">
        <a href="index" style="display: flex; align-items: center; text-decoration: none;">
            <img src="img/icon-192.png" class="brand-img" style="margin-right:8px;">
            <span class="brand" style="font-size:20px; color: #7385a5; font-weight:bold;">Beranda</span>
        </a>
    </div>
    <button class="btn-connect" id="btnConnect" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> Hubungkan
    </button>
</nav>

<div class="layout-wrapper">
    <aside class="sidebar-left">
        <div class="menu-card">
            <div class="sidebar-label">Navigasi Utama</div>
            <a href="index" class="sidebar-item active">
                <i class="fas fa-globe-asia"></i> <span>Beranda</span>
            </a>
            <a href="galeri" class="sidebar-item">
                <i class="fa fa-university"></i> <span>Galeri</span>
            </a>
            <a href="profile" class="sidebar-item">
                <i class="fas fa-user"></i> <span>Profile</span>
            </a>
            <div class="sidebar-item" onclick="window.scrollTo(0,0); toggleForm();" style="cursor:pointer;">
                <i class="fa fa-cloud-upload"></i> <span>Upload Koleksi</span>
            </div>
        </div>

        <div class="menu-card" style="margin-top: 20px;">
            <div class="sidebar-label">Dompet Digital</div>
            <div class="wallet-mini-info">
                <div class="status-pill">
                    <span class="pulse-dot"></span> <span id="networkName">Base Mainnet</span>
                </div>
                <div class="balance-display">
                    <span id="userBalance">0.0000</span> <small>ETH</small>
                </div>
                <div class="address-short" id="userAddrMini">0x...</div>
            </div>
        </div>
    </aside>

<main class="main-feed">
    <div class="search-google-style">
        <i class="fas fa-search search-icon-g"></i>
        <input type="text" id="searchInput" placeholder="Telusuri Wayang..." onkeyup="smartSearch(this.value)">
        <i class="fas fa-times search-clear-g" id="clearBtn" onclick="clearSearch()"></i>
    </div>

    <div class="upload-trigger" onclick="toggleForm()">
        <img src="img/ps-logo.png" class="my-avatar">
        <div class="fake-input">Apa wayang terbaru Anda? Upload sekarang...</div>
        <i class="fas fa-images" style="color: #45bd62; font-size: 20px;"></i>
    </div>

    <div class="upload-form-box" id="uploadBox">
        <div class="form-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0; color:#2c3e50;">Detail Wayang Lengkap</h3>
                <button onclick="toggleForm()" style="background:none; border:none; cursor:pointer; color:#e74c3c;">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <fieldset>
                <legend><i class="fas fa-id-card"></i> Identitas Utama</legend>
                <div class="preview-box" onclick="document.getElementById('fileUpload').click()">
                    <img id="imgPreview">
                    <div id="textPreview" style="text-align:center; color:#aaa;">
                        <i class="fas fa-cloud-upload-alt" style="font-size:24px;"></i><br>Klik pilih foto
                    </div>
                </div>
                <input type="file" id="fileUpload" hidden onchange="previewImage()">
                    
                <label>Nama Tokoh:</label>
                <input type="text" id="inputNama" class="form-input" placeholder="Contoh: Arjuna">
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Golongan:</label>
                        <select id="inputGolongan">
                            <option value="Satria">Satria</option>
                            <option value="Dewa">Dewa</option>
                            <option value="Yaksa">Yaksa</option>
                            <option value="Wanara">Wanara</option>
                            <option value="Panakawan">Panakawan</option>
                            <option value="Kayon">Kayon</option>
                            <option value="Bambangan">Bambangan</option>
                            <option value="Punggawa">Punggawa</option>
                            <option value="Krodan">Krodan</option>
                            <option value="Resi">Resi</option>
                            <option value="Putren">Putren</option>
                            <option value="Buta Kiwe">Buta Kiwe</option>
                            <option value="Sato">Sato</option>
                            <option value="Gaman">Gaman</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>Gaya:</label>
                        <select id="inputGaya">
                            <option value="Bali">Bali</option>
                    <option value="Banjar">Banjar</option>
                    <option value="Banyumas">Banyumas</option>
                    <option value="Cirebon">Cirebon</option>
                    <option value="Jawa Barat">Golek Sunda</option>
                    <option value="Jawa Timur">Jawa Timur</option>
                    <option value="Kedu">Kedu</option>
                    <option value="Kontemporer">Kontemporer</option>
                    <option value="Kreasi">Kreasi</option>
                    <option value="Lombok">Lombok</option>
                    <option value="Surakarta">Surakarta</option>
                    <option value="Yogyakarta">Yogyakarta</option>
                    <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend><i class="fas fa-ruler-combined"></i> Detail Fisik</legend>
                <label>Wanda (Ekspresi):</label>
                <input type="text" id="inputWanda" class="form-input" placeholder="-">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Material Kulit:</label><input type="text" id="inputKulit" class="form-input" placeholder="Kerbau"></div>
                    <div style="flex:1"><label>Material Gapit:</label><input type="text" id="inputGapit" class="form-input" placeholder="Tanduk"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Penatah:</label><input type="text" id="inputPenatah" class="form-input" placeholder="-"></div>
                    <div style="flex:1"><label>Penyungging:</label><input type="text" id="inputPenyungging" class="form-input" placeholder="-"></div>
                </div>
            </fieldset>

            <fieldset>
                <legend><i class="fas fa-users"></i> Silsilah & Asal</legend>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label>Ayah:</label><input type="text" id="inputAyah" class="form-input"></div>
                    <div style="flex: 1;"><label>Ibu:</label><input type="text" id="inputIbu" class="form-input"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>Negara:</label><input type="text" id="inputNegara" class="form-input"></div>
                    <div style="flex:1;"><label>Pusaka:</label><input type="text" id="inputPusaka" class="form-input"></div>
                </div>
            </fieldset>

            <fieldset>
                <legend><i class="fas fa-book-open"></i>  Cerita</legend>
                <label>Deskripsi:</label>
                <textarea id="inputDeskripsi" class="form-input" rows="3" placeholder="Ceritakan sejarah atau filosofinya..."></textarea>
            </fieldset>

            <button class="btn-post" id="btnSubmit" onclick="uploadWayang()">
                <i class="fas fa-paper-plane"></i> Posting
            </button>
        </div>
    </div>
    
    <div id="feedContent">
        <div style="text-align:center; padding:40px; color:#aaa;">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat...
        </div>
    </div>
</main>

<div id="walletModal" class="modal-overlay" onclick="closeWalletModal(event)">
    <div class="modal-card">
        <div class="modal-header">
            <h3><i class="fas fa-wallet" style="color:#7385a5;"></i> Wallet Info</h3>
            <button class="close-btn" onclick="toggleWalletModal()"><i class="fas fa-times"></i></button>
        </div>

        <div class="modal-status">
            <span class="status-label">Status:</span>
            <div class="status-badge">
                <span class="pulse-dot"></span> Terhubung Base Network
            </div>
        </div>

        <div class="modal-balance">
            <div class="balance-label">Saldo Dompet Utama</div>
            <div class="balance-amount" id="modalBalance">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>

            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #d1d9e6;">
                <div class="balance-label" style="color:#888;">
                    <i class="fas fa-gift"></i> Total Pendapatan Dukungan
                </div>
                <div class="balance-amount" id="modalTipBalance" style="font-size: 18px; color: #7385a5;">
                    0.0000 ETH
                </div>
            </div>
        </div>

        <div class="modal-address-box" onclick="copyAddress()">
            <div class="address-text">
                <span id="modalFullAddress" style="display:none;"></span> 
                <span id="modalShortAddress">0x...</span>
            </div>
            <i class="far fa-copy copy-icon"></i>
        </div>

        <div class="modal-history-section">
            <h4 style="font-size:12px; color:#7385a5; margin:0 0 8px 0; display:flex; justify-content:space-between;">
                <span><i class="fas fa-history"></i> Riwayat Masuk</span>
                <span id="modalTipCountBadge" style="background:#eee; padding:2px 6px; border-radius:10px; font-size:10px;">0</span>
            </h4>
            
            <div id="modalHistoryList" class="history-scroll-area">
                <p style="text-align:center; font-size:11px; color:#aaa; margin-top:10px;">Belum ada riwayat.</p>
            </div>

            <button id="btnModalLoadMore" onclick="loadNextModalTips()" style="display:none; width:100%; margin-top:5px; background:none; border:1px dashed #7385a5; color:#7385a5; font-size:10px; padding:5px; cursor:pointer; border-radius:5px;">
                Muat 2 Lama <i class="fas fa-chevron-down"></i>
            </button>
        </div>

        <button class="action-btn danger" onclick="disconnectWallet()" style="width: 100%;">
                <i class="fas fa-sign-out-alt"></i> Putuskan Koneksi
        </button>

        <div class="modal-actions" style="margin-top: 15px; text-align: center;">
            <div class="social-icons" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 15px;">
                <a href="https://youtube.com/@PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-youtube"></i></a>
                <a href="https://instagram.com/putramas_official" target="_blank" class="social-link"><i class="fab fa-instagram"></i></a>
                <a href="https://facebook.com/PutramasOfficial" target="_blank" class="social-link"><i class="fab fa-facebook-f"></i></a>
                <a href="https://opensea.io/collection/putramas-nusantara-shadows-archive" target="_blank" class="social-link"><i class="fa fa-shopping-cart"></i></a>
            </div>
            
            <p class="copyright" style="font-size: 10px; color: #94a3b8; margin-top: 15px;">
                &copy; <span id="year"></span> Powered By <strong>Putramas Official</strong>
            </p>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <a href="index" class="nav-link active"><i class="fas fa-globe-asia"></i><span>Beranda</span></a>
    <a href="galeri" class="nav-link"><i class="fa fa-university"></i><span>Galeri</span></a>
    <a href="profile" class="nav-link"><i class="fas fa-user"></i><span>Profile</span></a>
    <button class="nav-link" onclick="window.scrollTo(0,0); toggleForm();">
        <i class="fa fa-cloud-upload"></i><span>Upload</span>
    </button>
</nav>
    
    <script>
const CHAIN_ID_DECIMAL = 8453; // ID Base Mainnet
const CHAIN_ID_BASE = "0x2105"; // Hex ID Base Mainnet
const BASE_RPC_URL = "https://base-rpc.publicnode.com"; // RPC Resmi
        
const BASE_MAINNET_CONFIG = {
    chainId: CHAIN_ID_BASE,
    chainName: 'Base',
    nativeCurrency: {
        name: 'Ethereum',
        symbol: 'ETH',
        decimals: 18
    },
    rpcUrls: ['https://base-rpc.publicnode.com'], // RPC Resmi
    blockExplorerUrls: ['https://basescan.org']
};
        
        const CONTRACT_ADDRESS = "0x72359F776Ac4B44c6c79dBF805D79959515E0c58"; 
        const OFFICIAL_WALLET = "0xBAcc1F6e717bF03dB0c40E3044DA47318C369B70";
        // ABI Minimal untuk Read Data + Upload
        const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"FeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"RevisionFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"TipSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"},{"indexed":false,"internalType":"bool","name":"isOfficial","type":"bool"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[],"name":"MAX_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_TIP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct WayangArsipPutramas.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getTipByIndex","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"message","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct WayangArsipPutramas.TipRecord","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTipCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getTipTotalBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicMintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiWayang","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"revisionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_receiver","type":"address"},{"internalType":"string","name":"_message","type":"string"}],"name":"sendTip","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newFee","type":"uint256"}],"name":"setRevisionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTipsGrand","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"uploadPublik","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isOfficial","type":"bool"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
        
        const PINATA_API_KEY = "d209d53257fcc57219af";    
const PINATA_SECRET_KEY = "c65d0f4b9de3d144cbb09da6394b2f8dd690e09a9a7b1533d465b541350e7c0d";

        const PINATA_GATEWAY = "https://magenta-secondary-guan-686.mypinata.cloud/ipfs/";
        let provider, contractReader, signer;
        let feedData = [];
        // --- VARIABEL TAMBAHAN ---
let globalSearchIndex = []; // Buku telepon (Index) semua wayang
const INDEX_STORAGE_KEY = "WAYANG_INDEX_FULL_V1";
        let currentSearchTicket = 0;
        let isWalletConnected = false;
        let modalTipCursor = 0;      // Penanda index untuk modal
let modalUserAddr = null;    // Alamat user yang sedang login
let isModalFetching = false; // Kunci

        // --- INIT ---
        window.onload = async () => {
            // Setup Read Provider (Tanpa Wallet)
            const rpc = new ethers.providers.JsonRpcProvider("https://1rpc.io/base");
            contractReader = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpc);
            
            // Cek Login
            if(window.ethereum) {
        try {
            const web3 = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await web3.listAccounts();
            
            if(accounts.length > 0) {
                const btn = document.getElementById("btnConnect"); // Pastikan ID ini sesuai HTML
                if(btn) {
                    btn.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
                    btn.classList.add("connected");
                    isWalletConnected = true;
                    
                    // Update data modal di background
                    updateModalWalletData(accounts[0]);
                }
            }
        } catch(e) { console.log("Auto-login skip:", e); }
            }

            // Load Feed
            loadFeed();
            setTimeout(initDeepIndexer, 3000);
        };

async function connectWallet() {
    // A. Validasi Metamask
    if (!window.ethereum) return alert("Metamask tidak terdeteksi!");
    
    const btnConnect = document.getElementById("btnConnect");
    
    // B. LOGIKA TOGGLE: Jika sudah konek, klik tombol = BUKA MODAL
    if (isWalletConnected || (btnConnect && btnConnect.classList.contains("connected"))) {
        toggleWalletModal(); 
        return;
    }

    // C. PROSES KONEKSI BARU
    const originalText = btnConnect.innerHTML;
    btnConnect.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Loading...`;

    try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // 1. Request Akun
        await provider.send("eth_requestAccounts", []);

        // 2. Cek Network (Wajib Base Mainnet)
        const network = await provider.getNetwork();
        if (network.chainId !== CHAIN_ID_DECIMAL) {
            await switchNetwork(); // Paksa ganti network
            // Setelah ganti, provider perlu direfresh, jadi reload atau rekursif
            connectWallet(); 
            return; 
        }

        // 3. Ambil Data User
        const signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        
        // 4. Update Tampilan Tombol
        btnConnect.innerHTML = `<i class="fas fa-wallet"></i> Info Profile`;
        btnConnect.classList.add("connected");
        isWalletConnected = true; // Set flag global

        // 5. Update Data Modal (Saldo, Address, dll)
        document.getElementById("modalFullAddress").innerText = userAddress;
        document.getElementById("modalShortAddress").innerText = userAddress.substring(0, 6) + "..." + userAddress.slice(-4);
        
        const balance = await provider.getBalance(userAddress);
        document.getElementById("modalBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(8) + " ETH";
        
        // 6. Tarik Data History dari Kontrak
        await updateModalWalletData(userAddress);

    } catch (err) { 
        console.error("Koneksi Error:", err);
        btnConnect.innerHTML = originalText;
        // alert("Gagal: " + err.message);
    }
}

async function switchNetwork() {
    try {
        // Coba perintah ganti network
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CHAIN_ID_BASE }],
        });
    } catch (switchError) {
        // Kode 4902 artinya Network Belum Ada di Metamask User
        if (switchError.code === 4902) {
            try {
                // Perintah pasang RPC otomatis
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [BASE_MAINNET_CONFIG],
                });
            } catch (addError) {
                console.error("User menolak pasang RPC Base:", addError);
                throw addError;
            }
        } else {
            console.error("Gagal ganti network:", switchError);
            throw switchError;
        }
    }
}

    // Fungsi Buka/Tutup Modal
function toggleWalletModal() {
    const modal = document.getElementById("walletModal");
    if (modal.classList.contains("active")) {
        modal.classList.remove("active");
        setTimeout(() => modal.style.display = "none", 300);
    } else {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
        if (typeof userAddress !== 'undefined' && userAddress) {
            updateModalWalletData(userAddress);
        }
    }
}

// Fungsi Tutup jika klik area gelap
function closeWalletModal(e) {
    if (e.target.id === "walletModal") toggleWalletModal();
}

// Fungsi Copy Address
function copyAddress() {
    const fullAddress = document.getElementById("modalFullAddress").innerText;
    navigator.clipboard.writeText(fullAddress).then(() => {
        showToast("Alamat Wallet disalin!", 'success'); // Atau ubah icon ceklis
    });
}

// Fungsi Disconnect (Reset UI)
function disconnectWallet() {
    userAddress = null;
    signer = null;
    
    const btn = document.getElementById("btn-connect");
    btn.innerHTML = `<i class="fas fa-wallet"></i> Hubungkan`;
    btn.classList.remove("connected");
    
    toggleWalletModal();
    window.location.reload(); // Refresh halaman agar bersih
}

// 1. FUNGSI UPDATE DATA MODAL (Panggil ini saat Toggle Modal / Connect)
async function updateModalWalletData(userAddress) {
    if(!userAddress) return;
    modalUserAddr = userAddress;

    // Reset UI
    document.getElementById("modalHistoryList").innerHTML = `<div style="text-align:center; padding:10px;"><i class="fas fa-spinner fa-spin"></i></div>`;
    document.getElementById("btnModalLoadMore").style.display = 'none';

    try {
        const rpcProvider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, rpcProvider);

        // A. AMBIL TOTAL PENDAPATAN (getTipTotalBalance)
        const totalWei = await contract.getTipTotalBalance(userAddress);
        const totalEth = parseFloat(ethers.utils.formatEther(totalWei)).toFixed(8);
        document.getElementById("modalTipBalance").innerText = totalEth + " ETH";

        // B. AMBIL JUMLAH HISTORY (getTipCount)
        const countBN = await contract.getTipCount(userAddress);
        const count = parseInt(countBN);
        document.getElementById("modalTipCountBadge").innerText = count;

        if (count === 0) {
            document.getElementById("modalHistoryList").innerHTML = `<p style="text-align:center; font-size:11px; color:#aaa; margin-top:10px;">Belum ada riwayat masuk.</p>`;
            return;
        }

        // C. SIAPKAN BATCH PERTAMA (Reverse Order)
        modalTipCursor = count - 1; // Mulai dari yang terbaru
        document.getElementById("modalHistoryList").innerHTML = ""; // Bersihkan loader
        
        await loadNextModalTips(); // Load 5 pertama

    } catch (e) {
        console.error("Gagal update modal data:", e);
    }
}

// 2. FUNGSI LOAD BATCH MODAL (5 Item per klik)
async function loadNextModalTips() {
    if(isModalFetching || modalTipCursor < 0) return;
    
    isModalFetching = true;
    const container = document.getElementById("modalHistoryList");
    const btnMore = document.getElementById("btnModalLoadMore");
    
    // Matikan tombol sementara
    if(btnMore) btnMore.innerHTML = "Memuat...";

    const rpcProvider = new ethers.providers.JsonRpcProvider(BASE_RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, rpcProvider);

    // Hitung mundur 5 langkah
    let end = modalTipCursor - 3 + 1;
    if(end < 0) end = 0;

    let html = "";

    for (let i = modalTipCursor; i >= end; i--) {
        try {
            const tip = await contract.getTipByIndex(modalUserAddr, i);
            
            // Format Data
            const senderShort = tip.sender.substring(0,4) + ".." + tip.sender.substring(38);
            const amount = parseFloat(ethers.utils.formatEther(tip.amount)).toFixed(6);
            const msg = tip.message || "Tanpa pesan";

            html += `
            <div class="mini-history-item">
                <div>
                    <div class="mini-sender"><i class="fas fa-user-circle"></i> ${senderShort}</div>
                    <span class="mini-msg">"${msg}"</span>
                </div>
                <div class="mini-amount">+${amount} ETH</div>
            </div>`;
        } catch (e) {}
    }

    // Append (Tempel ke bawah)
    container.insertAdjacentHTML('beforeend', html);

    // Update Status
    modalTipCursor = end - 1;
    isModalFetching = false;

    // Cek Tombol Load More
    if(btnMore) {
        if(modalTipCursor >= 0) {
            btnMore.style.display = 'block';
            btnMore.innerHTML = `Muat 3 Lagi <i class="fas fa-chevron-down"></i>`;
        } else {
            btnMore.style.display = 'none'; // Data habis
        }
    }
}

        // --- PENCARIAN AGRESIF (DEEP SEARCH) ---
async function smartSearch(query) {
    const clearBtn = document.getElementById("clearBtn");
    const container = document.getElementById("feedContent");
    
    // Tiket pencarian baru
    currentSearchTicket++;
    const myTicket = currentSearchTicket;

    if (query.length === 0) {
        clearBtn.style.display = "none";
        container.innerHTML = "";
        loadFeed(); // Kembali ke feed awal
        return;
    }

    clearBtn.style.display = "block";
    query = query.toLowerCase().trim();

    // Tampilkan Loading
    container.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;"><i class="fas fa-circle-notch fa-spin"></i> Mencari...</div>`;

    // 1. FILTER UNIK dari Index
    // Kita filter dulu ID-nya agar tidak ada ID yang sama masuk ke proses render
    const matchedItems = globalSearchIndex.filter(item => 
        item.nama.includes(query) || 
        (item.id.toString() === query)
    );

    // Ambil ID Unik
    const uniqueMatchedIds = [...new Set(matchedItems.map(item => item.id))];

    // Jika tidak ada hasil
    if (uniqueMatchedIds.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#aaa;">Tidak ditemukan "${query}"</div>`;
        return;
    }

    // 2. RENDER HASIL
    container.innerHTML = ""; // Bersihkan loading
    
    // Ambil maksimal 10 hasil teratas untuk performa
    const targetIds = uniqueMatchedIds.slice(0, 10);

    for (let id of targetIds) {
        // Cek apakah tiket masih valid (user belum mengetik huruf baru)
        if (myTicket !== currentSearchTicket) return; 
        await renderCard(id, container);
    }
}

function clearSearch() {
    document.getElementById("searchInput").value = "";
    smartSearch(""); 
}

        
        // --- LOGIKA FEED (GABUNGAN SEMUA DATA) ---
        async function loadFeed() {
    const container = document.getElementById("feedContent");
    const golongans = ['Satria', 'Dewa', 'Yaksa', 'Wanara', 'Panakawan', 'Kayon', 'Bambangan', 'Punggawa', 'Krodan', 'Resi', 'Putren', 'Buta Kiwe', 'Sato', 'Gaman'];

    try {
        // Parallel Fetch ID dari semua golongan
        const results = await Promise.all(golongans.map(gol => contractReader.getIdsByGolongan(gol)));
        
        // MENGHILANGKAN DUPLIKAT SEJAK AWAL
        let allIds = results.flat().map(id => parseInt(id));
        const finalUniqueIds = [...new Set(allIds)].sort((a, b) => b - a);

        const feedIds = finalUniqueIds.slice(0, 15); // Ambil 15 terbaru saja agar cepat

        if(feedIds.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding:20px;'>Belum ada postingan.</p>";
            return;
        }

        container.innerHTML = ""; 

        // Render satu per satu secara sekuensial agar urutan terjaga
        for(let id of feedIds) {
            await renderCard(id, container);
        }

    } catch(e) {
        console.error(e);
        container.innerHTML = "<p style='color:red; text-align:center;'>Gagal memuat feed.</p>";
    }
        }

        async function renderCard(id, container) {
    // Mencegah duplikasi visual: Cek apakah ID ini sudah dirender di layar
    if (document.getElementById(`card-${id}`)) return;

    try {
        const [info, uri, owner, likes] = await Promise.all([
            contractReader.getInfoWayang(id),
            contractReader.tokenURI(id),
            contractReader.ownerOf(id),
            contractReader.totalLikes(id)
        ]);

        if(!info.isActive) return;

        let imgUrl = "img/loading-placeholder.gif"; // Gunakan placeholder lokal
        try {
            const jsonUrl = uri.replace("ipfs://", PINATA_GATEWAY);
            const res = await axios.get(jsonUrl, { timeout: 5000 });
            const rawImg = res.data.image || res.data.image_url;
            imgUrl = rawImg.replace("ipfs://", PINATA_GATEWAY);
            imgUrl = `https://wsrv.nl/?url=${encodeURIComponent(imgUrl)}&w=500&q=75&output=webp`;
        } catch(e) {
            console.warn("Gagal ambil metadata/gambar untuk ID:", id);
        }

        // 1. Cek apakah wallet adalah Official
const isOfficial = (owner.toLowerCase() === OFFICIAL_WALLET.toLowerCase());

// 2. Tentukan Badge (Verified Gold untuk Official)
const badge = isOfficial 
    ? `<i class="fas fa-check-circle verified-gold" title="Official"></i>` 
    : `<i class="fas fa-check-circle verified-badge" title="Verified Creator"></i>`;

// 3. Tentukan Nama Pengirim
const senderName = isOfficial ? "Putramas Official" : owner.substring(0,6) + "..." + owner.slice(-4);
const profileUrl = `profile?address=${owner}`;
// 4. LOGIKA CUSTOM AVATAR: Gunakan Logo Resmi jika Official
const avatar = isOfficial 
    ? "img/icon-192.png" // Path logo resmi Anda
    : `https://api.dicebear.com/7.x/identicon/svg?seed=${owner}`; // Avatar random untuk user biasa
        // Tambahkan ID pada div terluar kartu: id="card-${id}"
        const html = `
                <div class="feed-card" id="card-${id}">
    <div class="card-header">
        <a href="${profileUrl}" class="user-info" style="text-decoration: none; display: flex; align-items: center; gap: 10px;">
            <img src="${avatar}" class="user-pic" alt="Avatar">
            <div>
                <div class="user-name" style="color: #7385a5;">${senderName} ${badge}</div>
                <div class="post-time">${new Date(info.timestamp * 1000).toLocaleDateString()}  ID #${id}</div>
            </div>
        </a>
<i class="fas fa-edit" 
   style="color:#d35400; cursor: pointer; font-size:16px;" 
   onclick="event.stopPropagation(); window.location.href='revisi?id=${id}'" 
   title="Revisi Data">
</i>
    </div>
    
    <div class="card-content">
        <h3 class="wayang-title">${info.nama}</h3>
        <div class="wayang-desc">
            Wayang golongan <span class="tag-badge">${info.golongan}</span> 
            gaya <span class="tag-badge">${info.gaya}</span>
        </div>
    </div>
                    <div class="card-image" onclick="window.location.href='detail?id=${id}'" style="cursor:pointer;">
                        <img src="${imgUrl}" loading="lazy">
                    </div>

                    <div class="card-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); kirimLike('${id}', this)">
                        <i class="fas fa-heart"></i> ${likes} Suka</button>
                        <button class="action-btn"><i class="fa fa-gift"></i> Dukung</button>
                        <button class="action-btn"><i class="fa fa-star"></i> Ulasan</button>
                        <button class="action-btn" onclick="event.stopPropagation(); shareWayang('${id}', '${info.nama}')">
                        <i class="fas fa-share-alt"></i> Bagikan</button>
                    </div>
                </div>`;

        container.insertAdjacentHTML('beforeend', html);
    } catch(e) { 
        console.log("Gagal render kartu ID", id); 
    }
        }

        // --- DEEP INDEXER (JALAN DI BACKGROUND - ANTI DUPLIKAT) ---
async function initDeepIndexer() {
    // 1. Load index lama dari storage agar crawling lebih cepat
    const cachedIndex = localStorage.getItem(INDEX_STORAGE_KEY);
    if (cachedIndex) {
        globalSearchIndex = JSON.parse(cachedIndex);
        console.log(" Index awal dimuat:", globalSearchIndex.length, "items");
    }

    const golongans = ['Satria', 'Dewa', 'Yaksa', 'Wanara', 'Panakawan', 'Kayon', 'Bambangan', 'Punggawa', 'Krodan', 'Resi', 'Putren', 'Buta Kiwe', 'Sato', 'Gaman'];
    let tempIndex = [...globalSearchIndex]; // Mulai dengan data yang sudah ada

    // 2. Crawling Data Baru secara Paralel
    for (const gol of golongans) {
        try {
            const ids = await contractReader.getIdsByGolongan(gol);
            
            const promises = ids.map(async (idBig) => {
                const id = parseInt(idBig);
                
                // Cek apakah ID sudah ada di index? Kalau sudah, tidak perlu fetch lagi
                if (tempIndex.some(x => x.id === id)) return;

                try {
                    const info = await contractReader.getInfoWayang(id);
                    if (info.isActive) {
                        tempIndex.push({
                            id: id,
                            nama: info.nama.toLowerCase(),
                            golongan: info.golongan,
                            gaya: info.gaya
                        });
                    }
                } catch (e) {}
            });
            
            await Promise.all(promises);
        } catch (e) {}
    }

    // 3. PEMBERSIHAN DUPLIKAT FINAL (Penting!)
    // Kita gunakan Map untuk memastikan satu ID hanya punya satu entri data
    const uniqueIndex = Array.from(new Map(tempIndex.map(item => [item.id, item])).values());
    
    // Sortir terbaru di atas (ID Besar ke Kecil)
    globalSearchIndex = uniqueIndex.sort((a, b) => b.id - a.id);

    // 4. Simpan ke HP hanya data yang sudah unik dan rapi
    if (globalSearchIndex.length > 0) {
        localStorage.setItem(INDEX_STORAGE_KEY, JSON.stringify(globalSearchIndex));
        console.log(" Deep Index Sinkron:", globalSearchIndex.length, "items unik");
    }
}

// --- FUNGSI UPLOAD UTAMA ---
async function uploadWayang() {
    const btn = document.getElementById("btnSubmit");
    
    // 1. PERBAIKAN ID DISINI (Sesuaikan dengan HTML)
    const nama = document.getElementById("inputNama").value;
    const gol = document.getElementById("inputGolongan").value; // Dulu inputGol
    const gaya = document.getElementById("inputGaya").value;
    const fileInput = document.getElementById("fileUpload");    // Dulu inputGambar
    const deskripsi = document.getElementById("inputDeskripsi").value || "Koleksi Wayang Nusantara";

    // 2. Validasi
    if (!window.ethereum) return alert("Wajib install Metamask!");
    if (!nama || fileInput.files.length === 0) {
        return alert("Nama Tokoh dan Foto WAJIB diisi!");
    }

    try {
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> 1/4 Mempores Gambar...`;

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        // --- STAGE 1: KOMPRESI ---
        const compressedFile = await compressImage(fileInput.files[0], 300);

        // --- STAGE 2: IPFS GAMBAR ---
        btn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> 2/4 Mengupload Foto...`;
        const imgUrl = await uploadToIPFS(compressedFile);

        // --- STAGE 3: METADATA LENGKAP ---
        btn.innerHTML = `<i class="fas fa-file-alt"></i> 3/4 Mempores Metadata...`;

        const metadata = {
            name: nama,
            description: deskripsi,
            image: imgUrl,
            attributes: [
                // Identitas
                { trait_type: "Golongan", value: gol },
                { trait_type: "Gaya", value: gaya },
                // Fisik (Menggunakan helper getVal)
                { trait_type: "Wanda", value: getVal("inputWanda") },
                { trait_type: "Material Kulit", value: getVal("inputKulit") },
                { trait_type: "Material Gapit", value: getVal("inputGapit") },
                { trait_type: "Penatah", value: getVal("inputPenatah") },
                { trait_type: "Penyungging", value: getVal("inputPenyungging") },
                { trait_type: "Tahun Pembuatan", value: getVal("inputTahun") },
                { trait_type: "Kolektor", value: getVal("inputKolektor") },
                // Silsilah
                { trait_type: "Ayah", value: getVal("inputAyah") },
                { trait_type: "Ibu", value: getVal("inputIbu") },
                { trait_type: "Negara", value: getVal("inputNegara") },
                { trait_type: "Pusaka", value: getVal("inputPusaka") },
                // System
                { trait_type: "Creator", value: userAddress },
                { trait_type: "Type", value: "Full Metadata Upload" }
            ]
        };

        const tokenURI = await uploadJSON(metadata);

        // --- STAGE 4: BLOCKCHAIN ---
        btn.innerHTML = `<i class="fas fa-signature"></i> 4/4 Konfirmasi Wallet...`;
        
        const fee = await contract.publicMintFee();
        const tx = await contract.uploadPublik(tokenURI, nama, gol, gaya, { value: fee });
        
        btn.innerHTML = `<i class="fas fa-cog fa-spin"></i> Mining...`;
        await tx.wait();

        // SUKSES
        alert("Berhasil! Metadata lengkap sudah tersimpan.");
        toggleForm(); 
        
        // Refresh Feed jika fungsi tersedia
        if(typeof loadFeedTurbo === 'function') {
            loadFeedTurbo();
        } else {
            location.reload();
        }

    } catch (err) {
        console.error(err);
        alert("Gagal: " + (err.reason || err.message));
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-paper-plane"></i> Posting Sekarang`;
    }
}

// --- HELPER LAINNYA (JANGAN DIHAPUS) ---

async function uploadToIPFS(file) {
    const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
    let data = new FormData();
    data.append('file', file);
    const res = await axios.post(url, data, {
        headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY, "Content-Type": "multipart/form-data"}
    });
    return `https://gateway.pinata.cloud/ipfs/${res.data.IpfsHash}`;
}

async function uploadJSON(jsonData) {
    const url = `https://api.pinata.cloud/pinning/pinJSONToIPFS`;
    const res = await axios.post(url, jsonData, {
        headers: {'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_KEY}
    });
    return `ipfs://${res.data.IpfsHash}`;
}

async function compressImage(file, maxSizeKB = 300) {
    if (file.size <= maxSizeKB * 1024) return file;
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (ev) => {
            const img = new Image();
            img.src = ev.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                const MAX = 1200; 
                if (w > MAX || h > MAX) {
                    const ratio = w / h;
                    if (w > h) { w = MAX; h = MAX / ratio; }
                    else { h = MAX; w = MAX * ratio; }
                }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                let quality = 0.9;
                const recursiveCompress = () => {
                    canvas.toBlob((blob) => {
                        if (!blob) return reject("Gagal kompresi");
                        if (blob.size <= maxSizeKB * 1024 || quality <= 0.1) {
                            resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
                        } else {
                            quality -= 0.1;
                            recursiveCompress();
                        }
                    }, 'image/jpeg', quality);
                };
                recursiveCompress();
            };
        };
        reader.onerror = reject;
    });
}

// Helper UI Preview (Pastikan ID fileUpload sesuai HTML)
function previewImage() {
    const file = document.getElementById("fileUpload").files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById("imgPreview").src = e.target.result;
        document.getElementById("imgPreview").style.display = "block";
        document.getElementById("textPreview").style.display = "none";
    }
    if(file) reader.readAsDataURL(file);
}

function toggleForm() { 
    document.getElementById("uploadBox").classList.toggle("open"); 
}

function getVal(id) {
    const el = document.getElementById(id);
    return (el && el.value.trim() !== "") ? el.value.trim() : "-";
}

// --- FITUR SHARE MODERN (WEB SHARE API) ---
async function shareWayang(id, nama) {
    // 1. Susun Link Detail
    const shareUrl = `${window.location.origin}/detail?id=${id}`;
    
    // 2. Data yang akan dibagikan
    const shareData = {
        title: 'Putramas Official Feed',
        text: `Lihat Wayang "${nama}" (ID #${id}) ini di Galeri Digital Putramas!`,
        url: shareUrl
    };

    // 3. Cek apakah Browser support Native Share? (Biasanya HP Android/iPhone support)
    if (navigator.share) {
        try {
            await navigator.share(shareData);
            console.log('Berhasil dibagikan');
        } catch (err) {
            console.log('Batal berbagi / Error:', err);
        }
    } else {
        // 4. Fallback untuk Desktop / Browser Lama (Copy to Clipboard)
        try {
            await navigator.clipboard.writeText(shareUrl);
            // Tampilkan Toast/Alert sederhana
            alert(" Link berhasil disalin ke clipboard!"); 
        } catch (err) {
            prompt("Copy link ini manual:", shareUrl);
        }
    }
}

// --- FUNGSI LIKE YANG SUDAH DIPERBAIKI ---
async function kirimLike(idWayang, btnElement) {
    // 1. Validasi ID
    if (!idWayang) return showToast("ID tidak valid!", 'error');

    // 2. Simpan teks asli tombol (backup)
    const originalContent = btnElement.innerHTML;

    try {
        // 3. Pastikan User Konek Dulu (Wajib!)
        await ensureWallet(); 

        // 4. Setup Kontrak (Perhatikan: Pakai 'ABI' bukan 'CONTRACT_ABI')
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        
        // 5. Ubah tombol jadi Loading
        btnElement.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
        btnElement.style.pointerEvents = "none"; 
        
        // 6. Eksekusi Transaksi
        console.log("Mengirim Like ke ID:", idWayang);
        const tx = await contract.kasihLike(idWayang);
        
        // Menunggu konfirmasi blockchain
        await tx.wait(); 
        
        // 7. Sukses!
        showToast("Berhasil menyukai!", 'success');
        
        // Ubah tampilan jadi permanen merah
        btnElement.innerHTML = `<i class="fas fa-heart" style="color: #e74c3c;"></i> Sukses`;
        
    } catch(err) {
        console.error("Error Like:", err);
        const pesanError = (err.reason || err.message || "").toLowerCase();

        // Cek Error Spesifik
        if (pesanError.includes("already liked") || pesanError.includes("sudah")) {
            showToast("Anda sudah menyukai postingan ini", 'warning');
            // Tetap ubah jadi merah karena faktanya memang sudah dilike
            btnElement.innerHTML = `<i class="fas fa-heart" style="color: #e74c3c;"></i> Sudah`;
        } else if (pesanError.includes("user rejected")) {
            showToast("Transaksi dibatalkan user", 'error');
            // Balikin tombol ke awal
            btnElement.innerHTML = originalContent;
            btnElement.style.pointerEvents = "auto";
        } else {
            showToast("Gagal: " + (err.reason || "Terjadi kesalahan"), 'error');
            // Balikin tombol ke awal
            btnElement.innerHTML = originalContent;
            btnElement.style.pointerEvents = "auto";
        }
    }
}

// --- HELPER 1: PASTIKAN WALLET TERHUBUNG ---
async function ensureWallet() {
    // Cek apakah Metamask ada?
    if (!window.ethereum) throw new Error("Metamask tidak terinstall!");

    // Cek apakah sudah ada signer?
    if (!signer) {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        // Request akses akun
        await provider.send("eth_requestAccounts", []);
        
        // Cek Network (Harus Base Mainnet)
        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: "0x2105" }], // Hex 8453
                });
            } catch (e) {
                throw new Error("Harap ganti jaringan ke Base Mainnet");
            }
        }
        
        // Update variable global signer
        signer = provider.getSigner();
    }
    return signer;
}

// --- HELPER 2: TOAST NOTIFIKASI (PENGGANTI ALERT) ---
function showToast(message, type = 'info') {
    // Buat elemen toast jika belum ada
    let toast = document.getElementById("customToast");
    if (!toast) {
        toast = document.createElement("div");
        toast.id = "customToast";
        toast.style.cssText = `
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 12px 24px; border-radius: 30px;
            font-size: 14px; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none; align-items: center; gap: 10px; font-family: sans-serif;
        `;
        document.body.appendChild(toast);
    }

    // Tentukan Warna & Ikon
    let icon = '<i class="fas fa-info-circle"></i>';
    let color = "#333";

    if (type === 'success') {
        color = "#27ae60"; // Hijau
        icon = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'error') {
        color = "#c0392b"; // Merah
        icon = '<i class="fas fa-exclamation-circle"></i>';
    } else if (type === 'warning') {
        color = "#f39c12"; // Oranye
        icon = '<i class="fas fa-exclamation-triangle"></i>';
    }

    // Tampilkan
    toast.style.background = color;
    toast.innerHTML = `${icon} <span>${message}</span>`;
    toast.style.display = "flex";
    
    // Animasi Masuk
    toast.style.opacity = 0;
    toast.style.bottom = "10px";
    setTimeout(() => {
        toast.style.transition = "all 0.3s ease";
        toast.style.opacity = 1;
        toast.style.bottom = "30px";
    }, 10);

    // Hilang otomatis setelah 3 detik
    setTimeout(() => {
        toast.style.opacity = 0;
        toast.style.bottom = "10px";
        setTimeout(() => { toast.style.display = "none"; }, 300);
    }, 3000);
}

// Fungsi untuk memperbarui tampilan di Sidebar
async function updateSidebarWallet(address) {
    if(!address) return;
    
    // Tampilkan alamat pendek
    const short = address.substring(0, 21) + "," + address.slice(-22);
    document.getElementById("userAddrMini").innerText = short;
    
    // Ambil saldo asli dari provider
    const balance = await provider.getBalance(address);
    const eth = ethers.utils.formatEther(balance);
    document.getElementById("userBalance").innerText = parseFloat(eth).toFixed(8);
}
</script>
</body>
                                                     </html>
