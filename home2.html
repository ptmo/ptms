<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda | Putramas Social</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* 1. RESET & LAYOUT */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: sans-serif; background: #f0f2f5; padding-bottom: 80px; /* Space untuk menu bawah */ }

        .layout-wrapper { 
            display: grid; 
            grid-template-columns: 280px 1fr; /* PC: Sidebar 280px + Konten */
            gap: 25px; 
            max-width: 1200px; 
            margin: 20px auto;
            padding: 0 15px;
        }

        /* 2. MENU BAWAH (MOBILE NAV) - FIX POSITION */
        .mobile-nav {
            display: none; /* Sembunyi di PC */
            position: fixed; /* WAJIB: Agar menempel di layar bawah */
            bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #eee;
            z-index: 9999;
            justify-content: space-around; align-items: center;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .mobile-nav .menu-item { font-size: 20px; color: #ccc; text-decoration: none; position: relative; padding: 5px 15px; }
        .mobile-nav .menu-item.active { color: #7385a5; }

        /* 3. RESPONSIVE (HP) */
        @media (max-width: 900px) {
            .layout-wrapper { grid-template-columns: 1fr; } /* 1 Kolom */
            .sidebar-left { display: none !important; } /* Sidebar Hilang */
            .mobile-nav { display: flex !important; } /* Menu Bawah Muncul */
        }

        /* 4. LAIN-LAIN */
        .nav-badge { background: #e74c3c; color: white; font-size: 9px; min-width: 16px; height: 16px; border-radius: 50%; display: none; align-items: center; justify-content: center; position: absolute; top: -5px; right: 5px; }
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; gap: 10px; }
        .post-image { cursor: zoom-in; width: 100%; display: block; min-height: 200px; background: #f0f0f0; }
        .star-item.active { color: gold; transform: scale(1.2); }
        .star-item { color: #ccc; transition: 0.2s; cursor: pointer; }
        
        /* Tambahan agar modal tidak tertutup keyboard di HP */
        dialog { max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="walletPopupOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; width: 300px; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: relative;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Dompet Terhubung</h3>
            <div style="width: 60px; height: 60px; background: #eef2f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                <i class="fa-solid fa-wallet" style="font-size: 24px; color: #7385a5;"></i>
            </div>
            <p style="font-size: 12px; color: #888; margin-bottom: 5px;">Alamat Dompet:</p>
            <div style="background: #f5f5f5; padding: 8px; border-radius: 8px; font-family: monospace; font-size: 13px; color: #333; word-break: break-all; margin-bottom: 20px;">
                <span id="popupAddressText">0x...</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="copyAddress()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer;"><i class="fa-regular fa-copy"></i> Salin</button>
                <button onclick="performDisconnect()" style="flex: 1; padding: 10px; border: none; background: #ffebee; color: #d32f2f; border-radius: 8px; cursor: pointer; font-weight: bold;">Putuskan</button>
            </div>
            <button onclick="closeWalletPopup()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: #999;">&times;</button>
        </div>
    </div>

    <div class="layout-wrapper">
        <div class="sidebar-left">
            <div class="menu-card">
                <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i> Beranda</a>
                <a href="notifications.html" class="menu-item">
                    <i class="fa-solid fa-bell"></i> Notifikasi
                    <span class="nav-badge" id="badgeSidebar">0</span> 
                </a>
                <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i> Profil</a>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0; width: 100%;">
                
                <a href="#" id="sidebarWalletBtn" onclick="handleWalletClick()" class="menu-item" style="justify-content: space-between;">
                    <span><i class="fa-solid fa-wallet"></i> <span id="sidebarWalletText">Connect</span></span>
                    <i class="fa-solid fa-circle" id="walletIndicator" style="font-size: 8px; color: #ccc;"></i>
                </a>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin: 0 0 10px; font-size: 14px; color: #7385a5;">Status Wallet</h4>
                <div style="font-size: 12px; word-break: break-all; color: #666;" id="walletDisplay">Menunggu...</div>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin-top:0; color:#7385a5;">ðŸ”¥ Sedang Populer</h4>
                <div id="trendingWidget"><p style="font-size:12px; color:#999;">Memuat...</p></div>
            </div>

            <div class="menu-card" style="margin-top: 20px;">
                <h4 style="margin-top:0; color:#7385a5;">âœ¨ Siapa yang diikuti</h4>
                <div id="recomWidget"><p style="font-size:12px; color:#999;">Mencari...</p></div>
            </div>
        </div>

        <div class="main-feed">
            <div class="card" style="padding: 5px 15px; margin-bottom: 20px; position: sticky; top: 10px; z-index: 99; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">            
                <form onsubmit="event.preventDefault(); window.location.href = 'result.html?q=' + document.getElementById('searchInput').value;" style="display: flex; gap: 10px; align-items: center; margin: 0; width: 100%;">
                    <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer; color: #999;"><i class="fa-solid fa-magnifying-glass"></i></button>
                    <input type="search" id="searchInput" class="cp-input" placeholder="Pencarian..." style="border: none; background: transparent; flex: 1; outline: none; height:35px;">
                </form>
            </div>

            <div style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee;">
                <div id="tabFriends" onclick="switchFeed('friends')" style="flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #8b4513; border-bottom: 3px solid #8b4513;">
                     <i class="fa-solid fa-user-group"></i> Mengikuti
                </div>
                <div id="tabGlobal" onclick="switchFeed('global')" style="flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #999; border-bottom: 3px solid transparent;">
                     <i class="fa-solid fa-earth-asia"></i> Jelajah
                </div>
            </div>

            <div class="card create-post-box" style="margin-bottom: 20px;">
                <div class="cp-header">
                    <img src="https://via.placeholder.com/40" class="user-avatar" id="myAvatar">
                    <textarea id="mainCaption" class="cp-input" placeholder="Ceritakan wayang ini"></textarea>
                </div>
                <div id="nftReadyIndicator" style="display:none; background:#f0fff4; border:1px solid #48bb78; padding:10px; margin:10px 15px; border-radius:8px; font-size:12px; color:#2f855a;">
                    <i class="fa-solid fa-check-circle"></i> <strong>Data Arsip Siap!</strong> <span id="nftFilenamePreview"></span>
                    <button onclick="cancelNft()" style="float:right; background:none; border:none; color:#c53030; cursor:pointer;">Batal</button>
                </div>
                <div class="cp-actions">
                    <button onclick="openNftModal()" class="btn-upload" style="background:none; border:none; cursor:pointer; color:#8b4513; font-weight:bold; display:flex; align-items:center; gap:5px;">
                        <i class="fa-solid fa-scroll"></i> Arsipkan Wayang
                    </button>
                    <span style="font-size:10px; color:#999; margin-right:auto; margin-left:5px;">(0.0001 ETH)</span>
                    <button id="btnPost" class="btn-primary" onclick="submitPost()">Posting</button>
                </div>
            </div>

            <div id="feedContainer">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br><br>Memuat Blockchain...
                </div>
            </div>
        </div>
    </div>

    <dialog id="commentModal" style="border:none; border-radius:15px; padding:0; box-shadow:0 0 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; height: 70vh;">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; color:#7385a5;">Komentar</h3>
            <span onclick="document.getElementById('commentModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        <div id="commentList" style="flex: 1; overflow-y: auto; padding: 15px;"><p style="text-align:center; color:#999;">Memuat...</p></div>
        <div style="padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; display: flex; gap: 10px; align-items: flex-end;">
            <textarea id="commentInput" class="cp-input" placeholder="Tulis komentar..." style="flex: 1; height: 50px; padding: 10px; resize: none; border: 1px solid #ddd; border-radius: 10px;"></textarea>
            <input type="hidden" id="commentPostId">        
            <button onclick="submitComment()" class="btn-primary" style="height: 50px; width: 50px; border-radius: 10px;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </dialog>

    <dialog id="nftModal" style="border:none; border-radius:10px; padding:20px; width:95%; max-width:500px; box-shadow:0 0 50px rgba(0,0,0,0.5); margin:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#8b4513;"><i class="fa-solid fa-scroll"></i> Arsip Wayang (NFT)</h3>
            <span onclick="document.getElementById('nftModal').close()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        <div style="overflow-y:auto; max-height:60vh; padding-right:5px;">
            <input type="text" id="mName" class="cp-input" style="width:100%; margin-bottom:10px;" placeholder="Nama Tokoh Wayang">
            <div style="background:#fffaf0; padding:15px; border-radius:8px; text-align:center; border:2px dashed #d4af37; margin-bottom:15px;">
                <label for="modalFileInput" style="cursor:pointer; display:block;">
                    <i class="fa-solid fa-camera" style="font-size:24px; color:#8b4513;"></i><br><span style="font-size:12px; color:#666;">Pilih Foto Fisik</span>
                </label>
                <input type="file" id="modalFileInput" style="display:none;" onchange="previewInModal(this)">
                <div id="modalFilePreview" style="font-size:11px; color:#27ae60; margin-top:5px;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <select id="mGolongan" class="cp-input"><option value="Satria">Satria</option><option value="Dewa">Dewa</option></select>
                <select id="mGaya" class="cp-input"><option value="Surakarta">Surakarta</option><option value="Cirebon">Cirebon</option></select>
                <input type="text" id="mBahan" class="cp-input" placeholder="Bahan"><input type="text" id="mGapit" class="cp-input" placeholder="Gapit">
                <input type="text" id="mPenatah" class="cp-input" placeholder="Penatah"><input type="text" id="mPenyungging" class="cp-input" placeholder="Penyungging">
                <input type="text" id="mTahun" class="cp-input" placeholder="Tahun"><input type="text" id="mKolektor" class="cp-input" placeholder="Kolektor">
            </div>
        </div>
        <button onclick="saveNftDraft()" class="btn-primary" style="width:100%; margin-top:10px;">Simpan Draft</button>
    </dialog>

    <dialog id="sawerModal" style="border:none; padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); width: 300px;">
        <h3 style="margin:0; text-align:center;">Sawer Kurator</h3>
        <input type="hidden" id="sawerTargetId">
        <div style="display:flex; gap:5px; margin:10px 0; justify-content:center;">
             <button onclick="setSawerVal('min')">Min</button><button onclick="setSawerVal('max')">Max</button>
        </div>
        <input type="number" id="sawerAmount" class="cp-input" placeholder="Jumlah ETH" style="width:100%; margin-bottom:10px;">
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('sawerModal').close()" style="flex:1;">Batal</button>
            <button onclick="submitSawer()" class="btn-primary" style="flex:1;">Kirim</button>
        </div>
    </dialog>
    
    <dialog id="ratingModal" style="border:none; border-radius:12px; padding:20px; box-shadow:0 0 30px rgba(0,0,0,0.3); width:300px;">
        <h3 style="margin:0; text-align:center;">Beri Bintang</h3>
        <input type="hidden" id="ratingTargetId">
        <div class="star-wrapper" style="justify-content:center; margin:20px 0;">
            <i class="fa-solid fa-star star-item" onclick="setRate(1)"></i><i class="fa-solid fa-star star-item" onclick="setRate(2)"></i>
            <i class="fa-solid fa-star star-item" onclick="setRate(3)"></i><i class="fa-solid fa-star star-item" onclick="setRate(4)"></i>
            <i class="fa-solid fa-star star-item" onclick="setRate(5)"></i>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('ratingModal').close()" style="flex:1;">Batal</button>
            <button onclick="submitRating()" class="btn-primary" style="flex:1;">Kirim</button>
        </div>
    </dialog>

    <div class="mobile-nav">
        <a href="home.html" class="menu-item active"><i class="fa-solid fa-house"></i></a>
        <a href="notifications.html" class="menu-item">
            <i class="fa-solid fa-bell"></i>
            <span class="nav-badge" id="badgeMobile">0</span> 
        </a>
        <a href="profile.html" class="menu-item"><i class="fa-solid fa-user"></i></a>
        <a href="#" id="navWalletBtn" onclick="handleWalletClick()" class="menu-item"><i class="fa-solid fa-wallet"></i></a>
    </div>

    <div id="toast"></div>

    <script src="ipfs_helper.js"></script>

    <script>
        // --- 1. KONFIGURASI MANDIRI ---
        const MY_CONTRACT_ADDR = "0x0753d3a9f7cb7eD9De233a319d4AD9fF60A434B2"; 
        const BASE_SEPOLIA_ID = 84532;
        const BASE_SEPOLIA_HEX = "0x14a34";
        const SAWER_MIN = 0.00002;
        const SAWER_MAX = 0.01;

        // ABI LENGKAP
        const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"string","name":"action","type":"string"}],"name":"NewInteraction","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"postId","type":"uint256"},{"indexed":true,"internalType":"address","name":"author","type":"address"}],"name":"NewPost","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"newName","type":"string"},{"indexed":false,"internalType":"bool","name":"isPaid","type":"bool"}],"name":"NicknameChanged","type":"event"},{"inputs":[],"name":"MAX_FREE_CHANGES","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"string","name":"_text","type":"string"},{"internalType":"string","name":"_imageURI","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_newNickname","type":"string"}],"name":"changeNickname","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_imageURI","type":"string"},{"internalType":"string","name":"_caption","type":"string"}],"name":"createPost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"dislikePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficial.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_postIndex","type":"uint256"}],"name":"getComments","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasOfficial.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyNotifications","outputs":[{"components":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"internalType":"struct PutramasOfficial.Notification[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getProfile","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficial.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getProfileById","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"internalType":"struct PutramasOfficial.UserProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserPosts","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"internalType":"struct PutramasOfficial.Post[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasDisliked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"idToWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"likePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"nicknamePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"postComments","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"posts","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"author","type":"address"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"caption","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"likeCount","type":"uint256"},{"internalType":"uint256","name":"dislikeCount","type":"uint256"},{"internalType":"uint256","name":"commentCount","type":"uint256"},{"internalType":"uint256","name":"totalRatingScore","type":"uint256"},{"internalType":"uint256","name":"ratingCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"}],"name":"ratePost","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"registerProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newPrice","type":"uint256"}],"name":"setNicknamePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateBioAndPhoto","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_nickname","type":"string"},{"internalType":"string","name":"_foto","type":"string"},{"internalType":"string","name":"_bio","type":"string"},{"internalType":"string","name":"_lokasi","type":"string"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userNotifications","outputs":[{"internalType":"address","name":"actor","type":"address"},{"internalType":"string","name":"actionType","type":"string"},{"internalType":"uint256","name":"postId","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isRead","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userRating","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"fotoProfil","type":"string"},{"internalType":"string","name":"bio","type":"string"},{"internalType":"string","name":"lokasi","type":"string"},{"internalType":"address","name":"wallet","type":"address"},{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"uint256","name":"nameChangeCount","type":"uint256"}],"stateMutability":"view","type":"function"}]
            
        let contract, userAddress, provider, signer;
        let isWalletConnected = false;
        let currentFeedType = 'friends';
        let selectedRate = 0;
        let pendingNftData = null;
        const profileCache = {};

        // --- 2. INIT APP (Fix agar tidak error saat dipanggil) ---
        async function initApp() {
            console.log("App Started.");
            // Render widget dummy agar tidak kosong
            const tW = document.getElementById("trendingWidget");
            const rW = document.getElementById("recomWidget");
            if(tW) tW.innerHTML = "<p style='font-size:11px; color:#999; padding:10px;'>Segera Hadir</p>";
            if(rW) rW.innerHTML = "<p style='font-size:11px; color:#999; padding:10px;'>Segera Hadir</p>";
        }

        // --- 3. EVENT LISTENER STARTUP ---
        document.addEventListener("DOMContentLoaded", async () => {
            loadFeedFromCacheOnly(); 
            await initApp(); 
        });

        // --- 4. LOGIKA KONEKSI (PERBAIKAN TOTAL) ---
        window.addEventListener('load', async () => {
            const sessionRaw = localStorage.getItem("putramas_session");
            if (!sessionRaw) {
                // Jangan redirect paksa agar user bisa lihat feed (jika ada cache)
                return;
            }

            try {
                const session = JSON.parse(sessionRaw);
                
                // Cek Expired
                if (Date.now() > session.expiry) {
                    localStorage.removeItem("putramas_session");
                    return;
                }

                if (!window.ethereum) throw new Error("No Metamask");

                // Init Provider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Cek apakah wallet terkunci
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    // Jika sudah unlock, minta akses
                    await provider.send("eth_requestAccounts", []);
                } else {
                    return; // Stop jika terkunci
                }

                const { chainId } = await provider.getNetwork();
                if (chainId !== BASE_SEPOLIA_ID) return; // Salah network, stop

                signer = provider.getSigner();
                const currentAddr = await signer.getAddress();

                // Validasi Akun
                if (currentAddr.toLowerCase() !== session.address.toLowerCase()) {
                    throw new Error("Akun Berbeda");
                }

                // Setup Kontrak
                contract = new ethers.Contract(MY_CONTRACT_ADDR, CONTRACT_ABI, signer);
                window.contract = contract;
                window.userAddress = currentAddr;
                userAddress = currentAddr;

                console.log("âœ… KONEKSI AMAN:", currentAddr);
                
                // Update UI & Load Data
                isWalletConnected = true;
                updateWalletUI(currentAddr);
                loadMyProfile();
                loadFeedLive(); 

            } catch (e) {
                console.warn("Sesi Invalid:", e.message);
                localStorage.removeItem("putramas_session");
                isWalletConnected = false;
                updateWalletUI("");
            }
        });

        // --- 5. UI WALLET ---
        function updateWalletUI(address) {
            const navBtn = document.getElementById("navWalletBtn");
            const sideText = document.getElementById("sidebarWalletText");
            const sideInd = document.getElementById("walletIndicator");
            const popupText = document.getElementById("popupAddressText");
            const wDisplay = document.getElementById("walletDisplay");

            if(isWalletConnected && address) {
                const short = address.substring(0, 6) + "..." + address.substring(address.length - 4);
                if(sideText) sideText.innerText = short;
                if(sideInd) sideInd.style.color = "#2ecc71"; // Hijau
                if(navBtn) navBtn.style.color = "#2ecc71";
                if(popupText) popupText.innerText = address;
                if(wDisplay) { wDisplay.innerText = "Terhubung: " + short; wDisplay.style.color="#2ecc71"; }
            } else {
                if(sideText) sideText.innerText = "Connect";
                if(sideInd) sideInd.style.color = "#e74c3c"; // Merah
                if(navBtn) navBtn.style.color = "#ccc";
                if(wDisplay) { wDisplay.innerText = "Terputus"; wDisplay.style.color="#e74c3c"; }
            }
        }

        function handleWalletClick() {
            if (isWalletConnected) document.getElementById("walletPopupOverlay").style.display = "flex";
            else manualConnect();
        }

        function closeWalletPopup() { document.getElementById("walletPopupOverlay").style.display = "none"; }
        function copyAddress() { navigator.clipboard.writeText(userAddress).then(() => alert("Disalin!")); }
        function performDisconnect() { 
            if(confirm("Yakin logout?")) { 
                localStorage.removeItem("putramas_session"); 
                window.location.replace("index.html"); 
            } 
        }

        async function manualConnect() {
            try {
                if (!window.ethereum) return alert("Pasang MetaMask!");
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const { chainId } = await provider.getNetwork();
                if (chainId !== BASE_SEPOLIA_ID) await switchBaseSepolia();
                signer = provider.getSigner();
                const addr = await signer.getAddress();
                localStorage.setItem("putramas_session", JSON.stringify({ address: addr, expiry: Date.now() + 864000000 }));
                location.reload();
            } catch (e) { alert("Gagal: " + e.message); }
        }

        async function switchBaseSepolia() {
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_SEPOLIA_HEX }] }); }
            catch(e) { if(e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: BASE_SEPOLIA_HEX, chainName: 'Base Sepolia', rpcUrls: ['https://sepolia.base.org'], nativeCurrency: { name: 'ETH', decimals: 18, symbol: 'ETH' }, blockExplorerUrls: ['https://sepolia.basescan.org'] }] }); }
        }

        // --- 6. LOGIKA FEED ---
        function loadFeedFromCacheOnly() {
            const cacheKey = `feed_cache_${currentFeedType}`;
            const cachedData = localStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    const container = document.getElementById("feedContainer");
                    if(parsed.length > 0) {
                        container.innerHTML = "";
                        renderPostLoop(parsed, container, true);
                    }
                } catch(e) {}
            }
        }

        async function loadFeedLive() {
            if(!contract) return;
            try {
                let posts;
                if(currentFeedType === 'friends') posts = await contract.getMyFeed();
                else posts = await contract.getAllPosts();

                const container = document.getElementById("feedContainer");
                if(posts.length === 0) {
                    if(!localStorage.getItem(`feed_cache_${currentFeedType}`)) {
                         container.innerHTML = `<p style='text-align:center; color:#999; margin-top:40px;'>Belum ada postingan.</p>`;
                    }
                    return;
                }

                // Format Data & Simpan Cache
                const plainPosts = posts.map(p => ({
                    id: p.id.toString(), author: p.author, caption: p.caption,
                    imageURI: p.imageURI, timestamp: p.timestamp.toString(),
                    likeCount: p.likeCount.toString(), commentCount: p.commentCount.toString(),
                    ratingCount: p.ratingCount.toString(), totalRatingScore: p.totalRatingScore.toString()
                    // Tambahkan field NFT jika ada di struct asli
                }));

                localStorage.setItem(`feed_cache_${currentFeedType}`, JSON.stringify(plainPosts));
                container.innerHTML = ""; 
                renderPostLoop(plainPosts, container, false);

            } catch (e) { console.error("Gagal load live:", e); }
        }

        function renderPostLoop(postsArray, container, isCache) {
            [...postsArray].reverse().forEach(post => {
                const profileLink = `profile.html?addr=${post.author}`;
                let imgHtml = "";
                
                if(post.imageURI && post.imageURI.length > 5) {
                    const rawUrl = post.imageURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                    const optUrl = `https://wsrv.nl/?url=${encodeURIComponent(rawUrl)}&w=500&q=60&output=webp`;
                    imgHtml = `<div style="margin:10px -15px;"><img src="${optUrl}" class="post-image" style="width:100%; display:block; min-height:200px; background:#f0f0f0;" loading="lazy"></div>`;
                }

                const rCount = parseInt(post.ratingCount);
                const avgRating = rCount > 0 ? (parseInt(post.totalRatingScore) / rCount).toFixed(1) : "0.0";
                
                const html = `
                <div class="card" id="post-${post.id}" style="padding: 15px; margin-bottom: 20px;">
                    <div class="post-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <a href="${profileLink}"><img src="https://via.placeholder.com/40" class="user-avatar author-avatar-${post.author}" style="width: 40px; height: 40px; border-radius: 50%;"></a>
                        <div>
                            <a href="${profileLink}" class="author-nick-${post.author}" style="font-weight: bold; text-decoration:none; color:#333;">${post.author.substring(0,6)}...</a>
                            <div style="font-size: 11px; color: #999;">${new Date(parseInt(post.timestamp) * 1000).toLocaleString()}</div>
                        </div>
                    </div>
                    <div style="font-size:14px; line-height:1.5;">${formatCaption(post.caption)}</div>
                    ${imgHtml}
                    <div style="border-top:1px solid #eee; padding-top:10px; display:flex; justify-content:space-around;">
                        <button onclick="handleLike(${post.id})" style="background:none; border:none; color:#666;"><i class="fa-regular fa-heart" id="icon-like-${post.id}"></i> <span id="count-like-${post.id}">${post.likeCount}</span></button>
                        <button onclick="openComments(${post.id})" style="background:none; border:none; color:#666;"><i class="fa-regular fa-comment"></i> <span id="count-comment-${post.id}">${post.commentCount}</span></button>
                        <button onclick="openSawerModal(${post.id})" style="background:none; border:none; color:#666;"><i class="fa-solid fa-gift"></i></button>
                        <button onclick="openRating(${post.id})" style="background:none; border:none; color:gold;"><i class="fa-solid fa-star"></i> ${avgRating}</button>
                    </div>
                </div>`;
                container.innerHTML += html;
                fetchProfileLazy(post.author);
            });
        }

        // --- 7. UTILS ---
        function formatCaption(text) { return text ? text.replace(/</g, "&lt;").replace(/\n/g, "<br>") : ""; }
        function showToast(msg, type="info") { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; t.style.background = type === "error" ? "#e74c3c" : "#333"; setTimeout(() => t.className = t.className.replace("show", ""), 3000); }
        
        async function fetchProfileLazy(address) {
            if(profileCache[address]) { updatePostAuthorUI(address, profileCache[address]); return; }
            try {
                const p = await contract.getProfile(address);
                let avt = "https://via.placeholder.com/40";
                if(p.fotoProfil) avt = `https://wsrv.nl/?url=${encodeURIComponent(p.fotoProfil.replace('ipfs://','https://gateway.pinata.cloud/ipfs/'))}&w=80&q=60&output=webp`;
                const data = { nickname: p.nickname, avatar: avt };
                profileCache[address] = data;
                updatePostAuthorUI(address, data);
            } catch(e){}
        }
        function updatePostAuthorUI(address, data) {
            document.querySelectorAll(`.author-avatar-${address}`).forEach(img => img.src = data.avatar);
            document.querySelectorAll(`.author-nick-${address}`).forEach(el => el.innerText = data.nickname);
        }

        // --- 8. ACTION HANDLERS ---
        async function handleLike(id) {
            if(!contract) return manualConnect();
            try {
                const span = document.getElementById(`count-like-${id}`);
                span.innerText = parseInt(span.innerText) + 1; // Optimistic
                const tx = await contract.likePost(id - 1);
                await tx.wait();
            } catch(e) { showToast("Gagal Like", "error"); }
        }

        function openComments(id) { document.getElementById("commentPostId").value = id - 1; document.getElementById("commentModal").showModal(); loadComments(id-1); }
        async function loadComments(idx) {
            const list = document.getElementById("commentList"); list.innerHTML="Loading...";
            try {
                const comments = await contract.getComments(idx);
                list.innerHTML = "";
                if(comments.length===0) list.innerHTML="<p style='text-align:center;color:#999;'>Belum ada komentar.</p>";
                comments.forEach(c => list.innerHTML += `<div class="comment-item"><div><b>${c.commenter.substring(0,6)}...</b>: ${formatCaption(c.text)}</div></div>`);
            } catch(e) { list.innerHTML="Gagal memuat."; }
        }
        async function submitComment() {
            try {
                const idx = document.getElementById("commentPostId").value;
                const tx = await contract.addComment(idx, document.getElementById("commentInput").value, "");
                await tx.wait();
                document.getElementById("commentInput").value="";
                loadComments(idx);
            } catch(e) { showToast("Gagal Komen","error"); }
        }

        function openSawerModal(id) { document.getElementById("sawerTargetId").value = id; document.getElementById("sawerModal").showModal(); }
        function setSawerVal(v) { document.getElementById("sawerAmount").value = (v==='min')?SAWER_MIN : (v==='max'?SAWER_MAX : (SAWER_MAX*v).toFixed(5)); }
        async function submitSawer() {
            try {
                const id = document.getElementById("sawerTargetId").value;
                const val = ethers.utils.parseEther(document.getElementById("sawerAmount").value);
                const tx = await contract.sawerPost(id-1, {value: val});
                await tx.wait();
                document.getElementById("sawerModal").close();
                showToast("Terkirim!");
            } catch(e){ showToast("Gagal","error"); }
        }

        function openRating(id) { document.getElementById("ratingTargetId").value = id; document.getElementById("ratingModal").showModal(); }
        function setRate(n) { selectedRate=n; document.querySelectorAll('.star-item').forEach((s,i)=>s.style.color=i<n?'gold':'#ccc'); }
        async function submitRating() {
            try {
                const tx = await contract.ratePost(document.getElementById("ratingTargetId").value-1, selectedRate);
                await tx.wait();
                document.getElementById("ratingModal").close();
                showToast("Terkirim!");
            } catch(e){ showToast("Gagal","error"); }
        }

        function openNftModal() { document.getElementById("nftModal").showModal(); }
        function previewInModal(i) { if(i.files[0]){const r=new FileReader(); r.onload=e=>document.getElementById("modalFilePreview").innerHTML=`<img src="${e.target.result}" width="100">`; r.readAsDataURL(i.files[0]);} }
        async function saveNftDraft() { document.getElementById("nftModal").close(); document.getElementById("nftReadyIndicator").style.display="block"; showToast("Draft Siap!"); }
        function cancelNft() { document.getElementById("nftReadyIndicator").style.display="none"; }
        async function submitPost() {
            const caption = document.getElementById("mainCaption").value;
            if(!caption) return alert("Isi caption!");
            try {
                showToast("Posting...", "info");
                const tx = await contract.createPost("", "", caption);
                await tx.wait();
                showToast("Berhasil!", "success");
                location.reload();
            } catch(e) { showToast("Gagal posting", "error"); }
        }
        
        function switchFeed(type) {
            currentFeedType = type;
            const tF = document.getElementById("tabFriends"); const tG = document.getElementById("tabGlobal");
            if(type==='friends'){ tF.style.borderBottom="3px solid #8b4513"; tF.style.color="#8b4513"; tG.style.borderBottom="none"; tG.style.color="#999"; }
            else { tG.style.borderBottom="3px solid #8b4513"; tG.style.color="#8b4513"; tF.style.borderBottom="none"; tF.style.color="#999"; }
            loadFeedFromCacheOnly(); loadFeedLive();
        }

        // ============================================================
    // --- 9. FITUR TAMBAHAN YANG HILANG (Insert di Paling Bawah) ---
    // ============================================================

    // A. LOGIKA BADGE NOTIFIKASI (Wajib ada biar gak error loop)
    async function updateNotifBadge() {
        if(!contract || !userAddress) return;
        try {
            // 1. Ambil data notif dari Blockchain
            const notifs = await contract.getMyNotifications();
            
            // 2. Cek timestamp terakhir user membuka halaman notifikasi
            // (Disimpan di localStorage saat user membuka notifications.html)
            const lastCheck = localStorage.getItem("lastNotifCheck") || 0;
            
            // 3. Hitung notifikasi yang LEBIH BARU dari lastCheck
            // Filter: Timestamp notif > Timestamp terakhir cek
            const unreadCount = notifs.filter(n => parseInt(n.timestamp) > parseInt(lastCheck)).length;

            // 4. Update Badge UI (Mobile & PC)
            const badges = document.querySelectorAll('.nav-badge');
            badges.forEach(badge => {
                if (unreadCount > 0) {
                    badge.style.display = 'flex';
                    badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
                } else {
                    badge.style.display = 'none';
                }
            });
        } catch (e) {
            // Silent error agar tidak membanjiri console
        }
    }

    // B. LOGIKA WIDGET KANAN (Trending & Suggestion)
    async function renderWidgets() {
        if(!contract) return;
        try {
            const tW = document.getElementById("trendingWidget");
            const rW = document.getElementById("recomWidget");
            
            // Ambil semua postingan untuk dianalisa
            const posts = await contract.getAllPosts();
            
            // --- 1. POPULER (Urutkan berdasarkan Like terbanyak) ---
            // Copy array, sort descending, ambil 3 teratas
            const sorted = [...posts].sort((a,b) => parseInt(b.likeCount) - parseInt(a.likeCount)).slice(0, 3);
            
            let trendingHtml = "";
            sorted.forEach(p => {
                // Tampilkan cuplikan caption
                const snippet = p.caption.length > 30 ? p.caption.substring(0, 30) + "..." : p.caption;
                trendingHtml += `
                <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                    <a href="koleksi.html?id=${p.id}" style="text-decoration:none; color:#333; font-weight:bold; font-size:12px;">
                        ${snippet}
                    </a>
                    <div style="font-size:10px; color:#e74c3c; margin-top:2px;">
                        <i class="fa-solid fa-fire"></i> ${p.likeCount} Suka
                    </div>
                </div>`;
            });
            if(tW && trendingHtml) tW.innerHTML = trendingHtml;

            // --- 2. REKOMENDASI (User yang sering posting selain kita) ---
            // Ambil list author unik
            const authors = [...new Set(posts.map(p => p.author))];
            // Filter: Jangan tampilkan diri sendiri
            const suggestions = authors.filter(a => a.toLowerCase() !== userAddress.toLowerCase()).slice(0, 3);
            
            let recomHtml = "";
            for (const addr of suggestions) {
                // Ambil profil singkat (Nama & Foto)
                let nick = addr.substring(0, 6);
                let img = "https://via.placeholder.com/30";
                try {
                    const p = await contract.getProfile(addr);
                    if(p.nickname) nick = p.nickname;
                    if(p.fotoProfil) img = `https://wsrv.nl/?url=${encodeURIComponent(p.fotoProfil.replace('ipfs://','https://gateway.pinata.cloud/ipfs/'))}&w=30&q=60&output=webp`;
                } catch(e){}

                recomHtml += `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <img src="${img}" style="width:25px; height:25px; border-radius:50%; object-fit:cover;">
                        <a href="profile.html?addr=${addr}" style="text-decoration:none; color:#555; font-size:12px; font-weight:bold;">${nick}</a>
                    </div>
                    <button onclick="followUser('${addr}')" style="background:none; border:1px solid #7385a5; color:#7385a5; border-radius:15px; font-size:10px; padding:2px 8px; cursor:pointer;">
                        <i class="fa-solid fa-user-plus"></i>
                    </button>
                </div>`;
            }
            if(rW && recomHtml) rW.innerHTML = recomHtml;

        } catch (e) {
            console.log("Widget load skipped");
        }
    }

    // C. FUNGSI FOLLOW (Untuk tombol di Widget)
    async function followUser(targetAddr) {
        if(!contract) return manualConnect();
        if(confirm("Ikuti pengguna ini?")) {
            try {
                showToast("Memproses...", "info");
                const tx = await contract.followUser(targetAddr);
                await tx.wait();
                showToast("Berhasil Mengikuti!", "success");
            } catch(e) {
                showToast("Gagal: " + (e.reason || e.message), "error");
            }
        }
        }

        // ============================================================
    // --- 10. PEMICU REALTIME (Jantung Aplikasi) ---
    // ============================================================
    
    // Cek Notifikasi baru setiap 5 detik
    setInterval(() => {
        // Hanya jalan jika user sedang login
        if (isWalletConnected && contract) {
            updateNotifBadge();
        }
    }, 5000);
    </script>
</body>
</html>
