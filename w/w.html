<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mini Web Wallet + DApp Browser</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#0e0e11;
  color:#fff;
}
header{
  padding:10px;
  background:#15151c;
  text-align:center;
  font-weight:bold;
}
#controls{
  padding:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
select,input,button{
  padding:8px;
  border:none;
  border-radius:6px;
  font-size:14px;
}
button{
  background:#4f46e5;
  color:white;
}
button:active{opacity:0.8}
#browser{
  height:70vh;
  border-top:1px solid #222;
}
iframe{
  width:100%;
  height:100%;
  border:none;
  background:white;
}
#wallet{
  padding:10px;
  font-size:13px;
  background:#15151c;
}
small{color:#aaa}
</style>
</head>

<body>

<header>Mini Mobile Web Wallet + DApp Browser</header>

<div id="controls">
  <input id="url" placeholder="https://dapp.site" style="flex:1"/>
  <button onclick="openDapp()">Open</button>

  <select id="chainSelect" onchange="switchChain()">
    <option value="1">Ethereum</option>
    <option value="56">BSC</option>
    <option value="137">Polygon</option>
  </select>

  <button onclick="showRpc()">Import RPC</button>
</div>

<div id="wallet">
  Address: <span id="addr">not loaded</span><br/>
  Chain ID: <span id="chain">-</span><br/>
  <small>* demo private key only, not secure</small>
</div>

<div id="browser">
  <iframe id="frame"></iframe>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<script>
/* ================= WALLET ================= */

let wallet;
let provider;
let currentChain = "1";

const chains = {
  "1": { name:"Ethereum", rpc:"https://rpc.ankr.com/eth" },
  "56": { name:"BSC", rpc:"https://rpc.ankr.com/bsc" },
  "137": { name:"Polygon", rpc:"https://rpc.ankr.com/polygon" }
};

// demo private key (GANTI SENDIRI)
const PRIVATE_KEY = "0x59c6995e998f97a5a0044976f8dec9e5f89f7e90f5f7b0c72a9d94d9d2b7b555";

function loadWallet(){
  provider = new ethers.providers.JsonRpcProvider(chains[currentChain].rpc);
  wallet = new ethers.Wallet(PRIVATE_KEY, provider);

  document.getElementById("addr").innerText = wallet.address;
  document.getElementById("chain").innerText = currentChain;
}

loadWallet();

/* ================= DAPP BROWSER ================= */

function openDapp(){
  const url = document.getElementById("url").value;
  const frame = document.getElementById("frame");
  frame.src = url;

  frame.onload = () => injectProvider();
}

function injectProvider(){
  const frame = document.getElementById("frame");
  const script = `
    window.ethereum = {
      isMiniWallet: true,
      chainId: "0x${parseInt(currentChain).toString(16)}",
      selectedAddress: "${wallet.address}",
      request: async ({ method, params }) => {
        return parent.postMessage({ method, params }, "*");
      }
    };
  `;
  frame.contentWindow.eval(script);
}

/* ================= RPC IMPORT ================= */

function showRpc(){
  const rpc = prompt("RPC URL:");
  const chainId = prompt("Chain ID (number):");

  if(!rpc || !chainId) return;

  chains[chainId] = { name:"Custom", rpc };
  currentChain = chainId;

  const sel = document.getElementById("chainSelect");
  const opt = document.createElement("option");
  opt.value = chainId;
  opt.innerText = "Custom " + chainId;
  sel.appendChild(opt);
  sel.value = chainId;

  loadWallet();
}

/* ================= CHAIN SWITCH ================= */

function switchChain(){
  currentChain = document.getElementById("chainSelect").value;
  loadWallet();
  injectProvider();
}

/* ================= MESSAGE BRIDGE ================= */

window.addEventListener("message", async (e)=>{
  const { method, params } = e.data;

  try{
    if(method === "eth_requestAccounts"){
      reply([wallet.address]);
    }

    if(method === "eth_chainId"){
      reply("0x" + parseInt(currentChain).toString(16));
    }

    if(method === "eth_getBalance"){
      const bal = await provider.getBalance(wallet.address);
      reply(ethers.utils.hexValue(bal));
    }

    if(method === "eth_sendTransaction"){
      const tx = params[0];
      const sent = await wallet.sendTransaction(tx);
      reply(sent.hash);
    }
  }catch(err){
    reply({ error: err.message });
  }

  function reply(result){
    document.getElementById("frame").contentWindow.postMessage({
      result
    },"*");
  }
});
</script>

</body>
</html>
