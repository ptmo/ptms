<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLANA VAULT (DEV MODE)</title>
    
    <script src="https://bundle.run/buffer@6.0.3"></script>
    
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
    <script>
async function sha256(buf) {
  return crypto.subtle.digest("SHA-256", buf);
}

function bytesToBinary(bytes) {
  return bytes.map(b => b.toString(2).padStart(8, '0')).join('');
}

function binaryToMnemonic(bin) {
  const chunks = bin.match(/.{1,11}/g);
  return chunks.map(b => WORDLIST[parseInt(b, 2)]).join(" ");
}

async function generateMnemonic(strength = 128) {
  const entropy = crypto.getRandomValues(new Uint8Array(strength / 8));
  const entropyBits = bytesToBinary([...entropy]);

  const hash = new Uint8Array(await sha256(entropy));
  const checksumBits = bytesToBinary([...hash]).slice(0, strength / 32);

  return binaryToMnemonic(entropyBits + checksumBits);
}
    </script>

    <script>
async function mnemonicToSeed(mnemonic, passphrase = "") {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    enc.encode(mnemonic),
    "PBKDF2",
    false,
    ["deriveBits"]
  );

  return crypto.subtle.deriveBits(
    {
      name: "PBKDF2",
      salt: enc.encode("mnemonic" + passphrase),
      iterations: 2048,
      hash: "SHA-512"
    },
    keyMaterial,
    512
  );
}
    </script>
    
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --accent: #38bdf8; --danger: #ef4444; --success: #22c55e; }
        body { font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        .section { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        
        input, textarea { width: 90%; padding: 12px; background: #000; color: var(--accent); border: 1px solid #475569; border-radius: 6px; margin: 10px 0; font-family: inherit; }
        
        button { background: var(--accent); color: #000; padding: 12px 24px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; border-radius: 6px; margin: 5px; }
        button:hover { opacity: 0.9; }
        button.danger { background: var(--danger); color: white; }
        
        /* Hapus animasi pulse/offline warning */
        #status-banner { background: var(--success); color: black; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        
        .blur-text { filter: blur(5px); cursor: pointer; transition: 0.3s; }
        .blur-text:hover { filter: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõ†Ô∏è SOLANA VAULT (DEV MODE)</h1>
    
    <div id="status-banner">
        ‚ö° MODE ONLINE AKTIF (NO RESTRICTIONS)
    </div>

    <div id="login-panel" class="section">
        <h2>üîë AKSES WALLET</h2>
        <p>Silakan Generate Baru atau Paste Phrase/Private Key.</p>
        
        <div style="margin: 20px 0;">
            <button onclick="createWallet()">GENERATE NEW WALLET</button>
            <p>- ATAU -</p>
            <textarea id="input-phrase" placeholder="Paste Seed Phrase (12/24 kata) ATAU Private Key (Base58)..." rows="3"></textarea>
            <button onclick="importWallet()">IMPORT & PROCESS</button>
        </div>
    </div>

    <div id="result-panel" class="section" style="display:none;">
        <h3 style="color:var(--success)">‚úÖ WALLET TERMUAT DI RAM</h3>
        
        <div style="text-align:left; background:black; padding:15px; border: 1px solid var(--accent); border-radius:8px;">
            <p><strong>Public Key (Address):</strong></p>
            <p id="out-pub" style="color:white; word-break:break-all;"></p>
            
            <p><strong>Secret Data (Klik untuk lihat):</strong></p>
            <p id="out-priv" class="blur-text" style="color:var(--accent); word-break:break-all;"></p>
        </div>
    </div>

    <div id="dashboard" class="section" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üìà LIVE DASHBOARD</h2>
            <button onclick="logout()" class="danger">LOGOUT / RESET</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
            <div style="background:#334155; padding:15px; border-radius:8px;">
                <small>Saldo SOL</small>
                <h3 id="sol-balance">Loading...</h3>
            </div>
            <div style="background:#334155; padding:15px; border-radius:8px;">
                <small>Estimasi USD</small>
                <h3 id="usd-balance">Loading...</h3>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. INISIALISASI (PENTING) ---
    // Pastikan Buffer terdefinisi sebelum library lain jalan
    window.onload = function() {
        if (typeof buffer !== 'undefined') {
            window.Buffer = buffer.Buffer;
            console.log("Buffer Loaded.");
        } else {
            alert("Gagal memuat library Buffer. Cek koneksi internet!");
        }
    };

    let userPublicKey = null;
    const RPC_URL = "https://api.mainnet-beta.solana.com"; 

    // --- 2. FUNGSI DECODER BASE58 (Supaya bisa Import PK) ---
    // Ini pengganti library bs58 agar script tetap ringan
    const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    function decodeBase58(string) {
        if (string.length === 0) return new Uint8Array(0);
        const bytes = [0];
        for (let i = 0; i < string.length; i++) {
            const char = string[i];
            const value = ALPHABET.indexOf(char);
            if (value === -1) throw new Error('Karakter Base58 tidak valid!');
            for (let j = 0; j < bytes.length; j++) bytes[j] *= 58;
            bytes[0] += value;
            let carry = 0;
            for (let j = 0; j < bytes.length; j++) {
                bytes[j] += carry;
                carry = bytes[j] >> 8;
                bytes[j] &= 0xff;
            }
            while (carry) {
                bytes.push(carry & 0xff);
                carry >>= 8;
            }
        }
        for (let i = 0; i < string.length && string[i] === '1'; i++) bytes.push(0);
        return new Uint8Array(bytes.reverse());
    }

    // --- 3. LOGIKA WALLET ---
    async function createWallet() {
        // Cek library bip39
        if (typeof bip39 === 'undefined') return alert("Library bip39 belum siap. Refresh halaman.");
        
        const mnemonic = bip39.generateMnemonic();
        document.getElementById('input-phrase').value = mnemonic; // Tampilkan di input
        processKey(mnemonic);
    }

    async function importWallet() {
        const input = document.getElementById('input-phrase').value.trim();
        if (!input) return alert("Input masih kosong!");
        processKey(input);
    }

    async function processKey(inputSecret) {
        try {
            let keypair;

            // DETEKSI TIPE INPUT
            if (inputSecret.includes(" ")) {
                // --- TIPE: MNEMONIC PHRASE ---
                const seed = await bip39.mnemonicToSeed(inputSecret);
                // Derivasi Default (m/501'/0'/0/0) agar tidak butuh library ed25519
                const seedSlice = seed.slice(0, 32); 
                keypair = solanaWeb3.Keypair.fromSeed(seedSlice);
            } else {
                // --- TIPE: PRIVATE KEY (BASE58) ---
                try {
                    const secretKey = decodeBase58(inputSecret);
                    keypair = solanaWeb3.Keypair.fromSecretKey(secretKey);
                } catch (err) {
                    throw new Error("Private Key tidak valid. Pastikan format Base58.");
                }
            }

            // SUKSES
            userPublicKey = keypair.publicKey.toString();
            
            // Update UI
            document.getElementById('out-pub').innerText = userPublicKey;
            document.getElementById('out-priv').innerText = inputSecret;
            
            document.getElementById('login-panel').style.display = 'none';
            document.getElementById('result-panel').style.display = 'block';
            document.getElementById('dashboard').style.display = 'block';

            // Ambil Data Blockchain
            fetchBalance();

            // Hapus keypair dari variabel lokal fungsi (Security minimal)
            keypair = null;

        } catch (e) {
            alert("Error: " + e.message);
            console.error(e);
        }
    }

    // --- 4. DATA DASHBOARD ---
    async function fetchBalance() {
        if (!userPublicKey) return;
        
        try {
            const connection = new solanaWeb3.Connection(RPC_URL);
            const pubKey = new solanaWeb3.PublicKey(userPublicKey);
            
            // Get Balance
            const balance = await connection.getBalance(pubKey);
            const sol = balance / 1000000000;
            document.getElementById('sol-balance').innerText = sol.toFixed(4) + " SOL";

            // Get Price (via Jupiter API)
            const priceRes = await fetch("https://api.jup.ag/price/v2?ids=So11111111111111111111111111111111111111112");
            const priceJson = await priceRes.json();
            const price = priceJson.data['So11111111111111111111111111111111111111112'].price;
            
            document.getElementById('usd-balance').innerText = "$" + (sol * price).toFixed(2);

        } catch (e) {
            document.getElementById('sol-balance').innerText = "Error";
            console.log("Gagal koneksi RPC:", e);
        }
    }

    function logout() {
        location.reload();
    }
</script>

</body>
</html>
