<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>BROADCASTER (TEST MODE - CDN)</title>
    
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>

    <style>
        body { background: #f0f0f0; color: #333; font-family: monospace; padding: 20px; max-width: 700px; margin: 0 auto; }
        .box { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #aaa; }
        button { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; font-weight: bold; background: #333; color: white; }
    </style>
</head>
<body>

    <h1>ðŸ“¡ BROADCASTER (TEST MODE)</h1>
    <p>Gunakan file ini untuk membuat data transaksi dan mengirimnya.</p>

    <div class="box">
        <h3>LANGKAH 1: SIAPKAN DATA</h3>
        <label>Dari (Address Kamu):</label>
        <input type="text" id="from-pubkey">
        
        <label>Ke (Address Tujuan):</label>
        <input type="text" id="to-pubkey">
        
        <label>Jumlah (SOL):</label>
        <input type="number" id="amount" value="0.001">

        <button onclick="prepareTx()">GENERATE UNSIGNED MESSAGE</button>

        <p>Copy kode ini ke <strong>vault_test.html</strong>:</p>
        <textarea id="unsigned-out" rows="3" readonly></textarea>
    </div>

    <div class="box">
        <h3>LANGKAH 3: KIRIM (BROADCAST)</h3>
        <label>Paste Signed Transaction (Dari vault_test.html):</label>
        <textarea id="signed-in" rows="3"></textarea>
        
        <button onclick="broadcastTx()" style="background:#00c853;">KIRIM DANA SEKARANG</button>
    </div>

<script>
    const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
    window.Buffer = buffer.Buffer;

    async function prepareTx() {
        const fromStr = document.getElementById('from-pubkey').value.trim();
        const toStr = document.getElementById('to-pubkey').value.trim();
        const amt = document.getElementById('amount').value;

        if(!fromStr || !toStr || !amt) return alert("Isi semua data!");

        try {
            const fromPub = new solanaWeb3.PublicKey(fromStr);
            const toPub = new solanaWeb3.PublicKey(toStr);
            
            const { blockhash } = await connection.getLatestBlockhash();

            const tx = new solanaWeb3.Transaction({
                recentBlockhash: blockhash,
                feePayer: fromPub
            });

            tx.add(solanaWeb3.SystemProgram.transfer({
                fromPubkey: fromPub,
                toPubkey: toPub,
                lamports: amt * solanaWeb3.LAMPORTS_PER_SOL
            }));

            // Serialize Message Only
            const msgBuffer = tx.serializeMessage(); 
            document.getElementById('unsigned-out').value = buffer.Buffer.from(msgBuffer).toString('base64');
            alert("Data siap! Copy ke Vault.");

        } catch(e) { alert("Error: " + e.message); }
    }

    async function broadcastTx() {
        const signedBase64 = document.getElementById('signed-in').value.trim();
        if(!signedBase64) return alert("Paste signed transaction dulu!");

        try {
            const buf = buffer.Buffer.from(signedBase64, 'base64');
            const sig = await connection.sendRawTransaction(buf);
            alert("SUKSES! Signature: " + sig);
            window.open(`https://solscan.io/tx/${sig}`, '_blank');
        } catch(e) { alert("Gagal Broadcast: " + e.message); }
    }
</script>
</body>
</html>
