<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wayang Web Wallet (Secure)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #d35400; /* Warna Favorit Anda */
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --text-sec: #b0b0b0;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            /* Anti-Select agar kerasa kayak App Native */
            user-select: none; 
            -webkit-user-select: none;
        }

        /* --- UI COMPONENTS --- */
        .container { padding: 20px; max-width: 500px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
        
        h1, h2 { font-weight: 700; margin-bottom: 10px; }
        p { color: var(--text-sec); font-size: 14px; line-height: 1.5; margin-bottom: 20px; }

        .input-box { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 8px; font-size: 12px; color: var(--text-sec); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        input, textarea {
            width: 100%;
            padding: 16px;
            background: #252525;
            border: 2px solid #333;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: 0.3s;
        }
        input:focus { outline: none; border-color: var(--primary); background: #2a2a2a; }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); margin-top: 10px; }

        /* --- CARDS --- */
        .card {
            background: var(--surface);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .balance-card {
            background: linear-gradient(135deg, var(--primary) 0%, #a04000 100%);
            border: none;
            text-align: center;
            padding: 30px 20px;
        }

        /* --- LOADING OVERLAY --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- NAVIGATION --- */
        .bottom-nav {
            background: var(--surface);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            padding-bottom: calc(12px + var(--safe-bottom));
            position: sticky; bottom: 0;
        }
        .nav-item { text-align: center; color: var(--text-sec); font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }

        .hidden { display: none !important; }
        .show { display: block !important; }

        /* Helper for JSON display */
        pre { background: #000; padding: 10px; border-radius: 8px; overflow-x: scroll; font-size: 10px; color: #0f0; margin-bottom: 10px;}
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <h3 id="loader-text">Memproses...</h3>
        <p>Jangan tutup halaman ini.</p>
    </div>

    <div id="view-onboarding" class="container hidden">
        <div style="text-align: center; margin-top: 40px; margin-bottom: 40px;">
            <i class="fa-solid fa-shield-halved" style="font-size: 60px; color: var(--primary);"></i>
            <h1 style="margin-top: 20px;">Wayang Secure</h1>
            <p>Wallet Web3 berbasis Browser.<br>Data Anda terenkripsi di perangkat ini.</p>
        </div>
        
        <div class="card">
            <label>Buat Password Pengaman</label>
            <input type="password" id="new-password" placeholder="Minimal 6 karakter">
            <p style="font-size: 11px; margin-top: 5px; color: #e74c3c;">*Password ini tidak bisa di-reset. Jika lupa, aset hilang.</p>
        </div>

        <button class="btn" onclick="createWallet()">
            <i class="fa-solid fa-plus-circle"></i> Buat Wallet Baru
        </button>
        
        <div style="text-align: center; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px;">
            <p>Sudah punya akun?</p>
            <button class="btn btn-outline" onclick="showImport()">Impor (JSON/Phrase)</button>
        </div>
    </div>

    <div id="view-login" class="container hidden">
        <div style="margin-top: auto; margin-bottom: auto;">
            <h2>Selamat Datang Kembali</h2>
            <p>Masukkan password Anda untuk membuka dompet.</p>
            
            <div class="input-box">
                <input type="password" id="login-password" placeholder="Password Anda">
            </div>
            
            <button class="btn" onclick="loginWallet()">
                <i class="fa-solid fa-lock-open"></i> Buka Dompet
            </button>
            <button class="btn btn-outline" style="border:none; color: #e74c3c;" onclick="resetWallet()">
                Hapus & Reset Dompet
            </button>
        </div>
    </div>

    <div id="view-dashboard" class="container hidden" style="padding-bottom: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div style="font-size: 14px; font-weight: bold;">User Wayang</div>
            </div>
            <i class="fa-solid fa-wifi" style="color: var(--primary);"></i>
        </div>

        <div class="card balance-card">
            <div style="opacity: 0.8; font-size: 14px;">Total Balance</div>
            <h1 style="font-size: 36px; margin: 10px 0;" id="display-balance">0.00 ETH</h1>
            
            <div style="background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;" onclick="copyAddress()">
                <span id="display-address">0x...</span>
                <i class="fa-regular fa-copy"></i>
            </div>
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <button class="btn" style="flex: 1;"><i class="fa-solid fa-arrow-up"></i> Kirim</button>
            <button class="btn btn-outline" style="flex: 1; margin:0;"><i class="fa-solid fa-arrow-down"></i> Terima</button>
        </div>

        <h3>DApp Browser</h3>
        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 15px; border-bottom: 1px solid #333; background: #252525; display: flex; gap: 10px;">
                <input type="text" value="https://app.uniswap.org" style="padding: 8px; font-size: 14px;" disabled>
                <button style="width: 40px; background: var(--primary); border:none; color: white; border-radius: 8px;"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
            <div style="padding: 40px; text-align: center; color: #555;">
                <i class="fa-solid fa-globe" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>Area Webview Browser</p>
            </div>
        </div>
    </div>

    <div id="nav-bar" class="bottom-nav hidden">
        <div class="nav-item active">
            <i class="fa-solid fa-wallet"></i>
            Wallet
        </div>
        <div class="nav-item">
            <i class="fa-solid fa-compass"></i>
            Browser
        </div>
        <div class="nav-item">
            <i class="fa-solid fa-gear"></i>
            Settings
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const STORAGE_KEY = 'wayang_encrypted_json';
        // Gunakan Provider Publik (Contoh: Sepolia Testnet)
        const provider = new ethers.JsonRpcProvider("https://rpc.ankr.com/eth_sepolia");
        
        let globalWallet = null; // Wallet instance di RAM (hilang kalau refresh)

        // --- DOM ELEMENTS ---
        const els = {
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loader-text'),
            views: {
                onboarding: document.getElementById('view-onboarding'),
                login: document.getElementById('view-login'),
                dashboard: document.getElementById('view-dashboard')
            },
            nav: document.getElementById('nav-bar'),
            balance: document.getElementById('display-balance'),
            address: document.getElementById('display-address')
        };

        // --- INIT ---
        window.onload = () => {
            // Cek apakah ada data wallet tersimpan di LocalStorage
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                switchView('login');
            } else {
                switchView('onboarding');
            }
        };

        // --- CORE FUNCTIONS (THE REAL LOGIC) ---

        // 1. BUAT WALLET BARU & ENKRIPSI
        async function createWallet() {
            const pwd = document.getElementById('new-password').value;
            if(pwd.length < 6) return alert("Password minimal 6 karakter!");

            showLoader(true, "Membuat Wallet & Mengenkripsi... (Ini memakan waktu 3-5 detik)");

            // Gunakan setTimeout agar UI loader sempat muncul sebelum thread freeze karena enkripsi
            setTimeout(async () => {
                try {
                    // A. Bikin Random Wallet
                    const wallet = ethers.Wallet.createRandom();
                    
                    // B. Enkripsi Wallet jadi JSON (Standard Keystore v3)
                    // Ini proses berat (CPU intensive) untuk keamanan anti-bruteforce
                    const json = await wallet.encrypt(pwd);
                    
                    // C. Simpan JSON ke Storage
                    localStorage.setItem(STORAGE_KEY, json);

                    // D. Set Global Wallet
                    globalWallet = wallet.connect(provider);
                    
                    showLoader(false);
                    enterDashboard();

                } catch (err) {
                    showLoader(false);
                    alert("Error: " + err.message);
                }
            }, 100);
        }

        // 2. LOGIN (DEKRIPSI)
        async function loginWallet() {
            const pwd = document.getElementById('login-password').value;
            const encryptedJson = localStorage.getItem(STORAGE_KEY);
            
            if(!encryptedJson) return alert("Data korup. Reset wallet.");

            showLoader(true, "Membuka Brankas Digital...");

            setTimeout(async () => {
                try {
                    // A. Dekripsi JSON pakai password
                    const wallet = await ethers.Wallet.fromEncryptedJson(encryptedJson, pwd);
                    
                    // B. Konek ke Provider
                    globalWallet = wallet.connect(provider);
                    
                    showLoader(false);
                    enterDashboard();
                } catch (err) {
                    showLoader(false);
                    // Ethers.js akan throw error jika password salah
                    alert("Password Salah! Akses Ditolak.");
                }
            }, 100);
        }

        // 3. MASUK DASHBOARD & LOAD DATA
        async function enterDashboard() {
            switchView('dashboard');
            
            // Tampilkan Address
            const addr = globalWallet.address;
            els.address.innerText = addr.substring(0, 6) + "..." + addr.substring(addr.length - 4);

            // Cek Saldo
            try {
                const bal = await provider.getBalance(addr);
                els.balance.innerText = parseFloat(ethers.formatEther(bal)).toFixed(4) + " ETH";
            } catch (e) {
                console.log("Offline / RPC Error");
            }
        }

        // --- UTILITIES ---

        function switchView(viewName) {
            // Hide all
            Object.values(els.views).forEach(el => el.classList.add('hidden'));
            els.nav.classList.add('hidden');

            // Show target
            els.views[viewName].classList.remove('hidden');

            if(viewName === 'dashboard') {
                els.nav.classList.remove('hidden');
            }
        }

        function showLoader(isActive, text = "") {
            if(isActive) {
                els.loader.classList.remove('hidden');
                els.loaderText.innerText = text;
            } else {
                els.loader.classList.add('hidden');
            }
        }

        function resetWallet() {
            if(confirm("Yakin hapus dompet? Aset akan hilang permanen jika Anda tidak punya backup phrase!")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        window.copyAddress = () => {
            if(globalWallet) {
                navigator.clipboard.writeText(globalWallet.address);
                alert("Alamat disalin!");
            }
        }

        // --- BROWSER SIMULATION ---
        // Karena ini murni JS, kita tidak bisa inject 'window.ethereum' ke iframe lintas domain (CORS Policy).
        // Solusinya: Ini adalah "Wallet Connect" Client atau DApp browser khusus yang kita load via proxy (advanced).
        // Untuk code ini, browser hanya UI placeholder.
    </script>
</body>
</html>
