<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wayang Cloud Wallet</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

    <style>
        /* --- GAYA TAMPILAN (SAMA SEPERTI SEBELUMNYA) --- */
        :root { --primary: #FF9800; --bg: #121212; --card: #1e1e1e; --text: #fff; --radius: 12px; }
        * { box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        .container { padding: 20px; max-width: 480px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: var(--radius); color: #000; font-weight: bold; font-size: 16px; margin-bottom: 10px; cursor: pointer; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background: #e74c3c; color: #fff; }
        input { width: 100%; padding: 15px; background: #2c2c2c; border: 1px solid #333; border-radius: var(--radius); color: #fff; margin-bottom: 15px; font-size: 16px; }
        .card { background: var(--card); padding: 20px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid #333; }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p id="loader-msg">Menghubungkan ke Firebase...</p>
    </div>

    <div id="view-setup" class="container">
        <div style="text-align: center; margin: 40px 0;">
            <h1 style="color: var(--primary);">Wayang Cloud</h1>
            <p style="color: #aaa;">Wallet tersinkronisasi via Firebase</p>
        </div>

        <div class="card">
            <h3>Mulai Session</h3>
            <p style="font-size: 12px; color: #aaa; margin-bottom: 10px;">Masukkan Username unik untuk menyimpan/mengambil wallet Anda dari cloud.</p>
            <input type="text" id="user-id" placeholder="Username (misal: user123)">
            <button class="btn" onclick="WalletFlow.checkUser()">Lanjut</button>
        </div>
    </div>

    <div id="view-create" class="container hidden">
        <h2>Setup Wallet Baru</h2>
        <p>Username ini belum memiliki wallet. Mari buat baru.</p>
        <div class="card">
            <label>Buat Password Enkripsi</label>
            <input type="password" id="create-pwd" placeholder="Password (Wajib diingat!)">
            <button class="btn" onclick="WalletFlow.createWallet()">Generate & Simpan ke Cloud</button>
        </div>
        <button class="btn btn-outline" onclick="UI.show('view-setup')">Kembali</button>
    </div>

    <div id="view-login" class="container hidden">
        <h2>Unlock Wallet</h2>
        <p>Wallet ditemukan di Cloud. Masukkan password untuk mendekripsi.</p>
        <div class="card">
            <input type="password" id="login-pwd" placeholder="Password Wallet">
            <button class="btn" onclick="WalletFlow.unlockWallet()">Buka Wallet</button>
        </div>
        <button class="btn btn-outline" onclick="UI.show('view-setup')">Ganti User</button>
    </div>

    <div id="view-dashboard" class="container hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 id="dash-username">User</h3>
            <button class="btn-danger" style="width: auto; padding: 8px 15px; font-size: 12px;" onclick="location.reload()">Logout</button>
        </div>

        <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--primary), #e65100);">
            <p style="font-size: 12px; color: #000;">Sepolia Balance</p>
            <h1 id="dash-balance" style="color: #000; margin: 10px 0;">0.00 ETH</h1>
            <div style="background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px; display: inline-block; font-size: 12px; cursor: pointer;" onclick="WalletFlow.copyAddress()">
                <span id="dash-address">0x...</span> ðŸ“‹
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn" onclick="alert('Fitur Kirim sama seperti sebelumnya')">Kirim</button>
            <button class="btn btn-outline">Terima</button>
        </div>
    </div>

    <script type="module">
        // ----------------------------------------------------
        // 1. FIREBASE CONFIGURATION & INIT
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ðŸ”¥ GANTI BAGIAN INI DENGAN CONFIG FIREBASE ANDA ðŸ”¥
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCn1j8acLWDEVjoO2VB3qeN8rh8qUVBRR8",
  authDomain: "putramas-cc719.firebaseapp.com",
  databaseURL: "https://putramas-cc719-default-rtdb.firebaseio.com",
  projectId: "putramas-cc719",
  storageBucket: "putramas-cc719.firebasestorage.app",
  messagingSenderId: "1841157194",
  appId: "1:1841157194:web:012d80abf7293bd43d02b3",
  measurementId: "G-38XGWE5H38"
};

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ----------------------------------------------------
        // 2. CLOUD DATABASE MANAGER
        // ----------------------------------------------------
        class CloudDB {
            // Cek apakah user sudah punya wallet di Firestore
            static async getUserWallet(username) {
                const docRef = doc(db, "wallets", username);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return docSnap.data().encryptedData;
                } else {
                    return null;
                }
            }

            // Simpan encrypted JSON ke Firestore
            static async saveUserWallet(username, encryptedJson) {
                await setDoc(doc(db, "wallets", username), {
                    encryptedData: encryptedJson,
                    createdAt: new Date().toISOString()
                });
            }
        }

        // ----------------------------------------------------
        // 3. WALLET LOGIC
        // ----------------------------------------------------
        window.activeWallet = null;
        window.currentUser = null;
        const RPC_URL = "https://rpc.ankr.com/eth_sepolia";

        window.WalletFlow = class {
            
            // Step 1: Cek User
            static async checkUser() {
                const username = document.getElementById('user-id').value.trim();
                if(!username) return alert("Isi username dulu");

                UI.loading(true, "Mengecek Database...");
                
                try {
                    const data = await CloudDB.getUserWallet(username);
                    window.currentUser = username;
                    
                    UI.loading(false);
                    if(data) {
                        // User ada -> Login Mode
                        UI.show('view-login');
                    } else {
                        // User baru -> Create Mode
                        UI.show('view-create');
                    }
                } catch(e) {
                    UI.loading(false);
                    alert("Firebase Error: Pastikan Config Benar & Internet Lancar.\n" + e.message);
                }
            }

            // Step 2A: Create New (Encrypt -> Upload)
            static async createWallet() {
                const pwd = document.getElementById('create-pwd').value;
                if(pwd.length < 6) return alert("Password minimal 6 karakter");

                UI.loading(true, "Membuat Wallet & Upload ke Cloud...");

                setTimeout(async () => {
                    try {
                        const wallet = ethers.Wallet.createRandom();
                        const json = await wallet.encrypt(pwd); // Berat!
                        
                        // Upload ke Firebase
                        await CloudDB.saveUserWallet(window.currentUser, json);
                        
                        // Langsung login
                        window.activeWallet = wallet.connect(new ethers.JsonRpcProvider(RPC_URL));
                        this.enterDashboard();
                    } catch(e) {
                        alert("Gagal: " + e.message);
                    } finally {
                        UI.loading(false);
                    }
                }, 100);
            }

            // Step 2B: Unlock (Download -> Decrypt)
            static async unlockWallet() {
                const pwd = document.getElementById('login-pwd').value;
                UI.loading(true, "Download & Decrypting...");

                setTimeout(async () => {
                    try {
                        // Ambil lagi data fresh dari Cloud
                        const json = await CloudDB.getUserWallet(window.currentUser);
                        
                        // Decrypt lokal
                        const wallet = await ethers.Wallet.fromEncryptedJson(json, pwd);
                        
                        window.activeWallet = wallet.connect(new ethers.JsonRpcProvider(RPC_URL));
                        this.enterDashboard();
                    } catch(e) {
                        alert("Password Salah!");
                    } finally {
                        UI.loading(false);
                    }
                }, 100);
            }

            static enterDashboard() {
                UI.show('view-dashboard');
                document.getElementById('dash-username').innerText = window.currentUser;
                
                const addr = window.activeWallet.address;
                document.getElementById('dash-address').innerText = addr.substring(0,6) + "..." + addr.substring(addr.length-4);
                
                // Cek Saldo
                window.activeWallet.provider.getBalance(addr).then(bal => {
                    document.getElementById('dash-balance').innerText = parseFloat(ethers.formatEther(bal)).toFixed(4) + " ETH";
                });
            }

            static copyAddress() {
                if(window.activeWallet) navigator.clipboard.writeText(window.activeWallet.address);
                alert("Address Disalin");
            }
        };

        // ----------------------------------------------------
        // 4. UI UTILS
        // ----------------------------------------------------
        window.UI = class {
            static show(id) {
                document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            }
            static loading(show, msg) {
                const el = document.getElementById('loader');
                if(show) {
                    el.classList.remove('hidden');
                    if(msg) document.getElementById('loader-msg').innerText = msg;
                } else {
                    el.classList.add('hidden');
                }
            }
        };

    </script>
</body>
</html>
