<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wayang Lite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    
    <style>
        /* --- CSS RINGAN (Tanpa External Fonts) --- */
        :root { --primary: #d35400; --bg: #0a0a0a; --card: #141414; --text: #eee; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Helpers */
        .hidden { display: none !important; }
        .full-h { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        
        /* UI Components */
        .btn { background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 16px; margin-bottom: 10px; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .input { width: 100%; padding: 15px; background: #222; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        .input:focus { border-color: var(--primary); outline: none; }
        
        .card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #222; }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Navbar */
        .nav { display: flex; border-top: 1px solid #222; background: var(--card); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #666; font-size: 24px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        
        /* Browser Frame */
        #browser-view { display: flex; flex-direction: column; height: 100%; }
        .url-bar { padding: 10px; background: #222; display: flex; gap: 10px; }
        iframe { flex: 1; border: none; background: #fff; }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-size: 14px;" id="loader-txt">Memproses...</p>
    </div>

    <div id="pg-onboard" class="full-h">
        <div style="flex:1; display: flex; flex-direction: column; justify-content: center; text-align: center;">
            <div style="font-size: 60px;">üõ°Ô∏è</div>
            <h1 style="margin: 20px 0;">Wayang Lite</h1>
            <p style="color:#aaa;">Wallet Web3 Super Ringan</p>
        </div>
        <button class="btn" onclick="goTo('pg-create')">Buat Wallet</button>
        <button class="btn btn-outline" onclick="goTo('pg-import')">Import</button>
    </div>

    <div id="pg-dash" class="full-h hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Wayang Wallet</h3>
            <span style="font-size: 12px; color: var(--primary);">‚óè Sepolia</span>
        </div>

        <div class="card" style="text-align: center; background: linear-gradient(135deg, #d35400, #a04000);">
            <p style="font-size: 12px; opacity: 0.8;">Total Saldo</p>
            <h1 style="font-size: 32px; margin: 10px 0;" id="bal-txt">0.00 ETH</h1>
            <div style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px; font-size: 12px; display: inline-block; cursor: pointer;" onclick="copyAddr()">
                <span id="addr-txt">0x...</span> üìã
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" style="flex:1; margin:0;" onclick="alert('Fitur Kirim Sederhana')">‚¨ÜÔ∏è Kirim</button>
            <button class="btn btn-outline" style="flex:1; margin:0;">‚¨áÔ∏è Terima</button>
        </div>
    </div>

    <div id="pg-browser" class="hidden" style="flex: 1; flex-direction: column;">
        <div class="url-bar">
            <input type="text" id="url-input" class="input" style="margin:0; padding: 10px;" value="https://uniswap.org" placeholder="https://...">
            <button class="btn" style="width: auto; margin:0; padding: 0 20px;" onclick="loadIframe()">Go</button>
        </div>
        <iframe id="web-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
    </div>

    <div id="pg-create" class="full-h hidden">
        <h2>Setup Wallet</h2>
        <p style="color:#888; margin-bottom: 20px;">Masukkan password pengaman lokal.</p>
        <input type="password" id="pwd-input" class="input" placeholder="Password (min 6 char)">
        <button class="btn" onclick="processWallet('create')">Proses</button>
        <button class="btn btn-outline" onclick="goTo('pg-onboard')">Batal</button>
    </div>
    
    <div id="pg-import" class="full-h hidden">
        <h2>Import Phrase</h2>
        <textarea id="phrase-input" class="input" rows="3" placeholder="12 kata rahasia..."></textarea>
        <input type="password" id="import-pwd" class="input" placeholder="Password Baru App">
        <button class="btn" onclick="processWallet('import')">Import Sekarang</button>
        <button class="btn btn-outline" onclick="goTo('pg-onboard')">Batal</button>
    </div>

    <div id="navbar" class="nav hidden">
        <div class="nav-item active" onclick="switchTab('dash')">üëõ</div>
        <div class="nav-item" onclick="switchTab('browser')">üåè</div>
        <div class="nav-item" onclick="alert('Settings')">‚öôÔ∏è</div>
    </div>

    <script>
        // CONFIG
        const STORAGE_KEY = 'wayang_lite_v1';
        const PROVIDER_URL = "https://rpc.ankr.com/eth_sepolia";
        let provider, wallet;

        // UI HELPERS
        const el = (id) => document.getElementById(id);
        const pages = ['pg-onboard', 'pg-dash', 'pg-browser', 'pg-create', 'pg-import'];

        // 1. NAVIGATION
        function goTo(pid) {
            pages.forEach(p => el(p).classList.add('hidden'));
            el(pid).classList.remove('hidden');
            if(pid === 'pg-dash' || pid === 'pg-browser') el('navbar').classList.remove('hidden');
            else el('navbar').classList.add('hidden');
        }

        function switchTab(tab) {
            if(tab === 'dash') {
                el('pg-dash').classList.remove('hidden');
                el('pg-browser').classList.add('hidden');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.remove('active');
            } else {
                el('pg-dash').classList.add('hidden');
                el('pg-browser').classList.remove('hidden');
                el('pg-browser').style.display = 'flex'; // Fix display
                document.querySelectorAll('.nav-item')[0].classList.remove('active');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            }
        }

        function loading(show, txt) {
            el('loader').classList.toggle('hidden', !show);
            if(txt) el('loader-txt').innerText = txt;
        }

        // 2. WALLET CORE (NON-BLOCKING)
        function processWallet(mode) {
            const pwd = mode === 'create' ? el('pwd-input').value : el('import-pwd').value;
            if(pwd.length < 6) return alert("Password kurang panjang!");

            loading(true, "Mengenkripsi... (Tunggu)");

            // SETTIMEOUT HACK: Agar UI Loader muncul dulu sebelum JS macet karena enkripsi
            setTimeout(async () => {
                try {
                    let w;
                    if(mode === 'create') {
                        w = ethers.Wallet.createRandom();
                    } else {
                        const phrase = el('phrase-input').value.trim();
                        w = ethers.Wallet.fromPhrase(phrase);
                    }
                    
                    // Proses Berat di sini
                    const json = await w.encrypt(pwd);
                    localStorage.setItem(STORAGE_KEY, json);
                    
                    // Login otomatis
                    provider = new ethers.JsonRpcProvider(PROVIDER_URL);
                    wallet = w.connect(provider);
                    
                    updateUI();
                    goTo('pg-dash');
                } catch(e) {
                    alert("Error: " + e.message);
                } finally {
                    loading(false);
                }
            }, 100); 
        }

        async function init() {
            const data = localStorage.getItem(STORAGE_KEY);
            if(data) {
                // Auto login simple (Minta password idealnya, tapi ini versi lite)
                const pwd = prompt("Masukkan Password Wallet Anda:");
                if(!pwd) return;
                loading(true, "Membuka...");
                setTimeout(async () => {
                    try {
                        const w = await ethers.Wallet.fromEncryptedJson(data, pwd);
                        provider = new ethers.JsonRpcProvider(PROVIDER_URL);
                        wallet = w.connect(provider);
                        updateUI();
                        goTo('pg-dash');
                    } catch(e) {
                        alert("Password Salah / Data Rusak");
                        goTo('pg-onboard');
                    } finally {
                        loading(false);
                    }
                }, 50);
            } else {
                goTo('pg-onboard');
            }
        }

        async function updateUI() {
            const addr = wallet.address;
            el('addr-txt').innerText = addr.substring(0,6) + "..." + addr.substring(addr.length-4);
            try {
                const bal = await provider.getBalance(addr);
                el('bal-txt').innerText = parseFloat(ethers.formatEther(bal)).toFixed(4) + " ETH";
            } catch(e) {}
        }

        // 3. BROWSER & INJECTION ATTEMPT
        function loadIframe() {
            let url = el('url-input').value;
            if(!url.startsWith('http')) url = 'https://' + url;
            
            loading(true, "Memuat Website...");
            const frame = el('web-frame');
            
            // Bersihkan dulu biar ringan
            frame.src = "about:blank";
            
            setTimeout(() => {
                frame.src = url;
                loading(false);
                // Coba kirim pesan handshake ke Iframe (Walaupun kemungkinan besar diblokir DApp)
                injectProvider(frame); 
            }, 500);
        }

        function injectProvider(frame) {
            // Ini adalah upaya terbaik komunikasi postMessage
            // DApp harus punya listener "message" untuk ini bekerja.
            frame.onload = () => {
                const msg = {
                    type: 'ETHEREUM_PROVIDER_ANNOUNCE',
                    data: {
                        chainId: "0xaa36a7", // Sepolia
                        address: wallet ? wallet.address : null
                    }
                };
                // Mencoba mengirim data wallet ke dalam iframe
                frame.contentWindow.postMessage(msg, "*");
            };
        }

        // Start
        window.onload = init;
        
        window.copyAddr = () => {
            if(wallet) navigator.clipboard.writeText(wallet.address);
            alert("Disalin!");
        }
    </script>
</body>
</html>
