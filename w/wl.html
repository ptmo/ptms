<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA SECURE SOLANA VAULT (ESM VERSION)</title>
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --accent: #38bdf8; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        input, textarea { width: 90%; padding: 12px; background: #000; color: var(--accent); border: 1px solid #475569; border-radius: 6px; margin: 10px 0; font-family: inherit; }
        button { background: var(--accent); color: #000; padding: 12px 24px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; border-radius: 6px; margin: 5px; }
        button:hover { opacity: 0.9; }
        #status-banner { background: var(--success); color: #000; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        .blur-text { filter: blur(5px); cursor: pointer; transition: 0.3s; }
        .blur-text:hover { filter: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõ°Ô∏è SOLANA VAULT (MODERN ESM)</h1>
    
    <div id="status-banner">
        ‚ö° SYSTEM READY (ES MODULES)
    </div>

    <div id="login-panel" class="section">
        <div style="margin: 20px 0;">
            <button id="btn-create">GENERATE NEW WALLET</button>
            <p>- ATAU -</p>
            <textarea id="input-phrase" placeholder="Paste Seed Phrase (12/24 kata)..." rows="3"></textarea>
            <button id="btn-import">IMPORT WALLET</button>
        </div>
    </div>

    <div id="result-panel" class="section" style="display:none;">
        <h3 style="color:var(--success)">‚úÖ WALLET CONNECTED</h3>
        <div style="text-align:left; background:#000; padding:15px; border: 1px solid var(--accent); border-radius:8px;">
            <p><strong>Public Key:</strong></p>
            <p id="out-pub" style="color:#fff; word-break:break-all; font-size:1.1em;"></p>
            
            <p><strong>Phrase (Klik):</strong></p>
            <p id="out-priv" class="blur-text" style="color:var(--accent); word-break:break-all;"></p>
        </div>
        <div style="margin-top:20px;">
             <p>Saldo: <span id="sol-balance">Loading...</span></p>
        </div>
        <button onclick="location.reload()" style="background:var(--danger); color:white; margin-top:20px;">RESET / LOGOUT</button>
    </div>
</div>

<script type="module">
    // Kita import langsung dari ESM.SH (Mirror paling stabil untuk Deno/Browser)
    // PENTING: Jangan ubah URL ini, ini versi bundle khusus browser.
    import * as bip39 from 'https://esm.sh/bip39@3.1.0';
    import { Buffer } from 'https://esm.sh/buffer@6.0.3';
    import * as solanaWeb3 from 'https://esm.sh/@solana/web3.js@1.87.6';

    // Inisialisasi Buffer Global (Solana butuh ini)
    window.Buffer = Buffer;

    // Variabel Global
    const RPC_URL = "https://api.mainnet-beta.solana.com"; 

    // Event Listener (Harus di dalam module karena scope-nya terisolasi)
    document.getElementById('btn-create').addEventListener('click', createWallet);
    document.getElementById('btn-import').addEventListener('click', importWallet);

    async function createWallet() {
        try {
            // Generate Mnemonic Standard
            const mnemonic = bip39.generateMnemonic(); 
            document.getElementById('input-phrase').value = mnemonic;
            await processKey(mnemonic);
        } catch (e) {
            alert("Gagal generate: " + e.message);
        }
    }

    async function importWallet() {
        const input = document.getElementById('input-phrase').value.trim();
        if (!input) return alert("Input kosong!");
        await processKey(input);
    }

    async function processKey(mnemonic) {
        try {
            // Validasi Mnemonic dulu
            if (!bip39.validateMnemonic(mnemonic)) {
                return alert("Phrase tidak valid! Pastikan ejaan bahasa Inggris benar.");
            }

            // Proses ke Seed
            const seed = await bip39.mnemonicToSeed(mnemonic);
            
            // Derivasi (Native Solana Web3)
            // Menggunakan slice 32 byte pertama (Standard CLI / Simple)
            const seedSlice = seed.slice(0, 32); 
            const keypair = solanaWeb3.Keypair.fromSeed(seedSlice);

            // Tampilkan UI
            const pubKey = keypair.publicKey.toString();
            document.getElementById('out-pub').innerText = pubKey;
            document.getElementById('out-priv').innerText = mnemonic;
            
            document.getElementById('login-panel').style.display = 'none';
            document.getElementById('result-panel').style.display = 'block';

            // Cek Saldo
            fetchBalance(pubKey);

        } catch (e) {
            alert("Error Processing: " + e.message);
            console.error(e);
        }
    }

    async function fetchBalance(pubKeyStr) {
        try {
            const connection = new solanaWeb3.Connection(RPC_URL);
            const pubKey = new solanaWeb3.PublicKey(pubKeyStr);
            const balance = await connection.getBalance(pubKey);
            document.getElementById('sol-balance').innerText = (balance / 1000000000).toFixed(4) + " SOL";
        } catch (e) {
            document.getElementById('sol-balance').innerText = "Gagal koneksi RPC";
        }
    }

    console.log("System Ready via ES Modules.");
</script>

</body>
</html>
