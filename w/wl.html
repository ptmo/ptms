<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA SECURE SOLANA VAULT (FIXED)</title>
    
    <script src="https://bundle.run/buffer@6.0.3"></script>
    
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bip39js@1.0.1/bip39.js"></script>
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --accent: #14f195; --danger: #ef4444; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        #status-banner { padding: 15px; font-weight: bold; margin-bottom: 20px; border-radius: 8px; transition: 0.3s; }
        .online { background: var(--danger); color: white; animation: pulse 2s infinite; }
        .offline { background: var(--accent); color: black; }

        .section { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 20px; display: none; border: 1px solid #334155; }
        .active { display: block; }

        input, textarea { width: 90%; padding: 12px; background: #000; color: var(--accent); border: 1px solid #475569; border-radius: 6px; margin: 10px 0; font-family: inherit; }
        button { background: var(--accent); color: #000; padding: 12px 24px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; border-radius: 6px; margin: 5px; }
        button:disabled { background: #475569; cursor: not-allowed; opacity: 0.5; }
        button.danger { background: var(--danger); color: white; }

        .token-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #334155; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1> SOLANA SECURE VAULT</h1>
    
    <div id="status-banner" class="online">
        ‚ö†Ô∏è INTERNET TERDETEKSI! MATIKAN WIFI UNTUK AKSES BRANKAS.
    </div>

    <div id="secure-gate" class="section">
        <h2>üîê BRANKAS OFFLINE</h2>
        <p>Fitur ini hanya aktif jika internet MATI total.</p>
        
        <div style="margin: 20px 0;">
            <button onclick="createWallet()" id="btn-create">GENERATE NEW WALLET</button>
            <p>- ATAU -</p>
            <textarea id="input-phrase" placeholder="Paste Seed Phrase (12/24 kata) ATAU Private Key (Base58)..." rows="3"></textarea>
            <button onclick="importWallet()" id="btn-import">IMPORT & PROCESS</button>
        </div>

        <div id="result-area" style="display:none; text-align:left; background:black; padding:15px; border: 1px solid var(--accent);">
            <p style="color:yellow">‚ö†Ô∏è SALIN SEKARANG! DATA AKAN HILANG SAAT REFRESH.</p>
            <p><strong>Public Key (Address):</strong> <span id="out-pub" style="color:white"></span></p>
            <p><strong>Secret Data:</strong> <span id="out-priv" style="color:var(--accent); filter: blur(5px); cursor: pointer;" onclick="this.style.filter='none'">KLIK UNTUK LIHAT</span></p>
        </div>
    </div>

    <div id="dashboard" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üìà ASET DASHBOARD</h2>
            <button onclick="logout()" class="danger">LOGOUT / CLEAR RAM</button>
        </div>
        
        <div style="background:#000; padding:15px; border-radius:8px; margin-bottom:20px;">
            <small>Wallet Address:</small><br>
            <strong id="dash-pubkey" style="color:var(--accent); font-size:1.2em;">-</strong>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <div style="background:#334155; padding:15px; border-radius:8px;">
                <small>Total Balance (Est)</small>
                <h3 id="total-usd">$0.00</h3>
            </div>
            <div style="background:#334155; padding:15px; border-radius:8px;">
                <small>SOL Price</small>
                <h3 id="sol-price">Loading...</h3>
            </div>
        </div>
        <div id="token-list"></div>
    </div>
</div>

<script>
    // --- 0. SETUP AWAL (WAJIB) ---
    // Mengaktifkan Buffer agar bip39 bisa jalan di browser
    window.Buffer = buffer.Buffer;

    let userPublicKey = null; 
    const HELIUS_RPC = "https://api.mainnet-beta.solana.com";

    // --- HELPER: BASE58 DECODE MANUAL (Agar PK Import Jalan) ---
    // Kita tulis fungsi decode manual agar tidak perlu download library bs58 tambahan
    const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    function decodeBase58(string) {
        if (string.length === 0) return new Uint8Array(0);
        const bytes = [0];
        for (let i = 0; i < string.length; i++) {
            const char = string[i];
            const value = ALPHABET.indexOf(char);
            if (value === -1) throw new Error('Invalid Base58 character');
            for (let j = 0; j < bytes.length; j++) bytes[j] *= 58;
            bytes[0] += value;
            let carry = 0;
            for (let j = 0; j < bytes.length; j++) {
                bytes[j] += carry;
                carry = bytes[j] >> 8;
                bytes[j] &= 0xff;
            }
            while (carry) {
                bytes.push(carry & 0xff);
                carry >>= 8;
            }
        }
        for (let i = 0; i < string.length && string[i] === '1'; i++) bytes.push(0);
        return new Uint8Array(bytes.reverse());
    }

    // --- 1. DETEKSI NETWORK ---
    function updateNetworkStatus() {
        const banner = document.getElementById('status-banner');
        const gate = document.getElementById('secure-gate');
        const dash = document.getElementById('dashboard');
        const btns = document.querySelectorAll('#secure-gate button');

        if (navigator.onLine) {
            banner.className = 'online';
            banner.innerText = "‚ö†Ô∏è INTERNET ONLINE: INPUT KUNCI DIBLOKIR.";
            btns.forEach(b => b.disabled = true);
            
            if (userPublicKey) {
                gate.style.display = 'none';
                dash.style.display = 'block';
                fetchDashboardData();
            } else {
                gate.style.display = 'block'; 
                dash.style.display = 'none';
            }
        } else {
            banner.className = 'offline';
            banner.innerText = "‚úÖ INTERNET OFFLINE: MODE AMAN AKTIF.";
            btns.forEach(b => b.disabled = false);
            dash.style.display = 'none';
            gate.style.display = 'block';
        }
    }

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    updateNetworkStatus();

    // --- 2. LOGIKA CREATE & IMPORT ---
    async function createWallet() {
        if (typeof bip39 === 'undefined') return alert("Tunggu sebentar, library sedang loading atau koneksi CDN gagal. Coba refresh.");
        const mnemonic = bip39.generateMnemonic();
        processKey(mnemonic);
    }

    async function importWallet() {
        const input = document.getElementById('input-phrase').value.trim();
        if (!input) return alert("Masukkan Phrase atau Private Key!");
        processKey(input);
    }

    async function processKey(inputSecret) {
        try {
            let keypair;
            
            // CEK: Apakah Mnemonic (Ada spasi) atau Private Key (String panjang)?
            if (inputSecret.includes(" ")) {
                // --- CASE 1: MNEMONIC ---
                const seed = await bip39.mnemonicToSeed(inputSecret);
                // Derivasi simple (CLI Style)
                const seedSlice = seed.slice(0, 32); 
                keypair = solanaWeb3.Keypair.fromSeed(seedSlice);
            } else {
                // --- CASE 2: PRIVATE KEY (BASE58) ---
                try {
                    // Decode string Base58 menjadi array byte
                    const secretKey = decodeBase58(inputSecret);
                    keypair = solanaWeb3.Keypair.fromSecretKey(secretKey);
                } catch(err) {
                    throw new Error("Format Private Key Salah! Pastikan Base58 string.");
                }
            }

            userPublicKey = keypair.publicKey.toString();
            document.getElementById('out-pub').innerText = userPublicKey;
            document.getElementById('out-priv').innerText = inputSecret; // Tampilkan aslinya
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('input-phrase').value = ""; // Hapus input demi keamanan

            alert("‚úÖ BERHASIL! Wallet tersimpan di RAM.\n1. Catat Kunci Anda.\n2. Nyalakan Internet untuk melihat Dashboard.");

            // Wipe temporary variables
            keypair = null;

        } catch (e) {
            alert("GAGAL MEMPROSES WALLET:\n" + e.message);
        }
    }

    // --- 3. DASHBOARD LOGIC ---
    async function fetchDashboardData() {
        if (!navigator.onLine || !userPublicKey) return;

        document.getElementById('dash-pubkey').innerText = userPublicKey;
        const connection = new solanaWeb3.Connection(HELIUS_RPC);
        const pubKeyObj = new solanaWeb3.PublicKey(userPublicKey);

        // Ambil Saldo
        const balance = await connection.getBalance(pubKeyObj);
        const solBalance = balance / 1000000000;

        try {
            // Ambil Harga
            const priceRes = await fetch(`https://api.jup.ag/price/v2?ids=So11111111111111111111111111111111111111112`);
            const priceData = await priceRes.json();
            const solPrice = priceData.data['So11111111111111111111111111111111111111112'].price;

            document.getElementById('sol-price').innerText = `$${parseFloat(solPrice).toFixed(2)}`;
            const totalEst = solBalance * solPrice;
            document.getElementById('total-usd').innerText = `$${totalEst.toFixed(2)}`;
            
            document.getElementById('token-list').innerHTML = `
                <div class="token-item">
                    <span><strong>SOL</strong></span>
                    <div style="text-align:right">
                        <div>${solBalance.toFixed(4)} SOL</div>
                        <div style="font-size:0.8em; color:#94a3b8">$${totalEst.toFixed(2)}</div>
                    </div>
                </div>`;
        } catch (e) { console.error("Harga gagal", e); }
    }

    function logout() { location.reload(); }
</script>

</body>
</html>
