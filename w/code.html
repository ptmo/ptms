<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Obusion Cloud IDE</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-sidebar: #1e1f29;
            --bg-editor: #282a36;
            --bg-header: #191a21;
            --accent: #bd93f9;
            --text-main: #f8f8f2;
            --text-muted: #6272a4;
            --border: #44475a;
            --folder: #f1fa8c;
            --html: #ffb86c;
            --css: #8be9fd;
            --js: #f1fa8c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg-editor); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .ide-header {
            height: 45px; background: var(--bg-header); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0;
        }
        .brand { font-weight: 700; font-size: 0.9rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;}
        .brand i { color: var(--accent); }
        
        .header-actions button {
            background: var(--accent); color: #282a36; border: none;
            padding: 5px 12px; border-radius: 4px; font-weight: 600; font-size: 0.8rem;
            cursor: pointer; display: flex; align-items: center; gap: 6px;
        }

        /* LAYOUT UTAMA */
        .ide-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* SIDEBAR (File Explorer) */
        .sidebar {
            width: 240px; background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; transition: transform 0.3s ease;
            position: absolute; z-index: 10; height: 100%; top: 0; left: 0;
            /* Di HP default hidden (slide out) */
            transform: translateX(-100%); 
        }
        
        /* Sidebar Toggle untuk Mobile */
        .sidebar.open { transform: translateX(0); box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
        
        /* Tampilan Desktop: Sidebar selalu muncul */
        @media (min-width: 768px) {
            .sidebar { position: relative; transform: translateX(0); width: 220px; box-shadow: none; }
            .mobile-toggle { display: none; }
        }

        .sidebar-header {
            padding: 10px 15px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-actions i { cursor: pointer; margin-left: 10px; transition: color 0.2s; }
        .sidebar-actions i:hover { color: var(--text-main); }

        .file-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .file-item {
            padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; color: #dcdcdc; border-left: 2px solid transparent;
            transition: background 0.1s;
        }
        .file-item:hover { background: rgba(255,255,255,0.05); }
        .file-item.active { background: rgba(189, 147, 249, 0.1); border-left-color: var(--accent); color: white; }
        
        .file-icon { width: 16px; text-align: center; }
        .fa-html5 { color: var(--html); }
        .fa-css3-alt { color: var(--css); }
        .fa-js { color: var(--js); }
        .fa-folder { color: var(--folder); }

        /* EDITOR AREA */
        .editor-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-editor); min-width: 0; }
        
        .tab-bar {
            height: 35px; background: var(--bg-sidebar); display: flex; align-items: center;
            border-bottom: 1px solid var(--border); overflow-x: auto;
        }
        .file-tab {
            padding: 0 15px; height: 100%; display: flex; align-items: center; gap: 8px;
            font-size: 0.8rem; color: var(--text-muted); border-right: 1px solid var(--border);
            cursor: pointer; background: var(--bg-sidebar); min-width: 100px;
        }
        .file-tab.active { background: var(--bg-editor); color: var(--text-main); border-top: 2px solid var(--accent); }
        .file-tab i { font-size: 0.7rem; }

        /* CodeMirror Full Height */
        .CodeMirror { height: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; background: transparent !important; }
        .CodeMirror-gutters { background: var(--bg-editor) !important; border-right: 1px solid var(--border); }

        /* Mobile Sidebar Toggle Button */
        .mobile-toggle {
            font-size: 1.2rem; color: var(--text-muted); cursor: pointer; margin-right: 15px;
        }
    </style>
</head>
<body>

    <header class="ide-header">
        <div style="display:flex; align-items:center;">
            <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
            <div class="brand"><i class="fas fa-cloud"></i> OBUSION <span>CLOUD</span></div>
        </div>
        <div class="header-actions">
            <button onclick="runProject()"><i class="fas fa-play"></i> <span style="margin-left:5px; display:none; @media(min-width:768px){display:inline;}">Run Live</span></button>
        </div>
    </header>

    <div class="ide-body">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>Explorer</span>
                <div class="sidebar-actions">
                    <i class="fas fa-file-circle-plus" onclick="createNewFile()" title="New File"></i>
                    <i class="fas fa-folder-plus" title="New Folder"></i>
                </div>
            </div>
            <ul class="file-list" id="fileList">
                </ul>
        </aside>

        <main class="editor-area">
            <div class="tab-bar">
                <div class="file-tab active">
                    <i class="fab fa-html5" style="color:var(--html)"></i> 
                    <span id="activeFileName">index.html</span>
                </div>
            </div>
            
            <textarea id="codeEditor"></textarea>
        </main>
    </div>

    <script type="module">
    // 1. IMPORT FIREBASE (Tambah writeBatch dan getDocs)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, writeBatch, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 2. CONFIG ANDA
    const firebaseConfig = {
        apiKey: "AIzaSyCkXEEgB8fbEuxjVmzPqSL7K7oHnmnvDLs",
        authDomain: "obusioncode.firebaseapp.com",
        projectId: "obusioncode",
        storageBucket: "obusioncode.firebasestorage.app",
        messagingSenderId: "299520822295",
        appId: "1:299520822295:web:f222448979129ae6c2a052",
        measurementId: "G-B0CYQSNM7R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const PROJECT_ID = "global_workspace"; 

    // --- VARIABLES ---
    let files = [];
    let activeFileId = null;
    let isTyping = false;

    // --- SETUP EDITOR ---
    const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        autoCloseTags: true,
        autoCloseBrackets: true,
        styleActiveLine: true,
        mode: 'htmlmixed'
    });

    // --- 3. FUNGSI CRUD FIREBASE ---

    // A. READ (REALTIME LISTENER)
    const q = query(collection(db, "projects", PROJECT_ID, "files"), orderBy("createdAt"));
    
    onSnapshot(q, (snapshot) => {
        files = [];
        const list = document.getElementById('fileList');
        list.innerHTML = '';

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const fileObj = { id: docSnap.id, ...data };
            files.push(fileObj);

            const li = document.createElement('li');
            li.className = `file-item ${fileObj.id === activeFileId ? 'active' : ''}`;
            
            // LOGIC DELETE FILE (Menghapus Satu File)
            const delBtn = `<i class="fas fa-trash" title="Hapus File Ini" style="margin-left:auto; font-size:0.7rem; color:#ff5555; cursor:pointer;" onclick="window.deleteFile('${fileObj.id}', event)"></i>`;
            
            let iconClass = 'fa-file';
            if(data.type === 'html') iconClass = 'fab fa-html5';
            else if(data.type === 'css') iconClass = 'fab fa-css3-alt';
            else if(data.type === 'js') iconClass = 'fab fa-js';

            li.innerHTML = `
                <div class="file-icon"><i class="${iconClass}"></i></div>
                <span onclick="window.switchFile('${fileObj.id}')" style="flex:1">${data.name}</span>
                ${delBtn}
            `;
            list.appendChild(li);

            if (activeFileId === fileObj.id && !isTyping) {
                const cursor = editor.getCursor();
                if(editor.getValue() !== data.content) {
                    editor.setValue(data.content);
                    editor.setCursor(cursor);
                }
            }
        });

        // Update Header Sidebar (Tambahkan Tombol Hapus Folder/Project)
        // Pastikan di HTML ada elemen dengan class .sidebar-actions
        const sidebarActions = document.querySelector('.sidebar-actions');
        if(sidebarActions) {
            // Cek biar tombol tidak dobel
            if(!document.getElementById('btnDeleteAll')) {
                const btnDeleteAll = document.createElement('i');
                btnDeleteAll.id = 'btnDeleteAll';
                btnDeleteAll.className = 'fas fa-trash-alt';
                btnDeleteAll.style.color = '#ff5555';
                btnDeleteAll.style.marginLeft = '10px';
                btnDeleteAll.title = 'Hapus SEMUA File (Format Database)';
                btnDeleteAll.onclick = window.deleteProject; // Panggil fungsi delete semua
                sidebarActions.appendChild(btnDeleteAll);
            }
        }

        if (!activeFileId && files.length > 0) {
            window.switchFile(files[0].id);
        } else if (files.length === 0) {
            editor.setValue(""); // Kosongkan editor jika tidak ada file
            activeFileId = null;
        }
    });

    // B. CREATE (TAMBAH FILE)
    window.createNewFile = async function() {
        const name = prompt("Nama File (contoh: index.html):");
        if (!name) return;

        const ext = name.split('.').pop();
        let type = 'html';
        if (ext === 'css') type = 'css';
        else if (ext === 'js') type = 'js';

        try {
            await addDoc(collection(db, "projects", PROJECT_ID, "files"), {
                name: name,
                type: type,
                content: "// New File: " + name,
                createdAt: serverTimestamp()
            });
        } catch (e) {
            alert("Gagal membuat file: " + e.message);
        }
    };

    // C. UPDATE (AUTO SAVE)
    let saveTimeout;
    editor.on('change', (cm, change) => {
        if (change.origin === 'setValue') return;
        
        isTyping = true;
        clearTimeout(saveTimeout);
        
        saveTimeout = setTimeout(async () => {
            if (activeFileId) {
                const content = editor.getValue();
                const fileRef = doc(db, "projects", PROJECT_ID, "files", activeFileId);
                document.querySelector('.ide-header').style.borderBottomColor = '#f1fa8c';
                await updateDoc(fileRef, { content: content });
                document.querySelector('.ide-header').style.borderBottomColor = '#44475a';
                isTyping = false;
            }
        }, 1000);
    });

    // D. DELETE SINGLE FILE (Hapus 1 File)
    window.deleteFile = async function(id, event) {
        event.stopPropagation();
        if(confirm("Yakin hapus file ini dari Database? Data hilang permanen.")) {
            try {
                // INI PERINTAH HAPUS DARI FIREBASE
                await deleteDoc(doc(db, "projects", PROJECT_ID, "files", id));
                
                // Jika file yang dibuka dihapus, kosongkan editor
                if(activeFileId === id) {
                    editor.setValue("");
                    activeFileId = null;
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        }
    };

    // E. DELETE PROJECT FOLDER (Hapus SEMUA File) - FITUR BARU
    window.deleteProject = async function() {
        if(files.length === 0) return alert("Folder sudah kosong.");
        
        const konfirmasi = prompt("KETIK 'HAPUS' untuk menghapus SEMUA file di database. Ini akan membersihkan folder project.");
        
        if(konfirmasi === 'HAPUS') {
            try {
                const batch = writeBatch(db); // Pakai Batch biar cepat
                const allFiles = await getDocs(collection(db, "projects", PROJECT_ID, "files"));
                
                allFiles.forEach((document) => {
                    batch.delete(document.ref);
                });

                await batch.commit(); // Eksekusi hapus massal
                
                editor.setValue("");
                activeFileId = null;
                alert("Folder Project berhasil dibersihkan!");
            } catch (e) {
                alert("Gagal reset project: " + e.message);
            }
        }
    };

    // F. SWITCH FILE
    window.switchFile = function(id) {
        activeFileId = id;
        const file = files.find(f => f.id === id);
        if (!file) return;

        isTyping = true;
        editor.setValue(file.content);
        isTyping = false;
        document.getElementById('activeFileName').innerText = file.name;

        if(file.type === 'html') editor.setOption('mode', 'htmlmixed');
        else if(file.type === 'css') editor.setOption('mode', 'css');
        else if(file.type === 'js') editor.setOption('mode', 'javascript');

        const listItems = document.querySelectorAll('.file-item');
        files.forEach((f, index) => {
            if(f.id === id) listItems[index].classList.add('active');
            else listItems[index].classList.remove('active');
        });

        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.remove('open');
        }
    };

    // RUN PROJECT
    window.runProject = function() {
        const htmlFile = files.find(f => f.type === 'html');
        const cssFile = files.find(f => f.type === 'css');
        const jsFile = files.find(f => f.type === 'js');

        if(!htmlFile) { alert("Butuh setidaknya 1 file HTML"); return; }

        let finalHTML = htmlFile.content;
        if(cssFile) finalHTML += `<style>${cssFile.content}</style>`;
        if(jsFile) finalHTML += `<script>${jsFile.content}<\/script>`;

        const blob = new Blob([finalHTML], {type: 'text/html'});
        window.open(URL.createObjectURL(blob), '_blank');
    };
        </script>

    <script>
        

        // --- 2. INIT EDITOR ---
        const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            styleActiveLine: true,
            mode: 'htmlmixed' // Default mode
        });

        // Event: Saat ngetik, simpan ke variable 'files' (Memory)
        editor.on('change', () => {
            const currentFile = files.find(f => f.id === activeFileId);
            if(currentFile) currentFile.content = editor.getValue();
            // Nanti di sini tambahkan: saveToFirebase(currentFile);
        });

        // --- 3. RENDER FILE EXPLORER ---
        function renderExplorer() {
            const list = document.getElementById('fileList');
            list.innerHTML = '';

            files.forEach(file => {
                const li = document.createElement('li');
                li.className = `file-item ${file.id === activeFileId ? 'active' : ''}`;
                li.onclick = () => openFile(file.id);
                
                // Icon Logic
                let iconClass = 'fa-file';
                if(file.type === 'html') iconClass = 'fab fa-html5';
                else if(file.type === 'css') iconClass = 'fab fa-css3-alt';
                else if(file.type === 'js') iconClass = 'fab fa-js';

                li.innerHTML = `
                    <div class="file-icon"><i class="${iconClass}"></i></div>
                    <span>${file.name}</span>
                `;
                list.appendChild(li);
            });
        }

        // --- 4. OPEN FILE LOGIC (INTI SISTEM) ---
        function openFile(id) {
            activeFileId = id;
            const file = files.find(f => f.id === id);
            
            // Update Tab Name
            document.getElementById('activeFileName').innerText = file.name;

            // Ganti Mode Editor (Syntax Highlight)
            if(file.type === 'html') editor.setOption('mode', 'htmlmixed');
            else if(file.type === 'css') editor.setOption('mode', 'css');
            else if(file.type === 'js') editor.setOption('mode', 'javascript');

            // Isi Editor dengan konten file
            editor.setValue(file.content);

            // Refresh UI Sidebar
            renderExplorer();
            
            // Tutup Sidebar di Mobile setelah pilih file
            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- 5. CREATE NEW FILE ---
        function createNewFile() {
            const name = prompt("Enter file name (e.g., about.html):");
            if(!name) return;

            const ext = name.split('.').pop();
            let type = 'html';
            if(ext === 'css') type = 'css';
            else if(ext === 'js') type = 'js';

            const newFile = {
                id: Date.now().toString(), // ID unik sementara
                name: name,
                type: type,
                content: ''
            };
            
            files.push(newFile);
            renderExplorer();
            openFile(newFile.id);
            // Nanti di sini: createInFirebase(newFile);
        }

        // --- 6. RUN PROJECT (BUNDLE LOGIC) ---
        function runProject() {
            // Kita harus menggabungkan file-file ini secara manual karena tidak ada server
            const htmlFile = files.find(f => f.name === 'index.html');
            const cssFile = files.find(f => f.name === 'style.css');
            const jsFile = files.find(f => f.name === 'script.js');

            if(!htmlFile) { alert("Error: index.html not found!"); return; }

            let finalHTML = htmlFile.content;

            // Inject CSS (Gantikan <link> dengan <style>)
            if(cssFile) {
                finalHTML = finalHTML.replace(
                    /<link rel="stylesheet" href="style.css">/, 
                    `<style>${cssFile.content}</style>`
                );
            }

            // Inject JS (Gantikan <script src> dengan <script inline>)
            if(jsFile) {
                finalHTML = finalHTML.replace(
                    /<script src="script.js"><\/script>/, 
                    `<script>${jsFile.content}<\/script>`
                );
            }

            // Buka di Tab Baru / Iframe
            const blob = new Blob([finalHTML], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }

        // Sidebar Toggle Mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // --- INIT ---
        // Buka file pertama saat load
        openFile('1');

    </script>
</body>
</html>
