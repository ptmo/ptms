<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Obusion Cloud IDE | Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-sidebar: #1e1f29; --bg-editor: #282a36; --bg-header: #191a21;
            --accent: #bd93f9; --text-main: #f8f8f2; --text-muted: #6272a4; --border: #44475a;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-editor); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .ide-header {
            height: 50px; background: var(--bg-header); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0;
        }
        .brand { font-weight: 700; color: var(--accent); display: flex; gap: 10px; align-items: center; }
        .user-profile { display: flex; gap: 10px; align-items: center; }
        .user-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--accent); display: none; }

        /* BODY LAYOUT */
        .ide-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; user-select: none;
            position: absolute; z-index: 10; height: 100%; top: 0; left: 0; transform: translateX(-100%); transition: transform 0.3s;
        }
        .sidebar.open { transform: translateX(0); }
        @media (min-width: 768px) { .sidebar { position: relative; transform: translateX(0); width: 240px; } }

        .sidebar-header {
            padding: 15px; font-size: 0.8rem; font-weight: bold; color: var(--text-muted);
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);
        }
        .sidebar-actions i { cursor: pointer; margin-left: 8px; transition: 0.2s; }
        .sidebar-actions i:hover { color: white; }

        /* TREE VIEW */
        .file-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .file-tree, .folder-content { list-style: none; padding: 0; margin: 0; }
        
        .tree-item {
            padding: 6px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; color: #dcdcdc; border-left: 2px solid transparent;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .tree-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .tree-item.active { background: rgba(189, 147, 249, 0.1); border-left-color: var(--accent); color: white; }

        /* FOLDER LOGIC */
        .folder-content { display: none; }
        .folder-open > .folder-content { display: block; }
        .folder-arrow { font-size: 0.7rem; transition: 0.2s; width: 12px; text-align: center; }
        .folder-open > .tree-item > .folder-arrow { transform: rotate(90deg); color: var(--text-main); }

        /* KEBAB MENU (TITIK TIGA) */
        .kebab-btn { margin-left: auto; padding: 2px 5px; opacity: 0; transition: 0.2s; color: var(--text-muted); }
        .tree-item:hover .kebab-btn { opacity: 1; }
        .kebab-btn:hover { color: white; background: rgba(255,255,255,0.1); border-radius: 4px; }

        /* CONTEXT MENU DROPDOWN */
        #contextMenu {
            position: fixed; z-index: 9999; background: #282a36; border: 1px solid var(--border);
            border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; flex-direction: column;
            min-width: 160px;
        }
        #contextMenu.visible { display: flex; }
        .ctx-item {
            padding: 10px 15px; font-size: 0.85rem; cursor: pointer; display: flex; gap: 10px; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .ctx-item:hover { background: var(--accent); color: #282a36; }
        .ctx-item:last-child { color: #ff5555; }
        .ctx-item:last-child:hover { background: #ff5555; color: white; }

        /* EDITOR */
        .editor-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .tab-bar { height: 35px; background: var(--bg-sidebar); display: flex; align-items: center; border-bottom: 1px solid var(--border); }
        .file-tab { padding: 0 15px; height: 100%; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; background: var(--bg-editor); border-top: 2px solid var(--accent); }
        .CodeMirror { height: 100%; font-family: 'JetBrains Mono', monospace; background: transparent !important; }
        
        /* LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-editor); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #loginScreen.hidden { display: none; }
        .login-btn { padding: 10px 20px; background: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; display: flex; gap: 10px; align-items: center; }
        
        /* UTILS */
        #fileImporter, #folderImporter { display: none; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div style="text-align:center;">
            <h2 style="color:var(--accent)">Obusion Cloud</h2>
            <button class="login-btn" onclick="window.loginGoogle()">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
        </div>
    </div>

    <header class="ide-header">
        <div class="brand">
            <i class="fas fa-bars" onclick="toggleSidebar()" style="cursor:pointer; @media(min-width:768px){display:none;}"></i>
            <i class="fas fa-code"></i> OBUSION
        </div>
        <div class="user-profile">
            <img id="userAvatar" class="user-avatar">
            <button onclick="window.logoutGoogle()" style="background:none; border:1px solid var(--border); color:white; padding:5px 10px; cursor:pointer; border-radius:4px;">Logout</button>
            <button onclick="window.runProject()" style="background:var(--accent); border:none; padding:5px 15px; border-radius:4px; font-weight:bold; cursor:pointer;"><i class="fas fa-play"></i></button>
        </div>
    </header>

    <div class="ide-body">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>EXPLORER</span>
                <div class="sidebar-actions">
                    <i class="fas fa-file-circle-plus" onclick="window.createNewFile('')" title="New File (Root)"></i>
                    <i class="fas fa-folder-plus" onclick="window.createNewFolder('')" title="New Folder (Root)"></i>
                    <i class="fas fa-trash-alt" style="color:#ff5555" onclick="window.deleteProject()" title="Delete All"></i>
                </div>
            </div>

            <div id="fileTreeRoot" class="file-list" onclick="window.hideContextMenu()"></div>

            <input type="file" id="fileImporter" multiple onchange="window.processFileImport(this.files)">
            <input type="file" id="folderImporter" webkitdirectory directory onchange="window.processFolderImport(this.files)">
        </aside>

        <main class="editor-area">
            <div class="tab-bar">
                <div class="file-tab">
                    <span id="activeFileName">No File</span>
                </div>
            </div>
            <textarea id="codeEditor"></textarea>
        </main>
    </div>

    <div id="contextMenu">
        <div class="ctx-item" onclick="window.ctxAction('newFile')"><i class="fas fa-file-plus"></i> New File Here</div>
        <div class="ctx-item" onclick="window.ctxAction('newFolder')"><i class="fas fa-folder-plus"></i> New Folder Here</div>
        <div class="ctx-item" onclick="window.ctxAction('importFile')"><i class="fas fa-file-import"></i> Import File Here</div>
        <div class="ctx-item" onclick="window.ctxAction('delete')"><i class="fas fa-trash"></i> Delete Folder</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCkXEEgB8fbEuxjVmzPqSL7K7oHnmnvDLs",
            authDomain: "obusioncode.firebaseapp.com",
            projectId: "obusioncode",
            storageBucket: "obusioncode.firebasestorage.app",
            messagingSenderId: "299520822295",
            appId: "1:299520822295:web:f222448979129ae6c2a052",
            measurementId: "G-B0CYQSNM7R"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const PROJECT_ID = "global_workspace"; 

        // --- VARIABLES ---
        let files = [];
        let activeFileId = null;
        let isTyping = false;
        let expandedPaths = new Set();
        let currentCtxPath = ''; // Path folder yg lagi diklik kanan

        // --- EDITOR ---
        const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
            theme: 'dracula', lineNumbers: true, mode: 'htmlmixed',
            autoCloseTags: true, autoCloseBrackets: true, lineWrapping: true
        });

        // --- AUTH SYSTEM ---
        onAuthStateChanged(auth, (user) => {
            const screen = document.getElementById('loginScreen');
            if(user) {
                screen.classList.add('hidden');
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('userAvatar').style.display = 'block';
                startListener();
            } else {
                screen.classList.remove('hidden');
            }
        });

        // Bind Window Functions (Agar bisa dipanggil HTML)
        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logoutGoogle = () => signOut(auth);
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

        // --- CORE: TREE LISTENER ---
        function startListener() {
            const q = query(collection(db, "projects", PROJECT_ID, "files"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                files = [];
                snapshot.forEach(doc => files.push({id: doc.id, ...doc.data()}));
                renderTree();
            });
        }

        // --- RENDERER (POHON FILE) ---
        function renderTree() {
            const container = document.getElementById('fileTreeRoot');
            container.innerHTML = '';
            
            // 1. Build Object Tree
            const tree = {};
            files.forEach(file => {
                const parts = file.name.split('/');
                let current = tree;
                parts.forEach((part, i) => {
                    if (!current[part]) current[part] = (i === parts.length - 1) ? { __data: file, __children: {} } : { __children: {} };
                    current = current[part].__children;
                });
            });

            // 2. Build HTML
            function buildHTML(node, parentEl, pathPrefix = '', depth = 0) {
                // Sort: Folder First
                const keys = Object.keys(node).sort((a,b) => {
                    const isFolderA = Object.keys(node[a].__children).length > 0 || node[a].__data?.type === 'folder';
                    const isFolderB = Object.keys(node[b].__children).length > 0 || node[b].__data?.type === 'folder';
                    if(isFolderA && !isFolderB) return -1;
                    if(!isFolderA && isFolderB) return 1;
                    return a.localeCompare(b);
                });

                keys.forEach(key => {
                    if(key === '__data' || key === '__children') return;
                    
                    const item = node[key];
                    const fileData = item.__data || {};
                    const currentPath = pathPrefix ? `${pathPrefix}/${key}` : key;
                    const isFolder = Object.keys(item.__children).length > 0 || fileData.type === 'folder';

                    const li = document.createElement('li');
                    if(isFolder && expandedPaths.has(currentPath)) li.classList.add('folder-open');

                    // Icon Setup
                    let icon = isFolder ? '<i class="fas fa-folder" style="color:#f1fa8c"></i>' : '<i class="fas fa-file" style="color:#8be9fd"></i>';
                    if(!isFolder) {
                        if(fileData.type === 'html') icon = '<i class="fab fa-html5" style="color:#ffb86c"></i>';
                        else if(fileData.type === 'css') icon = '<i class="fab fa-css3-alt" style="color:#8be9fd"></i>';
                        else if(fileData.type === 'js') icon = '<i class="fab fa-js" style="color:#f1fa8c"></i>';
                    }

                    const arrow = isFolder ? `<i class="fas fa-chevron-right folder-arrow"></i>` : `<span style="width:12px"></span>`;
                    
                    // ACTIONS (Titik Tiga untuk Folder, Sampah untuk File)
                    let actionBtn = '';
                    if(isFolder) {
                        actionBtn = `<i class="fas fa-ellipsis-v kebab-btn" onclick="window.showContextMenu(event, '${currentPath}')"></i>`;
                    } else {
                        actionBtn = `<i class="fas fa-trash kebab-btn" style="color:#ff5555" onclick="window.deleteItem('${fileData.id}', event)"></i>`;
                    }

                    const div = document.createElement('div');
                    div.className = `tree-item ${fileData.id === activeFileId ? 'active' : ''}`;
                    div.style.paddingLeft = `${10 + (depth * 12)}px`;
                    div.innerHTML = `${arrow} ${icon} <span style="margin-left:5px">${key}</span> ${actionBtn}`;

                    div.onclick = (e) => {
                        e.stopPropagation(); window.hideContextMenu();
                        if(isFolder) {
                            li.classList.toggle('folder-open');
                            if(li.classList.contains('folder-open')) expandedPaths.add(currentPath); else expandedPaths.delete(currentPath);
                        } else {
                            window.switchFile(fileData.id);
                        }
                    };

                    li.appendChild(div);

                    if(isFolder) {
                        const ul = document.createElement('ul');
                        ul.className = 'folder-content';
                        buildHTML(item.__children, ul, currentPath, depth + 1);
                        li.appendChild(ul);
                    }
                    parentEl.appendChild(li);
                });
            }
            const rootUl = document.createElement('ul');
            rootUl.className = 'file-tree';
            buildHTML(tree, rootUl);
            container.appendChild(rootUl);
        }

        // --- CONTEXT MENU LOGIC ---
        window.showContextMenu = (e, path) => {
            e.stopPropagation();
            currentCtxPath = path;
            const menu = document.getElementById('contextMenu');
            menu.style.top = e.clientY + 'px';
            menu.style.left = (e.clientX - 120) + 'px';
            menu.classList.add('visible');
        };

        window.hideContextMenu = () => document.getElementById('contextMenu').classList.remove('visible');

        window.ctxAction = (action) => {
            window.hideContextMenu();
            if(action === 'newFile') window.createNewFile(currentCtxPath);
            if(action === 'newFolder') window.createNewFolder(currentCtxPath);
            if(action === 'importFile') {
                const input = document.getElementById('fileImporter');
                input.setAttribute('data-target', currentCtxPath); // Simpan target folder
                input.click();
            }
            if(action === 'delete') window.deleteFolder(currentCtxPath);
        };

        // --- SMART CREATE (PATH AWARE) ---
        window.createNewFile = async (basePath = '') => {
            const fileName = prompt(`Buat file baru di "${basePath || 'Root'}":\n(Contoh: index.html)`);
            if(!fileName) return;
            const fullPath = basePath ? `${basePath}/${fileName}` : fileName;
            const ext = fileName.split('.').pop();
            let type = 'txt';
            if(['html','htm'].includes(ext)) type = 'html';
            else if(['css'].includes(ext)) type = 'css';
            else if(['js','ts'].includes(ext)) type = 'js';

            await addDoc(collection(db, "projects", PROJECT_ID, "files"), {
                name: fullPath, type: type, content: '// ' + fileName, createdAt: serverTimestamp()
            });
        };

        window.createNewFolder = async (basePath = '') => {
            const name = prompt(`Buat folder baru di "${basePath || 'Root'}":`);
            if(!name) return;
            const fullPath = basePath ? `${basePath}/${name}` : name;
            await addDoc(collection(db, "projects", PROJECT_ID, "files"), {
                name: fullPath, type: 'folder', content: '', createdAt: serverTimestamp()
            });
        };

        // --- IMPORT LOGIC (SEPARATE) ---
        // 1. IMPORT FILE (Targeted to Folder)
        window.processFileImport = async (fileList) => {
            const target = document.getElementById('fileImporter').getAttribute('data-target') || '';
            if(!fileList.length) return;
            const batch = writeBatch(db);
            for(let i=0; i<fileList.length; i++) {
                const file = fileList[i];
                const fullPath = target ? `${target}/${file.name}` : file.name;
                const content = await readFile(file);
                const ref = doc(collection(db, "projects", PROJECT_ID, "files"));
                batch.set(ref, { name: fullPath, type: 'txt', content: content, createdAt: serverTimestamp() });
            }
            await batch.commit();
            alert("File Import Selesai!");
            document.getElementById('fileImporter').value = '';
        };

        // 2. IMPORT FOLDER (Full Structure)
        window.processFolderImport = async (fileList) => {
            if(!fileList.length) return;
            const batch = writeBatch(db);
            let count = 0;
            for(let i=0; i<fileList.length; i++) {
                const file = fileList[i];
                if(file.name.startsWith('.')) continue;
                const fullPath = file.webkitRelativePath || file.name;
                const content = await readFile(file);
                const ref = doc(collection(db, "projects", PROJECT_ID, "files"));
                batch.set(ref, { name: fullPath, type: 'txt', content: content, createdAt: serverTimestamp() });
                count++;
            }
            await batch.commit();
            alert(`Berhasil import ${count} file dari folder!`);
            document.getElementById('folderImporter').value = '';
        };

        // --- DELETE LOGIC ---
        window.deleteItem = async (id, e) => {
            e.stopPropagation();
            if(confirm("Hapus File ini?")) deleteDoc(doc(db, "projects", PROJECT_ID, "files", id));
        };

        window.deleteFolder = async (pathName) => {
            if(confirm(`HAPUS FOLDER "${pathName}" dan semua isinya?`)) {
                const batch = writeBatch(db);
                files.forEach(f => {
                    if(f.name.startsWith(pathName + '/') || f.name === pathName) {
                        batch.delete(doc(db, "projects", PROJECT_ID, "files", f.id));
                    }
                });
                await batch.commit();
            }
        };

        window.deleteProject = async () => {
            if(files.length === 0) return;
            if(prompt("Ketik 'HAPUS' untuk Reset Project:") === 'HAPUS') {
                const batch = writeBatch(db);
                const snap = await getDocs(collection(db, "projects", PROJECT_ID, "files"));
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }
        };

        // --- HELPER ---
        window.switchFile = (id) => {
            activeFileId = id;
            const file = files.find(f => f.id === id);
            if(file) {
                editor.setValue(file.content);
                document.getElementById('activeFileName').innerText = file.name;
                if(file.type === 'html') editor.setOption('mode', 'htmlmixed');
                else if(file.type === 'css') editor.setOption('mode', 'css');
                else if(file.type === 'js') editor.setOption('mode', 'javascript');
                
                isTyping = true; setTimeout(() => isTyping = false, 100);
                renderTree(); // refresh active class
                if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
            }
        };

        window.runProject = () => {
            const html = files.find(f => f.type === 'html' || f.name.endsWith('.html'));
            if(!html) return alert("Butuh setidaknya satu file HTML!");
            
            // Basic Bundle Logic (Bisa dikembangkan lagi)
            let content = html.content;
            const css = files.filter(f => f.type === 'css').map(f => f.content).join('\n');
            const js = files.filter(f => f.type === 'js').map(f => f.content).join('\n');
            
            content += `<style>${css}</style><script>${js}<\/script>`;
            const win = window.open();
            win.document.write(content);
        };

        function readFile(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => r(e.target.result);
                reader.readAsText(file);
            });
        }

        // Auto Save
        let saveTimeout;
        editor.on('change', () => {
            if(isTyping) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                if(activeFileId) updateDoc(doc(db, "projects", PROJECT_ID, "files", activeFileId), { content: editor.getValue() });
            }, 1000);
        });
    </script>
</body>
</html>
