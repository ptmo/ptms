<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Publik - Galeri Nusantara</title>
    <link rel="icon" href="img/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
    /* Style tetap sama persis seperti punya Anda, saya ringkas biar rapi */
    * { box-sizing: border-box; }
    body { font-family: 'Rubik', sans-serif; background: #fff; margin: 0; color: #666; }
    .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: #f6f9ff;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .nav-left { display: flex; align-items: center; gap: 15px; }
        
        .nav-logo {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 2px solid #7385a5;
            object-fit: cover;
        }
    .container { width: 95%; max-width: 800px; margin: 40px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    
    #btn-connect { background: transparent; color: #7385a5; border: 2px solid #7385a5; padding: 10px 25px; cursor: pointer; font-weight: bold; border-radius: 30px; transition: 0.3s; }
    #btn-connect.connected { background: #abb6c9; color: #fff; border-color: #7385a5; cursor: default; }
    
    .header { border-bottom: 2px solid #f1f1f1; padding-bottom: 15px; margin-bottom: 25px; }
    h3 { color: #7385a5; margin: 0; }
    
    label { font-weight: 600; font-size: 14px; display: block; margin-top: 20px; color: #555; }
    input, select, textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    input:focus, select:focus, textarea:focus { border-color: #7385a5; outline: none; }
    
    fieldset { border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    legend { font-weight: bold; color: #7385a5; padding: 0 10px; }
    
    .btn-action { background: #fff; color: #7385a5; padding: 15px; border: 2px solid #7385a5; width: 100%; max-width: 300px; cursor: pointer; border-radius: 25px; margin: 20px auto; display: block; font-weight: bold; transition: 0.3s; }
    .btn-action:hover { background: #7385a5; color: #fff; transform: translateY(-2px); }

    /* Toast CSS */
    #toast { visibility: hidden; min-width: 250px; background: #333; color: #fff; text-align: center; border-radius: 8px; padding: 15px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); display: flex; align-items: center; gap: 10px; font-size: 13px; }
    #toast.show { visibility: visible; animation: fadein 0.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    
    /* Status Colors */
    .status { margin-top: 15px; text-align: center; padding: 15px; border-radius: 8px; font-size: 14px; }
    .status.loading { background: #e3f2fd; color: #0d47a1; }
    .status.success { background: #e8f5e9; color: #1b5e20; }
    .status.error { background: #ffebee; color: #b71c1c; }

    .footer { text-align: center; margin-top: 50px; color: #888; font-size: 13px; padding-bottom: 30px; }
    .social-link { display: inline-flex; width: 35px; height: 35px; background: #7385a5; color: white; border-radius: 50%; align-items: center; justify-content: center; margin: 0 5px; text-decoration: none; }
</style>
</head>
<body>
    
<nav class="navbar">
        <div class="nav-left">
  <a href="index" style="display: flex; align-items: center; text-decoration: none;">
    <img src="img/icon-192.png" class="nav-logo" style="margin-right:8px;">
    <span class="nav-brand" style="font-size:20px; color: #7385a5; font-weight:bold;">Putramas Official</span>
  </a>
    </div>
    <div class="nav-right">
        <button id="btn-connect" onclick="connectWallet()">
            <i class="fas fa-wallet"></i> Hubungkan
        </button>
    </div>
</nav>
    
<div class="container">
    <div class="header">
        <h3><i class="fas fa-cloud-upload-alt"></i> Upload Ke Galeri Nusantara</h3>
    </div>
    
    <fieldset>
        <legend>1. Identitas Utama</legend>
        <label>Nama Tokoh:</label>
        <input type="text" id="inputNama" required placeholder="Contoh: Arjuna">
        
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;">
                <label>Golongan:</label>
                <select id="inputGolongan" required>
                    <option value="Satria">Satria</option>
                    <option value="Dewa">Dewa</option>
                    <option value="Yaksa">Yaksa</option>
                    <option value="Wanara">Wanara</option>
                    <option value="Panakawan">Panakawan</option>
                    <option value="Kayon">Kayon</option>
                    <option value="Bambangan">Bambangan</option>
                    <option value="Punggawa">Punggawa</option>
                    <option value="Krodan">Krodan</option>
                    <option value="Resi">Resi</option>
                    <option value="Putren">Putren</option>
                    <option value="Buta Kiwe">Buta Kiwe</option>
                    <option value="Sato">Sato</option>
                    <option value="Gaman">Gaman</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>Gaya:</label>
                <select id="inputGaya" required>
                    <option value="Bali">Bali</option>
                    <option value="Banjar">Banjar</option>
                    <option value="Banyumas">Banyumas</option>
                    <option value="Cirebon">Cirebon</option>
                    <option value="Jawa Barat">Golek Sunda</option>
                    <option value="Jawa Timur">Jawa Timur</option>
                    <option value="Kedu">Kedu</option>
                    <option value="Lombok">Lombok</option>
                    <option value="Surakarta">Surakarta</option>
                    <option value="Yogyakarta">Yogyakarta</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>2. Detail Fisik</legend>
        <label>Wanda (Ekspresi):</label>
        <input type="text" id="inputWanda" placeholder="Contoh: Luruh, Geger">
        <label>Material Kulit:</label>
        <input type="text" id="inputKulit" placeholder="Contoh: Kulit Kerbau">
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Penatah:</label><input type="text" id="inputPenatah"></div>
            <div style="flex:1"><label>Penyungging:</label><input type="text" id="inputPenyungging"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Tahun:</label><input type="text" id="inputTahun"></div>
            <div style="flex:1"><label>Kolektor:</label><input type="text" id="inputKolektor"></div>
        </div>
    </fieldset>

    <fieldset>
        <legend>3. Silsilah</legend>
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;"><label>Ayah:</label><input type="text" id="inputAyah"></div>
            <div style="flex: 1;"><label>Ibu:</label><input type="text" id="inputIbu"></div>
        </div>
        <label>Negara/Tempat:</label>
        <input type="text" id="inputNegara" placeholder="Contoh: Madukara">
        <label>Pusaka:</label>
        <input type="text" id="inputPusaka" placeholder="Contoh: Pasopati">
    </fieldset>

    <fieldset>
        <legend>4. Media & Cerita</legend>
        <label>Deskripsi Singkat:</label>
        <textarea id="inputDeskripsi" required rows="3" placeholder="Ceritakan sedikit tentang wayang ini..."></textarea>
        <label>Upload Foto:</label>
        <input type="file" id="inputGambar" accept="image/*" required>
        <p style="font-size:11px; color:#888;">*Otomatis dikompresi agar ringan (Max 300KB).</p>
    </fieldset>

    <button class="btn-action" onclick="kirimKeBlockchain()"> 
        <i class="fas fa-paper-plane"></i> ARSIPKAN KE BLOCKCHAIN 
    </button>
    
    <div id="statusPublik"></div>
</div>

<div id="toast"></div>

<footer class="footer">
    <div class="social-icons">
        <a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
        <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
    </div>
    <p class="copyright">&copy; <span id="year"></span> Powered By <strong>Putramas Official</strong></p>
</footer>

<script>
    // --- KONFIGURASI SMART CONTRACT ---
    const CONTRACT_ADDRESS = "0xE6A51b5D204e1bA45e2d607ee53eba3D7E70Bc69"; 
    
    // ABI (Hanya fungsi yang dibutuhkan saja biar ringan)
    const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"Liked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"uploader","type":"address"},{"indexed":false,"internalType":"string","name":"title","type":"string"}],"name":"NewGalleryUpload","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"star","type":"uint8"},{"indexed":false,"internalType":"string","name":"ulasan","type":"string"}],"name":"Reviewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"UploadFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"string","name":"golongan","type":"string"}],"name":"WayangLahir","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"namaBaru","type":"string"},{"indexed":false,"internalType":"string","name":"uriBaru","type":"string"}],"name":"WayangUpdate","type":"event"},{"inputs":[{"internalType":"string","name":"_title","type":"string"},{"internalType":"string","name":"_imageURI","type":"string"},{"internalType":"string","name":"_description","type":"string"}],"name":"addGalleryItem","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_penerima","type":"address"},{"internalType":"string","name":"_tokenURI","type":"string"},{"internalType":"string","name":"_nama","type":"string"},{"internalType":"string","name":"_golongan","type":"string"},{"internalType":"string","name":"_gaya","type":"string"}],"name":"arsipWayang","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dalang","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"galleryItems","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"uploader","type":"address"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAllGalleryItems","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"uploader","type":"address"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasWayangArsip.GalleryItem[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getAverageRating","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_galleryId","type":"uint256"}],"name":"getGalleryItemById","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"uploader","type":"address"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasWayangArsip.GalleryItem","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"golongan","type":"string"}],"name":"getIdsByGolongan","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getInfoWayang","outputs":[{"components":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct PutramasWayangArsip.WayangInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getReviews","outputs":[{"components":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PutramasWayangArsip.Review[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasLiked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasReviewed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"kasihLike","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint8","name":"_bintang","type":"uint8"},{"internalType":"string","name":"_ulasanPilihan","type":"string"}],"name":"kasihUlasan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicUploadFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_title","type":"string"},{"internalType":"string","name":"_imageURI","type":"string"},{"internalType":"string","name":"_description","type":"string"}],"name":"publicUploadGalleryNusantara","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"string","name":"_namaBaru","type":"string"},{"internalType":"string","name":"_uriBaru","type":"string"}],"name":"revisiDataWayang","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalLikes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"walletOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangRegistry","outputs":[{"internalType":"string","name":"nama","type":"string"},{"internalType":"string","name":"golongan","type":"string"},{"internalType":"string","name":"gaya","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"wayangReviews","outputs":[{"internalType":"address","name":"reviewer","type":"address"},{"internalType":"uint8","name":"bintang","type":"uint8"},{"internalType":"string","name":"ulasan","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];

    // --- KONFIGURASI BASE SEPOLIA ---
    const BASE_SEPOLIA_ID = '0x14a34'; // 84532
    const BASE_SEPOLIA_CONFIG = {
        chainId: BASE_SEPOLIA_ID, 
        chainName: 'Base Sepolia Testnet',
        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
        rpcUrls: ['https://sepolia.base.org'], 
        blockExplorerUrls: ['https://sepolia.basescan.org']
    };

    const PINATA_API_KEY = "9e761468bc54ff406e32";    
    const PINATA_SECRET_KEY = "56cc032751b13afe3deb04ee30a341fbeb54b119649a45a1c4c6b1df8e58a780";

    let provider, signer, contract;
    let userAddress = "";
    let toastTimeout;

    document.getElementById("year").innerText = new Date().getFullYear();

    // 1. KONEKSI WALLET (DENGAN AUTO SWITCH NETWORK)
    async function connectWallet() {
        if (!window.ethereum) return showToast("Install Metamask Dulu!", 'error');
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            
            // Request Akun
            const accounts = await provider.send("eth_requestAccounts", []);
            userAddress = accounts[0];

            // Cek & Switch Network ke Base Sepolia
            const network = await provider.getNetwork();
            if (network.chainId !== 84532) {
                showToast("Mengganti jaringan ke Base Sepolia...", 'loading');
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_ID }],
                    });
                    // Refresh provider setelah switch
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } catch (switchError) {
                    // Jika belum ada networknya, tambahkan
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    } else {
                        throw switchError;
                    }
                }
            }

            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            listenToEvents();

            const btn = document.getElementById("btn-connect");
            btn.innerHTML = `<i class="fas fa-wallet"></i> ${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
            btn.classList.add("connected");
            
            showToast("Dompet Terhubung!", 'success');
        } catch (err) { 
            console.error(err); 
            showToast("Gagal koneksi: " + err.message, 'error'); 
        }
    }

    // 2. LISTEN EVENT (Agar notifikasi muncul realtime)
    function listenToEvents() {
        if(!contract) return;
        contract.on("NewGalleryUpload", (id, uploader, title) => {
            if(uploader.toLowerCase() === userAddress.toLowerCase()) {
                const statusEl = document.getElementById("statusPublik");
                statusEl.className = "status success";
                statusEl.innerHTML = `
                    <h3><i class="fas fa-check-circle"></i> Upload Berhasil!</h3>
                    <p>Wayang <strong>${title}</strong> (ID: ${id}) berhasil diarsipkan.</p>
                `;
                showToast("Transaksi Dikonfirmasi Blockchain!", 'success');
                resetForm();
            }
        });
    }

    // 3. UPLOAD KE PINATA (IPFS)
    async function uploadToIPFS(file) {
        const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
        let data = new FormData();
        data.append('file', file);
        const res = await axios.post(url, data, {
            headers: {
                'pinata_api_key': PINATA_API_KEY, 
                'pinata_secret_api_key': PINATA_SECRET_KEY, 
                "Content-Type": "multipart/form-data"
            }
        });
        return `https://gateway.pinata.cloud/ipfs/${res.data.IpfsHash}`;
    }

    // 4. LOGIKA UTAMA: KIRIM KE BLOCKCHAIN
    async function kirimKeBlockchain() {
        const statusEl = document.getElementById("statusPublik");
        
        if(!userAddress) {
            await connectWallet();
            if(!userAddress) return;
        }

        const nama = document.getElementById("inputNama").value;
        const fileInput = document.getElementById("inputGambar");
        const deskripsiAsli = document.getElementById("inputDeskripsi").value;
        
        if(!nama || fileInput.files.length === 0 || !deskripsiAsli) {
            return showToast("Nama, Deskripsi, dan Gambar wajib diisi!", 'error');
        }

        try {
            statusEl.style.display = 'block';
            statusEl.className = "status loading";
            const loadingIcon = `<i class="fas fa-circle-notch fa-spin"></i>`;
            
            // A. KOMPRESI (Max 300KB)
            statusEl.innerHTML = `${loadingIcon} Mengompresi Gambar (Target 300KB)...`;
            const compressedFile = await compressImage(fileInput.files[0], 300);
            
            // B. UPLOAD GAMBAR
            statusEl.innerHTML = `${loadingIcon} Upload Gambar ke IPFS (Cloud)...`;
            const imgUrl = await uploadToIPFS(compressedFile);

            // C. SUSUN DATA LENGKAP (Untuk diparsing di Galeri)
            const fullDescription = `
${deskripsiAsli}

[Detail Wayang]
Golongan: ${document.getElementById("inputGolongan").value}
Gaya: ${document.getElementById("inputGaya").value}
Wanda: ${document.getElementById("inputWanda").value || "-"}
Material: ${document.getElementById("inputKulit").value || "-"}
Penatah: ${document.getElementById("inputPenatah").value || "-"}
Penyungging: ${document.getElementById("inputPenyungging").value || "-"}
Tahun: ${document.getElementById("inputTahun").value || "-"}
Kolektor: ${document.getElementById("inputKolektor").value || "-"}
Ayah: ${document.getElementById("inputAyah").value || "-"}
Ibu: ${document.getElementById("inputIbu").value || "-"}
Negara: ${document.getElementById("inputNegara").value || "-"}
Pusaka: ${document.getElementById("inputPusaka").value || "-"}
            `.trim();

            // D. TRANSAKSI BLOCKCHAIN
            statusEl.innerHTML = `${loadingIcon} Meminta Konfirmasi Wallet...`;

            // Cek Fee (antisipasi jika nanti owner set harga)
            const fee = await contract.publicUploadFee();
            
            // Kirim Transaksi
            const tx = await contract.publicUploadGalleryNusantara(nama, imgUrl, fullDescription, { 
                value: fee 
            });

            statusEl.innerHTML = `${loadingIcon} Sedang divalidasi Blockchain... (Tunggu Â±15 detik)`;
            
            // Tunggu Konfirmasi Blok
            await tx.wait();
            
            // Sukses dihandle oleh Event Listener

        } catch (err) {
            console.error(err);
            statusEl.className = "status error";
            statusEl.innerHTML = `<strong>Gagal:</strong> ${err.reason || err.message}`;
        }
    }

    function resetForm() {
        document.getElementById("inputNama").value = "";
        document.getElementById("inputDeskripsi").value = "";
        document.getElementById("inputGambar").value = "";
    }

    // --- FUNGSI KOMPRESI 300KB ---
    async function compressImage(file, maxSizeKB = 300) {
        if (file.size <= maxSizeKB * 1024) return file; 

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize dimensi jika terlalu besar
                    const MAX_WIDTH = 1200; 
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let quality = 0.9;
                    const tryCompress = () => {
                        canvas.toBlob((blob) => {
                            if (!blob) return reject("Gagal kompresi");
                            const sizeKB = blob.size / 1024;
                            if (sizeKB <= maxSizeKB || quality <= 0.5) {
                                const newFile = new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
                                resolve(newFile);
                            } else {
                                quality -= 0.1;
                                tryCompress();
                            }
                        }, 'image/jpeg', quality);
                    };
                    tryCompress();
                };
            };
            reader.onerror = (error) => reject(error);
        });
    }

    function showToast(msg, type) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = "show";
        if (type === 'error') x.style.background = "#c0392b";
        else if (type === 'success') x.style.background = "#27ae60";
        else x.style.background = "#333";
        
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => { x.className = x.className.replace("show", ""); }, 4000);
    }
</script>
</body>
</html>
